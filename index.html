<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧棱镜系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts-datatool/2.0.1/dataTool.min.js"></script>

    <!-- marked.js -->
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/12.0.0/marked.min.js"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/katex.min.css">

    <!-- KaTeX JS -->
    <script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/contrib/mhchem.min.js"></script>

    <!-- localForage -->
    <script src="https://cdn.bootcdn.net/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <script src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdn.bootcdn.net/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>


    <link rel="stylesheet" href="css/main.css">
</head>

<body>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>🪞智慧棱镜系统</h2>
                <h2>SMART PRISM</h2>
            </div>

            <ul>
                <li class="config-section" id="class-filter-container" style="display: none;">
                    <h4>班级筛选</h4>
                    <select id="class-filter" class="sidebar-select"></select>
                </li>
                <hr id="class-filter-hr" style="display: none;">

                <li class="config-section">
                    <h4>考试配置</h4>
                    <button id="config-subjects-btn" class="sidebar-button">
                        ⚙️ 配置各科满分
                    </button>
                </li>
                <hr>

                <li><a href="#" class="nav-link active" data-module="dashboard">📈 整体成绩分析</a></li>
                <li><a href="#" class="nav-link" data-module="student">👩‍🎓 学生个体报告</a></li>
                <li><a href="#" class="nav-link" data-module="paper">📝 试卷科目分析</a></li>
                <li><a href="#" class="nav-link" data-module="single-subject">🎯 单科成绩分析</a></li>
                <li><a href="#" class="nav-link" data-module="boundary">📊 临界生分析</a></li>
                <li><a href="#" class="nav-link" data-module="holistic">⚖️ 全科均衡分析</a></li>
                <li><a href="#" class="nav-link" data-module="trend-distribution">🌊 成绩分布变动</a></li>
                <li><a href="#" class="nav-link" data-module="groups">🎯 学生分层筛选</a></li>
                <li><a href="#" class="nav-link" data-module="correlation">🌡️ 学科关联矩阵</a></li>
                <li><a href="#" class="nav-link" data-module="weakness">📉 偏科诊断分析</a></li>
                <li><a href="#" class="nav-link" data-module="trend">🚀 成绩趋势对比</a></li>

                <li><a href="#" class="nav-link" data-module="item-analysis">🔬 学科小题分析</a></li>

                <li><a href="#" class="nav-link" data-module="ai-advisor">🤖 AI 智能分析</a></li>
                <li><a href="#" class="nav-link" data-module="goal-setting">🎯 目标与规划</a></li>
                <li><a href="#" class="nav-link" data-module="exam-arrangement">🧘 考场编排</a></li>
                <li><a href="#" class="nav-link" data-module="study-groups">🧩 智能互助分组</a></li>
                <li><a href="#" class="nav-link" data-module="comment-gen">✍️ 评语生成助手</a></li>
                <li><a href="#" class="nav-link" data-module="weakness-workbook">📝 错题攻坚本</a></li>
                <li><a href="#" class="nav-link" data-module="honor">🏆 荣誉中心</a></li>
                <hr style="margin-top: 20px; border-color: var(--border-color);">
                <li><a href="#" class="nav-link" data-module="multi-exam">📈 数据管理中心</a></li>
                <li>
                    <label id="import-main-btn" class="upload-label">
                        📊 导入本次成绩
                    </label>
                    <input type="file" id="file-uploader" accept=".xlsx, .xls, .csv" style="display: none;">
                </li>
                <li>
                    <label id="import-compare-btn" class="upload-label">
                        📉 导入对比成绩
                    </label>
                    <input type="file" id="file-uploader-compare" accept=".xlsx, .xls, .csv" style="display: none;">
                </li>

                <li>
                    <button id="clear-all-data-btn" class="sidebar-button"
                        style="width: 100%; background-color: var(--color-red); margin-top: 10px;">
                        🗑️ 清除所有导入数据
                    </button>
                </li>

                <li>
                    <button id="module-settings-btn" class="sidebar-button"
                        style="width: 100%; background-color: #a80aeb; margin-top: 5px; border: 1px dashed #ccc;">
                        ⚙️ 自定义菜单显示
                    </button>
                </li>

                <li>
                    <button id="theme-toggle-btn" class="sidebar-button"
                        style="width: 100%; background-color: var(--color-gray); margin-top: 10px;">
                        🌓 切换外观模式
                    </button>
                </li>
                <li><a href="#" class="nav-link">✍️ 作者：G.L.Wu</a></li>
            </ul>

            <div id="sidebar-drag-handle" title="点击收起/展开侧边栏">
                <span class="handle-icon">◀</span>
            </div>

            <div id="sidebar-resizer" title="拖动调节宽度"></div>
        </nav>

        <main class="main-content">

            <div id="welcome-screen">

                <h2>欢迎使用智慧棱镜系统</h2>
                <p>请点击左侧 "📊 导入本次成绩" 开始分析。</p>
                <img src="./assets/images/logo.png" alt="Logo" class="sidebar-logo">
            </div>

            <div id="module-dashboard" class="module-panel"></div>
            <div id="module-student" class="module-panel"></div>
            <div id="module-paper" class="module-panel"></div>
            <div id="module-single-subject" class="module-panel"></div>
            <div id="module-boundary" class="module-panel"></div>
            <div id="module-holistic" class="module-panel"></div>
            <div id="module-trend-distribution" class="module-panel"></div>
            <div id="module-groups" class="module-panel"></div>
            <div id="module-correlation" class="module-panel"></div>
            <div id="module-weakness" class="module-panel"></div>
            <div id="module-trend" class="module-panel"></div>
            <div id="module-multi-exam" class="module-panel"></div>
            <div id="module-item-analysis" class="module-panel"></div>
            <div id="module-goal-setting" class="module-panel"></div>

            <div id="module-exam-arrangement" class="module-panel"></div>

            <div id="module-study-groups" class="module-panel"></div>
            <div id="module-comment-gen" class="module-panel"></div>
            <div id="module-weakness-workbook" class="module-panel"></div>
            <div id="module-honor" class="module-panel"></div>

            <div id="module-ai-advisor" class="module-panel">
                <h2>模块十三：AI 智能分析</h2>
                <p>AI 智能分析模块基于 DeepSeek 模型，提供以下功能：</p>
                <ul>
                    <li>分析学生历史成绩趋势</li>
                    <li>识别学生偏科情况</li>
                    <li>提供个性化学习建议</li>
                </ul>
                <p style="color: var(--text-muted);">基于 DeepSeek模型，分析学生历史成绩趋势与偏科情况，提供个性化建议。</p>

                <button id="ai-history-toggle-btn" title="查看历史记录">
                    🕒 历史
                </button>

                <div id="ai-history-drawer">
                    <div class="history-header">
                        <h3>🕒 对话历史</h3>
                        <button id="ai-history-close-btn">&times;</button>
                    </div>

                    <div class="history-actions">
                        <button id="ai-history-clear-btn" class="sidebar-button"
                            style="background-color: var(--color-red); width: 100%; font-size: 0.85em;">
                            🗑️ 清空所有记录
                        </button>
                    </div>

                    <div id="ai-history-list" class="history-list-container">
                        <p style="color: #999; text-align: center; margin-top: 20px;">暂无历史记录</p>
                    </div>
                </div>

                <div class="main-card-wrapper"
                    style="margin-bottom: 20px; border-left: 5px solid var(--primary-color);">
                    <h4>🔑 API 设置</h4>
                    <div class="controls-bar" style="background: transparent; box-shadow: none; padding: 0;">
                        <label for="ai-api-key">DeepSeek API Key:</label>
                        <input type="password" id="ai-api-key" placeholder="sk-..."
                            style="flex-grow: 1; max-width: 400px;">
                        <button id="ai-save-key-btn" class="sidebar-button">保存 Key</button>
                        <button id="ai-prompt-settings-btn" class="sidebar-button"
                            style="background-color: #17a2b8; margin-left: 10px;">
                            📝 提示词模板
                        </button>
                        <span id="ai-key-status" style="margin-left: 10px; color: var(--color-green); display: none;">✅
                            已保存</span>
                    </div>

                    <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 5px;">
                        * Key 仅保存在您的浏览器本地，不会上传到任何服务器。
                    </p>

                </div>



                <div class="main-card-wrapper" style="margin-bottom: 20px;">
                    <h4>🎯 选择分析对象</h4>
                    <div class="controls-bar"
                        style="background: transparent; box-shadow: none; padding: 0; flex-wrap: wrap;">

                        <div class="search-combobox">
                            <input type="text" id="ai-student-search" placeholder="输入姓名或考号..." autocomplete="off">
                            <div class="search-results" id="ai-student-search-results"></div>
                        </div>

                        <select id="ai-grade-select" class="sidebar-select" style="margin-left: 10px; width: auto;">
                            <option value="一年级">一年级</option>
                            <option value="二年级">二年级</option>
                            <option value="三年级">三年级</option>
                            <option value="四年级">四年级</option>
                            <option value="五年级">五年级</option>
                            <option value="六年级">六年级</option>

                            <option value="初一">初一</option>
                            <option value="初二">初二</option>
                            <option value="初三">初三</option>

                            <option value="高一" selected>高一</option>
                            <option value="高二">高二</option>
                            <option value="高三">高三</option>
                        </select>

                        <select id="ai-mode-select" class="sidebar-select" style="margin-left: 15px;">
                            <option value="trend">📈 综合趋势点评 & 学习建议</option>
                            <option value="weakness">📉 弱科诊断 & 提分策略</option>
                            <option value="question">📝 针对弱项生成练习题</option>
                            <option value="item_diagnosis">🔬 小题深度诊断 (学生视角)</option>
                            <option value="teaching_guide">🍎 教师教学指导 (班级视角)</option>
                        </select>

                        <span id="ai-item-subject-wrapper"
                            style="display: none; margin-left: 10px; align-items: center;">
                            <label for="ai-item-subject"
                                style="margin-right: 5px; font-size: 0.9em; color: #555;">科目:</label>
                            <select id="ai-item-subject" class="sidebar-select"
                                style="width: auto; min-width: 80px; border-color: #17a2b8; background-color: #f0fcfd;">
                                <option value="">无数据</option>
                            </select>
                        </span>

                        <span id="ai-item-class-wrapper" style="display: none; margin-left: 10px; align-items: center;">
                            <label for="ai-item-class"
                                style="margin-right: 5px; font-size: 0.9em; color: #555;">班级:</label>
                            <select id="ai-item-class" class="sidebar-select"
                                style="width: auto; min-width: 80px; border-color: #fd7e14; background-color: #fffbf5;">
                                <option value="ALL">-- 全体年段 --</option>
                            </select>
                        </span>

                        <span id="ai-q-count-wrapper" style="display: none; margin-left: 10px; align-items: center;">
                            <label for="ai-q-count" style="margin-right: 5px; font-size: 0.9em;">题量:</label>
                            <input type="number" id="ai-q-count" value="3" min="1" max="10" class="sidebar-select"
                                style="width: 60px; padding: 6px;">
                        </span>

                        <select id="ai-model-select" class="sidebar-select"
                            style="margin-left: 10px; background-color: #f0fdf4; border-color: #28a745;">
                            <option value="deepseek-chat">🚀 V3 (标准极速版)</option>
                            <option value="deepseek-reasoner">🧠 R1 (深度思考版)</option>
                        </select>

                        <button id="ai-analyze-btn" class="sidebar-button"
                            style="background-color: #6f42c1; margin-left: 15px;" disabled>
                            ✨ 开始 AI 分析
                        </button>
                    </div>
                </div>

                <div class="main-card-wrapper" id="ai-result-container" style="display: none; min-height: 300px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h3 style="margin: 0;">🤖 DeepSeek 回复:</h3>
                            <button id="ai-stop-btn" class="sidebar-button"
                                style="background-color: #dc3545; padding: 4px 12px; font-size: 0.85em; display: none;">
                                ⏹ 停止生成
                            </button>
                            <button id="ai-print-btn" class="sidebar-button" ...>🖨️ 全部打印</button>

                            <button id="ai-print-range-btn" class="sidebar-button" style="background-color: #17a2b8;">
                                🔢 选段打印
                            </button>

                            <button id="ai-copy-btn" class="sidebar-button"
                                style="font-size: 0.8em; padding: 4px 8px; background-color: var(--color-gray);">复制内容</button>
                        </div>
                    </div>

                    <div id="ai-loading" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 2em;">🤔</div>
                        <p>AI 正在思考学生的成绩数据...</p>
                    </div>

                    <div id="ai-content" style="line-height: 1.6; font-size: 1.05em;"></div>

                    <div id="ai-chat-history" style="margin-top: 20px; border-top: 1px dashed #eee; padding-top: 20px;">
                    </div>

                    <div id="ai-followup-input-area">

                        <button id="ai-floating-stop-btn" style="display: none;">
                            ⏹ 停止生成
                        </button>

                        <textarea id="ai-user-input" class="sidebar-select" rows="1"
                            placeholder="在此输入您的问题 (例如：针对第5题再出几道变式题)..."></textarea>

                        <button id="ai-send-btn" class="sidebar-button">发送</button>
                    </div>
        </main>
    </div>

    <div id="subject-config-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>配置各科满分/及格线/优秀线</h3>
                <span id="modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p>默认值已设为“语数英150，其他100”。</p>
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table id="subject-config-table">
                        <thead>
                            <tr>
                                <th>科目</th>
                                <th>满分 (Full)</th>
                                <th>优秀线 (Excel)</th>
                                <th>良好线 (Good)</th>
                                <th>及格线 (Pass)</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal-save-btn" class="sidebar-button">保存并重新分析</button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="import-modal-title">选择数据源</h3>
                <span id="import-modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <h4>1. 从“数据管理中心”模块导入</h4>
                <p>选择一个您在“模块十二”中已保存的成绩单。</p>
                <select id="import-modal-select" class="sidebar-select" style="width: 100%;"></select>
                <button id="import-modal-from-storage" class="sidebar-button" style="width: 100%; margin-top: 10px;">
                    导入选中项
                </button>
                <hr style="margin: 20px 0;">
                <h4>2. 从本地文件导入</h4>
                <p>像以前一样，从您的电脑上传一个新文件。</p>
                <button id="import-modal-from-file" class="sidebar-button"
                    style="width: 100%; background-color: var(--color-gray);">
                    从本地文件上传
                </button>
            </div>
        </div>
    </div>

    <div id="item-analysis-config-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content"
            style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; padding: 0;">

            <div class="modal-header" style="padding: 15px 20px; border-bottom: 1px solid #dee2e6;">
                <h3 id="item-config-modal-title" style="margin:0;">配置题目详情 (科目: -)</h3>
                <span id="item-config-modal-close-btn" class="modal-close-btn">&times;</span>
            </div>

            <div class="modal-body" style="overflow-y: auto; flex: 1; padding: 20px;">

                <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                    <label for="item-config-skip-rows" style="display:block; font-weight:600; margin-bottom:8px;">
                        🔢 末尾跳过行数 (默认为 3):
                    </label>
                    <input type="number" id="item-config-skip-rows" value="3" min="0" class="sidebar-select"
                        placeholder="输入 0 则不忽略" style="width: 100px; padding: 6px;">
                    <p style="font-size:0.8em; color:#666; margin-top:5px;">
                        * 多数扫描系统会在文件末尾添加总平均分或统计数据。设为 0 则不忽略末尾行。
                    </p>
                </div>

                <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                    <label for="item-config-full-paper" style="display:block; font-weight:600; margin-bottom:8px;">
                        📄 粘贴完整试卷文本 (AI 分析核心参考):
                    </label>
                    <textarea id="item-config-full-paper" rows="6" class="sidebar-select"
                        placeholder="请在此处粘贴整张试卷的文字内容..."
                        style="width: 100%; resize: vertical; font-family: monospace; line-height: 1.5;"></textarea>
                </div>

                <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                    <label for="item-config-graph-def" style="display:block; font-weight:600; margin-bottom:8px;">
                        🕸️ 定义知识点层级关系 (格式：前置 -> 后继):
                    </label>
                    <textarea id="item-config-graph-def" rows="4" class="sidebar-select"
                        placeholder="在此定义知识点的依赖路径，每行一条。例如：&#10;一元二次方程 -> 二次函数&#10;二次函数 -> 二次函数图像性质"
                        style="width: 100%; resize: vertical; font-family: monospace; line-height: 1.5;"></textarea>
                    <p style="font-size:0.8em; color:#666; margin-top:5px;">* 系统将根据此关系生成归因图谱。请确保“知识点名称”与下方表格中的“考察内容”一致。
                    </p>
                </div>


                <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px;">
                    <label for="item-config-full-paper" style="display:block; font-weight:600; margin-bottom:8px;">
                        📄 知识点批量配置工具:
                    </label>

                    <p style="font-size: 0.85em; color: #888; margin-bottom: 5px;">
                        请在此粘贴小题对应的知识点内容，**每行对应一个题目的知识点**。系统将按表格顺序依次匹配小题。
                        <br>(例如：第1行内容对应表格中的第1道小题。)
                    </p>

                    <textarea id="item-config-batch-knowledge"
                        placeholder="粘贴知识点内容，按回车换行区分：&#10;牛顿第二定律&#10;万有引力公式&#10;动量守恒"
                        style="width: 100%; height: 100px; padding: 5px; border: 1px solid #ccc; box-sizing: border-box; resize: vertical; margin-bottom: 10px;"></textarea>

                    <div style="display: flex; gap: 10px;">
                        <button class="sidebar-button" style="background-color: var(--color-blue); flex-grow: 1;"
                            onclick="batchImportKnowledge()">
                            ✨ 批量导入知识点
                        </button>
                        <button class="sidebar-button" style="background-color: #dc3545; flex-grow: 1;"
                            onclick="clearAllKnowledgeConfig()">
                            🗑️ 清空所有知识点配置
                        </button>
                    </div>
                </div>


                <p style="color:#666; font-size:0.9em;">
                    “满分”：留空则使用自动检测的满分。手动填写数字将覆盖自动检测。<br>
                    “考察内容”：填写本题知识点，用“；”隔开。
                </p>

                <div class="table-container">
                    <table id="item-config-table">
                        <thead>
                            <tr>
                                <th>题号 (类型)</th>
                                <th>满分 (留空=自动)</th>
                                <th>预设难度 (0-1)</th>
                                <th>考察内容 (知识点)</th>
                            </tr>
                        </thead>
                        <tbody id="item-config-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #dee2e6;">
                <button id="item-config-modal-save-btn" class="sidebar-button">保存并重新分析</button>
            </div>
        </div>
    </div>

    

    <div id="print-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>选择打印范围</h3>
                <span id="print-modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p>请选择您要打印的学生范围。这可能需要几秒钟时间来生成所有报告。</p>

                <button id="print-btn-current" class="sidebar-button" style="width: 100%; margin-top: 10px;" disabled>
                    🖨️ 打印当前学生 (未选择)
                </button>

                <button id="print-btn-filter" class="sidebar-button"
                    style="width: 100%; margin-top: 10px; background-color: var(--color-green);">
                    🖨️ 打印当前筛选 (全体年段)
                </button>

                <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 15px;">
                    “打印当前筛选”会打印您在左侧边栏选择的班级（例如 "高一(1)班" 或 "全体年段"）。
                </p>
            </div>
        </div>
    </div>

    <div id="drill-down-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 id="drill-down-title">数据详情</h3>
                <span id="drill-down-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body" style="flex-grow: 1; overflow: hidden; display: flex; flex-direction: column;">

                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                    <p id="drill-down-subtitle" style="margin: 0; color: var(--text-muted);">学生名单</p>
                    <button id="drill-down-export-btn" class="sidebar-button"
                        style="background-color: var(--color-green); padding: 5px 15px; font-size: 0.85em;">
                        📥 导出名单 (Excel)
                    </button>
                </div>

                <div class="table-container" id="drill-down-table-container" style="flex-grow: 1; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>

    <div id="item-print-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>选择打印范围 (小题分析)</h3>
                <span id="item-print-modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p>请选择您要打印的学生诊断报告范围。</p>

                <button id="item-print-btn-current" class="sidebar-button" style="width: 100%; margin-top: 10px;"
                    disabled>
                    🖨️ 打印当前学生 (未选择)
                </button>

                <button id="item-print-btn-filter" class="sidebar-button"
                    style="width: 100%; margin-top: 10px; background-color: var(--color-green);">
                    🖨️ 打印当前筛选 (全体)
                </button>

                <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 15px;">
                    “打印当前筛选”会打印您在小题分析模块选择的班级（例如 "高一(1)班" 或 "全体"）。
                </p>
            </div>
        </div>
    </div>

    <button id="multi-collection-toggle-btn" title="切换考试列表">
        📂 考试列表库
    </button>

    <div id="multi-collection-drawer">
        <div class="drawer-header">
            <h3>📂 考试列表库</h3>
            <button id="multi-collection-close-btn">&times;</button>
        </div>

        <div class="drawer-content">
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                在这里创建或切换不同的考试合集（如“高一上”、“高二月考”）。
            </p>

            <label style="font-weight: 600; display:block; margin-bottom:5px;">当前列表:</label>
            <select id="multi-collection-select" class="sidebar-select"
                style="width: 100%; margin-bottom: 15px; font-weight: bold;">
            </select>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button id="btn-new-collection" class="sidebar-button" style="width: 100%;">➕ 新建列表</button>

                <div style="display: flex; gap: 10px;">
                    <button id="btn-rename-collection" class="sidebar-button"
                        style="flex: 1; background-color: var(--color-cyan);">✏️ 重命名</button>
                    <button id="btn-delete-collection" class="sidebar-button"
                        style="flex: 1; background-color: var(--color-red);">🗑️ 删除</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ai-prompt-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">

            <div class="modal-header">
                <h3>AI 提示词模板管理</h3>
                <span id="ai-prompt-close-btn" class="modal-close-btn">&times;</span>
            </div>

            <div class="modal-body" style="overflow-y: auto; flex: 1; padding: 20px;">
                <div class="controls-bar"
                    style="background: transparent; padding: 0; margin-bottom: 15px; flex-wrap: wrap;">
                    <label>选择模板:</label>
                    <select id="ai-prompt-select" class="sidebar-select"
                        style="min-width: 200px; margin-right: 10px;"></select>
                    <button id="ai-prompt-new-btn" class="sidebar-button">➕ 新建</button>
                    <button id="ai-prompt-delete-btn" class="sidebar-button"
                        style="background-color: var(--color-red); margin-left: 10px;">🗑️ 删除</button>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display:block; margin-bottom:5px; font-weight:600;">模板名称:</label>
                    <input type="text" id="ai-prompt-name" class="sidebar-select" style="width: 100%;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display:block; margin-bottom:5px; font-weight:600;">系统人设 (System Prompt):</label>
                    <textarea id="ai-prompt-system" class="sidebar-select" rows="2" style="width: 100%;"></textarea>
                </div>

                <div style="margin-bottom: 10px;">
                    <label style="display:block; margin-bottom:5px; font-weight:600;">用户指令模板 (User Prompt):</label>
                    <p style="font-size: 0.8em; color: #666; margin: 0 0 5px 0;">
                        可用变量: {{name}} 姓名, {{grade}} 年级, {{subject}} 科目, {{data_context}} 详细数据
                    </p>
                    <textarea id="ai-prompt-user" class="sidebar-select" rows="10"
                        style="width: 100%; font-family: monospace; line-height: 1.5;"></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button id="ai-prompt-save-btn" class="sidebar-button">💾 保存模板</button>
            </div>
        </div>
    </div>

    <div id="goal-detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content"
            style="max-width: 950px; width: 90%; max-height: 90vh; display: flex; flex-direction: column; padding: 0;">

            <div class="modal-header" style="padding: 15px 20px; border-bottom: 1px solid #eee;">
                <h3 id="goal-detail-title" style="margin:0;">规划详情回顾</h3>
                <span onclick="document.getElementById('goal-detail-modal').style.display='none'"
                    class="modal-close-btn">&times;</span>
            </div>

            <div class="modal-body" style="overflow-y: auto; flex: 1; padding: 20px;">
                <div id="goal-detail-alert"
                    style="display:none; background:#fff3cd; color:#856404; padding:10px; margin-bottom:15px; border-radius:4px; font-size:0.9em;">
                </div>

                <div class="kpi-grid" id="goal-detail-kpi"></div>

                <div class="table-container" id="goal-detail-table" style="margin-bottom: 20px;"></div>

                <div class="dashboard-chart-grid-2x2">
                    <div class="main-card-wrapper">
                        <h4 style="margin:0 0 10px 0; text-align:center;">📊 规划提分路径 (瀑布图)</h4>
                        <div class="chart-container" id="goal-detail-waterfall-chart" style="height: 350px;"></div>
                    </div>
                    <div class="main-card-wrapper">
                        <h4 style="margin:0 0 10px 0; text-align:center;">🕸️ 现状 vs 目标 vs 实际 (雷达图)</h4>
                        <div class="chart-container" id="goal-detail-radar-chart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer"
                style="padding: 15px 20px; border-top: 1px solid #eee; display:flex; justify-content:flex-end; gap:10px;">
                <button id="goal-detail-print-btn" class="sidebar-button"
                    style="background-color: var(--color-blue);">🖨️ 打印详情单</button>
                <button class="sidebar-button" style="background-color: #6c757d;"
                    onclick="document.getElementById('goal-detail-modal').style.display='none'">关闭</button>
            </div>
        </div>
    </div>


    <div id="module-settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>自定义侧边栏显示</h3>
                <span id="module-settings-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color: #f30606; font-size: 0.9em; margin-bottom: 15px;">
                    请勾选您常用的模块，未勾选的将被隐藏。<br>(数据依然保留，只是隐藏入口)
                </p>
                <div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                    <div id="module-checklist-container" style="display: flex; flex-direction: column; gap: 10px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="module-settings-save-btn" class="sidebar-button"
                    style="background-color: var(--primary-color);">保存设置</button>
            </div>
        </div>
    </div>

    <!-- 主入口文件 (ES6 模块) -->
    <script type="module" src="js/main.js"></script>
</body>

</html>