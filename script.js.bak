/* eslint-disable no-undef */
'use strict';

// æ ‡è®° script.js å·²åŠ è½½ï¼Œé˜²æ­¢ main.js é‡å¤åˆå§‹åŒ–
window.SCRIPT_JS_LOADED = true;

// 1. å…¨å±€é…ç½®ä¸çŠ¶æ€
localforage.config({
    name: 'SmartPrismDB',
    storeName: 'app_data',
    description: 'å­˜å‚¨å­¦ç”Ÿæˆç»©ã€å°é¢˜åˆ†æåŠè€ƒè¯•å½’æ¡£æ•°æ®'
});

// ---------------------------------
// 1. å…¨å±€é…ç½®ä¸çŠ¶æ€
// ---------------------------------
// é»˜è®¤ç§‘ç›®åˆ—è¡¨ï¼Œä»…ç”¨äºç¨‹åºé¦–æ¬¡åŠ è½½
const DEFAULT_SUBJECT_LIST = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'æ”¿æ²»', 'å†å²', 'åœ°ç†'];
// G_DynamicSubjectList ç°åœ¨æ˜¯å”¯ä¸€çš„ç§‘ç›®æ¥æºï¼Œé»˜è®¤ç­‰äº DEFAULT_SUBJECT_LIST
let G_DynamicSubjectList = [...DEFAULT_SUBJECT_LIST];

// å­˜å‚¨æ•°æ®
let G_StudentsData = []; // { id, name, class, totalScore, rank, gradeRank, scores: {...} }
let G_CompareData = [];  // åŒä¸Š, ç”¨äºå¯¹æ¯”
//let G_MultiExamData = [];
let G_Statistics = {};   // å­˜å‚¨å½“å‰ *å·²ç­›é€‰* åçš„ç»Ÿè®¡æ•°æ®
let G_ItemAnalysisData = {};
let G_ItemAnalysisConfig = {};
let G_ItemOutlierList = [];
let G_ItemDetailSort = { key: 'deviation', direction: 'asc' }; //  ç¼“å­˜å­¦ç”Ÿè¯¦æƒ…è¡¨çš„æ’åºçŠ¶æ€
let G_CompareStatistics = {};
let G_TrendSort = { key: 'rank', direction: 'asc' }; //   è¶‹åŠ¿æ¨¡å—çš„æ’åºçŠ¶æ€
let G_DashboardTableSort = { key: 'totalScore', direction: 'desc' };
let currentAIController = null;
// å…¨å±€å˜é‡ï¼šå­˜å‚¨ AI å¯¹è¯å†å²
let G_AIChatHistory = [];

let G_CurrentHistoryId = null;

// å­˜å‚¨UIçŠ¶æ€
let G_CurrentClassFilter = 'ALL';
let G_CurrentImportType = 'main';
let G_SubjectConfigs = {};

// å…¨å±€å˜é‡ï¼šå­˜å‚¨èº«é«˜/æ€§åˆ«æ•°æ® { id: { gender: 'ç”·', height: 175 }, ... }
let G_PhysicalData = {};
let G_CurrentSeatMap = null; // ç¼“å­˜ç»“æœç”¨äºå¯¼å‡º

// ç›®æ ‡è§„åˆ’æ¨¡å—çš„ä¸“ç”¨æ•°æ®æº
let G_GoalBaselineData = null; // åŸºå‡†æˆç»©
let G_GoalOutcomeData = null;  // å¤ç›˜æˆç»©

// ---------------------------------
// 2. DOM å…ƒç´ 
// ---------------------------------
let fileUploader, fileUploaderCompare, navLinks, modulePanels, welcomeScreen, compareUploadLabel;
let classFilterContainer, classFilterSelect, classFilterHr;
let modal, modalCloseBtn, modalSaveBtn, configSubjectsBtn, subjectConfigTableBody;
let echartsInstances = {};

document.addEventListener('DOMContentLoaded', () => {
    // ç»‘å®š DOM å…ƒç´ 
    fileUploader = document.getElementById('file-uploader');
    fileUploaderCompare = document.getElementById('file-uploader-compare');
    navLinks = document.querySelectorAll('.nav-link');
    modulePanels = document.querySelectorAll('.module-panel');
    welcomeScreen = document.getElementById('welcome-screen');

    // ç­çº§ç­›é€‰
    classFilterContainer = document.getElementById('class-filter-container');
    classFilterSelect = document.getElementById('class-filter');
    classFilterHr = document.getElementById('class-filter-hr');

    // ç§‘ç›®é…ç½®
    modal = document.getElementById('subject-config-modal');
    modalCloseBtn = document.getElementById('modal-close-btn');
    modalSaveBtn = document.getElementById('modal-save-btn');
    configSubjectsBtn = document.getElementById('config-subjects-btn');
    subjectConfigTableBody = document.getElementById('subject-config-table').getElementsByTagName('tbody')[0];

    // å¯¼å…¥æ¨¡æ€æ¡† DOM
    const importModal = document.getElementById('import-modal');
    const importModalTitle = document.getElementById('import-modal-title');
    const importModalCloseBtn = document.getElementById('import-modal-close-btn');
    const importModalSelect = document.getElementById('import-modal-select');
    const importModalFromFileBtn = document.getElementById('import-modal-from-file');
    const importModalFromStorageBtn = document.getElementById('import-modal-from-storage');
    const importMainBtn = document.getElementById('import-main-btn'); 
    const importCompareBtn = document.getElementById('import-compare-btn'); 
    const clearAllBtn = document.getElementById('clear-all-data-btn'); //    (    )



    const printModal = document.getElementById('print-modal');
    const printModalCloseBtn = document.getElementById('print-modal-close-btn');
    const printBtnCurrent = document.getElementById('print-btn-current');
    const printBtnFilter = document.getElementById('print-btn-filter');

    // åˆå§‹åŒ– UI
    initializeUI();
    initializeSubjectConfigs(); // åˆå§‹åŒ–ç§‘ç›®é…ç½®
    loadDataFromStorage().catch(console.error);


    initAIModule();
    // åˆå§‹åŒ–å†å²è®°å½• UI
    initAIHistoryUI();
    initMultiCollectionManager();

    // ---------------------------------
    // 3. äº‹ä»¶ç›‘å¬å™¨
    // ---------------------------------

    // ç›‘å¬æ–‡ä»¶ä¸Šä¼  (æœ¬æ¬¡æˆç»©) 
    fileUploader.addEventListener('change', async (event) => {
        await handleFileData(event, 'main');
    });

    // ç›‘å¬æ–‡ä»¶ä¸Šä¼  (å¯¹æ¯”æˆç»©) 
    fileUploaderCompare.addEventListener('change', async (event) => {
        await handleFileData(event, 'compare');
    });

    // æ‰“å¼€å¯¼å…¥æ¨¡æ€æ¡†
    importMainBtn.addEventListener('click', () => {
        G_CurrentImportType = 'main';
        importModalTitle.innerText = 'é€‰æ‹©â€œæœ¬æ¬¡æˆç»©â€æ•°æ®æº';
        openImportModal();
    });

    // æ‰“å¼€å¯¼å…¥æ¨¡æ€æ¡† (å¯¹æ¯”)
    importCompareBtn.addEventListener('click', (e) => {
        if (e.target.classList.contains('disabled')) return;
        G_CurrentImportType = 'compare';
        importModalTitle.innerText = 'é€‰æ‹©â€œå¯¹æ¯”æˆç»©â€æ•°æ®æº';
        openImportModal();
    });

    // å¯¼å…¥æ¨¡æ€æ¡†ï¼šå…³é—­
    importModalCloseBtn.addEventListener('click', () => {
        importModal.style.display = 'none';
    });

    // å¯¼å…¥æ¨¡æ€æ¡†ï¼šä»æ–‡ä»¶
    importModalFromFileBtn.addEventListener('click', () => {
        if (G_CurrentImportType === 'main') {
            fileUploader.click();
        } else if (G_CurrentImportType === 'compare') {
            fileUploaderCompare.click();
        } else if (G_CurrentImportType === 'goal-baseline') {
            // è§¦å‘ç›®æ ‡æ¨¡å—çš„ä¸“ç”¨ä¸Šä¼ æ§ä»¶
            const input = document.getElementById('goal-upload-baseline');
            if (input) input.click();
        } else if (G_CurrentImportType === 'goal-outcome') {
            const input = document.getElementById('goal-upload-outcome');
            if (input) input.click();
        }
        importModal.style.display = 'none';
    });

    // å¯¼å…¥æ¨¡æ€æ¡†ï¼šä»å­˜å‚¨
    // å¯¼å…¥æ¨¡æ€æ¡†ï¼šä»å­˜å‚¨ (Data Center)
    importModalFromStorageBtn.addEventListener('click', async () => {
        const selectedId = importModalSelect.value;
        if (!selectedId) { alert('è¯·é€‰æ‹©ä¸€ä¸ªå·²å­˜çš„æˆç»©å•ï¼'); return; }

        const allData = await loadMultiExamData();
        const selectedExam = allData.find(e => String(e.id) === selectedId);
        if (!selectedExam) { alert('æœªæ‰¾åˆ°æ‰€é€‰æ•°æ®ã€‚'); return; }

        const labelText = `âœ… ${selectedExam.label} (æ¥è‡ªå­˜å‚¨)`;

        // 2. åŒºåˆ†å¯¼å…¥ç±»å‹
        if (G_CurrentImportType === 'main') {
            // --- å¯¼å…¥åˆ°ã€æœ¬æ¬¡æˆç»©ã€‘ ---
            G_StudentsData = selectedExam.students;

            // (A) é‡å»ºç§‘ç›®åˆ—è¡¨
            if (G_StudentsData.length > 0) {
                const allSubjects = new Set();
                G_StudentsData.forEach(student => {
                    if (student.scores) {
                        // =====================================================================
                        // æ¨¡å—åä¸‰é€»è¾‘å·²è¿ç§»è‡³ js/modules/item-analysis/index.js
                        // æ¨¡å—åå››ï¼šAI æ™ºèƒ½åˆ†æ å·²è¿ç§»åˆ° `js/modules/ai-advisor.js`
                        // ä¸‹é¢åœ¨ legacy æ–‡ä»¶ä¸­ä¿ç•™è½»é‡å…¼å®¹ stubï¼ˆç”¨äºææ—§æµè§ˆå™¨ï¼‰ï¼Œ
                        // ç°ä»£æµè§ˆå™¨è¯·ä½¿ç”¨æ¨¡å—åŒ–å®ç°ï¼ˆæ­¤æ–‡ä»¶çš„ AI ä»£ç å·²è¢«è¿ç§»ï¼‰ã€‚

                        function _legacyMissing(name) {
                            console.warn(`${name} has been migrated to ES module. Use modern browser or ensure compatibility shims are loaded.`);
                            return function () {
                                alert(`${name} å·²è¿ç§»ä¸ºæ¨¡å—åŒ–å®ç°ã€‚è¯·åœ¨æ”¯æŒ ES module çš„æµè§ˆå™¨ä¸­ä½¿ç”¨åº”ç”¨æˆ–åŠ è½½å…¼å®¹ shimã€‚`);
                            };
                        }

                        // å…¼å®¹æ€§ stubï¼ˆæ—§ä»£ç ä»å¯è°ƒç”¨ï¼Œä½†ä¼šæç¤ºè¿ç§»ä¿¡æ¯ï¼‰
                        window.initAIModule = window.initAIModule || _legacyMissing('initAIModule');
                        window.generateAIPrompt = window.generateAIPrompt || (async function () { console.warn('generateAIPrompt migrated'); return { system: '', user: '' }; });
                        window.runAIAnalysis = window.runAIAnalysis || _legacyMissing('runAIAnalysis');
                        window.sendAIFollowUp = window.sendAIFollowUp || _legacyMissing('sendAIFollowUp');
                        window.initAIHistoryUI = window.initAIHistoryUI || _legacyMissing('initAIHistoryUI');
                        window.saveToAIHistory = window.saveToAIHistory || _legacyMissing('saveToAIHistory');
                        window.renderAIHistoryList = window.renderAIHistoryList || _legacyMissing('renderAIHistoryList');
                        window.loadAIHistoryItem = window.loadAIHistoryItem || _legacyMissing('loadAIHistoryItem');
                        window.deleteAIHistoryItem = window.deleteAIHistoryItem || _legacyMissing('deleteAIHistoryItem');
                        window.printSingleChatTurn = window.printSingleChatTurn || _legacyMissing('printSingleChatTurn');
                        window.printAIReport = window.printAIReport || _legacyMissing('printAIReport');
                        window.printRangeReport = window.printRangeReport || _legacyMissing('printRangeReport');
                        window.reattachPrintHandlers = window.reattachPrintHandlers || _legacyMissing('reattachPrintHandlers');

}

/**
 * [    ] 2.   é«˜è€ƒèµ‹åˆ†åˆ¶é¢„ä¼° (ç®€æ˜“ç‰ˆ - 21ç­‰çº§èµ‹åˆ†)
 * åŸºäºæ’ä½ç™¾åˆ†æ¯”æ˜ å°„åˆ° 100-30 åˆ†
 */
function calculateAssignedScore(rank, totalCount) {
    if (!totalCount) return 0;
    const percentage = (rank / totalCount) * 100;

    // å…¸å‹  é«˜è€ƒèµ‹åˆ†åŒºé—´ (å¯æ ¹æ®çœä»½æ”¿ç­–è°ƒæ•´)
    // å‰1% -> 100, 1-3% -> 97 ... 
    if (percentage <= 1) return 100;
    if (percentage <= 3) return 97;
    if (percentage <= 6) return 94;
    if (percentage <= 10) return 91;
    if (percentage <= 15) return 88;
    if (percentage <= 21) return 85;
    if (percentage <= 28) return 82;
    if (percentage <= 36) return 79;
    if (percentage <= 45) return 76;
    if (percentage <= 55) return 73;
    if (percentage <= 66) return 70;
    if (percentage <= 78) return 67;
    if (percentage <= 91) return 64;
    if (percentage <= 97) return 61;
    if (percentage <= 99) return 58; // Eç­‰çº§åŒºé—´
    return 40; // æœ€ä½ä¿åº•
}

/**
 * [    ] ç¦å»ºçœ  é«˜è€ƒèµ‹åˆ†ç®—æ³• (3+1+2æ¨¡å¼ - å†é€‰ç§‘ç›®)
 * è§„åˆ™ï¼š
 * Aç­‰çº§: 15%, 100-86
 * Bç­‰çº§: 35%, 85-71
 * Cç­‰çº§: 35%, 70-56
 * Dç­‰çº§: 13%, 55-41
 * Eç­‰çº§: 2%,  40-30
 * å…¬å¼: (Y2-Y)/(Y-Y1) = (T2-X)/(X-T1)  =>  X = ( (Y-Y1)/(Y2-Y1) ) * (T2-T1) + T1
 */
function calculateFujianAssignedScore(studentScore, allScores) {
    // 1. æ•°æ®æ¸…æ´—ä¸æ’åº (ä»é«˜åˆ°ä½)
    const validScores = allScores.filter(s => typeof s === 'number' && !isNaN(s)).sort((a, b) => b - a);
    const total = validScores.length;

    if (total === 0 || typeof studentScore !== 'number') return 'N/A';

    // 2. ç¡®å®šå„ä¸ªç­‰çº§çš„äººæ•°æˆªæ­¢ä½æ¬¡ (å‘ä¸‹å–æ•´)
    // æ³¨æ„ï¼šè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œä¸¥æ ¼åœºæ™¯ä¸‹å¦‚åŒåˆ†éœ€æ‰©å±•åŒºé—´
    const idxA = Math.floor(total * 0.15);          // Aç­‰çº§æˆªæ­¢ç´¢å¼•
    const idxB = Math.floor(total * (0.15 + 0.35)); // Bç­‰çº§æˆªæ­¢ç´¢å¼• (50%)
    const idxC = Math.floor(total * (0.50 + 0.35)); // Cç­‰çº§æˆªæ­¢ç´¢å¼• (85%)
    const idxD = Math.floor(total * (0.85 + 0.13)); // Dç­‰çº§æˆªæ­¢ç´¢å¼• (98%)
    // å‰©ä½™ä¸º Eç­‰çº§

    // 3. ç¡®å®šè€ƒç”Ÿæ‰€åœ¨çš„ç­‰çº§åŒºé—´
    const myRankIdx = validScores.indexOf(studentScore); // è·å–è¯¥åˆ†æ•°çš„æœ€é«˜æ’åç´¢å¼•

    let T1, T2, Y1, Y2;
    let subset = [];

    if (myRankIdx < idxA) {
        // Aç­‰çº§
        T2 = 100; T1 = 86;
        subset = validScores.slice(0, idxA);
    } else if (myRankIdx < idxB) {
        // Bç­‰çº§
        T2 = 85; T1 = 71;
        subset = validScores.slice(idxA, idxB);
    } else if (myRankIdx < idxC) {
        // Cç­‰çº§
        T2 = 70; T1 = 56;
        subset = validScores.slice(idxB, idxC);
    } else if (myRankIdx < idxD) {
        // Dç­‰çº§
        T2 = 55; T1 = 41;
        subset = validScores.slice(idxC, idxD);
    } else {
        // Eç­‰çº§
        T2 = 40; T1 = 30;
        subset = validScores.slice(idxD);
    }

    // 4. è·å–è¯¥ç­‰çº§åŸå§‹åˆ†çš„æœ€é«˜å€¼(Y2)å’Œæœ€ä½å€¼(Y1)
    if (subset.length === 0) return studentScore; // å¼‚å¸¸ä¿æŠ¤
    Y2 = subset[0]; // åŒºé—´æœ€é«˜åŸå§‹åˆ†
    Y1 = subset[subset.length - 1]; // åŒºé—´æœ€ä½åŸå§‹åˆ†

    // 5. ä»£å…¥å…¬å¼è®¡ç®—
    // ç‰¹æ®Šæƒ…å†µï¼šå¦‚æœè¯¥åŒºé—´åªæœ‰ä¸€ä¸ªåˆ†æ•°(Y1=Y2)ï¼Œç›´æ¥ç»™æ»¡åˆ†æˆ–å¹³å‡åˆ†ï¼Ÿé€šå¸¸ç»™ T2
    if (Y2 === Y1) return T2;

    // çº¿æ€§æ’å€¼å…¬å¼
    const assignedScore = ((studentScore - Y1) / (Y2 - Y1)) * (T2 - T1) + T1;

    return Math.round(assignedScore); // å››èˆäº”å…¥å–æ•´
}

/**
 *   6.4. è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—å•ä¸ªåˆ†æ•°æ•°ç»„çš„ç»Ÿè®¡å€¼
 *        åŠ äº† superExcelLine (ç‰¹ä¼˜çº¿) å’Œ lowLine (ä½åˆ†çº¿) å‚æ•°
 */
function calculateStatsForScores(scores, fullMark, passLine, excellentLine, goodLine, superExcelLine, lowLine) {
    const count = scores.length;

    //    é»˜è®¤å€¼ä¿æŠ¤ï¼šå¦‚æœæœªå®šä¹‰ï¼Œç»™ä¸€ä¸ªé»˜è®¤å€¼é˜²æ­¢æŠ¥é”™
    if (superExcelLine === undefined) superExcelLine = fullMark * 0.9;
    if (lowLine === undefined) lowLine = passLine * 0.5;

    if (count === 0) return { average: 0, max: 0, min: 0, median: 0, passRate: 0, excellentRate: 0, goodRate: 0, failRate: 0, superRate: 0, lowRate: 0, count: 0, variance: 0, stdDev: 0, difficulty: 0, scores: [] };

    const total = scores.reduce((acc, score) => acc + score, 0);
    const average = total / count;
    const max = scores[count - 1];
    const min = scores[0];

    const mid = Math.floor(count / 2);
    const median = count % 2 === 0 ? (scores[mid - 1] + scores[mid]) / 2 : scores[mid];

    const variance = (count > 0) ? scores.reduce((acc, score) => acc + Math.pow(score - average, 2), 0) / count : 0;
    const stdDev = (count > 0) ? Math.sqrt(variance) : 0;

    const difficulty = (fullMark > 0) ? parseFloat((average / fullMark).toFixed(2)) : 0;

    const passCount = scores.filter(s => s >= passLine).length;
    const excellentCount = scores.filter(s => s >= excellentLine).length;

    // (B) - B (è‰¯å¥½) = [goodLine, excelLine)
    const countB = scores.filter(s => s >= goodLine && s < excellentLine).length;
    // (D) - D (ä¸åŠæ ¼) = < passLine
    const countD = scores.filter(s => s < passLine).length;

    // (C) - C (åŠæ ¼) = [passLine, goodLine)
    const countC = scores.filter(s => s >= passLine && s < goodLine).length;
    const cRate = (count > 0) ? (countC / count) * 100 : 0;

    // è‰¯å¥½ç‡ (Bçº§ç‡)
    const goodRate = (count > 0) ? (countB / count) * 100 : 0;
    // ä¸åŠæ ¼ç‡ (Dçº§ç‡)
    const failRate = (count > 0) ? (countD / count) * 100 : 0;

    //    (    ) ç‰¹ä¼˜ç‡ (Super Excellent)
    const countSuper = scores.filter(s => s >= superExcelLine).length;
    const superRate = (count > 0) ? (countSuper / count) * 100 : 0;

    //    (    ) ä½åˆ†ç‡ (Low Score)
    const countLow = scores.filter(s => s < lowLine).length;
    const lowRate = (count > 0) ? (countLow / count) * 100 : 0;

    return {
        count: count,
        average: parseFloat(average.toFixed(2)),
        max: max,
        min: min,
        median: median,
        passRate: parseFloat(((passCount / count) * 100).toFixed(2)),
        excellentRate: parseFloat(((excellentCount / count) * 100).toFixed(2)),
        goodRate: parseFloat(goodRate.toFixed(2)),
        cRate: parseFloat(cRate.toFixed(2)),
        failRate: parseFloat(failRate.toFixed(2)),

        //        è¿”å›æŒ‡æ ‡
        superRate: parseFloat(superRate.toFixed(2)),
        lowRate: parseFloat(lowRate.toFixed(2)),

        variance: parseFloat(variance.toFixed(2)),
        stdDev: parseFloat(stdDev.toFixed(2)),
        difficulty: difficulty,
        scores: scores
    };
}

// ---------------------------------
// 7. æ¨¡å—æ¸²æŸ“ (Routing)
// ---------------------------------

/**
 * (    ) 7.1. æ ¸å¿ƒåˆ†æä¸æ¸²æŸ“è§¦å‘å™¨
 *       å…è®¸ multi-exam æ¨¡å—åœ¨æ²¡æœ‰ G_StudentsData æ—¶è¿è¡Œ
 */
function runAnalysisAndRender() {
    // 1.      å…ˆè·å–å½“å‰è¦æ¸²æŸ“çš„æ¨¡å—
    const currentModuleLink = document.querySelector('.nav-link.active');
    if (!currentModuleLink) return;
    const currentModule = currentModuleLink.dataset.module;

    // 2.      å¦‚æœæ˜¯â€œå¤šæ¬¡è€ƒè¯•åˆ†æâ€æˆ–â€œå°é¢˜åˆ†æâ€ï¼Œåˆ™ç‰¹æ®Šå¤„ç†
    if (currentModule === 'multi-exam') {
        renderModule(currentModule, [], []);
        return;
    }
    //    NEW   
    if (currentModule === 'item-analysis') {
        renderModule(currentModule, [], []);
        return;
    }

    // 3.    (åŸç¬¬1è¡Œ) å¯¹æ‰€æœ‰å…¶ä»–æ¨¡å—ï¼Œæ‰§è¡Œæ•°æ®æ£€æŸ¥
    if (G_StudentsData.length === 0) {
        console.warn("runAnalysisAndRender: G_StudentsData ä¸ºç©ºï¼Œå·²é€€å‡ºã€‚");
        return;
    }

    // 4. (    ) æ ¹æ®ç­çº§ç­›é€‰
    const currentFilter = classFilterSelect.value;
    let activeData = G_StudentsData;
    let activeCompareData = G_CompareData;

    if (currentFilter !== 'ALL') {
        activeData = G_StudentsData.filter(s => s.class === currentFilter);

        if (G_CompareData.length > 0) {
            activeCompareData = G_CompareData.filter(s => s.class === currentFilter);
        }
    }

    // 5.   é‡  è®¡ç®—ç»Ÿè®¡æ•°æ®
    G_Statistics = calculateAllStatistics(activeData);
    calculateStandardScores(activeData, G_Statistics);
    if (activeCompareData.length > 0) {
        G_CompareStatistics = calculateAllStatistics(activeCompareData);

        calculateStandardScores(activeCompareData, G_CompareStatistics); // <-- å…³é”®ï¼šè¿™ä¸€è¡Œä¹‹å‰æ¼äº†
    }

    // 6.   æ¸²æŸ“å½“å‰æ¿€æ´»çš„æ¨¡å—
    // (currentModule å·²åœ¨æœ€å‰é¢è·å–)
    renderModule(currentModule, activeData, activeCompareData);
}

/**
 *   7.2. æ¨¡å—æ¸²æŸ“çš„â€œè·¯ç”±å™¨â€
 *    å·²     case 'weakness'
 */
function renderModule(moduleName, activeData, activeCompareData) {
    //    (    ) æ¸²æŸ“ä»»ä½•æ¨¡å—æ—¶ï¼Œéƒ½è‡ªåŠ¨éšè—æ¬¢è¿å±å¹•
    if (welcomeScreen) welcomeScreen.style.display = 'none';

    modulePanels.forEach(p => p.style.display = 'none');
    const container = document.getElementById(`module-${moduleName}`);
    if (!container) return;
    container.style.display = 'block';

    //   G_Statistics å·²ç»æ˜¯ç®—å¥½çš„
    switch (moduleName) {
        case 'dashboard':
            renderDashboard(container, G_Statistics, activeData);
            break;
        case 'student':
            renderStudent(container, activeData, G_Statistics);
            break;
        case 'paper':
            renderPaper(container, G_Statistics, activeData);
            break;
        case 'single-subject':
            renderSingleSubject(container, activeData, G_Statistics);
            break;

        //    (    ) 3ä¸ª  æ¨¡å—çš„è·¯ç”±
        case 'boundary':
            renderBoundary(container, activeData, G_Statistics);
            break;
        case 'holistic':
            renderHolisticBalance(container, activeData, G_Statistics);
            break;
        case 'trend-distribution':
            renderTrendDistribution(container, activeData, activeCompareData, G_Statistics, G_CompareStatistics, G_CurrentClassFilter); //    (    ) ä¼ å…¥ G_CurrentClassFilter
            break;
        case 'multi-exam':
            renderMultiExam(container);
            break;
        case 'trend':
            renderTrend(container, activeData, activeCompareData);
            break;
        case 'groups':
            renderGroups(container, activeData);
            break;
        case 'correlation':
            renderCorrelation(container, activeData);
            break;
        //    (    ) åç§‘è¯Šæ–­
        case 'weakness':
            renderWeakness(container, activeData, G_Statistics); //    (    ) ä¼ å…¥ G_Statistics
            break;
        //å°é¢˜åˆ†æ
        case 'item-analysis':
            renderItemAnalysis(container);
            break;

        case 'ai-advisor':
            //    ä¿®å¤    æ¯æ¬¡è¿›å…¥ AI æ¨¡å—æ—¶ï¼Œå¼ºåˆ¶åˆ·  ä¸€ä¸‹ UI
            // è¿™æ ·ä½ åœ¨æ¨¡å— 13 åˆšå¯¼å…¥çš„æ•°æ®ï¼Œè¿™é‡Œä¹Ÿèƒ½ç«‹é©¬çœ‹åˆ°äº†
            const aiModeSelect = document.getElementById('ai-mode-select');
            if (aiModeSelect) {
                // æ¨¡æ‹Ÿç”¨æˆ·â€œåˆ‡æ¢â€äº†ä¸€æ¬¡æ¨¡å¼ï¼Œè§¦å‘æ•°æ®é‡  åŠ è½½
                aiModeSelect.dispatchEvent(new Event('change'));
            }
            break;

        case 'goal-setting':
            renderGoalSetting(container, activeData, G_Statistics);
            break;

        //    åœ¨è¿™é‡Œæ’å…¥è¿™ä¸€æ®µ   
        case 'exam-arrangement':
            renderExamArrangement(container);
            break;

        //            æ™ºèƒ½äº’åŠ©åˆ†ç»„
        case 'study-groups':
            renderStudyGroups(container);
            break;

        case 'comment-gen':
            renderCommentGenerator(container);
            break;

        //            é”™é¢˜æ”»åšæœ¬
        case 'weakness-workbook':
            renderWeaknessWorkbook(container);
            break;

        case 'honor':
            renderHonorWall(container);
            break;

        default:
            container.innerHTML = `<h2>æ¨¡å— ${moduleName} (å¾…å¼€å‘)</h2>`;
    }
}

/**
 * (    ) 7.3. å¡«å……ç­çº§ç­›é€‰
 */
function populateClassFilter(students) {
    const classes = [...new Set(students.map(s => s.class))].sort();

    let html = `<option value="ALL">-- å…¨ä½“å¹´æ®µ --</option>`;
    html += classes.map(c => `<option value="${c}">${c}</option>`).join('');

    classFilterSelect.innerHTML = html;
    G_CurrentClassFilter = 'ALL';
}

// ---------------------------------
// 8. ç§‘ç›®é…ç½® (Modal)
// ---------------------------------

/**
 * (    ) 8.1. åˆå§‹åŒ– G_SubjectConfigs
 */
function initializeSubjectConfigs() {
    G_SubjectConfigs = {};
    G_DynamicSubjectList.forEach(subject => {
        const isY_S_W = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­'].includes(subject);

        G_SubjectConfigs[subject] = {
            full: isY_S_W ? 150 : 100,
            superExcel: isY_S_W ? 135 : 90,
            excel: isY_S_W ? 120 : 85,
            good: isY_S_W ? 105 : 75,
            pass: isY_S_W ? 90 : 60,
            low: isY_S_W ? 45 : 30,
            isAssigned: false //            é»˜è®¤ä¸ºä¸èµ‹åˆ†
        };
    });
}

/**
 * (    ) 8.2. ç”¨ G_SubjectConfigs å¡«å……æ¨¡æ€çª—å£ (ä¿®å¤ç‰ˆï¼šè‡ªåŠ¨è¡¥å…¨é»˜è®¤å€¼)
 */


/**
 * (    ) 8.2. ç”¨ G_SubjectConfigs å¡«å……æ¨¡æ€çª—å£
 *    ä¿®æ­£ç‰ˆ 3      åŠ â€œæ˜¯å¦èµ‹åˆ†â€åˆ—
 */
function populateSubjectConfigModal() {
    let html = '';
    G_DynamicSubjectList.forEach(subject => {
        const config = G_SubjectConfigs[subject];

        const valSuper = config.superExcel !== undefined ? config.superExcel : (config.full * 0.9);
        const valLow = config.low !== undefined ? config.low : (config.full * 0.3);

        //            è¯»å–æ˜¯å¦èµ‹åˆ† (é»˜è®¤ false)
        const isAssigned = config.isAssigned === true;

        html += `
            <tr>
                <td><strong>${subject}</strong></td>
                <td style="text-align:center;">
                    <input type="checkbox" data-subject="${subject}" data-type="isAssigned" ${isAssigned ? 'checked' : ''} style="width:auto;">
                </td>
                <td><input type="number" data-subject="${subject}" data-type="full" value="${config.full}" style="width:50px"></td>
                <td><input type="number" data-subject="${subject}" data-type="superExcel" value="${valSuper}" style="width:50px; color:#6f42c1; font-weight:bold;"></td>
                <td><input type="number" data-subject="${subject}" data-type="excel" value="${config.excel}" style="width:50px"></td>
                <td><input type="number" data-subject="${subject}" data-type="good" value="${config.good}" style="width:50px"></td>
                <td><input type="number" data-subject="${subject}" data-type="pass" value="${config.pass}" style="width:50px"></td>
                <td><input type="number" data-subject="${subject}" data-type="low" value="${valLow}" style="width:50px; color:#dc3545;"></td>
            </tr>
        `;
    });

    const tableHead = document.querySelector('#subject-config-table thead');
    tableHead.innerHTML = `
        <tr>
            <th>ç§‘ç›®</th>
            <th>èµ‹åˆ†?</th> <th>æ»¡åˆ†</th>
            <th style="color:#6f42c1">ç‰¹ä¼˜çº¿</th>
            <th>ä¼˜ç§€çº¿</th>
            <th>è‰¯å¥½çº¿</th>
            <th>åŠæ ¼çº¿</th>
            <th style="color:#dc3545">ä½åˆ†çº¿</th>
        </tr>
    `;

    subjectConfigTableBody.innerHTML = html;
}

/**
 * (    ) 8.3. ä»æ¨¡æ€çª—å£ä¿å­˜é…ç½®
 *    ç»ˆæä¿®å¤ç‰ˆ    ä¸“é—¨å¤„ç† Checkbox çš„ä¿å­˜é€»è¾‘
 */
function saveSubjectConfigsFromModal() {
    // è·å–è¡¨æ ¼é‡Œæ‰€æœ‰çš„ input æ ‡ç­¾
    const inputs = subjectConfigTableBody.querySelectorAll('input');

    inputs.forEach(input => {
        const subject = input.dataset.subject;
        const type = input.dataset.type; 

        
        if (!G_SubjectConfigs[subject]) {
            G_SubjectConfigs[subject] = {};
        }

        
        if (input.type === 'checkbox') {
            
            G_SubjectConfigs[subject][type] = input.checked;
            console.log(`æ›´   ${subject} çš„èµ‹åˆ†çŠ¶æ€: ${input.checked}`); // è°ƒè¯•æ—¥å¿—
        } else {
            // å¦‚æœæ˜¯æ•°å­—æ¡†ï¼Œæˆ‘ä»¬è¦å­˜çš„æ˜¯æ•°å­— (valueå±æ€§)
            G_SubjectConfigs[subject][type] = parseFloat(input.value);
        }
    });

    // ä¿å­˜åˆ°æ•°æ®åº“
    localforage.setItem('G_SubjectConfigs', G_SubjectConfigs).then(() => {
        console.log("é…ç½®å·²æˆåŠŸä¿å­˜è‡³ IndexedDB");
        alert("é…ç½®å·²ä¿å­˜ï¼"); // [æç¤º] åŠ ä¸ªå¼¹çª—ç¡®è®¤ä¿å­˜æˆåŠŸ
    });
}


// ---------------------------------
// 9. å„æ¨¡å—å…·ä½“å®ç°
// ---------------------------------
/**
/**
/**
 * 9.1. [å®Œæ•´ä¿®å¤ç‰ˆ] æ¨¡å—ä¸€ï¼šç­çº§æ•´ä½“åˆ†æ
 * - ä¿®å¤ï¼šReferenceError: drawHistogram is not defined
 * - ä¼˜åŒ–ï¼šè°ƒæ•´å‡½æ•°å®šä¹‰é¡ºåºï¼Œç¡®ä¿æ‰€æœ‰å›¾è¡¨å‡½æ•°åœ¨è°ƒç”¨å‰å·²å®šä¹‰
 */
function renderDashboard(container, stats, activeData) {
    const totalStats = stats.totalScore || {};

    // 1. è®¡ç®—åŸºç¡€ KPI
    const totalStudentCount = activeData.length;
    const participantCount = totalStats.count || 0;
    const missingCount = totalStudentCount - participantCount;

    // [åŠ¨æ€è¡¨æ ¼çŠ¶æ€]
    let currentSelectedSubjects = [...G_DynamicSubjectList];

    // 2. æ„å»º HTML ç»“æ„
    container.innerHTML = `
        <h2>æ¨¡å—ä¸€ï¼šæ•´ä½“æˆç»©åˆ†æ (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>
        
        <div class="kpi-grid">
            <div class="kpi-card"><h3>æ€»äººæ•°</h3><div class="value">${totalStudentCount}</div></div>
            <div class="kpi-card"><h3>è€ƒè¯•äººæ•°</h3><div class="value">${participantCount}</div></div>
            <div class="kpi-card"><h3>ç¼ºè€ƒäººæ•°</h3><div class="value">${missingCount}</div></div>
            <div class="kpi-card"><h3>åŸå§‹æ€»åˆ†å‡åˆ†</h3><div class="value">${totalStats.average || 0}</div></div>
            <div class="kpi-card"><h3>åŸå§‹æ€»åˆ†æœ€é«˜</h3><div class="value">${totalStats.max || 0}</div></div>
            <div class="kpi-card"><h3>åŸå§‹æ€»åˆ†æœ€ä½</h3><div class="value">${totalStats.min || 0}</div></div>
            <div class="kpi-card"><h3>æ€»åˆ†ä¸­ä½æ•°</h3><div class="value">${totalStats.median || 0}</div></div>
            <div class="kpi-card"><h3>æ€»åˆ†ä¼˜ç§€ç‡ (%)</h3><div class="value">${totalStats.excellentRate || 0}</div></div>
            <div class="kpi-card"><h3>æ€»åˆ†è‰¯å¥½ç‡ (%)</h3><div class="value">${totalStats.goodRate || 0}</div></div>
            <div class="kpi-card"><h3>æ€»åˆ†åŠæ ¼ç‡ (%)</h3><div class="value">${totalStats.passRate || 0}</div></div>
            <div class="kpi-card"><h3>æ€»åˆ†ä¸åŠæ ¼ç‡ (%)</h3><div class="value">${totalStats.failRate || 0}</div></div>
            <div class="kpi-card"><h3>æ€»åˆ†æ ‡å‡†å·®</h3><div class="value">${totalStats.stdDev || 0}</div></div>
        </div>

        <div class="main-card-wrapper" style="margin-bottom: 20px; border-left: 5px solid #20c997;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3 style="margin:0; color:#333;">ğŸ“ˆ æˆç»©åˆ†æ®µäººæ•°åˆ†å¸ƒ (æ›²çº¿å›¾)</h3>
                <div class="controls-bar" style="background:transparent; box-shadow:none; padding:0; margin:0; align-items:center;">
                    <label>ç§‘ç›®:</label>
                    <select id="curve-subject-select" class="sidebar-select" style="width:auto; min-width:100px;">
                        <option value="totalScore">æ€»åˆ†</option>
                        <option value="ALL_SUBJECTS" style="color:#6f42c1; font-weight:bold;">ğŸ“Œ å…¨ç§‘å¯¹æ¯” (All)</option>
                        ${G_DynamicSubjectList.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                    
                    <div style="display:flex; align-items:center; margin-left:15px;">
                        <input type="checkbox" id="curve-compare-class" style="margin-right:5px; cursor:pointer;">
                        <label for="curve-compare-class" style="cursor:pointer; user-select:none; font-weight:bold; color:#007bff;">å¯¹æ¯”å„ç­</label>
                    </div>

                    <label style="margin-left:15px;">åˆ†æ®µé—´éš”:</label>
                    <input type="number" id="curve-bin-size" value="50" style="width:60px; text-align:center;" class="sidebar-select">
                    <button id="btn-update-curve" class="sidebar-button" style="margin-left:10px; padding:5px 15px; background-color:#20c997;">ç¡®å®š</button>
                </div>
            </div>
            <div class="chart-container" id="score-distribution-curve" style="height: 400px;"></div>
            <div id="curve-analysis-text" style="background:#f8f9fa; padding:15px; border-radius:6px; margin-top:10px; color:#555; font-size:0.95em; line-height:1.6;"></div>
        </div>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <h3>å…¨ç§‘ç»Ÿè®¡è¡¨</h3>
            <div class="table-container" style="max-height: 400px;">
                <table>
                    <thead>
                        <tr>
                            <th>ç§‘ç›®</th><th>è€ƒè¯•äººæ•°</th><th>å¹³å‡åˆ†</th><th>æœ€é«˜åˆ†</th><th>ä¸­ä½æ•°</th><th>ä¼˜ç§€ç‡ (%)</th><th>è‰¯å¥½ç‡ (%)</th><th>åŠæ ¼ç‡ (%)</th><th>æ ‡å‡†å·®</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="total-score-row">
                            <td><strong>${stats.totalScore.name}</strong></td>
                            <td>${stats.totalScore.count}</td><td>${stats.totalScore.average}</td><td>${stats.totalScore.max}</td><td>${stats.totalScore.median}</td>
                            <td>${stats.totalScore.excellentRate}</td><td>${stats.totalScore.goodRate || 0}</td><td>${stats.totalScore.passRate}</td><td>${stats.totalScore.stdDev || 0}</td>
                        </tr>
                        ${G_DynamicSubjectList.map(subject => stats[subject]).filter(s => s).map(s => `
                            <tr>
                                <td><strong>${s.name}</strong></td>
                                <td>${s.count}</td><td>${s.average}</td><td>${s.max}</td><td>${s.median}</td>
                                <td>${s.excellentRate}</td><td>${s.goodRate || 0}</td><td>${s.passRate}</td><td>${s.stdDev || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-chart-grid-2x2">
            <div class="main-card-wrapper"><div class="controls-bar chart-controls"><h4 style="margin:0;">å…¨ç§‘åˆ†æ•°åˆ†å¸ƒç®±å½¢å›¾</h4></div><div class="chart-container" id="subject-boxplot-chart" style="height: 350px;"></div></div>
            <div class="main-card-wrapper"><div class="controls-bar chart-controls"><label>ç§‘ç›®:</label><select id="class-compare-subject" class="sidebar-select" style="min-width: 100px;"><option value="totalScore">æ€»åˆ†</option>${G_DynamicSubjectList.map(s => `<option value="${s}">${s}</option>`).join('')}</select><label>æŒ‡æ ‡:</label><select id="class-compare-metric" class="sidebar-select" style="min-width: 120px;"><option value="average">å¹³å‡åˆ†</option><option value="passRate">åŠæ ¼ç‡ (%)</option><option value="stdDev">æ ‡å‡†å·®</option><option value="max">æœ€é«˜åˆ†</option><option value="median">ä¸­ä½æ•°</option></select></div><div class="chart-container" id="class-compare-chart" style="height: 350px;"></div></div>
            <div class="main-card-wrapper"><div class="chart-container" id="radar-chart" style="height: 400px;"></div></div>
            
            <div class="main-card-wrapper"><div class="controls-bar chart-controls"><label>åˆ†æ®µ:</label><input type="number" id="histogram-bin-size" value="30" style="width: 60px;"><button id="histogram-redraw-btn" class="sidebar-button" style="width: auto;">é‡ç»˜</button></div><div class="chart-container" id="histogram-chart" style="height: 350px;"></div></div>
            
            <div class="main-card-wrapper"><div class="controls-bar chart-controls"><label>Xè½´:</label><select id="scatter-x-subject" class="sidebar-select">${G_DynamicSubjectList.map(s => `<option value="${s}">${s}</option>`).join('')}</select><label>Yè½´:</label><select id="scatter-y-subject" class="sidebar-select">${G_DynamicSubjectList.map((s, i) => `<option value="${s}" ${i === 1 ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="chart-container" id="correlation-scatter-chart" style="height: 350px;"></div></div>
            <div class="main-card-wrapper"><div class="controls-bar chart-controls"><h4 style="margin:0;">å„ç§‘ A/B/C/D æ„æˆ</h4></div><div class="chart-container" id="stacked-bar-chart" style="height: 350px;"></div></div>
            <div class="main-card-wrapper" style="grid-column: span 2;"><div class="controls-bar chart-controls"><h4 style="margin:0;">è´¡çŒ®åº¦åˆ†æ</h4></div><div class="chart-container" id="contribution-chart" style="height: 400px;"></div></div>
        </div>

        <div class="main-card-wrapper" style="margin-top: 20px; min-height: 500px;">
            <style>
                #dashboard-full-table th:nth-child(1), #dashboard-full-table td:nth-child(1) { position: sticky; left: 0; z-index: 2; background-color: #fff; width: 90px; }
                #dashboard-full-table th:nth-child(2), #dashboard-full-table td:nth-child(2) { position: sticky; left: 90px; z-index: 2; background-color: #fff; width: 90px; }
                #dashboard-full-table th:nth-child(3), #dashboard-full-table td:nth-child(3) { position: sticky; left: 180px; z-index: 2; background-color: #fff; width: 110px; border-right: 2px solid #dcdfe6 !important; box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1); }
                #dashboard-full-table thead th:nth-child(1), #dashboard-full-table thead th:nth-child(2), #dashboard-full-table thead th:nth-child(3) { z-index: 5; background-color: #f8f9fa; }
                .subject-dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 10; padding: 10px; border-radius: 4px; border: 1px solid #eee; top: 100%; left: 0; }
                .subject-dropdown-content.show { display: block; }
                .subject-checkbox-item { display: block; margin: 5px 0; cursor: pointer; }
            </style>

            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap: 15px; margin-bottom:15px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <div style="display:flex; flex-direction:column;">
                    <h3 style="margin:0; white-space: nowrap;">ğŸ“‹ åŠ¨æ€æˆç»©æ˜ç»†è¡¨</h3>
                    <span style="font-size:0.8em; color:#e6a23c; margin-top:4px;">âš¡ï¸ å‹¾é€‰ç§‘ç›®åï¼Œæ€»åˆ†ä¸æ’åå°†å®æ—¶é‡ç®—</span>
                </div>
                
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="position: relative;">
                        <button id="btn-toggle-subjects" class="sidebar-button" style="background-color:#6f42c1; padding: 6px 15px; font-size: 0.9em;">ğŸ“š é€‰æ‹©ç§‘ç›® â–¼</button>
                        <div id="subject-dropdown" class="subject-dropdown-content">
                            <div style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px; display:flex; justify-content:space-between;">
                                <span style="font-weight:bold; font-size:0.9em;">å‚ä¸è®¡ç®—çš„ç§‘ç›®:</span>
                                <a href="#" id="btn-all-subjects" style="font-size:0.8em; color:#007bff;">å…¨é€‰</a>
                            </div>
                            <div id="subject-checkbox-list" style="max-height:200px; overflow-y:auto;"></div>
                        </div>
                    </div>
                    <button id="btn-print-dynamic-table" class="sidebar-button" style="background-color:#17a2b8; padding: 6px 15px; font-size: 0.9em;">ğŸ–¨ï¸ æ‰“å°æ¸…å•</button>
                    <div style="display:flex; align-items:center; gap:10px; background-color: #f8f9fa; padding: 6px 15px; border-radius: 20px; border: 1px solid #e9ecef;">
                        <span style="font-size:1.1em;">ğŸ”</span>
                        <select id="dashboard-table-filter" class="sidebar-select" style="width:auto; min-width:130px; padding: 4px 8px; height: 34px; margin:0;">
                            <option value="ALL">-- å…¨éƒ¨ç­çº§ --</option>
                        </select>
                        <input type="text" id="dashboard-table-search" placeholder="è¾“å…¥å§“åæˆ–è€ƒå·..." class="sidebar-select" style="width: 160px; padding: 4px 8px; height: 34px; margin:0;">
                    </div>
                </div>
            </div>
            
            <div class="table-container" style="max-height: 600px; overflow-y: auto; border: 1px solid #eee;">
                <table id="dashboard-full-table" style="border-collapse: separate; border-spacing: 0;">
                    <thead id="dashboard-table-head"></thead>
                    <tbody id="dashboard-full-tbody"></tbody>
                </table>
            </div>
            <div style="margin-top:8px; font-size:0.85em; color:#999; text-align:right;">
                * å‘å³æ»‘åŠ¨è¡¨æ ¼å¯å›ºå®šèº«ä»½åˆ—ã€‚æ˜¾ç¤ºæ ¼å¼ï¼š<b>åˆ†æ•° (å¹´æ’)</b>ã€‚<span style="color:#dc3545;">çº¢è‰²</span>ä»£è¡¨ä¸åŠæ ¼ã€‚
            </div>
        </div>
    `;

    // ============================================
    // 3. å®šä¹‰ç»˜å›¾è¾…åŠ©å‡½æ•° (å…³é”®ä¿®å¤ï¼šå…ˆå®šä¹‰ï¼Œå†ç»‘å®š)
    // ============================================

    // (1) ç›´æ–¹å›¾å‡½æ•°
    const drawHistogram = () => {
        if (totalStats.scores && totalStats.scores.length > 0) {
            const fullScore = G_DynamicSubjectList.reduce((sum, key) => sum + (G_SubjectConfigs[key]?.full || 0), 0);
            const binSize = parseInt(document.getElementById('histogram-bin-size').value) || 30;
            if (typeof renderHistogram === 'function') {
                renderHistogram('histogram-chart', activeData, 'totalScore', fullScore, `æ€»åˆ†åˆ†æ•°æ®µç›´æ–¹å›¾ (åˆ†æ®µ=${binSize})`, binSize);
            }
        }
    };

    // (2) æ›²çº¿å›¾å‡½æ•°
// (2) æ›²çº¿å›¾å‡½æ•° (æ›´æ–°ç‰ˆ)
    const updateCurveChart = () => {
        const subject = document.getElementById('curve-subject-select').value;
        const binSize = parseInt(document.getElementById('curve-bin-size').value) || 50;
        const isClassCompare = document.getElementById('curve-compare-class').checked; // è·å–å‹¾é€‰çŠ¶æ€

        // æ³¨æ„ï¼šå¦‚æœæ˜¯â€œå¯¹æ¯”å„ç­â€æ¨¡å¼ï¼Œæˆ‘ä»¬éœ€è¦å¼ºåˆ¶ä¼ å…¥æ‰€æœ‰å­¦ç”Ÿæ•°æ®(G_StudentsData)ï¼Œè€Œä¸æ˜¯ç­›é€‰åçš„(activeData)
        const sourceData = isClassCompare ? G_StudentsData : activeData;

        if (typeof renderScoreCurve === 'function') {
            renderScoreCurve('score-distribution-curve', sourceData, subject, binSize, isClassCompare);
        }
    };
    
    // æ–°å¢ï¼šç»‘å®š checkbox çš„ change äº‹ä»¶ï¼Œä¸€ç‚¹å°±åˆ·æ–°
    const compareCb = document.getElementById('curve-compare-class');
    if(compareCb) {
        compareCb.addEventListener('change', updateCurveChart);
    }

    // (3) ç­çº§å¯¹æ¯”å›¾å‡½æ•°
    const updateClassChart = () => {
        const classCompareSel = document.getElementById('class-compare-subject');
        const classMetricSel = document.getElementById('class-compare-metric');
        if (!classCompareSel || G_CurrentClassFilter !== 'ALL') return;
        
        const d = calculateClassComparison(classMetricSel.value, classCompareSel.value);
        let subName = classCompareSel.value === 'totalScore' ? 'æ€»åˆ†' : classCompareSel.value;
        let metName = classMetricSel.options[classMetricSel.selectedIndex].text;
        renderClassComparisonChart('class-compare-chart', d, `å„ç­çº§ - ${subName} ${metName} å¯¹æ¯”`);
    };

    // (4) æ•£ç‚¹å›¾å‡½æ•°
    const updateScat = () => {
        const scatX = document.getElementById('scatter-x-subject');
        const scatY = document.getElementById('scatter-y-subject');
        if (scatX && scatY) {
            renderCorrelationScatterPlot('correlation-scatter-chart', activeData, scatX.value, scatY.value);
        }
    };

    // (5) è´¡çŒ®åº¦å›¾å‡½æ•°
    const drawContribution = () => {
        if (G_CurrentClassFilter === 'ALL') {
            document.getElementById('contribution-chart').innerHTML = `<p style="text-align:center; padding-top:50px; color:#999;">è¯·é€‰æ‹©å…·ä½“ç­çº§ä»¥æŸ¥çœ‹è´¡çŒ®åº¦åˆ†æã€‚</p>`;
            return;
        }
        const globalStats = calculateAllStatistics(G_StudentsData); 
        const subjects = G_DynamicSubjectList;
        const contributionData = subjects.map(sub => {
            const classAvg = stats[sub] ? stats[sub].average : 0;
            const gradeAvg = globalStats[sub] ? globalStats[sub].average : 0;
            return parseFloat((classAvg - gradeAvg).toFixed(2));
        });
        const totalDiff = contributionData.reduce((a, b) => a + b, 0).toFixed(2);
        renderContributionChart('contribution-chart', subjects, contributionData, totalDiff);
    };

    // ============================================
    // 4. ç»‘å®šäº‹ä»¶
    // ============================================
    
    // æ›²çº¿å›¾
    const curveBinInput = document.getElementById('curve-bin-size');
    const curveSubjectSelect = document.getElementById('curve-subject-select');
    document.getElementById('btn-update-curve').addEventListener('click', updateCurveChart);
    curveSubjectSelect.addEventListener('change', () => {
        if (curveSubjectSelect.value === 'totalScore') curveBinInput.value = 50;
        else curveBinInput.value = 10;
        updateCurveChart();
    });

    // ç›´æ–¹å›¾
    document.getElementById('histogram-redraw-btn').addEventListener('click', drawHistogram);

    // ç­çº§å¯¹æ¯”
    const classCompareSel = document.getElementById('class-compare-subject');
    const classMetricSel = document.getElementById('class-compare-metric');
    if(classCompareSel) {
        classCompareSel.addEventListener('change', updateClassChart);
        classMetricSel.addEventListener('change', updateClassChart);
    }

    // æ•£ç‚¹å›¾
    const scatX = document.getElementById('scatter-x-subject');
    const scatY = document.getElementById('scatter-y-subject');
    if(scatX) {
        scatX.addEventListener('change', updateScat);
        scatY.addEventListener('change', updateScat);
    }

    // ============================================
    // 5. [æ ¸å¿ƒ] åŠ¨æ€è¡¨æ ¼é€»è¾‘å®ç°
    // ============================================
    const initDynamicTable = () => {
        const dropdownBtn = document.getElementById('btn-toggle-subjects');
        const dropdownContent = document.getElementById('subject-dropdown');
        const checkboxList = document.getElementById('subject-checkbox-list');
        const btnAll = document.getElementById('btn-all-subjects');
        const filterSelect = document.getElementById('dashboard-table-filter');
        const searchInput = document.getElementById('dashboard-table-search');
        const tableHead = document.getElementById('dashboard-table-head');
        const tableBody = document.getElementById('dashboard-full-tbody');

        // A. å¡«å…… Checkbox
        checkboxList.innerHTML = G_DynamicSubjectList.map(sub => `
            <label class="subject-checkbox-item">
                <input type="checkbox" value="${sub}" checked> ${sub}
            </label>
        `).join('');

        // B. å¡«å……ç­çº§ç­›é€‰
        const allClassSet = new Set(G_StudentsData.map(s => s.class));
        const allClasses = Array.from(allClassSet).sort();
        filterSelect.innerHTML = `<option value="ALL">-- å…¨éƒ¨ç­çº§ --</option>` + allClasses.map(c => `<option value="${c}">${c}</option>`).join('');
        if (G_CurrentClassFilter !== 'ALL') filterSelect.value = G_CurrentClassFilter;

        // --- æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ---
        const renderDynamicData = () => {
            const dynamicData = G_StudentsData.map(s => {
                let dynamicTotal = 0;
                let hasScore = false;
                currentSelectedSubjects.forEach(sub => {
                    const score = s.scores[sub];
                    if (typeof score === 'number') { dynamicTotal += score; hasScore = true; }
                });
                if (!hasScore) dynamicTotal = -1;
                return { raw: s, id: s.id, name: s.name, class: s.class, dynamicTotal: parseFloat(dynamicTotal.toFixed(2)), dynamicRank: 0 };
            });

            dynamicData.sort((a, b) => b.dynamicTotal - a.dynamicTotal);
            dynamicData.forEach((item, index) => {
                item.dynamicRank = (item.dynamicTotal >= 0) ? (index + 1) : '-';
                if (item.dynamicTotal < 0) item.dynamicTotal = 0;
            });

            const filterClass = filterSelect.value;
            const searchText = searchInput.value.toLowerCase().trim();
            let displayList = dynamicData.filter(item => {
                if (filterClass !== 'ALL' && item.class !== filterClass) return false;
                if (searchText && !item.name.includes(searchText) && !String(item.id).includes(searchText)) return false;
                return true;
            });

            const { key, direction } = G_DashboardTableSort;
            displayList.sort((a, b) => {
                let valA, valB;
                if (key === 'dynamicTotal' || key === 'dynamicRank') {
                    valA = a[key]; valB = b[key];
                    if (valA === '-') valA = -9999; if (valB === '-') valB = -9999;
                } else if (key.startsWith('scores.')) {
                    const sub = key.split('.')[1];
                    valA = a.raw.scores[sub] ?? -Infinity;
                    valB = b.raw.scores[sub] ?? -Infinity;
                } else { valA = a[key]; valB = b[key]; }
                if (typeof valA === 'string') return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                return direction === 'asc' ? valA - valB : valB - valA;
            });

            let theadHtml = `<tr><th data-sort="id" style="cursor:pointer;">å­¦å· â‡…</th><th data-sort="name" style="cursor:pointer;">å§“å â‡…</th><th data-sort="class" style="cursor:pointer;">ç­çº§ â‡…</th>`;
            currentSelectedSubjects.forEach(sub => { theadHtml += `<th data-sort="scores.${sub}" style="cursor:pointer; min-width:80px;">${sub} â‡…</th>`; });
            theadHtml += `<th data-sort="dynamicTotal" style="cursor:pointer; background-color:#e8f0fe; min-width:90px; border-left:2px solid #eee;">è‡ªå®šä¹‰æ€»åˆ† â‡…</th><th data-sort="dynamicRank" style="cursor:pointer; background-color:#e8f0fe; min-width:80px;">  æ’å â‡…</th></tr>`;
            tableHead.innerHTML = theadHtml;

            const limit = 500;
            const renderList = displayList.slice(0, limit);

            if (renderList.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${5 + currentSelectedSubjects.length}" style="text-align:center; padding:20px; color:#999;">æ— æ•°æ®</td></tr>`;
                return;
            }

            tableBody.innerHTML = renderList.map(item => {
                let row = `<tr><td>${item.id}</td><td style="font-weight:bold;">${item.name}</td><td>${item.class}</td>`;
                currentSelectedSubjects.forEach(sub => {
                    const score = item.raw.scores[sub];
                    const val = score !== undefined ? score : '-';
                    const rank = (item.raw.gradeRanks && item.raw.gradeRanks[sub]) ? item.raw.gradeRanks[sub] : '-';
                    const passLine = (G_SubjectConfigs[sub] && G_SubjectConfigs[sub].pass) ? G_SubjectConfigs[sub].pass : 60;
                    const style = (typeof score === 'number' && score < passLine) ? 'color:#dc3545; font-weight:bold;' : '';
                    row += `<td style="${style}">${val} <span style="font-size:0.8em; color:#999; font-weight:normal;">(${rank})</span></td>`;
                });
                row += `<td style="font-weight:bold; color:#6f42c1; background-color:#f8faff; border-left:2px solid #eee;">${item.dynamicTotal}</td><td style="font-weight:bold; color:#6f42c1; background-color:#f8faff;">${item.dynamicRank}</td></tr>`;
                return row;
            }).join('');

            if (displayList.length > limit) tableBody.innerHTML += `<tr><td colspan="100" style="text-align:center; color:#999;">(ä»…æ˜¾ç¤ºå‰ ${limit} æ¡ï¼Œè¯·ä½¿ç”¨ç­›é€‰ç¼©å°èŒƒå›´)</td></tr>`;
        };

        // æ‰“å°åŠŸèƒ½ (ä¿®å¤ç‰ˆï¼š    åŠ¨æ€ç­çº§æ’å + è°ƒæ•´å®½åº¦)
        document.getElementById('btn-print-dynamic-table').addEventListener('click', () => {
            // 1. [ç¬¬ä¸€æ­¥] åŸºç¡€è®¡ç®—ï¼šç®—æ€»åˆ†ã€ç®—å¹´æ’
            const dynamicData = G_StudentsData.map(s => {
                let dynamicTotal = 0;
                let hasScore = false;
                currentSelectedSubjects.forEach(sub => {
                    const score = s.scores[sub];
                    if (typeof score === 'number') { dynamicTotal += score; hasScore = true; }
                });
                if (!hasScore) dynamicTotal = -1;
                return { raw: s, dynamicTotal: parseFloat(dynamicTotal.toFixed(2)) };
            });
            
            // å…¨æ ¡æ’åº -> å¾—åˆ°å¹´çº§æ’å
            dynamicData.sort((a, b) => b.dynamicTotal - a.dynamicTotal);
            dynamicData.forEach((item, index) => { 
                item.dynamicRank = (item.dynamicTotal >= 0) ? (index + 1) : '-'; 
            });

            // 2. [    ç¬¬äºŒæ­¥] è¿›é˜¶è®¡ç®—ï¼šç®—ç­çº§æ’å
            // å…ˆæŒ‰ç­çº§åˆ†ç»„
            const classGroups = {};
            dynamicData.forEach(item => {
                const cls = item.raw.class;
                if (!classGroups[cls]) classGroups[cls] = [];
                classGroups[cls].push(item);
            });
            // ç»„å†…æ’åºå¹¶æ ‡è®°ç­æ’
            Object.values(classGroups).forEach(group => {
                group.sort((a, b) => b.dynamicTotal - a.dynamicTotal);
                group.forEach((item, idx) => {
                    item.dynamicClassRank = (item.dynamicTotal >= 0) ? (idx + 1) : '-';
                });
            });

            // 3. [ç¬¬ä¸‰æ­¥] ç­›é€‰ (åº”ç”¨å½“å‰çš„æœç´¢/ç­›é€‰æ¡ä»¶)
            const filterClass = filterSelect.value;
            const searchText = searchInput.value.toLowerCase().trim();
            const printList = dynamicData.filter(item => {
                if (filterClass !== 'ALL' && item.raw.class !== filterClass) return false;
                if (searchText && !item.raw.name.includes(searchText) && !String(item.raw.id).includes(searchText)) return false;
                return true;
            });

            if (printList.length === 0) { alert("å½“å‰åˆ—è¡¨ä¸ºç©º"); return; }
            if (printList.length > 300 && !confirm(`å³å°†æ‰“å° ${printList.length} æ¡æ•°æ®ï¼Œç¡®è®¤ï¼Ÿ`)) return;

            // 4. [ç¬¬å››æ­¥] ç”Ÿæˆ HTML
            let rowsHtml = '';
            printList.forEach((item, index) => {
                const s = item.raw;
                let scoresHtml = '';
                
                currentSelectedSubjects.forEach(sub => {
                    const score = s.scores[sub] !== undefined ? s.scores[sub] : '-';
                    const rank = (s.gradeRanks && s.gradeRanks[sub]) ? s.gradeRanks[sub] : '-';
                    const passLine = (G_SubjectConfigs[sub] && G_SubjectConfigs[sub].pass) ? G_SubjectConfigs[sub].pass : 60;
                    const colorStyle = (typeof s.scores[sub] === 'number' && s.scores[sub] < passLine) ? 'color:#dc3545;' : '';

                    scoresHtml += `
                        <div class="score-item">
                            <span class="subject-name">${sub}</span>
                            <span class="score-val" style="${colorStyle}">
                                ${score} <span style="font-size:0.8em; color:#999; font-weight:normal;">(${rank})</span>
                            </span>
                        </div>`;
                });

                // [ä¿®æ”¹] å·¦ä¾§  åŠ äº†ç­æ’å¾½ç« 
                rowsHtml += `
                    <div class="student-row">
                        <div class="student-info">
                            <div style="display:flex; flex-direction:column; gap:2px; margin-right:5px;">
                                <span class="rank-badge" style="background:#555;" title="å¹´çº§æ’å">å¹´${item.dynamicRank}</span>
                                <span class="rank-badge" style="background:#17a2b8;" title="ç­çº§æ’å">ç­${item.dynamicClassRank}</span>
                            </div>
                            <div style="display:flex; flex-direction:column;">
                                <span class="name">${s.name}</span>
                                <span class="class">${s.class}</span>
                            </div>
                        </div>
                        <div class="scores-grid">${scoresHtml}</div>
                        <div class="total-info">
                            <span>æ€»åˆ†: <strong>${item.dynamicTotal >= 0 ? item.dynamicTotal : '-'}</strong></span>
                        </div>
                    </div>
                `;
                
                if (index < printList.length - 1) {
                    rowsHtml += `<div class="spacer"></div><div class="dashed-line"></div><div class="spacer"></div>`;
                }
            });

            const printHtml = `
                <html>
                <head>
                    <title>æˆç»©æ¸…å•</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; color: #333; }
                        h2 { text-align: center; margin-bottom: 10px; }
                        
                        .student-row { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; }
                        
                        /* [ä¿®æ”¹] å®½åº¦åŠ å®½åˆ° 280pxï¼Œå®¹çº³åŒæ’å */
                        .student-info { width: 180px; display: flex; align-items: center; gap: 8px; border-right: 1px solid #eee; padding-right: 10px; }
                        
                        .rank-badge { 
                            color: white; padding: 1px 4px; border-radius: 3px; 
                            min-width: 35px; text-align: center; font-size: 0.8em; font-weight: bold; 
                        }
                        .name { font-weight: bold; font-size: 1.1em; } 
                        .class { color: #666; font-size: 0.85em; }
                        
                        .scores-grid { display: flex; flex-wrap: wrap; gap: 8px; flex: 1; padding: 0 15px; }
                        .score-item { border: 1px solid #eee; padding: 2px 6px; font-size: 0.9em; background: #f9f9f9; border-radius: 3px; }
                        .subject-name { color: #888; margin-right: 3px; }
                        .score-val { font-weight: bold; }
                        
                        .total-info { width: 120px; text-align: right; color: #6f42c1; font-size: 1.1em; }
                        
                        .dashed-line { border-bottom: 1px dashed #ccc; width: 100%; }
                        .spacer { height: 8px; }
                        
                        @media print { 
                            .rank-badge { -webkit-print-color-adjust: exact; } 
                            .score-item { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <h2>ğŸ“„ åŠ¨æ€æˆç»©æ¸…å•</h2>
                    <p style="text-align:center;color:#666;font-size:0.9em; margin-bottom:20px;">
                        åŒ…å«ç§‘ç›®ï¼š${currentSelectedSubjects.join('ã€')}
                    </p>
                    ${rowsHtml}
                </body>
                </html>
            `;
            
            const win = window.open('', '_blank');
            win.document.write(printHtml);
            win.document.close();
            setTimeout(() => { win.focus(); win.print(); }, 500);
        });

        // --- äº‹ä»¶ç»‘å®š ---
        const triggerUpdate = () => {
            const cbs = checkboxList.querySelectorAll('input:checked');
            currentSelectedSubjects = Array.from(cbs).map(cb => cb.value);
            dropdownBtn.innerText = `ğŸ“š é€‰æ‹©ç§‘ç›® (${currentSelectedSubjects.length}) â–¼`;
            renderDynamicData();
        };
        checkboxList.addEventListener('change', triggerUpdate);
        btnAll.addEventListener('click', (e) => {
            e.preventDefault();
            const cbs = checkboxList.querySelectorAll('input');
            const allChecked = Array.from(cbs).every(cb => cb.checked);
            cbs.forEach(cb => cb.checked = !allChecked);
            triggerUpdate();
        });
        dropdownBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownContent.classList.toggle('show'); });
        document.addEventListener('click', (e) => { if (!dropdownBtn.contains(e.target) && !dropdownContent.contains(e.target)) dropdownContent.classList.remove('show'); });
        filterSelect.addEventListener('change', renderDynamicData);
        searchInput.addEventListener('input', renderDynamicData);
        tableHead.addEventListener('click', (e) => {
            const th = e.target.closest('th'); if (!th) return;
            const sortKey = th.dataset.sort;
            if (sortKey) {
                if (G_DashboardTableSort.key === sortKey) G_DashboardTableSort.direction = G_DashboardTableSort.direction === 'asc' ? 'desc' : 'asc';
                else { G_DashboardTableSort.key = sortKey; G_DashboardTableSort.direction = 'desc'; }
                renderDynamicData();
            }
        });

        renderDynamicData();
    };

    // 6. åˆå§‹æ‰§è¡Œ
    updateCurveChart();
    drawHistogram();
    updateClassChart();
    updateScat();
    drawContribution();
    if(typeof renderAverageRadar === 'function') renderAverageRadar('radar-chart', stats);
    if(typeof renderSubjectBoxPlot === 'function') renderSubjectBoxPlot('subject-boxplot-chart', G_Statistics, activeData);
    if(typeof renderStackedBar === 'function') renderStackedBar('stacked-bar-chart', G_Statistics, G_SubjectConfigs);
    
    initDynamicTable();
}
/**
 * (ä¿®æ”¹å) 9.2. æ¨¡å—äºŒï¼šå­¦ç”Ÿä¸ªä½“æŠ¥å‘Š (    ï¼šéšè—æ’åæŒ‰é’®)
 */
function renderStudent(container, students, stats) {
    // åˆå§‹åŒ–éšè—çŠ¶æ€ (å¦‚æœæ²¡æœ‰å®šä¹‰è¿‡)
    if (typeof window.G_HideRank === 'undefined') window.G_HideRank = false;
    // --- [    ] é˜²å¾¡æ€§æ£€æŸ¥ï¼šå¦‚æœå‘ç°æ’åç¼ºå¤±ï¼Œå°è¯•ç°åœºè¡¥ç®— ---
    if (students.length > 0 && (!students[0].classRanks || !students[0].gradeRanks)) {
        console.log("æ£€æµ‹åˆ°æ’åæ•°æ®ç¼ºå¤±ï¼Œæ­£åœ¨è‡ªåŠ¨è¡¥å…¨...");
        // é‡  è®¡ç®—æ’å
        const recalculated = addSubjectRanksToData(students);
        // æ›´  å¼•ç”¨ (æ³¨æ„ï¼šè¿™ä¸ä¼šæ›´   IndexedDBï¼Œåªæ›´  å½“å‰è§†å›¾)
        students = recalculated; 
    }

    // 1. æ¸²æŸ“æœç´¢æ¡†ã€æ“ä½œæŒ‰é’® å’Œ ç»“æœå®¹å™¨
    container.innerHTML = `
        <h2>æ¨¡å—äºŒï¼šå­¦ç”Ÿä¸ªä½“æŠ¥å‘Š (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>
        <div class="controls-bar">
            <label for="student-search">æœç´¢å­¦ç”Ÿ (å§“å/è€ƒå·):</label>
            <div class="search-combobox">
                <input type="text" id="student-search" placeholder="è¾“å…¥å§“åæˆ–è€ƒå·..." autocomplete="off">
                <div class="search-results" id="student-search-results"></div>
            </div>
            
            <button id="toggle-rank-btn" class="sidebar-button" style="margin-left: auto; background-color: ${window.G_HideRank ? '#6c757d' : '#fd7e14'};">
                ${window.G_HideRank ? 'ğŸ‘ï¸ æ˜¾ç¤ºæ’å' : 'ğŸš« éšè—æ’å'}
            </button>

            <button id="open-print-modal-btn" class="sidebar-button" style="margin-left: 10px; background-color: var(--color-blue);">
                ğŸ–¨ï¸ æ‰“å°æŠ¥å‘Š
            </button>
        </div>
        <div id="student-report-content">
            <p>è¯·è¾“å…¥å…³é”®è¯ä»¥æœç´¢å­¦ç”Ÿã€‚</p>
        </div>
    `;

    const searchInput = document.getElementById('student-search');
    const resultsContainer = document.getElementById('student-search-results');
    const contentEl = document.getElementById('student-report-content');
    const openPrintModalBtn = document.getElementById('open-print-modal-btn');
    const toggleRankBtn = document.getElementById('toggle-rank-btn'); // [    ]

    // [    ] ç»‘å®šéšè—æ’åæŒ‰é’®äº‹ä»¶
    toggleRankBtn.addEventListener('click', () => {
        window.G_HideRank = !window.G_HideRank; // åˆ‡æ¢çŠ¶æ€

        // æ›´  æŒ‰é’®æ ·å¼
        toggleRankBtn.innerHTML = window.G_HideRank ? 'ğŸ‘ï¸ æ˜¾ç¤ºæ’å' : 'ğŸš« éšè—æ’å';
        toggleRankBtn.style.backgroundColor = window.G_HideRank ? '#6c757d' : '#fd7e14';

        // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„å­¦ç”Ÿï¼Œç«‹å³åˆ·  æ˜¾ç¤º
        const currentStudentId = contentEl.dataset.currentStudentId;
        if (currentStudentId) {
            showReport(currentStudentId);
        }
    });

    // [æ‰“å°åŠŸèƒ½] (ä¿æŒä¸å˜)
    const printBtnCurrent = document.getElementById('print-btn-current');
    const printBtnFilter = document.getElementById('print-btn-filter');
    const printModal = document.getElementById('print-modal');

    openPrintModalBtn.addEventListener('click', () => {
        const currentStudentId = contentEl.dataset.currentStudentId;
        if (currentStudentId) {
            const currentStudentName = contentEl.dataset.currentStudentName;
            printBtnCurrent.innerHTML = `ğŸ–¨ï¸ æ‰“å°å½“å‰å­¦ç”Ÿ (${currentStudentName})`;
            printBtnCurrent.dataset.studentId = currentStudentId;
            printBtnCurrent.disabled = false;
        } else {
            printBtnCurrent.innerHTML = `ğŸ–¨ï¸ æ‰“å°å½“å‰å­¦ç”Ÿ (æœªé€‰æ‹©)`;
            printBtnCurrent.dataset.studentId = '';
            printBtnCurrent.disabled = true;
        }
        const filterText = (G_CurrentClassFilter === 'ALL') ? 'å…¨ä½“å¹´æ®µ' : G_CurrentClassFilter;
        printBtnFilter.innerHTML = `ğŸ–¨ï¸ æ‰“å°å½“å‰ç­›é€‰ (${filterText})`;
        printModal.style.display = 'flex';
    });

    // å†…éƒ¨å‡½æ•°ï¼šæ˜¾ç¤ºæŠ¥å‘Š
    const showReport = (studentId) => {
        const student = students.find(s => String(s.id) === String(studentId));
        if (!student) {
            contentEl.innerHTML = `<p>æœªæ‰¾åˆ°å­¦ç”Ÿã€‚</p>`;
            return;
        }

        contentEl.dataset.currentStudentId = student.id;
        contentEl.dataset.currentStudentName = student.name;

        let oldStudent = null;
        let scoreDiff = 'N/A', rankDiff = 'N/A', gradeRankDiff = 'N/A';

        if (G_CompareData && G_CompareData.length > 0) {
            oldStudent = G_CompareData.find(s => String(s.id) === String(student.id));
        }

        if (oldStudent) {
            scoreDiff = (student.totalScore - oldStudent.totalScore).toFixed(2);
            rankDiff = oldStudent.rank - student.rank;
            gradeRankDiff = (oldStudent.gradeRank && student.gradeRank) ? oldStudent.gradeRank - student.gradeRank : 'N/A';
        }

        // [    ] æ©ç è¾…åŠ©å‡½æ•°
        const maskRank = (val) => window.G_HideRank ? '***' : val;
        // å¦‚æœéšè—æ’åï¼Œä¹Ÿä¸æ˜¾ç¤ºæ’åçš„å˜åŒ–ï¼ˆè¿›é€€æ­¥ï¼‰
        const maskDiff = (diffVal, diffText) => window.G_HideRank ? '' : (diffVal !== 'N/A' && oldStudent ? diffText : '');

        contentEl.innerHTML = `
            <div class="student-card">
                <div class="sc-name"><span>å§“å</span><strong>${student.name}</strong></div>
                <div class="sc-id"><span>è€ƒå·</span><strong>${student.id}</strong></div>
                
                <div class="sc-total">
                    <span>æ€»åˆ† (ä¸Šæ¬¡: ${oldStudent ? oldStudent.totalScore : 'N/A'})</span>
                    <strong class="${scoreDiff > 0 ? 'progress' : scoreDiff < 0 ? 'regress' : ''}">
                        ${student.totalScore}
                        ${(scoreDiff !== 'N/A' && oldStudent) ? `(${scoreDiff > 0 ? 'â–²' : 'â–¼'} ${Math.abs(scoreDiff)})` : ''}
                    </strong>
                </div>

                <div class="sc-rank">
                    <span>ç­çº§æ’å (ä¸Šæ¬¡: ${maskRank(oldStudent ? oldStudent.rank : 'N/A')})</span>
                    <strong class="${rankDiff > 0 ? 'progress' : rankDiff < 0 ? 'regress' : ''}">
                        ${maskRank(student.rank)}
                        ${maskDiff(rankDiff, `(${rankDiff > 0 ? 'â–²' : 'â–¼'} ${Math.abs(rankDiff)})`)}
                    </strong>
                </div>

                <div class="sc-grade-rank">
                    <span>å¹´çº§æ’å (ä¸Šæ¬¡: ${maskRank(oldStudent ? (oldStudent.gradeRank || 'N/A') : 'N/A')})</span>
                    <strong class="${gradeRankDiff > 0 ? 'progress' : gradeRankDiff < 0 ? 'regress' : ''}">
                        ${maskRank(student.gradeRank || 'N/A')}
                        ${maskDiff(gradeRankDiff, `(${gradeRankDiff > 0 ? 'â–²' : 'â–¼'} ${Math.abs(gradeRankDiff)})`)}
                    </strong>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ç§‘ç›®</th>
                            <th>å¾—åˆ† (å˜åŒ–)</th>
                            <th>ç­çº§ç§‘ç›®æ’å (å˜åŒ–)</th>
                            <th>å¹´çº§ç§‘ç›®æ’å (å˜åŒ–)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${G_DynamicSubjectList.map(subject => {
            let subjectScoreDiff = 'N/A';
            let subjectClassRankDiff = 'N/A';
            let subjectGradeRankDiff = 'N/A';

            if (oldStudent && oldStudent.scores) {
                const oldScore = oldStudent.scores[subject] || 0;
                const newScore = student.scores[subject] || 0;
                if (oldScore !== 0 || newScore !== 0) {
                    subjectScoreDiff = (newScore - oldScore).toFixed(2);
                }
                if (oldStudent.classRanks && student.classRanks) {
                    const oldClassRank = oldStudent.classRanks[subject] || 0;
                    const newClassRank = student.classRanks[subject] || 0;
                    if (oldClassRank > 0 && newClassRank > 0) {
                        subjectClassRankDiff = oldClassRank - newClassRank;
                    }
                }
                if (oldStudent.gradeRanks && student.gradeRanks) {
                    const oldGradeRank = oldStudent.gradeRanks[subject] || 0;
                    const newGradeRank = student.gradeRanks[subject] || 0;
                    if (oldGradeRank > 0 && newGradeRank > 0) {
                        subjectGradeRankDiff = oldGradeRank - newGradeRank;
                    }
                }
            }

            const config = G_SubjectConfigs[subject] || {};
            const isAssignedSubject = config.isAssigned === true;
            let rankBasedScoreDisplay = '';
            if (isAssignedSubject) {
                const allScoresForSubject = G_StudentsData.map(s => s.scores[subject]);
                const fujianScore = calculateFujianAssignedScore(student.scores[subject], allScoresForSubject);
                rankBasedScoreDisplay = `<div style="font-size:0.85em; color:#6f42c1; margin-top:4px; font-weight:bold;">èµ‹åˆ†: ${fujianScore}</div>`;
            } else {
                rankBasedScoreDisplay = `<div style="font-size:0.8em; color:#aaa; margin-top:4px;">(åŸå§‹åˆ†)</div>`;
            }

            const tScore = (student.tScores && student.tScores[subject]) ? student.tScores[subject] : 'N/A';
            let tScoreDiffHtml = '';
            if (oldStudent && oldStudent.tScores && oldStudent.tScores[subject]) {
                const oldTScore = oldStudent.tScores[subject];
                if (tScore !== 'N/A') {
                    const diff = tScore - oldTScore;
                    const diffAbs = Math.abs(diff).toFixed(1);
                    if (diff > 0) tScoreDiffHtml = `<span class="progress" style="font-size:0.9em; margin-left:4px;">(â–²${diffAbs})</span>`;
                    else if (diff < 0) tScoreDiffHtml = `<span class="regress" style="font-size:0.9em; margin-left:4px;">(â–¼${diffAbs})</span>`;
                }
            }

            return `
                                <tr>
                                    <td>${subject}</td>
                                    <td>
                                        <div>
                                            ${student.scores[subject] || 0}
                                            ${(oldStudent && subjectScoreDiff !== 'N/A') ? `<span class="${subjectScoreDiff > 0 ? 'progress' : subjectScoreDiff < 0 ? 'regress' : ''}" style="font-size:0.8em">(${subjectScoreDiff > 0 ? 'â–²' : 'â–¼'} ${Math.abs(subjectScoreDiff)})</span>` : ''}
                                        </div>
                                        <div style="font-size:0.8em; color:#666; margin-top:4px;">
                                            Tåˆ†: <strong>${tScore}</strong> ${tScoreDiffHtml}
                                        </div>
                                    </td>
                                    <td>
                                        ${maskRank(student.classRanks ? (student.classRanks[subject] || 'N/A') : 'N/A')}
                                        ${maskDiff(subjectClassRankDiff, `<span class="${subjectClassRankDiff > 0 ? 'progress' : subjectClassRankDiff < 0 ? 'regress' : ''}" style="font-size:0.8em">(${subjectClassRankDiff > 0 ? 'â–²' : 'â–¼'} ${Math.abs(subjectClassRankDiff)})</span>`)}
                                    </td>
                                    <td>
                                        <div>
                                            ${maskRank(student.gradeRanks ? (student.gradeRanks[subject] || 'N/A') : 'N/A')}
                                            ${maskDiff(subjectGradeRankDiff, `<span class="${subjectGradeRankDiff > 0 ? 'progress' : subjectGradeRankDiff < 0 ? 'regress' : ''}" style="font-size:0.8em">(${subjectGradeRankDiff > 0 ? 'â–²' : 'â–¼'} ${Math.abs(subjectGradeRankDiff)})</span>`)}
                                        </div>
                                        ${rankBasedScoreDisplay}
                                    </td>
                                </tr>
                            `;
        }).join('')}
                    </tbody>
                </table>
            </div>

            <div class="main-card-wrapper" style="margin-top: 20px;">
                <div class="chart-container" id="student-radar-chart" style="height: 400px;"></div>
            </div>
        `;

        renderStudentRadar('student-radar-chart', student, stats);
    };

    // ç›‘å¬æœç´¢è¾“å…¥ (ä¿æŒä¸å˜)
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        if (searchTerm.length < 1) {
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            return;
        }
        const filteredStudents = students.filter(s => {
            return String(s.name).toLowerCase().includes(searchTerm) ||
                String(s.id).toLowerCase().includes(searchTerm);
        }).slice(0, 50);

        if (filteredStudents.length === 0) {
            resultsContainer.innerHTML = '<div class="result-item">-- æœªæ‰¾åˆ° --</div>';
        } else {
            resultsContainer.innerHTML = filteredStudents.map(s => {
                return `<div class="result-item" data-id="${s.id}">
                    <strong>${s.name}</strong> (${s.id}) - ç­æ’: ${window.G_HideRank ? '***' : s.rank}
                </div>`;
            }).join('');
        }
        resultsContainer.style.display = 'block';
    });

    resultsContainer.addEventListener('click', (e) => {
        const item = e.target.closest('.result-item');
        if (item && item.dataset.id) {
            const studentId = item.dataset.id;
            searchInput.value = `${item.querySelector('strong').innerText} (${studentId})`;
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            showReport(studentId);
        }
    });

    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
        }
    });

    searchInput.addEventListener('focus', () => {
        if (resultsContainer.innerHTML !== '') {
            resultsContainer.style.display = 'block';
        }
    });
}

/**
 * 9.3. æ¨¡å—ä¸‰ï¼šè¯•å·ç§‘ç›®åˆ†æ
 *    å·²ä¿®æ”¹ï¼šç­¾å  åŠ  activeData, drawChart ä¼ é€’ activeData
 */
function renderPaper(container, stats, activeData) {
    // 1.   æ¸²æŸ“ 1x4 å‚ç›´å¸ƒå±€
    container.innerHTML = `
        <h2>æ¨¡å—ä¸‰ï¼šè¯•å·ç§‘ç›®åˆ†æ (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>
        
        <div class="main-card-wrapper" style="margin-bottom: 20px;">
                <div class="controls-bar chart-controls" style="align-items:center; flex-wrap:wrap;">
                    <label for="subject-select">é€‰æ‹©ç§‘ç›®:</label>
                    <select id="subject-select" class="sidebar-select" style="margin-right:15px;">
                        <option value="totalScore">æ€»åˆ†</option>
                        ${G_DynamicSubjectList.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                    
                    <div style="display:flex; align-items:center; margin-right:15px;">
                        <input type="checkbox" id="paper-compare-class" style="margin-right:5px; cursor:pointer;">
                        <label for="paper-compare-class" style="cursor:pointer; user-select:none; font-weight:bold; color:#007bff;">å¯¹æ¯”å„ç­</label>
                    </div>
                    
                    <label for="paper-bin-size">åˆ†æ®µå¤§å°:</label>
                    <input type="number" id="paper-bin-size" value="10" style="width: 60px;">
                    <button id="paper-redraw-btn" class="sidebar-button" style="width: auto; margin-left:10px;">é‡ç»˜</button>
                </div>
            <div class="chart-container" id="subject-histogram-chart" style="width: 100%; height: 500px;"></div>
        </div>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <div class="controls-bar chart-controls">
                <h4 style="margin:0;">å„ç§‘éš¾åº¦ç³»æ•°å¯¹æ¯”</h4>
                <span style="font-size: 0.8em; color: var(--text-muted);">(éš¾åº¦ = å¹³å‡åˆ† / æ»¡åˆ†, è¶Šé«˜è¶Šç®€å•)</span>
            </div>
            <div class="chart-container" id="difficulty-chart" style="width: 100%; height: 500px;"></div>
        </div>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <div class="controls-bar chart-controls">
                <h4 style="margin:0;">å„ç§‘åŒºåˆ†åº¦å¯¹æ¯” (æ ‡å‡†å·®)</h4>
                <span style="font-size: 0.8em; color: var(--text-muted);">(æ ‡å‡†å·®è¶Šå¤§, è¶Šèƒ½æ‹‰å¼€å·®è·)</span>
            </div>
            <div class="chart-container" id="discrimination-chart" style="width: 100%; height: 500px;"></div>
        </div>

        <div class="main-card-wrapper">
            <div class="controls-bar chart-controls" style="display: block;"> <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin:0;">éš¾åº¦-åŒºåˆ†åº¦ æ•£ç‚¹å›¾</h4>
                </div>
                
                <div style="background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 10px 15px; font-size: 0.85em; color: #555;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <strong style="color: #fd7e14;">â†– å·¦ä¸Š (éš¾ + æ‹‰åˆ†)</strong>ï¼š<strong>èƒœè´Ÿæ‰‹</strong>ã€‚é¢˜ç›®éš¾ä¸”èƒ½æ‹‰å¼€å·®è·ï¼Œå†³å®šå°–å­ç”Ÿæ’åã€‚
                        </div>
                        <div>
                            <strong style="color: #28a745;">â†— å³ä¸Š (æ˜“ + æ‹‰åˆ†)</strong>ï¼š<strong>é»„é‡‘åŒº</strong>ã€‚é¢˜ç›®é€‚ä¸­ï¼Œæ—¢ç…§é¡¾åŸºç¡€åˆèƒ½é€‰æ‹”äººæ‰ã€‚
                        </div>
                        <div>
                            <strong style="color: #dc3545;">â†™ å·¦ä¸‹ (éš¾ + ä¸æ‹‰åˆ†)</strong>ï¼š<strong>æ— æ•ˆéš¾</strong>ã€‚å¤ªéš¾äº†å¤§å®¶éƒ½ä¸ä¼šï¼Œæ— æ³•åŒºåˆ†æ°´å¹³ã€‚
                        </div>
                        <div>
                            <strong style="color: #007bff;">â†˜ å³ä¸‹ (æ˜“ + ä¸æ‹‰åˆ†)</strong>ï¼š<strong>ç¦åˆ©å±€</strong>ã€‚é¢˜ç›®ç®€å•ï¼Œå¤§å®¶åˆ†éƒ½é«˜ï¼Œä¸è®ºè‹±é›„ã€‚
                        </div>
                    </div>
                    <div style="margin-top: 8px; border-top: 1px dashed #dee2e6; padding-top: 5px; color: #888;">
                        * æ°”æ³¡å¤§å°ä»£è¡¨ç§‘ç›®æ»¡åˆ†æƒé‡ (å¦‚è¯­æ•°è‹±æ°”æ³¡æ›´å¤§)ã€‚
                    </div>
                </div>
                </div>
            <div class="chart-container" id="difficulty-scatter-chart" style="width: 100%; height: 500px;"></div>
        </div>
    `;

        // 2. ç»˜åˆ¶ç›´æ–¹å›¾ (å‡çº§ç‰ˆ)
        const drawChart = () => {
        const subjectName = document.getElementById('subject-select').value;
        const binSize = parseInt(document.getElementById('paper-bin-size').value) || 10;
        // æ–°å¢ï¼šè·å–å¯¹æ¯”çŠ¶æ€
        const isClassCompare = document.getElementById('paper-compare-class').checked;
        
        const s = stats[subjectName];
        if (!s) return;

        let fullScore;
        if (subjectName === 'totalScore') {
            fullScore = G_DynamicSubjectList.reduce((sum, key) => sum + (G_SubjectConfigs[key]?.full || 0), 0);
        } else {
            fullScore = G_SubjectConfigs[subjectName]?.full || 100;
        }

        // æ–°å¢ï¼šå¦‚æœæ˜¯å¯¹æ¯”æ¨¡å¼ï¼Œå¼ºåˆ¶ä½¿ç”¨æ‰€æœ‰æ•°æ®(G_StudentsData)ï¼›å¦åˆ™ä½¿ç”¨ç­›é€‰æ•°æ®(activeData)
        const sourceData = isClassCompare ? G_StudentsData : activeData;

        renderHistogram(
            'subject-histogram-chart',
            sourceData,     // æ•°æ®æº
            subjectName,    // ç§‘ç›®Key
            fullScore,
            `${s.name} åˆ†æ•°æ®µåˆ†å¸ƒå›¾ (åˆ†æ®µ=${binSize})`,
            binSize,
            isClassCompare  // ä¼ å…¥å¯¹æ¯”æ ‡è®°
        );
    };

    // 3. ç»‘å®šäº‹ä»¶
    document.getElementById('subject-select').addEventListener('change', drawChart);
    document.getElementById('paper-redraw-btn').addEventListener('click', drawChart);
    // æ–°å¢ï¼šç»‘å®š checkbox
    document.getElementById('paper-compare-class').addEventListener('change', drawChart);

    // 4. (    ) ç»˜åˆ¶  å›¾è¡¨
    renderSubjectComparisonBarChart('difficulty-chart', stats, 'difficulty');
    renderSubjectComparisonBarChart('discrimination-chart', stats, 'stdDev');
    renderDifficultyScatter('difficulty-scatter-chart', stats);

    // 5. é»˜è®¤ç»˜åˆ¶æ€»åˆ†
    drawChart('totalScore');
}


/**
 * (    ) 9.3.5. æ¨¡å—ï¼šå•ç§‘æˆç»©åˆ†æ
 * @param {Object} container - HTML å®¹å™¨
 * @param {Array} activeData - å½“å‰å·²ç­›é€‰çš„å­¦ç”Ÿæ•°æ®
 * @param {Object} stats - G_Statistics (å…¨ä½“ç»Ÿè®¡)
 */
function renderSingleSubject(container, activeData, stats) {

    // 1. æ¸²æŸ“åŸºç¡€HTML
    container.innerHTML = `
        <h2>æ¨¡å—å››ï¼šå•ç§‘æˆç»©åˆ†æ (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <div class="controls-bar chart-controls">
                <label for="ss-subject-select">é€‰æ‹©ç§‘ç›®:</label>
                <select id="ss-subject-select" class="sidebar-select">
                    ${G_DynamicSubjectList.map((s, i) => `<option value="${s}" ${i === 0 ? 'selected' : ''}>${s}</option>`).join('')}
                </select>
            </div>
        </div>

        <div id="ss-kpi-grid" class="kpi-grid" style="margin-bottom: 20px;"></div>

        <div class="dashboard-chart-grid-2x2">
            <div class="main-card-wrapper">
                <h4 style="margin:0;">åˆ†æ•°æ®µç›´æ–¹å›¾</h4>
                <div class="chart-container" id="ss-histogram-chart" style="height: 350px;"></div>
            </div>

            <div class="main-card-wrapper">
                <div class="controls-bar chart-controls">
                    <label for="ss-class-compare-metric">å¯¹æ¯”æŒ‡æ ‡:</label>
                    <select id="ss-class-compare-metric" class="sidebar-select" style="min-width: 120px;">
                        <option value="average">å¹³å‡åˆ†</option>
                        <option value="passRate">åŠæ ¼ç‡ (%)</option>
                        <option value="excellentRate">ä¼˜ç§€ç‡ (%)</option>
                        <option value="stdDev">æ ‡å‡†å·®</option>
                        <option value="max">æœ€é«˜åˆ†</option>
                    </select>
                </div>
                <div class="chart-container" id="ss-class-compare-chart" style="height: 350px;"></div>
            </div>
        </div>

        <div class="dashboard-chart-grid-2x2" style="margin-top: 20px;">
            <div class="main-card-wrapper">
                <h4 style="margin:0;">ğŸ“¦ å„ç­åˆ†åŒ–ç¨‹åº¦å¯¹æ¯” (ç®±å½¢å›¾)</h4>
                <p style="font-size:0.8em; color:#999; margin:5px 0;">* ç®±ä½“è¶Šé•¿è¡¨ç¤ºç­çº§å†…éƒ¨åˆ†åŒ–è¶Šä¸¥é‡ï¼›åœ†ç‚¹ä¸ºå¼‚å¸¸é«˜/ä½åˆ†ã€‚</p>
                <div class="chart-container" id="ss-class-boxplot" style="height: 400px;"></div>
            </div>
            <div class="main-card-wrapper">
                <h4 style="margin:0;">ğŸ¯ ç­çº§æ•™å­¦è´¨é‡è¯Šæ–­ (å››è±¡é™)</h4>
                <p style="font-size:0.8em; color:#999; margin:5px 0;">* Xè½´:åŠæ ¼ç‡, Yè½´:å¹³å‡åˆ†ã€‚åå­—çº¿ä¸ºå¹´çº§å¹³å‡æ°´å¹³ã€‚</p>
                <div class="chart-container" id="ss-class-quadrant" style="height: 400px;"></div>
            </div>
        </div>

        <div class="dashboard-chart-grid-2x2" style="margin-top: 20px;">
            <div class="main-card-wrapper">
                <h4 style="margin:0;">A/B/C/D ç­‰çº§æ„æˆ</h4>
                <div class="chart-container" id="ss-abcd-pie-chart" style="height: 400px;"></div>
            </div>
            <div class="main-card-wrapper" style="display:flex; flex-direction:column; gap:10px;">
                <div style="flex:1; display:flex; flex-direction:column;">
                    <h4 style="margin:0;">æœ¬ç§‘ç›® Top 10</h4>
                    <div class="table-container" id="ss-top10-table" style="flex:1; overflow-y:auto;"></div>
                </div>
                <div style="flex:1; display:flex; flex-direction:column; border-top:1px dashed #eee; padding-top:10px;">
                    <h4 style="margin:0;">æœ¬ç§‘ç›® Bottom 10</h4>
                    <div class="table-container" id="ss-bottom10-table" style="flex:1; overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    `;

    // 2. å†…éƒ¨è¾…åŠ©å‡½æ•°ï¼šç”¨äºæ¸²æŸ“æ‰€æœ‰å›¾è¡¨å’Œè¡¨æ ¼
    const drawAnalysis = () => {
        const subjectName = document.getElementById('ss-subject-select').value;
        if (!subjectName) return;

        const subjectStats = stats[subjectName] || {};
        const config = G_SubjectConfigs[subjectName] || {};
        const fullScore = config.full || 100;

        // 2.1 æ¸²æŸ“KPIs (ä¸å˜)
        const kpiContainer = document.getElementById('ss-kpi-grid');
        kpiContainer.innerHTML = `
            <div class="kpi-card"><h3>å¹³å‡åˆ†</h3><div class="value">${subjectStats.average || 0}</div></div>
            <div class="kpi-card"><h3>æœ€é«˜åˆ†</h3><div class="value">${subjectStats.max || 0}</div></div>
            <div class="kpi-card"><h3>æœ€ä½åˆ†</h3><div class="value">${subjectStats.min || 0}</div></div>
            <div class="kpi-card"><h3>ä¼˜ç§€ç‡ (%)</h3><div class="value">${subjectStats.excellentRate || 0}</div></div>
            <div class="kpi-card"><h3>è‰¯å¥½ç‡ (%)</h3><div class="value">${subjectStats.goodRate || 0}</div></div>
            <div class="kpi-card"><h3>åŠæ ¼ç‡ (%)</h3><div class="value">${subjectStats.passRate || 0}</div></div>
            <div class="kpi-card"><h3>ä¸åŠæ ¼ç‡ (%)</h3><div class="value">${subjectStats.failRate || 0}</div></div>
            <div class="kpi-card"><h3>æ ‡å‡†å·®</h3><div class="value">${subjectStats.stdDev || 0}</div></div>
        `;

        // 2.2 æ¸²æŸ“ç›´æ–¹å›¾ (ä¸å˜)
        renderHistogram(
            'ss-histogram-chart',
            activeData,
            subjectName,
            fullScore,
            `${subjectName} åˆ†æ•°æ®µç›´æ–¹å›¾`,
            Math.round(fullScore / 15) // åŠ¨æ€åˆ†æ®µï¼Œçº¦15æ®µ
        );

        // 2.3    (  ) æ¸²æŸ“ç­çº§å¯¹æ¯”å›¾
        const metricSelect = document.getElementById('ss-class-compare-metric');
        const drawClassCompareChart = () => {
            const metric = metricSelect.value;
            const chartEl = document.getElementById('ss-class-compare-chart');

            if (G_CurrentClassFilter !== 'ALL') {
                chartEl.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding-top: 50px;">è¯·åœ¨ä¾§è¾¹æ é€‰æ‹© "å…¨ä½“å¹´æ®µ" ä»¥æŸ¥çœ‹ç­çº§å¯¹æ¯”ã€‚</p>`;
                return;
            }

            // (å¤ç”¨) è°ƒç”¨ç­çº§å¯¹æ¯”æ•°æ®è®¡ç®—å‡½æ•°
            const data = calculateClassComparison(metric, subjectName);
            let metricName = metricSelect.options[metricSelect.selectedIndex].text;
            // (å¤ç”¨) è°ƒç”¨ç­çº§å¯¹æ¯”å›¾æ¸²æŸ“å‡½æ•°
            renderClassComparisonChart('ss-class-compare-chart', data, `å„ç­çº§ - ${subjectName} ${metricName}`);
        };

        // (ç»‘å®šäº‹ä»¶)
        metricSelect.addEventListener('change', drawClassCompareChart);
        // (åˆå§‹ç»˜åˆ¶)
        drawClassCompareChart();


        // 2.4    (  ) æ¸²æŸ“é¥¼å›¾
        renderSingleSubjectPie('ss-abcd-pie-chart', subjectStats);


        // 2.5 æ¸²æŸ“ Top/Bottom è¡¨æ ¼ (ä¸å˜)
        const sortedStudents = [...activeData]
            .filter(s => s.scores[subjectName] !== null && s.scores[subjectName] !== undefined)
            .sort((a, b) => (b.scores[subjectName]) - (a.scores[subjectName]));

        const top10 = sortedStudents.slice(0, 10);
        const bottom10 = sortedStudents.slice(-10).reverse();


        const createTable = (data, rankType) => {
            let rankHeader = rankType === 'top' ? 'æ’å' : 'å€’æ•°';
            if (data.length === 0) return '<p style="text-align: center; color: var(--text-muted); padding-top: 20px;">æ— æ•°æ®</p>';

            return `
                <table>
                    <thead>
                        <tr>
                            <th>${rankHeader}</th>
                            <th>å§“å</th>
                            <th>åˆ†æ•°</th>
                            <th>ç­æ’(æ€»åˆ†)</th> <th>å¹´æ’(å•ç§‘)</th> </tr>
                    </thead>
                    <tbody>
                        ${data.map((s, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${s.name}</td>
                                <td><strong>${s.scores[subjectName]}</strong></td>
                                <td>${s.rank || '-'}</td>
                                <td>${(s.gradeRanks && s.gradeRanks[subjectName]) ? s.gradeRanks[subjectName] : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        };

        document.getElementById('ss-top10-table').innerHTML = createTable(top10, 'top');
        document.getElementById('ss-bottom10-table').innerHTML = createTable(bottom10, 'bottom');


        // åªæœ‰åœ¨"å…¨ä½“"æ¨¡å¼ä¸‹æ‰æ˜¾ç¤ºç­çº§å¯¹æ¯”ï¼Œå¦åˆ™æ˜¾ç¤ºæç¤º
        const boxplotDiv = document.getElementById('ss-class-boxplot');
        const quadrantDiv = document.getElementById('ss-class-quadrant');

        if (G_CurrentClassFilter === 'ALL') {
            renderSingleSubjectClassBoxplot('ss-class-boxplot', activeData, subjectName);
            renderSingleSubjectQuadrant('ss-class-quadrant', activeData, subjectName, subjectStats);
        } else {
            boxplotDiv.innerHTML = quadrantDiv.innerHTML = `<p style="text-align:center; color:#ccc; padding-top:100px;">è¯·é€‰æ‹©â€œå…¨ä½“å¹´æ®µâ€ä»¥æŸ¥çœ‹ç­çº§å¯¹æ¯”åˆ†æ</p>`;
        }
    };

    // 3. ç»‘å®šä¸»äº‹ä»¶
    document.getElementById('ss-subject-select').addEventListener('change', drawAnalysis);

    // 4. åˆå§‹ç»˜åˆ¶ (é»˜è®¤ä½¿ç”¨åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªç§‘ç›®)
    drawAnalysis();
}

/**
 * [æ–°å¢] å•ç§‘åˆ†æ - å„ç­çº§åˆ†æ•°ç®±å½¢å›¾
 */
function renderSingleSubjectClassBoxplot(elementId, students, subject) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // 1. æ•°æ®åˆ†ç»„
    const classMap = {};
    students.forEach(s => {
        if (!classMap[s.class]) classMap[s.class] = [];
        const val = s.scores[subject];
        if (typeof val === 'number' && !isNaN(val)) {
            classMap[s.class].push(val);
        }
    });

    // 2. æ’åºç­çº§å
    const classes = Object.keys(classMap).sort();
    
    // 3. è®¡ç®—ç®±çº¿æ•°æ®
    const boxData = [];
    const outliers = [];

    classes.forEach((cls, idx) => {
        const scores = classMap[cls].sort((a, b) => a - b);
        if (scores.length === 0) {
            boxData.push([0,0,0,0,0]); return;
        }
        
        // è®¡ç®—å››åˆ†ä½
        const q1Val = quantile(scores, 0.25);
        const q2Val = quantile(scores, 0.5);
        const q3Val = quantile(scores, 0.75);
        const iqr = q3Val - q1Val;
        
        const minLimit = q1Val - 1.5 * iqr;
        const maxLimit = q3Val + 1.5 * iqr;

        // è¿‡æ»¤å¼‚å¸¸å€¼
        const normalScores = scores.filter(s => s >= minLimit && s <= maxLimit);
        const minVal = normalScores.length > 0 ? Math.min(...normalScores) : q1Val;
        const maxVal = normalScores.length > 0 ? Math.max(...normalScores) : q3Val;

        boxData.push([minVal, q1Val, q2Val, q3Val, maxVal]);

        // æ”¶é›†å¼‚å¸¸ç‚¹
        scores.forEach(s => {
            if (s < minLimit || s > maxLimit) {
                outliers.push([idx, s]);
            }
        });
    });

    // è¾…åŠ©ï¼šè®¡ç®—åˆ†ä½æ•°
    function quantile(arr, q) {
        const pos = (arr.length - 1) * q;
        const base = Math.floor(pos);
        const rest = pos - base;
        if (arr[base + 1] !== undefined) {
            return arr[base] + rest * (arr[base + 1] - arr[base]);
        } else {
            return arr[base];
        }
    }

    const option = {
        tooltip: {
            trigger: 'item',
            axisPointer: { type: 'shadow' },
            confine: true
        },
        grid: { left: '10%', right: '5%', bottom: '15%' },
        xAxis: {
            type: 'category',
            data: classes,
            axisLabel: { rotate: 30, interval: 0 }
        },
        yAxis: {
            type: 'value',
            name: 'åˆ†æ•°',
            splitArea: { show: true }
        },
        series: [
            {
                name: 'åˆ†æ•°åˆ†å¸ƒ',
                type: 'boxplot',
                data: boxData,
                itemStyle: {
                    color: '#e3f2fd',
                    borderColor: '#007bff'
                },
                tooltip: {
                    formatter: function (param) {
                        return [
                            '<strong>' + param.name + '</strong>',
                            'æœ€é«˜åˆ† (ä¸Šé¡»): ' + param.data[5].toFixed(1),
                            'Q3 (å‰25%çº¿): ' + param.data[4].toFixed(1),
                            'ä¸­ä½æ•°: ' + param.data[3].toFixed(1),
                            'Q1 (å25%çº¿): ' + param.data[2].toFixed(1),
                            'æœ€ä½åˆ† (ä¸‹é¡»): ' + param.data[1].toFixed(1)
                        ].join('<br/>');
                    }
                }
            },
            {
                name: 'å¼‚å¸¸å€¼',
                type: 'scatter',
                data: outliers,
                itemStyle: { color: '#dc3545' },
                tooltip: {
                    formatter: (p) => `<strong>${classes[p.data[0]]}</strong><br/>å¼‚å¸¸åˆ†: ${p.data[1]}`
                }
            }
        ]
    };
    myChart.setOption(option);
}

/**
 * [æ–°å¢] å•ç§‘åˆ†æ - ç­çº§å››è±¡é™è¯Šæ–­å›¾
 * Xè½´ï¼šåŠæ ¼ç‡ï¼ŒYè½´ï¼šå¹³å‡åˆ†
 */
function renderSingleSubjectQuadrant(elementId, students, subject, gradeStats) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // 1. å‡†å¤‡æ•°æ®
    const classMap = {};
    const classes = [...new Set(students.map(s => s.class))].sort();
    const config = G_SubjectConfigs[subject] || { pass: 60 };

    const data = classes.map(cls => {
        const group = students.filter(s => s.class === cls);
        const scores = group.map(s => s.scores[subject]).filter(v => typeof v === 'number');
        
        if (scores.length === 0) return null;

        const avg = scores.reduce((a,b)=>a+b, 0) / scores.length;
        const passCount = scores.filter(v => v >= config.pass).length;
        const passRate = (passCount / scores.length) * 100;

        return {
            name: cls,
            value: [passRate.toFixed(1), avg.toFixed(1)], // [X, Y]
            count: scores.length
        };
    }).filter(d => d !== null);

    // 2. åŸºå‡†çº¿ (å¹´çº§å¹³å‡)
    const gradeAvg = gradeStats.average || 0;
    const gradePassRate = gradeStats.passRate || 0;

    // 3. è®¡ç®—åæ ‡è½´èŒƒå›´ (ä¸ºäº†ç¾è§‚ï¼Œä¸ä»0å¼€å§‹)
    const minX = Math.min(...data.map(d => parseFloat(d.value[0])), gradePassRate) * 0.9;
    const maxX = Math.min(100, Math.max(...data.map(d => parseFloat(d.value[0])), gradePassRate) * 1.05);
    const minY = Math.min(...data.map(d => parseFloat(d.value[1])), gradeAvg) * 0.9;
    const maxY = Math.max(...data.map(d => parseFloat(d.value[1])), gradeAvg) * 1.05;

    const option = {
        tooltip: {
            trigger: 'item',
            formatter: (p) => {
                return `<strong>${p.name}</strong><br/>` +
                       `å¹³å‡åˆ†: ${p.value[1]}<br/>` +
                       `åŠæ ¼ç‡: ${p.value[0]}%<br/>` +
                       `äººæ•°: ${p.data.count}`;
            }
        },
        grid: { left: '10%', right: '10%', top: '10%', bottom: '10%' },
        xAxis: {
            type: 'value',
            name: 'åŠæ ¼ç‡ (%)',
            nameLocation: 'middle',
            nameGap: 25,
            min: Math.floor(minX),
            max: Math.ceil(maxX),
            splitLine: { show: false }
        },
        yAxis: {
            type: 'value',
            name: 'å¹³å‡åˆ†',
            nameLocation: 'middle',
            nameGap: 30,
            min: Math.floor(minY),
            max: Math.ceil(maxY),
            splitLine: { show: false }
        },
        series: [
            {
                type: 'scatter',
                data: data,
                symbolSize: 15,
                itemStyle: {
                    color: (p) => {
                        // ç®€å•ç€è‰²é€»è¾‘
                        const x = parseFloat(p.value[0]);
                        const y = parseFloat(p.value[1]);
                        if (x >= gradePassRate && y >= gradeAvg) return '#28a745'; // å³ä¸Š: ä¼˜
                        if (x < gradePassRate && y < gradeAvg) return '#dc3545'; // å·¦ä¸‹: å·®
                        return '#ffc107'; // ä¸­
                    },
                    shadowBlur: 5,
                    shadowColor: 'rgba(0,0,0,0.3)'
                },
                label: {
                    show: true,
                    formatter: '{b}',
                    position: 'top',
                    color: '#333',
                    fontSize: 10
                },
                markLine: {
                    silent: true,
                    symbol: 'none',
                    lineStyle: { type: 'dashed', color: '#666' },
                    label: { position: 'end' },
                    data: [
                        { xAxis: gradePassRate, name: 'å¹´çº§åŠæ ¼ç‡' },
                        { yAxis: gradeAvg, name: 'å¹´çº§å¹³å‡åˆ†' }
                    ]
                },
                markArea: {
                    silent: true,
                    itemStyle: { opacity: 0.03 },
                    data: [
                        // å³ä¸Šè±¡é™ (åŒé«˜)
                        [{ xAxis: gradePassRate, yAxis: gradeAvg }, { xAxis: 100, yAxis: maxY }],
                        // å·¦ä¸‹è±¡é™ (åŒä½) - çº¢è‰²è­¦ç¤º
                        [{ xAxis: minX, yAxis: minY }, { xAxis: gradePassRate, yAxis: gradeAvg, itemStyle: { color: '#ff0000', opacity: 0.05 } }]
                    ]
                }
            }
        ]
    };
    myChart.setOption(option);
}
/**
 * [æ——èˆ°å‡çº§ç‰ˆ] æ¨¡å—åä¸€ï¼šæˆç»©è¶‹åŠ¿å¯¹æ¯” (å«ç­çº§å¢å€¼è¯„ä»·)
 */
function renderTrend(container, currentData, compareData) {

    if (!compareData || compareData.length === 0) {
        container.innerHTML = `<h2>æ¨¡å—åä¸€ï¼šæˆç»©è¶‹åŠ¿å¯¹æ¯” (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2><p style="padding:20px; color:#999;">è¯·å…ˆåœ¨ä¾§è¾¹æ å¯¼å…¥ "å¯¹æ¯”æˆç»©" æ•°æ®ã€‚</p>`;
        return;
    }

    // 1. æ•°æ®é¢„å¤„ç†ï¼šåˆå¹¶æ–°æ—§æ•°æ®
    const mergedData = currentData.map(student => {
        const oldStudent = compareData.find(s => String(s.id) === String(student.id));
        
        // é¢„è®¡ç®—å·®å¼‚
        let rankDiff = null;
        let gradeRankDiff = null;
        let scoreDiff = null;

        if (oldStudent) {
            if (student.totalScore !== null && oldStudent.totalScore !== null) {
                scoreDiff = parseFloat((student.totalScore - oldStudent.totalScore).toFixed(2));
            }
            if (student.rank !== null && oldStudent.rank !== null) {
                rankDiff = oldStudent.rank - student.rank;
            }
            if (student.gradeRank !== null && oldStudent.gradeRank !== null) {
                gradeRankDiff = oldStudent.gradeRank - student.gradeRank;
            }
        }

        return {
            ...student,
            oldFound: !!oldStudent,
            oldTotalScore: oldStudent ? oldStudent.totalScore : null,
            oldRank: oldStudent ? oldStudent.rank : null,
            oldGradeRank: oldStudent ? oldStudent.gradeRank : null,
            scoreDiff: scoreDiff,
            rankDiff: rankDiff,
            gradeRankDiff: gradeRankDiff,
            oldScores: oldStudent ? (oldStudent.scores || {}) : {},
            oldClassRanks: oldStudent ? (oldStudent.classRanks || {}) : {},
            oldGradeRanks: oldStudent ? (oldStudent.gradeRanks || {}) : {}
        };
    });

    // 2. æ¸²æŸ“ HTML æ¡†æ¶
    container.innerHTML = `
        <h2>æ¨¡å—åä¸€ï¼šæˆç»©è¶‹åŠ¿å¯¹æ¯” (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>

        <div class="controls-bar chart-controls" style="flex-wrap: wrap; margin-bottom: 20px;">
            <label for="trend-subject-select" style="font-weight:bold;">åˆ†æå¯¹è±¡:</label>
            <select id="trend-subject-select" class="sidebar-select" style="min-width: 120px; margin-right: 15px; color: #6f42c1; font-weight: bold;">
                <option value="totalScore">æ€»åˆ†</option>
                ${G_DynamicSubjectList.map(s => `<option value="${s}">${s}</option>`).join('')}
            </select>

            <label for="trend-class-filter">ç­çº§:</label>
            <select id="trend-class-filter" class="sidebar-select" style="min-width: 120px;">
                <option value="ALL">-- å…¨ä½“å¹´æ®µ --</option>
                ${[...new Set(currentData.map(s => s.class))].sort().map(c => `<option value="${c}">${c}</option>`).join('')}
            </select>
        </div>

        <div class="main-card-wrapper" style="margin-bottom: 20px; border-left: 5px solid #fd7e14;">
            <h4 style="margin: 0 0 10px 0; color: #fd7e14;">ğŸ“Š ç­çº§å¢å€¼è¯„ä»· (Value-Added)</h4>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                <strong>â€œä½è¿›é«˜å‡ºâ€å³ä¸ºå¢å€¼ã€‚</strong><br>
                Xè½´ï¼šä¸Šæ¬¡æ’å (ä¸Šæ¬¡è€ƒè¯•å¹³å‡å¹´æ’ï¼Œè¶Šé å³ç”Ÿæºè¶Šå·®)ï¼›Yè½´ï¼šå¢å€¼å¹…åº¦ã€‚<br>
                <span style="color:#28a745">â— ç¬¬ä¸€è±¡é™ (æ’åå·®ï¼Œè¿›æ­¥å¤§)</span>
                <span style="color:#dc3545">â— ç¬¬å››è±¡é™ (æ’åå·®ï¼Œé€€æ­¥)</span>
                <span style="color:#007bff">â— ç¬¬äºŒè±¡é™ (æ’åé«˜ï¼Œè¿›æ­¥)</span>
                <span style="color:#6c757d">â— ç¬¬ä¸‰è±¡é™ (æ’åé«˜ï¼Œé€€æ­¥)</span>
            </p>
            <div class="chart-container" id="trend-class-value-added-chart" style="height: 450px;"></div>
        </div>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0;">å­¦ç”Ÿä¸ªä½“è¿›é€€æ­¥è¯¦æƒ…</h4>
                <div style="display:flex; align-items:center;">
                    <label for="trend-sort-filter" style="margin-right:5px; font-size:0.9em;">æ’åº:</label>
                    <select id="trend-sort-filter" class="sidebar-select" style="width: 160px;">
                        <option value="name">æŒ‰å§“å</option>
                        <option value="rankDiff_desc">æŒ‰ ç­æ’è¿›æ­¥ (å¤§åˆ°å°)</option>
                        <option value="gradeRankDiff_desc">æŒ‰ å¹´æ’è¿›æ­¥ (å¤§åˆ°å°)</option>
                    </select>
                </div>
            </div>
            <div class="chart-container" id="trend-rank-change-bar-chart" style="height: 350px;"></div>
        </div>

        <div class="main-card-wrapper">
            <div class="controls-bar" style="background: transparent; box-shadow: none; padding: 0 0 15px 0; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center;">
                    <label for="trend-search">æœç´¢:</label>
                    <input type="text" id="trend-search" placeholder="å§“å/è€ƒå·..." class="sidebar-select" style="width:150px;">
                </div>
                <span id="trend-table-status" style="font-size:0.85em; color:#20c997; font-weight:bold;">* è”åŠ¨æ˜¾ç¤ºæ€»åˆ†</span>
            </div>

            <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                <table>
                    <thead id="trend-table-header">
                        <tr>
                            <th data-sort-key="id" style="cursor:pointer;">è€ƒå· â‡…</th>
                            <th data-sort-key="name" style="cursor:pointer;">å§“å â‡…</th>
                            <th data-sort-key="currentVal" style="cursor:pointer;" id="th-trend-score">æ€»åˆ† â‡…</th>
                            <th data-sort-key="diffVal" style="cursor:pointer;">åˆ†å·® â‡…</th>
                            <th data-sort-key="currentCR" style="cursor:pointer;" id="th-trend-cr">ç­æ’ â‡…</th>
                            <th data-sort-key="diffCR" style="cursor:pointer;">ç­æ’å˜ â‡…</th>
                            <th data-sort-key="currentGR" style="cursor:pointer;" id="th-trend-gr">å¹´æ’ â‡…</th>
                            <th data-sort-key="diffGR" style="cursor:pointer;">å¹´æ’å˜ â‡…</th>
                        </tr>
                    </thead>
                    <tbody id="trend-table-body"></tbody>
                </table>
            </div>
        </div>
    `;

    // 3. æ ¸å¿ƒé€»è¾‘ï¼šåŠ¨æ€è®¡ç®—å½“å‰ç§‘ç›®
    const getDisplayData = () => {
        const subject = document.getElementById('trend-subject-select').value;
        const isTotal = subject === 'totalScore';

        return mergedData.map(s => {
            let currentVal, oldVal, currentCR, oldCR, currentGR, oldGR;
            
            if (isTotal) {
                currentVal = s.totalScore; oldVal = s.oldTotalScore;
                currentCR = s.rank; oldCR = s.oldRank;
                currentGR = s.gradeRank; oldGR = s.oldGradeRank;
            } else {
                currentVal = s.scores[subject]; oldVal = s.oldScores[subject];
                currentCR = s.classRanks ? s.classRanks[subject] : null;
                oldCR = s.oldClassRanks ? s.oldClassRanks[subject] : null;
                currentGR = s.gradeRanks ? s.gradeRanks[subject] : null;
                oldGR = s.oldGradeRanks ? s.oldGradeRanks[subject] : null;
            }

            let diffVal = (currentVal !== null && oldVal !== null) ? (currentVal - oldVal) : null;
            let diffCR = (currentCR !== null && oldCR !== null) ? (oldCR - currentCR) : null; 
            let diffGR = (currentGR !== null && oldGR !== null) ? (oldGR - currentGR) : null;

            return {
                raw: s, id: s.id, name: s.name, class: s.class,
                currentVal, oldVal, diffVal,
                currentCR, oldCR, diffCR,
                currentGR, oldGR, diffGR,
                // è¾…åŠ©å­—æ®µï¼šç”¨äºå¢å€¼è®¡ç®—
                validGradeChange: (currentGR !== null && oldGR !== null)
            };
        });
    };

    // 4. ğŸ”¥ ç»˜åˆ¶ å¢å€¼è¯„ä»·å›¾ (ä¸Šå¸è§†è§’ä¿®å¤ç‰ˆ) ğŸ”¥
    const drawValueAddedChart = () => {
        const subject = document.getElementById('trend-subject-select').value;
        const subjectLabel = (subject === 'totalScore') ? 'æ€»åˆ†' : subject;
        const currentFilterClass = document.getElementById('trend-class-filter').value;

        // ğŸ”¥ å…³é”®ï¼šå¼ºåˆ¶ä½¿ç”¨å…¨å±€æ•°æ® G_StudentsData è®¡ç®—ç­çº§æŒ‡æ ‡ï¼Œä¸å—ç­›é€‰å½±å“
        const globalClassMap = {};
        
        G_StudentsData.forEach(s => {
            // æ‰¾åˆ°æ—§æ•°æ®
            const oldS = G_CompareData.find(o => String(o.id) === String(s.id));
            if (!globalClassMap[s.class]) globalClassMap[s.class] = { name: s.class, sumOldRank: 0, sumChange: 0, count: 0 };
            
            // è®¡ç®—å•ç§‘/æ€»åˆ†æ’åå˜åŒ–
            let oldR = null, newR = null;
            if (subject === 'totalScore') {
                if (s.gradeRank && oldS && oldS.gradeRank) { oldR = oldS.gradeRank; newR = s.gradeRank; }
            } else {
                // ç¡®ä¿å•ç§‘æ’åå­˜åœ¨
                if (s.gradeRanks && s.gradeRanks[subject] && oldS && oldS.gradeRanks && oldS.gradeRanks[subject]) {
                    oldR = oldS.gradeRanks[subject];
                    newR = s.gradeRanks[subject];
                }
            }

            if (oldR !== null && newR !== null) {
                globalClassMap[s.class].sumOldRank += oldR;
                globalClassMap[s.class].sumChange += (oldR - newR); // æ­£æ•°=è¿›æ­¥
                globalClassMap[s.class].count++;
            }
        });

        const chartData = [];
        const missingClasses = [];

        // è·å–æ‰€æœ‰ç­çº§åˆ—è¡¨
        const allClasses = [...new Set(G_StudentsData.map(s => s.class))].sort();
        
        allClasses.forEach(cls => {
            const c = globalClassMap[cls];
            if (c && c.count > 0) {
                // ğŸ”¥ é˜²é‡å æŠ–åŠ¨ (Jitter)ï¼šåŠ ä¸€ä¸ªæå°çš„éšæœºæ•° (-0.05 ~ 0.05)
                // è¿™æ ·å³ä½¿ä¸¤ä¸ªç­æ•°æ®å®Œå…¨ä¸€æ ·ï¼Œä¹Ÿèƒ½é”™å¼€æ˜¾ç¤º
                const jitterX = (Math.random() - 0.5) * 0.1; 
                const jitterY = (Math.random() - 0.5) * 0.1;

                chartData.push({
                    name: cls,
                    x: parseFloat((c.sumOldRank / c.count).toFixed(1)) + jitterX,
                    y: parseFloat((c.sumChange / c.count).toFixed(1)) + jitterY,
                    count: c.count,
                    isHighlight: (currentFilterClass === 'ALL' || currentFilterClass === cls) // æ ‡è®°é«˜äº®
                });
            } else {
                missingClasses.push(cls);
            }
        });

        let subTitle = "";
        if (missingClasses.length > 0) subTitle = `âš ï¸ [${missingClasses.join(', ')}] å› ç¼ºæ•°æ®æœªæ˜¾ç¤º`;

        // è°ƒç”¨ç»˜å›¾ (ä¼ å…¥é«˜äº®æ ‡è®°)
        renderClassValueAddedChart('trend-class-value-added-chart', chartData, subjectLabel, subTitle);
    };

    // 5. æ¸²æŸ“è¡¨æ ¼
    const drawTable = () => {
        const subject = document.getElementById('trend-subject-select').value;
        const subjectLabel = (subject === 'totalScore') ? 'æ€»åˆ†' : subject;
        const searchTerm = document.getElementById('trend-search').value.toLowerCase();
        const selectedClass = document.getElementById('trend-class-filter').value;

        document.getElementById('th-trend-score').innerText = `${subjectLabel} â‡…`;
        document.getElementById('th-trend-cr').innerText = `${subjectLabel}ç­æ’ â‡…`;
        document.getElementById('th-trend-gr').innerText = `${subjectLabel}å¹´æ’ â‡…`;
        document.getElementById('trend-table-status').innerText = `* å·²è”åŠ¨æ˜¾ç¤ºâ€œ${subjectLabel}â€æ•°æ®`;

        let data = getDisplayData();

        data = data.filter(item => {
            if (selectedClass !== 'ALL' && item.class !== selectedClass) return false;
            if (searchTerm && !item.name.toLowerCase().includes(searchTerm) && !String(item.id).includes(searchTerm)) return false;
            return true;
        });

        const { key, direction } = G_TrendSort; 
        data.sort((a, b) => {
            let valA = a[key], valB = b[key];
            if (valA == null) valA = direction === 'asc' ? 99999 : -99999;
            if (valB == null) valB = direction === 'asc' ? 99999 : -99999;
            if (typeof valA === 'string') return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return direction === 'asc' ? valA - valB : valB - valA;
        });

        const tbody = document.getElementById('trend-table-body');
        if (data.length === 0) { tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:20px; color:#999;">æ— æ•°æ®</td></tr>`; return; }

        tbody.innerHTML = data.map(row => {
            const formatDiff = (val) => {
                if (val == null) return '<span style="color:#ccc">-</span>';
                if (val === 0) return `<span style="color:#999;">0</span>`;
                if (val > 0) return `<span class="progress">â–² ${val}</span>`;
                return `<span class="regress">â–¼ ${Math.abs(val)}</span>`;
            };
            const formatScoreDiff = (val) => {
                 if (val == null) return '<span style="color:#ccc">-</span>';
                 if (val === 0) return `<span style="color:#999;">0</span>`;
                 if (val > 0) return `<span class="progress">â–² +${val.toFixed(1)}</span>`;
                 return `<span class="regress">â–¼ ${val.toFixed(1)}</span>`;
            };

            return `
                <tr>
                    <td>${row.id}</td><td><strong>${row.name}</strong></td>
                    <td><strong>${row.currentVal ?? '-'}</strong> <span style="font-size:0.8em; color:#999;">(å‰:${row.oldVal ?? '-'})</span></td>
                    <td>${formatScoreDiff(row.diffVal)}</td>
                    <td><strong>${row.currentCR ?? '-'}</strong></td><td>${formatDiff(row.diffCR)}</td>
                    <td>${row.currentGR ?? '-'}</td><td>${formatDiff(row.diffGR)}</td>
                </tr>
            `;
        }).join('');
    };

    // 6. ç»˜åˆ¶ä¸ªä½“æŸ±çŠ¶å›¾
    const drawCharts = () => {
        const classFilter = document.getElementById('trend-class-filter').value;
        const sortFilter = document.getElementById('trend-sort-filter').value;
        const subject = document.getElementById('trend-subject-select').value;
        
        let chartSource = mergedData;
        if (classFilter !== 'ALL') chartSource = mergedData.filter(s => s.class === classFilter);
        
        renderRankChangeBarChart('trend-rank-change-bar-chart', chartSource, sortFilter, subject);
    };

    // 7. ç»‘å®šäº‹ä»¶
    const subjectSelect = document.getElementById('trend-subject-select');
    const classSelect = document.getElementById('trend-class-filter');
    const sortSelect = document.getElementById('trend-sort-filter');
    const searchInput = document.getElementById('trend-search');
    const tableHead = document.getElementById('trend-table-header');

    const refreshAll = () => { drawValueAddedChart(); drawCharts(); drawTable(); };

    subjectSelect.addEventListener('change', refreshAll);
    classSelect.addEventListener('change', refreshAll);
    sortSelect.addEventListener('change', drawCharts);
    searchInput.addEventListener('input', drawTable);

    tableHead.addEventListener('click', (e) => {
        const th = e.target.closest('th[data-sort-key]');
        if (!th) return;
        const newKey = th.dataset.sortKey;
        if (newKey === G_TrendSort.key) G_TrendSort.direction = (G_TrendSort.direction === 'asc') ? 'desc' : 'asc';
        else { G_TrendSort.key = newKey; G_TrendSort.direction = ['diffVal','diffCR','diffGR'].includes(newKey) ? 'desc' : 'asc'; }
        
        tableHead.querySelectorAll('th').forEach(h => h.style.color = '');
        th.style.color = '#007bff';
        drawTable();
    });

    // 8. åˆå§‹åŒ–
    G_TrendSort = { key: 'diffGR', direction: 'desc' }; // é»˜è®¤æŒ‰å¹´æ’è¿›æ­¥æ’åº
    refreshAll();
}

/**
 * [å®Œæ•´ç‰ˆ] ç»˜åˆ¶ç­çº§å¢å€¼è¯„ä»·æ•£ç‚¹å›¾ (å››è±¡é™å¸¦æ ‡ç­¾)
 * @param {string} elementId - DOM å®¹å™¨ ID
 * @param {Array} data - æ•°æ®æ•°ç»„ [{name: '1ç­', x: 120, y: 5, count: 45}, ...]
 * @param {string} subjectName - ç§‘ç›®åç§°
 * @param {string} subTitle - (å¯é€‰) å‰¯æ ‡é¢˜ï¼Œç”¨äºæ˜¾ç¤ºç¼ºå¤±ç­çº§æç¤º
 */

/**
 * [æ——èˆ°å®Œæ•´ç‰ˆ] ç»˜åˆ¶ç­çº§å¢å€¼è¯„ä»·æ•£ç‚¹å›¾
 * - ç‰¹æ€§1ï¼šæ”¯æŒé«˜äº®é€‰ä¸­ç­çº§ (UI ä¼˜åŒ–)
 * - ç‰¹æ€§2ï¼šTooltip æ˜¾ç¤ºè¯¦ç»†æ•°æ®ä¸”ä¿ç•™æœ‰æ•ˆæ•°å­— (toFixedä¿®å¤)
 */
function renderClassValueAddedChart(elementId, data, subjectName, subTitle = "") {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    if (!data || data.length === 0) {
        chartDom.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#999;">æš‚æ— æœ‰æ•ˆå¢å€¼æ•°æ® (éœ€åŒæ—¶æ‹¥æœ‰ä¸¤æ¬¡è€ƒè¯•çš„æ’å)</div>`;
        return;
    }

    // å®šä¹‰é¢œè‰²
    const colors = { Q1: '#28a745', Q2: '#007bff', Q3: '#ffc107', Q4: '#dc3545' };

    // 1. è®¡ç®—åæ ‡è½´èŒƒå›´
    const xValues = data.map(d => d.x);
// åŠ¨æ€è®¡ç®— X è½´èŒƒå›´ï¼Œé¿å…ç‚¹è´´åœ¨è¾¹ç¼˜ (å¹¶å‘ä¸‹/å‘ä¸Šå–æ•´ï¼Œå»é™¤å°æ•°)
    const minX = Math.floor(Math.min(...xValues) * 0.9);
    const maxX = Math.ceil(Math.max(...xValues) * 1.1);
    const avgEntryRank = xValues.reduce((a,b)=>a+b,0) / xValues.length;

    // 2. å‡†å¤‡ Series Data (å¸¦é«˜äº®é€»è¾‘)
    const seriesData = data.map(item => ({
        name: item.name,
        value: [item.x, item.y, item.count],
        // é«˜äº®é€»è¾‘ï¼šé€‰ä¸­çš„ä¸é€æ˜ï¼Œæœªé€‰ä¸­çš„åŠé€æ˜
        itemStyle: { 
            shadowBlur: item.isHighlight ? 20 : 0, 
            shadowColor: 'rgba(0,0,0,0.5)',
            opacity: item.isHighlight ? 1 : 0.2, 
            borderColor: item.isHighlight ? '#000' : null,
            borderWidth: item.isHighlight ? 1 : 0
        },
        label: {
            show: true,
            formatter: '{b}',
            position: 'top',
            color: item.isHighlight ? '#333' : '#ccc',
            fontWeight: item.isHighlight ? 'bold' : 'normal'
        }
    }));

    // 3. ECharts é…ç½®
    const option = {
        title: {
            text: `${subjectName} - ç­çº§å¢å€¼å››è±¡é™ (å…¨æ ¡è§†è§’)`,
            subtext: subTitle,
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' },
            subtextStyle: { color: '#f56c6c' }
        },
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(255,255,255,0.95)',
            formatter: (params) => {
                if (params.componentType !== 'series') return;
                
                const d = params.data;
                const entryRank = d.value[0];
                const progress = d.value[1];

                // ğŸ”¥ ä¿®å¤ç‚¹ï¼šå¼ºåˆ¶ä¿ç•™å°æ•°ä½ï¼Œé˜²æ­¢æ˜¾ç¤ºè¿‡é•¿ ğŸ”¥
                const progressFixed = parseFloat(progress).toFixed(2);
                const entryRankFixed = parseFloat(entryRank).toFixed(1);
                
                // åˆ¤æ–­è±¡é™
                let type = "";
                if (progress >= 0) {
                    type = entryRank >= avgEntryRank ? "ğŸŒŸ é€†è¢­ç­çº§ (æ’åå¼±, è¿›æ­¥å¤§)" : "ğŸ’ª åŸ¹ä¼˜ç­çº§ (æ’åå¼º, è¿›æ­¥å¤§)";
                } else {
                    type = entryRank >= avgEntryRank ? "âš ï¸ ä½æ•ˆåŒº (æ’åå¼±, ä¸”é€€æ­¥)" : "ğŸ“‰ è­¦ç¤ºåŒº (æ’åå¼º, ä½†é€€æ­¥)";
                }

                // è¿”å›è¯¦ç»†çš„ HTML ç»“æ„
                return `<strong>${d.name}</strong><br/>` +
                       `ä¸Šæ¬¡æ’å: å¹´æ’ ${entryRankFixed}<br/>` +
                       `æœ¬æ¬¡å¢å€¼: <strong style="color:${progress>=0?'#28a745':'#dc3545'}">${progress>0?'+':''}${progressFixed} å</strong><br/>` +
                       `å‚è¯„äººæ•°: ${d.value[2]}<br/>` +
                       `<hr style="margin:5px 0;border-color:#eee"/>${type}`;
            }
        },
        grid: { left: '8%', right: '12%', bottom: '10%', top: '18%', containLabel: true },
        xAxis: {
            type: 'value', name: 'ä¸Šæ¬¡æ’å (æ’åè¶Šå¤§è¶Šå¼± â†’)', nameLocation: 'middle', nameGap: 30,
            min: minX, max: maxX, scale: true, splitLine: { show: false }, axisLine: { symbol: ['none', 'arrow'] }
        },
        yAxis: {
            type: 'value', name: 'æ•™å­¦å¢å€¼ (è¿›æ­¥åæ¬¡ â†‘)', nameLocation: 'middle', nameGap: 40,
            scale: true, splitLine: { show: false }, axisLine: { symbol: ['none', 'arrow'] }
        },
        series: [
            {
                type: 'scatter',
                data: seriesData,
                symbolSize: (val) => Math.max(15, Math.min(50, val[2])),
                itemStyle: {
                    // åŠ¨æ€è®¡ç®—æ°”æ³¡é¢œè‰²
                    color: (params) => {
                        const [x, y] = params.value;
                        if (x >= avgEntryRank && y >= 0) return colors.Q1;
                        if (x < avgEntryRank && y >= 0) return colors.Q2;
                        if (x < avgEntryRank && y < 0) return colors.Q3;
                        return colors.Q4;
                    }
                },
                markLine: {
                    silent: true, symbol: 'none', lineStyle: { color: '#333', width: 2, type: 'dashed' },
                    data: [
                        { xAxis: avgEntryRank, name: 'å¹³å‡ç”Ÿæºçº¿' },
                        { yAxis: 0, name: 'é›¶å¢å€¼çº¿' }
                    ]
                },
                markArea: {
                    silent: true, itemStyle: { opacity: 0.08 },
                    data: [
                        [{ xAxis: avgEntryRank, yAxis: 0, itemStyle: {color: colors.Q1} }, { xAxis: 99999, yAxis: 99999 }],
                        [{ xAxis: -99999, yAxis: 0, itemStyle: {color: colors.Q2} }, { xAxis: avgEntryRank, yAxis: 99999 }],
                        [{ xAxis: -99999, yAxis: -99999, itemStyle: {color: colors.Q3} }, { xAxis: avgEntryRank, yAxis: 0 }],
                        [{ xAxis: avgEntryRank, yAxis: -99999, itemStyle: {color: colors.Q4} }, { xAxis: 99999, yAxis: 0 }]
                    ]
                }
            }
        ]
    };

    myChart.setOption(option);
    
    // åŠ¨æ€æ·»åŠ å››è§’æ ‡ç­¾
    setTimeout(() => {
        myChart.setOption({
            graphic: [
                { type: 'text', right: '5%', top: '20%', style: { text: 'ğŸŒŸ é€†è¢­åŒº', fill: colors.Q1, font: 'bold 14px sans-serif' } },
                { type: 'text', left: '10%', top: '20%', style: { text: 'ğŸ’ª åŸ¹ä¼˜åŒº', fill: colors.Q2, font: 'bold 14px sans-serif' } },
                { type: 'text', left: '10%', bottom: '15%', style: { text: 'ğŸ“‰ è­¦ç¤ºåŒº', fill: colors.Q3, font: 'bold 14px sans-serif' } },
                { type: 'text', right: '5%', bottom: '15%', style: { text: 'âš ï¸ ä½æ•ˆåŒº', fill: colors.Q4, font: 'bold 14px sans-serif' } }
            ]
        });
    }, 100);
}

/**
 * 9.5. æ¨¡å—äº”ï¼šå­¦ç”Ÿåˆ†å±‚ç­›é€‰
 *    (å…³é”®) A/B/C/D å¿«æ·æŒ‰é’®ç°åœ¨ä» config.good è¯»å–
 */
function renderGroups(container, students) {
    // 1.   æ¸²æŸ“ç­›é€‰å™¨å¡ç‰‡
    container.innerHTML = `
        <h2>æ¨¡å—å…«ï¼šå­¦ç”Ÿåˆ†å±‚ç­›é€‰ (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>
        
        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <div class="controls-bar" style="background: transparent; box-shadow: none; padding: 0; margin-bottom: 0; flex-wrap: wrap;">
                <label for="group-subject">ç­›é€‰ç§‘ç›®:</label>
                <select id="group-subject" class="sidebar-select">
                    <option value="totalScore">æ€»åˆ†</option>
                    ${G_DynamicSubjectList.map(s => `<option value="${s}">${s}</option>`).join('')}
                </select>
                <input type="number" id="group-min" placeholder="æœ€ä½åˆ†" value="0">
                <label for="group-max"> <= åˆ†æ•° <= </label>
                <input type="number" id="group-max" placeholder="æœ€é«˜åˆ†" value="900">
                <button id="group-filter-btn" class="sidebar-button">ç­›é€‰</button>
            </div>
            
            <div class="shortcut-btn-group">
                <label style="font-size: 0.9em; color: var(--text-muted); align-self: center;">å¿«æ·æ–¹å¼:</label>
                <button class="shortcut-btn" data-type="A">A (ä¼˜ç§€)</button>
                <button class="shortcut-btn" data-type="B">B (è‰¯å¥½)</button>
                <button class="shortcut-btn" data-type="C">C (åŠæ ¼)</button>
                <button class="shortcut-btn" data-type="D">D (ä¸åŠæ ¼)</button>
            </div>
        </div>

        <div class="main-card-wrapper" id="group-results-wrapper" style="display: none;">
            
            <div id="group-results-table"></div>

            <div class="dashboard-chart-grid-2x2" style="margin-top: 20px;">
                <div class="main-card-wrapper" style="padding: 10px;">
                    <h4 style="margin:0 0 10px 0; text-align:center;">ğŸ¥§ ç­›é€‰ç¾¤ä½“çš„ç­çº§æ„æˆ</h4>
                    <div class="chart-container" id="group-class-pie-chart" style="height: 350px;"></div>
                </div>
                <div class="main-card-wrapper" style="padding: 10px;">
                    <h4 style="margin:0 0 10px 0; text-align:center;">ğŸ•¸ï¸ ç¾¤ä½“èƒ½åŠ› vs å…¨ä½“å¹³å‡</h4>
                    <p style="font-size:0.8em; color:#999; text-align:center; margin:0;">(åŸºäºå„ç§‘å¾—åˆ†ç‡/éš¾åº¦ç³»æ•°å¯¹æ¯”)</p>
                    <div class="chart-container" id="group-radar-chart" style="height: 350px;"></div>
                </div>
            </div>

        </div>
    `;

    // 2. ç»‘å®šäº‹ä»¶
    const subjectSelect = document.getElementById('group-subject');
    const minInput = document.getElementById('group-min');
    const maxInput = document.getElementById('group-max');
    const filterBtn = document.getElementById('group-filter-btn');
    const resultsWrapper = document.getElementById('group-results-wrapper');
    const tableEl = document.getElementById('group-results-table');
    const shortcutBtns = document.querySelectorAll('.shortcut-btn');

    // 3. (    ) å¿«æ·æŒ‰é’®äº‹ä»¶
    shortcutBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const type = btn.dataset.type;
            const subject = subjectSelect.value;
            let config;
            let min = 0, max = 0;

            if (subject === 'totalScore') {
                const full = G_DynamicSubjectList.reduce((sum, key) => sum + (G_SubjectConfigs[key]?.full || 0), 0);
                const excel = G_DynamicSubjectList.reduce((sum, key) => sum + (G_SubjectConfigs[key]?.excel || 0), 0);
                const good = G_DynamicSubjectList.reduce((sum, key) => sum + (G_SubjectConfigs[key]?.good || 0), 0);
                const pass = G_DynamicSubjectList.reduce((sum, key) => sum + (G_SubjectConfigs[key]?.pass || 0), 0);
                config = { full: full, excel: excel, good: good, pass: pass };
            } else {
                config = G_SubjectConfigs[subject];
            }

            //    æ ¸å¿ƒä¿®æ­£ï¼šä»é…ç½®ä¸­è¯»å–å¯å®šä¹‰çš„ "è‰¯å¥½çº¿"
            const goodLine = config.good;

            switch (type) {
                case 'A': min = config.excel; max = config.full; break;
                case 'B': min = goodLine; max = config.excel; break;
                case 'C': min = config.pass; max = goodLine; break;
                case 'D': min = 0; max = config.pass; break;
            }

            minInput.value = Math.floor(min);
            maxInput.value = Math.ceil(max);
        });
    });

// 4.   ç­›é€‰æŒ‰é’®äº‹ä»¶ (æ ¸å¿ƒ)
    filterBtn.addEventListener('click', () => {
        const subject = subjectSelect.value;
        const min = parseFloat(minInput.value);
        const max = parseFloat(maxInput.value);

        const filteredStudents = students.filter(s => {
            const score = (subject === 'totalScore') ? s.totalScore : s.scores[subject];
            return score >= min && score <= max;
        });

        resultsWrapper.style.display = 'block';

        // 4.1 æ¸²æŸ“è¡¨æ ¼ (ä¿ç•™åŸä»£ç ï¼Œè¿™é‡Œç®€å†™)
        if (filteredStudents.length === 0) {
            tableEl.innerHTML = `<p>åœ¨ ${min} - ${max} åˆ†æ•°æ®µå†…æ²¡æœ‰æ‰¾åˆ°å­¦ç”Ÿã€‚</p>`;
            // æ¸…ç©ºå›¾è¡¨
            document.getElementById('group-class-pie-chart').innerHTML = '';
            document.getElementById('group-radar-chart').innerHTML = '';
            return;
        }

        tableEl.innerHTML = `
            <h4>ç­›é€‰ç»“æœ (å…± ${filteredStudents.length} äºº)</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ç­æ’</th>
                            <th>å§“å</th>
                            <th>è€ƒå·</th>
                            <th>${subject === 'totalScore' ? 'æ€»åˆ†' : subject}</th>
                            <th>å¹´æ’</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredStudents.map(s => `
                        <tr>
                            <td>${s.rank}</td>
                            <td>${s.name}</td>
                            <td>${s.id}</td>
                            <td><strong>${subject === 'totalScore' ? s.totalScore : s.scores[subject]}</strong></td>
                            <td>${s.gradeRank || 'N/A'}</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

       // ğŸ”¥ æ–°å¢ï¼šæ¸²æŸ“ä¸¤ä¸ªåˆ†æå›¾è¡¨
        renderGroupClassPie('group-class-pie-chart', filteredStudents);

        // [ä¿®å¤] ç¡®ä¿ä¼ å…¥æœ‰æ•ˆçš„å…¨ä½“ç»Ÿè®¡æ•°æ®
        // å¦‚æœ G_Statistics ä¸ºç©ºï¼ˆè¿˜æ²¡è®¡ç®—è¿‡ï¼‰ï¼Œåˆ™ç°åœºç”¨æ‰€æœ‰å­¦ç”Ÿæ•°æ®ç®—ä¸€æ¬¡
        let globalStats = G_Statistics;
        if (!globalStats || Object.keys(globalStats).length === 0) {
            // å‡è®¾ä½ å·²ç»å®šä¹‰äº† G_StudentsData å’Œ calculateAllStatistics
            if (typeof G_StudentsData !== 'undefined' && typeof calculateAllStatistics === 'function') {
                globalStats = calculateAllStatistics(G_StudentsData);
            } else {
                globalStats = {}; // æœ€åçš„ä¿åº•ï¼Œé˜²æ­¢æŠ¥é”™
            }
        }
        
        renderGroupRadarChart('group-radar-chart', filteredStudents, globalStats);
    });
}


/**
 * [æ–°å¢] æ¨¡å—å…«ï¼šç­›é€‰ç»“æœ - ç­çº§æ„æˆé¥¼å›¾
 * å±•ç¤ºç­›é€‰å‡ºæ¥çš„è¿™æ‰¹äººï¼Œä¸»è¦åˆ†å¸ƒåœ¨å“ªäº›ç­çº§
 */
function renderGroupClassPie(elementId, filteredStudents) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. ç»Ÿè®¡ç­çº§
    const classCounts = {};
    filteredStudents.forEach(student => {
        classCounts[student.class] = (classCounts[student.class] || 0) + 1;
    });

    // 2. è½¬æ¢ä¸º ECharts æ•°æ®
    const pieData = Object.keys(classCounts).map(className => {
        return {
            value: classCounts[className],
            name: className
        };
    }).sort((a, b) => b.value - a.value); // (æŒ‰äººæ•°é™åº)

    const option = {
        title: {
            text: 'ç­›é€‰ç¾¤ä½“çš„ç­çº§æ„æˆ',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c}äºº ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left',
            top: 'middle',
            type: 'scroll',
            data: pieData.map(d => d.name)
        },
        series: [{
            name: 'ç­çº§',
            type: 'pie',
            radius: ['40%', '70%'], // (ç©ºå¿ƒåœ†ï¼Œæ›´ç°ä»£)
            center: ['65%', '55%'], // (é¥¼å›¾é å³, ä¸ºå›¾ä¾‹è…¾ç©ºé—´)
            data: pieData,
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            label: {
                show: true,
                formatter: '{c}äºº', // é¥¼å›¾ä¸Šç›´æ¥æ˜¾ç¤ºäººæ•°
                position: 'outside'
            }
        }]
    };
    echartsInstances[elementId].setOption(option);
}

/**
 * [æ–°å¢] æ¨¡å—å…«ï¼šç­›é€‰ç»“æœ - ç¾¤ä½“èƒ½åŠ›é›·è¾¾å›¾
 * (å¯¹æ¯” "ç­›é€‰ç¾¤ä½“" vs "å…¨ä½“å¹³å‡" çš„å¾—åˆ†ç‡)
 */
function renderGroupRadarChart(elementId, filteredStudents, totalStats) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. (å…³é”®) é‡æ–°è®¡ç®—è¿™ä¸ª "ç­›é€‰ç¾¤ä½“" çš„ç»Ÿè®¡æ•°æ®
    // æˆ‘ä»¬å¤ç”¨ calculateAllStatistics å‡½æ•°æ¥è·å¾—è¯¥ç¾¤ä½“çš„å¹³å‡åˆ†
    const groupStats = calculateAllStatistics(filteredStudents);

    // 2. å‡†å¤‡é›·è¾¾å›¾æŒ‡ç¤ºå™¨
    // ä¸ºäº†æ¶ˆé™¤å„ç§‘æ»¡åˆ†ä¸åŒçš„å½±å“ï¼Œæˆ‘ä»¬ç»Ÿä¸€ä½¿ç”¨â€œå¾—åˆ†ç‡/éš¾åº¦ç³»æ•°â€ (Score / FullScore)
    // å¦‚æœæ²¡æœ‰é…ç½®éš¾åº¦ç³»æ•°ï¼Œå¯ä»¥ç”¨ Average / Full è®¡ç®—
    const indicators = G_DynamicSubjectList.map(subject => {
        return { name: subject, max: 1.0 }; // æ»¡åˆ†ç‡å‡ä¸º 1.0
    });

    // 3. è·å– "ç­›é€‰ç¾¤ä½“" çš„å¾—åˆ†ç‡
    const groupData = G_DynamicSubjectList.map(subject => {
        const stats = groupStats[subject];
        // éš¾åº¦ = å¹³å‡åˆ† / æ»¡åˆ†ã€‚å¦‚æœ groupStats é‡Œæ²¡æœ‰ difficulty å±æ€§ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ç®—
        if (stats && stats.difficulty !== undefined) return stats.difficulty;
        if (stats && G_SubjectConfigs[subject]) return stats.average / G_SubjectConfigs[subject].full;
        return 0;
    });

    // 4. è·å– "å…¨ä½“å¹³å‡" çš„å¾—åˆ†ç‡
    const totalData = G_DynamicSubjectList.map(subject => {
        const stats = totalStats[subject];
        if (stats && stats.difficulty !== undefined) return stats.difficulty;
        if (stats && G_SubjectConfigs[subject]) return stats.average / G_SubjectConfigs[subject].full;
        return 0;
    });

    const option = {
        title: {
            text: 'ç¾¤ä½“èƒ½åŠ› vs å…¨ä½“å¹³å‡',
            subtext: '(æŒ‡æ ‡: å¾—åˆ†ç‡/éš¾åº¦)',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: { trigger: 'item' },
        legend: {
            data: ['ç­›é€‰ç¾¤ä½“', 'å…¨ä½“å¹³å‡'],
            bottom: 10
        },
        radar: {
            indicator: indicators,
            radius: '65%',
            splitArea: {
                areaStyle: {
                    color: ['rgba(250,250,250,0.3)', 'rgba(200,200,200,0.3)']
                }
            }
        },
        series: [{
            name: 'ç¾¤ä½“ vs å…¨ä½“',
            type: 'radar',
            data: [
                {
                    value: groupData,
                    name: 'ç­›é€‰ç¾¤ä½“',
                    areaStyle: { opacity: 0.4, color: '#28a745' }, // ç»¿è‰²ä»£è¡¨é€‰å‡ºæ¥çš„ï¼ˆé€šå¸¸æ˜¯ä¼˜ç§€çš„ï¼‰
                    itemStyle: { color: '#28a745' },
                    lineStyle: { color: '#28a745' }
                },
                {
                    value: totalData,
                    name: 'å…¨ä½“å¹³å‡',
                    areaStyle: { opacity: 0.2, color: '#007bff' }, // è“è‰²ä»£è¡¨åŸºå‡†
                    itemStyle: { color: '#007bff' },
                    lineStyle: { color: '#007bff' }
                }
            ]
        }]
    };
    echartsInstances[elementId].setOption(option);
}
/**
 * [é‡æ„ç‰ˆ] 9.6. æ¨¡å—ä¹ï¼šå­¦ç§‘å…³è”çŸ©é˜µ (ä¸»å…¥å£)
 * - ç»Ÿä¸€è®¡ç®—ç›¸å…³ç³»æ•°çŸ©é˜µ
 * - æ¸²æŸ“çƒ­åŠ›å›¾ã€ç½‘ç»œå›¾ã€å½±å“åŠ›æ’è¡Œ
 */
function renderCorrelation(container, activeData) {
    // 1. æ¸²æŸ“åŸºç¡€ HTML
    container.innerHTML = `
        <h2>æ¨¡å—ä¹ï¼šå­¦ç§‘å…³è”çŸ©é˜µ (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>
        <p style="margin-top: -20px; margin-bottom: 20px; color: var(--text-muted);">
            æ¢ç´¢å­¦ç§‘é—´çš„éšæ€§å…³è”ã€‚ç›¸å…³ç³»æ•°è¶Šæ¥è¿‘ 1ï¼Œè¯´æ˜ä¸¤ç§‘æˆç»©â€œåŒè¿›é€€â€çš„è¶‹åŠ¿è¶Šå¼ºã€‚
        </p>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <h4 style="margin:0;">ğŸ”¥ å…¨ç§‘ç›¸å…³ç³»æ•°çƒ­åŠ›å›¾</h4>
            <div class="chart-container" id="correlation-heatmap-chart" style="width: 100%; height: 600px;"></div>
        </div>

        <div class="dashboard-chart-grid-2x2" style="margin-bottom: 20px;">
            <div class="main-card-wrapper">
                <h4 style="margin:0;">ğŸ•¸ï¸ å­¦ç§‘â€œå¼•åŠ›â€ç½‘ç»œæ‹“æ‰‘å›¾</h4>
                <p style="font-size:0.8em; color:#999; margin:5px 0;">* çº¿æ¡è¶Šç²—ä»£è¡¨å…³è”è¶Šå¼ºã€‚æŠ±å›¢çš„ç§‘ç›®é€šå¸¸éœ€è¦ç›¸ä¼¼çš„æ€ç»´èƒ½åŠ›ã€‚</p>
                <div class="chart-container" id="correlation-network-chart" style="height: 450px;"></div>
            </div>
            <div class="main-card-wrapper">
                <h4 style="margin:0;">ğŸ‘‘ å­¦ç§‘â€œæ ¸å¿ƒå½±å“åŠ›â€æ’è¡Œ</h4>
                <p style="font-size:0.8em; color:#999; margin:5px 0;">* æ ¸å¿ƒåº¦ = è¯¥ç§‘ä¸å…¶ä»–æ‰€æœ‰ç§‘ç›®ç›¸å…³æ€§çš„å‡å€¼ã€‚åˆ†å€¼è¶Šé«˜ï¼Œä»£è¡¨è¯¥ç§‘è¶Šèƒ½åæ˜ ç»¼åˆå®åŠ›ã€‚</p>
                <div class="chart-container" id="correlation-centrality-chart" style="height: 450px;"></div>
            </div>
        </div>
    `;

    // 2. [æ ¸å¿ƒ] ç»Ÿä¸€è®¡ç®—çŸ©é˜µæ•°æ®
    const subjects = G_DynamicSubjectList;
    const n = subjects.length;
    
    // å‡†å¤‡æ•°æ®ç»“æ„
    // matrix: äºŒç»´æ•°ç»„ï¼Œå­˜å‚¨ç›¸å…³ç³»æ•°
    // nodes: å­¦ç§‘èŠ‚ç‚¹
    // links: å¼ºç›¸å…³è¿çº¿
    // centrality: æ ¸å¿ƒåº¦æ•°ç»„
    const matrix = Array(n).fill(0).map(() => Array(n).fill(0));
    const links = [];
    const centrality = subjects.map(sub => ({ name: sub, totalR: 0, count: 0 }));

    // é¢„å¤„ç†ï¼šæå–æ‰€æœ‰åˆ†æ•°ï¼Œå‡å°‘å¾ªç¯å†…çš„ map æ“ä½œ
    const scoresCache = {};
    subjects.forEach(sub => {
        scoresCache[sub] = [];
    });
    activeData.forEach(s => {
        subjects.forEach(sub => {
            // åªæœ‰å½“ä¸¤ä¸ªç§‘ç›®éƒ½æœ‰åˆ†æ—¶ï¼Œæ‰è®¡å…¥æˆå¯¹æ•°æ®
            if (s.scores[sub] !== undefined && s.scores[sub] !== null) {
                scoresCache[sub].push(s.scores[sub]); // è¿™é‡Œæš‚å­˜ï¼Œåç»­æˆå¯¹å¤„ç†æ—¶éœ€è¦å¯¹é½ç´¢å¼•
            }
        });
    });

    // åŒé‡å¾ªç¯è®¡ç®—çŸ©é˜µ
    for (let i = 0; i < n; i++) {
        for (let j = 0; j < n; j++) {
            if (i === j) {
                matrix[i][j] = 1.0;
            } else if (i < j) {
                const subA = subjects[i];
                const subB = subjects[j];

                // æå–æˆå¯¹æœ‰æ•ˆæ•°æ® (Pairwise Deletion)
                const pairsA = [];
                const pairsB = [];
                
                activeData.forEach(s => {
                    const valA = s.scores[subA];
                    const valB = s.scores[subB];
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        pairsA.push(valA);
                        pairsB.push(valB);
                    }
                });

                const r = calculateCorrelation(pairsA, pairsB); // ä½¿ç”¨ç°æœ‰çš„è¾…åŠ©å‡½æ•°
                const rVal = parseFloat(r.toFixed(2));

                matrix[i][j] = rVal;
                matrix[j][i] = rVal; // å¯¹ç§°

                // æ”¶é›†ç½‘ç»œå›¾è¿çº¿ (åªä¿ç•™æ­£ç›¸å…³ä¸”æœ‰ä¸€å®šå¼ºåº¦çš„ï¼Œä¾‹å¦‚ > 0.3)
                if (rVal > 0.35) {
                    links.push({
                        source: subA,
                        target: subB,
                        value: rVal,
                        lineStyle: {
                            width: (rVal - 0.3) * 5, // åŠ¨æ€çº¿å®½
                            opacity: 0.6 + (rVal * 0.4)
                        }
                    });
                }

                // ç´¯åŠ æ ¸å¿ƒåº¦
                centrality[i].totalR += rVal;
                centrality[i].count++;
                centrality[j].totalR += rVal;
                centrality[j].count++;
            }
        }
    }

    // 3. è°ƒç”¨å„å­å›¾è¡¨æ¸²æŸ“å‡½æ•°
    // (1) çƒ­åŠ›å›¾ (å¤ç”¨é€»è¾‘ï¼Œä½†ç›´æ¥ä¼ çŸ©é˜µæ•°æ®ï¼Œé¿å…é‡å¤ç®—)
    renderCorrelationHeatmapV2('correlation-heatmap-chart', subjects, matrix);
    
    // (2) ç½‘ç»œå›¾
    renderCorrelationNetwork('correlation-network-chart', subjects, links);

    // (3) å½±å“åŠ›æ’è¡Œ
    renderSubjectCentrality('correlation-centrality-chart', centrality);
}

/**
 * [ä¼˜åŒ–ç‰ˆ] æ¸²æŸ“çƒ­åŠ›å›¾ (ç›´æ¥æ¥æ”¶çŸ©é˜µæ•°æ®)
 */
function renderCorrelationHeatmapV2(elementId, subjects, matrix) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // è½¬æ¢ä¸º ECharts æ ¼å¼ [x, y, value]
    const data = [];
    for (let i = 0; i < subjects.length; i++) {
        for (let j = 0; j < subjects.length; j++) {
            data.push([i, j, matrix[i][j]]);
        }
    }

    const option = {
        tooltip: {
            position: 'top',
            formatter: (p) => `${subjects[p.data[0]]} vs ${subjects[p.data[1]]}<br/>ç›¸å…³ç³»æ•°: <strong>${p.data[2]}</strong>`
        },
        grid: { height: '80%', top: '5%' },
        xAxis: { type: 'category', data: subjects, splitArea: { show: true }, axisLabel: { rotate: 30 } },
        yAxis: { type: 'category', data: subjects, splitArea: { show: true } },
        visualMap: {
            min: -0.2, max: 1,
            calculable: true,
            orient: 'horizontal',
            left: 'center', bottom: 0,
            inRange: { color: ['#f5f5f5', '#e0f3f8', '#4575b4'] } // æµ…ç° -> è“
        },
        series: [{
            name: 'ç›¸å…³ç³»æ•°',
            type: 'heatmap',
            data: data,
            label: { show: true, color: '#333' },
            itemStyle: {
                borderColor: '#fff',
                borderWidth: 1
            }
        }]
    };
    myChart.setOption(option);
}

/**
 * [æ–°å¢] æ¨¡å—ä¹ï¼šå­¦ç§‘å¼•åŠ›ç½‘ç»œå›¾
 */
function renderCorrelationNetwork(elementId, subjects, links) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // æ„å»ºèŠ‚ç‚¹
    const nodes = subjects.map((sub, idx) => ({
        name: sub,
        symbolSize: 30,
        itemStyle: {
            color: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4'][idx % 8]
        },
        label: { show: true, fontSize: 11 }
    }));

    const option = {
        tooltip: { formatter: '{b}' }, // ç®€åŒ–æç¤º
        series: [{
            type: 'graph',
            layout: 'force',
            data: nodes,
            links: links,
            roam: true,
            label: { position: 'right', formatter: '{b}' },
            force: {
                repulsion: 400, // æ–¥åŠ›
                edgeLength: [50, 200] // è¾¹çš„é•¿åº¦èŒƒå›´ï¼Œç›¸å…³æ€§å¼ºçš„ä¼šè¢«æ‹‰è¿‘
            },
            lineStyle: {
                color: 'source',
                curveness: 0.1
            },
            emphasis: {
                focus: 'adjacency',
                lineStyle: { width: 5 }
            }
        }]
    };
    myChart.setOption(option);
}

/**
 * [æ–°å¢] æ¨¡å—ä¹ï¼šå­¦ç§‘æ ¸å¿ƒå½±å“åŠ›æ’è¡Œ
 */
function renderSubjectCentrality(elementId, centralityData) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // è®¡ç®—å¹³å‡å€¼å¹¶æ’åº
    const data = centralityData.map(item => ({
        name: item.name,
        value: item.count > 0 ? parseFloat((item.totalR / item.count).toFixed(3)) : 0
    })).sort((a, b) => a.value - b.value); // å‡åºï¼Œå› ä¸ºæ¡å½¢å›¾ä»ä¸‹å¾€ä¸Šç”»

    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: '{b}<br/>å¹³å‡ç›¸å…³ç³»æ•°: {c}'
        },
        grid: { left: '3%', right: '4%', bottom: '3%', top: '5%', containLabel: true },
        xAxis: { type: 'value', name: 'å¹³å‡ç›¸å…³ç³»æ•°' },
        yAxis: { type: 'category', data: data.map(d => d.name) },
        series: [{
            type: 'bar',
            data: data.map(d => d.value),
            label: { show: true, position: 'right' },
            itemStyle: {
                color: (p) => {
                    // é¢œè‰²æ¸å˜ï¼šè¶Šæ ¸å¿ƒé¢œè‰²è¶Šæ·±
                    // ç®€å•å¤„ç†ï¼šå‰3åç”¨æ·±è‰²
                    const rank = data.length - 1 - p.dataIndex; // 0æ˜¯ç¬¬ä¸€å
                    if (rank < 3) return '#d35400'; // æ ¸å¿ƒç§‘ç›® (æ©™çº¢)
                    return '#87cefa'; // æ™®é€šç§‘ç›® (æ·¡è“)
                },
                borderRadius: [0, 4, 4, 0]
            },
            barWidth: '60%'
        }]
    };
    myChart.setOption(option);
}

/**
 * (ä¿®æ”¹å) 9.7. æ¨¡å—ä¸ƒï¼šå­¦ç”Ÿåç§‘è¯Šæ–­
 */
function renderWeakness(container, activeData, stats) {
    // 1. æ¸²æŸ“åŸºç¡€ HTML (  åŠ äº† ç­çº§ç­›é€‰ å’Œ æ‰“å°æŒ‰é’®)
    container.innerHTML = `
        <h2>æ¨¡å—åï¼šå­¦ç”Ÿåç§‘è¯Šæ–­ (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>
        <p style="margin-top: -20px; margin-bottom: 20px; color: var(--text-muted);">
            åˆ†æå­¦ç”Ÿçš„å­¦ç§‘å‡è¡¡åº¦ï¼Œå¿«é€Ÿå®šä½â€œé«˜åˆ†ä½èƒ½â€æˆ–â€œä¸¥é‡åç§‘â€çš„å­¦ç”Ÿã€‚
        </p>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <div class="controls-bar chart-controls">
                <h4 style="margin:0;">åç§‘ç¨‹åº¦å››è±¡é™å›¾</h4>
                <span style="font-size: 0.8em; color: var(--text-muted);">(å³ä¸Š: å°–å­ç”Ÿæœ‰çŸ­æ¿ | å³ä¸‹: å­¦éœ¸å…¨èƒ½ | å·¦ä¸Š: åŸºç¡€å·®ä¸”åç§‘ | å·¦ä¸‹: åŸºç¡€å·®ä½†å‡è¡¡)</span>
            </div>
            <div class="chart-container" id="weakness-scatter-chart" style="width: 100%; height: 500px;"></div>
        </div>

        <div class="main-card-wrapper">
            <div class="controls-bar chart-controls" style="justify-content: space-between;">
                <h4 style="margin:0;">å­¦ç”Ÿåç§‘è¯Šæ–­æ€»è¡¨</h4>
                <span style="font-size: 0.8em; color: var(--text-muted);">(æŒ‰â€œæœ€å¼±é¡¹åç¦»åº¦â€æ’åº)</span>
            </div>

            <div class="controls-bar" style="background: transparent; box-shadow: none; padding: 0 0 15px 0; flex-wrap: wrap; gap: 10px;">
                
                <label for="weakness-class-filter">ç­çº§:</label>
                <select id="weakness-class-filter" class="sidebar-select" style="min-width: 120px;">
                    <option value="ALL">-- å…¨éƒ¨ --</option>
                    </select>

                <label for="weakness-search" style="margin-left: 10px;">æœç´¢:</label>
                <input type="text" id="weakness-search" placeholder="è¾“å…¥å§“åæˆ–è€ƒå·..." style="width: 150px;">

                <button id="weakness-print-btn" class="sidebar-button" style="background-color: var(--color-blue); margin-left: auto;">
                    ğŸ–¨ï¸ æ‰“å°è¡¨æ ¼
                </button>
            </div>

            <div class="table-container" id="weakness-table-container"></div>

            <div id="weakness-detail-container" style="margin-top: 20px; display: none;"></div>
        </div>
    `;

    // 2. (æ ¸å¿ƒ) è®¡ç®—åç§‘æ•°æ®
    const weaknessData = calculateWeaknessData(activeData, stats);

    // 3. æ¸²æŸ“å›¾è¡¨
    renderWeaknessScatter('weakness-scatter-chart', weaknessData, stats);

    // 4. æ¸²æŸ“è¡¨æ ¼ (åŒ…å«å¡«å……ä¸‹æ‹‰æ¡†é€»è¾‘)
    renderWeaknessTable('weakness-table-container', weaknessData);

    // 5. ç»‘å®šä¸»è¡¨ç‚¹å‡»äº‹ä»¶ (è¯¦æƒ…å¼¹çª—)
    const tableContainer = document.getElementById('weakness-table-container');
    const detailContainer = document.getElementById('weakness-detail-container');

    tableContainer.addEventListener('click', (e) => {
        const row = e.target.closest('tr[data-id]');
        if (!row) return;

        const studentId = row.dataset.id;
        const studentData = weaknessData.find(d => String(d.student.id) === String(studentId));

        if (studentData) {
            renderWeaknessDetail(detailContainer, studentData);
            detailContainer.style.display = 'block';
            // æ»šåŠ¨åˆ°è¯¦æƒ…å¤„
            detailContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
}

/**
 * (    ) 9.8. æ¨¡å—å…«ï¼šä¸´ç•Œç”Ÿåˆ†æ
 * @param {Object} container - HTML å®¹å™¨
 * @param {Array} activeData - å½“å‰å·²ç­›é€‰çš„å­¦ç”Ÿæ•°æ®
 */
function renderBoundary(container, activeData, stats) {

    // 1. æ¸²æŸ“HTML
    container.innerHTML = `
        <h2>æ¨¡å—äº”ï¼šä¸´ç•Œç”Ÿåˆ†æ (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>
        <p style="margin-top: -20px; margin-bottom: 20px; color: var(--text-muted);">
            å¿«é€Ÿå®šä½â€œå·®ä¸€ç‚¹â€å°±èƒ½ä¸Šä¸€ä¸ªå°é˜¶çš„å­¦ç”Ÿã€‚(å•å‡»å­¦ç”Ÿå§“åå¯ä»¥å¿«é€ŸæŸ¥çœ‹å­¦ç”Ÿå„ç§‘åˆ†æ•°ï¼)
        </p>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <h4>è‡ªå®šä¹‰ä¸´ç•Œçº¿ç­›é€‰</h4>
            <div class="controls-bar" style="background: transparent; box-shadow: none; padding: 0; flex-wrap: wrap;">
                <label>ç§‘ç›®:</label>
                <select id="boundary-subject" class="sidebar-select">
                    <option value="totalScore">æ€»åˆ†</option>
                    ${G_DynamicSubjectList.map(s => `<option value="${s}">${s}</option>`).join('')}
                </select>
                <label>åˆ†æ•°çº¿:</label>
                <select id="boundary-line-type" class="sidebar-select">
                    <option value="excel">ä¼˜ç§€çº¿</option>
                    <option value="good">è‰¯å¥½çº¿</option>
                    <option value="pass">åŠæ ¼çº¿</option>
                    <option value="average">å¹³å‡åˆ†</option>
                </select>
                <label>èŒƒå›´ (Â±):</label>
                <input type="number" id="boundary-range" value="5" style="width: 60px;">
                <button id="boundary-filter-btn" class="sidebar-button">ç­›é€‰</button>
            </div>
        </div>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <h4>å¿«æ·é¢„è®¾ç­›é€‰</h4>
            <div class="shortcut-btn-group" style="border-top: none; padding-top: 0;">
                <button class="shortcut-btn" data-preset="high_potential">é«˜åˆ†çŸ­æ¿ç”Ÿ (æ€»åˆ†ä¼˜ç§€, 1ç§‘ä¸åŠæ ¼)</button>
                <button class="shortcut-btn" data-preset="pass_potential">åŠæ ¼çŸ­æ¿ç”Ÿ (æ€»åˆ†åŠæ ¼, 1ç§‘ä¸åŠæ ¼)</button>
                <button class="shortcut-btn" data-preset="holistic_pass">å…¨ç§‘åŠæ ¼ç”Ÿ</button>
                <button class="shortcut-btn" data-preset="holistic_excel">å…¨ç§‘ä¼˜ç§€ç”Ÿ</button>
                <button class="shortcut-btn" data-preset="multi_fail">å¤šç§‘ä¸åŠæ ¼ç”Ÿ (>=3ç§‘)</button>
            </div>
        </div>

        <div id="boundary-charts-area" style="display: none;">
            <div class="dashboard-chart-grid-2x2" style="margin-bottom: 20px;">
                <div class="main-card-wrapper">
                    <h4 style="margin:0;">ğŸ“‰ ä¸´ç•Œç”Ÿâ€œçŸ­æ¿ç§‘ç›®â€é¢‘æ¬¡ç»Ÿè®¡</h4>
                    <p style="font-size:0.8em; color:#999; margin:5px 0;">* ç»Ÿè®¡è¿™æ‰¹å­¦ç”Ÿåœ¨å„ç§‘æœªè¾¾æ ‡ï¼ˆå¦‚ä¸åŠæ ¼ï¼‰çš„äººæ¬¡ï¼ŒæŸ±å­è¶Šé«˜ä»£è¡¨è¯¥ç§‘ç›®æ˜¯ç¾¤ä½“çš„å…±åŒçŸ­æ¿ã€‚</p>
                    <div class="chart-container" id="boundary-bottleneck-chart" style="height: 350px;"></div>
                </div>
                <div class="main-card-wrapper">
                    <h4 style="margin:0;">ğŸ¯ ä¸´ç•Œåˆ†å·®æ•£ç‚¹å›¾ (è·ç¦»ç›®æ ‡çº¿)</h4>
                    <p style="font-size:0.8em; color:#999; margin:5px 0;">* Yè½´=0ä¸ºç›®æ ‡çº¿ã€‚ç‚¹åœ¨çº¢åŒºè¡¨ç¤ºæœªè¾¾æ ‡ï¼Œç»¿åŒºè¡¨ç¤ºå·²è¾¾æ ‡ã€‚è¶Šé è¿‘0è½´æå‡æ€§ä»·æ¯”è¶Šé«˜ã€‚</p>
                    <div class="chart-container" id="boundary-gap-chart" style="height: 350px;"></div>
                </div>
            </div>
        </div>

        <div class="main-card-wrapper" id="boundary-results-wrapper" style="display: none;">
                <h4 id="boundary-results-title">ç­›é€‰ç»“æœ</h4>
                <div class="table-container" id="boundary-results-table"></div>

                <div id="boundary-detail-container" style="margin-top: 20px; display: none; border-top: 1px solid var(--border-color); padding-top: 20px;">
                    </div>
            </div>
        `;



    // 2. ç»‘å®šäº‹ä»¶
    const subjectSelect = document.getElementById('boundary-subject');
    const lineTypeSelect = document.getElementById('boundary-line-type');
    const rangeInput = document.getElementById('boundary-range');
    const filterBtn = document.getElementById('boundary-filter-btn');
    const presetBtns = document.querySelectorAll('.shortcut-btn[data-preset]');

    const resultsWrapper = document.getElementById('boundary-results-wrapper');
    const resultsTitle = document.getElementById('boundary-results-title');
    const resultsTable = document.getElementById('boundary-results-table');

    // (è¾…åŠ©å‡½æ•°) æ¸²æŸ“è¡¨æ ¼
    const renderResultTable = (title, students, targetSubject, lineTypeLabel) => { // ğŸ‘ˆ æ³¨æ„ï¼šè¿™é‡Œå¤šä¼ ä¸€ä¸ª lineTypeLabel å‚æ•°ï¼Œæ–¹ä¾¿å›¾è¡¨æ ‡é¢˜ä½¿ç”¨
        resultsTitle.innerText = title;
        resultsWrapper.style.display = 'block';
        
        // ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºå¹¶æ¸²æŸ“å›¾è¡¨åŒºåŸŸ
        document.getElementById('boundary-charts-area').style.display = 'block';
        
        // ç¨ä½œå»¶æ—¶ç¡®ä¿å®¹å™¨å¯è§
        setTimeout(() => {
            // 1. æ¸²æŸ“çŸ­æ¿å½’å› å›¾
            renderBoundaryBottleneckChart('boundary-bottleneck-chart', students);
            // 2. æ¸²æŸ“åˆ†å·®æ•£ç‚¹å›¾ (éœ€è¦çŸ¥é“å½“å‰å¯¹æ¯”çš„æ˜¯ä»€ä¹ˆçº¿ï¼Œä¾‹å¦‚"åŠæ ¼çº¿")
            renderBoundaryGapChart('boundary-gap-chart', students, lineTypeLabel || 'åŠæ ¼çº¿'); 
        }, 100);

        if (!students || students.length === 0) {
            resultsTable.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding: 20px;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿã€‚</p>`;
            // å¦‚æœæ²¡äººï¼Œæ¸…ç©ºå›¾è¡¨
            const chart1 = echarts.getInstanceByDom(document.getElementById('boundary-bottleneck-chart'));
            if(chart1) chart1.clear();
            const chart2 = echarts.getInstanceByDom(document.getElementById('boundary-gap-chart'));
            if(chart2) chart2.clear();
            return;
        }

        //      ä»…å½“ targetSubject ä¸æ˜¯ 'totalScore' æ—¶æ‰æ·»åŠ é¢å¤–åˆ—
        const isSubject = targetSubject && targetSubject !== 'totalScore';

        let targetHeaderTitle = isSubject ? `<th>${targetSubject} åˆ†æ•°</th>` : '';

        resultsTable.innerHTML = `
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>ç­çº§</th>
                        <th>æ€»åˆ†</th>
                        <th>ç­æ’</th>
                        ${targetHeaderTitle}
                    </tr>
                </thead>
                <tbody>
                    ${students.map(s => `
                    <tr data-id="${s.id}"> <td data-action="show-detail" style="cursor: pointer; color: var(--primary-color); font-weight: 600;">
                                ${s.name}
                            </td>
                        <td>${s.class}</td>
                        <td>${s.totalScore}</td>
                        <td>${s.rank}</td>
                        ${isSubject ? `<td><strong>${s.scores[targetSubject] || 'N/A'}</strong></td>` : ''}
                    </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    };

    // 3. äº‹ä»¶ï¼šè‡ªå®šä¹‰ç­›é€‰
    filterBtn.addEventListener('click', () => {
        const subject = subjectSelect.value;
        const lineType = lineTypeSelect.value;
        const range = parseFloat(rangeInput.value) || 0;

        let threshold = 0;
        //    (é‡æ„)
        if (lineType === 'average') {
            // (å¹³å‡åˆ†é€»è¾‘: ä» stats ä¸­è¯»å–)
            if (subject === 'totalScore') {
                threshold = stats.totalScore ? stats.totalScore.average : 0;
            } else {
                threshold = stats[subject] ? stats[subject].average : 0;
            }
        } else {
            // (åŸæœ‰é€»è¾‘: ä» G_SubjectConfigs ä¸­ç´¯åŠ )
            if (subject === 'totalScore') {
                threshold = G_DynamicSubjectList.reduce((sum, key) => sum + (G_SubjectConfigs[key] ? G_SubjectConfigs[key][lineType] : 0), 0);
            } else {
                threshold = G_SubjectConfigs[subject] ? G_SubjectConfigs[subject][lineType] : 0;
            }
        }

        const min = threshold - range;
        const max = threshold + range;

        const filteredStudents = activeData.filter(s => {
            const score = (subject === 'totalScore') ? s.totalScore : s.scores[subject];
            return score >= min && score <= max;
        });

        const lineLabel = lineTypeSelect.options[lineTypeSelect.selectedIndex].text; 

        renderResultTable(
            `â€œ${subject}â€ åœ¨ â€œ${lineLabel}â€ ( ${threshold.toFixed(0)}åˆ† ) Â± ${range}åˆ† çš„å­¦ç”Ÿ (${filteredStudents.length}äºº)`, 
            filteredStudents, 
            subject,
            lineLabel // ğŸ‘ˆ ä¼ å…¥æ–°å‚æ•°
        );
        //renderResultTable(`â€œ${subject}â€ åœ¨ â€œ${lineTypeSelect.options[lineTypeSelect.selectedIndex].text}â€ ( ${threshold.toFixed(0)}åˆ† ) Â± ${range}åˆ† çš„å­¦ç”Ÿ (${filteredStudents.length}äºº)`, filteredStudents, subject);
    });

    // (è¾…åŠ©å‡½æ•°) è·å–æ€»åˆ†çº¿
    const getTotalLine = (lineType) => {
        return G_DynamicSubjectList.reduce((sum, key) => sum + (G_SubjectConfigs[key] ? G_SubjectConfigs[key][lineType] : 0), 0);
    };

    // 4. äº‹ä»¶ï¼šé¢„è®¾ç­›é€‰
    presetBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const preset = btn.dataset.preset;
            let title = '';
            let filteredStudents = [];

            const totalPassLine = getTotalLine('pass');
            const totalExcelLine = getTotalLine('excel');

            if (preset === 'holistic_pass') {
                title = 'å…¨ç§‘åŠæ ¼ç”Ÿ';
                filteredStudents = activeData.filter(s => {
                    return G_DynamicSubjectList.every(subject => {
                        const passLine = G_SubjectConfigs[subject] ? G_SubjectConfigs[subject].pass : 0;
                        return (s.scores[subject] || 0) >= passLine;
                    });
                });
            } else if (preset === 'pass_potential' || preset === 'high_potential') {
                const minTotal = (preset === 'pass_potential') ? totalPassLine : totalExcelLine;
                title = (preset === 'pass_potential') ? 'åŠæ ¼çŸ­æ¿ç”Ÿ (æ€»åˆ†åŠæ ¼, 1ç§‘ä¸åŠæ ¼)' : 'é«˜åˆ†çŸ­æ¿ç”Ÿ (æ€»åˆ†ä¼˜ç§€, 1ç§‘ä¸åŠæ ¼)';

                filteredStudents = activeData.filter(s => {
                    if (s.totalScore < minTotal) return false;

                    let failCount = 0;
                    G_DynamicSubjectList.forEach(subject => {
                        const passLine = G_SubjectConfigs[subject] ? G_SubjectConfigs[subject].pass : 0;
                        if ((s.scores[subject] || 0) < passLine) {
                            failCount++;
                        }
                    });
                    return failCount === 1; //    ä¸¥æ ¼é™åˆ¶ä¸ºåªæœ‰1ç§‘ä¸åŠæ ¼
                });
            } else if (preset === 'holistic_excel') {
                title = 'å…¨ç§‘ä¼˜ç§€ç”Ÿ';
                filteredStudents = activeData.filter(s => {
                    return G_DynamicSubjectList.every(subject => {
                        const excelLine = G_SubjectConfigs[subject] ? G_SubjectConfigs[subject].excel : 0;
                        return (s.scores[subject] || 0) >= excelLine;
                    });
                });

                //    (    )
            } else if (preset === 'multi_fail') {
                title = 'å¤šç§‘ä¸åŠæ ¼ç”Ÿ (>=3ç§‘)';
                filteredStudents = activeData.filter(s => {
                    let failCount = 0;
                    G_DynamicSubjectList.forEach(subject => {
                        const passLine = G_SubjectConfigs[subject] ? G_SubjectConfigs[subject].pass : 0;
                        if ((s.scores[subject] === null || s.scores[subject] === undefined) || s.scores[subject] < passLine) {
                            failCount++;
                        }
                    });
                    return failCount >= 3;
                });
            }
            let lineLabel = 'åŠæ ¼çº¿'; 
            if (preset.includes('high') || preset.includes('excel')) {
                lineLabel = 'ä¼˜ç§€çº¿'; // é«˜åˆ†ç›¸å…³çš„é¢„è®¾ï¼Œå¯¹æ¯”çš„æ˜¯ä¼˜ç§€çº¿
            }

            // âœ… [ä¿®æ”¹] ä¼ å…¥ lineLabel
            renderResultTable(`${title} (${filteredStudents.length}äºº)`, filteredStudents, null, lineLabel);
            
            //renderResultTable(`${title} (${filteredStudents.length}äºº)`, filteredStudents, null);
        });
    });
    //    (    ) ä¸ºç»“æœè¡¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
    const detailContainer = document.getElementById('boundary-detail-container');

    resultsTable.addEventListener('click', (e) => {
        // (å¯»æ‰¾è¢«ç‚¹å‡»çš„ <td> å•å…ƒæ ¼)
        const cell = e.target.closest('td[data-action="show-detail"]');
        // (å¯»æ‰¾è¢«ç‚¹å‡»çš„ <tr> è¡Œ)
        const row = e.target.closest('tr[data-id]');

        if (!cell || !row) return; // å¿…é¡»ç‚¹å‡»åœ¨æŒ‡å®šå•å…ƒæ ¼ä¸Š

        const studentId = row.dataset.id;
        const student = activeData.find(s => String(s.id) === String(studentId));

        if (student) {
            // (è°ƒç”¨  å‡½æ•°æ¸²æŸ“è¯¦æƒ…)
            renderBoundaryStudentDetail(detailContainer, student);
            detailContainer.style.display = 'block';
        }
    });
}


/**
 * [å‡çº§ç‰ˆ] æ¨¡å—äº”ï¼šä¸´ç•Œç”Ÿ - çŸ­æ¿ç§‘ç›®é¢‘æ¬¡å›¾
 */
function renderBoundaryBottleneckChart(elementId, students) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // 1. å‡†å¤‡æ•°æ®å®¹å™¨ï¼š{ 'è¯­æ–‡': {count: 0, students: []}, ... }
    const bottleneckMap = {};
    G_DynamicSubjectList.forEach(sub => {
        bottleneckMap[sub] = { count: 0, students: [] };
    });

    // 2. éå†ç»Ÿè®¡
    students.forEach(s => {
        G_DynamicSubjectList.forEach(sub => {
            const score = s.scores[sub];
            const config = G_SubjectConfigs[sub] || { pass: 60 };
            
            // å¦‚æœåˆ†æ•° < åŠæ ¼çº¿ (pass) æˆ–è€…ç¼ºè€ƒï¼Œè§†ä¸ºè¯¥ç§‘æ˜¯çŸ­æ¿
            if (typeof score !== 'number' || score < config.pass) {
                bottleneckMap[sub].count++;
                bottleneckMap[sub].students.push(s);
            }
        });
    });

    const xData = Object.keys(bottleneckMap);
    // æ„å»º ECharts éœ€è¦çš„æ•°æ®å¯¹è±¡æ•°ç»„
    const seriesData = xData.map(sub => ({
        name: sub,
        value: bottleneckMap[sub].count,
        studentList: bottleneckMap[sub].students // è—å…¥åå•
    }));

    const option = {
        tooltip: { 
            trigger: 'item', 
            formatter: (params) => {
                return `${params.marker} <strong>${params.name}</strong><br/>` +
                       `æœªè¾¾æ ‡äººæ•°ï¼š${params.value} äºº<br/>` +
                       `<span style="font-size:0.8em;color:#aaa;">(ç‚¹å‡»æŸ¥çœ‹åå•)</span>`;
            }
        },
        grid: { left: '3%', right: '4%', bottom: '10%', top: '10%', containLabel: true },
        xAxis: { 
            type: 'category', 
            data: xData, 
            axisLabel: { rotate: 30, interval: 0 } 
        },
        yAxis: { type: 'value', name: 'æœªè¾¾æ ‡äººæ•°' },
        series: [{
            name: 'æœªè¾¾æ ‡äººæ•°',
            type: 'bar',
            data: seriesData, // ä¼ å…¥åŒ…å« studentList çš„å¯¹è±¡
            itemStyle: {
                // æ¸å˜çº¢è‰²ï¼Œå¼ºè°ƒâ€œçŸ­æ¿â€
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#ff7675' },
                    { offset: 1, color: '#d63031' }
                ])
            },
            label: { show: true, position: 'top' },
            cursor: 'pointer' // é¼ æ ‡å˜æ‰‹å‹
        }]
    };
    myChart.setOption(option);

    // 3. ç»‘å®šç‚¹å‡»äº‹ä»¶
    myChart.off('click');
    myChart.on('click', function(params) {
        const targetStudents = params.data.studentList;
        const subjectName = params.name;

        if (targetStudents && targetStudents.length > 0) {
            // è°ƒç”¨é€šç”¨å¼¹çª—
            // è¿™é‡Œçš„ title åŠ¨æ€è·å–å½“å‰ç­›é€‰çš„èŒƒå›´å¯èƒ½æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬ç”¨é€šç”¨çš„æè¿°
            showDrillDownModal(
                `ã€${subjectName}ã€‘æœªè¾¾æ ‡ä¸´ç•Œç”Ÿåå•`, 
                targetStudents, 
                subjectName // ä¼ å…¥ç§‘ç›®ï¼Œè¡¨æ ¼é‡Œä¼šæ˜¾ç¤ºè¯¥ç§‘å…·ä½“åˆ†æ•°
            );
        }
    });
}


/**
 * [æ–°å¢] æ¨¡å—äº”ï¼šä¸´ç•Œç”Ÿ - åˆ†å·®æ•£ç‚¹å›¾
 * å±•ç¤ºæ¯ä¸ªå­¦ç”Ÿå„ç§‘è·ç¦»ç›®æ ‡çº¿ï¼ˆå¦‚åŠæ ¼çº¿ï¼‰çš„åˆ†å·®
 */
function renderBoundaryGapChart(elementId, students, lineTypeLabel) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // å‡†å¤‡æ•°æ®ï¼š[ç§‘ç›®ç´¢å¼•, åˆ†å·®, å­¦ç”Ÿå§“å, ç§‘ç›®å, å®é™…åˆ†]
    const scatterData = [];
    // ç¡®å®šå¯¹æ¯”å“ªæ¡çº¿ï¼ˆç®€å•èµ·è§ï¼Œè¿™é‡Œç»Ÿä¸€å¯¹æ¯”â€œåŠæ ¼çº¿â€æˆ–è€…æ ¹æ®ä¼ å…¥çš„ label æ¨¡ç³ŠåŒ¹é…é…ç½®ï¼‰
    // å¦‚æœ lineTypeLabel æ˜¯ "ä¼˜ç§€çº¿"ï¼Œåˆ™å¯¹æ¯” excelï¼Œå¦åˆ™å¯¹æ¯” pass
    const configKey = lineTypeLabel.includes('ä¼˜ç§€') ? 'excel' : 'pass';

    G_DynamicSubjectList.forEach((sub, idx) => {
        const config = G_SubjectConfigs[sub] || {};
        const targetLine = config[configKey] || 60;

        students.forEach(s => {
            const score = s.scores[sub];
            if (typeof score === 'number') {
                const diff = parseFloat((score - targetLine).toFixed(1));
                // ä¸ºäº†å›¾è¡¨ç¾è§‚ï¼Œåªå±•ç¤ºåœ¨ç›®æ ‡çº¿é™„è¿‘ +/- 20åˆ†çš„æ•°æ®ï¼Œ
                // æˆ–è€…å±•ç¤ºå…¨éƒ¨ä½†é‡ç‚¹çœ‹ 0 é™„è¿‘çš„ã€‚è¿™é‡Œå±•ç¤ºå…¨éƒ¨ã€‚
                scatterData.push([idx, diff, s.name, sub, score, targetLine]);
            }
        });
    });

    // Xè½´æ ‡ç­¾
    const categories = G_DynamicSubjectList;

    const option = {
        tooltip: {
            formatter: (p) => {
                const data = p.data; // [idx, diff, name, sub, score, target]
                const diffStr = data[1] >= 0 ? `+${data[1]}` : `${data[1]}`;
                const color = data[1] >= 0 ? 'green' : 'red';
                return `<strong>${data[2]}</strong> - ${data[3]}<br/>` +
                       `å®é™…åˆ†: ${data[4]} (çº¿: ${data[5]})<br/>` +
                       `åˆ†å·®: <span style="color:${color}; font-weight:bold;">${diffStr}</span>`;
            }
        },
        grid: { left: '3%', right: '4%', bottom: '10%', top: '10%', containLabel: true },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: { rotate: 30, interval: 0 },
            splitLine: { show: true, lineStyle: { type: 'dashed' } }
        },
        yAxis: {
            type: 'value',
            name: `è·ç¦»${lineTypeLabel}åˆ†å·®`,
            axisLabel: { formatter: '{value} åˆ†' }
        },
        series: [{
            type: 'scatter',
            data: scatterData,
            symbolSize: 10,
            itemStyle: {
                color: (p) => {
                    // å¤§äºç­‰äº0 ç»¿è‰²ï¼Œå°äº0 çº¢è‰²
                    return p.data[1] >= 0 ? '#28a745' : '#dc3545';
                },
                opacity: 0.6
            },
            markLine: {
                silent: true,
                symbol: 'none',
                data: [{ yAxis: 0 }],
                lineStyle: { color: '#333', width: 2 },
                label: { formatter: 'ç›®æ ‡çº¿', position: 'end' }
            },
            markArea: {
                silent: true,
                itemStyle: { opacity: 0.1 },
                data: [
                    // 0è½´ä»¥ä¸‹æ ‡çº¢èƒŒæ™¯
                    [{ yAxis: -999, itemStyle: { color: '#ffebee' } }, { yAxis: 0 }],
                    // 0è½´ä»¥ä¸Šæ ‡ç»¿èƒŒæ™¯
                    [{ yAxis: 0, itemStyle: { color: '#e8f5e9' } }, { yAxis: 999 }]
                ]
            }
        }]
    };
    myChart.setOption(option);
}



/**
 * (    ) 9.9. æ¨¡å—ä¹ï¼šå…¨ç§‘å‡è¡¡åˆ†æ
 * @param {Object} container - HTML å®¹å™¨
 * @param {Array} activeData - å½“å‰å·²ç­›é€‰çš„å­¦ç”Ÿæ•°æ®
 * @param {Object} stats - G_Statistics
 */
function renderHolisticBalance(container, activeData, stats) {

// 1. æ¸²æŸ“HTML
    container.innerHTML = `
        <h2>æ¨¡å—å…­ï¼šå…¨ç§‘å‡è¡¡åˆ†æ (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>
        <p style="margin-top: -20px; margin-bottom: 20px; color: var(--text-muted);">
            åˆ†æå­¦ç”Ÿç¾¤ä½“çš„â€œçŸ­æ¿â€æ•°é‡åŠå­¦ç§‘å‡è¡¡åº¦ã€‚
        </p>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <h4 style="margin:0;">ğŸ“‰ ä¸åŠæ ¼ç§‘ç›®æ•°é‡åˆ†å¸ƒ</h4>
            <p style="font-size:0.8em; color:#999; margin:5px 0;">* ç‚¹å‡»æŸ±å­å¯æŸ¥çœ‹å…·ä½“å­¦ç”Ÿåå•ã€‚</p>
            <div class="chart-container" id="holistic-failure-count-chart" style="height: 400px;"></div>
        </div>

        <div class="dashboard-chart-grid-2x2" style="margin-bottom: 20px;">
            <div class="main-card-wrapper">
                <h4 style="margin:0;">ğŸªµ â€œæœ€çŸ­æ¿â€ç§‘ç›®å½’å› åˆ†å¸ƒ</h4>
                <p style="font-size:0.8em; color:#999; margin:5px 0;">* ç»Ÿè®¡æœ‰å¤šå°‘å­¦ç”Ÿçš„â€œå…¨ç§‘æœ€å·®ä¸€é—¨â€æ˜¯è¯¥ç§‘ç›® (åŸºäºå¾—åˆ†ç‡)ã€‚</p>
                <div class="chart-container" id="holistic-shortest-plank-chart" style="height: 350px;"></div>
            </div>
            <div class="main-card-wrapper">
                <h4 style="margin:0;">âš–ï¸ ç»¼åˆå®åŠ› vs å‡è¡¡åº¦ çŸ©é˜µ</h4>
                <p style="font-size:0.8em; color:#999; margin:5px 0;">* Yè½´è¶Šä½è¶Šå‡è¡¡ã€‚å³ä¸‹è§’ä¸ºâ€œå…­è¾¹å½¢æˆ˜å£«â€ï¼Œå³ä¸Šè§’ä¸ºâ€œè·›è„šå­¦éœ¸â€ã€‚</p>
                <div class="chart-container" id="holistic-scatter-chart" style="height: 350px;"></div>
            </div>
        </div>

        <div class="main-card-wrapper" id="holistic-results-wrapper" style="display: none;">
            <h4 id="holistic-results-title">å­¦ç”Ÿåˆ—è¡¨</h4>
            <div class="table-container" id="holistic-results-table"></div>
        </div>
    `;

    // 2. (æ ¸å¿ƒ)      è®¡ç®—ä¸åŠæ ¼ç§‘ç›®æ•°, å¹¶å­˜å‚¨å­¦ç”Ÿå¯¹è±¡
    const failureData = {}; // { 0: [student1, student2], 1: [student3], ... }

    activeData.forEach(student => {
        let count = 0;
        G_DynamicSubjectList.forEach(subject => {
            const passLine = G_SubjectConfigs[subject] ? G_SubjectConfigs[subject].pass : 0;
            if ((student.scores[subject] === null || student.scores[subject] === undefined) || student.scores[subject] < passLine) {
                count++; // (ç¼ºè€ƒä¹Ÿç®—ä¸åŠæ ¼)
            }
        });

        if (!failureData[count]) {
            failureData[count] = [];
        }
        failureData[count].push(student); //      å­˜å…¥å­¦ç”Ÿå¯¹è±¡
    });

    // 3.      æ¸²æŸ“å›¾è¡¨, å¹¶è·å– ECharts å®ä¾‹
    const chartInstance = renderFailureCountChart('holistic-failure-count-chart', failureData);

    // 4.    (    ) ç»‘å®šå›¾è¡¨ç‚¹å‡»äº‹ä»¶
    const resultsWrapper = document.getElementById('holistic-results-wrapper');
    const resultsTitle = document.getElementById('holistic-results-title');
    const resultsTable = document.getElementById('holistic-results-table');

    if (chartInstance) {
        chartInstance.on('click', (params) => {
            const failCountText = params.name; // '0 ç§‘', '1 ç§‘', ...
            const countKey = failCountText.split(' ')[0]; // '0', '1', ...
            const students = failureData[countKey];

            if (!students || students.length === 0) return;

            resultsWrapper.style.display = 'block';
            resultsTitle.innerText = `ä¸åŠæ ¼ ${failCountText} çš„å­¦ç”Ÿ (${students.length}äºº)`;

            // (æ¸²æŸ“å­¦ç”Ÿåˆ—è¡¨)
            resultsTable.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>å§“å</th>
                                <th>ç­çº§</th>
                                <th>æ€»åˆ†</th>
                                <th>ç­æ’</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map(s => `
                            <tr>
                                <td>${s.name}</td>
                                <td>${s.class}</td>
                                <td>${s.totalScore}</td>
                                <td>${s.rank}</td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        });
    }
    setTimeout(() => {
        renderHolisticShortestPlankChart('holistic-shortest-plank-chart', activeData);
        renderHolisticScatterChart('holistic-scatter-chart', activeData, stats);
    }, 100);
}


/**
 * [æ–°å¢] æ¨¡å—å…­ï¼šæœ€çŸ­æ¿ç§‘ç›®å½’å› å›¾ (äº¤äº’å‡çº§ç‰ˆ)
 */
function renderHolisticShortestPlankChart(elementId, students) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // 1. å‡†å¤‡æ•°æ®å®¹å™¨ï¼š{ 'è¯­æ–‡': {count:0, students:[]}, ... }
    const plankMap = {};
    G_DynamicSubjectList.forEach(sub => {
        plankMap[sub] = { count: 0, students: [] };
    });

    // 2. éå†å­¦ç”Ÿï¼Œæ‰¾å‡ºæ¯ä¸ªäººçš„â€œæœ€çŸ­æ¿â€
    students.forEach(s => {
        let minRate = 2.0; // å¾—åˆ†ç‡ä¸å¯èƒ½è¶…è¿‡ 1.0
        let worstSub = null;

        G_DynamicSubjectList.forEach(sub => {
            const score = s.scores[sub];
            const config = G_SubjectConfigs[sub];
            const full = config ? config.full : 100;
            
            if (typeof score === 'number' && full > 0) {
                const rate = score / full;
                if (rate < minRate) {
                    minRate = rate;
                    worstSub = sub;
                }
            }
        });

        // å½’ç±»
        if (worstSub && plankMap[worstSub]) {
            plankMap[worstSub].count++;
            plankMap[worstSub].students.push(s);
        }
    });

    // 3. è½¬æ¢ä¸ºå›¾è¡¨æ•°æ®å¹¶æ’åº (é™åº)
    const data = Object.keys(plankMap)
        .map(sub => ({ 
            name: sub, 
            value: plankMap[sub].count,
            studentList: plankMap[sub].students // å°†åå•è—åœ¨æ•°æ®é¡¹é‡Œ
        }))
        .sort((a, b) => b.value - a.value);

    // 4. é…ç½®é¡¹
    const option = {
        tooltip: { 
            trigger: 'item', 
            formatter: (params) => {
                return `${params.marker} <strong>${params.name}</strong><br/>` +
                       `äººæ•°ï¼š${params.value} äºº<br/>` +
                       `<span style="font-size:0.8em;color:#aaa;">(ç‚¹å‡»æŸ¥çœ‹åå•)</span>`;
            }
        },
        grid: { left: '3%', right: '4%', bottom: '10%', top: '10%', containLabel: true },
        xAxis: { 
            type: 'category', 
            data: data.map(d => d.name),
            axisLabel: { rotate: 30, interval: 0 }
        },
        yAxis: { type: 'value', name: 'äººæ•°' },
        series: [{
            name: 'çŸ­æ¿äººæ•°',
            type: 'bar',
            data: data, // è¿™é‡Œä¼ å…¥åŒ…å« studentList çš„å¯¹è±¡æ•°ç»„ï¼ŒECharts ä¼šè‡ªåŠ¨å– value ç»˜å›¾
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#ff9f43' },
                    { offset: 1, color: '#ee5253' }
                ]),
                borderRadius: [4, 4, 0, 0]
            },
            label: { show: true, position: 'top' },
            cursor: 'pointer' // é¼ æ ‡å˜æ‰‹å‹
        }]
    };
    myChart.setOption(option);

    // 5. ç»‘å®šç‚¹å‡»äº‹ä»¶ (è°ƒç”¨é€šç”¨å¼¹çª—)
    myChart.off('click'); // é˜²æ­¢é‡å¤ç»‘å®š
    myChart.on('click', function(params) {
        // ä» data ä¸­å–å‡ºè—å¥½çš„ studentList
        const targetStudents = params.data.studentList;
        const subjectName = params.name;

        if (targetStudents && targetStudents.length > 0) {
            // è°ƒç”¨ç³»ç»Ÿç°æœ‰çš„ä¸‹é’»å¼¹çª—å‡½æ•°
            // æ ‡é¢˜ï¼šä»¥â€œè¯­æ–‡â€ä¸ºçŸ­æ¿çš„å­¦ç”Ÿåå•
            showDrillDownModal(
                `ä»¥â€œ${subjectName}â€ä¸ºæœ€çŸ­æ¿çš„å­¦ç”Ÿåå•`, 
                targetStudents, 
                subjectName // ä¼ å…¥ç§‘ç›®ï¼Œä»¥ä¾¿å¼¹çª—è¡¨æ ¼æ˜¾ç¤ºè¯¥ç§‘åˆ†æ•°
            );
        }
    });
}

/**
 * [æ–°å¢] æ¨¡å—å…­ï¼šç»¼åˆå®åŠ› vs å‡è¡¡åº¦ æ•£ç‚¹å›¾
 * Xè½´: æ€»åˆ†, Yè½´: åç§‘ç³»æ•° (å„ç§‘å¾—åˆ†ç‡çš„æ ‡å‡†å·®)
 */
function renderHolisticScatterChart(elementId, students, totalStats) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // è¾…åŠ©ï¼šè®¡ç®—æ ‡å‡†å·®
    const calcStdDev = (arr) => {
        if (arr.length === 0) return 0;
        const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
        const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / arr.length;
        return Math.sqrt(variance);
    };

    // 1. å‡†å¤‡æ•£ç‚¹æ•°æ®
    const scatterData = [];
    let maxStdDev = 0;

    students.forEach(s => {
        if (typeof s.totalScore !== 'number') return;

        // æ”¶é›†è¯¥ç”Ÿæ‰€æœ‰ç§‘ç›®çš„â€œå¾—åˆ†ç‡â€
        const rates = [];
        G_DynamicSubjectList.forEach(sub => {
            const score = s.scores[sub];
            const config = G_SubjectConfigs[sub];
            if (typeof score === 'number' && config && config.full > 0) {
                rates.push(score / config.full); // 0.0 - 1.0
            }
        });

        if (rates.length > 0) {
            const dev = calcStdDev(rates); // åç§‘ç³»æ•°
            if (dev > maxStdDev) maxStdDev = dev;
            
            // æ•°æ®æ ¼å¼: [æ€»åˆ†, åç§‘ç³»æ•°, å§“å, ç­çº§]
            scatterData.push([s.totalScore, parseFloat(dev.toFixed(3)), s.name, s.class]);
        }
    });

    // 2. è®¡ç®—è¾…åŠ©çº¿ (å¹´çº§å¹³å‡)
    const avgTotal = totalStats.totalScore ? totalStats.totalScore.average : 0;
    const avgDev = maxStdDev * 0.4; // ä¼°ç®—ä¸€ä¸ªåˆç†çš„åç§‘è­¦æˆ’çº¿ï¼Œæˆ–è€…å–å¹³å‡å€¼

    const option = {
        tooltip: {
            formatter: (p) => {
                const d = p.data;
                return `<strong>${d[2]}</strong> (${d[3]})<br/>` +
                       `æ€»åˆ†: ${d[0]}<br/>` +
                       `åç§‘åº¦: ${d[1]} (è¶Šä½è¶Šå¥½)`;
            }
        },
        grid: { left: '10%', right: '10%', top: '10%', bottom: '10%' },
        xAxis: {
            type: 'value',
            name: 'æ€»åˆ† (å®åŠ›)',
            nameLocation: 'middle',
            nameGap: 20,
            scale: true, // ä¸ä»0å¼€å§‹
            splitLine: { show: false }
        },
        yAxis: {
            type: 'value',
            name: 'åç§‘åº¦ (ä¸å‡è¡¡)',
            nameLocation: 'middle',
            nameGap: 30,
            splitLine: { show: false }
        },
        series: [
            {
                type: 'scatter',
                data: scatterData,
                symbolSize: 8,
                itemStyle: {
                    color: (p) => {
                        const score = p.data[0];
                        const dev = p.data[1];
                        // ç®€å•ç€è‰²é€»è¾‘
                        if (score >= avgTotal && dev <= avgDev) return '#28a745'; // å³ä¸‹ (ä¼˜+ç¨³) - ç»¿
                        if (score >= avgTotal && dev > avgDev) return '#ff9f43';  // å³ä¸Š (ä¼˜+å) - æ©™
                        if (score < avgTotal && dev > avgDev) return '#ee5253';   // å·¦ä¸Š (å·®+å) - çº¢
                        return '#54a0ff'; // å·¦ä¸‹ (å·®+ç¨³) - è“
                    },
                    opacity: 0.7
                },
                markLine: {
                    silent: true,
                    symbol: 'none',
                    lineStyle: { type: 'dashed', color: '#999' },
                    data: [
                        { xAxis: avgTotal, name: 'å¹³å‡æ€»åˆ†' },
                        { yAxis: avgDev, name: 'å¹³å‡å‡è¡¡åº¦' }
                    ],
                    label: { formatter: '{b}' }
                },
                markArea: {
                    silent: true,
                    itemStyle: { opacity: 0.05 },
                    data: [
                        // å³ä¸‹è§’ (å…­è¾¹å½¢æˆ˜å£«åŒºåŸŸ) - ç»¿è‰²é«˜äº®
                        [
                            { xAxis: avgTotal, yAxis: 0 },
                            { xAxis: 10000, yAxis: avgDev, itemStyle: { color: '#28a745' } } // 10000æ˜¯è¶³å¤Ÿå¤§çš„æ•°
                        ]
                    ]
                }
            }
        ]
    };
    myChart.setOption(option);
}

/**
 * (    ) 9.10. æ¨¡å—åï¼šæˆç»©åˆ†å¸ƒå˜åŠ¨
 * @param {Object} container - HTML å®¹å™¨
 * @param {Array} currentData - (å·²ç­›é€‰) æœ¬æ¬¡å­¦ç”Ÿæ•°æ®
 * @param {Array} compareData - (å·²ç­›é€‰) å¯¹æ¯”å­¦ç”Ÿæ•°æ®
 * @param {Object} currentStats - G_Statistics
 * @param {Object} compareStats - G_CompareStatistics
 */
/**
 *    UPGRADED V4    æ¨¡å—ä¸ƒï¼šæˆç»©åˆ†å¸ƒå˜åŠ¨ (ç›´æ–¹å›¾ä¹Ÿæ”¯æŒ Tåˆ†/åŸå§‹åˆ† åˆ‡æ¢)
 */
function renderTrendDistribution(container, currentData, compareData, currentStats, compareStats, currentFilter) {

    // 1. æ£€æŸ¥æ•°æ®
    if (!compareData || compareData.length === 0) {
        container.innerHTML = `<h2>æ¨¡å—ä¸ƒï¼šæˆç»©åˆ†å¸ƒå˜åŠ¨</h2><p>è¯·å…ˆåœ¨ä¾§è¾¹æ å¯¼å…¥ "å¯¹æ¯”æˆç»©" æ•°æ®ã€‚</p>`;
        return;
    }
    // è‡ªåŠ¨è¡¥å…¨æ’åæ•°æ®
    if (compareData.length > 0 && !compareData[0].gradeRanks) {
        compareData = addSubjectRanksToData(compareData);
        localStorage.setItem('G_CompareData', JSON.stringify(compareData));
    }

    // 2. æ¸²æŸ“ HTML
    container.innerHTML = `
        <h2>æ¨¡å—ä¸ƒï¼šæˆç»©åˆ†å¸ƒå˜åŠ¨ (å½“å‰ç­›é€‰: ${G_CurrentClassFilter})</h2>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <div class="controls-bar chart-controls" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                
                <div>
                    <label for="dist-subject-select">é€‰æ‹©ç§‘ç›®:</label>
                    <select id="dist-subject-select" class="sidebar-select" style="min-width: 120px;">
                        <option value="totalScore">æ€»åˆ†</option>
                        ${G_DynamicSubjectList.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>

                <div>
                    <label>ç»Ÿè®¡æ¨¡å¼:</label>
                    <select id="dist-hist-mode" class="sidebar-select" style="width:auto; font-weight:bold; color:#20c997; border-color:#20c997;">
                        <option value="raw">ğŸ“Š åŸå§‹åˆ†</option>
                        <option value="tscore">âš–ï¸ Tåˆ† (æ ‡å‡†åˆ†)</option>
                    </select>
                </div>

                <div style="border-left: 1px solid #ddd; padding-left: 15px; display: flex; align-items: center; gap: 10px;">
                    <label for="dist-bin-size">åˆ†æ®µé—´éš”:</label>
                    <input type="number" id="dist-bin-size" class="sidebar-select" placeholder="è‡ªåŠ¨" style="width: 70px;">
                    <button id="dist-redraw-btn" class="sidebar-button" style="padding: 6px 12px;">ğŸ”„ é‡ç»˜</button>
                </div>
            </div>
            <div class="chart-container" id="dist-overlap-histogram-chart" style="height: 500px;"></div>
        </div>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <div class="controls-bar chart-controls" style="border-bottom: none; padding-bottom: 0; margin-bottom: 10px; flex-wrap: wrap; justify-content: space-between;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <h4 style="margin: 0;">å„ç§‘ç­‰çº§æ„æˆå¯¹æ¯”</h4>
                    <select id="dist-comp-mode" class="sidebar-select" style="width:auto; font-weight:bold; color:#007bff; border-color:#007bff;">
                        <option value="raw">ğŸ“Š åŸå§‹åˆ†æ¨¡å¼</option>
                        <option value="tscore">âš–ï¸ Tåˆ†æ¨¡å¼</option>
                    </select>
                </div>
                <button id="dist-export-composition-btn" class="sidebar-button" style="padding: 4px 12px; font-size: 0.85em; background-color: var(--color-green);">
                    ğŸ“¥ å¯¼å‡ºåå•
                </button>
            </div>
            <p style="font-size: 0.8em; color: var(--text-muted); margin-top: -5px; margin-bottom: 10px;" id="dist-comp-desc">
                * åŸå§‹åˆ†æ¨¡å¼ï¼šA(ä¼˜ç§€çº¿), B(è‰¯å¥½çº¿), C(åŠæ ¼çº¿) | Tåˆ†æ¨¡å¼ï¼šA(Tâ‰¥60), B(Tâ‰¥50), C(Tâ‰¥40)
            </p>
            <div class="chart-container" id="dist-composition-compare-chart" style="height: 450px;"></div>
        </div>

        <div class="main-card-wrapper">
            <div class="controls-bar chart-controls" style="border-bottom: none; padding-bottom: 0; margin-bottom: 10px;">
                <h4 style="margin: 0; margin-right: 20px;">æ’ååˆ†å±‚æµåŠ¨å›¾</h4>
                <label>åˆ†æå¯¹è±¡:</label>
                <select id="dist-sankey-subject-select" class="sidebar-select" style="width: auto;">
                    <option value="totalScore">æ€»åˆ†æ’å</option>
                    ${G_DynamicSubjectList.map(s => `<option value="${s}">${s}æ’å</option>`).join('')}
                </select>
            </div>
            <div class="chart-container" id="dist-sankey-chart" style="height: 600px;"></div>
        </div>
        
        <div class="main-card-wrapper" id="dist-sankey-results-wrapper" style="display: none; margin-top: 20px;">
            <h4 id="dist-sankey-results-title">å­¦ç”Ÿåˆ—è¡¨</h4>
            <div class="table-container" id="dist-sankey-results-table"></div>
        </div>
    `;

    // 3. æ•°æ®é¢„å¤„ç†
    const mergedData = currentData.map(student => {
        const oldStudent = compareData.find(s => String(s.id) === String(student.id));
        if (!oldStudent) return null;
        return {
            ...student,
            oldTotalScore: oldStudent.totalScore,
            oldRank: oldStudent.rank,
            oldGradeRank: oldStudent.gradeRank || 0,
            oldScores: oldStudent.scores || {},
            oldTScores: oldStudent.tScores || {}, // [å…³é”®] æºå¸¦æ—§Tåˆ†
            oldClassRanks: oldStudent.classRanks || {},
            oldGradeRanks: oldStudent.gradeRanks || {}
        };
    }).filter(s => s !== null);

    // 4. é€»è¾‘ A: ç›´æ–¹å›¾ (ä¿®å¤ç‰ˆ - ç§»é™¤å†—ä½™å˜é‡)
    const subjectSelect = document.getElementById('dist-subject-select');
    const histModeSelect = document.getElementById('dist-hist-mode');
    const binInput = document.getElementById('dist-bin-size');
    const redrawBtn = document.getElementById('dist-redraw-btn');

    const drawHistogram = () => {
        const subject = subjectSelect.value;
        const mode = histModeSelect.value; // 'raw' or 'tscore'
        const binSize = parseFloat(binInput.value);

        //    æ ¸å¿ƒä¿®å¤    
        // ç›´æ¥å°†å®Œæ•´æ•°æ® (currentData, compareData) ä¼ ç»™ç»˜å›¾å‡½æ•°ã€‚
        // å†…éƒ¨ä¼šè‡ªåŠ¨æ ¹æ® mode æå– scores æˆ– tScoresã€‚
        // ä¹‹å‰è¿™é‡Œæœ‰å¤šä½™çš„ currentScores è®¡ç®—ä»£ç ï¼Œå¯¼è‡´æŠ¥é”™ï¼Œç°å·²åˆ é™¤ã€‚
        renderOverlappingHistogram('dist-overlap-histogram-chart', currentData, compareData, subject, binSize, mode);
    };

    // ç»‘å®šäº‹ä»¶ (ä¿æŒä¸å˜)
    subjectSelect.addEventListener('change', () => { binInput.value = ''; drawHistogram(); });
    histModeSelect.addEventListener('change', () => { binInput.value = ''; drawHistogram(); });
    redrawBtn.addEventListener('click', drawHistogram);

    // 5.    NEW    é€»è¾‘ B: ç­‰çº§å¯¹æ¯”å›¾ (æ”¯æŒåˆ‡æ¢)
    const compModeSelect = document.getElementById('dist-comp-mode');
    const exportBtn = document.getElementById('dist-export-composition-btn');
    const descText = document.getElementById('dist-comp-desc');

    const drawComposition = () => {
        const mode = compModeSelect.value; // 'raw' or 'tscore'

        // æ›´  è¯´æ˜æ–‡å­—
        if (mode === 'raw') descText.innerText = '* åŸå§‹åˆ†æ¨¡å¼ï¼šåŸºäºâ€œç§‘ç›®é…ç½®â€ä¸­çš„ ä¼˜ç§€çº¿(A)ã€è‰¯å¥½çº¿(B)ã€åŠæ ¼çº¿(C) è¿›è¡Œç»Ÿè®¡ã€‚';
        else descText.innerText = '* Tåˆ†æ¨¡å¼ (æ ‡å‡†åˆ†)ï¼šA (Tâ‰¥60, å‰16%), B (Tâ‰¥50, å‰50%), C (Tâ‰¥40, å‰84%), D (T<40)ã€‚æ¶ˆé™¤è¯•å·éš¾åº¦å·®å¼‚ã€‚';

        // è°ƒç”¨ç»˜å›¾
        renderTrendCompositionChart('dist-composition-compare-chart', currentData, compareData, mode);
    };

    compModeSelect.addEventListener('change', drawComposition);

    // ç»‘å®šå¯¼å‡º
    exportBtn.addEventListener('click', () => {
        const mode = compModeSelect.value;
        exportCompositionDetails(mergedData, mode); // ä¼ å…¥å½“å‰æ¨¡å¼
    });

    // 5. æ¡‘åŸºå›¾é€»è¾‘
    const sankeySubjectSelect = document.getElementById('dist-sankey-subject-select');
    const total = currentData.length;

    // åˆ†å±‚è§„åˆ™
    const rankTiers = [
        { name: 'Top 10%', min: 1, max: Math.ceil(total * 0.1) },
        { name: '10%-30%', min: Math.ceil(total * 0.1) + 1, max: Math.ceil(total * 0.3) },
        { name: '30%-60%', min: Math.ceil(total * 0.3) + 1, max: Math.ceil(total * 0.6) },
        { name: 'Bottom 40%', min: Math.ceil(total * 0.6) + 1, max: total }
    ];

    const getRankCategory = (rank) => {
        for (const tier of rankTiers) {
            if (rank >= tier.min && rank <= tier.max) return tier.name;
        }
        return 'N/A';
    };

    let sankeyInstance = null;
    const drawSankey = () => {
        const subject = sankeySubjectSelect.value;
        sankeyInstance = renderRankingSankey('dist-sankey-chart', mergedData, rankTiers, getRankCategory, currentFilter, subject);
        bindSankeyEvents();
    };

    sankeySubjectSelect.addEventListener('change', drawSankey);

    // 6. åˆå§‹ç»˜åˆ¶
    drawHistogram();
    drawComposition();
    drawSankey();


    //            ç»‘å®šå¯¼å‡ºç­‰çº§åå•äº‹ä»¶
    document.getElementById('dist-export-composition-btn').addEventListener('click', () => {
        exportCompositionDetails(mergedData);
    });

    // [ä¿®æ”¹ç‰ˆ] å¯¼å‡ºé€»è¾‘
    const exportCompositionDetails = (data, mode = 'raw') => {
        const exportData = [];
        const subjects = G_DynamicSubjectList;
        const label = mode === 'tscore' ? 'Tåˆ†' : 'åŸå§‹åˆ†';

        exportData.push(["ç§‘ç›®", "æœ¬æ¬¡ç­‰çº§", "ç­çº§", "å§“å", `æœ¬æ¬¡${label}`, "ä¸Šæ¬¡ç­‰çº§", `ä¸Šæ¬¡${label}`, "å˜åŠ¨æƒ…å†µ"]);

        subjects.forEach(subject => {
            const config = G_SubjectConfigs[subject] || {};

            // ç­‰çº§åˆ¤æ–­ (å†…éƒ¨æ ¹æ® mode åˆ†æµ)
            const getLevel = (val) => {
                if (val === undefined || val === null || isNaN(val)) return 'æ— æ•°æ®';
                if (mode === 'tscore') {
                    if (val >= 60) return 'A (ä¼˜ç§€)';
                    if (val >= 50) return 'B (è‰¯å¥½)';
                    if (val >= 40) return 'C (åŠæ ¼)';
                    return 'D (ä¸åŠæ ¼)';
                } else {
                    if (val >= config.excel) return 'A (ä¼˜ç§€)';
                    if (val >= config.good) return 'B (è‰¯å¥½)';
                    if (val >= config.pass) return 'C (åŠæ ¼)';
                    return 'D (ä¸åŠæ ¼)';
                }
            };

            const levelVal = (l) => {
                if (l.startsWith('A')) return 4; if (l.startsWith('B')) return 3;
                if (l.startsWith('C')) return 2; if (l.startsWith('D')) return 1;
                return 0;
            };

            data.forEach(s => {
                // æ ¹æ®æ¨¡å¼è·å–åˆ†æ•°
                let currVal, oldVal;
                if (mode === 'tscore') {
                    currVal = (s.tScores && s.tScores[subject]);
                    oldVal = (s.oldTScores && s.oldTScores[subject]);
                } else {
                    currVal = s.scores[subject];
                    oldVal = s.oldScores[subject];
                }

                const currLevel = getLevel(currVal);
                const oldLevel = getLevel(oldVal);

                // å˜åŠ¨åˆ¤æ–­
                let changeText = '-';
                const v1 = levelVal(currLevel);
                const v2 = levelVal(oldLevel);
                if (v1 > 0 && v2 > 0) {
                    if (v1 > v2) changeText = 'â¬†ï¸ å‡çº§';
                    else if (v1 < v2) changeText = 'â¬‡ï¸ é™çº§';
                    else changeText = 'â¡ï¸ ä¿æŒ';
                }

                if (v1 > 0 || v2 > 0) {
                    exportData.push([
                        subject,
                        currLevel,
                        s.class,
                        s.name,
                        currVal !== undefined && currVal !== null ? currVal.toFixed(1) : '-',
                        oldLevel,
                        oldVal !== undefined && oldVal !== null ? oldVal.toFixed(1) : '-',
                        changeText
                    ]);
                }
            });
            exportData.push([]);
        });

        const ws = XLSX.utils.aoa_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, `${label}ç­‰çº§åˆ†å¸ƒ`);
        XLSX.writeFile(wb, `${label}ç­‰çº§å˜åŠ¨åå•_${new Date().toLocaleDateString()}.xlsx`);
    };


    // 7. ç»‘å®šæ¡‘åŸºå›¾ç‚¹å‡»äº‹ä»¶ (ä¿®å¤ç‰ˆï¼šè§£å†³å•ç§‘ç‚¹å‡»æ— ååº” Bug)
    function bindSankeyEvents() {
        const resultsWrapper = document.getElementById('dist-sankey-results-wrapper');
        const resultsTitle = document.getElementById('dist-sankey-results-title');
        const resultsTable = document.getElementById('dist-sankey-results-table');

        if (sankeyInstance) {
            sankeyInstance.off('click');
            sankeyInstance.on('click', (params) => {
                const subject = sankeySubjectSelect.value;
                const isTotal = (subject === 'totalScore');
                const useGradeRank = (currentFilter === 'ALL');
                const { dataType, data } = params;

                // [æ ¸å¿ƒä¿®å¤] å®‰å…¨è·å–æ’åå’Œåˆ†æ•°
                const getRanks = (s) => {
                    if (isTotal) {
                        return {
                            old: useGradeRank ? s.oldGradeRank : s.oldRank,
                            new: useGradeRank ? s.gradeRank : s.rank,
                            oldScore: s.oldTotalScore,
                            newScore: s.totalScore
                        };
                    } else {
                        // ğŸ”¥ ä¿®å¤ç‚¹ï¼šå¢åŠ  (s.oldGradeRanks || {}) å®‰å…¨è®¿é—®
                        // é˜²æ­¢å› æ’åæ•°æ®ç¼ºå¤±å¯¼è‡´çš„ undefined æŠ¥é”™
                        const oldRanks = useGradeRank ? (s.oldGradeRanks || {}) : (s.oldClassRanks || {});
                        const newRanks = useGradeRank ? (s.gradeRanks || {}) : (s.classRanks || {});
                        
                        return {
                            old: oldRanks[subject] || 0,
                            new: newRanks[subject] || 0,
                            // åˆ†æ•°ä¹ŸåŠ å®‰å…¨æ£€æŸ¥
                            oldScore: (s.oldScores && s.oldScores[subject] !== undefined) ? s.oldScores[subject] : '-',
                            newScore: (s.scores && s.scores[subject] !== undefined) ? s.scores[subject] : '-'
                        };
                    }
                };

                let students = [];
                let title = '';

                if (dataType === 'link') {
                    title = `${data.source} â†’ ${data.target} (${data.value}äºº)`;
                    const sourceTierName = data.source.replace('ä¸Šæ¬¡: ', '');
                    const targetTierName = data.target.replace('æœ¬æ¬¡: ', '');

                    students = mergedData.filter(s => {
                        const r = getRanks(s);
                        return r.old > 0 && r.new > 0 &&
                            getRankCategory(r.old) === sourceTierName &&
                            getRankCategory(r.new) === targetTierName;
                    });
                } else if (dataType === 'node') {
                    title = `${params.name} (${params.value}äºº)`;
                    // ä¿®å¤èŠ‚ç‚¹åç§°è§£æ (å»æ‰å‰ç¼€)
                    const nodeName = data.name.replace(/^(ä¸Šæ¬¡|æœ¬æ¬¡): /, '');
                    const isOld = data.name.startsWith('ä¸Šæ¬¡:');

                    students = mergedData.filter(s => {
                        const r = getRanks(s);
                        const rankToCheck = isOld ? r.old : r.new;
                        return rankToCheck > 0 && getRankCategory(rankToCheck) === nodeName;
                    });
                }

                if (students.length > 0) {
                    resultsWrapper.style.display = 'block';
                    resultsTitle.innerText = `${title} - ${isTotal ? 'æ€»åˆ†' : subject}`;

                    const scoreLabel = isTotal ? 'æ€»åˆ†' : subject;
                    const rankLabel = useGradeRank ? 'å¹´æ’' : 'ç­æ’';

                    resultsTable.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>å§“å</th><th>ç­çº§</th>
                                        <th>ä¸Šæ¬¡åˆ†å±‚</th> <th>æœ¬æ¬¡åˆ†å±‚</th>
                                        <th>æœ¬æ¬¡${scoreLabel}</th><th>æœ¬æ¬¡${rankLabel}</th>
                                        <th>ä¸Šæ¬¡${scoreLabel}</th><th>ä¸Šæ¬¡${rankLabel}</th>
                                    </tr>
                                </thead>
                                <tbody>
                        ${students.map(s => {
                        const r = getRanks(s);

                        // è·å–åˆ†å±‚åç§°
                        const oldTierName = getRankCategory(r.old);
                        const newTierName = getRankCategory(r.new);

                        const tierOld = rankTiers.findIndex(t => t.name === oldTierName);
                        const tierNew = rankTiers.findIndex(t => t.name === newTierName);

                        let rowClass = '';
                        // ç´¢å¼•è¶Šå°ä»£è¡¨æ’åè¶Šé å‰ (Top 10% æ˜¯ 0)ï¼Œæ‰€ä»¥ æ—§ç´¢å¼• > æ–°ç´¢å¼• = è¿›æ­¥
                        if (tierOld > tierNew) rowClass = 'progress';
                        else if (tierOld < tierNew) rowClass = 'regress';

                        return `
                                        <tr class="${rowClass}">
                                            <td>${s.name}</td><td>${s.class}</td>
                                            
                                            <td style="color: #888; font-size: 0.9em;">${oldTierName}</td>
                                            <td style="font-weight: bold;">${newTierName}</td>
                                            
                                            <td><strong>${r.newScore}</strong></td>
                                            <td>${r.new}</td>
                                            <td>${r.oldScore}</td>
                                            <td>${r.old}</td>
                                        </tr>`;
                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // æ»šåŠ¨åˆ°è¡¨æ ¼ä½ç½®
                    resultsWrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }
    }
}

/**
 *   9.11. æ¨¡å—ï¼šæ•°æ®ç®¡ç†ä¸­å¿ƒ
 *    ä¿®å¤ç‰ˆ    è§£å†³ loadMultiExamData å¼‚æ­¥è°ƒç”¨é—®é¢˜
 */
function renderMultiExam(container) {

    // 1. æ¸²æŸ“æ¨¡å— HTML (ä¿æŒä¸å˜)
    container.innerHTML = `
        <h2>è€ƒè¯•ç³»ç»Ÿä¸­å¿ƒå’Œå¤šæ¬¡æ•°æ®åˆ†æ</h2>
        <p style="margin-top: -20px; margin-bottom: 20px; color: var(--text-muted);">
            åœ¨æ­¤æ¨¡å—ä¸Šä¼ çš„æˆç»©å°†è¢«æµè§ˆå™¨æ°¸ä¹…ä¿å­˜ï¼ˆç›´åˆ°æ‚¨æ‰‹åŠ¨æ¸…é™¤ï¼‰ã€‚
        </p>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <h4>è€ƒè¯•åˆ—è¡¨ç®¡ç†</h4>
            <ol id="multi-exam-list" class="multi-exam-list-container"></ol>

            <div class="controls-bar" style="background: transparent; box-shadow: none; padding: 15px 0 0 0; border-top: 1px solid var(--border-color); flex-wrap: wrap; justify-content: space-between;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <label for="multi-file-uploader" class="upload-label" style="padding: 10px 16px; background-color: var(--primary-color); color: white;">
                        ğŸ“Š æ·»åŠ   æˆç»© (å¯å¤šé€‰)
                    </label>
                    <input type="file" id="multi-file-uploader" accept=".xlsx, .xls, .csv" style="display: none;" multiple>

                    <label for="multi-json-uploader" class="upload-label" style="padding: 10px 16px; background-color: var(--color-orange); color: white;">
                        ğŸ“¥ å¯¼å…¥å…¨ç³»ç»Ÿå¤‡ä»½ (JSON)
                    </label>
                    <input type="file" id="multi-json-uploader" accept=".json" style="display: none;">
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="multi-export-all" class="sidebar-button" style="background-color: var(--color-green);">
                        ğŸ“¤ å¯¼å‡ºå…¨ç³»ç»Ÿå¤‡ä»½ (JSON)  </button>
                    </button>
                    <button id="multi-clear-all" class="sidebar-button" style="background-color: var(--color-red);">
                        ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨
                    </button>
                </div>
            </div>
            <span id="multi-file-status" style="margin-top: 10px; color: var(--text-muted); display: block;"></span>
        </div>

        <div class="main-card-wrapper" style="margin-bottom: 20px;">
            <div class="controls-bar">
                <label for="multi-student-search">æœç´¢å­¦ç”Ÿ (å§“å/è€ƒå·):</label>
                <div class="search-combobox">
                    <input type="text" id="multi-student-search" placeholder="è¾“å…¥å§“åæˆ–è€ƒå·..." autocomplete="off">
                    <div class="search-results" id="multi-student-search-results"></div>
                </div>
            </div>
        </div>

        <div id="multi-student-report" style="display: none;">
            <div class="main-card-wrapper" style="margin-bottom: 20px;">
                <h4 id="multi-student-name-title">å­¦ç”ŸæŠ¥è¡¨</h4>
                
                <div id="multi-subject-filter-container">
                    <div class="main-card-wrapper" style="padding: 15px; margin-top: 10px; box-shadow: var(--shadow-sm);">
                        <h5>å„ç§‘æˆç»©æ›²çº¿ (å›¾1) - ç§‘ç›®ç­›é€‰</h5>
                        <div class="controls-bar" style="background: transparent; box-shadow: none; padding: 0; flex-wrap: wrap; gap: 10px;">
                            <button id="multi-subject-all" class="sidebar-button" style="padding: 5px 10px; font-size: 0.8em;">å…¨é€‰</button>
                            <button id="multi-subject-none" class="sidebar-button" style="padding: 5px 10px; font-size: 0.8em; background-color: var(--color-gray);">å…¨ä¸é€‰</button>
                        </div>
                        <div id="multi-subject-checkboxes" class="multi-subject-filter-container">
                        </div>
                    </div>
                </div>

                <div class="dashboard-chart-grid-1x1" style="margin-top: 20px;">
                    <div class="main-card-wrapper" style="padding: 15px; margin-bottom: 0; border-bottom: none; border-radius: 8px 8px 0 0;">
                        <h4 style="margin: 0;">1. å„ç§‘åˆ†æ•°å˜åŒ–æ›²çº¿</h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.8em; color: var(--text-muted);">* å—ä¸Šæ–¹â€œç§‘ç›®å¤é€‰æ¡†â€æ§åˆ¶</p>
                    </div>
                    <div class="chart-container" id="multi-exam-score-chart" style="height: 350px; margin-top: 0; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; background: #fff;"></div>

                    <div class="main-card-wrapper" style="padding: 15px; margin-top: 20px; margin-bottom: 0; border-bottom: none; border-radius: 8px 8px 0 0;">
                        <h4 style="margin: 0;">2. æ€»åˆ†æ’åå˜åŒ–æ›²çº¿</h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.8em; color: var(--text-muted);">* å›ºå®šæ˜¾ç¤ºæ€»åˆ†æ’åï¼Œä¸å—ç­›é€‰å½±å“</p>
                    </div>
                    <div class="chart-container" id="multi-exam-rank-chart" style="height: 350px; margin-top: 0; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; background: #fff;"></div>

                    <div class="main-card-wrapper" style="padding: 15px; margin-top: 20px; margin-bottom: 0; border-bottom: none; border-radius: 8px 8px 0 0;">
                        <div class="controls-bar" style="background: transparent; box-shadow: none; padding: 0; margin: 0; justify-content: space-between; flex-wrap: wrap;">
                            <h4 style="margin: 0;">3. å„ç§‘æ’åå˜åŒ–æ›²çº¿</h4>
                            
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label for="multi-rank-type-select" style="margin: 0; font-size: 0.9em;">æ˜¾ç¤ºç±»å‹:</label>
                                <select id="multi-rank-type-select" class="sidebar-select" style="width: auto; padding: 6px 12px;">
                                    <option value="both">åŒæ—¶æ˜¾ç¤º (ç­æ’ + å¹´æ’)</option>
                                    <option value="class">ä»…çœ‹ç­çº§æ’å</option>
                                    <option value="grade">ä»…çœ‹å¹´çº§æ’å</option>
                                </select>
                            </div>
                        </div>
                        <p style="margin: 5px 0 0 0; font-size: 0.8em; color: var(--text-muted);">
                            * å—ä¸Šæ–¹â€œç§‘ç›®å¤é€‰æ¡†â€ å’Œ æ­¤å¤„â€œæ˜¾ç¤ºç±»å‹â€ å…±åŒæ§åˆ¶
                        </p>
                    </div>
                    <div class="chart-container" id="multi-exam-subject-rank-chart" style="height: 350px; margin-top: 0; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; background: #fff;"></div>
                </div>

                <div id="multi-student-table-container" class="multi-exam-table-container">
                </div>
            </div>
        </div>
    `;

    // 2. ç»‘å®š DOM å’Œäº‹ä»¶
    const multiUploader = document.getElementById('multi-file-uploader');
    const statusLabel = document.getElementById('multi-file-status');
    const listContainer = document.getElementById('multi-exam-list');
    const clearBtn = document.getElementById('multi-clear-all');
    const exportBtn = document.getElementById('multi-export-all');
    const jsonUploader = document.getElementById('multi-json-uploader');

    // (ä¸Šä¼ äº‹ä»¶)
    multiUploader.addEventListener('change', async (event) => {
        const files = event.target.files;
        if (!files || files.length === 0) return;

        statusLabel.innerText = `ğŸ”„ æ­£åœ¨è§£æ ${files.length} ä¸ªæ–‡ä»¶...`;
        let loadedData = await loadMultiExamData();

        try {
            for (const file of files) {
                const { processedData } = await loadExcelData(file);
                const rankedData = addSubjectRanksToData(processedData);

                loadedData.push({
                    id: Date.now() + Math.random(),
                    originalName: file.name,
                    label: file.name.replace(/\.xlsx|\.xls|\.csv/g, ''),
                    students: rankedData,
                    isHidden: false // é»˜è®¤ä¸éšè—
                });
            }

            statusLabel.innerText = `âœ… æˆåŠŸæ·»åŠ  ${files.length} æ¬¡è€ƒè¯•ã€‚`;
            saveMultiExamData(loadedData);
            renderMultiExamList(loadedData);
            initializeStudentSearch(loadedData);

        } catch (err) {
            statusLabel.innerText = `âŒ åŠ è½½å¤±è´¥: ${err.message}`;
            console.error(err);
        }
    });

    // (åˆ—è¡¨äº¤äº’äº‹ä»¶: é‡å‘½å)
    listContainer.addEventListener('input', async (e) => { // async added just in case
        if (e.target && e.target.dataset.role === 'label') {
            const id = e.target.closest('li').dataset.id;
            const newLabel = e.target.value;
            let data = await loadMultiExamData(); // await
            const item = data.find(d => String(d.id) === id);
            if (item) {
                item.label = newLabel;
                saveMultiExamData(data);
                initializeStudentSearch(data);
                document.getElementById('multi-student-report').style.display = 'none';
            }
        }
    });

    // (åˆ—è¡¨äº¤äº’äº‹ä»¶: æŒ‰é’®ç‚¹å‡»)
    listContainer.addEventListener('click', async (e) => { // async added
        if (!e.target) return;
        const button = e.target.closest('button');
        if (!button) return;

        const role = button.dataset.role;
        const id = button.closest('li').dataset.id;
        let data = await loadMultiExamData(); // await
        const index = data.findIndex(d => String(d.id) === id);

        if (index === -1) return;

        if (role === 'toggle-hide') {
            data[index].isHidden = !data[index].isHidden;
            document.getElementById('multi-student-report').style.display = 'none';
        } else if (role === 'delete') {
            const itemLabel = data[index].label;
            if (confirm(`æ‚¨ç¡®å®šè¦åˆ é™¤ "${itemLabel}" è¿™æ¬¡è€ƒè¯•å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                data.splice(index, 1);
            } else {
                return;
            }
        } else if (role === 'up' && index > 0) {
            [data[index - 1], data[index]] = [data[index], data[index - 1]];
        } else if (role === 'down' && index < data.length - 1) {
            [data[index + 1], data[index]] = [data[index], data[index + 1]];
        }

        saveMultiExamData(data);
        renderMultiExamList(data);
        initializeStudentSearch(data);
        document.getElementById('multi-student-report').style.display = 'none';
    });

    // (æ¸…ç©ºäº‹ä»¶)
    clearBtn.addEventListener('click', () => {
        if (confirm('æ‚¨ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„â€œå¤šæ¬¡è€ƒè¯•â€æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            saveMultiExamData([]);
            renderMultiExamList([]);
            initializeStudentSearch([]);
            document.getElementById('multi-student-report').style.display = 'none';
        }
    });

    // ============================================================
    //    æ ¸å¿ƒå‡çº§    å…¨ç³»ç»Ÿæ•°æ®å¯¼å‡º (Full System Export)
    // ============================================================
    exportBtn.onclick = async () => { // ä½¿ç”¨ onclick é¿å…é‡å¤ç»‘å®š
        try {
            exportBtn.innerText = "ğŸ“¦ æ‰“åŒ…ä¸­...";
            exportBtn.disabled = true;

            // 1. å‡†å¤‡è¦å¤‡ä»½çš„æ•°æ® Key æ¸…å•
            // æ ¼å¼: { backupKey: localForageKey/localStorageKey, type: 'localforage'/'localstorage' }

            // (A) ä» IndexedDB è·å–çš„å¤§æ•°æ®
            const [
                collections,
                goalArchives,
                goalSessionMeta,
                itemLibrary,
                subjectConfigs
            ] = await Promise.all([
                localforage.getItem('G_MultiExam_Collections_V2'), // è€ƒè¯•åˆ—è¡¨åº“
                localforage.getItem('G_Goal_Archives'),            // ç›®æ ‡è§„åˆ’-æ¡£æ¡ˆ
                localforage.getItem('G_Goal_Session_Meta'),        // ç›®æ ‡è§„åˆ’-åˆ—è¡¨å…ƒæ•°æ®
                localforage.getItem('G_ItemAnalysis_Library'),     // å­¦ç§‘å°é¢˜åº“
                localforage.getItem('G_SubjectConfigs')            // å…¨å±€ç§‘ç›®é…ç½®
            ]);

            // (B) ä» localStorage è·å–çš„çŠ¶æ€/å°æ•°æ®
            const metaData = {
                activeCollectionId: localStorage.getItem('G_MultiExam_ActiveId'),
                activeGoalSessionId: localStorage.getItem('G_Goal_Current_Session_ID'),
                deepSeekKey: localStorage.getItem('G_DeepSeekKey'), // å¯é€‰ï¼šå¤‡ä»½API Keyæ–¹ä¾¿è¿ç§»
                theme: localStorage.getItem('app_theme')
            };

            // 2. æ„å»ºå…¨é‡å¤‡ä»½å¯¹è±¡
            const fullBackup = {
                __version__: "SmartPrism_Full_v2.0", // ç‰ˆæœ¬æ ‡è¯†ï¼Œç”¨äºå¯¼å…¥æ—¶è¯†åˆ«
                timestamp: new Date().toLocaleString(),
                data: {
                    collections: collections || {},
                    goalArchives: goalArchives || {},
                    goalSessionMeta: goalSessionMeta || [],
                    itemLibrary: itemLibrary || [],
                    subjectConfigs: subjectConfigs || {},
                    meta: metaData
                }
            };

            // 3. ç”Ÿæˆæ–‡ä»¶å¹¶ä¸‹è½½
            const jsonString = JSON.stringify(fullBackup, null, 2); // ç¾åŒ–è¾“å‡º
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ™ºæ…§æ£±é•œ_å…¨ç³»ç»Ÿå¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            statusLabel.innerText = `âœ… å…¨ç³»ç»Ÿå¤‡ä»½å·²å¯¼å‡º (åŒ…å«è€ƒè¯•åº“ã€è§„åˆ’ã€å°é¢˜åº“ç­‰)`;
            statusLabel.style.color = "green";

        } catch (err) {
            console.error(err);
            alert("å¯¼å‡ºå¤±è´¥: " + err.message);
            statusLabel.innerText = `âŒ å¯¼å‡ºå¤±è´¥`;
        } finally {
            exportBtn.innerText = "ğŸ“¤ å¯¼å‡ºå…¨ç³»ç»Ÿå¤‡ä»½ (JSON)";
            exportBtn.disabled = false;
        }
    };

    // ============================================================
    //    æ ¸å¿ƒå‡çº§    å…¨ç³»ç»Ÿæ•°æ®å¯¼å…¥ (Full System Import)
    // ============================================================
    jsonUploader.onchange = (event) => { // ä½¿ç”¨ onchange è¦†ç›–
        const file = event.target.files[0];
        if (!file) return;

        statusLabel.innerText = `â³ æ­£åœ¨è§£æå¤‡ä»½æ–‡ä»¶...`;
        const reader = new FileReader();

        reader.onload = async (e) => {
            try {
                const jsonContent = JSON.parse(e.target.result);

                // --- æƒ…å†µ A: è¯†åˆ«ä¸º  ç‰ˆå…¨é‡å¤‡ä»½ ---
                if (jsonContent.__version__ && jsonContent.__version__.startsWith("SmartPrism_Full")) {
                    const { data, timestamp } = jsonContent;

                    if (!confirm(`æ£€æµ‹åˆ°å…¨ç³»ç»Ÿå¤‡ä»½æ–‡ä»¶ (åˆ›å»ºäº ${timestamp})ã€‚\n\nåŒ…å«ï¼š\n- ğŸ“š è€ƒè¯•åˆ—è¡¨åº“\n- ğŸ¯ ç›®æ ‡è§„åˆ’æ•°æ®\n- ğŸ”¬ å°é¢˜åˆ†æåº“\n- âš™ï¸ ç³»ç»Ÿé…ç½®\n\nã€è­¦å‘Šã€‘å¯¼å…¥å°†è¦†ç›–å½“å‰æµè§ˆå™¨çš„æ‰€æœ‰å†å²æ•°æ®ï¼\nç¡®å®šè¦è¿˜åŸå—ï¼Ÿ`)) {
                        statusLabel.innerText = "æ“ä½œå·²å–æ¶ˆ";
                        jsonUploader.value = null;
                        return;
                    }

                    statusLabel.innerText = "ğŸ”„ æ­£åœ¨è¿˜åŸæ•°æ®...";

                    // 1. è¿˜åŸ IndexedDB æ•°æ®
                    await Promise.all([
                        localforage.setItem('G_MultiExam_Collections_V2', data.collections),
                        localforage.setItem('G_Goal_Archives', data.goalArchives),
                        localforage.setItem('G_Goal_Session_Meta', data.goalSessionMeta),
                        localforage.setItem('G_ItemAnalysis_Library', data.itemLibrary),
                        localforage.setItem('G_SubjectConfigs', data.subjectConfigs)
                    ]);

                    // 2. è¿˜åŸ LocalStorage çŠ¶æ€
                    if (data.meta) {
                        if (data.meta.activeCollectionId) localStorage.setItem('G_MultiExam_ActiveId', data.meta.activeCollectionId);
                        if (data.meta.activeGoalSessionId) localStorage.setItem('G_Goal_Current_Session_ID', data.meta.activeGoalSessionId);
                        if (data.meta.deepSeekKey) localStorage.setItem('G_DeepSeekKey', data.meta.deepSeekKey);
                        if (data.meta.theme) {
                            localStorage.setItem('app_theme', data.meta.theme);
                            if (data.meta.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
                        }
                    }

                    alert("âœ… å…¨ç³»ç»Ÿæ•°æ®è¿˜åŸæˆåŠŸï¼é¡µé¢å³å°†åˆ·  ã€‚");
                    location.reload(); // åˆ·  ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹
                }

                // --- æƒ…å†µ B: è¯†åˆ«ä¸ºæ—§ç‰ˆå¤‡ä»½ (ä»…è€ƒè¯•åˆ—è¡¨æ•°ç»„) ---
                else if (Array.isArray(jsonContent) || (jsonContent.length > 0 && jsonContent[0].students)) {
                    if (!confirm(`æ£€æµ‹åˆ°æ—§ç‰ˆå¤‡ä»½æ–‡ä»¶ (ä»…åŒ…å«è€ƒè¯•åˆ—è¡¨)ã€‚\n\næ˜¯å¦å°†å…¶å¯¼å…¥åˆ°å½“å‰é€‰ä¸­çš„åˆ—è¡¨åº“ä¸­ï¼Ÿ(è¿™ä¸ä¼šè¦†ç›–ç›®æ ‡è§„åˆ’å’Œå°é¢˜åº“)`)) {
                        jsonUploader.value = null;
                        return;
                    }

                    // èµ°æ—§çš„é€»è¾‘ï¼šä¿å­˜åˆ°å½“å‰ collection
                    await saveMultiExamData(jsonContent);

                    // åˆ·  ç•Œé¢
                    renderMultiExamList(jsonContent);
                    initializeStudentSearch(jsonContent);
                    statusLabel.innerText = `âœ… æ—§ç‰ˆæ•°æ®å·²å¯¼å…¥ (ä»…æ›´  è€ƒè¯•åˆ—è¡¨)`;
                }

                else {
                    throw new Error("æ— æ³•è¯†åˆ«çš„æ–‡ä»¶æ ¼å¼ã€‚è¯·ç¡®ä¿è¿™æ˜¯ç”±æœ¬ç³»ç»Ÿå¯¼å‡ºçš„ JSON å¤‡ä»½ã€‚");
                }

            } catch (err) {
                console.error(err);
                alert(`âŒ å¯¼å…¥å¤±è´¥: ${err.message}`);
                statusLabel.innerText = "âŒ æ–‡ä»¶è§£æé”™è¯¯";
            } finally {
                jsonUploader.value = null; // é‡ç½®æ§ä»¶ï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒåæ–‡ä»¶
            }
        };

        reader.onerror = () => {
            alert("æ–‡ä»¶è¯»å–å¤±è´¥");
            jsonUploader.value = null;
        };

        reader.readAsText(file);
    };

    // 3. åˆå§‹åŒ–æ•°æ®
    loadMultiExamData().then(initialData => {
        renderMultiExamList(initialData);
        initializeStudentSearch(initialData);
    });

    // ------------------------------------------------------------------
    //    æ ¸å¿ƒä¿®å¤    åœ¨è¿™é‡Œç»‘å®šâ€œæ’åç±»å‹â€å’Œâ€œå¤é€‰æ¡†â€çš„ç›‘å¬å™¨
    // ------------------------------------------------------------------

    // (ç›‘å¬: æ’åç±»å‹ä¸‹æ‹‰æ¡† - [Fix]   åŠ  async/await)
    const rankTypeSelect = document.getElementById('multi-rank-type-select');
    if (rankTypeSelect) {
        rankTypeSelect.addEventListener('change', async () => {
            const reportContainer = document.getElementById('multi-student-report');
            const currentStudentId = reportContainer.dataset.studentId;
            if (currentStudentId) {
                const data = await loadMultiExamData();
                drawMultiExamChartsAndTable(currentStudentId, data, false);
            }
        });
    }

    // (ç›‘å¬: å¤é€‰æ¡†å®¹å™¨ - [Fix]   åŠ  async/await)
    const checkboxContainer = document.getElementById('multi-subject-checkboxes');
    if (checkboxContainer) {
        checkboxContainer.addEventListener('change', async () => {
            const reportContainer = document.getElementById('multi-student-report');
            const currentStudentId = reportContainer.dataset.studentId;
            if (currentStudentId) {
                const data = await loadMultiExamData();
                drawMultiExamChartsAndTable(currentStudentId, data, false);
            }
        });
    }

    // (ç›‘å¬: å…¨é€‰ - [Fix]   åŠ  async/await)
    const selectAllBtn = document.getElementById('multi-subject-all');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', async () => {
            if (checkboxContainer) {
                checkboxContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                const reportContainer = document.getElementById('multi-student-report');
                const currentStudentId = reportContainer.dataset.studentId;
                if (currentStudentId) {
                    const data = await loadMultiExamData();
                    drawMultiExamChartsAndTable(currentStudentId, data, false);
                }
            }
        });
    }

    // (ç›‘å¬: å…¨ä¸é€‰ - [Fix]   åŠ  async/await)
    const selectNoneBtn = document.getElementById('multi-subject-none');
    if (selectNoneBtn) {
        selectNoneBtn.addEventListener('click', async () => {
            if (checkboxContainer) {
                checkboxContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                const reportContainer = document.getElementById('multi-student-report');
                const currentStudentId = reportContainer.dataset.studentId;
                if (currentStudentId) {
                    const data = await loadMultiExamData();
                    drawMultiExamChartsAndTable(currentStudentId, data, false);
                }
            }
        });
    }
}


/**
 * (    ) 10.15. æ¸²æŸ“å­¦ç§‘å…³è”çƒ­åŠ›å›¾ (Heatmap)
 *    (å·²ä¿®å¤)
 */
function renderCorrelationHeatmap(elementId, activeData) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. (æ ¸å¿ƒ) è®¡ç®—ç›¸å…³ç³»æ•°çŸ©é˜µ
    const subjects = G_DynamicSubjectList; // (å·²ç¡®è®¤æ­£ç¡®)
    const n = subjects.length;
    const heatmapData = []; // ECharts æ ¼å¼: [xIndex, yIndex, value]
    const correlationMatrix = Array(n).fill(0).map(() => Array(n).fill(0));

    // (æå–æ‰€æœ‰ç§‘ç›®çš„åˆ†æ•°æ•°ç»„ï¼Œæé«˜æ•ˆç‡)
    // (æ­¤ scoresMap æœªåœ¨æ­¤å‡½æ•°ä¸­ä½¿ç”¨, ä½†ä¿ç•™æ— å®³)
    const scoresMap = {};
    subjects.forEach(subject => {
        scoresMap[subject] = activeData.map(s => s.scores[subject]).filter(s => s !== null && s !== undefined);
    });

    //    (é€»è¾‘ä¿®å¤)
    for (let i = 0; i < n; i++) {
        for (let j = 0; j < n; j++) {

            let value = 0.0; // (é»˜è®¤å€¼)

            if (i === j) {
                value = 1.0;
                correlationMatrix[i][j] = value;

            } else if (i < j) {
                // (åªè®¡ç®—ä¸Šä¸‰è§’)
                const xSubject = subjects[i];
                const ySubject = subjects[j];

                // (å¯¹é½å­¦ç”Ÿ)
                const xScores = [];
                const yScores = [];
                activeData.forEach(student => {
                    const xScore = student.scores[xSubject];
                    const yScore = student.scores[ySubject];
                    if (xScore !== null && yScore !== null && xScore !== undefined && yScore !== undefined) {
                        xScores.push(xScore);
                        yScores.push(yScore);
                    }
                });

                const coeff = calculateCorrelation(xScores, yScores);
                value = coeff;
                correlationMatrix[i][j] = value;
                correlationMatrix[j][i] = value; // (çŸ©é˜µå¯¹ç§°)

            } else { // (i > j)
                //    (æ ¸å¿ƒä¿®å¤)
                // (æˆ‘ä»¬ä¸é‡  è®¡ç®—, è€Œæ˜¯ä»å·²å­˜çš„å¯¹ç§°çŸ©é˜µä¸­æ£€ç´¢å€¼)
                value = correlationMatrix[i][j];
            }

            // (ç°åœ¨, push é€»è¾‘åœ¨æ‰€æœ‰åˆ†æ”¯ä¹‹åæ‰§è¡Œ, ç¡®ä¿ value æ˜¯æ­£ç¡®çš„)
            heatmapData.push([
                i, // X è½´ç´¢å¼•
                j, // Y è½´ç´¢å¼•
                parseFloat(value.toFixed(2)) // å€¼
            ]);
        }
    }

    // 2. ECharts é…ç½® (ä¸å˜)
    const option = {
        title: {
            text: 'å­¦ç§‘ç›¸å…³æ€§çƒ­åŠ›å›¾',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            position: 'top',
            formatter: (params) => {
                const i = params.data[0];
                const j = params.data[1];
                const value = params.data[2];
                return `<strong>${subjects[i]}</strong> vs <strong>${subjects[j]}</strong><br/>` +
                    `ç›¸å…³ç³»æ•°: <strong>${value}</strong>`;
            }
        },
        grid: {
            height: '70%',
            top: '10%',
            bottom: '20%'
        },
        xAxis: {
            type: 'category',
            data: subjects,
            splitArea: { show: true },
            axisLabel: { rotate: 30 }
        },
        yAxis: {
            type: 'category',
            data: subjects,
            splitArea: { show: true }
        },
        visualMap: {
            min: -1,
            max: 1,
            calculable: true,
            orient: 'horizontal',
            left: 'center',
            bottom: '5%',
            inRange: {
                color: ['#dc3545', '#ffffff', '#007bff']
            }
        },
        series: [{
            name: 'ç›¸å…³ç³»æ•°',
            type: 'heatmap',
            data: heatmapData,
            label: {
                show: true,
                formatter: (params) => params.data[2]
            },
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            }
        }]
    };

    echartsInstances[elementId].setOption(option);
}

// ---------------------------------
// 10. ECharts ç»˜å›¾å‡½æ•°
// ---------------------------------
/**
 * 10.1. æ¸²æŸ“ç›´æ–¹å›¾ (å‡çº§ç‰ˆï¼šæ”¯æŒç­çº§å¯¹æ¯”)
 * - å•ç­æ¨¡å¼ï¼šæ˜¾ç¤ºé«˜äº®æŸ±çŠ¶å›¾ (Bar)
 * - å¯¹æ¯”æ¨¡å¼ï¼šæ˜¾ç¤ºå¤šç­æŠ˜çº¿å›¾ (Line)
 */
function renderHistogram(elementId, students, scoreKey, fullScore, title, binSize, isClassCompare = false) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // 1. åŸºç¡€æ•°æ®æ¸…æ´—
    if (!students || students.length === 0) {
        chartDom.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding-top: 50px;">æ— æ•°æ®å¯ä¾›æ˜¾ç¤ºã€‚</p>`;
        return;
    }

    const effectiveBinSize = binSize > 0 ? binSize : Math.max(10, Math.ceil(fullScore / 10));
    
    // 2. ç¡®å®šå…¨å±€ X è½´èŒƒå›´ (ç»Ÿä¸€åæ ‡ç³»)
    const allScores = students.map(s => (scoreKey === 'totalScore') ? s.totalScore : s.scores[scoreKey])
                              .filter(s => typeof s === 'number' && !isNaN(s));
    
    if (allScores.length === 0) {
        chartDom.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding-top: 50px;">æ— æœ‰æ•ˆåˆ†æ•°æ•°æ®ã€‚</p>`;
        return;
    }

    const minScore = Math.min(...allScores);
    const maxScore = Math.max(...allScores);
    const startBin = Math.floor(minScore / effectiveBinSize) * effectiveBinSize;
    const endBinLimit = Math.min(Math.ceil((maxScore + 0.01) / effectiveBinSize) * effectiveBinSize, fullScore);

    const labels = [];
    // ç”Ÿæˆ X è½´æ ‡ç­¾
    for (let i = startBin; i < endBinLimit; i += effectiveBinSize) {
        const end = Math.min(i + effectiveBinSize, fullScore);
        labels.push(`${i}-${end}`);
    }
    // å¦‚æœæ»¡åˆ†æ­£å¥½åœ¨åŒºé—´å¤–ï¼Œè¡¥ä¸€ä¸ª
    if (maxScore === fullScore && labels.length > 0) {
       // é€šå¸¸ä¸Šé¢çš„é€»è¾‘å·²ç»æ¶µç›–ï¼Œè¿™é‡Œåšä¸ªä¿é™©
    }

    let series = [];
    let legendData = [];
    let tooltipFormatter;

    // ============================================================
    // æ¨¡å¼ A: ç­çº§å¯¹æ¯” (å¤šæŠ˜çº¿å›¾)
    // ============================================================
    if (isClassCompare) {
        const classSet = new Set(students.map(s => s.class));
        const classes = Array.from(classSet).sort();
        const colors = ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc'];

        classes.forEach((cls, idx) => {
            const classStudents = students.filter(s => s.class === cls);
            // åˆå§‹åŒ–è¯¥ç­çš„ bins
            const bins = new Array(labels.length).fill(0);

            classStudents.forEach(s => {
                const score = (scoreKey === 'totalScore') ? s.totalScore : s.scores[scoreKey];
                if (typeof score !== 'number' || isNaN(score) || score < startBin) return;

                let binIndex = Math.floor((score - startBin) / effectiveBinSize);
                // ä¿®æ­£è¾¹ç•Œ
                if (binIndex >= labels.length) binIndex = labels.length - 1;
                bins[binIndex]++;
            });

            series.push({
                name: cls,
                type: 'line',
                smooth: 0.3,
                symbol: 'circle',
                symbolSize: 6,
                data: bins,
                itemStyle: { color: colors[idx % colors.length] },
                lineStyle: { width: 2 }
            });
            legendData.push(cls);
        });

        // å¯¹æ¯”æ¨¡å¼çš„ Tooltip
        tooltipFormatter = (params) => {
            let html = `<strong>${params[0].name} åˆ†æ•°æ®µ</strong><br/>`;
            // æŒ‰äººæ•°é™åºæ’åˆ—
            const sorted = [...params].sort((a, b) => b.value - a.value);
            sorted.forEach(p => {
                if (p.value > 0) {
                    const marker = p.marker || `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${p.color};"></span>`;
                    html += `${marker} ${p.seriesName}: <strong>${p.value}</strong>äºº<br/>`;
                }
            });
            return html;
        };

    } 
    // ============================================================
    // æ¨¡å¼ B: å•ä¸€ç¾¤ä½“ (åŸç‰ˆæŸ±çŠ¶å›¾)
    // ============================================================
    else {
        const bins = new Array(labels.length).fill(0);
        const binNames = new Array(labels.length).fill(null).map(() => []); // å­˜å‚¨åå­—

        students.forEach(s => {
            const score = (scoreKey === 'totalScore') ? s.totalScore : s.scores[scoreKey];
            if (typeof score !== 'number' || isNaN(score) || score < startBin) return;

            let binIndex = Math.floor((score - startBin) / effectiveBinSize);
            if (binIndex >= labels.length) binIndex = labels.length - 1;
            
            bins[binIndex]++;
            binNames[binIndex].push(s.name);
        });

        // è®¡ç®—æå€¼ç”¨äºé«˜äº®
        let maxVal = Math.max(...bins);
        let minVal = Infinity;
        bins.forEach(v => { if(v > 0 && v < minVal) minVal = v; });
        if (minVal === Infinity) minVal = 0;

        const seriesData = bins.map((count, i) => {
            let color = '#007bff';
            if (count === maxVal && maxVal !== 0) color = '#28a745';
            else if (count === minVal && minVal !== maxVal) color = '#dc3545';
            
            return {
                value: count,
                names: binNames[i], // å­˜åå­—ç”¨äºä¸‹é’»
                itemStyle: { color: color }
            };
        });

        series.push({
            name: 'äººæ•°',
            type: 'bar',
            data: seriesData,
            barWidth: '60%',
            label: { show: true, position: 'top' }
        });

        // å•ä½“æ¨¡å¼ Tooltip
        tooltipFormatter = (params) => {
            const p = params[0];
            const data = p.data;
            let namesHtml = "";
            if (data.names && data.names.length > 0) {
                namesHtml = `<hr style="margin:5px 0; border-color:#eee"/>` + 
                            data.names.slice(0, 10).join('<br/>');
                if (data.names.length > 10) namesHtml += `<br/>...ç­‰ ${data.names.length} äºº`;
            }
            return `<strong>${p.name}</strong><br/>äººæ•°: <strong>${p.value}</strong>${namesHtml}`;
        };
    }

    // 3. æ¸²æŸ“å›¾è¡¨
    const option = {
        title: { text: title, left: 'center', textStyle: { fontSize: 16, fontWeight: 'normal' } },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: tooltipFormatter,
            backgroundColor: 'rgba(255,255,255,0.95)',
            borderColor: '#ccc',
            textStyle: { color: '#333' }
        },
        legend: {
            show: isClassCompare,
            data: legendData,
            top: 30,
            type: 'scroll'
        },
        grid: { left: '3%', right: '4%', bottom: '20%', top: isClassCompare ? '15%' : '10%', containLabel: true },
        xAxis: {
            type: 'category',
            data: labels,
            name: 'åˆ†æ•°æ®µ',
            axisLabel: { interval: 'auto', rotate: 30 }
        },
        yAxis: { type: 'value', name: 'äººæ•°' },
        series: series,
        toolbox: {
            show: true,
            feature: { saveAsImage: { show: true, title: 'ä¿å­˜' } }
        }
    };

    myChart.setOption(option, true); // true: ä¸åˆå¹¶ï¼Œå¼ºåˆ¶é‡ç»˜

    // 4. ç‚¹å‡»äº‹ä»¶ (ä¿ç•™åŸæœ‰çš„ä¸‹é’»åŠŸèƒ½)
    // æ³¨æ„ï¼šå¯¹æ¯”æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»æŠ˜çº¿å›¾çš„ç‚¹æ¯”è¾ƒéš¾å®šä½åˆ°å…·ä½“ç­çº§ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼š
    // å¦‚æœæ˜¯å•ä½“æ¨¡å¼ï¼Œç»§ç»­æ”¯æŒç‚¹å‡»çœ‹åå•ï¼›å¦‚æœæ˜¯å¯¹æ¯”æ¨¡å¼ï¼Œæš‚ä¸æ”¯æŒï¼ˆæˆ–ç‚¹å‡»æ˜¾ç¤ºè¯¥åˆ†æ•°æ®µæ‰€æœ‰å­¦ç”Ÿï¼‰ã€‚
    // ä¸ºäº†ä»£ç ç®€æ´ï¼Œè¿™é‡Œåªä¿ç•™å•ä½“æ¨¡å¼çš„ç‚¹å‡»ï¼Œæˆ–è€…é€šç”¨é€»è¾‘ã€‚
    
    myChart.off('click'); // è§£ç»‘æ—§äº‹ä»¶
    myChart.on('click', function (params) {
        const label = params.name; 
        if (!label || !label.includes('-')) return;

        const [minStr, maxStr] = label.split('-');
        const minVal = parseFloat(minStr);
        const maxVal = parseFloat(maxStr);

        // ç¡®å®šç­›é€‰æº
        let targetStudents = students;
        // å¦‚æœæ˜¯å¯¹æ¯”æ¨¡å¼ï¼Œä¸”ç‚¹å‡»äº†æŸæ¡å…·ä½“çš„çº¿ï¼Œparams.seriesName å°±æ˜¯ç­çº§å
        if (isClassCompare && params.seriesName) {
            targetStudents = students.filter(s => s.class === params.seriesName);
        }

        const drilled = targetStudents.filter(s => {
            const val = (scoreKey === 'totalScore') ? s.totalScore : s.scores[scoreKey];
            if (typeof val !== 'number') return false;
            // ç®€å•èŒƒå›´åˆ¤æ–­
            return val >= minVal && val < (maxVal + 0.01); 
        });

        const subTitle = isClassCompare ? `${params.seriesName} - ` : "";
        showDrillDownModal(`${subTitle}${scoreKey} åˆ†æ•°æ®µ [${label}] åå•`, drilled, scoreKey);
    });
}

/**
 * 10.2. æ¸²æŸ“é›·è¾¾å›¾ (Radar)
 * @param {string} elementId - DOM å…ƒç´  ID
 * @param {Object} stats - G_Statistics å¯¹è±¡
 */
function renderAverageRadar(elementId, stats) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    const indicators = G_DynamicSubjectList.map(subject => {
        const full = G_SubjectConfigs[subject]?.full || 100;
        return { name: subject, max: full }; // (    ) max åŠ¨æ€è¯»å–é…ç½®
    });

    const averageData = G_DynamicSubjectList.map(subject => {
        return stats[subject] ? stats[subject].average : 0;
    });

    const option = {
        title: { text: 'å„ç§‘å¹³å‡åˆ†é›·è¾¾å›¾', left: 'center' },
        tooltip: { trigger: 'item' },
        radar: {
            indicator: indicators,
            radius: 120, // é›·è¾¾å›¾å¤§å°
        },
        series: [{
            name: 'ç­çº§å¹³å‡åˆ†',
            type: 'radar',
            data: [{ value: averageData, name: 'å¹³å‡åˆ†' }]
        }]
    };
    echartsInstances[elementId].setOption(option);
}

/**
 * 10.3. æ¸²æŸ“ç§‘ç›®å¯¹æ¯”æ¡å½¢å›¾ (å·²é‡æ„ï¼Œç§»é™¤æ’åº)
 *    å·²ä¿®æ”¹ï¼šé«˜äº®æ˜¾ç¤ºæœ€å¤§å€¼å’Œæœ€å°å€¼
 *    å·²ä¿®æ”¹ï¼šæ ‡ç­¾æ ¼å¼åŒ–ä¸º 2 ä½å°æ•°
 */
function renderSubjectComparisonBarChart(elementId, stats, metric) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. æå–æ•°æ®
    const data = G_DynamicSubjectList.map(subject => {
        return {
            name: subject,
            value: (stats[subject] && stats[subject][metric] !== undefined) ? stats[subject][metric] : 0
        };
    });

    // 2. å‡†å¤‡EChartsæ•°æ®
    const labels = data.map(d => d.name);
    const values = data.map(d => d.value);

    //    (    ) æ‰¾å‡ºæœ€å¤§å€¼å’Œæœ€å°å€¼
    let maxValue = -Infinity;
    let minValue = Infinity;
    // (è¿‡æ»¤æ‰ 0 æˆ–æ— æ•ˆå€¼æ¥æ‰¾æœ€å°å€¼ï¼Œé™¤éå…¨æ˜¯0)
    const validValues = values.filter(v => v > 0);
    if (validValues.length > 0) {
        minValue = Math.min(...validValues);
    } else {
        minValue = 0; // å¦‚æœéƒ½æ˜¯0ï¼Œæœ€å°å€¼å°±æ˜¯0
    }
    maxValue = Math.max(...values);

    //    (    ) å‡†å¤‡ Series æ•°æ®ï¼Œç”¨äºé«˜äº®
    const seriesData = values.map(value => {
        let color;
        if (value === maxValue && maxValue !== 0) {
            color = '#28a745'; // Green
        } else if (value === minValue && minValue !== maxValue) {
            color = '#dc3545'; // Red
        } else {
            color = '#007bff'; // Blue (Default)
        }
        return {
            value: value,
            itemStyle: { color: color }
        };
    });


    // 4. æ ¹æ®æŒ‡æ ‡ç¡®å®šå›¾è¡¨æ ‡é¢˜
    let titleText = '';
    switch (metric) {
        case 'average': titleText = 'å„ç§‘å¹³å‡åˆ†å¯¹æ¯”'; break;
        case 'passRate': titleText = 'å„ç§‘åŠæ ¼ç‡å¯¹æ¯” (%)'; break;
        case 'excellentRate': titleText = 'å„ç§‘ä¼˜ç§€ç‡å¯¹æ¯” (%)'; break;
        case 'stdDev': titleText = 'å„ç§‘æ ‡å‡†å·®å¯¹æ¯”'; break;
        case 'max': titleText = 'å„ç§‘æœ€é«˜åˆ†å¯¹æ¯”'; break;
        case 'difficulty': titleText = 'å„ç§‘éš¾åº¦ç³»æ•°å¯¹æ¯”'; break;
        default: titleText = 'ç§‘ç›®å¯¹æ¯”';
    }

    const option = {
        title: { text: titleText, left: 'center', textStyle: { fontSize: 16, fontWeight: 'normal' } },
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        grid: { left: '3%', right: '8%', bottom: '3%', containLabel: true },
        xAxis: { type: 'category', data: labels, name: 'ç§‘ç›®', axisLabel: { rotate: 30 } },
        yAxis: { type: 'value', name: metric.includes('Rate') ? '%' : 'åˆ†æ•°' },
        series: [{
            name: titleText,
            type: 'bar',
            data: seriesData, //    ä½¿ç”¨  çš„ seriesData
            barWidth: '60%',
            label: {
                show: true,
                position: 'top',
                formatter: (params) => parseFloat(params.value).toFixed(2)
            }
        }],
        toolbox: {
            show: true,
            feature: {
                saveAsImage: { show: true, title: 'ä¿å­˜ä¸ºå›¾ç‰‡' }
            }
        }
    };
    echartsInstances[elementId].setOption(option);
}

/**
 * (    ) 10.4. æ¸²æŸ“ç­çº§å¯¹æ¯”æ¡å½¢å›¾
 *    å·²ä¿®æ”¹ï¼šé«˜äº®æ˜¾ç¤ºæœ€å¤§å€¼(ç»¿è‰²)å’Œæœ€å°å€¼(çº¢è‰²)
 */
function renderClassComparisonChart(elementId, data, title) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    //      æ‰¾å‡ºæœ€å¤§å€¼å’Œæœ€å°å€¼
    let maxValue = -Infinity;
    let minValue = Infinity;
    const values = data.map(d => d.value);

    const validValues = values.filter(v => v > 0);
    if (validValues.length > 0) {
        minValue = Math.min(...validValues);
    } else {
        minValue = 0;
    }
    maxValue = Math.max(...values);


    // 2. å‡†å¤‡ ECharts æ•°æ®
    const labels = data.map(d => d.name);

    //      å°† 'values' æ•°ç»„è½¬æ¢ä¸ºåŒ…å«è‡ªå®šä¹‰æ ·å¼çš„ 'seriesData' æ•°ç»„
    const seriesData = data.map(d => {
        const isMax = (d.value === maxValue && maxValue !== 0);
        const isMin = (d.value === minValue && minValue !== maxValue);

        let color;
        if (isMax) {
            color = '#28a745'; // Green
        } else if (isMin) {
            color = '#dc3545'; // Red
        } else {
            color = '#007bff'; // Blue (Default)
        }

        return {
            value: d.value,
            itemStyle: { color: color }
        };
    });


    const option = {
        title: { text: title, left: 'center', textStyle: { fontSize: 16, fontWeight: 'normal' } },
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        grid: { left: '3%', right: '8%', bottom: '3%', containLabel: true },
        xAxis: {
            type: 'category',
            data: labels,
            name: 'ç­çº§',
            axisLabel: {
                interval: 0,
                rotate: 30
            }
        },
        yAxis: { type: 'value', name: 'æ•°å€¼' },
        series: [{
            name: title,
            type: 'bar',
            data: seriesData, //      ä½¿ç”¨  çš„ seriesData
            barWidth: '60%',
            label: {
                show: true,
                position: 'top',
                formatter: (params) => parseFloat(params.value).toFixed(1)
            }
        }],
        toolbox: {
            show: true,
            feature: {
                saveAsImage: { show: true, title: 'ä¿å­˜ä¸ºå›¾ç‰‡' }
            }
        }
    };
    echartsInstances[elementId].setOption(option);
}

/**
 *    10.5. æ¸²æŸ“å¤šç§‘ç›®ç®±å½¢å›¾
 *      æ‰‹åŠ¨è®¡ç®—ç®±å½¢å›¾æ•°æ®ï¼Œä»¥ä¾¿åœ¨å¼‚å¸¸å€¼ä¸­æ˜¾ç¤ºå­¦ç”Ÿå§“å
 * @param {string} elementId
 * @param {Object} stats - G_Statistics
 * @param {Array} activeData - ä¼ å…¥å­¦ç”Ÿæ•°æ®
 */
function renderSubjectBoxPlot(elementId, stats, activeData) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1.    (    ) è¾…åŠ©å‡½æ•°ï¼šæ‰‹åŠ¨è®¡ç®—åˆ†ä½æ•°
    const getQuartiles = (scores) => {
        if (!scores || scores.length === 0) return { q1: 0, q2: 0, q3: 0 };
        // (æ³¨æ„) stats.scores å·²ç»æ˜¯æ’å¥½åºçš„
        const n = scores.length;
        const q1Index = Math.floor(n * 0.25);
        const q2Index = Math.floor(n * 0.5);
        const q3Index = Math.floor(n * 0.75);
        return {
            q1: scores[q1Index],
            q2: scores[q2Index], // ä¸­ä½æ•°
            q3: scores[q3Index]
        };
    };

    const boxData = [];    // å­˜å‚¨ç®±ä½“æ•°æ®
    const scatterData = []; // å­˜å‚¨å¼‚å¸¸å€¼æ•°æ® (å¸¦å§“å)
    const labels = G_DynamicSubjectList;

    // 2.      éå†æ‰€æœ‰ç§‘ç›®
    labels.forEach((subject, subjectIndex) => {
        const s = stats[subject];
        // (å¦‚æœè¯¥ç§‘ç›®æ²¡æœ‰æ•°æ®ï¼Œè·³è¿‡)
        if (!s || !s.scores || s.scores.length === 0) return;

        // 2.1 è®¡ç®—å››åˆ†ä½æ•°å’Œ IQR (ç®±ä½“)
        const { q1, q2, q3 } = getQuartiles(s.scores);
        const iqr = q3 - q1;

        // 2.2 è®¡ç®—ä¸Šä¸‹é™ (èƒ¡é¡»)
        const lowerWhiskerLimit = q1 - 1.5 * iqr;
        const upperWhiskerLimit = q3 + 1.5 * iqr;

        // 2.3 æ‰¾åˆ°èƒ¡é¡»çš„å®é™…ä½ç½® (åœ¨é™åˆ¶å†…çš„çœŸå® min/max)
        let actualMin = Infinity;
        let actualMax = -Infinity;
        s.scores.forEach(score => {
            if (score >= lowerWhiskerLimit && score < actualMin) actualMin = score;
            if (score <= upperWhiskerLimit && score > actualMax) actualMax = score;
        });
        // (å¤„ç†æç«¯æƒ…å†µï¼Œå¦‚æœæ‰€æœ‰å€¼éƒ½æ˜¯å¼‚å¸¸å€¼)
        if (actualMin === Infinity) actualMin = q1;
        if (actualMax === -Infinity) actualMax = q3;

        // 2.4 æ·»åŠ ç®±ä½“æ•°æ®
        // ECharts æ ¼å¼: [min, q1, q2, q3, max]
        boxData.push([actualMin, q1, q2, q3, actualMax]);

        // 2.5 (æ ¸å¿ƒ) éå† activeData æŸ¥æ‰¾å¼‚å¸¸å€¼å­¦ç”Ÿ
        activeData.forEach(student => {
            const score = student.scores[subject];
            if (score !== null && score !== undefined) {
                // (å¦‚æœåˆ†æ•°åœ¨èƒ¡é¡»ä¹‹å¤–ï¼Œåˆ™ä¸ºå¼‚å¸¸å€¼)
                if (score > upperWhiskerLimit || score < lowerWhiskerLimit) {
                    scatterData.push({
                        name: `${student.name} (${student.class})`, //    (    ) å­˜å‚¨å­¦ç”Ÿä¿¡æ¯
                        value: [subjectIndex, score] // [Xè½´ç´¢å¼•, Yè½´åˆ†æ•°]
                    });
                }
            }
        });
    });

    // 3.    (åˆ é™¤) ç§»é™¤ dataTool
    // const allScores = ...
    // const boxplotData = echarts.dataTool.prepareBoxplotData(allScores);

    // 4.   ECharts é…ç½®
    const option = {
        title: {
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'item',
            axisPointer: { type: 'shadow' }
        },
        grid: { left: '10%', right: '5%', bottom: '15%' },
        xAxis: {
            type: 'category',
            data: labels, //    (ä¿®æ”¹)
            boundaryGap: true,
            nameGap: 30,
            axisLabel: { rotate: 30 }
        },
        yAxis: {
            type: 'value',
            name: 'åˆ†æ•°',
            splitArea: { show: true }
        },
        series: [
            {
                name: 'ç®±å½¢å›¾',
                type: 'boxplot',
                data: boxData, //    (ä¿®æ”¹)
                tooltip: {
                    formatter: function (param) {
                        // param.data[0] æ˜¯ xAxis ç´¢å¼•, param.data[1-5] æ˜¯ [min, q1, q2, q3, max]
                        return [
                            '<strong>' + labels[param.dataIndex] + '</strong>',
                            'æœ€å¤§å€¼ (ä¸Šé¡»): ' + param.data[5],
                            'ä¸Šå››åˆ†ä½ (Q3): ' + param.data[4],
                            'ä¸­ä½æ•° (Q2): ' + param.data[3],
                            'ä¸‹å››åˆ†ä½ (Q1): ' + param.data[2],
                            'æœ€å°å€¼ (ä¸‹é¡»): ' + param.data[1]
                        ].join('<br/>');
                    }
                }
            },
            {
                name: 'å¼‚å¸¸å€¼',
                type: 'scatter',
                data: scatterData, //    (ä¿®æ”¹)
                //    (    ) ä¸ºå¼‚å¸¸å€¼å®šåˆ¶ Tooltip
                tooltip: {
                    formatter: function (param) {
                        // param.data æ˜¯ { name: '...', value: [...] }
                        return `<strong>${param.data.name}</strong><br/>` +
                            `${labels[param.data.value[0]]}: <strong>${param.data.value[1]}</strong>åˆ†`;
                    }
                }
            }
        ],
        toolbox: {
            show: true,
            feature: {
                saveAsImage: { show: true, title: 'ä¿å­˜ä¸ºå›¾ç‰‡' }
            }
        }
    };
    echartsInstances[elementId].setOption(option);
}
/**
 * 10.6. æ¸²æŸ“å­¦ç§‘å…³è”æ€§æ•£ç‚¹å›¾
 * ç°åœ¨è°ƒç”¨ calculateCorrelation() è¾…åŠ©å‡½æ•°
 */
function renderCorrelationScatterPlot(elementId, activeData, xSubject, ySubject) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom || !activeData) return;

    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. å‡†å¤‡æ•°æ®: [ [xScore, yScore], ... ]
    const scatterData = [];
    const xScores = []; // (ç”¨äºè®¡ç®—ç›¸å…³ç³»æ•°)
    const yScores = []; // (ç”¨äºè®¡ç®—ç›¸å…³ç³»æ•°)

    activeData.forEach(student => {
        const xScore = student.scores[xSubject];
        const yScore = student.scores[ySubject];

        if (xScore !== null && yScore !== null && xScore !== undefined && yScore !== undefined) {
            scatterData.push([xScore, yScore]);
            xScores.push(xScore);
            yScores.push(yScore);
        }
    });
    const correlationCoefficient = calculateCorrelation(xScores, yScores);
    const formattedCorrelation = correlationCoefficient.toFixed(2);

    // 3. ç¡®å®šå›¾è¡¨çš„ X/Y è½´æœ€å¤§å€¼
    const maxX = G_SubjectConfigs[xSubject]?.full || 150;
    const maxY = G_SubjectConfigs[ySubject]?.full || 150;

    const option = {
        title: {
            text: `${xSubject} vs ${ySubject} æˆç»©å…³è”æ€§ (ç›¸å…³ç³»æ•°: ${formattedCorrelation})`,
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        grid: { left: '10%', right: '10%', bottom: '15%', top: '15%' },
        tooltip: {
            trigger: 'item',
            formatter: (params) => {
                if (params.seriesType === 'scatter') {
                    return `å­¦ç”Ÿåˆ†æ•°<br/>${xSubject}: ${params.data[0]}åˆ†<br/>${ySubject}: ${params.data[1]}åˆ†`;
                }
                return params.name;
            }
        },
        xAxis: {
            type: 'value',
            name: xSubject,
            min: 0,
            max: maxX,
            splitLine: { show: false }
        },
        yAxis: {
            type: 'value',
            name: ySubject,
            min: 0,
            max: maxY,
            splitLine: { show: false }
        },
        series: [{
            name: 'å­¦ç”Ÿ',
            type: 'scatter',
            data: scatterData,
            symbolSize: 6,
            emphasis: {
                focus: 'series'
            },
            itemStyle: {
                opacity: 0.6
            },

            markLine: {
                silent: true,
                animation: false,
                lineStyle: {
                    color: '#9932CC',
                    type: 'dashed',
                    width: 2
                },
                symbol: 'none',
                data: [
                    [
                        {
                            name: 'æ¯”ä¾‹çº¿',
                            coord: [0, 0],
                            label: { show: false }
                        },
                        {
                            coord: [maxX, maxY],
                            label: {
                                show: true,
                                formatter: 'æ¯”ä¾‹çº¿',
                                position: 'end',
                                color: '#9932CC'
                            }
                        }
                    ]
                ]
            }
        }],
        toolbox: {
            show: true,
            feature: {
                saveAsImage: { show: true, title: 'ä¿å­˜ä¸ºå›¾ç‰‡' }
            }
        }
    };

    echartsInstances[elementId].setOption(option, true);
}


/**
 * 10.7. æ¸²æŸ“ A/B/C/D å †å ç™¾åˆ†æ¯”æ¡å½¢å›¾
 * A/B/C/D çš„åˆ†ç•Œçº¿ç°åœ¨ä» config.good è¯»å–
 */
function renderStackedBar(elementId, stats, configs) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    echartsInstances[elementId] = echarts.init(chartDom);

    const categories = G_DynamicSubjectList;

    let aData = []; // A (ä¼˜ç§€)
    let bData = []; // B (è‰¯å¥½)
    let cData = []; // C (åŠæ ¼)
    let dData = []; // D (ä¸åŠæ ¼)

    categories.forEach(subject => {
        const s = stats[subject];
        const config = configs[subject];

        if (!s || !config || !s.scores || s.scores.length === 0) {
            aData.push(0);
            bData.push(0);
            cData.push(0);
            dData.push(0);
            return;
        }

        const excelLine = config.excel;
        const passLine = config.pass;
        //    æ ¸å¿ƒä¿®æ­£ï¼šä»é…ç½®ä¸­è¯»å–å¯å®šä¹‰çš„ "è‰¯å¥½çº¿"
        const goodLine = config.good;
        const totalCount = s.scores.length;

        let countA = 0;
        let countB = 0;
        let countC = 0;
        let countD = 0;

        // éå†è¯¥ç§‘ç›®çš„æ‰€æœ‰åˆ†æ•°ï¼Œè¿›è¡Œ 4 çº§åˆ†ç®±
        s.scores.forEach(score => {
            if (score >= excelLine) {
                countA++;
            } else if (score >= goodLine) { // (å·²ä½äº excelLine)
                countB++;
            } else if (score >= passLine) { // (å·²ä½äº goodLine)
                countC++;
            } else { // (å·²ä½äº passLine)
                countD++;
            }
        });

        // è½¬æ¢ä¸ºç™¾åˆ†æ¯”
        aData.push(parseFloat(((countA / totalCount) * 100).toFixed(1)));
        bData.push(parseFloat(((countB / totalCount) * 100).toFixed(1)));
        cData.push(parseFloat(((countC / totalCount) * 100).toFixed(1)));
        dData.push(parseFloat(((countD / totalCount) * 100).toFixed(1)));
    });

    const option = {
        title: {
            text: 'å„ç§‘ A/B/C/D æ„æˆ (ç™¾åˆ†æ¯”)',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: (params) => {
                let tooltipHtml = `<strong>${params[0].name}</strong><br/>`;
                params.reverse().forEach(p => {
                    tooltipHtml += `${p.marker} ${p.seriesName}: ${p.value.toFixed(1)}%<br/>`;
                });
                return tooltipHtml;
            }
        },
        legend: { top: 30 },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: { rotate: 30 }
        },
        yAxis: {
            type: 'value',
            name: 'ç™¾åˆ†æ¯” (%)',
            min: 0,
            max: 100
        },
        series: [
            {
                name: 'D (ä¸åŠæ ¼)',
                type: 'bar',
                stack: 'total',
                emphasis: { focus: 'series' },
                data: dData,
                color: '#dc3545' // (var(--color-red))
            },
            {
                name: 'C (åŠæ ¼)',
                type: 'bar',
                stack: 'total',
                emphasis: { focus: 'series' },
                data: cData,
                color: '#ffc107' // (var(--color-yellow))
            },
            {
                name: 'B (è‰¯å¥½)',
                type: 'bar',
                stack: 'total',
                emphasis: { focus: 'series' },
                data: bData,
                color: '#007bff' // (var(--color-blue))
            },
            {
                name: 'A (ä¼˜ç§€)',
                type: 'bar',
                stack: 'total',
                barWidth: '60%',
                emphasis: { focus: 'series' },
                data: aData,
                color: '#28a745' // (var(--color-green))
            }
        ],
        toolbox: {
            show: true,
            feature: {
                saveAsImage: { show: true, title: 'ä¿å­˜ä¸ºå›¾ç‰‡' }
            }
        }
    };
    echartsInstances[elementId].setOption(option);
}

/**
 *    10.8. æ¸²æŸ“å­¦ç”Ÿä¸ªä½“ vs å¹´çº§å¹³å‡é›·è¾¾å›¾
 *        äº†é¢œè‰²åŒºåˆ†
 */
function renderStudentRadar(elementId, student, stats) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. å‡†å¤‡é›·è¾¾å›¾æŒ‡ç¤ºå™¨ (max è®¾ä¸º 100, å› ä¸ºæˆ‘ä»¬ç”¨å¾—åˆ†ç‡)
    const indicators = G_DynamicSubjectList.map(subject => {
        return { name: subject, max: 100 };
    });

    // 2. è®¡ç®— "å­¦ç”Ÿå¾—åˆ†ç‡"
    const studentData = G_DynamicSubjectList.map(subject => {
        const score = student.scores[subject] || 0;
        const full = G_SubjectConfigs[subject]?.full;
        if (!full || full === 0) return 0; // é¿å…é™¤ä»¥é›¶
        return parseFloat(((score / full) * 100).toFixed(1));
    });

    // 3. è®¡ç®— "å¹´çº§å¹³å‡å¾—åˆ†ç‡"
    const averageData = G_DynamicSubjectList.map(subject => {
        const avgScore = stats[subject]?.average || 0;
        const full = G_SubjectConfigs[subject]?.full;
        if (!full || full === 0) return 0; // é¿å…é™¤ä»¥é›¶
        return parseFloat(((avgScore / full) * 100).toFixed(1));
    });

    const option = {
        title: {
            text: 'å­¦ç”Ÿ vs å¹´çº§å¹³å‡ (å¾—åˆ†ç‡ %)',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'item',
            formatter: (params) => {
                let s = `<strong>${params.name}</strong><br/>`;
                //    ä¿®æ­£ï¼štooltip ä¸­ä¹Ÿæ˜¾ç¤ºå¯¹åº”çš„é¢œè‰²æ ‡è®°
                let studentColor = '#28a745'; // å­¦ç”Ÿçš„é¢œè‰²
                let averageColor = '#007bff'; // å¹´çº§å¹³å‡çš„é¢œè‰²

                if (params.seriesName === 'å­¦ç”Ÿ vs å¹´çº§å¹³å‡') {
                    // å½“ hover åˆ°çº¿æ®µæ—¶ï¼Œparams.value[0]æ˜¯å­¦ç”Ÿæ•°æ®ï¼Œparams.value[1]æ˜¯å¹´çº§å¹³å‡æ•°æ®
                    s += `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${studentColor};"></span> å­¦ç”Ÿ: ${studentData[params.dataIndex]}%<br/>`;
                    s += `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${averageColor};"></span> å¹´çº§å¹³å‡: ${averageData[params.dataIndex]}%`;
                } else if (params.seriesName === 'å­¦ç”Ÿ') { // ç›´æ¥hoveråˆ°â€œå­¦ç”Ÿâ€çš„å›¾ä¾‹
                    s += `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${studentColor};"></span> ${params.name}: ${params.value}%`;
                } else if (params.seriesName === 'å¹´çº§å¹³å‡') { // ç›´æ¥hoveråˆ°â€œå¹´çº§å¹³å‡â€çš„å›¾ä¾‹
                    s += `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${averageColor};"></span> ${params.name}: ${params.value}%`;
                }
                return s;
            }
        },
        legend: {
            data: ['å­¦ç”Ÿ', 'å¹´çº§å¹³å‡'],
            bottom: 10
        },
        radar: {
            indicator: indicators,
            radius: '65%', // é›·è¾¾å›¾å¤§å°
            splitArea: {
                areaStyle: {
                    color: ['rgba(250,250,250,0.3)', 'rgba(200,200,200,0.3)']
                }
            }
        },
        series: [{
            name: 'å­¦ç”Ÿ vs å¹´çº§å¹³å‡',
            type: 'radar',
            //    æ·»åŠ é¢œè‰²é…ç½®
            itemStyle: {
                color: '#28a745' // å­¦ç”Ÿçº¿çš„é¢œè‰² (ç»¿è‰²)
            },
            lineStyle: {
                color: '#28a745' // å­¦ç”Ÿçº¿çš„é¢œè‰² (ç»¿è‰²)
            },
            data: [
                {
                    value: studentData,
                    name: 'å­¦ç”Ÿ',
                    //    æ·»åŠ åŒºåŸŸé¢œè‰²
                    areaStyle: {
                        opacity: 0.4,
                        color: '#28a745' // å­¦ç”ŸåŒºåŸŸçš„é¢œè‰² (ç»¿è‰²)
                    },
                    itemStyle: { // å•ç‹¬ä¸ºå­¦ç”Ÿæ•°æ®ç‚¹è®¾ç½®é¢œè‰²
                        color: '#28a745'
                    },
                    lineStyle: { // å•ç‹¬ä¸ºå­¦ç”Ÿæ•°æ®çº¿è®¾ç½®é¢œè‰²
                        color: '#28a745'
                    }
                },
                {
                    value: averageData,
                    name: 'å¹´çº§å¹³å‡',
                    //    æ·»åŠ åŒºåŸŸé¢œè‰²
                    areaStyle: {
                        opacity: 0.2,
                        color: '#007bff' // å¹´çº§å¹³å‡åŒºåŸŸçš„é¢œè‰² (è“è‰²)
                    },
                    itemStyle: { // å•ç‹¬ä¸ºå¹´çº§å¹³å‡æ•°æ®ç‚¹è®¾ç½®é¢œè‰²
                        color: '#007bff'
                    },
                    lineStyle: { // å•ç‹¬ä¸ºå¹´çº§å¹³å‡æ•°æ®çº¿è®¾ç½®é¢œè‰²
                        color: '#007bff'
                    }
                }
            ]
        }],
        toolbox: {
            show: true,
            feature: {
                saveAsImage: { show: true, title: 'ä¿å­˜ä¸ºå›¾ç‰‡' }
            }
        }
    };
    echartsInstances[elementId].setOption(option);
}


/**
 * (    ) 10.9. æ¸²æŸ“ éš¾åº¦-åŒºåˆ†åº¦ æ•£ç‚¹å›¾
 * (ç”¨äºè¯•å·ç§‘ç›®åˆ†ææ¨¡å—)
 * @param {string} elementId - DOM å…ƒç´  ID
 * @param {Object} stats - G_Statistics
 */
/**
 * (    ) 10.9. æ¸²æŸ“ éš¾åº¦-åŒºåˆ†åº¦ æ•£ç‚¹å›¾ (ä¿®å¤ç‰ˆï¼šå¸¦åå­—è±¡é™çº¿)
 *         markLine åŠŸèƒ½ï¼Œè‡ªåŠ¨ç”»å‡ºå¹³å‡çº¿ï¼Œå½¢æˆå››ä¸ªè±¡é™
 */
function renderDifficultyScatter(elementId, stats) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. å‡†å¤‡æ•°æ®
    const scatterData = G_DynamicSubjectList.map(subject => {
        const s = stats[subject];
        if (!s) return null;

        const fullMark = G_SubjectConfigs[subject]?.full || 100;
        // æ°”æ³¡å¤§å°ç¼©æ”¾é€»è¾‘
        const bubbleSize = Math.sqrt(fullMark) * 2.5;

        return {
            name: subject,
            value: [
                s.difficulty,  // X: éš¾åº¦
                s.stdDev,      // Y: åŒºåˆ†åº¦
                bubbleSize,    // Size
                subject        // Name
            ],
            //    ç»™æ°”æ³¡åŠ ä¸ªé¢œè‰²ï¼Œè¯­æ•°è‹±æ·±ä¸€ç‚¹
            itemStyle: {
                color: (['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­'].includes(subject)) ? '#007bff' : '#6cb2eb',
                opacity: 0.8
            }
        };
    }).filter(d => d !== null);

    // 2. æ¸²æŸ“å›¾è¡¨
    const option = {
        title: {
            text: 'éš¾åº¦ (X) vs åŒºåˆ†åº¦ (Y)',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(255,255,255,0.9)',
            formatter: (params) => {
                const data = params.data;
                // params.value: [éš¾åº¦, åŒºåˆ†åº¦, å¤§å°, ç§‘ç›®]
                return `<strong>${data.value[3]}</strong><br/>` +
                    `éš¾åº¦ç³»æ•°: <strong>${data.value[0]}</strong> (è¶Šå³è¶Šç®€å•)<br/>` +
                    `åŒºåˆ†åº¦: <strong>${data.value[1]}</strong> (è¶Šä¸Šè¶Šæ‹‰åˆ†)`;
            }
        },
        grid: { left: '10%', right: '10%', bottom: '15%', top: '15%' },
        xAxis: {
            type: 'value',
            name: 'éš¾åº¦ (ç®€å• â†’)',
            nameLocation: 'end',
            min: 0,
            max: 1.0,
            splitLine: { show: false } // éšè—é»˜è®¤ç½‘æ ¼ï¼Œä¸ºäº†çœ‹æ¸…åå­—çº¿
        },
        yAxis: {
            type: 'value',
            name: 'åŒºåˆ†åº¦ (æ‹‰åˆ† â†‘)',
            nameLocation: 'end',
            splitLine: { show: false } // éšè—é»˜è®¤ç½‘æ ¼
        },
        series: [{
            name: 'ç§‘ç›®',
            type: 'scatter',
            data: scatterData,
            symbolSize: (data) => data[2],
            label: {
                show: true,
                formatter: (param) => param.data.name,
                position: 'top',
                color: '#333',
                fontWeight: 'bold'
            },
            //    æ ¸å¿ƒä¿®æ”¹    æ·»åŠ åå­—è¾…åŠ©çº¿ (MarkLine)
            markLine: {
                silent: true, // é¼ æ ‡æ”¾ä¸Šå»ä¸è§¦å‘æ•ˆæœ
                symbol: 'none', // ä¸è¦ç®­å¤´
                lineStyle: {
                    type: 'dashed',
                    color: '#999',
                    width: 1.5
                },
                label: {
                    show: true,
                    position: 'end', // æ–‡å­—æ˜¾ç¤ºåœ¨çº¿çš„æœ«ç«¯
                    formatter: '{b}: {c}'
                },
                data: [
                    // 1. å‚ç›´çº¿ (Xè½´å¹³å‡å€¼ - å¹³å‡éš¾åº¦)
                    {
                        type: 'average',
                        valueDim: 'x',
                        name: 'å¹³å‡éš¾åº¦',
                        label: { position: 'start', formatter: 'å¹³å‡éš¾åº¦\n{c}' }
                    },
                    // 2. æ°´å¹³çº¿ (Yè½´å¹³å‡å€¼ - å¹³å‡åŒºåˆ†åº¦)
                    {
                        type: 'average',
                        valueDim: 'y',
                        name: 'å¹³å‡åŒºåˆ†åº¦',
                        label: { position: 'end', formatter: 'å¹³å‡åŒºåˆ†åº¦ {c}' }
                    }
                ]
            },
            //    å¯é€‰    æ·»åŠ å››ä¸ªè±¡é™çš„èƒŒæ™¯è‰² (è®©åˆ†åŒºæ›´æ˜æ˜¾)
            markArea: {
                silent: true,
                itemStyle: { opacity: 0.05 }, // éå¸¸æ·¡çš„èƒŒæ™¯
                data: [
                    // å·¦ä¸Š (éš¾+æ‹‰åˆ†) - çº¢è‰²è­¦ç¤º
                    [
                        { xAxis: 0, yAxis: 'average', itemStyle: { color: '#ff0000' } },
                        { xAxis: 'average', yAxis: 100 } // 100æ˜¯Yè½´æ— é™å¤§
                    ],
                    // å³ä¸Š (æ˜“+æ‹‰åˆ†) - ç»¿è‰²ç†æƒ³
                    [
                        { xAxis: 'average', yAxis: 'average', itemStyle: { color: '#008000' } },
                        { xAxis: 1, yAxis: 100 }
                    ]
                ]
            }
        }],
        toolbox: {
            show: true,
            feature: { saveAsImage: { show: true, title: 'ä¿å­˜' } }
        }
    };
    echartsInstances[elementId].setOption(option);
}

/**
 * (    ) 10.10. æ¸²æŸ“è¿›é€€æ­¥æ•£ç‚¹å›¾ (Barbell Plot)
 * (ç”¨äºæˆç»©è¶‹åŠ¿å¯¹æ¯”æ¨¡å—)
 */
function renderTrendScatter(elementId, students) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. è¿‡æ»¤æ‰æ²¡æœ‰å¯¹æ¯”æ•°æ®çš„å­¦ç”Ÿï¼Œå¹¶æŒ‰  æ’åæ’åº
    const data = students
        .filter(s => s.oldRank !== null)
        .sort((a, b) => a.rank - b.rank); // æŒ‰  æ’åå‡åº

    const studentNames = data.map(s => s.name);

    // 2. å‡†å¤‡ "ä¸Šæ¬¡æ’å" å’Œ "æœ¬æ¬¡æ’å" çš„æ•°æ®
    const oldRankData = data.map((s, index) => [s.oldRank, index]);
    const newRankData = data.map((s, index) => [s.rank, index]);

    // 3. å‡†å¤‡ "è¿æ¥çº¿" (Barbell) çš„æ•°æ®
    const lineData = data.map((s, index) => {
        const color = s.rankDiff > 0 ? '#28a745' : s.rankDiff < 0 ? '#dc3545' : '#aaa'; // ç»¿ / çº¢ / ç°
        return {
            coords: [[s.oldRank, index], [s.rank, index]],
            lineStyle: { color: color, width: 1.5 }
        };
    });

    const option = {
        title: {
            text: 'ç­çº§æ’å è¿›é€€æ­¥ä¸€è§ˆ',
            subtext: 'æŒ‰æœ¬æ¬¡ç­æ’ (Yè½´) æ’åº',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'item',
            formatter: (params) => {
                const dataIndex = params.data[1]; // Y è½´çš„ç´¢å¼•
                const student = data[dataIndex];
                if (!student) return;

                let change = student.rankDiff > 0
                    ? `<strong style="color: #28a745;">è¿›æ­¥ ${student.rankDiff} å</strong>`
                    : student.rankDiff < 0
                        ? `<strong style="color: #dc3545;">é€€æ­¥ ${Math.abs(student.rankDiff)} å</strong>`
                        : 'æ’åä¸å˜';

                return `<strong>${student.name} (${student.id})</strong><br/>` +
                    `æœ¬æ¬¡æ’å: ${student.rank}<br/>` +
                    `ä¸Šæ¬¡æ’å: ${student.oldRank}<br/>` +
                    `<strong>${change}</strong>`;
            }
        },
        grid: { left: '3%', right: '10%', bottom: '8%', containLabel: true },
        xAxis: {
            type: 'value',
            name: 'ç­çº§æ’å',
            position: 'top',
            splitLine: { show: true },
            axisLine: { show: true },
            min: 0,
            inverse: true //    æ’å 1 åœ¨å³ä¾§
        },
        yAxis: {
            type: 'category',
            data: studentNames,
            axisLabel: { show: false }, //    å§“åå¤ªå¤š, é»˜è®¤éšè— (è§ CSS)
            axisTick: { show: false }
        },
        series: [
            {
                name: 'ä¸Šæ¬¡æ’å',
                type: 'scatter',
                data: oldRankData,
                symbolSize: 8,
                itemStyle: { color: '#aaa' }
            },
            {
                name: 'æœ¬æ¬¡æ’å',
                type: 'scatter',
                data: newRankData,
                symbolSize: 8,
                itemStyle: { color: '#007bff' }
            },
            {
                name: 'è¿›é€€',
                type: 'lines',
                data: lineData,
                symbol: 'none',
                silent: true // çº¿æ¡ä¸å“åº”é¼ æ ‡
            }
        ]
    };
    echartsInstances[elementId].setOption(option);
}

/**
 *    10.11. æ¸²æŸ“å­¦ç”Ÿè¿›é€€æ­¥æ¡å½¢å›¾
 *    ä¿®å¤ç‰ˆï¼šæ”¯æŒæŒ‰ã€å¹´çº§æ’åå˜åŒ–ã€‘æ’åº
 */
function renderRankChangeBarChart(elementId, students, sortBy = 'name', subject = 'totalScore') {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. å‡†å¤‡æ•°æ®ï¼šè®¡ç®—æŒ‡å®šç§‘ç›®çš„æ’åå˜åŒ–
    let chartData = students.map(s => {
        let classDiff = 0;
        let gradeDiff = 0;
        let valid = false; // æ ‡è®°æ˜¯å¦æœ‰å¯¹æ¯”æ•°æ®

        if (subject === 'totalScore') {
            // æ€»åˆ†é€»è¾‘ (ç›´æ¥ç”¨ç®—å¥½çš„)
            if (s.oldRank !== null) {
                classDiff = s.rankDiff;
                gradeDiff = s.gradeRankDiff;
                valid = true;
            }
        } else {
            // å•ç§‘é€»è¾‘
            const oldCR = s.oldClassRanks ? s.oldClassRanks[subject] : null;
            const newCR = s.classRanks ? s.classRanks[subject] : null;
            
            const oldGR = s.oldGradeRanks ? s.oldGradeRanks[subject] : null;
            const newGR = s.gradeRanks ? s.gradeRanks[subject] : null;

            if (oldCR !== null && newCR !== null) {
                classDiff = oldCR - newCR;
                valid = true;
            }
            if (oldGR !== null && newGR !== null) {
                gradeDiff = oldGR - newGR;
            }
        }

        return {
            name: s.name,
            rank: s.rank, // ç”¨äºæ’åº
            displayClassDiff: classDiff,
            displayGradeDiff: gradeDiff,
            valid: valid
        };
    }).filter(item => item.valid);

    // 2. æ’åº
    const sortOption = sortBy.split('_');
    const sortKey = sortOption[0]; // 'name', 'rankDiff', 'gradeRankDiff'
    const sortDir = sortOption[1] || 'asc';

    chartData.sort((a, b) => {
        if (sortKey === 'name') {
            return a.name.localeCompare(b.name);
        } 
        else if (sortKey === 'rankDiff') {
            // æŒ‰ã€ç­çº§æ’åã€‘å˜åŒ–æ’åº
            // desc: è¿›æ­¥æœ€å¤šä¼˜å…ˆ (æ­£æ•°å¤§åœ¨å‰); asc: é€€æ­¥æœ€å¤šä¼˜å…ˆ (è´Ÿæ•°å°åœ¨å‰)
            return sortDir === 'asc' 
                ? a.displayClassDiff - b.displayClassDiff 
                : b.displayClassDiff - a.displayClassDiff;
        } 
        else if (sortKey === 'gradeRankDiff') {
            // [    ] æŒ‰ã€å¹´çº§æ’åã€‘å˜åŒ–æ’åº
            return sortDir === 'asc' 
                ? a.displayGradeDiff - b.displayGradeDiff 
                : b.displayGradeDiff - a.displayGradeDiff;
        }
        return 0;
    });

    // 3. å‡†å¤‡ ECharts æ•°æ®
    const studentNames = chartData.map(s => s.name);
    const classRankDiffs = chartData.map(s => s.displayClassDiff);
    const gradeRankDiffs = chartData.map(s => s.displayGradeDiff);

    const subjectText = (subject === 'totalScore') ? 'æ€»åˆ†' : subject;
    
    // åŠ¨æ€æ˜¾ç¤ºå‰¯æ ‡é¢˜
    let subTextStr = "æ’åºæ–¹å¼: å§“å";
    if (sortKey === 'rankDiff') subTextStr = `æ’åºæ–¹å¼: ç­æ’${sortDir === 'desc' ? 'è¿›æ­¥' : 'é€€æ­¥'}å¹…åº¦`;
    if (sortKey === 'gradeRankDiff') subTextStr = `æ’åºæ–¹å¼: å¹´æ’${sortDir === 'desc' ? 'è¿›æ­¥' : 'é€€æ­¥'}å¹…åº¦`;

    const option = {
        title: {
            text: `å­¦ç”Ÿ ${subjectText} ç­æ’/å¹´æ’ å˜åŒ–`,
            subtext: subTextStr,
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: (params) => {
                const studentName = params[0].name;
                let tip = `<strong>${studentName} (${subjectText})</strong><br/>`;
                params.forEach(p => {
                    const value = p.value;
                    const change = value > 0 ? `è¿›æ­¥ ${value} å` : (value < 0 ? `é€€æ­¥ ${Math.abs(value)} å` : 'ä¸å˜');
                    tip += `${p.marker} ${p.seriesName}: ${change}<br/>`;
                });
                return tip;
            }
        },
        legend: {
            data: ['ç­æ’å˜åŒ–', 'å¹´æ’å˜åŒ–'],
            top: 50
        },
        grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true, top: 100 },
        xAxis: {
            type: 'category',
            data: studentNames,
            axisLabel: { rotate: 30, interval: 0 }
        },
        yAxis: {
            type: 'value',
            name: 'æ’åå˜åŒ– (æ­£æ•°ä¸ºè¿›æ­¥)'
        },
        dataZoom: [
            { type: 'inside', xAxisIndex: [0] },
            { type: 'slider', xAxisIndex: [0], bottom: 10, height: 20 }
        ],
        series: [
            {
                name: 'ç­æ’å˜åŒ–',
                type: 'bar',
                barWidth: '40%',
                emphasis: { focus: 'series' },
                data: classRankDiffs,
                itemStyle: { color: '#007bff' }
            },
            {
                name: 'å¹´æ’å˜åŒ–',
                type: 'bar',
                barWidth: '40%',
                emphasis: { focus: 'series' },
                data: gradeRankDiffs,
                itemStyle: { color: '#ffc107' }
            }
        ]
    };
    
    option.grid.bottom = (chartData.length > 20 ? 50 : 30) + 'px';
    option.dataZoom[1].bottom = 10;

    echartsInstances[elementId].setOption(option);
}

/**
 *    10.11. æ¸²æŸ“å­¦ç”Ÿè¿›é€€æ­¥æ¡å½¢å›¾
 *    ä¿®å¤ç‰ˆï¼šæ”¯æŒæŒ‰ã€å¹´çº§æ’åå˜åŒ–ã€‘æ’åº
 * åŠ¡å¿…æ›´  æ­¤å‡½æ•°ï¼Œå¦åˆ™ä¸‹æ‹‰æ¡†é€‰äº†æ²¡ååº”ï¼
 */
function renderRankChangeBarChart(elementId, students, sortBy = 'name', subject = 'totalScore') {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. å‡†å¤‡æ•°æ®ï¼šè®¡ç®—æŒ‡å®šç§‘ç›®çš„æ’åå˜åŒ–
    let chartData = students.map(s => {
        let classDiff = 0;
        let gradeDiff = 0;
        let valid = false; // æ ‡è®°æ˜¯å¦æœ‰å¯¹æ¯”æ•°æ®

        if (subject === 'totalScore') {
            // æ€»åˆ†é€»è¾‘ (ç›´æ¥ç”¨ç®—å¥½çš„)
            if (s.oldRank !== null && s.oldRank !== undefined) {
                classDiff = s.rankDiff;
                gradeDiff = s.gradeRankDiff;
                valid = true;
            }
        } else {
            // å•ç§‘é€»è¾‘
            const oldCR = s.oldClassRanks ? s.oldClassRanks[subject] : null;
            const newCR = s.classRanks ? s.classRanks[subject] : null;
            
            const oldGR = s.oldGradeRanks ? s.oldGradeRanks[subject] : null;
            const newGR = s.gradeRanks ? s.gradeRanks[subject] : null;

            if (oldCR !== null && newCR !== null && oldCR !== undefined && newCR !== undefined) {
                classDiff = oldCR - newCR;
                valid = true;
            }
            if (oldGR !== null && newGR !== null && oldGR !== undefined && newGR !== undefined) {
                gradeDiff = oldGR - newGR;
            }
        }

        return {
            name: s.name,
            rank: s.rank, // ç”¨äºæ’åº
            displayClassDiff: classDiff,
            displayGradeDiff: gradeDiff,
            valid: valid
        };
    }).filter(item => item.valid);

    // 2. æ’åºæ ¸å¿ƒé€»è¾‘ [å…³é”®ä¿®å¤ç‚¹]
    const sortOption = sortBy.split('_');
    const sortKey = sortOption[0]; // 'name', 'rankDiff', 'gradeRankDiff'
    const sortDir = sortOption[1] || 'asc';

    chartData.sort((a, b) => {
        if (sortKey === 'name') {
            return a.name.localeCompare(b.name);
        } 
        else if (sortKey === 'rankDiff') {
            // æŒ‰ã€ç­çº§æ’åã€‘å˜åŒ–æ’åº
            return sortDir === 'asc' 
                ? a.displayClassDiff - b.displayClassDiff 
                : b.displayClassDiff - a.displayClassDiff;
        } 
        else if (sortKey === 'gradeRankDiff') {
            // [    ] æŒ‰ã€å¹´çº§æ’åã€‘å˜åŒ–æ’åº
            return sortDir === 'asc' 
                ? a.displayGradeDiff - b.displayGradeDiff 
                : b.displayGradeDiff - a.displayGradeDiff;
        }
        return 0;
    });

    // 3. å‡†å¤‡ ECharts æ•°æ®
    const studentNames = chartData.map(s => s.name);
    const classRankDiffs = chartData.map(s => s.displayClassDiff);
    const gradeRankDiffs = chartData.map(s => s.displayGradeDiff);

    const subjectText = (subject === 'totalScore') ? 'æ€»åˆ†' : subject;
    
    // åŠ¨æ€æ˜¾ç¤ºå‰¯æ ‡é¢˜
    let subTextStr = "å½“å‰æ’åº: å§“å";
    if (sortKey === 'rankDiff') subTextStr = `å½“å‰æ’åº: ç­æ’${sortDir === 'desc' ? 'è¿›æ­¥' : 'é€€æ­¥'}å¹…åº¦`;
    if (sortKey === 'gradeRankDiff') subTextStr = `å½“å‰æ’åº: å¹´æ’${sortDir === 'desc' ? 'è¿›æ­¥' : 'é€€æ­¥'}å¹…åº¦`;

    const option = {
        title: {
            text: `å­¦ç”Ÿ ${subjectText} ç­æ’/å¹´æ’ å˜åŒ–`,
            subtext: subTextStr,
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: (params) => {
                const studentName = params[0].name;
                let tip = `<strong>${studentName} (${subjectText})</strong><br/>`;
                params.forEach(p => {
                    const value = p.value;
                    const change = value > 0 ? `è¿›æ­¥ ${value} å` : (value < 0 ? `é€€æ­¥ ${Math.abs(value)} å` : 'ä¸å˜');
                    tip += `${p.marker} ${p.seriesName}: ${change}<br/>`;
                });
                return tip;
            }
        },
        legend: {
            data: ['ç­æ’å˜åŒ–', 'å¹´æ’å˜åŒ–'],
            top: 50
        },
        grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true, top: 100 },
        xAxis: {
            type: 'category',
            data: studentNames,
            axisLabel: { rotate: 30, interval: 0 }
        },
        yAxis: {
            type: 'value',
            name: 'æ’åå˜åŒ– (æ­£æ•°ä¸ºè¿›æ­¥)'
        },
        dataZoom: [
            { type: 'inside', xAxisIndex: [0] },
            { type: 'slider', xAxisIndex: [0], bottom: 10, height: 20 }
        ],
        series: [
            {
                name: 'ç­æ’å˜åŒ–',
                type: 'bar',
                barWidth: '40%',
                emphasis: { focus: 'series' },
                data: classRankDiffs,
                itemStyle: { color: '#007bff' }
            },
            {
                name: 'å¹´æ’å˜åŒ–',
                type: 'bar',
                barWidth: '40%',
                emphasis: { focus: 'series' },
                data: gradeRankDiffs,
                itemStyle: { color: '#ffc107' }
            }
        ]
    };
    
    // è‡ªåŠ¨è°ƒæ•´åº•éƒ¨é«˜åº¦ä»¥é€‚åº”äººå
    option.grid.bottom = (chartData.length > 20 ? 50 : 30) + 'px';
    option.dataZoom[1].bottom = 10;

    echartsInstances[elementId].setOption(option);
}

/**
 * (    ) 10.16. [è¾…åŠ©å‡½æ•°] è®¡ç®—åç§‘åˆ†ææ•°æ®
 * (è¿™æ˜¯  æ¨¡å—çš„æ ¸å¿ƒ)
 */
//      æ¥æ”¶ G_Statistics
function calculateWeaknessData(students, stats) {

    // (è¾…åŠ©å‡½æ•°)
    const mean = (arr) => {
        if (!arr || arr.length === 0) return 0;
        const validArr = arr.filter(v => typeof v === 'number' && !isNaN(v)); //    (å¥å£®æ€§)
        if (validArr.length === 0) return 0;
        return validArr.reduce((sum, val) => sum + val, 0) / validArr.length;
    };
    const stdDev = (arr, meanVal) => {
        if (!arr || arr.length < 2) return 0;
        const validArr = arr.filter(v => typeof v === 'number' && !isNaN(v)); //    (å¥å£®æ€§)
        if (validArr.length < 2) return 0;
        return Math.sqrt(validArr.reduce((sum, val) => sum + Math.pow(val - meanVal, 2), 0) / validArr.length);
    };

    const results = [];

    students.forEach(student => {
        // 1.      è®¡ç®—è¯¥ç”Ÿçš„æ‰€æœ‰ "Z-Score" (æ ‡å‡†åˆ†)
        const zScores = [];
        const validSubjects = [];

        G_DynamicSubjectList.forEach(subject => {
            const subjectStat = stats[subject];
            const score = student.scores[subject];

            // (å¿…é¡»æœ‰åˆ†æ•°, ä¸”è¯¥ç§‘ç›®æœ‰ç»Ÿè®¡æ•°æ®, ä¸”æ ‡å‡†å·®ä¸ä¸º0)
            if (subjectStat && subjectStat.stdDev > 0 && score !== null && score !== undefined) {
                const z = (score - subjectStat.average) / subjectStat.stdDev;
                zScores.push(z);
                validSubjects.push(subject);
            }
        });

        if (zScores.length < 2) {
            results.push(null); // (æ•°æ®ä¸è¶³ï¼Œæ— æ³•åˆ†æåç§‘)
            return;
        }

        // 2.      è®¡ç®—è¯¥ç”Ÿçš„ "å¹³å‡Z-Score" å’Œ "Z-Scoreæ ‡å‡†å·®" (å³åç§‘ç¨‹åº¦)
        const avgZScore = mean(zScores);
        const stdDevZScore = stdDev(zScores, avgZScore);

        // 3.      è®¡ç®—æ¯ç§‘çš„ "Z-Scoreåç¦»åº¦"
        const subjectDeviations = [];
        zScores.forEach((z, index) => {
            const subject = validSubjects[index];
            subjectDeviations.push({
                subject: subject,
                zScore: parseFloat(z.toFixed(2)), //    è¯¥ç§‘Zåˆ†
                deviation: parseFloat((z - avgZScore).toFixed(2)) //    åç¦»åº¦
            });
        });

        results.push({
            student: student,
            avgZScore: parseFloat(avgZScore.toFixed(2)), //    (  ) å­¦ç”Ÿç»¼åˆèƒ½åŠ› (Zåˆ†å‡å€¼)
            stdDevZScore: parseFloat(stdDevZScore.toFixed(2)), //    (  ) å­¦ç”Ÿåç§‘ç¨‹åº¦ (Zåˆ†æ ‡å‡†å·®)
            subjectDeviations: subjectDeviations
        });
    });

    return results.filter(r => r !== null); // è¿‡æ»¤æ‰æ— æ³•åˆ†æçš„å­¦ç”Ÿ
}


/**
 * (æœ€ç»ˆä¿®å¤ç‰ˆ V4 - å®Œç¾ç‰ˆ) è§£å†³ MarkLineã€å››è‰²æ¸²æŸ“ã€queryComponents é”™è¯¯ï¼Œå¹¶å®ç° X è½´åŠ¨æ€ç¼©æ”¾ã€‚
 */
//      æ¥æ”¶ G_Statistics
function renderWeaknessScatter(elementId, weaknessData, stats) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // è¾…åŠ©å‡½æ•°: è®¡ç®—å¹³å‡å€¼
    const mean = (arr) => {
        if (!arr || arr.length === 0) return 0;
        const validArr = arr.filter(val => typeof val === 'number' && !isNaN(val));
        if (validArr.length === 0) return 0;
        return validArr.reduce((sum, val) => sum + val, 0) / validArr.length;
    };

    // 1.      è®¡ç®—å¹³å‡çº¿
    // Z-Score çš„å‡å€¼ç†è®ºä¸Šä¸º 0
    const avgZScoreLine = 0;
    // åç§‘ç¨‹åº¦çš„å‡å€¼
    const yValues = weaknessData.map(d => d.stdDevZScore).filter(v => typeof v === 'number' && !isNaN(v));
    const avgStdDev = mean(yValues);

    // 2. æ•°æ®é¢„å¤„ç†
    const quadrantData = { 'å³ä¸Š': [], 'å·¦ä¸Š': [], 'å³ä¸‹': [], 'å·¦ä¸‹': [] };
    const xValuesRaw = [];
    const yValuesRaw = [];

    weaknessData.forEach(data => {
        //      ä½¿ç”¨ Z-Score
        const x = data.avgZScore;
        const y = data.stdDevZScore;
        const studentName = data.student.name;

        if (typeof x !== 'number' || isNaN(x) || typeof y !== 'number' || isNaN(y)) return;

        xValuesRaw.push(x);
        yValuesRaw.push(y);

        const quadrantKey = (x >= avgZScoreLine ? 'å³' : 'å·¦') + (y >= avgStdDev ? 'ä¸Š' : 'ä¸‹');
        quadrantData[quadrantKey].push([x, y, studentName]);
    });

    // 3. ğŸš€      åŠ¨æ€è®¡ç®—åæ ‡è½´èŒƒå›´ (Z-Score)
    // Z-Scores æ˜¯å›´ç»• 0 å¯¹ç§°çš„
    const min_X = xValuesRaw.length > 0 ? Math.min(...xValuesRaw) : -2;
    const max_X = xValuesRaw.length > 0 ? Math.max(...xValuesRaw) : 2;
    const max_Y = yValuesRaw.length > 0 ? Math.max(...yValuesRaw) : 1.5;

    // X è½´åŠ¨æ€èŒƒå›´, è‡³å°‘ -2 åˆ° 2
    const dynamicMinX = Math.floor(Math.min(-0.5, min_X * 1.1) / 0.5) * 0.5;
    const dynamicMaxX = Math.ceil(Math.max(0.5, max_X * 1.1) / 0.5) * 0.5;
    // Y è½´åŠ¨æ€èŒƒå›´
    const dynamicMaxY = Math.ceil(Math.max(0.5, max_Y * 1.1) / 0.5) * 0.5;

    // 4. å®šä¹‰é¢œè‰²å’Œæ–‡æœ¬ (ä¿æŒä¸å˜)
    const quadrantColors = {
        'å³ä¸Š': '#dc3545', 'å·¦ä¸Š': '#ffc107', 'å³ä¸‹': '#28a745', 'å·¦ä¸‹': '#17a2b8'
    };
    const quadrantLabels = {
        'å³ä¸Š': 'å°–å­ç”Ÿä½†æœ‰çŸ­æ¿\n(é‡ç‚¹å…³æ³¨)', 'å·¦ä¸Š': 'åŸºç¡€å·®ä¸”æœ‰\næå¤§çŸ­æ¿',
        'å³ä¸‹': 'å­¦éœ¸/å…¨èƒ½å‹', 'å·¦ä¸‹': 'åŸºç¡€è–„å¼±ä½†\nå„ç§‘å‡è¡¡'
    };

    // 5. åˆå§‹ Option (ä¸åŒ…å« graphic)
    const initialOption = {
        title: { text: 'å­¦ç”Ÿèƒ½åŠ›-å‡è¡¡åº¦ å››è±¡é™å›¾ (Z-Score)', left: 'center', textStyle: { fontSize: 16, fontWeight: 'normal' } },
        tooltip: {
            trigger: 'item',
            formatter: (params) => {
                if (params.componentType === 'graphic') return '';
                const data = params.data;
                //      æ›´   Tooltip
                return `<strong>${data[2]}</strong><br/>` +
                    `ç»¼åˆèƒ½åŠ› (Z-Scoreå‡å€¼): ${data[0].toFixed(2)}<br/>` +
                    `åç§‘ç¨‹åº¦ (Z-Scoreæ ‡å‡†å·®): ${data[1].toFixed(2)}`;
            }
        },
        grid: { left: '10%', right: '10%', bottom: '10%', top: '10%' },
        xAxis: {
            type: 'value',
            //      æ›´   X è½´
            name: 'ç»¼åˆèƒ½åŠ› (å¹³å‡Z-Score)',
            nameLocation: 'middle',
            nameGap: 30,
            min: dynamicMinX,
            max: dynamicMaxX
        },
        //      æ›´   Y è½´
        yAxis: { type: 'value', name: 'åç§‘ç¨‹åº¦ (Z-Scoreæ ‡å‡†å·®)', nameLocation: 'middle', nameGap: 40, min: 0, max: dynamicMaxY },

        series: [
            // å››ä¸ªæ•£ç‚¹å›¾ç³»åˆ— (ä¿æŒä¸å˜)
            { name: 'å³ä¸Šè±¡é™', type: 'scatter', data: quadrantData['å³ä¸Š'], symbolSize: 8, itemStyle: { opacity: 0.7, color: quadrantColors['å³ä¸Š'] } },
            { name: 'å·¦ä¸Šè±¡é™', type: 'scatter', data: quadrantData['å·¦ä¸Š'], symbolSize: 8, itemStyle: { opacity: 0.7, color: quadrantColors['å·¦ä¸Š'] } },
            { name: 'å³ä¸‹è±¡é™', type: 'scatter', data: quadrantData['å³ä¸‹'], symbolSize: 8, itemStyle: { opacity: 0.7, color: quadrantColors['å³ä¸‹'] } },
            { name: 'å·¦ä¸‹è±¡é™', type: 'scatter', data: quadrantData['å·¦ä¸‹'], symbolSize: 8, itemStyle: { opacity: 0.7, color: quadrantColors['å·¦ä¸‹'] } },

            //      æ›´  è¾…åŠ© MarkLine
            {
                name: 'è¾…åŠ©çº¿', type: 'scatter', data: [],
                markLine: {
                    silent: true, animation: false, symbol: 'none',
                    lineStyle: { type: 'dashed', color: 'red' },
                    data: [
                        { xAxis: avgZScoreLine, name: 'å¹´çº§å¹³å‡çº¿', label: { formatter: 'å¹´çº§å¹³å‡(0)' } },
                        { yAxis: avgStdDev, name: 'å¹³å‡åç§‘çº¿', label: { formatter: 'å¹³å‡åç§‘' } }
                    ]
                }
            }
        ]
    };

    // 6. ç¬¬ä¸€æ¬¡æ¸²æŸ“ï¼šä¸åŒ…å« graphic ç»„ä»¶
    myChart.setOption(initialOption);

    // 7. å»¶è¿Ÿ graphic æ¸²æŸ“
    setTimeout(() => {

        const graphicElements = [];
        //      ä½¿ç”¨ Z-Score å‡å€¼çº¿
        const quadrantPositions = {
            'å³ä¸Š': [avgZScoreLine + (dynamicMaxX - avgZScoreLine) * 0.5, avgStdDev + (dynamicMaxY - avgStdDev) * 0.5],
            'å·¦ä¸Š': [dynamicMinX + (avgZScoreLine - dynamicMinX) * 0.5, avgStdDev + (dynamicMaxY - avgStdDev) * 0.5],
            'å³ä¸‹': [avgZScoreLine + (dynamicMaxX - avgZScoreLine) * 0.5, avgStdDev * 0.5],
            'å·¦ä¸‹': [dynamicMinX + (avgZScoreLine - dynamicMinX) * 0.5, avgStdDev * 0.5]
        };

        for (const key in quadrantPositions) {
            const [xCoord, yCoord] = quadrantPositions[key];

            // ç¡®ä¿åæ ‡åœ¨ grid èŒƒå›´å†…
            if (xCoord > dynamicMaxX || yCoord > dynamicMaxY || xCoord < dynamicMinX || yCoord < 0) continue;

            const [pixelX, pixelY] = myChart.convertToPixel('grid', [xCoord, yCoord]);

            graphicElements.push({
                type: 'text', left: pixelX, top: pixelY,
                style: {
                    text: quadrantLabels[key], fill: quadrantColors[key],
                    fontFamily: 'sans-serif', fontSize: 13, fontWeight: 'bold',
                    textAlign: 'center', textVerticalAlign: 'middle'
                },
                z: 100
            });
        }

        myChart.setOption({ graphic: graphicElements });

    }, 0);
}

/**
 * (ä¿®æ”¹å - æ”¯æŒæ‰“å°è€ƒè¯•åç§°) 10.18. æ¸²æŸ“â€œçŸ­æ¿â€å­¦ç”Ÿè¡¨æ ¼
 */
function renderWeaknessTable(elementId, weaknessData) {
    const tableContainer = document.getElementById(elementId);
    if (!tableContainer) return;

    // 1. åˆ›å»ºåˆ—è¡¨ï¼Œå¿…é¡»åŒ…å«ç­çº§ä¿¡æ¯
    const studentWeaknessList = weaknessData.map(data => {
        if (!data.subjectDeviations || data.subjectDeviations.length === 0) {
            return {
                name: data.student.name,
                id: data.student.id,
                className: data.student.class, // ç”¨äºç­›é€‰
                avgZScore: data.avgZScore,
                weakestSubject: 'N/A',
                weakestDeviation: 0,
                weakestZScore: 'N/A'
            };
        }

        // æ‰¾åˆ°åç¦»åº¦æœ€å°çš„ç§‘ç›®
        const weakest = data.subjectDeviations.reduce((minSub, currentSub) => {
            return currentSub.deviation < minSub.deviation ? currentSub : minSub;
        }, data.subjectDeviations[0]);

        return {
            name: data.student.name,
            id: data.student.id,
            className: data.student.class, // ç”¨äºç­›é€‰
            avgZScore: data.avgZScore,
            weakestSubject: weakest.subject,
            weakestDeviation: weakest.deviation,
            weakestZScore: weakest.zScore
        };
    });

    // 2. é»˜è®¤æ’åº
    studentWeaknessList.sort((a, b) => a.weakestDeviation - b.weakestDeviation);

    // 3. å¡«å……ç­çº§ä¸‹æ‹‰æ¡†
    const classSelect = document.getElementById('weakness-class-filter');
    if (classSelect) {
        const uniqueClasses = [...new Set(studentWeaknessList.map(s => s.className))].sort();
        let opts = `<option value="ALL">-- å…¨éƒ¨ç­çº§ --</option>`;
        uniqueClasses.forEach(c => {
            opts += `<option value="${c}">${c}</option>`;
        });
        classSelect.innerHTML = opts;
    }

    // 4. (æ ¸å¿ƒ) æ¸²æŸ“è¡¨æ ¼å‡½æ•° (æ”¯æŒ æœç´¢ + ç­çº§ç­›é€‰)
    const drawTable = () => {
        const searchTerm = document.getElementById('weakness-search').value.toLowerCase();
        const selectedClass = document.getElementById('weakness-class-filter').value;

        const filteredList = studentWeaknessList.filter(item => {
            // æœç´¢åŒ¹é…
            const matchSearch = String(item.name).toLowerCase().includes(searchTerm) ||
                String(item.id).toLowerCase().includes(searchTerm);
            // ç­çº§åŒ¹é…
            const matchClass = (selectedClass === 'ALL') || (item.className === selectedClass);

            return matchSearch && matchClass;
        });

        let html = ``;
        if (filteredList.length === 0) {
            html = `<p style="text-align: center; padding: 20px; color: var(--text-muted);">æœªæ‰¾åˆ°åŒ¹é…çš„å­¦ç”Ÿã€‚</p>`;
        } else {
            html = `
                <table>
                    <thead>
                        <tr>
                            <th>ç­çº§</th>
                            <th>å­¦ç”Ÿå§“å</th>
                            <th>è€ƒå·</th>
                            <th>æœ€å¼±ç§‘ç›®</th>
                            <th>æœ€å¼±é¡¹åç¦»åº¦</th>
                            <th>æœ€å¼±é¡¹Z-Score</th>
                            <th>å­¦ç”Ÿå¹³å‡Z-Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredList.map(item => `
                            <tr data-id="${item.id}" style="cursor: pointer;">
                                <td>${item.className}</td>
                                <td><strong>${item.name}</strong></td>
                                <td>${item.id}</td>
                                <td><strong>${item.weakestSubject}</strong></td>
                                <td><strong class="${item.weakestDeviation < -0.5 ? 'regress' : ''}">${item.weakestDeviation.toFixed(2)}</strong></td>
                                <td>${item.weakestZScore !== 'N/A' ? item.weakestZScore.toFixed(2) : 'N/A'}</td>
                                <td>${item.avgZScore.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="margin-top:10px; font-size:0.85em; color:#666; text-align:right;">
                    å…±ç­›é€‰å‡º ${filteredList.length} äºº
                </div>
            `;
        }
        tableContainer.innerHTML = html;
    };

    // 5. ç»‘å®šäº‹ä»¶
    const searchInput = document.getElementById('weakness-search');
    if (searchInput) searchInput.addEventListener('input', drawTable);
    if (classSelect) classSelect.addEventListener('change', drawTable);

    // 6. [ä¿®æ”¹] ç»‘å®šæ‰“å°æŒ‰é’®äº‹ä»¶ (è·å–è€ƒè¯•åç§°)
    const printBtn = document.getElementById('weakness-print-btn');
    if (printBtn) {
        // æ³¨æ„ï¼šè¿™é‡Œæ·»åŠ äº† async å…³é”®å­—
        printBtn.addEventListener('click', async () => {
            const content = tableContainer.innerHTML;
            if (!content || content.includes('æœªæ‰¾åˆ°åŒ¹é…')) {
                alert('å½“å‰åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•æ‰“å°ã€‚');
                return;
            }

            // [æ ¸å¿ƒä¿®æ”¹] è·å–è€ƒè¯•åç§°
            // ä¼˜å…ˆä» localforage è¯»å–ï¼Œå¦‚æœå¤±è´¥åˆ™å°è¯• localStorage æˆ–ä½¿ç”¨é»˜è®¤å€¼
            let examName = "æœ¬æ¬¡è€ƒè¯•";
            try {
                const name = await localforage.getItem('G_MainFileName');
                if (name) examName = name;
                else {
                    // é™çº§å°è¯•
                    examName = localStorage.getItem('G_MainFileName') || "æœ¬æ¬¡è€ƒè¯•";
                }
            } catch (e) {
                console.warn("æ— æ³•è¯»å–è€ƒè¯•åç§°", e);
            }

            // è·å–å½“å‰ç­›é€‰çš„ç­çº§åç§°ä»¥ä¾¿å±•ç¤º
            const selectedClassVal = document.getElementById('weakness-class-filter').value;
            const subTitle = selectedClassVal === 'ALL' ? 'å…¨ä½“å­¦ç”Ÿ' : selectedClassVal;

            // æ„å»ºæ‰“å°é¡µ
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>${examName} - åç§‘è¯Šæ–­è¡¨</title>
                    <style>
                        body { font-family: "Segoe UI", Arial, sans-serif; padding: 30px; color: #333; }
                        h2 { text-align: center; margin-bottom: 5px; }
                        h4 { text-align: center; margin-top: 0; color: #666; font-weight: normal; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
                        th { background-color: #f0f0f0; }
                        .regress { color: red; font-weight: bold; }
                        @media print {
                           .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h2>${examName} - å­¦ç”Ÿåç§‘è¯Šæ–­è¡¨</h2>
                    <h4>èŒƒå›´ï¼š${subTitle} | ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}</h4>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 500);
        });
    }

    // 7. åˆå§‹ç»˜åˆ¶
    drawTable();
}

/**
 * (    ) 10.19. æ¸²æŸ“å•ä¸ªå­¦ç”Ÿçš„è¯¦ç»†åç§‘è¡¨
 * (åœ¨ renderWeaknessTable ä¹‹åè°ƒç”¨)
 */
function renderWeaknessDetail(containerElement, studentData) {
    const student = studentData.student;
    const deviations = [...studentData.subjectDeviations]; // å¤åˆ¶æ•°ç»„

    // æŒ‰åç¦»åº¦å‡åºæ’åº (æœ€å¼±çš„åœ¨æœ€å‰é¢)
    deviations.sort((a, b) => a.deviation - b.deviation);

    let html = `
        <h4>${student.name} (${student.id}) - å„ç§‘åç¦»åº¦è¯¦æƒ…</h4>
        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
            <table>
                <thead>
                    <tr>
                        <th>ç§‘ç›®</th>
                        <th>ç§‘ç›®åˆ†æ•°</th> <th>è¯¥ç§‘Z-Score</th>
                        <th>å­¦ç”Ÿå¹³å‡Z-Score</th>
                        <th>åç¦»åº¦ (è¯¥ç§‘Z - å‡Z)</th>
                    </tr>
                </thead>
                <tbody>
                    ${deviations.map(item => `
                        <tr>
                            <td><strong>${item.subject}</strong></td>
                            
                            <td style="font-weight:bold; color:#555;">
                                ${student.scores[item.subject] !== undefined ? student.scores[item.subject] : '-'}
                            </td>
                            
                            <td>${item.zScore.toFixed(2)}</td>
                            <td>${studentData.avgZScore.toFixed(2)}</td>
                            <td>
                                <strong class="${item.deviation < -0.5 ? 'regress' : (item.deviation > 0.5 ? 'progress' : '')}">
                                    ${item.deviation.toFixed(2)}
                                </strong>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    containerElement.innerHTML = html;
}


// ---------------------------------
// (    ) 10.21. æ¸²æŸ“ä¸åŠæ ¼ç§‘ç›®æ•°æ¡å½¢å›¾
// ---------------------------------
function renderFailureCountChart(elementId, failureCounts) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    const labels = Object.keys(failureCounts).sort((a, b) => a - b);
    const data = labels.map(key => failureCounts[key]);

    const option = {
        title: {
            text: 'ä¸åŠæ ¼ç§‘ç›®æ•°é‡åˆ†å¸ƒ',
            subtext: 'Xè½´: ä¸åŠæ ¼(å«ç¼ºè€ƒ)çš„ç§‘ç›®æ•°, Yè½´: å­¦ç”Ÿäººæ•°',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: (params) => {
                const p = params[0];
                return `<strong>${p.name} ç§‘</strong><br/>å­¦ç”Ÿäººæ•°: <strong>${p.value}</strong>äºº`;
            }
        },
        grid: { left: '10%', right: '5%', bottom: '15%' },
        xAxis: {
            type: 'category',
            data: labels,
            name: 'ä¸åŠæ ¼ç§‘ç›®æ•°'
        },
        yAxis: {
            type: 'value',
            name: 'å­¦ç”Ÿäººæ•°'
        },
        series: [{
            name: 'äººæ•°',
            type: 'bar',
            data: data,
            barWidth: '60%',
            label: {
                show: true,
                position: 'top'
            },
            itemStyle: {
                color: (params) => {
                    const failCount = parseInt(params.name);
                    if (failCount === 0) return '#28a745'; // å…¨åŠæ ¼ (ç»¿)
                    if (failCount === 1) return '#007bff'; // 1ç§‘ (è“)
                    if (failCount <= 3) return '#ffc107'; // 2-3ç§‘ (é»„)
                    return '#dc3545'; // 4ç§‘åŠä»¥ä¸Š (çº¢)
                }
            }
        }]
    };
    echartsInstances[elementId].setOption(option);
}

/**
 * [ä¿®æ”¹ç‰ˆ] æ¸²æŸ“é‡å ç›´æ–¹å›¾ (æ”¯æŒç‚¹å‡»ä¸‹é’»æŸ¥çœ‹åå•)
 */
function renderOverlappingHistogram(elementId, currentData, compareData, subjectName, customBinSize, mode = 'raw') {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    // 1. å†…éƒ¨è¾…åŠ©ï¼šä»æ•°æ®å¯¹è±¡ä¸­æå–åˆ†æ•°æ•°ç»„
    const getScores = (list) => {
        return list.map(s => {
            if (mode === 'tscore') return s.tScores ? s.tScores[subjectName] : null;
            return (subjectName === 'totalScore') ? s.totalScore : s.scores[subjectName];
        });
    };

    const currentScores = getScores(currentData);
    const compareScores = getScores(compareData);

    const cleanCurrent = currentScores.filter(s => typeof s === 'number' && !isNaN(s));
    const cleanCompare = compareScores.filter(s => typeof s === 'number' && !isNaN(s));

    if (cleanCurrent.length === 0 && cleanCompare.length === 0) {
        chartDom.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding-top: 50px;">æ— æ•°æ®å¯ä¾›æ˜¾ç¤ºã€‚</p>`;
        return;
    }

    // 2. è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡ (ä¿æŒä¸å˜)
    const calcStats = (scores) => {
        if (scores.length === 0) return { avg: 0, full: 100 };
        const sum = scores.reduce((a, b) => a + b, 0);
        const avg = sum / scores.length;
        let fullScore = 100;
        if (subjectName === 'totalScore') {
            fullScore = G_DynamicSubjectList.reduce((sum, key) => sum + (G_SubjectConfigs[key]?.full || 0), 0);
        } else {
            fullScore = G_SubjectConfigs[subjectName]?.full || 100;
        }
        return {
            avg: parseFloat(avg.toFixed(1)),
            full: fullScore
        };
    };
    const currStats = calcStats(cleanCurrent);
    const compStats = calcStats(cleanCompare);

    // 3. ç¡®å®šåˆ†ç®±é€»è¾‘ (Binning)
    const allScores = [...cleanCurrent, ...cleanCompare];
    const min = Math.min(...allScores);
    const max = Math.max(...allScores);

    let binSize;
    if (customBinSize && customBinSize > 0) {
        binSize = customBinSize;
    } else {
        if (mode === 'tscore') binSize = 5; // Tåˆ†é»˜è®¤5åˆ†ä¸€æ®µ
        else {
            const fullScore = currStats.full;
            binSize = Math.max(5, Math.round(fullScore / 20));
        }
    }

    const startBin = Math.floor(min / binSize) * binSize;
    const endBinLimit = Math.ceil((max + 0.001) / binSize) * binSize;

    const labels = [];
    const binsCurrent = {};
    const binsCompare = {};

    for (let i = startBin; i < endBinLimit; i += binSize) {
        // ä¿®æ­£æµ®ç‚¹æ•°ç²¾åº¦
        const rangeStart = parseFloat(i.toFixed(2));
        const rangeEnd = parseFloat((i + binSize).toFixed(2));
        const label = `${rangeStart}-${rangeEnd}`;
        labels.push(label);
        binsCurrent[label] = 0;
        binsCompare[label] = 0;
    }

    // å¡«å……æ•°æ®
    const fillBins = (scores, bins) => {
        scores.forEach(score => {
            if (score < startBin) return;
            let binIndex = Math.floor((score - startBin) / binSize);
            if (binIndex >= labels.length) binIndex = labels.length - 1;
            const label = labels[binIndex];
            if (label) bins[label]++;
        });
    };

    fillBins(cleanCurrent, binsCurrent);
    fillBins(cleanCompare, binsCompare);

    const dataCurrent = labels.map(label => binsCurrent[label]);
    const dataCompare = labels.map(label => binsCompare[label]);

    // 4. é…ç½®å›¾è¡¨
    let titleText = `${subjectName} æˆç»©åˆ†å¸ƒå¯¹æ¯”`;
    let subTitleText = "";
    if (mode === 'tscore') {
        titleText += " (Tåˆ†æ¨¡å¼)";
        subTitleText = `æœ¬æ¬¡Tåˆ†å‡å€¼: ${currStats.avg}  vs  ä¸Šæ¬¡Tåˆ†å‡å€¼: ${compStats.avg}`;
    } else {
        titleText += " (åŸå§‹åˆ†æ¨¡å¼)";
        subTitleText = `æœ¬æ¬¡å‡åˆ†: ${currStats.avg}  vs  ä¸Šæ¬¡å‡åˆ†: ${compStats.avg}`;
    }

    const option = {
        title: {
            text: titleText,
            subtext: subTitleText,
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' },
            subtextStyle: { fontSize: 12, color: '#666' }
        },
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        legend: { data: ['æœ¬æ¬¡æˆç»©', 'å¯¹æ¯”æˆç»©'], top: 50 },
        grid: { left: '3%', right: '4%', bottom: '10%', top: 80, containLabel: true },
        xAxis: {
            type: 'category',
            data: labels,
            name: mode === 'tscore' ? 'Tåˆ†æ®µ' : 'åˆ†æ•°æ®µ',
            axisLabel: { interval: 'auto', rotate: 30 }
        },
        yAxis: { type: 'value', name: 'äººæ•°' },
        series: [
            {
                name: 'å¯¹æ¯”æˆç»©',
                type: 'bar',
                data: dataCompare,
                itemStyle: { color: '#ccc' },
                markLine: {
                    symbol: 'none',
                    data: [{ xAxis: (compStats.avg - startBin) / binSize, lineStyle: { color: '#999', type: 'dashed' }, label: { formatter: `{c}`, position: 'start' } }],
                    silent: true
                }
            },
            {
                name: 'æœ¬æ¬¡æˆç»©',
                type: 'bar',
                data: dataCurrent,
                itemStyle: { color: '#4285f4' },
                markLine: {
                    symbol: 'none',
                    data: [{ xAxis: (currStats.avg - startBin) / binSize, lineStyle: { color: '#4285f4', type: 'dashed' }, label: { formatter: `{c}`, position: 'end' } }],
                    silent: true
                }
            }
        ]
    };
    myChart.setOption(option);

    // ============================================================
    //            ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºåå•å¼¹çª—
    // ============================================================
    myChart.on('click', function (params) {
        const label = params.name; // ä¾‹å¦‚ "75-80"
        const seriesName = params.seriesName; // "æœ¬æ¬¡æˆç»©" æˆ– "å¯¹æ¯”æˆç»©"

        if (!label || !label.includes('-')) return;

        const [minStr, maxStr] = label.split('-');
        const minVal = parseFloat(minStr);
        const maxVal = parseFloat(maxStr);

        // ç¡®å®šæ•°æ®æº (æœ¬æ¬¡è¿˜æ˜¯ä¸Šæ¬¡)
        const isCurrent = (seriesName === 'æœ¬æ¬¡æˆç»©');
        const sourceData = isCurrent ? currentData : compareData;

        // ç­›é€‰å­¦ç”Ÿé€»è¾‘
        const drilledStudents = sourceData.filter(s => {
            let val;
            if (mode === 'tscore') {
                val = s.tScores ? s.tScores[subjectName] : null;
            } else {
                val = (subjectName === 'totalScore') ? s.totalScore : s.scores[subjectName];
            }

            if (typeof val !== 'number' || isNaN(val)) return false;

            // èŒƒå›´åˆ¤æ–­ [min, max)
            // ä¸ºäº†åŒ…å«æœ€åä¸€ä¸ªåŒºé—´çš„æœ€å¤§å€¼ï¼Œå¦‚æœç‚¹å‡»çš„æ˜¯æœ€åä¸€ä¸ªæŸ±å­ï¼Œåˆ™æ”¹ä¸ºé—­åŒºé—´
            const isLastBin = (label === labels[labels.length - 1]);
            if (isLastBin) {
                return val >= minVal && val <= maxVal + 0.001;
            } else {
                return val >= minVal && val < maxVal;
            }
        });

        // è°ƒç”¨é€šç”¨å¼¹çª—æ˜¾ç¤ºåå•
        const typeText = mode === 'tscore' ? 'Tåˆ†' : 'åˆ†';
        const title = `${subjectName} ${typeText}æ®µ [${label}] å­¦ç”Ÿåå• (${seriesName})`;

        // æ³¨æ„ï¼šshowDrillDownModal é»˜è®¤æ˜¾ç¤ºçš„æ˜¯åŸå§‹åˆ†ï¼Œè¿™æ­£å¥½æ–¹ä¾¿è€å¸ˆæ ¸å¯¹
        showDrillDownModal(title, drilledStudents, subjectName);
    });
}

/**
 * (    ) 10.24. æ¸²æŸ“ä¸´ç•Œç”Ÿæ¨¡å— - å•ä¸ªå­¦ç”Ÿç§‘ç›®è¯¦æƒ…
 *       - ä¸åŠæ ¼ç§‘ç›®å’Œåˆ†æ•°å‡æ ‡çº¢
 */
function renderBoundaryStudentDetail(containerElement, student) {

    // (ä» G_DynamicSubjectList æ„å»ºç§‘ç›®æ•°æ®)
    const subjectData = G_DynamicSubjectList.map(subject => {

        const score = student.scores[subject];
        const config = G_SubjectConfigs[subject];
        let scoreClass = '';

        if (config && typeof score === 'number' && score < config.pass) {
            scoreClass = 'regress'; //
        }

        return {
            name: subject,
            score: score || 'N/A',
            classRank: (student.classRanks && student.classRanks[subject]) ? student.classRanks[subject] : 'N/A',
            gradeRank: (student.gradeRanks && student.gradeRanks[subject]) ? student.gradeRanks[subject] : 'N/A',
            scoreClass: scoreClass
        };
    });

    let html = `
        <h4>${student.name} (${student.id}) - å…¨ç§‘æˆç»©è¯¦æƒ…</h4>
        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
            <table>
                <thead>
                    <tr>
                        <th>ç§‘ç›®</th>
                        <th>å¾—åˆ†</th>
                        <th>ç­çº§ç§‘ç›®æ’å</th>
                        <th>å¹´çº§ç§‘ç›®æ’å</th>
                    </tr>
                </thead>
                <tbody>
                    ${subjectData.map(item => `
                        <tr>
                            <td class="${item.scoreClass}"><strong>${item.name}</strong></td>
                            <td class="${item.scoreClass}"><strong>${item.score}</strong></td>
                            <td>${item.classRank}</td>
                            <td>${item.gradeRank}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    containerElement.innerHTML = html;
}

/**
 * (    ) 10.12. æ¸²æŸ“åˆ†å±‚ç­›é€‰ - ç­çº§æ„æˆé¥¼å›¾
 */
function renderGroupClassPie(elementId, filteredStudents) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. ç»Ÿè®¡ç­çº§
    const classCounts = {};
    filteredStudents.forEach(student => {
        classCounts[student.class] = (classCounts[student.class] || 0) + 1;
    });

    // 2. è½¬æ¢ä¸º ECharts æ•°æ®
    const pieData = Object.keys(classCounts).map(className => {
        return {
            value: classCounts[className],
            name: className
        };
    }).sort((a, b) => b.value - a.value); // (æŒ‰äººæ•°é™åº)

    const option = {
        title: {
            text: 'ç­›é€‰ç¾¤ä½“çš„ç­çº§æ„æˆ',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c}äºº ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left',
            top: 'middle',
            data: pieData.map(d => d.name).slice(0, 10) // (æœ€å¤šæ˜¾ç¤º10ä¸ªå›¾ä¾‹)
        },
        series: [{
            name: 'ç­çº§',
            type: 'pie',
            radius: ['40%', '70%'], // (ç©ºå¿ƒåœ†)
            center: ['65%', '55%'], // (é¥¼å›¾é å³, ä¸ºå›¾ä¾‹è…¾ç©ºé—´)
            data: pieData,
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            label: {
                show: false,
                position: 'center'
            }
        }]
    };
    echartsInstances[elementId].setOption(option);
}
/**
 * (    ) 10.13. æ¸²æŸ“åˆ†å±‚ç­›é€‰ - ç¾¤ä½“èƒ½åŠ›é›·è¾¾å›¾
 * (å¯¹æ¯” "ç­›é€‰ç¾¤ä½“" vs "å…¨ä½“å¹³å‡" çš„å¾—åˆ†ç‡)
 * @param {Object} filteredStudents - ç­›é€‰å‡ºçš„å­¦ç”Ÿ
 * @param {Object} totalStats - G_Statistics (å…¨ä½“ç»Ÿè®¡)
 */
function renderGroupRadarChart(elementId, filteredStudents, totalStats) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    // 1. (å…³é”®) é‡  è®¡ç®—è¿™ä¸ª "ç­›é€‰ç¾¤ä½“" çš„ç»Ÿè®¡æ•°æ®
    //    å¤ç”¨ calculateAllStatistics å‡½æ•°
    const groupStats = calculateAllStatistics(filteredStudents);

    // 2. å‡†å¤‡é›·è¾¾å›¾æŒ‡ç¤ºå™¨ (max è®¾ä¸º 1, å› ä¸ºæˆ‘ä»¬ç”¨éš¾åº¦/å¾—åˆ†ç‡)
    const indicators = G_DynamicSubjectList.map(subject => {
        // (åŠ¨æ€è·å–æœ€å¤§å€¼, 0.8 å·¦å³æ˜¯æ¯”è¾ƒå¥½çš„æœ€å¤§å€¼)
        const max = Math.max(
            totalStats[subject]?.difficulty || 0,
            groupStats[subject]?.difficulty || 0
        );
        return { name: subject, max: Math.max(1.0, Math.ceil(max * 10) / 10) };
    });

    // 3. (    ) è·å– "ç­›é€‰ç¾¤ä½“" çš„å¾—åˆ†ç‡ (å³éš¾åº¦)
    const groupData = G_DynamicSubjectList.map(subject => {
        return groupStats[subject]?.difficulty || 0;
    });

    // 4. (    ) è·å– "å…¨ä½“å¹³å‡" çš„å¾—åˆ†ç‡ (å³éš¾åº¦)
    const totalData = G_DynamicSubjectList.map(subject => {
        return totalStats[subject]?.difficulty || 0;
    });

    const option = {
        title: {
            text: 'ç¾¤ä½“èƒ½åŠ› vs å…¨ä½“å¹³å‡',
            subtext: '(æŒ‡æ ‡: å¾—åˆ†ç‡/éš¾åº¦)',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: { trigger: 'item' },
        legend: {
            data: ['ç­›é€‰ç¾¤ä½“', 'å…¨ä½“å¹³å‡'],
            bottom: 10
        },
        radar: {
            indicator: indicators,
            radius: '65%',
            splitArea: {
                areaStyle: {
                    color: ['rgba(250,250,250,0.3)', 'rgba(200,200,200,0.3)']
                }
            }
        },
        series: [{
            name: 'ç¾¤ä½“ vs å…¨ä½“',
            type: 'radar',
            data: [
                {
                    value: groupData,
                    name: 'ç­›é€‰ç¾¤ä½“',
                    areaStyle: { opacity: 0.4, color: '#28a745' },
                    itemStyle: { color: '#28a745' },
                    lineStyle: { color: '#28a745' }
                },
                {
                    value: totalData,
                    name: 'å…¨ä½“å¹³å‡',
                    areaStyle: { opacity: 0.2, color: '#007bff' },
                    itemStyle: { color: '#007bff' },
                    lineStyle: { color: '#007bff' }
                }
            ]
        }],
        toolbox: {
            show: true,
            feature: {
                saveAsImage: { show: true, title: 'ä¿å­˜ä¸ºå›¾ç‰‡' }
            }
        }
    };
    echartsInstances[elementId].setOption(option);
}

/**
 * (    ) 10.14. [è¾…åŠ©å‡½æ•°] è®¡ç®—çš®å°”é€Šç›¸å…³ç³»æ•°
 * @param {Array<Number>} xScores - æ•°ç»„ X
 * @param {Array<Number>} yScores - æ•°ç»„ Y
 * @returns {Number} - ç›¸å…³ç³»æ•° ( -1 åˆ° 1 )
 */
function calculateCorrelation(xScores, yScores) {
    if (!xScores || !yScores || xScores.length !== yScores.length || xScores.length < 2) {
        return 0; // æ— æ³•è®¡ç®—
    }

    const n = xScores.length;
    const mean = (arr) => arr.reduce((sum, val) => sum + val, 0) / n;

    const meanX = mean(xScores);
    const meanY = mean(yScores);

    const stdDev = (arr, meanVal) => Math.sqrt(arr.reduce((sum, val) => sum + Math.pow(val - meanVal, 2), 0) / n);

    const stdDevX = stdDev(xScores, meanX);
    const stdDevY = stdDev(yScores, meanY);

    if (stdDevX === 0 || stdDevY === 0) {
        return 0; // (æ²¡æœ‰æ–¹å·®ï¼Œæ— æ³•è®¡ç®—)
    }

    let covariance = 0;
    for (let i = 0; i < n; i++) {
        covariance += (xScores[i] - meanX) * (yScores[i] - meanY);
    }

    const correlationCoefficient = covariance / (n * stdDevX * stdDevY);
    return correlationCoefficient;
}

/**
 * (    ) 10.20. æ¸²æŸ“å•ç§‘A/B/C/Dç­‰çº§æ„æˆé¥¼å›¾
 */
function renderSingleSubjectPie(elementId, subjectStats) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    //    ä» stats ä¸­è·å– A, B, C, D çš„æ¯”ç‡
    // A = ä¼˜ç§€ç‡
    // B = è‰¯å¥½ç‡
    // C = Cç‡ (åŠæ ¼ä½†æœªè‰¯å¥½)
    // D = ä¸åŠæ ¼ç‡
    const pieData = [
        { value: subjectStats.excellentRate || 0, name: 'A (ä¼˜ç§€)' },
        { value: subjectStats.goodRate || 0, name: 'B (è‰¯å¥½)' },
        { value: subjectStats.cRate || 0, name: 'C (åŠæ ¼)' },
        { value: subjectStats.failRate || 0, name: 'D (ä¸åŠæ ¼)' }
    ];

    const option = {
        title: {
            text: 'ç­‰çº§æ„æˆ',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c}%'
        },
        legend: {
            orient: 'vertical',
            left: 'left',
            top: 'middle'
        },
        series: [{
            name: 'ç­‰çº§',
            type: 'pie',
            radius: ['40%', '70%'], // (ç©ºå¿ƒåœ†)
            center: ['65%', '55%'], // (é¥¼å›¾é å³, ä¸ºå›¾ä¾‹è…¾ç©ºé—´)
            data: pieData,
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            label: {
                show: true,
                formatter: '{d}%', // (åœ¨é¥¼å›¾ä¸Šæ˜¾ç¤ºç™¾åˆ†æ¯”)
                position: 'inside',
                color: '#fff'
            },
            //    (    ) é¢œè‰²æ˜ å°„
            color: [
                '#28a745', // A (ç»¿)
                '#007bff', // B (è“)
                '#ffc107', // C (é»„)
                '#dc3545'  // D (çº¢)
            ]
        }]
    };
    echartsInstances[elementId].setOption(option);
}

// ---------------------------------
// (    ) 10.21. æ¸²æŸ“ä¸åŠæ ¼ç§‘ç›®æ•°æ¡å½¢å›¾
// ---------------------------------
//      æ¥æ”¶ failureData (å¯¹è±¡) è€Œä¸æ˜¯ failureCounts (æ•°å­—)
function renderFailureCountChart(elementId, failureData) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    //      ä» failureData è®¡ç®— labels å’Œ data
    const labels = Object.keys(failureData).sort((a, b) => a - b); // ['0', '1', '2']
    const data = labels.map(key => {
        const students = failureData[key] || [];
        return {
            value: students.length, //      value æ˜¯æ•°ç»„é•¿åº¦
            names: students.map(s => s.name) //    (    ) å­˜å‚¨å§“åç”¨äº tooltip
        };
    });
    const categoryLabels = labels.map(l => `${l} ç§‘`); // ['0 ç§‘', '1 ç§‘', '2 ç§‘']


    const option = {
        title: {
            text: 'ä¸åŠæ ¼ç§‘ç›®æ•°é‡åˆ†å¸ƒ',
            subtext: 'Xè½´: ä¸åŠæ ¼(å«ç¼ºè€ƒ)çš„ç§‘ç›®æ•°, Yè½´: å­¦ç”Ÿäººæ•°',
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: (params) => {
                //      Tooltip æ˜¾ç¤ºå§“å
                const p = params[0];
                const names = p.data.names || [];
                let namesHtml = names.slice(0, 10).join('<br/>');
                if (names.length > 10) {
                    namesHtml += `<br/>... (åŠå¦å¤– ${names.length - 10} äºº)`;
                }

                return `<strong>${p.name}</strong><br/>` +
                    `å­¦ç”Ÿäººæ•°: <strong>${p.value}</strong>äºº` +
                    `<hr style="margin: 5px 0; border-color: #eee;"/>` +
                    `${namesHtml}`;
            }
        },
        grid: { left: '10%', right: '5%', bottom: '15%' },
        xAxis: {
            type: 'category',
            data: categoryLabels, //    (ä¿®æ”¹)
            name: 'ä¸åŠæ ¼ç§‘ç›®æ•°'
        },
        yAxis: {
            type: 'value',
            name: 'å­¦ç”Ÿäººæ•°'
        },
        series: [{
            name: 'äººæ•°',
            type: 'bar',
            data: data, //    (ä¿®æ”¹)
            barWidth: '60%',
            label: {
                show: true,
                position: 'top'
            },
            itemStyle: {
                color: (params) => {
                    //      è§£æ '0 ç§‘'
                    const failCount = parseInt(params.name.split(' ')[0]);
                    if (failCount === 0) return '#28a745'; // å…¨åŠæ ¼ (ç»¿)
                    if (failCount === 1) return '#007bff'; // 1ç§‘ (è“)
                    if (failCount <= 3) return '#ffc107'; // 2-3ç§‘ (é»„)
                    return '#dc3545'; // 4ç§‘åŠä»¥ä¸Š (çº¢)
                }
            }
        }]
    };
    echartsInstances[elementId].setOption(option);
    return echartsInstances[elementId]; //    (    ) è¿”å›å®ä¾‹
}

/**
 * æ¸²æŸ“æ’åæµåŠ¨æ¡‘åŸºå›¾
 */
function renderRankingSankey(elementId, mergedData, rankTiers, getRankCategory, currentFilter, subject = 'totalScore') {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return null;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    if (mergedData.length === 0) {
        chartDom.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding-top: 50px;">æ— åŒ¹é…çš„å­¦ç”Ÿæ•°æ®ã€‚</p>`;
        return null;
    }

    //    1. å®šä¹‰é¢œè‰²ç›˜ (å¯¹åº” rankTiers çš„é¡ºåº)
    // é¡ºåºï¼šTop 10% (è“), 10-30% (æ©™), 30-60% (ç»¿), Bottom 40% (çº¢/ç²‰)
    const tierColors = ['#5470c6', '#fac858', '#91cc75', '#ee6666'];

    // 2. ECharts Nodes
    const nodes = [];

    //    ä¿®å¤ï¼šåœ¨ç”ŸæˆèŠ‚ç‚¹æ—¶åˆ†é…é¢œè‰²
    rankTiers.forEach((tier, index) => {
        const color = tierColors[index % tierColors.length]; // æŒ‰é¡ºåºå–è‰²
        nodes.push({
            name: `ä¸Šæ¬¡: ${tier.name}`,
            itemStyle: { color: color } // è®¾å®šé¢œè‰²
        });
    });

    rankTiers.forEach((tier, index) => {
        const color = tierColors[index % tierColors.length];
        nodes.push({
            name: `æœ¬æ¬¡: ${tier.name}`,
            itemStyle: { color: color } // è®¾å®šé¢œè‰²
        });
    });

    // 3. ECharts Links
    const linksMap = {};

    mergedData.forEach(student => {
        const useGradeRank = (currentFilter === 'ALL');
        let oldRank, newRank;

        if (subject === 'totalScore') {
            oldRank = useGradeRank ? (student.oldGradeRank || 0) : student.oldRank;
            newRank = useGradeRank ? (student.gradeRank || 0) : student.rank;
        } else {
            const oldRanksObj = useGradeRank ? (student.oldGradeRanks || {}) : (student.oldClassRanks || {});
            const newRanksObj = useGradeRank ? (student.gradeRanks || {}) : (student.classRanks || {});
            oldRank = oldRanksObj[subject] || 0;
            newRank = newRanksObj[subject] || 0;
        }

        if (oldRank > 0 && newRank > 0) {
            const source = `ä¸Šæ¬¡: ${getRankCategory(oldRank)}`;
            const target = `æœ¬æ¬¡: ${getRankCategory(newRank)}`;
            const key = `${source} -> ${target}`;
            linksMap[key] = (linksMap[key] || 0) + 1;
        }
    });

    const links = Object.keys(linksMap).map(key => {
        const [source, target] = key.split(' -> ');
        return {
            source: source,
            target: target,
            value: linksMap[key]
        };
    });

    const titleText = (subject === 'totalScore') ? 'æ€»åˆ†æ’å' : `${subject}æ’å`;

    const option = {
        title: {
            text: `${titleText}åˆ†å±‚æµåŠ¨å›¾`,
            subtext: `åŸºäºä¸¤æ¬¡${subject === 'totalScore' ? 'æ€»åˆ†' : subject}å‡æœ‰æ•ˆçš„å­¦ç”Ÿ`,
            left: 'center'
        },
        tooltip: {
            trigger: 'item',
            triggerOn: 'mousemove',
            formatter: (params) => {
                if (params.dataType === 'link') {
                    return `${params.data.source} â†’ ${params.data.target}: ${params.data.value} äºº`;
                }
                if (params.dataType === 'node') {
                    return `${params.name}: ${params.value} äºº`;
                }
                return '';
            }
        },
        series: [{
            type: 'sankey',
            data: nodes,
            links: links,
            emphasis: { focus: 'adjacency' },
            nodeAlign: 'justify',
            layoutIterations: 32,
            lineStyle: {
                color: 'gradient', //    æ¢å¤æ¸å˜è‰² (ä¾èµ– source å’Œ target çš„é¢œè‰²)
                curveness: 0.5,
                opacity: 0.4
            },
            label: {
                fontSize: 11,
                color: '#333',
                formatter: '{b}'
            },
            levels: [
                { depth: 0, itemStyle: { opacity: 1 }, lineStyle: { color: 'source', opacity: 0.3 } },
                { depth: 1, itemStyle: { opacity: 1 }, lineStyle: { color: 'source', opacity: 0.3 } }
            ]
        }]
    };

    echartsInstances[elementId].setOption(option, { notMerge: true });

    return echartsInstances[elementId];
}


/**
 * (    ) 11.1. è®¡ç®—æ‰€æœ‰ç­çº§çš„ç»Ÿè®¡æ•°æ® (ç”¨äºç­çº§å¯¹æ¯”)
 * @param {string} metric - 'average', 'passRate', 'stdDev'
 * @param {string} subject - 'totalScore', 'è¯­æ–‡', ...
 * @returns {Array} - e.g., [{ name: 'é«˜ä¸€1ç­', value: 85.5 }, ...]
 */
function calculateClassComparison(metric, subject) {
    if (!G_StudentsData || G_StudentsData.length === 0) return [];

    const classes = [...new Set(G_StudentsData.map(s => s.class))].sort();
    const classData = [];

    for (const className of classes) {
        // 1. ç­›é€‰å‡ºè¯¥ç­çš„å­¦ç”Ÿ
        const classStudents = G_StudentsData.filter(s => s.class === className);

        // 2. ä¸ºè¯¥ç­è®¡ç®—ç»Ÿè®¡æ•°æ® (ä½¿ç”¨å…¨å±€ç§‘ç›®é…ç½®)
        const classStats = calculateAllStatistics(classStudents);

        // 3. æå–æ‰€éœ€çš„ç‰¹å®šæŒ‡æ ‡
        let value = 0;
        if (classStats[subject] && classStats[subject][metric] !== undefined) {
            value = classStats[subject][metric];
        }

        classData.push({
            name: className.replace('é«˜ä¸€å¹´çº§', ''), // ç®€åŒ–ç­çº§åç§° (å¯è‡ªå®šä¹‰)
            value: value
        });
    }



    return classData;
}

/**
 * 10.25. (ECharts) æ¸²æŸ“å¤šæ¬¡è€ƒè¯•æ›²çº¿å›¾
 */
function renderMultiExamLineChart(elementId, title, examNames, seriesData, yAxisInverse) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    echartsInstances[elementId] = echarts.init(chartDom);

    const option = {
        title: {
            text: title,
            left: 'center',
            textStyle: { fontSize: 16, fontWeight: 'normal' }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross' }
        },
        legend: {
            top: 30,
            type: 'scroll' // (å¦‚æœç§‘ç›®å¤ªå¤š)
        },
        grid: {
            left: '10%',
            right: '10%',
            bottom: '15%',
            top: 70
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: examNames,
            axisLabel: {
                rotate: 15,
                interval: 0 // (å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰Xè½´æ ‡ç­¾)
            }
        },
        yAxis: {
            type: 'value',
            inverse: yAxisInverse, //    (æ’åå›¾éœ€è¦åè½¬)
            axisPointer: {
                snap: true
            }
        },
        dataZoom: [ // (å…è®¸ç¼©æ”¾)
            {
                type: 'inside',
                xAxisIndex: [0]
            },
            {
                type: 'slider',
                xAxisIndex: [0],
                bottom: 10,
                height: 20
            }
        ],
        series: seriesData
    };

    echartsInstances[elementId].setOption(option);
}

/**
 * [ä¿®æ”¹ç‰ˆ] 11. å¯åŠ¨æ—¶ä» IndexedDB åŠ è½½æ•°æ®
 * ä¿ç•™äº†æ‚¨åŸæœ‰çš„æ‰€æœ‰è§£æé€»è¾‘å’Œå®¹é”™å¤„ç†
 */
async function loadDataFromStorage() {
    console.log("ğŸš€ ç³»ç»Ÿå¯åŠ¨ï¼šæ­£åœ¨è¿æ¥ IndexedDB åŠ è½½æ•°æ®...");

    try {
        // 1. [ä¿®æ”¹] å¹¶è¡Œè¯»å–æ•°æ® (    äº† ItemAnalysisData ç­‰3ä¸ªKey)
        const [
            storedData,
            storedCompareData,
            storedConfigs,
            storedMainFile,
            storedCompareFile,
            storedItemData,      // [    ]
            storedItemConfig,    // [    ]
            storedItemFile       // [    ]
        ] = await Promise.all([
            localforage.getItem('G_StudentsData'),
            localforage.getItem('G_CompareData'),
            localforage.getItem('G_SubjectConfigs'),
            localforage.getItem('G_MainFileName'),
            localforage.getItem('G_CompareFileName'),
            localforage.getItem('G_ItemAnalysisData'),    // [    ]
            localforage.getItem('G_ItemAnalysisConfig'),  // [    ]
            localforage.getItem('G_ItemAnalysisFileName') // [    ]
        ]);

        // 2. [ä¿ç•™åŸæœ‰é€»è¾‘] å¦‚æœæ²¡æœ‰â€œæœ¬æ¬¡æˆç»©â€ï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åš
        if (!storedData) {
            console.log("ğŸ“­ æœ¬åœ°å­˜å‚¨ä¸ºç©ºï¼Œç­‰å¾…ç”¨æˆ·å¯¼å…¥...");
            initializeSubjectConfigs();
            // å¦‚æœè¿™é‡Œç›´æ¥ returnï¼Œå°é¢˜æ•°æ®å¯èƒ½ä¹ŸåŠ è½½ä¸åˆ°äº†ï¼Œä½†è€ƒè™‘åˆ°æ²¡æœ‰ä¸»æ•°æ®ç³»ç»Ÿæ— æ³•è¿è¡Œï¼Œä¿æŒæ‚¨åŸæœ‰çš„ return é€»è¾‘æ˜¯åˆç†çš„
            return;
        }

        // 3. [ä¿ç•™åŸæœ‰é€»è¾‘] æ£€æŸ¥æ•°æ®ç±»å‹ (å…¼å®¹æ€§ä¿®å¤)
        if (typeof storedData === 'string') {
            console.log("âš ï¸ æ£€æµ‹åˆ°å­—ç¬¦ä¸²æ ¼å¼çš„æœ¬æ¬¡æˆç»©ï¼Œæ­£åœ¨è§£æ...");
            G_StudentsData = JSON.parse(storedData);
        } else {
            G_StudentsData = storedData;
        }

        // 4. [ä¿ç•™åŸæœ‰é€»è¾‘] æ£€æŸ¥å¯¹æ¯”æ•°æ®
        if (storedCompareData) {
            if (typeof storedCompareData === 'string') {
                console.log("âš ï¸ æ£€æµ‹åˆ°å­—ç¬¦ä¸²æ ¼å¼çš„å¯¹æ¯”æˆç»©ï¼Œæ­£åœ¨è§£æ...");
                G_CompareData = JSON.parse(storedCompareData);
            } else {
                G_CompareData = storedCompareData;
            }
        }

        console.log(`âœ… æˆåŠŸåŠ è½½æœ¬æ¬¡æˆç»©ï¼š${G_StudentsData.length} æ¡è®°å½•`);

        // 5. [ä¿ç•™åŸæœ‰é€»è¾‘] é‡å»º G_DynamicSubjectList
        if (G_StudentsData.length > 0) {
            const allSubjects = new Set();
            G_StudentsData.forEach(student => {
                if (student.scores) {
                    Object.keys(student.scores).forEach(subject => allSubjects.add(subject));
                }
            });
            if (allSubjects.size > 0) {
                G_DynamicSubjectList = Array.from(allSubjects);
            }
        }

        // 6. [ä¿ç•™åŸæœ‰é€»è¾‘] åŠ è½½é…ç½®
        if (storedConfigs) {
            G_SubjectConfigs = storedConfigs;
        } else {
            initializeSubjectConfigs();
        }

        // 7. [ä¿ç•™åŸæœ‰é€»è¾‘] å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿æ‰€æœ‰ç§‘ç›®éƒ½æœ‰é…ç½®
        G_DynamicSubjectList.forEach(subject => {
            if (!G_SubjectConfigs[subject]) {
                const isY_S_W = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­'].includes(subject);
                G_SubjectConfigs[subject] = {
                    full: isY_S_W ? 150 : 100,
                    excel: isY_S_W ? 120 : 85,
                    good: isY_S_W ? (isY_S_W ? 105 : 75) : (100 + 60) / 2,
                    pass: isY_S_W ? 90 : 60,
                };
            }
        });

        // ============================================================
        //            é¢„åŠ è½½â€œå­¦ç§‘å°é¢˜åˆ†æâ€æ•°æ®
        // ============================================================
        if (storedItemData) {
            G_ItemAnalysisData = storedItemData;
            console.log(`âœ… æˆåŠŸé¢„åŠ è½½å°é¢˜æ•°æ®: ${Object.keys(storedItemData).length} ç§‘`);
        }
        if (storedItemConfig) {
            G_ItemAnalysisConfig = storedItemConfig;
        }
        // é¡ºä¾¿æ›´  ä¸€ä¸‹æ¨¡å—åä¸‰é‚£è¾¹çš„çŠ¶æ€æ–‡å­— (å¦‚æœ DOM å­˜åœ¨)
        const itemStatusLabel = document.getElementById('item-analysis-status');
        if (itemStatusLabel && storedItemFile) {
            itemStatusLabel.innerText = `âœ… å·²åŠ è½½: ${storedItemFile}`;
        }
        // ============================================================

        // 8. [ä¿ç•™åŸæœ‰é€»è¾‘] UI æ›´  
        populateClassFilter(G_StudentsData);
        if (welcomeScreen) welcomeScreen.style.display = 'none';

        const compareBtnEl = document.getElementById('import-compare-btn');
        if (compareBtnEl) compareBtnEl.classList.remove('disabled');

        navLinks.forEach(l => l.classList.remove('disabled'));
        if (classFilterContainer) classFilterContainer.style.display = 'block';
        if (classFilterHr) classFilterHr.style.display = 'block';

        if (storedMainFile) {
            const mainBtn = document.getElementById('import-main-btn');
            if (mainBtn) mainBtn.innerHTML = `âœ… ${storedMainFile} (å·²åŠ è½½)`;
        }
        if (storedCompareFile && compareBtnEl) {
            compareBtnEl.innerHTML = `âœ… ${storedCompareFile} (å·²åŠ è½½)`;
        }

        // 9. [ä¿ç•™åŸæœ‰é€»è¾‘] è¿è¡Œåˆ†æ
        runAnalysisAndRender();

    } catch (err) {
        // [ä¿ç•™åŸæœ‰é€»è¾‘] é”™è¯¯å¤„ç†
        console.error("âŒ IndexedDB è¯»å–ä¸¥é‡å¤±è´¥:", err);
        alert("è¯»å–ç¼“å­˜æ•°æ®å‡ºé”™ã€‚å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·ç‚¹å‡»å·¦ä¸‹è§’çš„â€œæ¸…é™¤æ‰€æœ‰å¯¼å…¥æ•°æ®â€æŒ‰é’®é‡ç½®ç³»ç»Ÿã€‚");
    }
}

/**
 * (    ) 11.2.   æ¸²æŸ“â€œå¤šæ¬¡è€ƒè¯•â€çš„UIåˆ—è¡¨
 */
function renderMultiExamList(multiExamData) {
    const listContainer = document.getElementById('multi-exam-list');
    if (!listContainer) return;

    if (!multiExamData || multiExamData.length === 0) {
        listContainer.innerHTML = `<li class="multi-exam-item-empty">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»â€œæ·»åŠ   æˆç»©â€ä¸Šä¼ ã€‚</li>`;
        return;
    }

    listContainer.innerHTML = multiExamData.map((item, index) => {
        return `
            <li class="multi-exam-item ${item.isHidden ? 'is-hidden' : ''}" data-id="${item.id}">
                <span class="multi-exam-index">${index + 1}.</span>
                <input type="text" value="${item.label}" data-role="label" class="multi-exam-label" title="ç‚¹å‡»å¯é‡å‘½å: ${item.originalName}">
                    <div class="multi-exam-buttons">
                    <button data-role="up" ${index === 0 ? 'disabled' : ''}>â–²</button>
                    <button data-role="down" ${index === multiExamData.length - 1 ? 'disabled' : ''}>â–¼</button>
                    
                    <button data-role="toggle-hide" class="hide-btn" title="${item.isHidden ? 'ç‚¹å‡»è®¾ä¸ºå¯è§' : 'ç‚¹å‡»è®¾ä¸ºéšè—'}">
                        ${item.isHidden ? 'ğŸš«' : 'ğŸ‘ï¸'}
                    </button>
                    
                    <button data-role="delete" class="delete-btn">Ã—</button>
                </div>
            </li>
        `;
    }).join('');
}

/**
 * [ä¿®æ”¹ç‰ˆ] ä¿å­˜è€ƒè¯•æ•°æ®åˆ°å½“å‰é€‰ä¸­çš„åˆ—è¡¨
 */
async function saveMultiExamData(examArray) {
    // 1. è¯»å–æ‰€æœ‰é›†åˆ
    const collections = await getCollections();

    // 2. æ›´  å½“å‰é›†åˆçš„ exams
    if (collections[G_CurrentCollectionId]) {
        collections[G_CurrentCollectionId].exams = examArray;

        // 3. ä¿å­˜å› LocalStorage
        await saveCollections(collections);

        // 4. é¡ºä¾¿æ›´  ä¸€ä¸‹ä¸‹æ‹‰æ¡†æ˜¾ç¤ºçš„è€ƒè¯•æ•°é‡
        await renderCollectionSelect();
    }
}

/**
 * [ä¿®æ”¹ç‰ˆ] ä»å½“å‰é€‰ä¸­çš„åˆ—è¡¨ä¸­åŠ è½½è€ƒè¯•æ•°æ®
 */
async function loadMultiExamData() {
    // 1. ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
    await ensureCollectionsExist();

    // 2. è¯»å–æ‰€æœ‰é›†åˆ
    const collections = await getCollections();

    // 3. è¿”å›å½“å‰é›†åˆçš„ exams æ•°ç»„
    // (  åŠ å®¹é”™ï¼šå¦‚æœå½“å‰IDä¸å¯¹ï¼Œé»˜è®¤è¿”å›ç©ºæ•°ç»„)
    if (collections[G_CurrentCollectionId]) {
        // åŒæ ·åšä¸€æ¬¡æ—§æ•°æ®å…¼å®¹å¤„ç† (isHidden)
        return collections[G_CurrentCollectionId].exams.map(item => ({
            ...item,
            isHidden: item.isHidden || false
        }));
    } else {
        return [];
    }
}


/**
 *   11.5. åˆå§‹åŒ–â€œå¤šæ¬¡è€ƒè¯•åˆ†æâ€çš„å­¦ç”Ÿæœç´¢æ¡†
 *    ä¿®å¤ç‰ˆ    è§£å†³ loadMultiExamData è¿”å› Promise å¯¼è‡´çš„ .filter æŠ¥é”™
 */
function initializeStudentSearch(multiExamData) {
    const searchInput = document.getElementById('multi-student-search');
    const resultsContainer = document.getElementById('multi-student-search-results');
    const reportContainer = document.getElementById('multi-student-report');

    if (!searchInput) return;

    // (è®¡ç®—æ‰€æœ‰å­¦ç”Ÿåˆ—è¡¨ - ä¸å˜)
    const allStudentsMap = new Map();
    multiExamData.filter(e => !e.isHidden).forEach(exam => {
        exam.students.forEach(student => {
            if (!allStudentsMap.has(student.id)) {
                allStudentsMap.set(student.id, student.name);
            }
        });
    });
    const allStudentsList = Array.from(allStudentsMap, ([id, name]) => ({ id, name }));

    // (æœç´¢æ¡† input äº‹ä»¶ - ä¸å˜)
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        if (searchTerm.length < 1) {
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            return;
        }
        const filteredStudents = allStudentsList.filter(s => {
            return String(s.name).toLowerCase().includes(searchTerm) ||
                String(s.id).toLowerCase().includes(searchTerm);
        }).slice(0, 50);

        if (filteredStudents.length === 0) {
            resultsContainer.innerHTML = '<div class="result-item">-- æœªæ‰¾åˆ° --</div>';
        } else {
            resultsContainer.innerHTML = filteredStudents.map(s => {
                return `<div class="result-item" data-id="${s.id}">
                    <strong>${s.name}</strong> (${s.id})
                </div>`;
            }).join('');
        }
        resultsContainer.style.display = 'block';
    });

    // (ç‚¹å‡»æœç´¢ç»“æœ äº‹ä»¶ -    ä¿®æ”¹ï¼š  åŠ  async/await)
    resultsContainer.addEventListener('click', async (e) => {
        const item = e.target.closest('.result-item');
        if (item && item.dataset.id) {
            const studentId = item.dataset.id;
            const studentName = item.querySelector('strong').innerText;

            searchInput.value = `${studentName} (${studentId})`;
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';

            document.getElementById('multi-student-name-title').innerText = `${studentName} çš„æˆç»©æ›²çº¿`;
            reportContainer.style.display = 'block';

            // å­˜å‚¨å½“å‰å­¦ç”ŸID
            reportContainer.dataset.studentId = studentId;

            // [ä¿®å¤ç‚¹] ç­‰å¾…æ•°æ®åŠ è½½
            const currentData = await loadMultiExamData();
            drawMultiExamChartsAndTable(studentId, currentData, true);
        }
    });

    document.addEventListener('click', (e) => {
        if (searchInput && !searchInput.contains(e.target) && resultsContainer && !resultsContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
        }
    });

    // ç»‘å®šç­›é€‰å™¨äº‹ä»¶
    const checkboxContainer = document.getElementById('multi-subject-checkboxes');
    const selectAllBtn = document.getElementById('multi-subject-all');
    const selectNoneBtn = document.getElementById('multi-subject-none');

    // (è¾…åŠ©å‡½æ•°ï¼šé‡ç»˜å›¾è¡¨ -    ä¿®æ”¹ï¼š  åŠ  async/await)
    const redrawCharts = async () => {
        const currentStudentId = reportContainer.dataset.studentId;
        if (currentStudentId) {
            // [ä¿®å¤ç‚¹] ç­‰å¾…æ•°æ®åŠ è½½
            const currentData = await loadMultiExamData();
            drawMultiExamChartsAndTable(currentStudentId, currentData, false);
        }
    };

    if (checkboxContainer) {
        checkboxContainer.addEventListener('change', redrawCharts);
    }

    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', () => {
            checkboxContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            redrawCharts();
        });
    }

    if (selectNoneBtn) {
        selectNoneBtn.addEventListener('click', () => {
            checkboxContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            redrawCharts();
        });
    }
}

/**
 *   11.6. (æ ¸å¿ƒ) ç»˜åˆ¶å¤šæ¬¡è€ƒè¯•çš„å›¾è¡¨å’Œè¡¨æ ¼
 */
function drawMultiExamChartsAndTable(studentId, multiExamData, forceRepopulateCheckboxes = false) {

    // 1. è¿‡æ»¤ä¸å‡†å¤‡æ•°æ®
    const visibleExamData = multiExamData.filter(e => !e.isHidden);
    const examNames = visibleExamData.map(e => e.label);

    const rankData = { classRank: [], gradeRank: [] };
    const subjectData = {};
    const subjectRankData = {};

    const allSubjects = new Set();
    visibleExamData.forEach(exam => {
        exam.students.forEach(s => {
            if (s.scores) Object.keys(s.scores).forEach(subject => allSubjects.add(subject));
        });
    });

    const dynamicSubjects = Array.from(allSubjects);
    dynamicSubjects.forEach(subject => {
        subjectData[subject] = [];
        subjectRankData[subject] = { classRank: [], gradeRank: [] };
    });

    let currentStudentName = "å­¦ç”Ÿ";
    let currentStudentClass = "";

    // 2. å¡«å……æ•°æ® (è·å–å½“å‰å­¦ç”Ÿçš„æ•°æ®)
    visibleExamData.forEach(exam => {
        const student = exam.students.find(s => String(s.id) === String(studentId));
        if (student) {
            if (currentStudentName === "å­¦ç”Ÿ") {
                currentStudentName = student.name;
                currentStudentClass = student.class;
            }

            rankData.classRank.push(student.rank || null);
            rankData.gradeRank.push(student.gradeRank || null);

            dynamicSubjects.forEach(subject => {
                const rawScore = student.scores[subject];
                subjectData[subject].push((rawScore !== null && rawScore !== undefined) ? rawScore : null);

                let classRank = null;
                let gradeRank = null;

                if (typeof rawScore === 'number' && !isNaN(rawScore)) {
                    // [ä¿®å¤] åˆ é™¤ä¹‹å‰æŠ¥é”™çš„ validClassRank è¡Œï¼Œç›´æ¥ä½¿ç”¨ä¸‹æ–¹é€»è¾‘
                    classRank = student.classRanks ? student.classRanks[subject] : null;
                    gradeRank = student.gradeRanks ? student.gradeRanks[subject] : null;
                }

                subjectRankData[subject].classRank.push(classRank);
                subjectRankData[subject].gradeRank.push(gradeRank);
            });
        } else {
            // ç¼ºè€ƒå¡«ç©º
            rankData.classRank.push(null);
            rankData.gradeRank.push(null);
            dynamicSubjects.forEach(subject => {
                subjectData[subject].push(null);
                subjectRankData[subject].classRank.push(null);
                subjectRankData[subject].gradeRank.push(null);
            });
        }
    });

    // 3. [å›¾è¡¨1 æ•°æ®]
    const scoreSeries = [];
    dynamicSubjects.forEach(subject => {
        scoreSeries.push({ name: subject, type: 'line', data: subjectData[subject], smooth: true, connectNulls: true });
    });

    // 4. å¤é€‰æ¡†é€»è¾‘
    const checkboxContainer = document.getElementById('multi-subject-checkboxes');
    if (checkboxContainer && forceRepopulateCheckboxes) {
        checkboxContainer.innerHTML = dynamicSubjects.map(subject => `
            <div><input type="checkbox" id="multi-cb-${subject}" value="${subject}" checked><label for="multi-cb-${subject}">${subject}</label></div>
        `).join('');
    }
    const checkedSubjects = new Set();
    if (checkboxContainer) {
        checkboxContainer.querySelectorAll('input:checked').forEach(cb => checkedSubjects.add(cb.value));
    }
    const filteredScoreSeries = scoreSeries.filter(series => checkedSubjects.has(series.name));

    // 5. [å›¾è¡¨2 æ•°æ®]
    const totalRankSeries = [];
    totalRankSeries.push({ name: 'ç­çº§æ’å (æ€»)', type: 'line', data: rankData.classRank, smooth: true, connectNulls: true });
    totalRankSeries.push({ name: 'å¹´çº§æ’å (æ€»)', type: 'line', data: rankData.gradeRank, smooth: true, connectNulls: true });

    // 6. æ¸²æŸ“ å›¾è¡¨
    if (typeof renderMultiExamLineChart === 'function') {
        renderMultiExamLineChart('multi-exam-score-chart', '', examNames, filteredScoreSeries, false);
        renderMultiExamLineChart('multi-exam-rank-chart', '', examNames, totalRankSeries, true);
    }

    const rankTypeSelect = document.getElementById('multi-rank-type-select');
    const rankType = rankTypeSelect ? rankTypeSelect.value : 'both';

    if (typeof renderSubjectRankChart === 'function') {
        renderSubjectRankChart('multi-exam-subject-rank-chart', examNames, visibleExamData, studentId, checkedSubjects, rankType);
    }

    // 8. ç»˜åˆ¶è¡¨æ ¼ (å«æ‰“å°æŒ‰é’®)
    const tableContainer = document.getElementById('multi-student-table-container');
    if (!tableContainer) return;

    const safeVal = (v) => (v !== null && v !== undefined) ? v : '-';

    // æ„å»ºè¡¨æ ¼ HTML çš„è¾…åŠ©å‡½æ•°
    const generateSingleTableHTML = (sName, sClass, sId, sRankData, sSubData, sSubRankData) => {
        return `
            <div class="print-page-wrapper" style="page-break-after: always; padding: 20px;">
                <div style="text-align:center; margin-bottom:20px;">
                    <h2 style="margin:0;">${sName} - å†æ¬¡è€ƒè¯•æˆç»©è¯¦æƒ…</h2>
                    <p style="margin:5px 0; color:#666;">ç­çº§: ${sClass} | è€ƒå·: ${sId}</p>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 12px; text-align: center;">
                    <thead>
                        <tr style="background-color: #f0f0f0;">
                            <th style="border: 1px solid #999; padding: 8px; min-width: 120px;">è€ƒè¯•åç§°</th>
                            <th style="border: 1px solid #999; padding: 8px;">ç­çº§æ’å (æ€»)</th>
                            <th style="border: 1px solid #999; padding: 8px;">å¹´çº§æ’å (æ€»)</th>
                            ${dynamicSubjects.map(s => `<th style="border: 1px solid #999; padding: 8px;">${s}<br>(åˆ†æ•°)</th>`).join('')}
                            ${dynamicSubjects.map(s => `<th style="border: 1px solid #999; padding: 8px;">${s}<br>(ç­æ’)</th>`).join('')}
                            ${dynamicSubjects.map(s => `<th style="border: 1px solid #999; padding: 8px;">${s}<br>(å¹´æ’)</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${examNames.map((examName, index) => `
                            <tr>
                                <td style="border: 1px solid #999; padding: 8px; font-weight: bold;">${examName}</td>
                                <td style="border: 1px solid #999; padding: 8px;">${safeVal(sRankData.classRank[index])}</td>
                                <td style="border: 1px solid #999; padding: 8px;">${safeVal(sRankData.gradeRank[index])}</td>
                                ${dynamicSubjects.map(subject => `<td style="border: 1px solid #999; padding: 8px;">${safeVal(sSubData[subject][index])}</td>`).join('')}
                                ${dynamicSubjects.map(subject => `<td style="border: 1px solid #999; padding: 8px;">${safeVal(sSubRankData[subject].classRank[index])}</td>`).join('')}
                                ${dynamicSubjects.map(subject => `<td style="border: 1px solid #999; padding: 8px;">${safeVal(sSubRankData[subject].gradeRank[index])}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 20px; text-align: right; font-size: 10px; color: #999;">
                    ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
                </div>
            </div>
        `;
    };

    // ç”Ÿæˆå½“å‰å­¦ç”Ÿçš„ HTML (ç”¨äºæ˜¾ç¤º)
    const currentStudentHtml = generateSingleTableHTML(currentStudentName, currentStudentClass, studentId, rankData, subjectData, subjectRankData);

    // æ¸²æŸ“åˆ°é¡µé¢
    let interfaceHtml = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-top: 20px; border-top: 1px solid var(--border-color); flex-wrap: wrap; gap: 10px;">
            <h4 style="margin: 0;">æˆç»©è¯¦æƒ…è¡¨</h4>
            <div>
                <button id="multi-print-table-btn" class="sidebar-button" style="font-size: 0.9em; padding: 6px 12px; background-color: var(--color-gray);">
                    ğŸ–¨ï¸ æ‰“å°å½“å‰
                </button>
                <button id="multi-batch-print-btn" class="sidebar-button" style="font-size: 0.9em; padding: 6px 12px; background-color: var(--color-blue); margin-left: 10px;">
                    ğŸ“‘ æ‰¹é‡æ‰“å° (å…¨ç­/æ¯äººä¸€é¡µ)
                </button>
            </div>
        </div>
        <div class="table-container" id="multi-print-table-content" style="max-height: 400px;">
            ${currentStudentHtml.replace(/<div class="print-page-wrapper".*?>|<\/div>$/g, '')} </div>
    `;
    tableContainer.innerHTML = interfaceHtml;

    // ç»‘å®šäº‹ä»¶ï¼šæ‰“å°å½“å‰
    const printBtn = document.getElementById('multi-print-table-btn');
    if (printBtn) {
        printBtn.addEventListener('click', () => {
            if (typeof startMultiTablePrintJob === 'function') {
                startMultiTablePrintJob(currentStudentName, currentStudentHtml);
            } else {
                console.error("startMultiTablePrintJob æœªå®šä¹‰");
            }
        });
    }

    // ç»‘å®šäº‹ä»¶ï¼šæ‰¹é‡æ‰“å°
    const batchPrintBtn = document.getElementById('multi-batch-print-btn');
    if (batchPrintBtn) {
        batchPrintBtn.addEventListener('click', () => {
            if (!currentStudentClass) {
                alert("æ— æ³•è¯†åˆ«å½“å‰å­¦ç”Ÿçš„ç­çº§ï¼Œæ— æ³•è¿›è¡Œæ‰¹é‡æ‰“å°ã€‚");
                return;
            }

            if (!confirm(`å³å°†ç”Ÿæˆ "${currentStudentClass}" æ‰€æœ‰å­¦ç”Ÿçš„æˆç»©å•ã€‚\n\næ¯ä½å­¦ç”Ÿå°†å æ®ä¸€é¡µï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) return;

            // 1. æ‰¾å‡ºåŒç­åŒå­¦
            const classStudentsMap = new Map(); // ç”¨ Map å»é‡
            visibleExamData.forEach(exam => {
                exam.students.forEach(s => {
                    if (s.class === currentStudentClass) {
                        if (!classStudentsMap.has(s.id)) {
                            classStudentsMap.set(s.id, { id: s.id, name: s.name, class: s.class });
                        }
                    }
                });
            });

            const classmates = Array.from(classStudentsMap.values()).sort((a, b) => a.id.localeCompare(b.id)); // æŒ‰å­¦å·æ’åº

            if (classmates.length === 0) {
                alert("æœªæ‰¾åˆ°åŒç­åŒå­¦æ•°æ®ã€‚");
                return;
            }

            // 2. å¾ªç¯ç”Ÿæˆ HTML
            let fullHtml = "";

            classmates.forEach(mate => {
                // ä¸ºæ¯ä¸ªåŒå­¦å‡†å¤‡æ•°æ®
                const mRankData = { classRank: [], gradeRank: [] };
                const mSubjectData = {};
                const mSubjectRankData = {};
                dynamicSubjects.forEach(sub => {
                    mSubjectData[sub] = [];
                    mSubjectRankData[sub] = { classRank: [], gradeRank: [] };
                });

                visibleExamData.forEach(exam => {
                    const s = exam.students.find(st => String(st.id) === String(mate.id));
                    if (s) {
                        mRankData.classRank.push(s.rank || null);
                        mRankData.gradeRank.push(s.gradeRank || null);
                        dynamicSubjects.forEach(sub => {
                            const score = s.scores[sub];
                            mSubjectData[sub].push((score !== null && score !== undefined) ? score : null);
                            let cRank = null, gRank = null;
                            if (typeof score === 'number' && !isNaN(score)) {
                                cRank = s.classRanks ? s.classRanks[sub] : null;
                                gRank = s.gradeRanks ? s.gradeRanks[sub] : null;
                            }
                            mSubjectRankData[sub].classRank.push(cRank);
                            mSubjectRankData[sub].gradeRank.push(gRank);
                        });
                    } else {
                        // ç¼ºè€ƒ
                        mRankData.classRank.push(null);
                        mRankData.gradeRank.push(null);
                        dynamicSubjects.forEach(sub => {
                            mSubjectData[sub].push(null);
                            mSubjectRankData[sub].classRank.push(null);
                            mSubjectRankData[sub].gradeRank.push(null);
                        });
                    }
                });

                // ç”Ÿæˆå•ä¸ªHTMLå¹¶è¿½åŠ 
                fullHtml += generateSingleTableHTML(mate.name, mate.class, mate.id, mRankData, mSubjectData, mSubjectRankData);
            });

            // 3. è°ƒç”¨æ‰“å°
            if (typeof startMultiTablePrintJob === 'function') {
                startMultiTablePrintJob(`${currentStudentClass}-æ‰¹é‡æˆç»©å•`, fullHtml);
            } else {
                console.error("startMultiTablePrintJob æœªå®šä¹‰");
                alert("æ‰“å°åŠŸèƒ½å‡½æ•° startMultiTablePrintJob ç¼ºå¤±");
            }
        });
    }
}

/**
 * (    ) 11.7. æ‰“å¼€â€œå¯¼å…¥æ¥æºâ€æ¨¡æ€æ¡†
 */
async function openImportModal() {
    const importModal = document.getElementById('import-modal');
    const importModalSelect = document.getElementById('import-modal-select');
    const importModalFromStorageBtn = document.getElementById('import-modal-from-storage');

    // 1. (å¤ç”¨) åŠ è½½â€œæ¨¡å—åäºŒâ€çš„æ•°æ®
    const multiData = await loadMultiExamData();

    // 2. å¡«å……ä¸‹æ‹‰æ¡†
    if (multiData.length > 0) {
        importModalSelect.innerHTML = multiData.map(exam => {
            const label = `${exam.label} ${exam.isHidden ? '(å·²éšè—)' : ''}`;
            return `<option value="${exam.id}">${label} (åŸå§‹: ${exam.originalName})</option>`;
        }).join('');
        importModalSelect.disabled = false;
        importModalFromStorageBtn.disabled = false;
    } else {
        importModalSelect.innerHTML = '<option value="">â€œæ¨¡å—åäºŒâ€ä¸­æš‚æ— æ•°æ®</option>';
        importModalSelect.disabled = true;
        importModalFromStorageBtn.disabled = true;
    }

    // 3. æ˜¾ç¤ºæ¨¡æ€æ¡†
    importModal.style.display = 'flex';
}

// =====================================================================
// æ¨¡å—åä¸‰é€»è¾‘å·²è¿ç§»è‡³ js/modules/item-analysis/index.js

//    NEW    æ¨¡å—åå››ï¼šAI æ™ºèƒ½åˆ†æ (DeepSeek é›†æˆ)
// =====================================================================

/**
 * 14.0 [æ——èˆ°å®Œæ•´ç‰ˆ - å·²æ¸…æ´—] åˆå§‹åŒ– AI æ¨¡å—
 * - ä¿ç•™ï¼šæ‰¹é‡ç”Ÿæˆã€è‡ªåŠ¨è¡¥å½•ã€å†å²è®°å½•ç­‰æ ¸å¿ƒåŠŸèƒ½
 */
async function initAIModule() {

    initPromptManager();
    initAIHistoryUI(); 

    const apiKeyInput = document.getElementById('ai-api-key');
    const saveKeyBtn = document.getElementById('ai-save-key-btn');
    const analyzeBtn = document.getElementById('ai-analyze-btn');
    const searchInput = document.getElementById('ai-student-search');
    const modeSelect = document.getElementById('ai-mode-select');
    const itemSubjectWrapper = document.getElementById('ai-item-subject-wrapper');
    const itemSubjectSelect = document.getElementById('ai-item-subject');
    const itemClassWrapper = document.getElementById('ai-item-class-wrapper');
    const itemClassSelect = document.getElementById('ai-item-class');
    const studentSearchContainer = document.querySelector('.search-combobox');
    const qCountWrapper = document.getElementById('ai-q-count-wrapper');

    // ============================================================
    // 1. åŠ¨æ€æ³¨å…¥â€œæ‰¹é‡ç”Ÿæˆâ€æŒ‰é’®å’Œâ€œè¿›åº¦å¼¹çª—â€
    // ============================================================
    const controlBar = analyzeBtn.parentElement;
    
    if (!document.getElementById('ai-batch-btn')) {
        const batchBtn = document.createElement('button');
        batchBtn.id = 'ai-batch-btn';
        batchBtn.className = 'sidebar-button';
        batchBtn.style.cssText = "background-color: #fd7e14; margin-right: 10px;";
        batchBtn.innerHTML = "ğŸ“¦ æ‰¹é‡ç”Ÿæˆ";
        controlBar.insertBefore(batchBtn, analyzeBtn);

        const batchModalHtml = `
        <div id="ai-batch-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>ğŸ“¦ AI æ‰¹é‡æŠ¥å‘Šç”Ÿæˆå™¨</h3>
                    <span onclick="document.getElementById('ai-batch-modal').style.display='none'" class="modal-close-btn">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="ai-batch-config">
                        <div style="margin-bottom:10px; display:flex; gap:10px; align-items:center;">
                            <label style="font-weight:bold;">1. é€‰æ‹©ç­çº§:</label>
                            <select id="ai-batch-class" class="sidebar-select" style="flex:1;"></select>
                        </div>
                        <div style="margin-bottom:15px; border:1px solid #eee; padding:10px; border-radius:4px; background:#f9f9f9;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px;">
                                <label style="font-weight:bold; font-size:0.9em;">2. é€‰æ‹©å­¦ç”Ÿ:</label>
                                <div>
                                    <a href="javascript:void(0)" id="ai-batch-select-all" style="font-size:0.8em; color:#007bff; margin-right:10px; text-decoration:none;">å…¨é€‰</a>
                                    <a href="javascript:void(0)" id="ai-batch-select-none" style="font-size:0.8em; color:#666; text-decoration:none;">æ¸…ç©º</a>
                                </div>
                            </div>
                            <div id="ai-batch-student-list" style="max-height:150px; overflow-y:auto; display:grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap:5px;"></div>
                            <div id="ai-batch-selected-count" style="text-align:right; font-size:0.8em; color:#666; margin-top:5px;">å·²é€‰: 0 äºº</div>
                        </div>
                        <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
                            <label style="font-weight:bold;">åˆ†ææ¨¡å¼:</label>
                            <span id="ai-batch-mode-display" style="color:#6f42c1; font-weight:bold;">--</span>
                            <span style="font-size:0.8em; color:#999;">(è·Ÿéšä¸»ç•Œé¢é€‰æ‹©)</span>
                        </div>
                        <button id="ai-batch-start-btn" class="sidebar-button" style="width:100%; background-color:#6f42c1;">ğŸš€ å¼€å§‹æ‰¹é‡ç”Ÿæˆ</button>
                    </div>
                    <div id="ai-batch-progress-area" style="display:none;">
                        <div style="margin-bottom:5px; display:flex; justify-content:space-between;">
                            <span id="ai-batch-status">åˆå§‹åŒ–...</span>
                            <span id="ai-batch-count">0/0</span>
                        </div>
                        <div style="width:100%; background:#eee; height:10px; border-radius:5px; overflow:hidden; margin-bottom:15px;">
                            <div id="ai-batch-bar" style="width:0%; height:100%; background:#28a745; transition:width 0.3s;"></div>
                        </div>
                        <div id="ai-batch-log" style="height:150px; overflow-y:auto; background:#f8f9fa; border:1px solid #eee; padding:10px; font-size:0.85em; color:#555; margin-bottom:15px;"></div>
                        <div style="display:flex; gap:10px;">
                            <button id="ai-batch-save-btn" class="sidebar-button" style="flex:1; background-color:#17a2b8;" disabled onclick="window.saveBatchToHistory()">ğŸ’¾ æ‰¹é‡å­˜æ¡£</button>
                            <button id="ai-batch-print-btn" class="sidebar-button" style="flex:1; background-color:#28a745;" disabled>ğŸ–¨ï¸ æ‰¹é‡æ‰“å°</button>
                            <button id="ai-batch-stop-btn" class="sidebar-button" style="flex:0.5; background-color:#dc3545;">åœæ­¢â¹</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        
        document.body.insertAdjacentHTML('beforeend', batchModalHtml);
        
        // ç»‘å®šäº‹ä»¶
        batchBtn.addEventListener('click', openBatchModal);
        document.getElementById('ai-batch-start-btn').addEventListener('click', runBatchAnalysis);
        document.getElementById('ai-batch-print-btn').addEventListener('click', printBatchReports);
        document.getElementById('ai-batch-stop-btn').addEventListener('click', () => { window.stopBatchAI = true; });
        
        document.getElementById('ai-batch-select-all').onclick = () => toggleBatchSelection(true);
        document.getElementById('ai-batch-select-none').onclick = () => toggleBatchSelection(false);
        document.getElementById('ai-batch-class').addEventListener('change', () => {
            renderBatchStudentList(document.getElementById('ai-batch-class').value);
        });
    }

    // ============================================================
    // 2. å¸¸è§„åˆå§‹åŒ–
    // ============================================================

    // åŠ è½½ Key
    const savedKey = localStorage.getItem('G_DeepSeekKey');
    if (savedKey) {
        apiKeyInput.value = savedKey;
        document.getElementById('ai-key-status').style.display = 'inline';
    }

    // ç»‘å®šé¡¶éƒ¨æŒ‰é’®
    const sendFollowUpBtn = document.getElementById('ai-send-btn');
    if (sendFollowUpBtn) sendFollowUpBtn.addEventListener('click', sendAIFollowUp);
    
    const printReportBtn = document.getElementById('ai-print-btn');
    if (printReportBtn) printReportBtn.addEventListener('click', printAIReport);

    const printRangeBtn = document.getElementById('ai-print-range-btn');
    if (printRangeBtn) {
        printRangeBtn.addEventListener('click', () => {
            const input = prompt("è¯·è¾“å…¥è¦æ‰“å°çš„å¯¹è¯è½®æ¬¡ (ä¾‹å¦‚ '1' æˆ– '1-3')ï¼š", "1");
            if (input) printRangeReport(input);
        });
    }

    saveKeyBtn.addEventListener('click', () => {
        const key = apiKeyInput.value.trim();
        if (key.startsWith('sk-')) {
            localStorage.setItem('G_DeepSeekKey', key);
            document.getElementById('ai-key-status').style.display = 'inline';
            alert('API Key å·²ä¿å­˜ï¼');
        } else { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ DeepSeek API Key'); }
    });

    // ç‹¬ç«‹çš„æ›´æ–°ç­çº§åˆ—è¡¨å‡½æ•°
    const updateClassList = () => {
        const subject = itemSubjectSelect.value;
        if (!subject || !window.G_ItemAnalysisData || !window.G_ItemAnalysisData[subject]) {
            itemClassSelect.innerHTML = `<option value="ALL">-- å…¨ä½“å¹´æ®µ --</option>`;
            return;
        }
        const students = window.G_ItemAnalysisData[subject].students;
        const classes = [...new Set(students.map(s => s.class))].sort();
        const currentClass = itemClassSelect.value;
        let html = `<option value="ALL">-- å…¨ä½“å¹´æ®µ --</option>`;
        html += classes.map(c => `<option value="${c}">${c}</option>`).join('');
        itemClassSelect.innerHTML = html;
        if (currentClass && (classes.includes(currentClass) || currentClass === 'ALL')) {
            itemClassSelect.value = currentClass;
        }
    };

    itemSubjectSelect.addEventListener('change', updateClassList);

    // ç›‘å¬æ¨¡å¼å˜åŒ– (è‡ªåŠ¨è¡¥å½•æ•°æ®)
    modeSelect.addEventListener('change', async () => {
        const val = modeSelect.value;
        if (qCountWrapper) qCountWrapper.style.display = (val === 'question') ? 'inline-flex' : 'none';

        // æ§åˆ¶æŒ‰é’®å¯ç”¨çŠ¶æ€
        if (val === 'teaching_guide') {
            analyzeBtn.disabled = false;
        } else {
            if (searchInput.dataset.selectedId) analyzeBtn.disabled = false;
            else analyzeBtn.disabled = true;
        }

        if (val === 'item_diagnosis' || val === 'teaching_guide') {
            itemSubjectWrapper.style.display = 'inline-flex';
            
            // å°è¯•è¡¥è½½æ•°æ®
            if (!window.G_ItemAnalysisData || Object.keys(window.G_ItemAnalysisData).length === 0) {
                try {
                    itemSubjectSelect.innerHTML = `<option>âŒ›ï¸ åŠ è½½ä¸­...</option>`;
                    const storedData = await localforage.getItem('G_ItemAnalysisData');
                    const storedConfig = await localforage.getItem('G_ItemAnalysisConfig');
                    if (storedData) {
                        window.G_ItemAnalysisData = storedData;
                        window.G_ItemAnalysisConfig = storedConfig || {};
                    }
                } catch (e) { console.error(e); }
            }

            if (window.G_ItemAnalysisData && Object.keys(window.G_ItemAnalysisData).length > 0) {
                const subjects = Object.keys(window.G_ItemAnalysisData);
                const currentVal = itemSubjectSelect.value;
                itemSubjectSelect.innerHTML = subjects.map(s => `<option value="${s}">${s}</option>`).join('');
                if (!currentVal || !subjects.includes(currentVal)) itemSubjectSelect.value = subjects[0];
                if (typeof updateClassList === 'function') updateClassList();
            } else {
                itemSubjectSelect.innerHTML = `<option value="">è¯·å…ˆå¯¼å…¥æ•°æ®</option>`;
                itemClassSelect.innerHTML = `<option value="ALL">-- å…¨ä½“å¹´æ®µ --</option>`;
            }

            if (val === 'teaching_guide') {
                studentSearchContainer.style.display = 'none';
                itemClassWrapper.style.display = 'inline-flex';
            } else {
                studentSearchContainer.style.display = 'inline-block';
                itemClassWrapper.style.display = 'none';
            }
        } else {
            itemSubjectWrapper.style.display = 'none';
            itemClassWrapper.style.display = 'none';
            studentSearchContainer.style.display = 'inline-block';
        }
    });

    // å¤åˆ¶æŒ‰é’®
    document.getElementById('ai-copy-btn').addEventListener('click', () => {
        const content = document.getElementById('ai-content').innerText;
        navigator.clipboard.writeText(content).then(() => alert('å†…å®¹å·²å¤åˆ¶'));
    });

    // ============================================================
    // 3. ç‚¹å‡»ä¸»åˆ†ææŒ‰é’® (å•æ¬¡ç”Ÿæˆ)
    // ============================================================
    analyzeBtn.addEventListener('click', () => {
        const studentId = searchInput.dataset.selectedId || "";
        const studentName = searchInput.dataset.selectedName || "å…¨ä½“åŒå­¦";
        const mode = document.getElementById('ai-mode-select').value;
        const model = document.getElementById('ai-model-select').value;
        const qCount = document.getElementById('ai-q-count').value;
        const grade = document.getElementById('ai-grade-select').value;
        
        let targetSubject = document.getElementById('ai-item-subject').value;
        if (mode !== 'item_diagnosis' && mode !== 'teaching_guide') targetSubject = "";
        const targetClass = document.getElementById('ai-item-class').value || 'ALL';
        const apiKey = localStorage.getItem('G_DeepSeekKey');

        if (!apiKey) { alert('è¯·å…ˆè®¾ç½® DeepSeek API Key'); return; }

        if (mode === 'teaching_guide' || mode === 'item_diagnosis') {
            if (!targetSubject) { alert("è¯·é€‰æ‹©ä¸€ä¸ªç§‘ç›®ï¼"); return; }
            if (!window.G_ItemAnalysisData) { alert("æ— æ³•è¯»å–æ•°æ®ï¼Œè¯·å…ˆå»æ¨¡å—13å¯¼å…¥ï¼"); return; }
            if (!window.G_ItemAnalysisData[targetSubject]) { alert(`æ‰¾ä¸åˆ°ç§‘ç›®ã€${targetSubject}ã€‘çš„æ•°æ®ã€‚`); return; }
            if (mode === 'item_diagnosis' && !studentId) { alert('è¯·å…ˆé€‰æ‹©ä¸€åå­¦ç”Ÿ'); return; }
        } else {
            if (!studentId) { alert('è¯·å…ˆé€‰æ‹©ä¸€åå­¦ç”Ÿ'); return; }
        }

        runAIAnalysis(apiKey, studentId, studentName, mode, model, qCount, grade, targetSubject, targetClass);
    });
    
    // 4. åˆå§‹åŒ–æœç´¢é€»è¾‘ (ä¸€æ¬¡æ€§è°ƒç”¨ï¼Œæ›¿ä»£äº†ä¹‹å‰çš„é‡å¤ä»£ç )
    initStudentSearchLogic();
}

/**
 * [é‡æ„ç‰ˆ] ç”Ÿæˆ AI æç¤ºè¯
 * é€»è¾‘ï¼šå‡†å¤‡æ•°æ®ä¸Šä¸‹æ–‡ (dataContextStr) -> è¯»å–ç”¨æˆ·æ¨¡æ¿ -> æ›¿æ¢å˜é‡
 */
async function generateAIPrompt(studentId, studentName, mode, qCount = 3, grade = "é«˜ä¸‰", targetSubject = "", targetClass = "ALL") {

    // 1. åŠ è½½æ¨¡æ¿ (å¦‚æœè¯»å–å¤±è´¥åˆ™ä½¿ç”¨é»˜è®¤)
    // ç¡®ä¿ DEFAULT_PROMPTS å·²ç»åœ¨å…¨å±€å®šä¹‰è¿‡ (è§ä¸‹æ–‡è¡¥å……)
    const prompts = JSON.parse(localStorage.getItem('G_AI_Prompts')) || DEFAULT_PROMPTS;
    const activeId = localStorage.getItem('G_AI_ActivePromptId') || 'default';
    const template = prompts[activeId] || prompts['default'];

    // 2. å‡†å¤‡æ•°æ®ä¸Šä¸‹æ–‡ (Data Context)
    // æˆ‘ä»¬å°†æ ¹æ®ä¸åŒçš„ modeï¼Œç”Ÿæˆä¸€æ®µè¯¦ç»†çš„æ•°æ®æè¿°æ–‡æœ¬ï¼Œæœ€åå¡«å…¥ {{data_context}}
    let dataContextStr = "";
    let paperContextInfo = "";

    // [é€šç”¨] å°è¯•è·å–è¯•å·åŸé¢˜æ–‡æœ¬ (å¦‚æœå­˜åœ¨)
    if (targetSubject && window.G_ItemAnalysisConfig && window.G_ItemAnalysisConfig[targetSubject]) {
        const fullText = window.G_ItemAnalysisConfig[targetSubject]['_full_paper_context_'];
        if (fullText && fullText.trim() !== "") {
            paperContextInfo = `\n=== ğŸ“„ é™„ï¼šæœ¬æ¬¡è€ƒè¯•å®Œæ•´è¯•å·å†…å®¹ ===\n${fullText.substring(0, 15000)}\n============================\n\n`;
        }
    }

    // ============================================================
    // åœºæ™¯ A: æ•™å¸ˆæ•™å­¦æŒ‡å¯¼ (ç­çº§/å¹´çº§è§†è§’)
    // ============================================================
    if (mode === 'teaching_guide') {
        if (!window.G_ItemAnalysisData || !window.G_ItemAnalysisData[targetSubject]) {
            return { system: template.system, user: "é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°è¯¥ç§‘ç›®çš„å°é¢˜æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥æ¨¡å—13ã€‚" };
        }

        const itemData = window.G_ItemAnalysisData[targetSubject];
        const itemConfig = window.G_ItemAnalysisConfig ? (window.G_ItemAnalysisConfig[targetSubject] || {}) : {};

        // ç­›é€‰å­¦ç”Ÿ
        let targetStudents = itemData.students;
        let scopeName = "å…¨å¹´æ®µ";
        if (targetClass !== 'ALL') {
            targetStudents = itemData.students.filter(s => s.class === targetClass);
            scopeName = targetClass;
        }

        dataContextStr += `ã€åˆ†æèŒƒå›´ã€‘ï¼š${scopeName} (å…±${targetStudents.length}äºº)\n`;
        dataContextStr += `ã€åˆ†æä»»åŠ¡ã€‘ï¼šè¯·åˆ†æè¯¥ç¾¤ä½“çš„å¾—åˆ†ç‡æ•°æ®ï¼Œæ‰¾å‡ºå…±æ€§è–„å¼±ç‚¹ã€‚\n\n`;
        dataContextStr += `ã€è¯¦ç»†å¾—åˆ†ç‡æ•°æ®ã€‘ï¼š\n`;
        dataContextStr += `| é¢˜å· | çŸ¥è¯†ç‚¹ | æœ¬æ¬¡å¾—åˆ†ç‡ | æ»¡åˆ† |\n|---|---|---|---|\n`;

        // è¾…åŠ©ï¼šè®¡ç®—å¾—åˆ†ç‡è¡¨æ ¼
        const appendRates = (qList, scoreKey, statsObj) => {
            qList.forEach(qName => {
                const gradeStat = statsObj[qName];
                if (!gradeStat) return;

                const config = itemConfig[qName] || {};
                const fullScore = config.fullScore || gradeStat.maxScore;
                const content = config.content || "æœªæ ‡è®°";

                if (fullScore > 0) {
                    let total = 0, count = 0;
                    targetStudents.forEach(s => {
                        const v = s[scoreKey][qName];
                        if (typeof v === 'number') { total += v; count++; }
                    });
                    const avg = count > 0 ? total / count : 0;
                    const ratio = (avg / fullScore * 100).toFixed(1);
                    dataContextStr += `| ${qName} | ${content} | ${ratio}% | ${fullScore} |\n`;
                }
            });
        };

        appendRates(itemData.minorQuestions, 'minorScores', itemData.minorStats);
        appendRates(itemData.majorQuestions, 'majorScores', itemData.majorStats);
    }

    // ============================================================
    // åœºæ™¯ B: å­¦ç”Ÿå°é¢˜æ·±åº¦è¯Šæ–­ (ä¸ªäººè§†è§’)
    // ============================================================
    else if (mode === 'item_diagnosis') {
        if (!window.G_ItemAnalysisData || !window.G_ItemAnalysisData[targetSubject]) {
            return { system: template.system, user: "é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°è¯¥ç§‘ç›®çš„å°é¢˜æ•°æ®ã€‚" };
        }
        const itemData = window.G_ItemAnalysisData[targetSubject];
        const itemConfig = window.G_ItemAnalysisConfig ? (window.G_ItemAnalysisConfig[targetSubject] || {}) : {};

        // æŸ¥æ‰¾å­¦ç”Ÿ
        let studentDetails = itemData.students.find(s => String(s.id) === String(studentId));
        if (!studentDetails) studentDetails = itemData.students.find(s => s.name === studentName);

        if (!studentDetails) {
            return { system: template.system, user: `é”™è¯¯ï¼šæœªåœ¨ç§‘ç›®ã€${targetSubject}ã€‘ä¸­æ‰¾åˆ°è¯¥å­¦ç”Ÿæ•°æ®ã€‚` };
        }

        dataContextStr += `ã€è¯•å·æ€»åˆ†ã€‘ï¼š${studentDetails.totalScore}\n`;
        dataContextStr += `ã€å°é¢˜å¾—åˆ†è¯¦æƒ…ã€‘(é¢˜å· | çŸ¥è¯†ç‚¹ | å¾—åˆ†/æ»¡åˆ† | ç­çº§å‡åˆ† | ä¸ªäººå¾—åˆ†ç‡)ï¼š\n`;

        const processQuestions = (qList, scoreObj, statsObj) => {
            qList.forEach(qName => {
                const score = scoreObj[qName];
                const stat = statsObj[qName];
                const config = itemConfig[qName] || {};
                const fullScore = config.fullScore || stat.maxScore;
                const content = config.content || "æœªæ ‡è®°";

                if (typeof score === 'number') {
                    const ratio = (fullScore > 0) ? (score / fullScore).toFixed(2) : 0;
                    // åªåˆ—å‡ºå¾—åˆ†ç‡ä½äº 0.8 çš„é¢˜ç›®ï¼Œæˆ–è€…æ˜¯å¤§é¢˜ï¼Œé¿å…æ•°æ®è¿‡é•¿
                    // (æˆ–è€…å…¨éƒ¨åˆ—å‡ºï¼ŒAI å¤„ç†èƒ½åŠ›å¾ˆå¼º)
                    dataContextStr += `- é¢˜${qName} | ${content} | å¾—${score} (æ»¡${fullScore}) | ç­å‡${stat.avg} | ç‡${ratio}\n`;
                }
            });
        };

        dataContextStr += `--- å®¢è§‚é¢˜ ---\n`;
        processQuestions(itemData.minorQuestions, studentDetails.minorScores, itemData.minorStats);
        dataContextStr += `--- ä¸»è§‚é¢˜ ---\n`;
        processQuestions(itemData.majorQuestions, studentDetails.majorScores, itemData.majorStats);
    }

    // ============================================================
    // åœºæ™¯ C: ç»¼åˆè¶‹åŠ¿ / åç§‘ / å‡ºé¢˜ (é€šç”¨æ•°æ®)
    // ============================================================
    else {
        // 1. è·å–å†å²æ•°æ®
        const multiData = (await loadMultiExamData()).filter(e => !e.isHidden);
        dataContextStr += `ã€å†å²è€ƒè¯•æ•°æ®ã€‘ï¼š\n`;

        if (multiData.length === 0) {
            dataContextStr += `(æš‚æ— å†å²æ•°æ®)\n`;
        } else {
            multiData.forEach(exam => {
                const s = exam.students.find(st => String(st.id) === String(studentId));
                if (s) {
                    dataContextStr += `- ${exam.label}: æ€»åˆ†${s.totalScore} (ç­æ’${s.rank}, å¹´æ’${s.gradeRank || '-'}); `;
                    // ç®€ç•¥å„ç§‘
                    const scores = [];
                    for (let k in s.scores) scores.push(`${k}:${s.scores[k]}`);
                    dataContextStr += scores.join(', ') + "\n";
                }
            });
        }

        // 2. è·å–æœ¬æ¬¡è¯¦æƒ…
        const currentStudent = G_StudentsData.find(s => String(s.id) === String(studentId));
        if (currentStudent) {
            dataContextStr += `\nã€æœ¬æ¬¡è€ƒè¯•è¯¦æƒ…ã€‘ï¼š\n`;
            dataContextStr += `æ€»åˆ†: ${currentStudent.totalScore}, ç­æ’: ${currentStudent.rank}\n`;
            dataContextStr += `å„ç§‘æ˜ç»† (ç§‘ç›®: åˆ†æ•° | ç­æ’ | å¹´æ’ | Tåˆ†):\n`;

            G_DynamicSubjectList.forEach(sub => {
                const score = currentStudent.scores[sub];
                if (score !== undefined) {
                    const cr = currentStudent.classRanks ? currentStudent.classRanks[sub] : '-';
                    const gr = currentStudent.gradeRanks ? currentStudent.gradeRanks[sub] : '-';
                    const tScore = (currentStudent.tScores && currentStudent.tScores[sub]) ? currentStudent.tScores[sub] : '-';
                    dataContextStr += `- ${sub}: ${score} | ${cr} | ${gr} | T:${tScore}\n`;
                }
            });
        }

        // 3. ç‰¹å®šæ¨¡å¼è¡¥å……è¯´æ˜
        if (mode === 'question') {
            dataContextStr += `\nã€ç‰¹æ®ŠæŒ‡ä»¤ã€‘ï¼šè¯·é’ˆå¯¹è¯¥ç”Ÿæœ€è–„å¼±çš„å­¦ç§‘ï¼Œç”Ÿæˆ ${qCount} é“é€‚åˆ ${grade} æ°´å¹³çš„ç»ƒä¹ é¢˜ã€‚`;
        }
    }

    // 3. æ‹¼æ¥æœ€ç»ˆ Prompt
    // å°†è¯•å·å†…å®¹æ”¾åœ¨æœ€å‰é¢ï¼Œæ•°æ®æ”¾åœ¨ä¸­é—´
    const fullDataContext = paperContextInfo + dataContextStr;

    // æ‰§è¡Œæ¨¡æ¿æ›¿æ¢
    let finalUserPrompt = template.user
        .replace(/{{name}}/g, studentName)
        .replace(/{{grade}}/g, grade)
        .replace(/{{subject}}/g, targetSubject || "ç»¼åˆ")
        .replace(/{{score}}/g, "") // ç®€å•ç½®ç©ºï¼Œå…·ä½“æ•°æ®åœ¨ data_context é‡Œ
        .replace(/{{rank}}/g, "")
        .replace(/{{data_context}}/g, fullDataContext);

    // è¿”å›ç¬¦åˆ API æ ¼å¼çš„å¯¹è±¡
    return {
        system: template.system,
        user: finalUserPrompt
    };
}

/**
 * 3. è°ƒç”¨ DeepSeek API (æœ€ç»ˆå®Œæ•´ç‰ˆ)
 * - æ”¯æŒ Prompt æ¨¡æ¿ (ä» generateAIPrompt è·å– system/user)
 * - åŒ…å«æµå¼è¾“å‡ºèŠ‚æµ (Throttle) ä¼˜åŒ–ï¼Œé˜²æ­¢é¡µé¢å¡é¡¿
 * - åŒ…å«æ™ºèƒ½æ»šå± (Smart Auto-scroll)
 * - åŒ…å«åº•éƒ¨å›ºå®šè¾“å…¥æ¡†çŠ¶æ€ç®¡ç†
 */
async function runAIAnalysis(apiKey, studentId, studentName, mode, model, qCount, grade, targetSubject, targetClass) {
    const resultContainer = document.getElementById('ai-result-container');
    const loadingDiv = document.getElementById('ai-loading');
    const contentDiv = document.getElementById('ai-content');
    const chatHistoryDiv = document.getElementById('ai-chat-history');

    // åº•éƒ¨UIå…ƒç´ 
    const inputArea = document.getElementById('ai-followup-input-area');
    const floatingStopBtn = document.getElementById('ai-floating-stop-btn');
    const sendBtn = document.getElementById('ai-send-btn');

    // UI åˆå§‹åŒ–æ£€æŸ¥
    if (typeof marked === 'undefined') { alert("é”™è¯¯ï¼šmarked.js æœªåŠ è½½ï¼"); return; }

    // æ˜¾ç¤ºåŒºåŸŸï¼Œæ¸…ç©ºæ—§å†å²
    resultContainer.style.display = 'block';
    if (chatHistoryDiv) chatHistoryDiv.innerHTML = '';

    // [å…³é”®] ç¡®ä¿è¾“å…¥æ¡†å¯è§ï¼Œç¦ç”¨å‘é€æŒ‰é’®
    if (inputArea) inputArea.style.display = 'flex';
    if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerText = 'ç”Ÿæˆä¸­...';
    }
    // æ˜¾ç¤ºåœæ­¢æŒ‰é’®
    if (floatingStopBtn) floatingStopBtn.style.display = 'flex';

    // 1. æ„å»ºé™æ€ HTML ç»“æ„ (ç©ºå£³)ï¼Œé˜²æ­¢é‡ç»˜å¯¼è‡´æŠ˜å å¤±æ•ˆ
    contentDiv.innerHTML = `
        <div id="ai-response-wrapper">
            <details id="current-reasoning-box" class="ai-reasoning-box" style="display:none;" open>
                <summary><span>ğŸ§  æ·±åº¦æ€è€ƒè¿‡ç¨‹ (ç‚¹å‡»åˆ‡æ¢)</span></summary>
                <div id="current-reasoning-text" class="ai-reasoning-content"></div>
            </details>
            <div id="current-answer-text" class="typing-cursor" style="min-height: 50px;"></div>
        </div>
    `;

    const reasoningBox = document.getElementById('current-reasoning-box');
    const reasoningTextEl = document.getElementById('current-reasoning-text');
    const answerTextEl = document.getElementById('current-answer-text');

    // Loading åŠ¨ç”»
    loadingDiv.style.display = 'block';

    // [å…³é”®] é‡ç½®å½“å‰å†å²è®°å½• ID (  åˆ†æ =   è®°å½•)
    G_CurrentHistoryId = null;

    // AbortController è®¾ç½® (ç”¨äºåœæ­¢ç”Ÿæˆ)
    if (currentAIController) currentAIController.abort();
    currentAIController = new AbortController();

    // å˜é‡æå‡ (ç”¨äºåœæ­¢æ—¶ä¿å­˜)
    let fullReasoning = "";
    let fullContent = "";

    // å®šä¹‰åœæ­¢é€»è¾‘
    const handleStop = () => {
        if (currentAIController) {
            currentAIController.abort();
            currentAIController = null;

            // UI æ¢å¤
            if (floatingStopBtn) floatingStopBtn.style.display = 'none';
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.innerText = 'å‘é€';
            }

            answerTextEl.classList.remove('typing-cursor');
            answerTextEl.innerHTML += `<br><br><em style="color: #dc3545;">(ç”¨æˆ·æ‰‹åŠ¨åœæ­¢äº†ç”Ÿæˆ)</em>`;

            // è§¦å‘ä¿å­˜é€»è¾‘ (å¦‚æœå·²æœ‰å†…å®¹)
            if (fullContent && fullContent.length > 0) {
                const modeEl = document.getElementById('ai-mode-select');
                const modeText = modeEl ? modeEl.selectedOptions[0].text : "AIåˆ†æ";
                let historyTitle = `${studentName} - ${modeText}`;
                if (mode === 'teaching_guide') historyTitle = `æ•™å­¦æŒ‡å¯¼ - ${targetSubject}`;

                // ä¿å­˜æœªå®Œæˆçš„è®°å½•
                saveToAIHistory(historyTitle, `${grade} | ${targetSubject} (æœªå®Œæˆ)`, G_CurrentHistoryId);
            }
        }
    };

    // ç»‘å®šåœæ­¢äº‹ä»¶
    if (floatingStopBtn) floatingStopBtn.onclick = handleStop;

    try {
        // 2. ç”Ÿæˆ Prompt (ä½¿ç”¨æ¨¡æ¿)
        // æ³¨æ„ï¼šgenerateAIPrompt ç°åœ¨è¿”å›å¯¹è±¡ { system: "...", user: "..." }
        const promptData = await generateAIPrompt(studentId, studentName, mode, qCount, grade, targetSubject, targetClass);

        // æ£€æŸ¥ Prompt ç”Ÿæˆæ˜¯å¦æŠ¥é”™ (å­—ç¬¦ä¸²å½¢å¼çš„é”™è¯¯)
        if (promptData.user && (promptData.user.startsWith('é”™è¯¯ï¼š') || promptData.user.startsWith('ç³»ç»Ÿé”™è¯¯ï¼š'))) {
            throw new Error(promptData.user);
        }

        // åˆå§‹åŒ–å¯¹è¯å†å² (ä½¿ç”¨æ¨¡æ¿ä¸­çš„ System Prompt)
        const temp = (model === 'deepseek-reasoner') ? 0.6 : 0.7;
        G_AIChatHistory = [
            { "role": "system", "content": promptData.system },
            { "role": "user", "content": promptData.user }
        ];

        // 3. å‘èµ· Fetch è¯·æ±‚
        const response = await fetch('https://api.deepseek.com/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model: model, messages: G_AIChatHistory, temperature: temp, stream: true }),
            signal: currentAIController.signal
        });

        if (!response.ok) {
            const errJson = await response.json().catch(() => ({}));
            throw new Error(errJson.error?.message || `API è¯·æ±‚å¤±è´¥: ${response.status}`);
        }

        // å¼€å§‹æ¥æ”¶æµ
        loadingDiv.style.display = 'none';
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");

        //    æ ¸å¿ƒä¼˜åŒ–    èŠ‚æµæ¸²æŸ“å˜é‡
        let lastRenderTime = 0;
        const RENDER_INTERVAL = 100; // æ¯ 100ms æ¸²æŸ“ä¸€æ¬¡ Markdownï¼Œé˜²æ­¢é¡µé¢é—ªçƒ

        //    æ ¸å¿ƒä¼˜åŒ–    æ™ºèƒ½æ»šå±æ£€æµ‹
        // æˆ‘ä»¬ç›‘å¬çª—å£æ»šåŠ¨ï¼Œåªæœ‰å½“ç”¨æˆ·æœ¬æ¥å°±åœ¨æœ€åº•éƒ¨æ—¶ï¼ŒAIç”Ÿæˆå†…å®¹æ‰è‡ªåŠ¨æ»šåŠ¨
        // å¦‚æœç”¨æˆ·å¾€ä¸Šç¿»çœ‹å†å²ï¼ŒAIç”Ÿæˆæ—¶ä¸ä¼šå¼ºåˆ¶æŠŠç”¨æˆ·æ‹‰å›åº•éƒ¨
        let isUserAtBottom = true;
        const checkScroll = () => {
            const threshold = 100; // å®¹å·®
            // ä½¿ç”¨ document.documentElement (æ•´ä¸ªé¡µé¢) æˆ– main-content
            const el = document.documentElement;
            isUserAtBottom = (el.scrollHeight - el.scrollTop - el.clientHeight) <= threshold;
        };
        window.addEventListener('scroll', checkScroll);

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed === 'data: [DONE]') continue;
                if (trimmed.startsWith('data: ')) {
                    try {
                        const json = JSON.parse(trimmed.slice(6));
                        const delta = json.choices[0].delta;

                        // A. å¤„ç†æ€è€ƒè¿‡ç¨‹ (R1) - çº¯æ–‡æœ¬ï¼Œç›´æ¥è¿½åŠ å³å¯
                        if (delta.reasoning_content) {
                            if (fullReasoning === "") {
                                reasoningBox.style.display = "block";
                            }
                            fullReasoning += delta.reasoning_content;
                            reasoningTextEl.textContent = fullReasoning;
                            // æ€è€ƒè¿‡ç¨‹é»˜è®¤è‡ªåŠ¨æ»šåŠ¨
                            // reasoningTextEl.scrollTop = reasoningTextEl.scrollHeight;
                        }

                        // B. å¤„ç†æ­£æ–‡å†…å®¹ - èŠ‚æµæ¸²æŸ“ Markdown
                        if (delta.content) {
                            fullContent += delta.content;

                            const now = Date.now();
                            // åªæœ‰é—´éš”è¶…è¿‡ 100ms æ‰é‡  è§£æ Markdown å¹¶æ¸²æŸ“ DOM
                            if (now - lastRenderTime > RENDER_INTERVAL) {
                                renderMarkdownWithMath(answerTextEl, fullContent);
                                lastRenderTime = now;

                                // æ™ºèƒ½æ»šåŠ¨ï¼šä»…å½“ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ»šåŠ¨
                                if (isUserAtBottom) {
                                    // æ»šåŠ¨æ•´ä¸ªçª—å£åˆ°åº•éƒ¨
                                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'auto' });
                                }
                            }
                        }
                    } catch (e) { }
                }
            }
        }

        // ç§»é™¤æ»šåŠ¨ç›‘å¬
        window.removeEventListener('scroll', checkScroll);

        // 4. å¾ªç¯ç»“æŸï¼šç¡®ä¿æœ€åä¸€æ¬¡å†…å®¹è¢«å®Œæ•´æ¸²æŸ“
        renderMarkdownWithMath(answerTextEl, fullContent);
        // æœ€åå¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });

        // ç”Ÿæˆç»“æŸï¼Œæ›´  å†å²ä¸Šä¸‹æ–‡
        G_AIChatHistory.push({ "role": "assistant", "content": fullContent });

        // 5. è‡ªåŠ¨ä¿å­˜åˆ°å†å²è®°å½•å­˜æ¡£
        const modeEl = document.getElementById('ai-mode-select');
        const modeText = modeEl ? modeEl.selectedOptions[0].text : "AIåˆ†æ";
        let historyTitle = `${studentName} - ${modeText}`;
        if (mode === 'teaching_guide') historyTitle = `æ•™å­¦æŒ‡å¯¼ - ${targetSubject}`;

        // ä¼ å…¥ G_CurrentHistoryId (æ­¤æ—¶ä¸º null)ï¼Œè¿”å›  ç”Ÿæˆçš„ ID
        const newId = saveToAIHistory(historyTitle, `${grade} | ${targetSubject}`, G_CurrentHistoryId);
        G_CurrentHistoryId = newId; // æ›´  å…¨å±€ ID

    } catch (err) {
        loadingDiv.style.display = 'none';
        if (err.name === 'AbortError') {
            // å·²åœ¨ handleStop å¤„ç†
            answerTextEl.classList.remove('typing-cursor');
        } else {
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            answerTextEl.innerHTML = `
                <div style="padding: 20px; background-color: #fff5f5; border-left: 5px solid #dc3545; color: #721c24;">
                    <h3>âš ï¸ å‡ºé”™äº†</h3>
                    <p>${err.message}</p>
                </div>
            `;
        }
    } finally {
        answerTextEl.classList.remove('typing-cursor');
        if (floatingStopBtn) floatingStopBtn.style.display = 'none';
        if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.innerText = 'å‘é€';
        }
        currentAIController = null;
    }
}


// ============================================================
//    NEW Feature: è·¨è€ƒè¯•éš¾åº¦åŠ æƒå¯¹æ¯”åˆ†æ
// ============================================================

// 1. åˆå§‹åŒ–å¯¹æ¯”ä¸‹æ‹‰æ¡† (å¢å¼ºç‰ˆï¼šæ”¯æŒåŠ¨æ€åŠ è½½ç§‘ç›®)
async function initDiffCompareUI() {
    const selectA = document.getElementById('comp-exam-a');
    const selectB = document.getElementById('comp-exam-b');
    const selectSub = document.getElementById('comp-subject-select');
    
    if (!selectA || !selectB || !selectSub) return;

    // 1. åŠ è½½æ‰€æœ‰å¯ç”¨è€ƒè¯• (å½“å‰ + å†å²å­˜æ¡£)
    const library = await localforage.getItem('G_ItemAnalysis_Library') || [];
    
    // æ„å»ºé€‰é¡¹ï¼šå½“å‰æ•°æ® + å†å²æ•°æ®
    let optionsHtml = `<option value="current">å½“å‰æ­£åœ¨åˆ†æçš„æ•°æ® (æœªå­˜æ¡£)</option>`;
    optionsHtml += library.map(item => `<option value="${item.id}">${item.name} (${item.date})</option>`).join('');

    selectA.innerHTML = optionsHtml;
    selectB.innerHTML = optionsHtml;

    // 2. å®šä¹‰ï¼šæ ¹æ®é€‰ä¸­çš„è€ƒè¯•IDï¼ŒåŠ¨æ€æ›´æ–°ç§‘ç›®åˆ—è¡¨
    const updateSubjectList = async () => {
        const examId = selectA.value; // ä»¥è€ƒè¯• A ä¸ºå‡†
        let subjects = [];

        if (examId === 'current') {
            // è¯»å–å½“å‰å†…å­˜æ•°æ®
            if (window.G_ItemAnalysisData) {
                subjects = Object.keys(window.G_ItemAnalysisData);
            }
        } else {
            // è¯»å–å†å²å­˜æ¡£æ•°æ®
            const lib = await localforage.getItem('G_ItemAnalysis_Library') || [];
            const record = lib.find(r => r.id === examId);
            if (record && record.data) {
                subjects = Object.keys(record.data);
            }
        }

        // æ¸²æŸ“ç§‘ç›®ä¸‹æ‹‰æ¡†
        if (subjects.length > 0) {
            // è®°å½•å½“å‰é€‰ä¸­çš„å€¼ï¼Œå°è¯•åœ¨åˆ·æ–°åä¿æŒ
            const oldVal = selectSub.value;
            selectSub.innerHTML = subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            if (subjects.includes(oldVal)) selectSub.value = oldVal;
        } else {
            selectSub.innerHTML = `<option value="">æ— å¯ç”¨ç§‘ç›®</option>`;
        }
    };

    // 3. ç»‘å®šäº‹ä»¶ï¼šå½“è€ƒè¯•Aå˜åŒ–æ—¶ï¼Œåˆ·æ–°ç§‘ç›®åˆ—è¡¨
    selectA.onchange = updateSubjectList;

    // 4. ç»‘å®šå¯¹æ¯”æŒ‰é’®äº‹ä»¶
    document.getElementById('btn-run-diff-compare').onclick = performDiffCompare;

    // 5. åˆå§‹æ‰§è¡Œä¸€æ¬¡ï¼Œå¡«æ»¡ç§‘ç›®
    await updateSubjectList();
}



// 2. æ ¸å¿ƒè®¡ç®—é€»è¾‘
async function performDiffCompare() {
    const idA = document.getElementById('comp-exam-a').value;
    const idB = document.getElementById('comp-exam-b').value;
    const subject = document.getElementById('comp-subject-select').value;

    if (!idA || !idB) { alert("è¯·é€‰æ‹©ä¸¤æ¬¡è€ƒè¯•è¿›è¡Œå¯¹æ¯”"); return; }

    // è¾…åŠ©ï¼šåŠ è½½æ•°æ®
    const loadData = async (id) => {
        if (id === 'current') {
            return { 
                data: window.G_ItemAnalysisData, 
                config: window.G_ItemAnalysisConfig,
                name: "å½“å‰æ•°æ®"
            };
        } else {
            const library = await localforage.getItem('G_ItemAnalysis_Library') || [];
            const record = library.find(r => r.id === id);
            return record ? { data: record.data, config: record.config, name: record.name } : null;
        }
    };

    const recA = await loadData(idA);
    const recB = await loadData(idB);

    if (!recA || !recA.data[subject]) { alert(`è€ƒè¯•Aä¸­æœªæ‰¾åˆ°ç§‘ç›®ï¼š${subject}`); return; }
    if (!recB || !recB.data[subject]) { alert(`è€ƒè¯•Bä¸­æœªæ‰¾åˆ°ç§‘ç›®ï¼š${subject}`); return; }

    // æ ¸å¿ƒå…¬å¼è®¡ç®—å‡½æ•°
    // Formula: Sum( (1 - Difficulty) * QuestionTotalScore ) / StudentCount
    const calculateWeightedMetric = (examRecord, subName) => {
        const itemData = examRecord.data[subName];
        const itemConfig = examRecord.config[subName] || {};
        const students = itemData.students;
        
        // è·å–æ‰€æœ‰é¢˜ç›®
        const allQuestions = [...(itemData.minorQuestions||[]), ...(itemData.majorQuestions||[])];
        
        // æŒ‰ç­çº§åˆ†ç»„
        const classMap = { 'å…¨å¹´æ®µ': students };
        students.forEach(s => {
            if (!classMap[s.class]) classMap[s.class] = [];
            classMap[s.class].push(s);
        });

        const results = {}; // { "å…¨å¹´æ®µ": 120.5, "1ç­": 118.2 ... }

        for (const [className, groupStudents] of Object.entries(classMap)) {
            if (groupStudents.length === 0) continue;

            let numerator = 0; // åˆ†å­ç´¯åŠ 

            allQuestions.forEach(qName => {
                // 1. è·å–é…ç½®çš„éš¾åº¦ (é»˜è®¤ä¸º0)
                const conf = itemConfig[qName] || {};
                const difficulty = (conf.manualDifficulty !== undefined) ? conf.manualDifficulty : 0;
                
                // 2. è®¡ç®—è¯¥é¢˜åœ¨è¯¥ç¾¤ä½“ä¸­çš„æ€»åˆ†
                let qTotalScore = 0;
                groupStudents.forEach(s => {
                    // å°è¯•ä»å°é¢˜æˆ–å¤§é¢˜åˆ†æ•°ä¸­è·å–
                    let val = s.minorScores[qName];
                    if (val === undefined) val = s.majorScores[qName];
                    
                    if (typeof val === 'number' && !isNaN(val)) {
                        qTotalScore += val;
                    }
                });

                // 3. ç´¯åŠ å…¬å¼é¡¹: (1 - éš¾åº¦) * ç¾¤ä½“è¯¥é¢˜æ€»åˆ†
                numerator += (1 - difficulty) * qTotalScore;
            });

            // 4. æœ€ç»ˆè®¡ç®—: åˆ†å­ / å‚è€ƒäººæ•°
            results[className] = parseFloat((numerator / groupStudents.length).toFixed(2));
        }

        return results;
    };

    const resultA = calculateWeightedMetric(recA, subject);
    const resultB = calculateWeightedMetric(recB, subject);

    renderDiffCompareCharts(resultA, resultB, recA.name, recB.name);
}

// 3. æ¸²æŸ“å›¾è¡¨
function renderDiffCompareCharts(resA, resB, nameA, nameB) {
    // æå–æ‰€æœ‰ç­çº§ (å¹¶é›†)
    const classes = Array.from(new Set([...Object.keys(resA), ...Object.keys(resB)])).sort();
    // æŠŠ "å…¨å¹´æ®µ" æ”¾åœ¨æœ€å‰é¢
    const sortedClasses = ['å…¨å¹´æ®µ', ...classes.filter(c => c !== 'å…¨å¹´æ®µ')];

    const dataA = sortedClasses.map(c => resA[c] || 0);
    const dataB = sortedClasses.map(c => resB[c] || 0);
    const diffData = sortedClasses.map(c => {
        const va = resA[c] || 0;
        const vb = resB[c] || 0;
        return parseFloat((va - vb).toFixed(2));
    });

    // å›¾è¡¨1ï¼šå¯¹æ¯”æŸ±çŠ¶å›¾
    const chartBar = echarts.init(document.getElementById('chart-diff-compare-bar'));
    chartBar.setOption({
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        legend: { data: [nameA, nameB], top: 0 },
        grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
        xAxis: { type: 'category', data: sortedClasses, axisLabel: { rotate: 30 } },
        yAxis: { type: 'value', name: 'åŠ æƒå¾—åˆ†æŒ‡æ ‡', scale:true },
        series: [
            { name: nameA, type: 'bar', data: dataA, itemStyle: { color: '#3498db' } },
            { name: nameB, type: 'bar', data: dataB, itemStyle: { color: '#e67e22' } }
        ]
    });

    // å›¾è¡¨2ï¼šå·®å¼‚ç€‘å¸ƒå›¾/æŸ±çŠ¶å›¾
    const chartDiff = echarts.init(document.getElementById('chart-diff-compare-diff'));
    chartDiff.setOption({
        tooltip: { trigger: 'axis', formatter: '{b}<br/>å·®å¼‚: {c}' },
        grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
        xAxis: { type: 'category', data: sortedClasses, axisLabel: { rotate: 30 } },
        yAxis: { type: 'value', name: 'å·®å¼‚å€¼ (A - B)' },
        series: [
            {
                name: 'å·®å¼‚',
                type: 'bar',
                data: diffData,
                itemStyle: {
                    color: (params) => params.value >= 0 ? '#2ecc71' : '#e74c3c'
                },
                label: { show: true, position: 'top' }
            }
        ]
    });
}

// 4. [æœ€ç»ˆå®Œæ•´ç‰ˆ] å‘é€è¿½é—®æ¶ˆæ¯ (æ”¯æŒ R1 æ€è€ƒã€å•ç‹¬æ‰“å°ã€å†å²è®°å½•æ›´  )
async function sendAIFollowUp() {
    const input = document.getElementById('ai-user-input');
    const chatHistoryDiv = document.getElementById('ai-chat-history');
    const apiKey = localStorage.getItem('G_DeepSeekKey');
    const model = document.getElementById('ai-model-select').value;

    // åº•éƒ¨UIå…ƒç´ 
    const floatingStopBtn = document.getElementById('ai-floating-stop-btn');
    const sendBtn = document.getElementById('ai-send-btn');

    const userText = input.value.trim();
    if (!userText) return;

    // 1. UI: ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡
    input.value = '';
    const userBubble = document.createElement('div');
    userBubble.style.cssText = "background: #e3f2fd; padding: 10px 15px; border-radius: 15px 15px 0 15px; margin: 10px 0 10px auto; max-width: 80%; color: #333; text-align: right; align-self: flex-end; width: fit-content;";
    userBubble.innerText = userText;
    chatHistoryDiv.appendChild(userBubble);

    // 2. UI: AI å›å¤å®¹å™¨
    const aiBubble = document.createElement('div');
    aiBubble.style.cssText = "background: #f8f9fa; padding: 15px; border-radius: 0 15px 15px 15px; margin: 10px 0; border: 1px solid #eee; min-height: 40px; position: relative;";

    // æ³¨å…¥ç»“æ„ï¼šæ‰“å°æŒ‰é’® + æŠ˜å æ¡† + æ­£æ–‡æ¡†
    aiBubble.innerHTML = `
        <button class="ai-bubble-print-btn" title="å•ç‹¬æ‰“å°æ­¤æ¡å¯¹è¯">ğŸ–¨ï¸</button>
        <details class="ai-reasoning-box" style="display:none;" open>
            <summary><span>ğŸ§  æ·±åº¦æ€è€ƒè¿‡ç¨‹ (è¿½é—®)</span></summary>
            <div class="ai-reasoning-content"></div>
        </details>
        <div class="ai-answer-content typing-cursor"></div>
    `;
    chatHistoryDiv.appendChild(aiBubble);

    // è·å–å†…éƒ¨å¼•ç”¨
    const printBtn = aiBubble.querySelector('.ai-bubble-print-btn');
    const reasoningBox = aiBubble.querySelector('details');
    const reasoningContentEl = aiBubble.querySelector('.ai-reasoning-content');
    const answerContentEl = aiBubble.querySelector('.ai-answer-content');

    // ç»‘å®šå•æ¡æ‰“å°äº‹ä»¶
    printBtn.onclick = () => {
        const currentReasoning = reasoningContentEl.innerText;
        const currentAnswer = answerContentEl.innerHTML;
        printSingleChatTurn(userText, currentAnswer, currentReasoning);
    };

    // [å…³é”®] UI çŠ¶æ€æ›´  ï¼šæ˜¾ç¤ºåœæ­¢æŒ‰é’®ï¼Œç¦ç”¨å‘é€
    if (floatingStopBtn) floatingStopBtn.style.display = 'flex';
    if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerText = 'ç”Ÿæˆä¸­...';
    }

    G_AIChatHistory.push({ "role": "user", "content": userText });

    // AbortController
    if (currentAIController) currentAIController.abort();
    currentAIController = new AbortController();

    // å®šä¹‰åœæ­¢é€»è¾‘
    const handleStop = () => {
        if (currentAIController) {
            currentAIController.abort();
            currentAIController = null;

            // UI æ¢å¤
            if (floatingStopBtn) floatingStopBtn.style.display = 'none';
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.innerText = 'å‘é€';
            }

            answerContentEl.classList.remove('typing-cursor');
            answerContentEl.innerHTML += `<br><em style="color: #dc3545;">(å·²åœæ­¢)</em>`;

            // æ‰‹åŠ¨åœæ­¢æ—¶ï¼Œæ›´  å†å²è®°å½•
            if (G_CurrentHistoryId) {
                saveToAIHistory(null, null, G_CurrentHistoryId);
            }
        }
    };

    // ç»‘å®šåœæ­¢æŒ‰é’®
    if (floatingStopBtn) floatingStopBtn.onclick = handleStop;

    let fullReasoning = "";
    let fullContent = "";

    try {
        const response = await fetch('https://api.deepseek.com/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model: model, messages: G_AIChatHistory, temperature: 0.6, stream: true }),
            signal: currentAIController.signal
        });

        if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');

            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.startsWith('data: ')) {
                    try {
                        const json = JSON.parse(trimmed.slice(6));
                        const delta = json.choices[0].delta;

                        // A. æ€è€ƒè¿‡ç¨‹
                        if (delta.reasoning_content) {
                            if (fullReasoning === "") reasoningBox.style.display = "block";
                            fullReasoning += delta.reasoning_content;
                            reasoningContentEl.textContent = fullReasoning;
                        }

                        // B. æ­£æ–‡å†…å®¹
                        if (delta.content) {
                            fullContent += delta.content;
                            requestAnimationFrame(() => {
                                renderMarkdownWithMath(answerContentEl, fullContent);
                            });
                        }
                    } catch (e) { }
                }
            }
        }

        // ç”Ÿæˆç»“æŸï¼Œä¿å­˜ä¸Šä¸‹æ–‡
        G_AIChatHistory.push({ "role": "assistant", "content": fullContent });

        // [å…³é”®] æ›´  å†å²è®°å½• (è¿½é—®å†…å®¹å­˜å…¥ chatContent)
        if (G_CurrentHistoryId) {
            saveToAIHistory(null, null, G_CurrentHistoryId);
        }

    } catch (err) {
        if (err.name !== 'AbortError') {
            answerContentEl.innerHTML += `<div style="color: red; margin-top:10px;">âŒ å‡ºé”™: ${err.message}</div>`;
        }
    } finally {
        answerContentEl.classList.remove('typing-cursor');
        if (floatingStopBtn) floatingStopBtn.style.display = 'none';
        if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.innerText = 'å‘é€';
        }
        currentAIController = null;
    }
}

function renderMarkdownWithMath(element, markdown) {
    //    æœ€ç»ˆä¿®å¤    ç§»é™¤æ‰€æœ‰çš„ replace é¢„å¤„ç†
    // å› ä¸º Prompt å·²ç»è®© AI ç”Ÿæˆäº†æ ‡å‡†çš„ LaTeX æ ¼å¼ ($...$)
    // æˆ‘ä»¬ç›´æ¥æ¸²æŸ“ï¼Œä¸å†ç”»è›‡æ·»è¶³ï¼Œè¿™æ ·å°±ä¸ä¼šå¯¼è‡´æ¢è¡Œæˆ–ä¹±ç äº†

    // 1. ä¿æŠ¤å…¬å¼ (é˜²æ­¢ marked.js æŠŠå…¬å¼é‡Œçš„ç¬¦å·è¯¯è®¤ä¸ºæ˜¯ markdown è¯­æ³•)
    const mathSegments = [];
    const protectedMarkdown = markdown.replace(
        /(\$\$[\s\S]*?\$\$|\\\[[\s\S]*?\\\]|\\\([\s\S]*?\\\)|\\ce\{[^\}]+\}|\$[^\$]+\$)/g,
        (match) => {
            const placeholder = `MATHBLOCK${mathSegments.length}END`;
            mathSegments.push(match);
            return placeholder;
        }
    );

    // 2. æ¸²æŸ“ Markdown
    let html = marked.parse(protectedMarkdown);

    // 3. è¿˜åŸå…¬å¼
    mathSegments.forEach((segment, index) => {
        html = html.replace(`MATHBLOCK${index}END`, () => segment);
    });

    // 4. æ³¨å…¥ HTML
    element.innerHTML = html;

    // 5. æ¸²æŸ“ Math (KaTeX)
    if (window.renderMathInElement) {
        renderMathInElement(element, {
            delimiters: [
                { left: "$$", right: "$$", display: true }, // å—çº§å…¬å¼ (å±…ä¸­)
                { left: "\\[", right: "\\]", display: true },
                { left: "$", right: "$", display: false },  // è¡Œå†…å…¬å¼ (ä¸æ¢è¡Œ)
                { left: "\\(", right: "\\)", display: false }
            ],
            throwOnError: false
            // [é‡è¦] ç¡®ä¿è¿™é‡Œæ²¡æœ‰ macros é…ç½®
        });
    }
}

/**
 * 14.1    æ‰“å° AI åˆ†ææŠ¥å‘Š (åŒ…å«è¿½é—®è®°å½•)
 */
function printAIReport() {
    const contentDiv = document.getElementById('ai-content');
    const historyDiv = document.getElementById('ai-chat-history'); //    è·å–è¿½é—®å®¹å™¨

    // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹
    const hasInitialContent = contentDiv && contentDiv.innerHTML.trim() !== '';
    const hasHistoryContent = historyDiv && historyDiv.innerHTML.trim() !== '';

    if (!hasInitialContent && !hasHistoryContent) {
        alert("æ²¡æœ‰å¯æ‰“å°çš„å†…å®¹ï¼è¯·å…ˆç”Ÿæˆåˆ†ææŠ¥å‘Šã€‚");
        return;
    }

    // 1. è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯ (ç”¨äºé¡µçœ‰)
    const modeEl = document.getElementById('ai-mode-select');
    const modeText = modeEl ? modeEl.selectedOptions[0].text : "åˆ†ææŠ¥å‘Š";
    const grade = document.getElementById('ai-grade-select').value;
    // [ä¿®æ”¹å] -------------- å¼€å§‹ --------------
    let subject = document.getElementById('ai-item-subject').value;
    
    // å¦‚æœæ˜¯ç»¼åˆç±»æ¨¡å¼ï¼Œå¼ºåˆ¶æ˜¾ç¤ºä¸ºâ€œç»¼åˆâ€
    if (modeEl.value === 'trend' || modeEl.value === 'weakness' || modeEl.value === 'question') {
        subject = "ç»¼åˆ";
    } else {
        subject = subject || "ç»¼åˆ";
    }
    let title = "";
    let subTitle = "";

    if (modeEl.value === 'teaching_guide') {
        const className = document.getElementById('ai-item-class').value;
        const classText = className === 'ALL' ? 'å…¨å¹´æ®µ' : className;
        title = `æ•™å­¦è¯Šæ–­æŠ¥å‘Š - ${subject}`;
        subTitle = `åˆ†æå¯¹è±¡ï¼š${classText} | å¹´çº§ï¼š${grade}`;
    } else {
        const searchInput = document.getElementById('ai-student-search');
        const studentName = searchInput.dataset.selectedName || "å­¦ç”Ÿ";
        title = `å­¦ä¸šåˆ†ææŠ¥å‘Š - ${studentName}`;
        subTitle = `å¹´çº§ï¼š${grade} | ç§‘ç›®ï¼š${subject} | æ¨¡å¼ï¼š${modeText}`;
    }

    // 2.    æ ¸å¿ƒä¿®æ”¹    æ‹¼æ¥å†…å®¹ï¼šé¦–æ¬¡å›ç­” + è¿½é—®è®°å½•
    let reportHtml = "";

    if (hasInitialContent) {
        reportHtml += contentDiv.innerHTML;
    }

    if (hasHistoryContent) {
        // æ·»åŠ ä¸€ä¸ªåˆ†å‰²çº¿å’Œæ ‡é¢˜ï¼ŒåŒºåˆ†è¿½é—®éƒ¨åˆ†
        reportHtml += `
            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px dashed #ccc;">
                <h3 style="color: #333; border-left: 4px solid #666; padding-left: 10px;">ğŸ’¬ æ·±åº¦è¿½é—®è®°å½•</h3>
                ${historyDiv.innerHTML}
            </div>
        `;
    }

    // 3. æ„å»ºæ‰“å°é¡µé¢
    const printHtml = `
        <html>
        <head>
            <title>${title}</title>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
            <style>
                body {
                    font-family: -apple-system, "Segoe UI", "PingFang SC", sans-serif;
                    line-height: 1.6;
                    padding: 2cm;
                    color: #333;
                }
                /* é¡µçœ‰æ ·å¼ */
                .print-header {
                    text-align: center;
                    border-bottom: 2px solid #333;
                    margin-bottom: 30px;
                    padding-bottom: 10px;
                }
                .print-header h1 { margin: 0 0 10px 0; font-size: 24px; }
                .print-header p { margin: 0; color: #666; font-size: 14px; }

                /* å†…å®¹æ ·å¼å¤åˆ» */
                h1, h2, h3 { color: #000; margin-top: 1.5em; }
                h3 { font-size: 1.2em; border-left: 4px solid #007bff; padding-left: 10px; }
                ul, ol { padding-left: 25px; }
                li { margin-bottom: 5px; }
                p { text-align: justify; margin-bottom: 1em; }
                strong { font-weight: 900; background-color: #eee; padding: 0 4px; border-radius: 2px; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                th, td { border: 1px solid #999; padding: 8px; text-align: center; font-size: 0.9em; }
                th { background-color: #f0f0f0; font-weight: bold; }
                blockquote { border-left: 4px solid #ddd; margin: 1em 0; padding: 0.5em 1em; background-color: #f9f9f9; font-style: italic; }

                /*    è¿½é—®å¯¹è¯æ°”æ³¡æ ·å¼ (ç¡®ä¿æ‰“å°æ—¶ä¹Ÿèƒ½çœ‹åˆ°æ°”æ³¡) */
                div[style*="background: #e3f2fd"] { 
                    /* ç”¨æˆ·æ°”æ³¡ */
                    background-color: #e3f2fd !important; 
                    border: 1px solid #bbdefb;
                    color: #0d47a1;
                    margin: 15px 0 15px auto !important; /* å¼ºåˆ¶é å³ */
                    max-width: 80%;
                    padding: 10px 15px;
                    border-radius: 15px 15px 0 15px;
                    text-align: right;
                }
                div[style*="background: #f8f9fa"] { 
                    /* AI æ°”æ³¡ */
                    background-color: #f8f9fa !important;
                    border: 1px solid #dee2e6;
                    margin: 15px 0;
                    padding: 15px;
                    border-radius: 0 15px 15px 15px;
                }

                @media print {
                    @page { size: A4 portrait; margin: 0; }
                    /* å¼ºåˆ¶æ‰“å°èƒŒæ™¯è‰² (é’ˆå¯¹æ°”æ³¡) */
                    * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>${title}</h1>
                <p>${subTitle} | ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}</p>
            </div>
            
            <div class="report-content">
                ${reportHtml}
            </div>
        </body>
        </html>
    `;

    // 4. æ‰§è¡Œæ‰“å°
    const win = window.open('', '_blank');
    win.document.write(printHtml);
    win.document.close();

    setTimeout(() => {
        win.focus();
        win.print();
    }, 1000);
}
// =====================================================================
//    NEW    æ¨¡å—åå››ï¼šAI å†å²è®°å½•ç®¡ç†å™¨
// =====================================================================

const AI_HISTORY_KEY = 'G_AI_History_Archive';

/**
 * åˆå§‹åŒ–å†å²è®°å½• UI å’Œäº‹ä»¶
 * (éœ€è¦åœ¨ initAIModule ä¸­è°ƒç”¨)
 */
function initAIHistoryUI() {
    const drawer = document.getElementById('ai-history-drawer');
    const toggleBtn = document.getElementById('ai-history-toggle-btn');
    const closeBtn = document.getElementById('ai-history-close-btn');
    const clearBtn = document.getElementById('ai-history-clear-btn');

    // å¼€å…³æŠ½å±‰
    toggleBtn.addEventListener('click', () => {
        drawer.classList.add('open');
        renderAIHistoryList(); // æ¯æ¬¡æ‰“å¼€æ—¶åˆ·  åˆ—è¡¨
    });
    closeBtn.addEventListener('click', () => {
        drawer.classList.remove('open');
    });

    // æ¸…ç©ºæ‰€æœ‰
    clearBtn.addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å†å²å¯¹è¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            localStorage.removeItem(AI_HISTORY_KEY);
            renderAIHistoryList();
        }
    });

    // ç‚¹å‡»é®ç½©å±‚å…³é—­ (å¦‚æœæƒ³åšçš„æ›´ç»†è‡´ï¼Œå¯ä»¥åŠ ä¸ªç‚¹å‡» content å…³é—­ drawer çš„é€»è¾‘ï¼Œè¿™é‡Œæš‚ç•¥)
}

/**
 * [é‡æ„ç‰ˆ] ä¿å­˜/æ›´   AI å¯¹è¯å†å²
 * @param {string} title - æ ‡é¢˜
 * @param {string} subTitle - å‰¯æ ‡é¢˜
 * @param {number|null} existingId - å¦‚æœæ˜¯æ›´  ç°æœ‰è®°å½•ï¼Œä¼ å…¥ IDï¼›å¦åˆ™ä¼  null
 */
/**
 * [æ ¸å¿ƒä¿®å¤ç‰ˆ] ä¿å­˜/æ›´æ–° AI å¯¹è¯å†å²
 * - ä¿®å¤ï¼šæ›´æ–°è®°å½•æ—¶(å¦‚è¿½é—®)ï¼Œè‹¥æœªä¼ å…¥æ–°æ ‡é¢˜ï¼Œè‡ªåŠ¨ä¿ç•™æ—§æ ‡é¢˜ï¼Œé˜²æ­¢å˜æˆ "null"
 */
function saveToAIHistory(title, subTitle, existingId = null, customMainContent = null) {
    const contentDiv = document.getElementById('ai-content');
    const historyDiv = document.getElementById('ai-chat-history');

    // 1. è·å–å†…å®¹ (å…¼å®¹æ‰¹é‡æ¨¡å¼å’Œå•äººæ¨¡å¼)
    let mainHtml = "";
    let chatHtml = "";

    if (customMainContent !== null && customMainContent !== undefined) {
        mainHtml = customMainContent;
        chatHtml = ""; 
    } else {
        mainHtml = contentDiv ? contentDiv.innerHTML : "";
        chatHtml = historyDiv ? historyDiv.innerHTML : "";
    }

    // å†…å®¹å¤ªå°‘ä¸ä¿å­˜
    if (!mainHtml || mainHtml.trim().length < 5) {
        return null;
    }

    const AI_HISTORY_KEY = 'G_AI_History_Archive';
    let history = JSON.parse(localStorage.getItem(AI_HISTORY_KEY) || "[]");
    let recordId = existingId;

    // 2. [å…³é”®ä¿®å¤] æŸ¥æ‰¾æ—§è®°å½•ï¼Œå‡†å¤‡ç»§æ‰¿æ ‡é¢˜
    let oldRecord = null;
    let index = -1;
    
    if (existingId) {
        index = history.findIndex(r => r.id === existingId);
        if (index !== -1) {
            oldRecord = history[index];
        }
    }

    // 3. æ„å»ºè®°å½•å¯¹è±¡
    const record = {
        id: existingId || Date.now() + Math.random(),
        timestamp: new Date().toLocaleString(),
        
        // [ä¿®å¤æ ¸å¿ƒ]ï¼šä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„æ ‡é¢˜ï¼›å¦‚æœä¼ å…¥ä¸º null ä¸”å­˜åœ¨æ—§è®°å½•ï¼Œåˆ™ç»§æ‰¿æ—§æ ‡é¢˜ï¼›å¦åˆ™æ˜¾ç¤ºé»˜è®¤å€¼
        title: title || (oldRecord ? oldRecord.title : "AIåˆ†ææŠ¥å‘Š"),
        subTitle: subTitle || (oldRecord ? oldRecord.subTitle : "ç»¼åˆåˆ†æ"),
        
        mainContent: mainHtml,
        chatContent: chatHtml
    };

    // 4. å†™å…¥æ•°ç»„
    if (index !== -1) {
        history[index] = record; // æ›´æ–°ç°æœ‰
        recordId = record.id;
    } else {
        history.unshift(record); // æ’å…¥å¤´éƒ¨
        recordId = record.id;
    }

    // é™åˆ¶æ•°é‡
    if (history.length > 200) history = history.slice(0, 200);
    
    localStorage.setItem(AI_HISTORY_KEY, JSON.stringify(history));

    // 5. åˆ·æ–° UI
    if (document.getElementById('ai-history-list')) {
        renderAIHistoryList();
    }

    return recordId;
}

/**
 * æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
 */
function renderAIHistoryList() {
    const listContainer = document.getElementById('ai-history-list');
    const history = JSON.parse(localStorage.getItem(AI_HISTORY_KEY) || "[]");

    if (history.length === 0) {
        listContainer.innerHTML = `<p style="color: #999; text-align: center; margin-top: 40px;">æš‚æ— å†å²è®°å½•</p>`;
        return;
    }

    listContainer.innerHTML = history.map(item => `
        <div class="history-item" onclick="loadAIHistoryItem(${item.id})">
            <button class="history-delete-btn" onclick="deleteAIHistoryItem(event, ${item.id})">&times;</button>
            <h4>${item.title}</h4>
            <p>${item.subTitle}</p>
            <span class="history-date">${item.timestamp}</span>
        </div>
    `).join('');
}

/**
 * [é‡æ„ç‰ˆ] åŠ è½½å•æ¡å†å²è®°å½•
 */
function loadAIHistoryItem(id) {
    const history = JSON.parse(localStorage.getItem(AI_HISTORY_KEY) || "[]");
    const item = history.find(r => r.id === id);

    if (item) {
        // 1. æ¢å¤ä¸»å›ç­”
        const contentDiv = document.getElementById('ai-content');
        contentDiv.innerHTML = item.mainContent || item.content; // å…¼å®¹æ—§æ•°æ®(item.content)

        // 2.    NEW    æ¢å¤è¿½é—®è®°å½•
        const historyDiv = document.getElementById('ai-chat-history');
        if (historyDiv) {
            historyDiv.innerHTML = item.chatContent || ""; // å¦‚æœæ˜¯æ—§æ•°æ®å¯èƒ½æ²¡æœ‰ chatContent
        }

        // 3. è®¾ç½®å½“å‰ä¼šè¯ ID (è¿™æ ·åŠ è½½æ—§è®°å½•åï¼Œç»§ç»­è¿½é—®ä¼šä¿å­˜åœ¨è¿™æ¡è®°å½•é‡Œï¼Œè€Œä¸æ˜¯  å»º)
        G_CurrentHistoryId = item.id;

        // 4. æ˜¾ç¤ºå®¹å™¨
        document.getElementById('ai-result-container').style.display = 'block';

        // 5. é‡  æ¸²æŸ“å…¬å¼
        const renderTarget = document.getElementById('ai-result-container');
        if (window.renderMathInElement) {
            renderMathInElement(renderTarget, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "\\[", right: "\\]", display: true },
                    { left: "$", right: "$", display: false },
                    { left: "\\(", right: "\\)", display: false }
                ],
                throwOnError: false
            });
        }

        // 6. ç»‘å®šæ‰“å°æŒ‰é’®äº‹ä»¶ (å› ä¸º innerHTML è¦†ç›–åï¼ŒåŸæ¥çš„ onclick äº‹ä»¶ç»‘å®šä¼šä¸¢å¤±)
        reattachPrintHandlers();

        // 7. ç§»åŠ¨ç«¯è‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
        if (window.innerWidth < 1000) {
            document.getElementById('ai-history-drawer').classList.remove('open');
        }
    }
}

// [    è¾…åŠ©å‡½æ•°] é‡  ç»‘å®šæ°”æ³¡ä¸Šçš„æ‰“å°æŒ‰é’®äº‹ä»¶
function reattachPrintHandlers() {
    const printBtns = document.querySelectorAll('.ai-bubble-print-btn');
    printBtns.forEach(btn => {
        btn.onclick = function () {
            // æ‰¾åˆ°çˆ¶çº§æ°”æ³¡
            const bubble = this.parentElement;
            // æå–ä¿¡æ¯ (è¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„ DOM ç»“æ„åå‘è·å–ï¼Œæˆ–è€…ç®€å•ç‚¹ï¼Œä¸é‡  ç»‘å®šå¤æ‚é€»è¾‘)
            // ç®€å•çš„åšæ³•ï¼šé‡  è§£æ DOM å†…å®¹
            const userBubble = bubble.previousElementSibling; // å‡è®¾ä¸Šé¢ä¸€ä¸ªæ˜¯ç”¨æˆ·æé—®
            const userText = userBubble ? userBubble.innerText : "å†å²è®°å½•";

            const reasoningEl = bubble.querySelector('.ai-reasoning-content');
            const answerEl = bubble.querySelector('.ai-answer-content');

            const rText = reasoningEl ? reasoningEl.innerText : "";
            const aHtml = answerEl ? answerEl.innerHTML : "";

            printSingleChatTurn(userText, aHtml, rText);
        };
    });
}

/**
 * åˆ é™¤å•æ¡è®°å½•
 */
function deleteAIHistoryItem(event, id) {
    event.stopPropagation(); // é˜²æ­¢è§¦å‘ onclick åŠ è½½
    if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;

    let history = JSON.parse(localStorage.getItem(AI_HISTORY_KEY) || "[]");
    history = history.filter(r => r.id !== id);
    localStorage.setItem(AI_HISTORY_KEY, JSON.stringify(history));

    renderAIHistoryList();
}


/**
 *    æ‰“å°å•è½®å¯¹è¯ (è¿½é—®è®°å½•)
 */
function printSingleChatTurn(userQuestion, aiAnswerHtml, aiReasoningText) {
    // 1. è·å–åŸºæœ¬ä¿¡æ¯ (ç”¨äºé¡µçœ‰)
    const studentSearch = document.getElementById('ai-student-search');
    const studentName = studentSearch.dataset.selectedName || "å­¦ç”Ÿ";
    const subject = document.getElementById('ai-item-subject').value || "ç»¼åˆ";

    // 2. æ„å»ºæ€è€ƒè¿‡ç¨‹çš„ HTML (å¦‚æœåœ¨æ‰“å°æ—¶æƒ³å±•ç¤º)
    let reasoningHtml = "";
    if (aiReasoningText && aiReasoningText.trim() !== "") {
        reasoningHtml = `
            <div class="print-reasoning">
                <h4>ğŸ§  æ·±åº¦æ€è€ƒè¿‡ç¨‹</h4>
                <div class="reasoning-text">${aiReasoningText.replace(/\n/g, '<br>')}</div>
            </div>
        `;
    }

    // 3. æ„å»ºæ‰“å°é¡µé¢
    const printHtml = `
        <html>
        <head>
            <title>æ·±åº¦è¿½é—®è®°å½• - ${studentName}</title>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
            <style>
                body { font-family: -apple-system, "Segoe UI", sans-serif; padding: 2cm; line-height: 1.6; color: #333; }
                
                /* é¡µçœ‰ */
                .header { border-bottom: 2px solid #333; margin-bottom: 30px; padding-bottom: 10px; text-align: center; }
                .header h2 { margin: 0; font-size: 20px; }
                .header p { margin: 5px 0 0; color: #666; font-size: 14px; }

                /* å¯¹è¯æ ·å¼ */
                .user-box { 
                    background-color: #e3f2fd; 
                    border: 1px solid #bbdefb; 
                    padding: 15px; 
                    border-radius: 8px; 
                    margin-bottom: 20px; 
                    color: #0d47a1; 
                    font-weight: bold;
                }
                .user-label { font-size: 0.8em; color: #1976d2; margin-bottom: 5px; display: block; }

                .ai-box { margin-top: 20px; }
                
                /* æ€è€ƒè¿‡ç¨‹æ ·å¼ (æ‰“å°ç‰ˆ) */
                .print-reasoning { 
                    margin: 20px 0; 
                    padding: 15px; 
                    background-color: #f9fafb; 
                    border-left: 4px solid #999; 
                    font-size: 0.9em; 
                    color: #555;
                }
                .print-reasoning h4 { margin: 0 0 10px 0; color: #333; }
                .reasoning-text { white-space: pre-wrap; font-family: monospace; }

                /* æ­£æ–‡æ ·å¼å¤åˆ» */
                h3 { border-left: 4px solid #007bff; padding-left: 10px; }
                strong { background-color: #eee; padding: 0 4px; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
                th { background-color: #f0f0f0; }

                @media print {
                    * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>æ·±åº¦è¿½é—®è®°å½•</h2>
                <p>å¯¹è±¡ï¼š${studentName} | ç§‘ç›®ï¼š${subject} | æ—¶é—´ï¼š${new Date().toLocaleString()}</p>
            </div>

            <div class="user-box">
                <span class="user-label">ğŸ™‹ è¿½é—®é—®é¢˜ï¼š</span>
                ${userQuestion}
            </div>

            <div class="ai-box">
                ${reasoningHtml}
                <div class="ai-content">
                    ${aiAnswerHtml}
                </div>
            </div>
        </body>
        </html>
    `;

    const win = window.open('', '_blank');
    win.document.write(printHtml);
    win.document.close();
    setTimeout(() => { win.focus(); win.print(); }, 1000);
}


/**
 * 14.2    èŒƒå›´æ‰“å°åŠŸèƒ½ (æŒ‰å¯¹è¯è½®æ¬¡åˆ‡ç‰‡)
 * @param {string} rangeStr - ç”¨æˆ·è¾“å…¥çš„èŒƒå›´å­—ç¬¦ä¸²ï¼Œå¦‚ "1-3" æˆ– "2"
 */
function printRangeReport(rangeStr) {
    const contentDiv = document.getElementById('ai-content');
    const historyDiv = document.getElementById('ai-chat-history');

    // --- 1. æŠŠé¡µé¢å†…å®¹æ•´ç†æˆâ€œè½®æ¬¡â€æ•°ç»„ ---
    let rounds = [];

    // [ç¬¬1è½®]ï¼šåˆå§‹æŠ¥å‘Š
    if (contentDiv && contentDiv.innerHTML.trim() !== "") {
        rounds.push({
            type: 'initial',
            html: contentDiv.innerHTML
        });
    }

    // [ç¬¬2+è½®]ï¼šè¿½é—®è®°å½•
    // è¿½é—®è®°å½•åœ¨ historyDiv é‡Œæ˜¯æ‰å¹³æ’åˆ—çš„ (User, AI, User, AI...)
    // æˆ‘ä»¬éœ€è¦æŒ‰é¡ºåºæŠŠå®ƒä»¬ä¸¤ä¸¤é…å¯¹
    if (historyDiv) {
        const nodes = Array.from(historyDiv.children);
        let currentRound = { type: 'followup', user: '', ai: '' };
        let hasUser = false;

        nodes.forEach(node => {
            // è¯†åˆ«ç”¨æˆ·æ°”æ³¡ (æµ…è“èƒŒæ™¯)
            if (node.style.backgroundColor === 'rgb(227, 242, 253)' || node.style.background.includes('e3f2fd')) {
                if (hasUser) {
                    // å¦‚æœå·²ç»æœ‰ä¸€ä¸ªç”¨æˆ·é—®é¢˜ä½†æ²¡AIå›ç­”(å¼‚å¸¸æƒ…å†µ)ï¼Œå…ˆå°åŒ…
                    rounds.push({ type: 'followup', html: buildFollowUpHtml(currentRound.user, currentRound.ai) });
                    currentRound = { type: 'followup', user: '', ai: '' };
                }
                currentRound.user = node.innerHTML; // æ‹¿å–å†…å®¹
                hasUser = true;
            }
            // è¯†åˆ« AI æ°”æ³¡ (ç°ç™½èƒŒæ™¯)
            else if (node.style.backgroundColor === 'rgb(248, 249, 250)' || node.style.background.includes('f8f9fa')) {
                currentRound.ai = node.innerHTML; // æ‹¿å–å†…å®¹
                // é…å¯¹å®Œæˆï¼Œæ¨å…¥æ•°ç»„
                rounds.push({ type: 'followup', html: buildFollowUpHtml(currentRound.user, currentRound.ai) });
                hasUser = false;
                currentRound = { type: 'followup', user: '', ai: '' }; // é‡ç½®
            }
        });
    }

    // --- 2. è§£æç”¨æˆ·è¾“å…¥çš„èŒƒå›´ ---
    // æ”¯æŒ "1", "1-3", "1,3,5" æ ¼å¼
    const selectedIndices = new Set();
    const parts = rangeStr.split(/[,ï¼Œ]/); // æ”¯æŒä¸­è‹±æ–‡é€—å·

    parts.forEach(part => {
        if (part.includes('-')) {
            const [start, end] = part.split('-').map(Number);
            if (!isNaN(start) && !isNaN(end)) {
                for (let i = start; i <= end; i++) selectedIndices.add(i);
            }
        } else {
            const num = Number(part);
            if (!isNaN(num)) selectedIndices.add(num);
        }
    });

    // --- 3. æ‹¼æ¥éœ€è¦æ‰“å°çš„ HTML ---
    let finalHtml = "";
    let count = 0;

    // éå†æ‰€æœ‰è½®æ¬¡ (æ³¨æ„ï¼šrounds æ•°ç»„ä¸‹æ ‡ä» 0 å¼€å§‹ï¼Œç”¨æˆ·è¾“å…¥ä» 1 å¼€å§‹)
    rounds.forEach((round, index) => {
        const roundNum = index + 1;
        if (selectedIndices.has(roundNum)) {
            if (round.type === 'initial') {
                finalHtml += `
                    <div class="print-section">
                        <h3 class="section-title">ğŸ“„ ç¬¬ 1 è½®ï¼šåˆå§‹åˆ†ææŠ¥å‘Š</h3>
                        ${round.html}
                    </div>
                `;
            } else {
                finalHtml += `
                    <div class="print-section" style="page-break-before: auto;">
                        <h3 class="section-title">ğŸ’¬ ç¬¬ ${roundNum} è½®ï¼šæ·±åº¦è¿½é—®</h3>
                        ${round.html}
                    </div>
                `;
            }
            count++;
        }
    });

    if (count === 0) {
        alert("è¾“å…¥çš„èŒƒå›´æ— æ•ˆæˆ–æ²¡æœ‰å¯¹åº”çš„å†…å®¹ï¼\nå½“å‰å…±æœ‰ " + rounds.length + " è½®å¯¹è¯ã€‚");
        return;
    }

    // --- 4. è°ƒç”¨æ‰“å°çª—å£ (å¤ç”¨ä¹‹å‰çš„æ ·å¼) ---
    // è·å–è¡¨å¤´ä¿¡æ¯
    const studentSearch = document.getElementById('ai-student-search');
    const studentName = studentSearch.dataset.selectedName || "å­¦ç”Ÿ";

    const printPage = `
        <html>
        <head>
            <title>é€‰æ®µæ‰“å° - ${studentName}</title>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
            <style>
                body { font-family: "Segoe UI", sans-serif; padding: 2cm; color: #333; line-height: 1.6; }
                .print-header { text-align: center; border-bottom: 2px solid #333; margin-bottom: 20px; padding-bottom: 10px; }
                
                /* åŒºåŸŸæ ·å¼ */
                .print-section { margin-bottom: 40px; }
                .section-title { background: #eee; padding: 8px 15px; border-left: 5px solid #007bff; margin-bottom: 20px; font-size: 1.1em; }

                /* æ°”æ³¡æ ·å¼å¤åˆ» (å¼ºåˆ¶æ‰“å°èƒŒæ™¯è‰²) */
                .user-bubble-print { 
                    background-color: #e3f2fd !important; 
                    border: 1px solid #bbdefb; color: #0d47a1; 
                    padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: bold;
                }
                .ai-bubble-print { 
                    background-color: #f8f9fa !important; 
                    border: 1px solid #dee2e6; padding: 10px; border-radius: 8px; 
                }
                
                /* éšè—ä¸éœ€è¦çš„æŒ‰é’® */
                .ai-bubble-print-btn, details summary { display: none !important; } 
                /* æ‰“å°æ—¶é»˜è®¤å±•å¼€æ‰€æœ‰æŠ˜å æ¡†å†…å®¹ */
                details .ai-reasoning-content { display: block !important; border-left: 3px solid #ccc; padding-left: 10px; margin: 10px 0; color: #666; font-size: 0.9em; }

                @media print { * { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h2>AI åˆ†ææŠ¥å‘Š (é€‰æ®µ)</h2>
                <p>å¯¹è±¡ï¼š${studentName} | æ‰“å°èŒƒå›´ï¼šç¬¬ ${rangeStr} è½®</p>
            </div>
            ${finalHtml}
        </body>
        </html>
    `;

    const win = window.open('', '_blank');
    win.document.write(printPage);
    win.document.close();
    setTimeout(() => { win.focus(); win.print(); }, 1000);
}

// (å†…éƒ¨è¾…åŠ©å‡½æ•°) æ„å»ºè¿½é—®çš„æ‰“å° HTML
function buildFollowUpHtml(userHtml, aiHtml) {
    return `
        <div class="user-bubble-print">ğŸ™‹ æé—®ï¼š<br>${userHtml}</div>
        <div class="ai-bubble-print">ğŸ¤– å›å¤ï¼š<br>${aiHtml}</div>
    `;
}


// =====================================================================
//    NEW    æ¨¡å—åäºŒï¼šå¤šåˆ—è¡¨ç®¡ç†é€»è¾‘
// =====================================================================

// å…¨å±€å˜é‡ï¼šå½“å‰é€‰ä¸­çš„åˆ—è¡¨ID
let G_CurrentCollectionId = 'default';
const COLLECTIONS_KEY = 'G_MultiExam_Collections_V2';

async function initMultiCollectionManager() {
    const select = document.getElementById('multi-collection-select');
    const btnNew = document.getElementById('btn-new-collection');
    const btnRename = document.getElementById('btn-rename-collection');
    const btnDelete = document.getElementById('btn-delete-collection');

    try {
        // 1. æ•°æ®è¿ç§»ä¸åŠ è½½
        await ensureCollectionsExist();

        // 2. æ¸²æŸ“ä¸‹æ‹‰æ¡†
        await renderCollectionSelect();
    } catch (err) {
        console.error("åˆå§‹åŒ–åˆ—è¡¨ç®¡ç†å™¨å¤±è´¥:", err);
    }

    // 3. ç»‘å®šäº‹ä»¶ (å…¨éƒ¨éƒ½è¦æ”¹ä¸º async)
    if (select) {
        select.onchange = async () => {
            G_CurrentCollectionId = select.value;
            localStorage.setItem('G_MultiExam_ActiveId', G_CurrentCollectionId);

            // åˆ·  åˆ—è¡¨æ˜¾ç¤º
            const data = await loadMultiExamData(); // [ä¿®æ”¹] await
            renderMultiExamList(data);
            initializeStudentSearch(data);

            // éšè—æŠ¥è¡¨
            const report = document.getElementById('multi-student-report');
            if (report) report.style.display = 'none';
        };
    }

    if (btnNew) {
        btnNew.onclick = async () => {
            const name = prompt("è¯·è¾“å…¥  åˆ—è¡¨åç§° (ä¾‹å¦‚ï¼šé«˜äºŒä¸‹å­¦æœŸ):");
            if (!name) return;

            const collections = await getCollections(); // [ä¿®æ”¹] await
            const newId = 'col_' + Date.now();
            collections[newId] = {
                name: name,
                exams: []
            };
            await saveCollections(collections); // [ä¿®æ”¹] await

            // åˆ‡æ¢åˆ°  åˆ—è¡¨
            G_CurrentCollectionId = newId;
            localStorage.setItem('G_MultiExam_ActiveId', newId);

            await renderCollectionSelect(); // [ä¿®æ”¹] await

            // åˆ·  ç•Œé¢
            renderMultiExamList([]);
            initializeStudentSearch([]);
            const report = document.getElementById('multi-student-report');
            if (report) report.style.display = 'none';
        };
    }

    if (btnRename) {
        btnRename.onclick = async () => {
            const collections = await getCollections(); // [ä¿®æ”¹] await
            const current = collections[G_CurrentCollectionId];
            if (!current) return;

            const newName = prompt("é‡å‘½ååˆ—è¡¨:", current.name);
            if (newName && newName !== current.name) {
                current.name = newName;
                await saveCollections(collections); // [ä¿®æ”¹] await
                await renderCollectionSelect(); // [ä¿®æ”¹] await
            }
        };
    }

    if (btnDelete) {
        btnDelete.onclick = async () => {
            const collections = await getCollections(); // [ä¿®æ”¹] await
            const keys = Object.keys(collections);
            if (keys.length <= 1) {
                alert("è¿™æ˜¯æœ€åä¸€ä¸ªåˆ—è¡¨ï¼Œæ— æ³•åˆ é™¤ï¼");
                return;
            }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ—è¡¨ã€${collections[G_CurrentCollectionId].name}ã€‘åŠå…¶åŒ…å«çš„æ‰€æœ‰è€ƒè¯•æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            delete collections[G_CurrentCollectionId];
            await saveCollections(collections); // [ä¿®æ”¹] await

            // åˆ‡æ¢å›ç¬¬ä¸€ä¸ªå¯ç”¨åˆ—è¡¨
            G_CurrentCollectionId = Object.keys(collections)[0];
            localStorage.setItem('G_MultiExam_ActiveId', G_CurrentCollectionId);

            await renderCollectionSelect(); // [ä¿®æ”¹] await

            // åˆ·  ç•Œé¢
            const data = await loadMultiExamData(); // [ä¿®æ”¹] await
            renderMultiExamList(data);
            initializeStudentSearch(data);
            const report = document.getElementById('multi-student-report');
            if (report) report.style.display = 'none';
        };
    }

    // ä¾§è¾¹æ  UI æ§åˆ¶é€»è¾‘ (ä¿æŒä¸å˜)
    const drawer = document.getElementById('multi-collection-drawer');
    const toggleBtn = document.getElementById('multi-collection-toggle-btn');
    const closeBtn = document.getElementById('multi-collection-close-btn');

    if (toggleBtn && drawer) {
        toggleBtn.onclick = () => { drawer.classList.add('open'); };
        closeBtn.onclick = () => { drawer.classList.remove('open'); };
        if (select) {
            select.addEventListener('change', () => {
                setTimeout(() => drawer.classList.remove('open'), 300);
            });
        }
    }
}

// --- è¾…åŠ©å‡½æ•° ---
async function getCollections() {
    // [ä¿®æ”¹]   åŠ  await
    const json = await localforage.getItem(COLLECTIONS_KEY);
    // localforage å­˜çš„æ˜¯å¯¹è±¡ï¼Œä¸éœ€è¦å† JSON.parseï¼Œé™¤éä½ æ‰‹åŠ¨ stringify è¿‡
    // ä¸ºäº†å…¼å®¹æ—§é€»è¾‘ï¼Œå¦‚æœä½ å­˜çš„æ—¶å€™ç”¨äº† JSON.stringifyï¼Œè¿™é‡Œå°±è¦ parse
    // å»ºè®®ç»Ÿä¸€ï¼šå­˜å¯¹è±¡ï¼Œå–å¯¹è±¡ã€‚LocalForage ä¼šè‡ªåŠ¨å¤„ç†ã€‚
    if (typeof json === 'string') {
        try { return JSON.parse(json); } catch (e) { return {}; }
    }
    return json || {};
}

async function saveCollections(data) {
    // [ä¿®æ”¹]   åŠ  awaitï¼Œç›´æ¥å­˜å¯¹è±¡
    await localforage.setItem(COLLECTIONS_KEY, data);
}

async function ensureCollectionsExist() {
    let collections = await getCollections(); // [ä¿®æ”¹] await

    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œ  ç‰ˆï¼Œæˆ–è€…æ²¡æœ‰æ•°æ®
    if (!collections || Object.keys(collections).length === 0) {
        console.log("æ£€æµ‹åˆ°  ç¯å¢ƒï¼Œæ­£åœ¨è¿ç§»æ—§æ•°æ®...");

        // å°è¯•è¿ç§»æ—§ç‰ˆæ•°æ® (G_MultiExamData)
        // localStorage æ˜¯åŒæ­¥çš„ï¼Œè¿™é‡Œä¸éœ€è¦ await
        const oldDataJson = localStorage.getItem('G_MultiExamData');
        const oldData = oldDataJson ? JSON.parse(oldDataJson) : [];

        // åˆ›å»ºé»˜è®¤åˆ—è¡¨
        collections = {
            'default': {
                name: 'é»˜è®¤è€ƒè¯•åˆ—è¡¨',
                exams: oldData
            }
        };
        await saveCollections(collections); // [ä¿®æ”¹] await
    }

    // æ¢å¤ä¸Šæ¬¡é€‰ä¸­çš„ID
    const savedId = localStorage.getItem('G_MultiExam_ActiveId');
    if (savedId && collections[savedId]) {
        G_CurrentCollectionId = savedId;
    } else {
        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
        G_CurrentCollectionId = Object.keys(collections)[0];
    }
}

async function renderCollectionSelect() {
    const select = document.getElementById('multi-collection-select');
    if (!select) return;

    // [ä¿®æ”¹] å¿…é¡»åŠ  awaitï¼Œå¦åˆ™ collections æ˜¯ Promiseï¼Œæ— æ³•éå†
    const collections = await getCollections();

    let html = '';
    for (const id in collections) {
        const selected = (id === G_CurrentCollectionId) ? 'selected' : '';
        // é˜²æ­¢ exams ä¸º undefined
        const count = collections[id].exams ? collections[id].exams.length : 0;
        html += `<option value="${id}" ${selected}>${collections[id].name} (${count}æ¬¡è€ƒè¯•)</option>`;
    }
    select.innerHTML = html;
}

// script.js

/**
 * [é€šç”¨] æ˜¾ç¤ºä¸‹é’»æ¨¡æ€æ¡†
 * @param {string} title - æ ‡é¢˜ (ä¾‹å¦‚ "ä¸åŠæ ¼å­¦ç”Ÿåå•")
 * @param {Array} students - å­¦ç”Ÿå¯¹è±¡æ•°ç»„
 * @param {string} subject - å½“å‰åˆ†æçš„ç§‘ç›® (ç”¨äºæ˜¾ç¤ºåˆ†æ•°)
 */
function showDrillDownModal(title, students, subject = 'totalScore') {
    const modal = document.getElementById('drill-down-modal');
    const titleEl = document.getElementById('drill-down-title');
    const subtitleEl = document.getElementById('drill-down-subtitle');
    const container = document.getElementById('drill-down-table-container');
    const closeBtn = document.getElementById('drill-down-close-btn');
    const exportBtn = document.getElementById('drill-down-export-btn');

    // 1. è®¾ç½®åŸºæœ¬ä¿¡æ¯
    titleEl.innerText = title;
    subtitleEl.innerText = `å…± ${students.length} äºº`;

    // 2. æ¸²æŸ“è¡¨æ ¼
    if (students.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:20px;">æ— æ•°æ®</p>';
    } else {
        const isTotal = (subject === 'totalScore');
        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>ç­çº§</th>
                        <th>è€ƒå·</th>
                        <th>${isTotal ? 'æ€»åˆ†' : subject}</th>
                        <th>ç­æ’</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(s => `
                        <tr>
                            <td>${s.name}</td>
                            <td>${s.class}</td>
                            <td>${s.id}</td>
                            <td><strong>${isTotal ? s.totalScore : (s.scores[subject] || 0)}</strong></td>
                            <td>${s.rank}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    // 3. ç»‘å®šå¯¼å‡ºæŒ‰é’®
    exportBtn.onclick = () => {
        if (students.length === 0) return;
        // å‡†å¤‡å¯¼å‡ºæ•°æ®
        const sheetData = students.map(s => ({
            "å§“å": s.name,
            "ç­çº§": s.class,
            "è€ƒå·": s.id,
            "åˆ†æ•°": (subject === 'totalScore') ? s.totalScore : (s.scores[subject] || 0),
            "ç­æ’": s.rank
        }));
        const ws = XLSX.utils.json_to_sheet(sheetData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "åå•");
        XLSX.writeFile(wb, `${title}.xlsx`);
    };

    // 4. æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.style.display = 'flex';

    // 5. ç»‘å®šå…³é—­
    closeBtn.onclick = () => { modal.style.display = 'none'; };
    // ç‚¹å‡»é®ç½©å…³é—­
    window.onclick = (event) => {
        if (event.target == modal) modal.style.display = 'none';
    };
}


/**
 * [    ] æ¸²æŸ“è´¡çŒ®åº¦åˆ†æå›¾ (æ­£è´Ÿæ¡å½¢å›¾)
 */
function renderContributionChart(elementId, subjects, data, totalDiff) {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    const myChart = echarts.init(chartDom);

    const option = {
        title: {
            text: `æ€»åˆ†ä¸å¹´çº§å‡åˆ†å·®è·: ${totalDiff > 0 ? '+' : ''}${totalDiff} åˆ†`,
            left: 'center',
            textStyle: { color: totalDiff >= 0 ? '#28a745' : '#dc3545' }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: '{b}: {c} åˆ†'
        },
        grid: { top: 50, bottom: 30 },
        xAxis: {
            type: 'category',
            data: subjects,
            axisLabel: { rotate: 0 },
            splitLine: { show: false }
        },
        yAxis: {
            type: 'value',
            name: 'è´¡çŒ®åˆ†å€¼',
            axisLabel: { formatter: '{value}' }
        },
        series: [{
            name: 'è´¡çŒ®å€¼',
            type: 'bar',
            data: data,
            label: { show: true, position: 'top' },
            itemStyle: {
                color: function (params) {
                    return params.value >= 0 ? '#28a745' : '#dc3545';
                }
            }
        }]
    };
    myChart.setOption(option);
    echartsInstances[elementId] = myChart;
}



//            é»˜è®¤æ¨¡æ¿åº“
const DEFAULT_PROMPTS = {
    "default": {
        name: "é»˜è®¤ä¸“å®¶é£æ ¼",
        system: "ä½ æ˜¯ä¸€åä¸“ä¸šçš„ä¸­å­¦æ•°æ®åˆ†æå¸ˆã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼è¾“å‡ºã€‚æ•°å­¦å…¬å¼ä½¿ç”¨ LaTeXã€‚",
        user: "è¯·åˆ†æå­¦ç”Ÿ {{name}} ({{grade}}) çš„{{subject}}æˆç»©ã€‚\n\næ•°æ®èƒŒæ™¯ï¼š\n{{data_context}}\n\nè¯·ç»™å‡ºï¼š\n1. æˆç»©è¯Šæ–­\n2. å½’å› åˆ†æ\n3. æåˆ†å»ºè®®"
    },
    "encouraging": {
        name: "é¼“åŠ±å¼æ²Ÿé€š (ç»™å®¶é•¿çœ‹)",
        system: "ä½ æ˜¯ä¸€ä½æ¸©æš–ã€å¯Œæœ‰åŒç†å¿ƒçš„èµ„æ·±ç­ä¸»ä»»ã€‚ä½ çš„åˆ†æå¯¹è±¡æ˜¯å­¦ç”Ÿå®¶é•¿ï¼Œè¯­æ°”è¦å§”å©‰ã€å¤šé¼“åŠ±ï¼Œå°‘æ‰¹è¯„ã€‚",
        user: "è¯·ä¸º {{name}} åŒå­¦çš„å®¶é•¿å†™ä¸€ä»½{{subject}}å­¦æƒ…åé¦ˆã€‚\n\næ•°æ®è¯¦æƒ…ï¼š\n{{data_context}}\n\nè¦æ±‚ï¼š\n1. å…ˆè‚¯å®šå­©å­çš„åŠªåŠ›å’Œäº®ç‚¹ï¼ˆå…·ä½“åˆ°é¢˜ç›®æˆ–çŸ¥è¯†ç‚¹ï¼‰ã€‚\n2. å§”å©‰æŒ‡å‡ºå­˜åœ¨çš„å°é—®é¢˜ã€‚\n3. ç»™å®¶é•¿æä¾›é…åˆå»ºè®®ã€‚"
    },
    "strict": {
        name: "ä¸¥å‰è¯Šæ–­ (ç»™å­¦ç”Ÿçœ‹)",
        system: "ä½ æ˜¯ä¸€ä½ä¸¥å‰ä½†è´Ÿè´£çš„å­¦ç§‘æ•™ç»ƒã€‚è¯´è¯é’ˆé’ˆè§è¡€ï¼Œä¸ç•™æƒ…é¢ï¼Œç›´æ¥æŒ‡å‡ºæ¼æ´ã€‚",
        user: "ç›´æ¥æŒ‡å‡º {{name}} åœ¨{{subject}}ä¸Šçš„ä¸¥é‡å¤±åˆ†ç‚¹ã€‚\n\næ•°æ®ï¼š\n{{data_context}}\n\nå‘Šè¯‰æˆ‘ï¼šä»–åˆ°åº•å“ªå­¦çš„ä¸è¡Œï¼Ÿæ¥ä¸‹æ¥è¯¥æ€ä¹ˆé­”é¬¼è®­ç»ƒï¼Ÿ"
    }
};

//    åœ¨ initAIModule ä¸­è°ƒç”¨æ­¤å‡½æ•°   
function initPromptManager() {
    const modal = document.getElementById('ai-prompt-modal');
    const openBtn = document.getElementById('ai-prompt-settings-btn');
    const closeBtn = document.getElementById('ai-prompt-close-btn');
    const select = document.getElementById('ai-prompt-select');
    const nameInput = document.getElementById('ai-prompt-name');
    const sysInput = document.getElementById('ai-prompt-system');
    const userInput = document.getElementById('ai-prompt-user');
    const saveBtn = document.getElementById('ai-prompt-save-btn');
    const newBtn = document.getElementById('ai-prompt-new-btn');
    const delBtn = document.getElementById('ai-prompt-delete-btn');

    // åŠ è½½æ¨¡æ¿
    let prompts = JSON.parse(localStorage.getItem('G_AI_Prompts')) || DEFAULT_PROMPTS;

    const renderSelect = () => {
        select.innerHTML = Object.keys(prompts).map(k => `<option value="${k}">${prompts[k].name}</option>`).join('');
        loadTemplate(select.value);
    };

    const loadTemplate = (key) => {
        const t = prompts[key];
        if (t) {
            nameInput.value = t.name;
            sysInput.value = t.system;
            userInput.value = t.user;
        }
    };

    openBtn.onclick = () => { modal.style.display = 'flex'; renderSelect(); };
    closeBtn.onclick = () => { modal.style.display = 'none'; };
    select.onchange = () => loadTemplate(select.value);

    newBtn.onclick = () => {
        const id = 'custom_' + Date.now();
        prompts[id] = { name: "  æ¨¡æ¿", system: "", user: "" };
        renderSelect();
        select.value = id;
        loadTemplate(id);
    };

    saveBtn.onclick = () => {
        const key = select.value;
        prompts[key] = {
            name: nameInput.value,
            system: sysInput.value,
            user: userInput.value
        };
        localStorage.setItem('G_AI_Prompts', JSON.stringify(prompts));
        // ä¿å­˜å½“å‰é€‰ä¸­çš„æ¨¡æ¿IDï¼Œä¾›ç”Ÿæˆæ—¶ä½¿ç”¨
        localStorage.setItem('G_AI_ActivePromptId', key);
        alert("æ¨¡æ¿å·²ä¿å­˜");
        
        // --- âœ…     å…³é—­æŒ‡ä»¤ ---
        modal.style.display = 'none'; 
    };

    // ============================================================
    //    ä¿®å¤    æ·»åŠ åˆ é™¤æŒ‰é’®çš„é€»è¾‘
    // ============================================================
    delBtn.onclick = () => {
        const key = select.value;

        // 1. ä¿æŠ¤ç³»ç»Ÿé»˜è®¤æ¨¡æ¿ï¼Œä¸å…è®¸åˆ é™¤
        if (DEFAULT_PROMPTS[key]) {
            alert("ç³»ç»Ÿé»˜è®¤æ¨¡æ¿æ— æ³•åˆ é™¤ï¼");
            return;
        }

        // 2. åˆ é™¤ç¡®è®¤
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰æ¨¡æ¿å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;

        // 3. æ‰§è¡Œåˆ é™¤
        delete prompts[key];

        // 4. ä¿å­˜æ›´  åçš„æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('G_AI_Prompts', JSON.stringify(prompts));

        // 5. æ£€æŸ¥é€»è¾‘ï¼šå¦‚æœåˆ é™¤äº†å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ¨¡æ¿ï¼Œé‡ç½®ä¸ºé»˜è®¤
        if (localStorage.getItem('G_AI_ActivePromptId') === key) {
            localStorage.setItem('G_AI_ActivePromptId', 'default');
        }

        // 6. åˆ·   UI
        alert("âœ… æ¨¡æ¿å·²åˆ é™¤");
        renderSelect(); // é‡  æ¸²æŸ“ä¸‹æ‹‰æ¡†

        // 7. è‡ªåŠ¨åˆ‡æ¢å›é»˜è®¤æ¨¡æ¿
        select.value = 'default';
        loadTemplate('default');
    };

    // åˆå§‹åŒ–
    renderSelect();
}
/**
 * [æ——èˆ°å®Œæ•´ç‰ˆ] æ¨¡å—åå››ï¼šç›®æ ‡ä¸è§„åˆ’
 * - æ”¯æŒè§„åˆ’åˆ—è¡¨ï¼ˆæ‰¹æ¬¡ï¼‰ç®¡ç†
 * - æ”¯æŒç‹¬ç«‹åŸºå‡†/å¤ç›˜æ•°æ®æºå¯¼å…¥
 * - æ”¯æŒè¯¦æƒ…å¼¹çª—å¯¹æ¯”ä¸æ»‘åŠ¨
 * - æ”¯æŒæ•°æ®æ¥æºæ ‡è¯†æ‰“å°
 */
async function renderGoalSetting(container, activeData, stats) {
    // ------------------------------------------------------
    // 0. åˆå§‹åŒ–ä¸æ•°æ®åŠ è½½
    // ------------------------------------------------------

    // é»˜è®¤åŸºå‡†æ•°æ®ä½¿ç”¨å…¨å±€å¯¼å…¥çš„æ•°æ®
    if (!G_GoalBaselineData) G_GoalBaselineData = activeData;

    // è®°å½•å¤ç›˜æ•°æ®æ¥æºåç§° (ç”¨äºæ˜¾ç¤ºå’Œæ‰“å°)
    let currentOutcomeSourceName = "æœªå¯¼å…¥";
    // å°è¯•æ£€æµ‹æ˜¯å¦å·²æœ‰æ•°æ®
    if (G_GoalOutcomeData && G_GoalOutcomeData.length > 0) {
        currentOutcomeSourceName = localStorage.getItem('G_GoalOutcome_FileName') || "å·²å¯¼å…¥æ•°æ®";
    }

    // åŠ è½½å­˜æ¡£å’Œæ‰¹æ¬¡ä¿¡æ¯
    let allArchives = await localforage.getItem('G_Goal_Archives') || {};
    let sessionMeta = await localforage.getItem('G_Goal_Session_Meta') || [];

    // åˆå§‹åŒ–é»˜è®¤æ‰¹æ¬¡
    if (sessionMeta.length === 0) {
        sessionMeta = [{ id: 'default_session', name: 'é»˜è®¤è§„åˆ’åˆ—è¡¨', createDate: new Date().toLocaleString() }];
        await localforage.setItem('G_Goal_Session_Meta', sessionMeta);
    }

    // è·å–å½“å‰é€‰ä¸­çš„æ‰¹æ¬¡ID
    let currentSessionId = localStorage.getItem('G_Goal_Current_Session_ID') || sessionMeta[0].id;
    if (!sessionMeta.find(s => s.id === currentSessionId)) currentSessionId = sessionMeta[0].id;

    // å±€éƒ¨å˜é‡
    let currentStudent = null;
    let G_EditingPlanState = null;
    let currentPlanMode = 'total';
    let currentSubject = G_DynamicSubjectList[0];
    let currentStrategy = null;
    let currentTargetData = { val: 0, type: 'score' };

    // ------------------------------------------------------
    // 1. æ¸²æŸ“ç•Œé¢æ¡†æ¶
    // ------------------------------------------------------
    container.innerHTML = `
        <h2>ğŸ¯ æ¨¡å—åå››ï¼šç›®æ ‡è§„åˆ’ä¸å¤ç›˜ç®¡ç†</h2>
        
        <div class="main-card-wrapper" style="background: #f8f9fa; border: 1px dashed #ccc; margin-bottom: 20px; padding: 15px;">
            <h4 style="margin: 0 0 15px 0; color: #555; display:flex; justify-content:space-between;">
                <span>ğŸ“‚ æ•°æ®æºé…ç½® (Data Sources)</span>
                <span style="font-size:0.8em; font-weight:normal; color:#999;">æ”¯æŒä»â€œæ•°æ®ä¸­å¿ƒâ€é€‰æ‹©å†å²æˆç»©</span>
            </h4>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 250px; background:white; padding:10px; border-radius:8px; border:1px solid #eee;">
                    <div style="font-weight:bold; margin-bottom:5px; color:#6f42c1;">1. åŸºå‡†æˆç»© (åˆ¶å®šè§„åˆ’ç”¨)</div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button id="btn-import-baseline" class="sidebar-button" style="background-color: #6f42c1; font-size: 0.9em; width: 100%;">ğŸ“¥ å¯¼å…¥/é€‰æ‹©æ•°æ®</button>
                        <input type="file" id="goal-upload-baseline" accept=".xlsx, .xls, .csv" style="display: none;">
                    </div>
                    <div id="goal-status-baseline" style="font-size: 0.85em; color: #666; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        å½“å‰: ç³»ç»Ÿé»˜è®¤æ•°æ® (${activeData.length}äºº)
                    </div>
                </div>
                <div style="flex: 1; min-width: 250px; background:white; padding:10px; border-radius:8px; border:1px solid #eee;">
                    <div style="font-weight:bold; margin-bottom:5px; color:#20c997;">2. è¾¾æˆæˆç»© (å¤ç›˜å¯¹æ¯”ç”¨)</div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button id="btn-import-outcome" class="sidebar-button" style="background-color: #20c997; font-size: 0.9em; width: 100%;">ğŸ“¥ å¯¼å…¥/é€‰æ‹©æ•°æ®</button>
                        <input type="file" id="goal-upload-outcome" accept=".xlsx, .xls, .csv" style="display: none;">
                    </div>
                    <div id="goal-status-outcome" style="font-size: 0.85em; color: #dc3545; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        å½“å‰: ${currentOutcomeSourceName}
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px; border-bottom: 2px solid #eee; display: flex; gap: 20px;">
            <button class="tab-btn active" data-tab="create" style="padding: 10px 20px; font-weight: bold; cursor: pointer; border:none; background:none; border-bottom: 3px solid var(--primary-color); color: var(--primary-color);">
                âœï¸   å»º/ä¿®æ”¹è§„åˆ’
            </button>
            <button class="tab-btn" data-tab="manage" style="padding: 10px 20px; font-weight: bold; cursor: pointer; border:none; background:none; color: #666; border-bottom: 3px solid transparent;">
                ğŸ“‹ è§„åˆ’ç®¡ç†å¤§å…
            </button>
        </div>

        <div id="goal-tab-create" class="tab-content">
            <div class="main-card-wrapper" style="margin-bottom: 20px; padding: 15px;">
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                    <label style="font-weight:bold;">é€‰æ‹©ç­çº§ (åŸºäºåŸºå‡†è¡¨):</label>
                    <select id="goal-class-select" class="sidebar-select" style="width:auto; min-width:150px; font-weight:bold; color:var(--primary-color);"></select>

                    <input type="text" id="goal-fast-search" placeholder="ğŸ” å¿«é€Ÿæ‰¾äºº (å§“å/è€ƒå·)" class="sidebar-select" style="width: 180px;">
                    <span style="color:#999; font-size:0.9em;">(âœ… = å½“å‰åˆ—è¡¨å†…å·²æœ‰è§„åˆ’)</span>
                </div>
                <div id="goal-student-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; max-height: 150px; overflow-y: auto; padding-right:5px;"></div>
            </div>

            <div id="goal-workspace" style="display: none;">
                <div class="controls-bar" style="background: #f0f7ff; border: 1px solid #cce5ff; padding: 10px 20px; justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap:20px;">
                        <label style="font-weight:bold; color:#004085;">è§„åˆ’æ¨¡å¼:</label>
                        <label style="cursor: pointer; display: flex; align-items: center;">
                            <input type="radio" name="plan-mode" value="total" checked style="margin-right: 5px;"> å…¨ç§‘/ç­ä¸»ä»»
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center;">
                            <input type="radio" name="plan-mode" value="single" style="margin-right: 5px;"> å•ç§‘/ç§‘ä»»
                        </label>
                    </div>
                    <div id="goal-single-subject-select-wrapper" style="display:none;">
                        <select id="goal-single-subject-select" class="sidebar-select" style="width:auto;">
                            ${G_DynamicSubjectList.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="main-card-wrapper" style="margin-bottom: 20px; border-left: 5px solid var(--color-purple);">
                    <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                        <span id="goal-target-label" style="font-weight:bold;">è®¾å®šç›®æ ‡:</span>
                        <select id="goal-target-type" class="sidebar-select" style="width:120px;">
                            <option value="score">åˆ†æ•° (Score)</option>
                            <option value="rank">å¹´çº§æ’å (Rank)</option>
                        </select>
                        <input type="number" id="goal-target-val" class="sidebar-select" style="width:100px;" placeholder="ç›®æ ‡å€¼">
                        <button id="goal-calc-btn" class="sidebar-button" style="background-color: var(--color-purple);">ğŸš€ ç”Ÿæˆè§„åˆ’</button>
                    </div>
                    <p id="goal-current-info" style="margin-top:10px; color:#666; font-size:0.9em;"></p>
                    <div style="font-size:0.85em; color:#999; text-align:right;">
                        å½“å‰å°†ä¿å­˜è‡³åˆ—è¡¨ï¼š<span id="goal-current-session-label" style="font-weight:bold; color:#333;">...</span>
                    </div>
                </div>

                <div id="goal-result-area" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">ğŸ“Š è§„åˆ’é¢„è§ˆ</h3>
                        <div style="display: flex; gap: 10px;">
                            <button id="goal-save-btn" class="sidebar-button" style="background-color: #28a745;">ğŸ’¾ ä¿å­˜å¹¶æ ‡è®°</button>
                            <button id="goal-print-btn" class="sidebar-button" style="background-color: var(--color-blue);">ğŸ–¨ï¸ æ‰“å°è§„åˆ’ä¹¦</button>
                        </div>
                    </div>
                    <div id="goal-result-kpi" class="kpi-grid"></div>
                    <div class="table-container" id="goal-result-table"></div>
                    <div id="goal-chart-wrapper" class="dashboard-chart-grid-2x2" style="margin-top:20px;">
                        <div class="main-card-wrapper"><div class="chart-container" id="goal-waterfall-chart"></div></div>
                        <div class="main-card-wrapper"><div class="chart-container" id="goal-radar-chart"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="goal-tab-manage" class="tab-content" style="display: none;">
            <div class="main-card-wrapper" style="margin-bottom: 20px; background: #fffbf0; border: 1px solid #ffeebb;">
                <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                    <label style="font-weight:bold; font-size:1.1em;">ğŸ“ å½“å‰è§„åˆ’åˆ—è¡¨ (å®¹å™¨):</label>
                    <select id="goal-session-select" class="sidebar-select" style="width:auto; min-width:200px; font-weight:bold;"></select>
                    <button id="btn-new-session" class="sidebar-button" style="background-color:#fd7e14;">â•   å»ºåˆ—è¡¨</button>
                    <button id="btn-rename-session" class="sidebar-button" style="background-color:#17a2b8;">âœï¸ é‡å‘½å</button>
                    <button id="btn-delete-session" class="sidebar-button" style="background-color:#dc3545;">ğŸ—‘ï¸ åˆ é™¤åˆ—è¡¨</button>
                </div>
            </div>

            <div class="main-card-wrapper">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h4>ğŸ“‹ å­¦ç”Ÿè§„åˆ’æ¡£æ¡ˆ (å½“å‰åˆ—è¡¨å†…)</h4>
                    <button id="goal-manage-refresh" class="sidebar-button" style="font-size:0.8em; padding:5px 10px;">ğŸ”„ åˆ·  åˆ—è¡¨</button>
                </div>
                <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                    <table id="goal-manage-table">
                        <thead>
                            <tr>
                                <th>ç­çº§</th>
                                <th>å§“å</th>
                                <th>è§„åˆ’åç§° (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</th>
                                <th>ç±»å‹</th>
                                <th>ç›®æ ‡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="goal-manage-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div id="goal-review-panel" style="display:none; margin-top:20px; border-top:2px dashed #ccc; padding-top:20px;">
                <h3 style="color:var(--primary-color);">ğŸ§ è§„åˆ’å¤ç›˜æŠ¥å‘Š</h3>
                <div class="main-card-wrapper" style="margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0; text-align:left;">ğŸ“ˆ è§„åˆ’è¾¾æˆç‡è¶‹åŠ¿</h4>
                        <div style="display:flex; gap:15px; font-size:0.9em; background:#f1f3f5; padding:5px 10px; border-radius:20px;">
                            <label style="cursor:pointer;"><input type="radio" name="goal-trend-mode" value="student" checked> ğŸ‘¤ å½“å‰å­¦ç”Ÿ</label>
                            <label style="cursor:pointer;"><input type="radio" name="goal-trend-mode" value="all"> ğŸ‘¥ å…¨åˆ—è¡¨å¹³å‡</label>
                        </div>
                    </div>
                    <div class="chart-container" id="goal-trend-line-chart" style="height: 350px;"></div>
                </div>
                <div id="goal-review-content"></div>
            </div>
        </div>

        <div id="goal-detail-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 950px; width: 90%; max-height: 90vh; display: flex; flex-direction: column; padding: 0;">
                <div class="modal-header" style="padding: 15px 20px; border-bottom: 1px solid #eee;">
                    <h3 id="goal-detail-title" style="margin:0;">è§„åˆ’è¯¦æƒ…å›é¡¾</h3>
                    <span onclick="document.getElementById('goal-detail-modal').style.display='none'" class="modal-close-btn">&times;</span>
                </div>
                
                <div class="modal-body" style="overflow-y: auto; flex: 1; padding: 20px;">
                    <div id="goal-detail-alert" style="display:none; background:#fff3cd; color:#856404; padding:10px; margin-bottom:15px; border-radius:4px; font-size:0.9em;"></div>
                    
                    <div id="goal-detail-source-info"></div>

                    <div class="kpi-grid" id="goal-detail-kpi"></div>
                    <div class="table-container" id="goal-detail-table" style="margin-bottom: 20px;"></div>
                    <div class="dashboard-chart-grid-2x2">
                        <div class="main-card-wrapper">
                            <h4 style="margin:0 0 10px 0; text-align:center;">ğŸ“Š è§„åˆ’æåˆ†è·¯å¾„ (ç€‘å¸ƒå›¾)</h4>
                            <div class="chart-container" id="goal-detail-waterfall-chart" style="height: 350px;"></div>
                        </div>
                        <div class="main-card-wrapper">
                            <h4 style="margin:0 0 10px 0; text-align:center;">ğŸ•¸ï¸ ç°çŠ¶ vs ç›®æ ‡ vs å®é™… (é›·è¾¾å›¾)</h4>
                            <div class="chart-container" id="goal-detail-radar-chart" style="height: 350px;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #eee; display:flex; justify-content:flex-end; gap:10px;">
                    <button id="goal-detail-print-btn" class="sidebar-button" style="background-color: var(--color-blue);">ğŸ–¨ï¸ æ‰“å°è¯¦æƒ…å•</button>
                    <button class="sidebar-button" style="background-color: #6c757d;" onclick="document.getElementById('goal-detail-modal').style.display='none'">å…³é—­</button>
                </div>
            </div>
        </div>
    `;

    // ------------------------------------------------------
    // 2. æ•°æ®æºé’©å­ä¸äº‹ä»¶
    // ------------------------------------------------------
    document.getElementById('btn-import-baseline').addEventListener('click', () => { G_CurrentImportType = 'goal-baseline'; document.getElementById('import-modal-title').innerText = 'é€‰æ‹©â€œåŸºå‡†æˆç»©â€'; openImportModal(); });
    document.getElementById('btn-import-outcome').addEventListener('click', () => { G_CurrentImportType = 'goal-outcome'; document.getElementById('import-modal-title').innerText = 'é€‰æ‹©â€œè¾¾æˆæˆç»©â€'; openImportModal(); });

    // å…¨å±€æ•°æ®åˆ·  å›è°ƒ
    window.refreshGoalDataSourceUI = (type, fileName, data) => {
        if (type === 'baseline') {
            document.getElementById('goal-status-baseline').innerHTML = `âœ… å·²å¯¼å…¥: <strong>${fileName}</strong> (${data.length}äºº)`;
            document.getElementById('goal-status-baseline').style.color = "#28a745";
            refreshClassSelector();
            document.getElementById('goal-workspace').style.display = 'none';
        } else if (type === 'outcome') {
            //    æ›´  æ¥æºå
            currentOutcomeSourceName = fileName;
            // ä¿å­˜åˆ°æœ¬åœ°é˜²æ­¢åˆ·  ä¸¢å¤±
            localStorage.setItem('G_GoalOutcome_FileName', fileName);

            document.getElementById('goal-status-outcome').innerHTML = `âœ… å·²å¯¼å…¥: <strong>${fileName}</strong> (${data.length}äºº)`;
            document.getElementById('goal-status-outcome').style.color = "#28a745";
        }
    };

    // æ–‡ä»¶æ§ä»¶ç›‘å¬
    document.getElementById('goal-upload-baseline').addEventListener('change', async (e) => { const file = e.target.files[0]; if (!file) return; try { const { processedData } = await loadExcelData(file); G_GoalBaselineData = addSubjectRanksToData(processedData); window.refreshGoalDataSourceUI('baseline', file.name, G_GoalBaselineData); } catch (err) { alert(err.message); } });
    document.getElementById('goal-upload-outcome').addEventListener('change', async (e) => { const file = e.target.files[0]; if (!file) return; try { const { processedData } = await loadExcelData(file); G_GoalOutcomeData = addSubjectRanksToData(processedData); window.refreshGoalDataSourceUI('outcome', file.name, G_GoalOutcomeData); } catch (err) { alert(err.message); } });

    // ------------------------------------------------------
    // 3. æ‰¹æ¬¡ç®¡ç†é€»è¾‘
    // ------------------------------------------------------
    const sessionSelect = document.getElementById('goal-session-select');
    const sessionLabel = document.getElementById('goal-current-session-label');

    function renderSessionSelect() {
        sessionSelect.innerHTML = sessionMeta.map(s => `<option value="${s.id}" ${s.id === currentSessionId ? 'selected' : ''}>${s.name}</option>`).join('');
        const currentName = sessionMeta.find(s => s.id === currentSessionId)?.name || 'æœªçŸ¥';
        if (sessionLabel) sessionLabel.innerText = currentName;
    }
    renderSessionSelect();

    sessionSelect.addEventListener('change', () => { currentSessionId = sessionSelect.value; localStorage.setItem('G_Goal_Current_Session_ID', currentSessionId); renderManageTable(); refreshClassSelector(); if (sessionLabel) sessionLabel.innerText = sessionSelect.options[sessionSelect.selectedIndex].text; });
    document.getElementById('btn-new-session').addEventListener('click', async () => { const name = prompt("  åˆ—è¡¨åç§°:"); if (!name) return; const newId = 'session_' + Date.now(); sessionMeta.unshift({ id: newId, name: name, createDate: new Date().toLocaleString() }); await localforage.setItem('G_Goal_Session_Meta', sessionMeta); currentSessionId = newId; localStorage.setItem('G_Goal_Current_Session_ID', currentSessionId); renderSessionSelect(); renderManageTable(); });
    document.getElementById('btn-rename-session').addEventListener('click', async () => { const current = sessionMeta.find(s => s.id === currentSessionId); if (!current) return; const newName = prompt("é‡å‘½å:", current.name); if (newName) { current.name = newName; await localforage.setItem('G_Goal_Session_Meta', sessionMeta); renderSessionSelect(); } });
    document.getElementById('btn-delete-session').addEventListener('click', async () => { if (sessionMeta.length <= 1) { alert("è‡³å°‘ä¿ç•™ä¸€ä¸ª!"); return; } if (!confirm("ç¡®å®šåˆ é™¤?")) return; sessionMeta = sessionMeta.filter(s => s.id !== currentSessionId); await localforage.setItem('G_Goal_Session_Meta', sessionMeta); for (const sid of Object.keys(allArchives)) { allArchives[sid] = allArchives[sid].filter(r => r.sessionId !== currentSessionId); } await localforage.setItem('G_Goal_Archives', allArchives); currentSessionId = sessionMeta[0].id; localStorage.setItem('G_Goal_Current_Session_ID', currentSessionId); renderSessionSelect(); renderManageTable(); });

    // ------------------------------------------------------
    // 4.   å»ºè§„åˆ’é€»è¾‘ (Tab 1)
    // ------------------------------------------------------
    function refreshClassSelector() { const classSelect = document.getElementById('goal-class-select'); const studentGrid = document.getElementById('goal-student-grid'); studentGrid.innerHTML = ''; if (!G_GoalBaselineData || G_GoalBaselineData.length === 0) return; const classes = [...new Set(G_GoalBaselineData.map(s => s.class))].sort(); classSelect.innerHTML = `<option value="">-- è¯·é€‰æ‹©ç­çº§ --</option>` + classes.map(c => `<option value="${c}">${c}</option>`).join(''); }
    refreshClassSelector();

    // ã€åœ¨è¿™é‡Œæ’å…¥    ä»£ç ã€‘ å¿«é€Ÿæœç´¢ç›‘å¬
    document.getElementById('goal-fast-search').addEventListener('input', (e) => {
        const term = e.target.value.trim().toLowerCase();
        const grid = document.getElementById('goal-student-grid');

        // å¦‚æœæœç´¢æ¡†æ¸…ç©ºï¼Œè¿™å°±æ¢å¤å½“å‰é€‰ä¸­ç­çº§çš„è§†å›¾ (è§¦å‘ä¸€æ¬¡ change äº‹ä»¶)
        if (!term) {
            document.getElementById('goal-class-select').dispatchEvent(new Event('change'));
            return;
        }

        // åœ¨æ‰€æœ‰åŸºå‡†æ•°æ®ä¸­æœç´¢
        const matches = G_GoalBaselineData.filter(s =>
            s.name.toLowerCase().includes(term) || String(s.id).includes(term)
        );

        if (matches.length === 0) {
            grid.innerHTML = '<p style="color:#999; padding:10px;">æœªæ‰¾åˆ°åŒ¹é…çš„å­¦ç”Ÿ</p>';
            return;
        }

        // æ¸²æŸ“æœç´¢ç»“æœ (å¤ç”¨ä¹‹å‰çš„æŒ‰é’®æ ·å¼é€»è¾‘)
        grid.innerHTML = matches.map(s => {
            let hasPlan = false;
            if (allArchives[s.id]) hasPlan = allArchives[s.id].some(r => r.sessionId === currentSessionId);
            const mark = hasPlan ? `<span style="color:#28a745; font-weight:bold;">âœ…</span>` : '';

            // æ˜¾ç¤ºç­çº§ä¿¡æ¯ï¼Œæ–¹ä¾¿åŒºåˆ†åŒå
            return `<button class="sidebar-button goal-student-btn" data-id="${s.id}" 
                style="background-color:#fff; color:#333; border:1px solid #dee2e6; justify-content:center; font-size:0.9em; flex-direction:column; gap:2px;">
                <span>${s.name} ${mark}</span>
                <span style="font-size:0.75em; color:#999;">${s.class}</span>
            </button>`;
        }).join('');

        // é‡  ç»‘å®šç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.goal-student-btn').forEach(btn => {
            btn.addEventListener('click', () => selectStudent(btn.dataset.id));
        });
    });


    document.getElementById('goal-class-select').addEventListener('change', (e) => { const cls = e.target.value; const grid = document.getElementById('goal-student-grid'); if (!cls) { grid.innerHTML = ''; return; } const studentsInClass = G_GoalBaselineData.filter(s => s.class === cls); grid.innerHTML = studentsInClass.map(s => { let hasPlan = false; if (allArchives[s.id]) hasPlan = allArchives[s.id].some(r => r.sessionId === currentSessionId); const mark = hasPlan ? `<span style="color:#28a745; font-weight:bold;">âœ…</span>` : ''; return `<button class="sidebar-button goal-student-btn" data-id="${s.id}" style="background-color:#fff; color:#333; border:1px solid #dee2e6; justify-content:center; font-size:0.9em;">${s.name} ${mark}</button>`; }).join(''); document.querySelectorAll('.goal-student-btn').forEach(btn => btn.addEventListener('click', () => selectStudent(btn.dataset.id))); document.getElementById('goal-fast-search').value = ''; });
    function selectStudent(id) {
        
        if (G_EditingPlanState && String(G_EditingPlanState.sid) !== String(id)) {
            G_EditingPlanState = null;
            const saveBtn = document.getElementById('goal-save-btn');
            saveBtn.innerHTML = "ğŸ’¾ ä¿å­˜å¹¶æ ‡è®°";
            saveBtn.style.backgroundColor = "#28a745"; // æ¢å¤ç»¿è‰²
            document.getElementById('goal-target-val').value = ""; // æ¸…ç©ºè¾“å…¥
        }
        
        currentStudent = G_GoalBaselineData.find(s => String(s.id) === String(id)); if (!currentStudent) return; document.querySelectorAll('.goal-student-btn').forEach(b => { b.style.backgroundColor = '#fff'; b.style.color = '#333'; }); const activeBtn = document.querySelector(`.goal-student-btn[data-id="${id}"]`); if (activeBtn) { activeBtn.style.backgroundColor = '#007bff'; activeBtn.style.color = '#fff'; } document.getElementById('goal-workspace').style.display = 'block'; document.getElementById('goal-result-area').style.display = 'none'; updateCurrentInfoLabel(); }

    document.getElementsByName('plan-mode').forEach(r => r.addEventListener('change', (e) => { currentPlanMode = e.target.value; document.getElementById('goal-single-subject-select-wrapper').style.display = (currentPlanMode === 'single') ? 'block' : 'none'; document.getElementById('goal-chart-wrapper').style.display = (currentPlanMode === 'total') ? 'grid' : 'none'; updateCurrentInfoLabel(); }));
    document.getElementById('goal-single-subject-select').addEventListener('change', (e) => { currentSubject = e.target.value; updateCurrentInfoLabel(); });
    document.getElementById('goal-target-type').addEventListener('change', updateCurrentInfoLabel);
    // æ›´æ–°å½“å‰çŠ¶æ€æ–‡å­—
    function updateCurrentInfoLabel() { 
        if (!currentStudent) return; 
        const infoEl = document.getElementById('goal-current-info'); 
        const targetType = document.getElementById('goal-target-type').value; // è·å–å½“å‰é€‰çš„æ˜¯â€œåˆ†æ•°â€è¿˜æ˜¯â€œæ’åâ€

        if (currentPlanMode === 'total') {
             // å…¨ç§‘æ¨¡å¼ï¼šä¿æŒæ˜¾ç¤ºæ€»åˆ†å’Œæ€»æ’å
             infoEl.innerHTML = `å­¦ç”Ÿï¼š<strong>${currentStudent.name}</strong> | åŸºå‡†æ€»åˆ†ï¼š${currentStudent.totalScore} | åŸºå‡†å¹´æ’ï¼š${currentStudent.gradeRank}`; 
        } else { 
             // å•ç§‘æ¨¡å¼ï¼šæ ¹æ®ç›®æ ‡ç±»å‹æ™ºèƒ½åˆ‡æ¢
             const score = currentStudent.scores[currentSubject] || 0; 
             
             if (targetType === 'rank') {
                 // å¦‚æœç›®æ ‡è®¾å®šä¸ºâ€œæ’åâ€ï¼Œåˆ™æ˜¾ç¤ºåŸºå‡†æ’å
                 // (é˜²å¾¡æ€§æ£€æŸ¥ï¼šé˜²æ­¢ gradeRanks ä¸å­˜åœ¨)
                 const rank = (currentStudent.gradeRanks && currentStudent.gradeRanks[currentSubject]) 
                              ? currentStudent.gradeRanks[currentSubject] 
                              : '-';
                 infoEl.innerHTML = `å­¦ç”Ÿï¼š<strong>${currentStudent.name}</strong> | ç§‘ç›®ï¼š<strong>${currentSubject}</strong> | <span style="color:#fd7e14; font-weight:bold;">åŸºå‡†å¹´æ’ï¼š${rank}</span> <span style="color:#999; font-size:0.9em;">(å½“å‰åˆ†: ${score})</span>`; 
             } else {
                 // å¦‚æœç›®æ ‡è®¾å®šä¸ºâ€œåˆ†æ•°â€ï¼Œæ˜¾ç¤ºåŸºå‡†åˆ†æ•°
                 infoEl.innerHTML = `å­¦ç”Ÿï¼š<strong>${currentStudent.name}</strong> | ç§‘ç›®ï¼š<strong>${currentSubject}</strong> | åŸºå‡†åˆ†ï¼š${score}`; 
             }
        } 
    }
    // è®¡ç®—ç”Ÿæˆ
    document.getElementById('goal-calc-btn').addEventListener('click', () => {
        if (!currentStudent) return;
        const val = parseFloat(document.getElementById('goal-target-val').value);
        const type = document.getElementById('goal-target-type').value;
        if (!val) { alert("è¯·è¾“å…¥ç›®æ ‡å€¼"); return; }
        currentTargetData = { val, type };
        let details = [], targetTotal = 0, displayGap = 0;

        if (currentPlanMode === 'single') {
            let targetScore = val;
            const currentScore = currentStudent.scores[currentSubject] || 0;
            const fullScore = G_SubjectConfigs[currentSubject] ? G_SubjectConfigs[currentSubject].full : 100;
            if (type === 'rank') {
                const allScores = G_GoalBaselineData.map(s => s.scores[currentSubject]).filter(v => typeof v === 'number').sort((a, b) => b - a);
                const idx = Math.min(Math.max(0, Math.floor(val) - 1), allScores.length - 1);
                targetScore = allScores[idx] || 0;
            }
            if (targetScore > fullScore) targetScore = fullScore;
            details.push({ subject: currentSubject, current: currentScore, target: targetScore, gain: targetScore - currentScore, room: fullScore - currentScore, difficultyText: getDifficultyText(fullScore - currentScore, currentScore, fullScore) });
            targetTotal = targetScore; displayGap = targetScore - currentScore;
        } else {
            let targetScoreVal = val;
            if (type === 'rank') {
                const allTotals = G_GoalBaselineData.map(s => s.totalScore).filter(v => typeof v === 'number').sort((a, b) => b - a);
                const idx = Math.min(Math.max(0, Math.floor(val) - 1), allTotals.length - 1);
                targetScoreVal = allTotals[idx] || 0;
            }
            const baselineStats = calculateAllStatistics(G_GoalBaselineData);
            const allocation = calculateSmartAllocation(currentStudent, targetScoreVal, G_GoalBaselineData, baselineStats);
            details.push(...allocation.details);
            targetTotal = targetScoreVal; displayGap = allocation.totalDeficit;
        }

        currentStrategy = { mode: currentPlanMode, subject: currentPlanMode === 'single' ? currentSubject : 'Total', targetType: type, targetVal: val, targetScoreCalculated: targetTotal, details: details, totalDeficit: displayGap };
        renderGoalResultsUI(currentStudent, currentStrategy, displayGap);
    });

    function renderGoalResultsUI(student, strategy, gap) {
        document.getElementById('goal-result-area').style.display = 'block';
        const kpi = document.getElementById('goal-result-kpi');
        const gapText = gap > 0 ? `éœ€æå‡ ${gap.toFixed(1)}` : `å·²è¾¾æ ‡`;
        const modeText = strategy.mode === 'total' ? "æ€»åˆ†" : strategy.subject;
        kpi.innerHTML = `<div class="kpi-card"><h3>ç›®æ ‡${modeText}</h3><div class="value" style="color:var(--color-purple)">${strategy.targetScoreCalculated.toFixed(1)}</div></div><div class="kpi-card"><h3>å·®è·</h3><div class="value" style="font-size:1.5em; color:${gap > 0 ? '#dc3545' : '#28a745'}">${gapText}</div></div>`;
        document.getElementById('goal-result-table').innerHTML = `<table><thead><tr><th>ç§‘ç›®</th><th>åŸºå‡†åˆ†</th><th>ç›®æ ‡</th><th style="color:purple">éœ€æåˆ†</th><th>ç­–ç•¥</th></tr></thead><tbody>${strategy.details.map(d => `<tr><td>${d.subject}</td><td>${d.current}</td><td><strong>${d.target.toFixed(1)}</strong></td><td style="font-weight:bold; color:${d.gain > 0 ? 'purple' : '#999'}">+${d.gain.toFixed(1)}</td><td>${d.difficultyText}</td></tr>`).join('')}</tbody></table>`;
        if (strategy.mode === 'total') {
            renderGoalWaterfall('goal-waterfall-chart', student.totalScore, strategy.targetScoreCalculated, strategy.details);
            renderGoalRadar('goal-radar-chart', student, strategy.details);
        }
    }

    // ä¿å­˜è§„åˆ’
    document.getElementById('goal-save-btn').addEventListener('click', async () => {
        if (!currentStudent || !currentStrategy) return;
        const planName = prompt("è§„åˆ’åç§°:", "ç›®æ ‡-" + new Date().toLocaleDateString());
        if (!planName) return;

        let baselineSource = "ç³»ç»Ÿé»˜è®¤æ•°æ®";
        const baselineStatusText = document.getElementById('goal-status-baseline').innerText;
        if (baselineStatusText.includes('å·²å¯¼å…¥')) { const match = document.getElementById('goal-status-baseline').querySelector('strong'); if (match) baselineSource = match.innerText; }

        const record = { id: Date.now(), sessionId: currentSessionId, studentId: currentStudent.id, studentName: currentStudent.name, className: currentStudent.class, name: planName, createDate: new Date().toLocaleString(), baselineSource: baselineSource, strategy: currentStrategy };
        if (!allArchives[currentStudent.id]) allArchives[currentStudent.id] = [];
        allArchives[currentStudent.id].unshift(record);
        await localforage.setItem('G_Goal_Archives', allArchives);
        alert("âœ… è§„åˆ’å·²ä¿å­˜ï¼");
        const btn = document.querySelector(`.goal-student-btn[data-id="${currentStudent.id}"]`);
        if (btn && !btn.innerHTML.includes('âœ…')) btn.innerHTML += ` <span style="color:#28a745; font-weight:bold;">âœ…</span>`;
    });

    document.getElementById('goal-print-btn').addEventListener('click', () => { if (!currentStudent || !currentStrategy) return; let printRank = currentTargetData.type === 'rank' ? currentTargetData.val : '-'; startGoalPrintJob(currentStudent, currentStrategy.targetScoreCalculated, printRank, currentStrategy); });

    // ------------------------------------------------------
    // 5. ç®¡ç†å¤§å…é€»è¾‘ (Tab 2)
    // ------------------------------------------------------
    const tabManage = document.querySelector('button[data-tab="manage"]');
    const tabCreate = document.querySelector('button[data-tab="create"]');
    tabManage.addEventListener('click', () => { document.getElementById('goal-tab-create').style.display = 'none'; document.getElementById('goal-tab-manage').style.display = 'block'; tabManage.classList.add('active'); tabManage.style.borderBottomColor = 'var(--primary-color)'; tabManage.style.color = 'var(--primary-color)'; tabCreate.classList.remove('active'); tabCreate.style.borderBottomColor = 'transparent'; tabCreate.style.color = '#666'; renderManageTable(); });
    tabCreate.addEventListener('click', () => { document.getElementById('goal-tab-create').style.display = 'block'; document.getElementById('goal-tab-manage').style.display = 'none'; tabCreate.classList.add('active'); tabCreate.style.borderBottomColor = 'var(--primary-color)'; tabCreate.style.color = 'var(--primary-color)'; tabManage.classList.remove('active'); tabManage.style.borderBottomColor = 'transparent'; tabManage.style.color = '#666'; });
    document.getElementById('goal-manage-refresh').addEventListener('click', renderManageTable);

// [å‡çº§ç‰ˆ] æ¸²æŸ“ç®¡ç†å¤§å…è¡¨æ ¼ (æ”¯æŒç‚¹å‡»è¡¨å¤´æ’åº)
    async function renderManageTable() {
        // 1. åˆå§‹åŒ–æ’åºçŠ¶æ€ (å…¨å±€æŒä¹…åŒ–ï¼Œé˜²æ­¢åˆ‡æ¢Tabä¸¢å¤±)
        if (typeof window.G_GoalManageSort === 'undefined') {
            window.G_GoalManageSort = { key: 'id', direction: 'desc' }; // é»˜è®¤æŒ‰åˆ›å»ºæ—¶é—´å€’åº
        }

        // 2. åŠ¨æ€å‡çº§è¡¨å¤´ (æ³¨å…¥æ’åºåŠŸèƒ½)
        const thead = document.querySelector('#goal-manage-table thead');
        if (thead && !thead.dataset.sortEnabled) {
            thead.dataset.sortEnabled = "true";
            thead.innerHTML = `
                <tr>
                    <th data-sort="className" style="cursor:pointer; user-select:none;">ç­çº§ â‡…</th>
                    <th data-sort="studentName" style="cursor:pointer; user-select:none;">å§“å â‡…</th>
                    <th data-sort="name" style="cursor:pointer; user-select:none;">è§„åˆ’åç§° â‡…</th>
                    <th data-sort="mode" style="cursor:pointer; user-select:none;">ç±»å‹ â‡…</th>
                    <th data-sort="target" style="cursor:pointer; user-select:none;">ç›®æ ‡ â‡…</th>
                    <th>æ“ä½œ</th>
                </tr>
            `;
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            thead.addEventListener('click', (e) => {
                const th = e.target.closest('th');
                if (!th || !th.dataset.sort) return;
                const key = th.dataset.sort;
                
                // åˆ‡æ¢æ’åºé€»è¾‘
                if (window.G_GoalManageSort.key === key) {
                    window.G_GoalManageSort.direction = window.G_GoalManageSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    window.G_GoalManageSort.key = key;
                    window.G_GoalManageSort.direction = 'desc'; // é»˜è®¤é™åº
                }
                // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                renderManageTable();
            });
        }

        // 3. æ›´æ–°è¡¨å¤´æ ·å¼ (é«˜äº®å½“å‰æ’åºåˆ—)
        if (thead) {
            const ths = thead.querySelectorAll('th[data-sort]');
            ths.forEach(th => {
                th.style.color = '';
                // é‡ç½®å›¾æ ‡
                let text = th.innerText.replace(/[â†‘â†“â‡…]/g, '').trim();
                th.innerText = text + ' â‡…';
                
                if (th.dataset.sort === window.G_GoalManageSort.key) {
                    th.style.color = '#007bff'; // é«˜äº®é¢œè‰²
                    const icon = window.G_GoalManageSort.direction === 'asc' ? ' â†‘' : ' â†“';
                    th.innerText = text + icon;
                }
            });
        }

        // 4. è·å–å¹¶æ•´ç†æ•°æ®
        allArchives = await localforage.getItem('G_Goal_Archives') || {};
        const tbody = document.getElementById('goal-manage-tbody');
        const rows = [];
        
        Object.keys(allArchives).forEach(sid => { 
            if (Array.isArray(allArchives[sid])) { 
                allArchives[sid].forEach((plan, idx) => { 
                    if (plan.sessionId === currentSessionId || (!plan.sessionId && currentSessionId === sessionMeta[0].id)) { 
                        rows.push({ ...plan, idx, sid }); 
                    } 
                }); 
            } 
        });
        
        if (rows.length === 0) { 
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">å½“å‰åˆ—è¡¨ [${sessionLabel.innerText}] æš‚æ— è®°å½•</td></tr>`; 
            return; 
        }
        
        // 5. [æ ¸å¿ƒ] æ‰§è¡Œæ’åº
        const { key, direction } = window.G_GoalManageSort;
        rows.sort((a, b) => {
            let valA, valB;
            
            // æå–æ’åºå€¼
            if (key === 'target') {
                // ç›®æ ‡å€¼æ’åº (ä¼˜å…ˆç”¨è®¡ç®—åçš„åˆ†æ•°ï¼Œä¿è¯æ’åå’Œåˆ†æ•°èƒ½æ··åˆæ¯”è¾ƒ)
                valA = a.strategy.targetScoreCalculated || 0;
                valB = b.strategy.targetScoreCalculated || 0;
            } else if (key === 'mode') {
                valA = a.strategy.mode; // 'total' or 'single'
                valB = b.strategy.mode;
            } else if (key === 'id') {
                valA = a.id; valB = b.id; // åˆ›å»ºæ—¶é—´
            } else {
                // ç­çº§ã€å§“åã€è§„åˆ’åç§°
                valA = a[key] || ''; 
                valB = b[key] || '';
            }
            
            // æ‰§è¡Œæ¯”è¾ƒ
            if (typeof valA === 'string') {
                return direction === 'asc' ? valA.localeCompare(valB, 'zh-CN') : valB.localeCompare(valA, 'zh-CN');
            } else {
                return direction === 'asc' ? valA - valB : valB - valA;
            }
        });
        
        // 6. æ¸²æŸ“è¡¨æ ¼è¡Œ
        tbody.innerHTML = rows.map(r => { 
            const st = r.strategy || {}; 
            let targetDisplay = "";
            const isTotal = st.mode === 'total';
            const subjectLabel = isTotal ? "æ€»åˆ†" : st.subject;

            if (st.targetType === 'rank') {
                targetDisplay = `${subjectLabel} å¹´æ’ <span style="color:#fd7e14; font-weight:bold;">${st.targetVal}</span> å`;
            } else {
                const scoreVal = st.targetVal || st.targetScoreCalculated;
                targetDisplay = `${subjectLabel} <span style="color:#6f42c1; font-weight:bold;">${parseFloat(scoreVal).toFixed(1)}</span> åˆ†`;
            }

            return `
                <tr>
                    <td>${r.className}</td>
                    <td onclick="showPlanDetail('${r.sid}', ${r.idx})" style="cursor:pointer; color:#007bff; font-weight:bold;" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">
                        ${r.studentName} ğŸ“Š
                    </td>
                    <td onclick="renamePlan('${r.sid}', ${r.idx})" style="cursor:pointer; color:#333;">
                        ${r.name || 'æœªå‘½å'} <span style="font-size:0.8em; color:#999;">âœ</span>
                    </td>
                    <td>${isTotal ? 'å…¨ç§‘' : 'å•ç§‘'}</td>
                    <td>${targetDisplay}</td>
                    <td>
                        <button onclick="editPlanGlobal('${r.sid}', ${r.idx})" class="sidebar-button" style="background-color:#17a2b8; padding:4px 8px; font-size:0.8em;">ä¿®æ”¹</button>
                        <button onclick="reviewPlanGlobal('${r.sid}', ${r.idx})" class="sidebar-button" style="background-color:#28a745; padding:4px 8px; font-size:0.8em; margin-left:5px;">å¤ç›˜</button>
                        <button onclick="deletePlanGlobal('${r.sid}', ${r.idx})" class="sidebar-button" style="background-color:#dc3545; padding:4px 8px; font-size:0.8em; margin-left:5px;">åˆ é™¤</button>
                    </td>
                </tr>
            `; 
        }).join('');
    }

    window.renamePlan = async (sid, idx) => { let archives = await localforage.getItem('G_Goal_Archives'); const newName = prompt("é‡å‘½å:", archives[sid][idx].name); if (newName) { archives[sid][idx].name = newName; await localforage.setItem('G_Goal_Archives', archives); renderManageTable(); } };
    window.deletePlanGlobal = async (sid, idx) => { if (!confirm("ç¡®å®šåˆ é™¤?")) return; let archives = await localforage.getItem('G_Goal_Archives'); archives[sid].splice(idx, 1); await localforage.setItem('G_Goal_Archives', archives); renderManageTable(); };

    //    è¯¦æƒ…æŸ¥çœ‹ (å«æ¥æºæ˜¾ç¤º + æ‰“å°)
    window.showPlanDetail = async (sid, idx) => {
        let archives = await localforage.getItem('G_Goal_Archives');
        const plan = archives[sid][idx];
        if (!plan) return;

        let actualStudent = null;
        if (G_GoalOutcomeData) actualStudent = G_GoalOutcomeData.find(s => String(s.id) === String(sid));

        const modal = document.getElementById('goal-detail-modal');
        const titleEl = document.getElementById('goal-detail-title');
        const alertEl = document.getElementById('goal-detail-alert');
        const sourceInfoEl = document.getElementById('goal-detail-source-info');
        const kpiEl = document.getElementById('goal-detail-kpi');
        const tableEl = document.getElementById('goal-detail-table');
        const printBtn = document.getElementById('goal-detail-print-btn');

        titleEl.innerText = `${plan.studentName} - ${plan.name}`;

        //    æ¥æºæ˜¾ç¤ºé€»è¾‘
        const baseSource = plan.baselineSource || 'ç³»ç»Ÿé»˜è®¤/æœªçŸ¥';
        const outSource = actualStudent ? currentOutcomeSourceName : null; // ä½¿ç”¨ currentOutcomeSourceName

        sourceInfoEl.innerHTML = `
            <div style="background:#f1f3f5; padding:8px 12px; border-radius:6px; margin-bottom:15px; font-size:0.9em; color:#555; display:flex; flex-wrap:wrap; gap:15px;">
                <span>ğŸ“„ <strong>è§„åˆ’åŸºå‡†:</strong> ${baseSource}</span>
                ${outSource ? `<span>ğŸ“‰ <strong>å¤ç›˜ä¾æ®:</strong> ${outSource}</span>` : ''}
            </div>
        `;

        if (actualStudent) {
            alertEl.style.display = 'none';
        } else {
            alertEl.innerHTML = `âš ï¸ æœªæ£€æµ‹åˆ°â€œè¾¾æˆæˆç»©â€æ•°æ®æºï¼Œå½“å‰ä»…æ˜¾ç¤ºè§„åˆ’å†…å®¹ã€‚å¦‚éœ€å¯¹æ¯”ï¼Œè¯·å…ˆåœ¨ç®¡ç†å¤§å…é¡¶éƒ¨å¯¼å…¥â€œè¾¾æˆæˆç»©è¡¨â€ã€‚`;
            alertEl.style.display = 'block';
        }

        const st = plan.strategy;
        const modeText = st.mode === 'total' ? "æ€»åˆ†" : st.subject;
        let baseTotal = 0;
        st.details.forEach(d => baseTotal += d.current);

        let actualTotal = 0;
        let actualDiffHtml = '<span style="color:#ccc; font-size:0.5em;">(æ— æ•°æ®)</span>';

        if (actualStudent) {
            if (st.mode === 'total') {
                actualTotal = actualStudent.totalScore;
            } else {
                actualTotal = actualStudent.scores[st.subject] || 0;
            }
            const diff = actualTotal - st.targetScoreCalculated;
            const diffClass = diff >= 0 ? 'progress' : 'regress';
            const diffIcon = diff >= 0 ? 'ğŸ‰' : 'âš ï¸';
            actualDiffHtml = `<span class="${diffClass}" style="font-size:0.6em;">${diffIcon} ${diff > 0 ? '+' : ''}${diff.toFixed(1)}</span>`;
        }

        kpiEl.innerHTML = `
            <div class="kpi-card"><h3>åŸºå‡†${modeText}</h3><div class="value">${baseTotal.toFixed(1)}</div></div>
            <div class="kpi-card"><h3>ç›®æ ‡${modeText}</h3><div class="value" style="color:var(--color-purple)">${st.targetScoreCalculated.toFixed(1)}</div></div>
            ${actualStudent ? `<div class="kpi-card" style="border-left:5px solid #fd7e14;"><h3>å®é™…${modeText}</h3><div class="value" style="color:#fd7e14;">${actualTotal} ${actualDiffHtml}</div></div>` : ''}
            <div class="kpi-card"><h3>è®¡åˆ’æå‡</h3><div class="value" style="color:#28a745">+${(st.targetScoreCalculated - baseTotal).toFixed(1)}</div></div>
        `;

        let tableHtml = `<table><thead><tr><th>ç§‘ç›®</th><th>åŸºå‡†åˆ†</th><th>ç›®æ ‡åˆ†</th><th>è®¡åˆ’  é‡</th>${actualStudent ? `<th style="background:#fff8e1;">å®é™…åˆ†</th><th style="background:#fff8e1;">è¾¾æˆå·®å€¼</th>` : ''}<th>ç­–ç•¥</th></tr></thead><tbody>`;
        st.details.forEach(d => {
            let actualCell = '';
            if (actualStudent) {
                const actScore = actualStudent.scores[d.subject] || 0;
                const diff = actScore - d.target;
                const color = diff >= 0 ? 'green' : 'red';
                const icon = diff >= 0 ? 'âœ…' : 'âŒ';
                actualCell = `<td style="font-weight:bold; background:#fffbf0;">${actScore}</td><td style="color:${color}; background:#fffbf0;">${icon} ${diff > 0 ? '+' : ''}${diff.toFixed(1)}</td>`;
            }
            tableHtml += `<tr><td>${d.subject}</td><td>${d.current}</td><td><strong>${d.target.toFixed(1)}</strong></td><td style="color:#6f42c1;">+${d.gain.toFixed(1)}</td>${actualCell}<td>${d.difficultyText}</td></tr>`;
        });
        tableHtml += `</tbody></table>`;
        tableEl.innerHTML = tableHtml;

        // æ‰“å°ç»‘å®š (ä¼ é€’æ¥æºå)
        printBtn.onclick = () => {
            startDetailPrintJob(plan, actualStudent, baseTotal, actualTotal, baseSource, outSource);
        };

        modal.style.display = 'flex';
        setTimeout(() => {
            if (st.mode === 'total') {
                renderGoalWaterfall('goal-detail-waterfall-chart', baseTotal, st.targetScoreCalculated, st.details);
                renderGoalRadarComparison('goal-detail-radar-chart', st.details, actualStudent);
            } else {
                document.getElementById('goal-detail-waterfall-chart').innerHTML = '<p style="text-align:center; padding-top:50px; color:#999;">å•ç§‘æ¨¡å¼æ— ç€‘å¸ƒå›¾</p>';
                document.getElementById('goal-detail-radar-chart').innerHTML = '<p style="text-align:center; padding-top:50px; color:#999;">å•ç§‘æ¨¡å¼æ— é›·è¾¾å›¾</p>';
            }
        }, 100);
    };

    // [æ–°å¢] å…¨å±€ä¿®æ”¹å‡½æ•°ï¼šå›å¡«æ•°æ®å¹¶åˆ‡æ¢Tab
    window.editPlanGlobal = async (sid, idx) => {
        let archives = await localforage.getItem('G_Goal_Archives');
        const plan = archives[sid][idx];
        if (!plan) return;

        // 1. æ ‡è®°è¿›å…¥ç¼–è¾‘æ¨¡å¼
        G_EditingPlanState = { sid: sid, idx: idx };
        
        // 2. åˆ‡æ¢åˆ°â€œæ–°å»ºè§„åˆ’â€Tab
        document.querySelector('button[data-tab="create"]').click();
        
        // 3. é€‰ä¸­å­¦ç”Ÿ (è¿™ä¼šåˆå§‹åŒ–ç•Œé¢)
        selectStudent(sid); 

        // 4. å›å¡«è¡¨å•æ•°æ®
        const st = plan.strategy;
        
        // å›å¡«æ¨¡å¼ (å…¨ç§‘/å•ç§‘) - è§¦å‘ç‚¹å‡»ä»¥è”åŠ¨æ˜¾ç¤ºéšè—
        const modeRadio = document.querySelector(`input[name="plan-mode"][value="${st.mode}"]`);
        if (modeRadio) modeRadio.click();

        // å›å¡«ç§‘ç›® (å¦‚æœæ˜¯å•ç§‘)
        if (st.mode === 'single') {
            const subSelect = document.getElementById('goal-single-subject-select');
            subSelect.value = st.subject;
            // æ‰‹åŠ¨è§¦å‘ change æ›´æ–°ä¸‹æ–¹åŸºå‡†åˆ†
            subSelect.dispatchEvent(new Event('change'));
        }

        // å›å¡«ç›®æ ‡ç±»å‹ (åˆ†æ•°/æ’å)
        const typeSelect = document.getElementById('goal-target-type');
        if (st.targetType) {
            typeSelect.value = st.targetType;
            typeSelect.dispatchEvent(new Event('change')); // è§¦å‘æ›´æ–°ä¸‹æ–¹æ–‡å­—
        }

        // å›å¡«ç›®æ ‡å€¼
        document.getElementById('goal-target-val').value = st.targetVal || "";

        // 5. æ›´æ–°ä¿å­˜æŒ‰é’®çš„æ–‡å­—ï¼Œæç¤ºç”¨æˆ·æ­£åœ¨ä¿®æ”¹
        const saveBtn = document.getElementById('goal-save-btn');
        saveBtn.innerHTML = "ğŸ’¾ ç¡®è®¤ä¿®æ”¹ (è¦†ç›–æ—§è®°å½•)";
        saveBtn.style.backgroundColor = "#17a2b8"; // å˜è“è‰²æç¤º
        
        // æç¤ºç”¨æˆ·
        alert(`å·²åŠ è½½ã€${plan.studentName}ã€‘çš„è§„åˆ’ã€‚\nè¯·è°ƒæ•´ç›®æ ‡å€¼åï¼Œç‚¹å‡»â€œç”Ÿæˆè§„åˆ’â€ï¼Œæœ€åç‚¹å‡»â€œç¡®è®¤ä¿®æ”¹â€ã€‚`);
    };



    // [è¾…åŠ©] 3ç»´é›·è¾¾å›¾æ¸²æŸ“ (åŸºå‡† vs ç›®æ ‡ vs å®é™…)
    function renderGoalRadarComparison(elemId, details, actualStudent) {
        const dom = document.getElementById(elemId);
        if (!dom) return;
        if (echartsInstances[elemId]) echartsInstances[elemId].dispose();
        const myChart = echarts.init(dom);

        const indicators = [];
        const dataBaseline = [];
        const dataTarget = [];
        const dataActual = [];

        details.forEach(d => {
            // ä¼°ç®—æ»¡åˆ†
            const full = d.current + d.room;
            indicators.push({ name: d.subject, max: full });
            dataBaseline.push(d.current);
            dataTarget.push(d.target);
            if (actualStudent) {
                dataActual.push(actualStudent.scores[d.subject] || 0);
            }
        });

        const seriesData = [
            { value: dataBaseline, name: 'åŸºå‡†æˆç»©', itemStyle: { color: '#6c757d' }, lineStyle: { type: 'dotted' } },
            { value: dataTarget, name: 'è§„åˆ’ç›®æ ‡', itemStyle: { color: '#6f42c1' }, areaStyle: { opacity: 0.1, color: '#6f42c1' } }
        ];

        if (actualStudent) {
            seriesData.push({
                value: dataActual,
                name: 'å®é™…æˆç»©',
                itemStyle: { color: '#fd7e14' }, // æ©™è‰²
                lineStyle: { width: 3 },
                areaStyle: { opacity: 0.2, color: '#fd7e14' }
            });
        }

        const option = {
            tooltip: { trigger: 'item' },
            legend: { bottom: 0 },
            radar: { indicator: indicators, radius: '60%' },
            series: [{ type: 'radar', data: seriesData }]
        };
        myChart.setOption(option);
        echartsInstances[elemId] = myChart;
    }

    window.renamePlan = async (sid, idx) => {
        let archives = await localforage.getItem('G_Goal_Archives');
        const newName = prompt("é‡å‘½å:", archives[sid][idx].name);
        if (newName) { archives[sid][idx].name = newName; await localforage.setItem('G_Goal_Archives', archives); renderManageTable(); }
    };
    window.deletePlanGlobal = async (sid, idx) => {
        if (!confirm("ç¡®å®šåˆ é™¤?")) return;
        let archives = await localforage.getItem('G_Goal_Archives');
        archives[sid].splice(idx, 1); await localforage.setItem('G_Goal_Archives', archives); renderManageTable();
    };

// [æ ¸å¿ƒå‡çº§ç‰ˆ] å¤ç›˜æŸ¥çœ‹ (æ™ºèƒ½è¯†åˆ« æ’å/åˆ†æ•° ç›®æ ‡)
    window.reviewPlanGlobal = async (sid, idx) => {
        if (!G_GoalOutcomeData) { alert("âš ï¸ è¯·å…ˆåœ¨é¡¶éƒ¨å³ä¾§å¯¼å…¥ã€è¾¾æˆæˆç»©è¡¨ã€‘ï¼Œç³»ç»Ÿæ‰èƒ½è¿›è¡Œå¯¹æ¯”å¤ç›˜ï¼"); return; }

        let archives = await localforage.getItem('G_Goal_Archives');
        const plan = archives[sid][idx];
        const actualStudent = G_GoalOutcomeData.find(s => String(s.id) === String(sid));

        const panel = document.getElementById('goal-review-panel');
        const content = document.getElementById('goal-review-content');
        panel.style.display = 'block';

        if (!actualStudent) { 
            content.innerHTML = `<div style="padding:20px; text-align:center; color:#dc3545; background:#fff5f5; border-radius:8px;">âŒ é”™è¯¯ï¼šåœ¨â€œè¾¾æˆæˆç»©è¡¨â€ä¸­æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿ (è€ƒå· ${sid})ã€‚<br>è¯·æ£€æŸ¥æ˜¯å¦å¯¼å…¥äº†æ­£ç¡®çš„è€ƒè¯•æ•°æ®ã€‚</div>`; 
            return; 
        }

        // ------------------------------------------------------
        // 1. æ ¸å¿ƒç›®æ ‡è¾¾æˆåˆ¤å®š (æ–°å¢é€»è¾‘)
        // ------------------------------------------------------
        const st = plan.strategy;
        const isRankGoal = st.targetType === 'rank';
        const isTotal = st.mode === 'total';
        const subject = st.subject;

        // è·å–ç›®æ ‡å€¼
        const targetVal = parseFloat(st.targetVal || st.targetScoreCalculated); 

        // è·å–å®é™…å€¼
        let actualVal = 0;
        if (isRankGoal) {
            // å¦‚æœç›®æ ‡æ˜¯æ’åï¼Œè·å–å®é™…æ’å
            if (isTotal) {
                actualVal = actualStudent.gradeRank;
            } else {
                // å•ç§‘æ’å (é˜²å¾¡æ€§æ£€æŸ¥)
                actualVal = (actualStudent.gradeRanks && actualStudent.gradeRanks[subject]) ? actualStudent.gradeRanks[subject] : 9999;
            }
        } else {
            // å¦‚æœç›®æ ‡æ˜¯åˆ†æ•°ï¼Œè·å–å®é™…åˆ†æ•°
            if (isTotal) {
                actualVal = actualStudent.totalScore;
            } else {
                actualVal = actualStudent.scores[subject] || 0;
            }
        }

        // è®¡ç®—å·®è· (åˆ†æ•°æ˜¯é«˜å¥½ï¼Œæ’åæ˜¯ä½å¥½)
        let diff = 0;
        let isAchieved = false;
        let resultHtml = "";

        if (isRankGoal) {
            // æ’åé€»è¾‘ï¼šç›®æ ‡ 50ï¼Œå®é™… 40ï¼Œdiff = 50 - 40 = 10 (è¿›æ­¥10å)
            diff = targetVal - actualVal; 
            isAchieved = actualVal <= targetVal;
            
            const color = isAchieved ? '#28a745' : '#dc3545';
            const icon = isAchieved ? 'ğŸ‰ è¾¾æˆ' : 'âš ï¸ æœªè¾¾æˆ';
            const diffText = diff > 0 ? `å‰è¿› ${Math.abs(diff)} å` : (diff < 0 ? `åé€€ ${Math.abs(diff)} å` : `æŒå¹³`);
            
            resultHtml = `
                <div class="kpi-card" style="background:#fff; border-left: 5px solid ${color}; width:100%; margin-bottom:20px;">
                    <h3>æ ¸å¿ƒç›®æ ‡ (${isTotal ? 'æ€»åˆ†' : subject}å¹´æ’)</h3>
                    <div style="display:flex; align-items:baseline; gap:15px;">
                        <span style="font-size:1.2em; color:#666;">ç›®æ ‡: <strong>${targetVal}</strong></span>
                        <span style="font-size:1.2em; color:#333;">å®é™…: <strong>${actualVal}</strong></span>
                        <span style="font-size:1.4em; font-weight:bold; color:${color}; margin-left:auto;">${icon} <span style="font-size:0.6em;">(${diffText})</span></span>
                    </div>
                </div>
            `;
        } else {
            // åˆ†æ•°é€»è¾‘ï¼šç›®æ ‡ 600ï¼Œå®é™… 620ï¼Œdiff = 620 - 600 = 20 (è¿›æ­¥20åˆ†)
            diff = actualVal - targetVal;
            isAchieved = actualVal >= targetVal;
            
            const color = isAchieved ? '#28a745' : '#dc3545';
            const icon = isAchieved ? 'ğŸ‰ è¾¾æˆ' : 'âš ï¸ æœªè¾¾æˆ';
            const diffText = diff > 0 ? `è¶… ${Math.abs(diff).toFixed(1)} åˆ†` : `å·® ${Math.abs(diff).toFixed(1)} åˆ†`;

            resultHtml = `
                <div class="kpi-card" style="background:#fff; border-left: 5px solid ${color}; width:100%; margin-bottom:20px;">
                    <h3>æ ¸å¿ƒç›®æ ‡ (${isTotal ? 'æ€»åˆ†' : subject})</h3>
                    <div style="display:flex; align-items:baseline; gap:15px;">
                        <span style="font-size:1.2em; color:#666;">ç›®æ ‡: <strong>${targetVal}</strong></span>
                        <span style="font-size:1.2em; color:#333;">å®é™…: <strong>${actualVal}</strong></span>
                        <span style="font-size:1.4em; font-weight:bold; color:${color}; margin-left:auto;">${icon} <span style="font-size:0.6em;">(${diffText})</span></span>
                    </div>
                </div>
            `;
        }

        // ------------------------------------------------------
        // 2. å›¾è¡¨ç»˜åˆ¶é€»è¾‘ (ä¿æŒåˆ†æ•°è¾¾æˆç‡ï¼Œä½œä¸ºåŠªåŠ›ç¨‹åº¦å‚è€ƒ)
        // ------------------------------------------------------
        const radios = document.getElementsByName('goal-trend-mode');
        const drawChart = () => {
            let mode = 'student';
            radios.forEach(r => { if (r.checked) mode = r.value; });
            const trendX = [];
            const trendY = [];

            // *æ³¨ï¼šè¶‹åŠ¿å›¾ä¾ç„¶ä½¿ç”¨ã€åˆ†æ•°è¾¾æˆç‡ã€‘ç»˜åˆ¶ï¼Œå› ä¸ºæ’åæ— æ³•ç®€å•è®¡ç®—ç™¾åˆ†æ¯” (æ’å1ä¸æ˜¯100%ï¼Œæ’å500ä¸æ˜¯0%)
            // è¿™é‡Œæˆ‘ä»¬æ¯”è¾ƒçš„æ˜¯ "è®¡ç®—å‡ºçš„ç›®æ ‡åˆ†" vs "å®é™…åˆ†"
            if (mode === 'student') {
                const studentPlans = archives[sid] || [];
                const sessionPlans = studentPlans.filter(p => p.sessionId === currentSessionId).sort((a, b) => a.id - b.id);
                sessionPlans.forEach(p => {
                    if (p.strategy.mode === 'total' && actualStudent) {
                        const rate = (actualStudent.totalScore / p.strategy.targetScoreCalculated) * 100;
                        trendX.push(p.name);
                        trendY.push(parseFloat(rate.toFixed(1)));
                    }
                });
                renderGoalTrendChart('goal-trend-line-chart', trendX, trendY, `å¾—åˆ†è¾¾æˆç‡è¶‹åŠ¿ (å½“å‰å­¦ç”Ÿ: ${plan.studentName})`);
            } else {
                // ... å…¨åˆ—è¡¨å¹³å‡é€»è¾‘ (ä¿æŒåŸæ ·) ...
                const allSessionPlans = [];
                Object.values(archives).forEach(userPlans => {
                    userPlans.forEach(p => { if (p.sessionId === currentSessionId) allSessionPlans.push(p); });
                });
                const groups = {};
                allSessionPlans.forEach(p => {
                    if (p.strategy.mode === 'total') {
                        if (!groups[p.name]) groups[p.name] = { sumRate: 0, count: 0, ts: p.id };
                        const sData = G_GoalOutcomeData.find(s => String(s.id) === String(p.studentId));
                        if (sData) {
                            const rate = (sData.totalScore / p.strategy.targetScoreCalculated) * 100;
                            groups[p.name].sumRate += rate;
                            groups[p.name].count++;
                        }
                    }
                });
                const sortedGroups = Object.keys(groups).map(name => ({
                    name: name, avgRate: groups[name].count > 0 ? (groups[name].sumRate / groups[name].count) : 0, ts: groups[name].ts
                })).sort((a, b) => a.ts - b.ts);
                sortedGroups.forEach(g => { trendX.push(g.name); trendY.push(parseFloat(g.avgRate.toFixed(1))); });
                renderGoalTrendChart('goal-trend-line-chart', trendX, trendY, `å¾—åˆ†è¾¾æˆç‡è¶‹åŠ¿ (å…¨åˆ—è¡¨å¹³å‡)`);
            }
        };
        radios.forEach(r => r.onclick = drawChart);
        radios[0].checked = true;
        drawChart();

        // ------------------------------------------------------
        // 3. æ¸²æŸ“è¯¦æƒ…è¡¨æ ¼
        // ------------------------------------------------------
        let tableHtml = `<h4>${plan.studentName} - ${plan.name} (ç§‘ç›®ç»†åˆ†)</h4>`;
        tableHtml += `<table><thead><tr><th>ç§‘ç›®</th><th>è§„åˆ’åˆ†æ•°ç›®æ ‡</th><th>å®é™…å¾—åˆ†</th><th>çŠ¶æ€</th></tr></thead><tbody>`;
        
        st.details.forEach(d => {
            const actual = actualStudent.scores[d.subject] || 0;
            const diff = actual - d.target;
            // ç§‘ç›®ç»†åˆ†ä¾ç„¶å¯¹æ¯”åˆ†æ•°ï¼ˆå› ä¸ºå•ç§‘æ’åå¾ˆéš¾ç²¾ç¡®æ‹†è§£ï¼‰
            const status = diff >= 0 ? 'âœ…' : `ğŸ”» ${diff.toFixed(1)}`;
            const color = diff >= 0 ? 'green' : 'red';
            tableHtml += `<tr><td>${d.subject}</td><td>${d.target.toFixed(1)}</td><td style="font-weight:bold;">${actual}</td><td style="color:${color}">${status}</td></tr>`;
        });
        tableHtml += `</tbody></table>`;

        // ç»„åˆå†…å®¹
        content.innerHTML = resultHtml + tableHtml;
        
        panel.scrollIntoView({ behavior: 'smooth' });
    };
}

// è¾…åŠ©: æ¸²æŸ“è¶‹åŠ¿å›¾
function renderGoalTrendChart(elemId, xData, yData, titleText) {
    const dom = document.getElementById(elemId);
    if (!dom) return;
    if (echartsInstances[elemId]) echartsInstances[elemId].dispose();
    const myChart = echarts.init(dom);
    const option = {
        title: { text: titleText, left: 'center', textStyle: { fontSize: 14 } },
        tooltip: { trigger: 'axis', formatter: '{b}<br/>è¾¾æˆç‡: {c}%' },
        grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
        xAxis: { type: 'category', data: xData, axisLabel: { rotate: 30 } },
        yAxis: { type: 'value', name: 'è¾¾æˆç‡ (%)', min: (val) => Math.floor(val.min * 0.9), max: (val) => Math.ceil(val.max * 1.05) },
        series: [{
            data: yData, type: 'line', smooth: true,
            markLine: { data: [{ yAxis: 100, name: '100% ç›®æ ‡çº¿', lineStyle: { color: 'green', type: 'dashed' } }] },
            itemStyle: { color: '#6f42c1' },
            label: { show: true, position: 'top', formatter: '{c}%' }
        }]
    };
    myChart.setOption(option);
    echartsInstances[elemId] = myChart;
}

/* è¾…åŠ©å‡½æ•°ï¼šæ™ºèƒ½åˆ†é…ç®—æ³• (ä¿æŒä¸å˜ï¼Œæˆ–ç›´æ¥å¼•ç”¨ä¹‹å‰çš„) */
function calculateSmartAllocation(student, targetTotal, allStudents, stats) {
    // ... (è¿™é‡Œä½¿ç”¨æ‚¨ä¹‹å‰å·²æœ‰çš„ calculateSmartAllocation ä»£ç ï¼Œæ— éœ€æ›´æ”¹) ...
    // ä¸ºäº†ä»£ç å®Œæ•´æ€§ï¼Œå¦‚æœæ‚¨æ²¡æœ‰ä¿ç•™ä¹‹å‰çš„ä»£ç ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘å†è´´ä¸€éã€‚
    // ç®€å•èµ·è§ï¼Œè¿™é‡Œå‡è®¾å®ƒå·²å­˜åœ¨äº script.js ä¸­ã€‚

    // ä»¥ä¸‹æ˜¯ç®€åŒ–çš„å¤ç”¨é€»è¾‘ï¼Œç¡®ä¿ä»£ç èƒ½è·‘ï¼š
    const currentTotal = student.totalScore;
    const totalDeficit = targetTotal - currentTotal;
    const details = [];
    let totalWeight = 0;
    const items = [];

    G_DynamicSubjectList.forEach(subject => {
        const confFull = G_SubjectConfigs[subject] ? G_SubjectConfigs[subject].full : 100;
        const cur = student.scores[subject] || 0;
        const room = Math.max(0, confFull - cur);
        const weight = room; // ç®€åŒ–æƒé‡
        items.push({ subject, cur, room, weight });
        totalWeight += weight;
    });

    items.forEach(item => {
        let gain = 0;
        if (totalDeficit > 0 && totalWeight > 0) gain = (item.weight / totalWeight) * totalDeficit;
        if (gain > item.room) gain = item.room;

        details.push({
            subject: item.subject,
            current: item.cur,
            target: item.cur + gain,
            gain: gain,
            difficultyText: gain > 10 ? "é‡ç‚¹çªç ´" : "ç¨³æ­¥æå‡"
        });
    });

    return { totalDeficit, details };
}

/**
 * [æ ¸å¿ƒç®—æ³•] æ™ºèƒ½åˆ†é…æåˆ†é¢åº¦
 * é€»è¾‘ï¼š
 * 1. æ€»ç¼ºå£ = ç›®æ ‡åˆ† - å½“å‰åˆ†
 * 2. è®¡ç®—æ¯ç§‘çš„â€œæåˆ†æ½œåŠ›æƒé‡â€ (Weight):
 * - å› å­ A (ç©ºé—´): æ»¡åˆ† (æˆ–å¹´çº§æœ€é«˜åˆ†) - å­¦ç”Ÿå½“å‰åˆ†ã€‚ ç©ºé—´è¶Šå¤§ï¼Œæƒé‡è¶Šå¤§ã€‚
 * - å› å­ B (éš¾åº¦): éš¾åº¦ç³»æ•° (Average / Full)ã€‚ è¶Šç®€å•(ç³»æ•°å¤§)ï¼Œé€šå¸¸è¶Šå®¹æ˜“æåˆ†ï¼Ÿ
 * æˆ–è€…åè¿‡æ¥ï¼šæ ‡å‡†å·®è¶Šå¤§ï¼Œè¯´æ˜è¶Šå®¹æ˜“æ‹‰å¼€åˆ†å·®ã€‚
 * è¿™é‡Œé‡‡ç”¨ï¼šæƒé‡ = (å¹´çº§æœ€é«˜åˆ† - ä¸ªäººåˆ†) * (è¯¥ç§‘æ ‡å‡†å·® / æ»¡åˆ†)
 * (è§£é‡Šï¼šä¸ä»…è¦çœ‹è¿˜æœ‰å¤šå°‘åˆ†æ²¡æ‹¿ï¼Œè¿˜è¦çœ‹è¿™ä¸ªç§‘ç›®å¤§å®¶çš„åˆ†æ•°æ˜¯å¦æ‹‰å¾—å¾ˆå¼€ã€‚å¦‚æœæ ‡å‡†å·®å¤§ï¼Œè¯´æ˜åŠªåŠ›ä¸€ä¸‹å®¹æ˜“å˜åŠ¨)
 */
function calculateSmartAllocation(student, targetTotal, allStudents, stats) {
    const currentTotal = student.totalScore;
    const totalDeficit = targetTotal - currentTotal;

    const result = {
        details: [],
        totalDeficit: totalDeficit
    };

    if (totalDeficit <= 0) return result; // å·²ç»è¾¾åˆ°ç›®æ ‡

    let totalWeight = 0;
    const subjectWeights = [];

    G_DynamicSubjectList.forEach(subject => {
        const sStat = stats[subject];
        const currentScore = student.scores[subject] || 0;

        // 1. ç¡®å®šè¯¥ç§‘ç›®çš„â€œå¤©èŠ±æ¿â€ (ä½¿ç”¨å¹´çº§æœ€é«˜åˆ†æ¯”è¾ƒåˆç†ï¼Œæˆ–è€…æ»¡åˆ†)
        // ä½¿ç”¨é…ç½®çš„æ»¡åˆ†æ›´ç¨³å¦¥ï¼Œæˆ–è€…å–ä¸¤è€…è¾ƒå°å€¼é˜²æ­¢å¼‚å¸¸æ•°æ®
        const configFull = G_SubjectConfigs[subject] ? G_SubjectConfigs[subject].full : 100;
        const maxScore = sStat ? sStat.max : configFull;
        const ceiling = Math.min(configFull, maxScore);

        // 2. è®¡ç®—æå‡ç©ºé—´ (Room to Grow)
        let room = ceiling - currentScore;
        if (room < 0) room = 0;

        // 3. è®¡ç®—æƒé‡ (Heuristic)
        // æƒé‡ = ç©ºé—´ * (1 + éš¾åº¦ç³»æ•°). è¶Šç®€å•çš„ç§‘ç›®(éš¾åº¦ç³»æ•°é«˜)ï¼Œåœ¨æœ‰ç©ºé—´çš„æƒ…å†µä¸‹ï¼Œè¶Šå¥½æ‹¿åˆ†ã€‚
        // æˆ–è€…ï¼šæƒé‡ = ç©ºé—´ * å½’ä¸€åŒ–çš„æ ‡å‡†å·®ã€‚
        // è¿™é‡Œç”¨ç®€å•æ¨¡å‹ï¼šç©ºé—´ * (è¯¥ç§‘å¹³å‡åˆ†/æ»¡åˆ†)ã€‚ å¹³å‡åˆ†é«˜è¯´æ˜é¢˜ç›®ç›¸å¯¹å®¹æ˜“ï¼Œè¡¥åˆ†å®¹æ˜“ã€‚
        const difficulty = sStat ? (sStat.average / configFull) : 0.6;
        const weight = room * difficulty; // ç®€å•ç²—æš´ä½†æœ‰æ•ˆ

        if (weight > 0) {
            subjectWeights.push({ subject, weight, room, currentScore, ceiling });
            totalWeight += weight;
        } else {
            subjectWeights.push({ subject, weight: 0, room, currentScore, ceiling });
        }
    });

    // 4. åˆ†é…åˆ†æ•°
    subjectWeights.forEach(item => {
        let suggestedGain = 0;
        if (totalWeight > 0) {
            suggestedGain = (item.weight / totalWeight) * totalDeficit;
        }

        // 5. ä¿®æ­£è¾¹ç•Œï¼šä¸èƒ½è¶…è¿‡ç©ºé—´ (è™½ç„¶æƒé‡é€»è¾‘å·²è€ƒè™‘ï¼Œä½†æŒ‰æ¯”ä¾‹åˆ†é…å¯èƒ½æº¢å‡º)
        if (suggestedGain > item.room) suggestedGain = item.room;

        result.details.push({
            subject: item.subject,
            current: item.currentScore,
            target: item.currentScore + suggestedGain,
            gain: suggestedGain,
            room: item.room,
            difficultyText: getDifficultyText(item.room, item.currentScore, item.ceiling) // è·å–è¯„è¯­
        });
    });

    return result;
}

// è¾…åŠ©ï¼šç”Ÿæˆç®€å•çš„è¯„è¯­
function getDifficultyText(room, current, ceiling) {
    const ratio = current / ceiling;
    if (ratio > 0.90) return "ä¿æŒä¼˜åŠ¿ (å†²æ»¡åˆ†)";
    if (ratio > 0.80) return "é‡ç‚¹çªç ´ (å†²ä¼˜ç§€)";
    if (ratio < 0.60) return "åŸºç¡€è¡¥å¼º (æŠ“åŠæ ¼)";
    return "ç¨³æ­¥æå‡";
}

/**
 * [æ¸²æŸ“] å±•ç¤ºè§„åˆ’ç»“æœ
 */
function renderGoalResults(student, targetRank, targetScore, strategy) {
    const container = document.getElementById('goal-result-container');
    container.style.display = 'block';

    const gap = strategy.totalDeficit;
    const gapClass = gap > 0 ? 'regress' : 'progress'; // gap>0 æ„å‘³ç€è¿˜å·®åˆ†(çº¢è‰²)ï¼Œgap<=0 æ„å‘³ç€å·²è¾¾æˆ(ç»¿è‰²)
    const gapText = gap > 0 ? `è¿˜éœ€æå‡ ${gap.toFixed(1)} åˆ†` : `å·²è¶…è¶Šç›®æ ‡ ${Math.abs(gap).toFixed(1)} åˆ†`;

    // 1. KPI
    document.getElementById('goal-kpi-cards').innerHTML = `
        <div class="kpi-card" style="border-left-color: #666;"><h3>å½“å‰æ€»åˆ† / æ’å</h3><div class="value">${student.totalScore} <span style="font-size:0.5em">(${student.gradeRank}å)</span></div></div>
        <div class="kpi-card" style="border-left-color: var(--color-purple);"><h3>ç›®æ ‡æ€»åˆ† / æ’å</h3><div class="value">${targetScore.toFixed(1)} <span style="font-size:0.5em">(${targetRank}å)</span></div></div>
        <div class="kpi-card" style="border-left-color: ${gap > 0 ? '#dc3545' : '#28a745'};"><h3>å·®è·åˆ†æ</h3><div class="value" style="font-size:1.5em; color:${gap > 0 ? '#dc3545' : '#28a745'}">${gapText}</div></div>
    `;

    if (gap <= 0) {
        document.getElementById('goal-strategy-table').innerHTML = `<p style="padding:20px; text-align:center; color:#28a745; font-weight:bold;">ğŸ‰ æ­å–œï¼å½“å‰æˆç»©å·²è¾¾æˆè®¾å®šç›®æ ‡ã€‚</p>`;
        return;
    }

    // 2. ç­–ç•¥è¡¨
    // æŒ‰å»ºè®®æåˆ†å€¼é™åºæ’åˆ— (ä¼˜å…ˆå±•ç¤ºé‡ç‚¹æ‹¿åˆ†ç§‘ç›®)
    const sortedDetails = [...strategy.details].sort((a, b) => b.gain - a.gain);

    document.getElementById('goal-strategy-table').innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>ç§‘ç›®</th>
                    <th>å½“å‰åˆ†æ•°</th>
                    <th style="color:var(--color-purple);">å»ºè®®æåˆ† (+)</th>
                    <th>ç›®æ ‡åˆ†æ•°</th>
                    <th>æåˆ†éš¾åº¦/ç­–ç•¥</th>
                    <th>æå‡ç©ºé—´ä½™é‡</th>
                </tr>
            </thead>
            <tbody>
                ${sortedDetails.map(d => `
                    <tr>
                        <td><strong>${d.subject}</strong></td>
                        <td>${d.current}</td>
                        <td style="color:var(--color-purple); font-weight:bold; background-color:#f3e5f5;">+${d.gain.toFixed(1)}</td>
                        <td><strong>${d.target.toFixed(1)}</strong></td>
                        <td>${d.difficultyText}</td>
                        <td style="color:#999; font-size:0.9em;">${(d.room - d.gain).toFixed(1)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    // 3. ç€‘å¸ƒå›¾ (ECharts)
    renderGoalWaterfall('goal-waterfall-chart', student.totalScore, targetScore, sortedDetails);

    // 4. é›·è¾¾å›¾ (ECharts)
    renderGoalRadar('goal-radar-chart', student, strategy.details);
}

/**
 * [å›¾è¡¨] æåˆ†è·¯å¾„ç€‘å¸ƒå›¾
 */
function renderGoalWaterfall(elementId, currentTotal, targetTotal, details) {
    const dom = document.getElementById(elementId);
    const myChart = echarts.init(dom);

    // è¿‡æ»¤æ‰æåˆ†ä¸º0çš„ç§‘ç›®ï¼Œé¿å…å›¾è¡¨å¤ªé•¿
    const validDetails = details.filter(d => d.gain > 0.1);

    const xData = ['å½“å‰æ€»åˆ†', ...validDetails.map(d => d.subject), 'ç›®æ ‡æ€»åˆ†'];

    // è¾…åŠ©æ•°æ®æ„å»º
    // ç€‘å¸ƒå›¾åŸç†ï¼šé€æ˜æŸ±å­å«åº•
    let currentStack = currentTotal;
    const placeholders = [0]; // ç¬¬ä¸€æ ¹æŸ±å­èµ·ç‚¹0
    const values = [currentTotal]; // ç¬¬ä¸€æ ¹æŸ±å­é«˜åº¦

    validDetails.forEach(d => {
        placeholders.push(currentStack); // å«é«˜
        values.push(parseFloat(d.gain.toFixed(1))); //   é‡
        currentStack += d.gain;
    });

    // æœ€åä¸€æ ¹æŸ±å­ (ç›®æ ‡)
    placeholders.push(0);
    values.push(parseFloat(targetTotal.toFixed(1)));

    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: function (params) {
                let tar = params[1]; // å®é™…æ˜¾ç¤ºçš„æŸ±å­
                return `${tar.name}<br/>${tar.seriesName} : ${tar.value}`;
            }
        },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: {
            type: 'category',
            splitLine: { show: false },
            data: xData
        },
        yAxis: {
            type: 'value',
            min: Math.floor(currentTotal * 0.9) // Yè½´ä¸ä»0å¼€å§‹ï¼Œæ˜¾ç¤ºå·®å¼‚æ›´æ˜æ˜¾
        },
        series: [
            {
                name: 'è¾…åŠ©',
                type: 'bar',
                stack: 'æ€»é‡',
                itemStyle: {
                    barBorderColor: 'rgba(0,0,0,0)',
                    color: 'rgba(0,0,0,0)'
                },
                emphasis: {
                    itemStyle: {
                        barBorderColor: 'rgba(0,0,0,0)',
                        color: 'rgba(0,0,0,0)'
                    }
                },
                data: placeholders
            },
            {
                name: 'åˆ†æ•°',
                type: 'bar',
                stack: 'æ€»é‡',
                label: {
                    show: true,
                    position: 'top'
                },
                data: values.map((val, idx) => {
                    // ç¬¬ä¸€åˆ—å’Œæœ€åä¸€åˆ—é¢œè‰²ä¸åŒ
                    if (idx === 0) return { value: val, itemStyle: { color: '#6c757d' } };
                    if (idx === values.length - 1) return { value: val, itemStyle: { color: '#28a745' } };
                    return { value: val, itemStyle: { color: '#6f42c1' } }; //   é‡éƒ¨åˆ†ç´«è‰²
                })
            }
        ]
    };
    myChart.setOption(option);
    // æ³¨å†Œ resize
    echartsInstances[elementId] = myChart;
}

/**
 * [å›¾è¡¨] ç°çŠ¶ vs ç›®æ ‡ é›·è¾¾å›¾
 */
function renderGoalRadar(elementId, student, details) {
    const dom = document.getElementById(elementId);
    const myChart = echarts.init(dom);

    const indicators = [];
    const currentData = [];
    const targetData = [];

    // å°† details è½¬ä¸º map æ–¹ä¾¿æŸ¥æ‰¾
    const detailMap = {};
    details.forEach(d => detailMap[d.subject] = d);

    G_DynamicSubjectList.forEach(subject => {
        const config = G_SubjectConfigs[subject] || { full: 100 };
        indicators.push({ name: subject, max: config.full });

        currentData.push(student.scores[subject] || 0);

        const d = detailMap[subject];
        targetData.push(d ? parseFloat(d.target.toFixed(1)) : (student.scores[subject] || 0));
    });

    const option = {
        tooltip: {},
        legend: { data: ['å½“å‰æˆç»©', 'è§„åˆ’ç›®æ ‡'], bottom: 0 },
        radar: {
            indicator: indicators,
            radius: '65%'
        },
        series: [{
            name: 'å½“å‰ vs ç›®æ ‡',
            type: 'radar',
            data: [
                {
                    value: currentData,
                    name: 'å½“å‰æˆç»©',
                    itemStyle: { color: '#6c757d' },
                    areaStyle: { opacity: 0.2 }
                },
                {
                    value: targetData,
                    name: 'è§„åˆ’ç›®æ ‡',
                    itemStyle: { color: '#6f42c1' }, // ç´«è‰²ä»£è¡¨ç›®æ ‡
                    lineStyle: { type: 'dashed' },
                    areaStyle: { opacity: 0.1, color: '#6f42c1' }
                }
            ]
        }]
    };
    myChart.setOption(option);
    echartsInstances[elementId] = myChart;
}


/**
 *    æ‰“å°ç›®æ ‡è§„åˆ’ä¹¦
 * 1. ä¿®å¤æ–‡ä»¶åæ˜¾ç¤º (ä» IndexedDB è¯»å–)
 * 2. ä¿®å¤ NaN é—®é¢˜ (æ­£ç¡®è¯»å– totalDeficit)
 */
async function startGoalPrintJob(student, targetScore, targetRank, strategy) {
    // 1. [ä¿®å¤] å¼‚æ­¥è·å–æ­£ç¡®çš„æ–‡ä»¶å
    let examName = await localforage.getItem('G_MainFileName');
    if (!examName) examName = localStorage.getItem('G_MainFileName') || 'æœ¬æ¬¡è€ƒè¯•';

    // 2. æ’åºç­–ç•¥æ•°æ®
    const sortedDetails = [...strategy.details].sort((a, b) => b.gain - a.gain);

    // 3. [ä¿®å¤] è®¡ç®—æ€»ç¼ºå£æè¿° (é˜²æ­¢ NaN)
    // å¦‚æœ totalDeficit æœªå®šä¹‰ï¼Œåˆ™é‡  è®¡ç®—ï¼šç›®æ ‡ - å½“å‰
    let gap = strategy.totalDeficit;
    if (gap === undefined || gap === null) {
        const currentTotal = (strategy.mode === 'single') ? (student.scores[strategy.subject] || 0) : student.totalScore;
        gap = targetScore - currentTotal;
    }

    const gapHtml = gap > 0.1 // ä½¿ç”¨ 0.1 å®¹é”™
        ? `<span style="color:#dc3545; font-weight:bold;">è¿˜éœ€æå‡ ${gap.toFixed(1)} åˆ†</span>`
        : `<span style="color:#28a745; font-weight:bold;">å½“å‰å·²è¾¾æˆç›®æ ‡ (æº¢å‡º ${Math.abs(gap).toFixed(1)} åˆ†)</span>`;

    // 4. æ„å»ºæ‰“å° HTML (ä¿æŒåŸæœ‰æ ·å¼)
    const printHtml = `
    <html>
    <head>
        <title>å­¦ä¸šç›®æ ‡è§„åˆ’ä¹¦ - ${student.name}</title>
        <style>
            body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; padding: 30px; color: #333; line-height: 1.5; }
            .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; }
            .header h1 { margin: 0; font-size: 24px; letter-spacing: 2px; }
            .header p { margin: 5px 0 0; color: #666; font-size: 14px; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
            .info-item { display: flex; flex-direction: column; }
            .info-label { font-size: 12px; color: #666; margin-bottom: 4px; }
            .info-value { font-size: 18px; font-weight: bold; color: #333; }
            .highlight { color: #6f42c1; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
            th, td { border: 1px solid #999; padding: 10px; text-align: center; font-size: 14px; }
            th { background-color: #f0f0f0; font-weight: bold; color: #333; }
            tr:nth-child(even) { background-color: #fcfcfc; }
            .gain-cell { background-color: #f3e5f5; font-weight: bold; color: #6f42c1; font-size: 16px; }
            .footer-signatures { margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .sign-box { width: 30%; border-top: 1px solid #333; padding-top: 10px; text-align: center; }
            .sign-label { display: block; margin-bottom: 40px; font-weight: bold; }
            .motto { text-align: center; font-style: italic; color: #666; margin-top: 40px; font-size: 14px; }
            @media print {
                @page { size: A4 portrait; margin: 1.5cm; }
                body { -webkit-print-color-adjust: exact; }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>ğŸ¯ ä¸ªäººå­¦ä¸šç›®æ ‡è§„åˆ’ä¹¦</h1>
            <p>æ•°æ®æ¥æºï¼š${examName} | ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleDateString()}</p>
        </div>

        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">å­¦ç”Ÿå§“å / è€ƒå·</span>
                <span class="info-value">${student.name} <span style="font-size:0.8em; font-weight:normal;">(${student.id})</span></span>
            </div>
            <div class="info-item">
                <span class="info-label">å½“å‰ç­çº§</span>
                <span class="info-value">${student.class}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å½“å‰æ€»åˆ† / å¹´æ’</span>
                <span class="info-value">${student.totalScore} åˆ† / ${student.gradeRank} å</span>
            </div>
            <div class="info-item">
                <span class="info-label">ğŸ¯ ç›®æ ‡è®¾å®š</span>
                <span class="info-value highlight">${targetScore.toFixed(0)} åˆ† / ${targetRank === '-' ? '-' : 'å‰ ' + targetRank} å</span>
            </div>
        </div>

        <div style="text-align: center; margin-bottom: 20px; font-size: 16px;">
            å·®è·åˆ†æï¼š${gapHtml}
        </div>

        <h3>ğŸ“Š æ™ºèƒ½æåˆ†ç­–ç•¥æ‹†è§£</h3>
        <table>
            <thead>
                <tr>
                    <th>å­¦ç§‘</th>
                    <th>å½“å‰åˆ†æ•°</th>
                    <th>ç›®æ ‡  é‡ (+)</th>
                    <th>ç›®æ ‡åˆ†æ•°</th>
                    <th>æåˆ†ç­–ç•¥å»ºè®®</th>
                    <th>å‰©ä½™ç©ºé—´</th>
                </tr>
            </thead>
            <tbody>
                ${sortedDetails.map(d => `
                    <tr>
                        <td style="font-weight:bold;">${d.subject}</td>
                        <td>${d.current}</td>
                        <td class="gain-cell">+${d.gain.toFixed(1)}</td>
                        <td><strong>${d.target.toFixed(1)}</strong></td>
                        <td style="text-align:left; padding-left:15px;">${d.difficultyText}</td>
                        <td style="color:#888;">${(d.room - d.gain).toFixed(1)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>

        <p style="font-size:13px; color:#666;">* <strong>è®¡ç®—é€»è¾‘ï¼š</strong>ç³»ç»Ÿä¾æ®å„ç§‘å½“å‰åˆ†æ•°ã€å¹´çº§æ»¡åˆ†ç©ºé—´åŠå­¦ç§‘éš¾åº¦ç³»æ•°ï¼Œè‡ªåŠ¨å°†æ€»ç›®æ ‡åˆ†åˆç†åˆ†é…è‡³å„å­¦ç§‘ã€‚</p>

        <div class="footer-signatures">
            <div class="sign-box"><span class="sign-label">å­¦ç”Ÿæ‰¿è¯º</span>(ç­¾å­—)</div>
            <div class="sign-box"><span class="sign-label">å®¶é•¿çŸ¥æƒ…</span>(ç­¾å­—)</div>
            <div class="sign-box"><span class="sign-label">ç­ä¸»ä»»/å¯¼å¸ˆ</span>(ç­¾å­—)</div>
        </div>

        <div class="motto">"ç›®æ ‡ä¸æ˜¯ä¸ºäº†é¢„æµ‹æœªæ¥ï¼Œè€Œæ˜¯ä¸ºäº†æŒ‡å¯¼ä»Šå¤©çš„è¡ŒåŠ¨ã€‚"</div>

    </body>
    </html>
    `;

    const win = window.open('', '_blank');
    win.document.write(printHtml);
    win.document.close();

    setTimeout(() => {
        win.focus();
        win.print();
    }, 500);
}


/**
 *    æ‰“å°è§„åˆ’è¯¦æƒ…å• (å«æ¥æºä¿¡æ¯)
 */
function startDetailPrintJob(plan, actualStudent, baseTotal, actualTotal, baseName, outName) {
    const st = plan.strategy;
    const isCompare = !!actualStudent;

    // 1. æ„å»ºè¡¨æ ¼è¡Œ
    const rows = st.details.map(d => {
        let compareCells = '';
        if (isCompare) {
            const act = actualStudent.scores[d.subject] || 0;
            const diff = act - d.target;
            const color = diff >= 0 ? 'green' : 'red';
            const icon = diff >= 0 ? 'âœ…' : 'âŒ';
            compareCells = `
                <td style="background-color:#fff8e1; font-weight:bold;">${act}</td>
                <td style="background-color:#fff8e1; color:${color};">${icon} ${diff > 0 ? '+' : ''}${diff.toFixed(1)}</td>
            `;
        }

        return `
            <tr>
                <td>${d.subject}</td>
                <td>${d.current}</td>
                <td style="font-weight:bold;">${d.target.toFixed(1)}</td>
                <td>+${d.gain.toFixed(1)}</td>
                ${compareCells}
                <td style="text-align:left; padding-left:10px;">${d.difficultyText}</td>
            </tr>
        `;
    }).join('');

    // 2. æ„å»ºæ€»ç»“ HTML
    let summaryHtml = `
        <div class="info-box">
            <span>åŸºå‡†æ€»åˆ†: <strong>${baseTotal.toFixed(1)}</strong></span>
            <span>ç›®æ ‡æ€»åˆ†: <strong style="color:#6f42c1;">${st.targetScoreCalculated.toFixed(1)}</strong></span>
            <span>è®¡åˆ’æå‡: <strong>+${(st.targetScoreCalculated - baseTotal).toFixed(1)}</strong></span>
        </div>
    `;

    if (isCompare) {
        const diffTotal = actualTotal - st.targetScoreCalculated;
        const statusText = diffTotal >= 0 ? 'ğŸ‰ è¾¾æˆç›®æ ‡' : 'âš ï¸ æœªè¾¾æˆ';
        const statusColor = diffTotal >= 0 ? 'green' : 'red';
        summaryHtml += `
            <div class="info-box" style="border-color: #fd7e14; background-color: #fffbf0; margin-top:10px;">
                <span>å®é™…æ€»åˆ†: <strong style="font-size:1.2em; color:#fd7e14;">${actualTotal}</strong></span>
                <span style="color:${statusColor}; font-weight:bold;">${statusText} (${diffTotal > 0 ? '+' : ''}${diffTotal.toFixed(1)})</span>
            </div>
        `;
    }

    //    æ¥æºä¿¡æ¯è¡Œ
    const sourceHtml = `
        <div class="source-line">
            <span>ğŸ“‹ è§„åˆ’åŸºå‡†ï¼š${baseName}</span>
            ${outName ? ` | <span>ğŸ“ˆ å¤ç›˜ä¾æ®ï¼š${outName}</span>` : ''}
        </div>
    `;

    // 3. å®Œæ•´ HTML
    const html = `
    <html>
    <head>
        <title>è§„åˆ’è¯¦æƒ… - ${plan.studentName}</title>
        <style>
            body { font-family: "Segoe UI", sans-serif; padding: 2cm; color: #333; }
            h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 5px; }
            .meta { text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9em; }
            .source-line { text-align: center; font-size: 0.85em; color: #555; background: #eee; padding: 5px; border-radius: 4px; margin-bottom: 25px; }
            
            .info-box { 
                display: flex; justify-content: space-around; padding: 15px; 
                background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; 
            }
            
            table { width: 100%; border-collapse: collapse; margin-top: 30px; }
            th, td { border: 1px solid #ccc; padding: 10px; text-align: center; font-size: 0.95em; }
            th { background-color: #f0f0f0; }
            
            @media print {
                @page { size: A4 portrait; }
                body { -webkit-print-color-adjust: exact; }
            }
        </style>
    </head>
    <body>
        <h2>ğŸ¯ ä¸ªäººå­¦ä¸šè§„åˆ’è¯¦æƒ…å•</h2>
        <div class="meta">
            å­¦ç”Ÿï¼š<strong>${plan.studentName}</strong> | 
            è§„åˆ’åç§°ï¼š${plan.name} | 
            åˆ›å»ºæ—¶é—´ï¼š${plan.createDate}
        </div>

        ${sourceHtml}

        ${summaryHtml}

        <h3>ğŸ“š ç§‘ç›®è¯¦æƒ…åˆ†è§£</h3>
        <table>
            <thead>
                <tr>
                    <th>ç§‘ç›®</th><th>åŸºå‡†åˆ†</th><th>ç›®æ ‡åˆ†</th><th>è®¡åˆ’  é‡</th>
                    ${isCompare ? '<th>å®é™…åˆ†</th><th>è¾¾æˆå·®å€¼</th>' : ''}
                    <th>ç­–ç•¥å»ºè®®</th>
                </tr>
            </thead>
            <tbody>
                ${rows}
            </tbody>
        </table>
        
        <div style="margin-top: 40px; text-align: center; color: #999; font-size: 0.8em;">
            * æŠ¥è¡¨ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}
        </div>
    </body>
    </html>
    `;

    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
    setTimeout(() => { win.focus(); win.print(); }, 500);
}

/**
 *    13.20 ç»˜åˆ¶çŸ¥è¯†ç‚¹å½’å› å›¾è°±
 */
function drawItemKnowledgeGraph() {
    const chartDom = document.getElementById('item-chart-knowledge-graph');
    if (!chartDom) return;

    if (echartsInstances['item-chart-knowledge-graph']) {
        echartsInstances['item-chart-knowledge-graph'].dispose();
    }
    const myChart = echarts.init(chartDom);
    echartsInstances['item-chart-knowledge-graph'] = myChart;

    // 1. è·å–é…ç½®ä¸æ•°æ®
    const subjectName = document.getElementById('item-subject-select').value;
    const selectedClass = document.getElementById('item-class-filter').value;

    if (!G_ItemAnalysisData || !G_ItemAnalysisData[subjectName]) return;
    const subjectConfig = G_ItemAnalysisConfig[subjectName] || {};
    const graphDef = subjectConfig['_knowledge_graph_def_'];

    // 2. è§£æç”¨æˆ·å®šä¹‰çš„ä¾èµ–å…³ç³»
    const edges = [];
    const nodesSet = new Set();

    if (graphDef) {
        const lines = graphDef.split('\n');
        lines.forEach(line => {
            if (line.includes('->')) {
                // 1. æŒ‰ç®­å¤´åˆ†å‰²å¹¶å»é™¤ç©ºç™½
                const parts = line.split('->').map(s => s.trim()).filter(s => s);

                // 2. å¾ªç¯åˆ›å»ºé“¾å¼å…³ç³» (A->B, B->C, C->D...)
                for (let i = 0; i < parts.length - 1; i++) {
                    const source = parts[i];
                    const target = parts[i + 1];

                    // é˜²æ­¢é‡å¤æ·»åŠ ç›¸åŒçš„è¾¹ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
                    // ä½† ECharts Graph å…è®¸é‡è¾¹ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ç›´æ¥æ¨å…¥å³å¯
                    edges.push({ source, target });
                    nodesSet.add(source);
                    nodesSet.add(target);
                }
            }
        });
    }

    // 3. è®¡ç®—å½“å‰ç­›é€‰ç¾¤ä½“çš„çŸ¥è¯†ç‚¹å¾—åˆ†ç‡
    // (å¤ç”¨ç°æœ‰é€»è¾‘ï¼Œä½†é’ˆå¯¹ç‰¹å®šç¾¤ä½“)
    const allStudents = G_ItemAnalysisData[subjectName].students;
    const filteredStudents = (selectedClass === 'ALL')
        ? allStudents
        : allStudents.filter(s => s.class === selectedClass);

    // è®¡ç®—å¾—åˆ†ç‡ Map: { "äºŒæ¬¡å‡½æ•°": 0.65, ... }
    const kpRates = {};

    // è·å–æ‰€æœ‰æ¶‰åŠçš„çŸ¥è¯†ç‚¹ï¼ˆåŒ…æ‹¬é…ç½®ä¸­æœªå®šä¹‰ä½†åœ¨é¢˜ç›®ä¸­å‡ºç°çš„ï¼‰
    const recalculatedStats = getRecalculatedItemStats(subjectName);
    // éå†æ‰€æœ‰é¢˜ç›®ç´¯åŠ åˆ†æ•°
    const aggregates = {};

    const processQ = (qList, scoreType, statsType) => {
        qList.forEach(qName => {
            const content = subjectConfig[qName]?.content || "";
            const kps = content.split(/[;ï¼›]/).map(k => k.trim()).filter(k => k);
            const stat = recalculatedStats[statsType][qName];
            const full = stat?.manualFullScore || stat?.maxScore || 0;

            if (full > 0 && kps.length > 0) {
                let totalGot = 0;
                let count = 0;
                filteredStudents.forEach(s => {
                    const v = s[scoreType][qName];
                    if (typeof v === 'number') { totalGot += v; count++; }
                });
                const avgScore = count > 0 ? totalGot / count : 0;

                kps.forEach(kp => {
                    if (!aggregates[kp]) aggregates[kp] = { got: 0, full: 0 };
                    aggregates[kp].got += avgScore;
                    aggregates[kp].full += full;
                    nodesSet.add(kp); // ç¡®ä¿å›¾è°±åŒ…å«æ‰€æœ‰å‡ºç°çš„çŸ¥è¯†ç‚¹
                });
            }
        });
    };

    processQ(G_ItemAnalysisData[subjectName].minorQuestions, 'minorScores', 'minorStats');
    processQ(G_ItemAnalysisData[subjectName].majorQuestions, 'majorScores', 'majorStats');

    // ç”Ÿæˆæœ€ç»ˆå¾—åˆ†ç‡
    Object.keys(aggregates).forEach(kp => {
        const agg = aggregates[kp];
        kpRates[kp] = agg.full > 0 ? (agg.got / agg.full) : 0;
    });

    if (nodesSet.size === 0) {
        chartDom.innerHTML = `<p style="text-align:center; padding-top:100px; color:#999;">æš‚æ— çŸ¥è¯†ç‚¹æ•°æ®ï¼Œè¯·åœ¨â€œé…ç½®é¢˜ç›®â€ä¸­å¡«å†™è€ƒå¯Ÿå†…å®¹å’Œå±‚çº§å…³ç³»ã€‚</p>`;
        return;
    }

    // 4. æ„å»º ECharts Nodes
    const echartsNodes = Array.from(nodesSet).map(kp => {
        const rate = kpRates[kp] !== undefined ? kpRates[kp] : 0; // é»˜è®¤0æˆ–è€…ä¸æ˜¾ç¤º

        // é¢œè‰²é€»è¾‘
        let color = '#007bff'; // é»˜è®¤è“
        if (rate >= 0.85) color = '#28a745'; // ä¼˜ (ç»¿)
        else if (rate < 0.6) color = '#dc3545'; // å·® (çº¢)
        else color = '#ffc107'; // ä¸­ (é»„)

        return {
            name: kp,
            value: (rate * 100).toFixed(1), // æ˜¾ç¤ºä¸ºç™¾åˆ†æ¯”
            itemStyle: { color: color },
            label: { show: true, color: '#333', position: 'right' },
            symbolSize: 20 + (rate * 10) // åˆ†æ•°è¶Šé«˜ç‚¹è¶Šå¤§? æˆ–è€…åè¿‡æ¥ï¼Œè–„å¼±ç‚¹å¤§? è¿™é‡Œéšåˆ†æ•°å˜å¤§
        };
    });

    // 5. æ„å»º ECharts Links (å½’å› é“¾é€»è¾‘)
    const echartsLinks = edges.map(edge => {
        const sourceRate = kpRates[edge.source] || 1;
        const targetRate = kpRates[edge.target] || 1;

        // å½’å› é€»è¾‘ï¼šå¦‚æœçˆ¶å­åŒåŒæŒ‚ç§‘ (<0.6)ï¼Œåˆ™ä¸ºâ€œæ ¸å¿ƒå½’å› é“¾â€
        const isCritical = (sourceRate < 0.6 && targetRate < 0.6);

        return {
            source: edge.source,
            target: edge.target,
            lineStyle: {
                color: isCritical ? '#dc3545' : '#ccc', // çº¢è‰²æˆ–ç°è‰²
                width: isCritical ? 4 : 1,              // åŠ ç²—
                type: isCritical ? 'solid' : 'solid',
                curveness: 0.2
            },
            symbol: ['none', 'arrow']
        };
    });

    // 6. æ¸²æŸ“å›¾è¡¨
    const option = {
        title: { text: 'çŸ¥è¯†ç‚¹å…³è”å›¾è°±', left: 'center' },
        tooltip: {
            formatter: (params) => {
                if (params.dataType === 'node') {
                    return `<strong>${params.name}</strong><br/>å¾—åˆ†ç‡: ${params.value}%`;
                }
                if (params.dataType === 'edge') {
                    return `${params.data.source} -> ${params.data.target}`;
                }
            }
        },
        series: [{
            type: 'graph',
            layout: 'force', // åŠ›å¼•å¯¼å¸ƒå±€
            data: echartsNodes,
            links: echartsLinks,
            roam: true,
            label: { show: true, position: 'bottom' },
            force: {
                repulsion: 500,
                edgeLength: 100
            },
            lineStyle: {
                opacity: 0.9,
                width: 2,
                curveness: 0
            }
        }]
    };

    myChart.setOption(option);
}


/**
 * [å‡çº§ç‰ˆ] 15. æ¸²æŸ“æ¨¡å—åäº”ï¼šè€ƒåœºç¼–æ’
 *     åŠŸèƒ½ï¼šæ”¯æŒâ€œç«–å‘å¡«å……â€æ¨¡å¼ (ç«–å‘Zå‹ / ç«–å‘Så‹)
 */
function renderExamArrangement(container) {
    const studentsSource = G_StudentsData;
    const studentCount = studentsSource.length;

    container.innerHTML = `
        <h2>ğŸ§˜ æ¨¡å—åäº”ï¼šè€ƒåœºåº§ä½ç¼–æ’ & è€ƒå·ç”Ÿæˆ</h2>
        
        <div class="main-card-wrapper" style="border-left: 5px solid var(--color-cyan); margin-bottom: 20px; padding-bottom: 30px;">
            <h4 style="margin-top:0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">ğŸ› ï¸ ç¼–æ’é…ç½®å‚æ•°</h4>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; align-items: end;">
                
                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">1. è€ƒç”Ÿæ’åºç­–ç•¥:</label>
                    <select id="exam-sort-strategy" class="sidebar-select" style="font-weight:bold; color:var(--primary-color); width:100%; padding: 10px;">
                        <option value="random">ğŸ² å®Œå…¨éšæœºæ‰“ä¹±</option>
                        <option value="class_balanced">âš–ï¸ ç­çº§å‡è¡¡ (åˆ†å±‚ç©¿æ’)</option>
                        <option value="score_desc">ğŸ† æŒ‰æ€»åˆ†é«˜åˆ°ä½ (ä¼˜ç”Ÿåœ¨å‰)</option>
                        <option value="score_asc">ğŸ“‰ æŒ‰æ€»åˆ†ä½åˆ°é«˜ (ä¼˜ç”Ÿåœ¨å)</option>
                        
                    </select>
                </div>

                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">2. å•åœºäººæ•° (Capacity):</label>
                    <input type="number" id="exam-room-capacity" class="sidebar-select" value="40" min="1" style="width:100%; padding: 10px;">
                </div>

                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">3. åº§ä½åˆ—æ•° (Columns):</label>
                    <input type="number" id="exam-room-columns" class="sidebar-select" value="5" min="1" style="width:100%; padding: 10px;">
                </div>

                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">4. åº§ä½å¡«å……æ¨¡å¼:</label>
                    <select id="exam-seat-pattern" class="sidebar-select" style="width:100%; padding: 10px; border: 2px solid var(--color-orange);">
                        <optgroup label="æ¨ªå‘å¡«å…… (å…ˆå·¦å³ï¼Œå†æ¢è¡Œ)">
                            <option value="z_shape">â¡ï¸ æ¨ªå‘ Z å‹ (ä»å·¦åˆ°å³)</option>
                            <option value="s_shape">ğŸ æ¨ªå‘ S å‹ (è›‡å½¢/å¼“å­—å½¢)</option>
                        </optgroup>
                        <optgroup label="ç«–å‘å¡«å…… (å…ˆå‰åï¼Œå†æ¢åˆ—)">
                            <option value="z_shape_v">â¬‡ï¸ ç«–å‘ Z å‹ (ä»å‰åˆ°å)</option>
                            <option value="s_shape_v">ğŸ§¬ ç«–å‘ S å‹ (ç¬¬1åˆ—å, ç¬¬2åˆ—å‰...)</option>
                        </optgroup>
                    </select>
                </div>

                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">5. è€ƒå·ç”Ÿæˆ:</label>
                    <select id="exam-id-mode" class="sidebar-select" style="width:100%; padding: 10px;">
                        <option value="use_existing">ä¿æŒç°æœ‰ (ExcelåŸæ•°æ®)</option>
                        <option value="auto_generate">è‡ªåŠ¨ç”Ÿæˆ (è€ƒåœº+åº§ä½)</option>
                    </select>
                </div>
                
                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#666;">å‰ç¼€ (å¯é€‰):</label>
                    <input type="text" id="exam-id-prefix" class="sidebar-select" placeholder="ä¾‹: 2025H1" style="width:100%; padding: 10px;">
                </div>

            </div>
            
            <div style="margin-top: 30px; text-align: right; border-top: 1px solid #eee; padding-top: 20px;">
                <span style="color: #666; margin-right: 20px; font-size: 1.1em;">å¾…ç¼–æ’å­¦ç”Ÿæ€»æ•°: <strong style="color: var(--primary-color); font-size: 1.2em;">${studentCount}</strong> äºº</span>
                <button id="exam-generate-btn" class="sidebar-button" style="background-color: var(--color-cyan); padding: 10px 25px; font-size: 1em;">âš™ï¸ å¼€å§‹ç¼–æ’ & é¢„è§ˆ</button>
            </div>
        </div>

        <div id="exam-result-area" style="display: none;">
            <div class="main-card-wrapper">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">ğŸ“‹ ç¼–æ’ç»“æœé¢„è§ˆ</h3>
                    <button id="exam-export-btn" class="sidebar-button" style="background-color: var(--color-green);">ğŸ“¥ å¯¼å‡ºåº§ä½è¡¨ (Excel)</button>
                </div>
                
                <div id="exam-room-tabs" style="display:flex; gap:5px; overflow-x:auto; padding-bottom:10px; margin-bottom:10px; border-bottom:1px solid #eee;"></div>
                <div id="exam-room-preview" style="min-height: 300px;"></div>
            </div>
        </div>
    `;

    let generatedRooms = [];

    const generateBtn = document.getElementById('exam-generate-btn');
    const exportBtn = document.getElementById('exam-export-btn');

    generateBtn.addEventListener('click', () => {
        // å®æ—¶è¯»å–æ‰€æœ‰é…ç½®
        const config = {
            sort: document.getElementById('exam-sort-strategy').value,
            capacity: parseInt(document.getElementById('exam-room-capacity').value) || 30,
            cols: parseInt(document.getElementById('exam-room-columns').value) || 8,
            pattern: document.getElementById('exam-seat-pattern').value,
            idMode: document.getElementById('exam-id-mode').value,
            idPrefix: document.getElementById('exam-id-prefix').value.trim()
        };

        console.log("å¼€å§‹ç¼–æ’ï¼Œé…ç½®:", config);

        generatedRooms = calculateExamArrangement(studentsSource, config);
        renderExamPreview(generatedRooms, config.cols);
    });

    exportBtn.addEventListener('click', () => {
        if (generatedRooms.length > 0) exportExamToExcel(generatedRooms);
        else alert("è¯·å…ˆç”Ÿæˆç¼–æ’æ–¹æ¡ˆï¼");
    });
}

/**
 * [æ ¸å¿ƒç®—æ³•] è®¡ç®—è€ƒåœºç¼–æ’ (æ”¯æŒæ¨ªå‘/ç«–å‘å¡«å……)
 */
function calculateExamArrangement(students, config) {
    let sortedStudents = [];

    // --- 1. æ’åºç­–ç•¥ ---
    if (config.sort === 'class_balanced') {
        const classMap = {};
        students.forEach(s => {
            if (!classMap[s.class]) classMap[s.class] = [];
            classMap[s.class].push(s);
        });
        const queues = [];
        Object.keys(classMap).sort().forEach(cls => {
            classMap[cls].sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
            queues.push(classMap[cls]);
        });
        let hasStudent = true;
        let i = 0;
        while (hasStudent) {
            hasStudent = false;
            for (let q of queues) {
                if (i < q.length) {
                    sortedStudents.push(q[i]);
                    hasStudent = true;
                }
            }
            i++;
        }
    } else if (config.sort === 'score_desc') {
        sortedStudents = [...students].sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
    } else if (config.sort === 'score_asc') {
        sortedStudents = [...students].sort((a, b) => (a.totalScore || 0) - (b.totalScore || 0));
    } else {
        sortedStudents = [...students].sort(() => Math.random() - 0.5);
    }

    // --- 2. è€ƒåœºåˆ‡åˆ† ---
    const rooms = [];
    const totalStudents = sortedStudents.length;
    let currentStudentIdx = 0;
    let roomNum = 1;

    // è®¡ç®—æ¯ä¸ªè€ƒåœºæœ€å¤§éœ€è¦å¤šå°‘è¡Œ (ç”¨äºç«–å‘å¡«å……)
    // ç«–å‘å¡«å……æ—¶ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¿™ä¸€åˆ—å¡«åˆ°ç¬¬å‡ è¡Œå°±è¯¥æ¢åˆ—äº†
    const maxRowsPerRoom = Math.ceil(config.capacity / config.cols);

    while (currentStudentIdx < totalStudents) {
        const endIdx = Math.min(currentStudentIdx + config.capacity, totalStudents);
        let roomStudents = sortedStudents.slice(currentStudentIdx, endIdx);

        if (config.sort !== 'random') {
            // roomStudents.sort(() => Math.random() - 0.5); // å¯é€‰ï¼šç»„å†…å†æ¬¡éšæœº
        }

        // --- 3. åæ ‡è®¡ç®— & è€ƒå·ç”Ÿæˆ ---
        const processedStudents = roomStudents.map((student, indexInRoom) => {
            const seatNo = indexInRoom + 1;

            // ç”Ÿæˆè€ƒå·
            let examId = student.id;
            if (config.idMode === 'auto_generate') {
                const rStr = String(roomNum).padStart(2, '0');
                const sStr = String(seatNo).padStart(2, '0');
                const prefix = config.idPrefix || "";
                examId = `${prefix}${rStr}${sStr}`;
            }

            let row = 0;
            let col = 0;

            // [å…³é”®ä¿®æ”¹] æ ¹æ®æ¨¡å¼è®¡ç®—åæ ‡ (Row, Col)
            // indexInRoom: 0, 1, 2, ...

            switch (config.pattern) {
                case 's_shape': // æ¨ªå‘Så‹ (è›‡å½¢)
                    row = Math.floor(indexInRoom / config.cols);
                    col = indexInRoom % config.cols;
                    // å¶æ•°è¡Œ(0,2,4)ï¼šå·¦->å³ï¼›å¥‡æ•°è¡Œ(1,3,5)ï¼šå³->å·¦ (å³ç¿»è½¬åˆ—å·)
                    if (row % 2 !== 0) {
                        col = config.cols - 1 - col;
                    }
                    break;

                case 'z_shape_v': // ç«–å‘Zå‹ (ä»å‰åˆ°åï¼Œå¡«æ»¡ä¸€åˆ—æ¢ä¸‹åˆ—)
                    // å…ˆç¡®å®šåœ¨ç¬¬å‡ åˆ—
                    col = Math.floor(indexInRoom / maxRowsPerRoom);
                    // å†ç¡®å®šåœ¨ç¬¬å‡ è¡Œ
                    row = indexInRoom % maxRowsPerRoom;
                    break;

                case 's_shape_v': // ç«–å‘Så‹ (ç¬¬1åˆ—å‰->åï¼Œç¬¬2åˆ—å->å‰)
                    col = Math.floor(indexInRoom / maxRowsPerRoom);
                    let remainder = indexInRoom % maxRowsPerRoom;

                    // å¶æ•°åˆ—(0,2,4)ï¼šä¸Š->ä¸‹ (row = remainder)
                    // å¥‡æ•°åˆ—(1,3,5)ï¼šä¸‹->ä¸Š (row = max - 1 - remainder)
                    if (col % 2 === 0) {
                        row = remainder;
                    } else {
                        row = maxRowsPerRoom - 1 - remainder;
                    }
                    break;

                case 'z_shape': // æ¨ªå‘Zå‹ (é»˜è®¤)
                default:
                    row = Math.floor(indexInRoom / config.cols);
                    col = indexInRoom % config.cols;
                    break;
            }

            return {
                ...student,
                tempExamId: examId,
                roomNum: roomNum,
                seatNo: seatNo,
                gridRow: row,
                gridCol: col
            };
        });

        rooms.push({
            id: roomNum,
            name: `ç¬¬ ${roomNum} è€ƒåœº`,
            students: processedStudents
        });

        currentStudentIdx += config.capacity;
        roomNum++;
    }

    return rooms;
}

/**
 * [æ¸²æŸ“] è€ƒåœºé¢„è§ˆ (é€»è¾‘ä¼˜åŒ–)
 */
function renderExamPreview(rooms, cols) {
    const resultArea = document.getElementById('exam-result-area');
    const tabContainer = document.getElementById('exam-room-tabs');
    const previewContainer = document.getElementById('exam-room-preview');

    if (resultArea) resultArea.style.display = 'block';

    // ç”Ÿæˆ Tabs
    tabContainer.innerHTML = rooms.map((r, idx) => `
        <button class="sidebar-button room-tab-btn ${idx === 0 ? 'active-tab' : ''}" 
            data-idx="${idx}"
            style="background-color: ${idx === 0 ? 'var(--primary-color)' : '#fff'}; color: ${idx === 0 ? '#fff' : '#333'}; border: 1px solid #ccc; white-space: nowrap;">
            ${r.name} (${r.students.length}äºº)
        </button>
    `).join('');

    // ç»‘å®š Tab ç‚¹å‡»äº‹ä»¶ (é¿å…ä½¿ç”¨å…¨å±€å‡½æ•° window.switchExamRoom)
    const tabs = tabContainer.querySelectorAll('.room-tab-btn');
    tabs.forEach(btn => {
        btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.idx);
            // æ›´  æ ·å¼
            tabs.forEach(t => {
                t.style.backgroundColor = '#fff';
                t.style.color = '#333';
            });
            btn.style.backgroundColor = 'var(--primary-color)';
            btn.style.color = '#fff';

            // æ¸²æŸ“
            renderRoomGrid(rooms[idx], cols, previewContainer);
        });
    });

    // é»˜è®¤æ˜¾ç¤ºç¬¬1ä¸ª
    if (rooms.length > 0) {
        renderRoomGrid(rooms[0], cols, previewContainer);
    }
}

/**
 * [æ¸²æŸ“] å•ä¸ªè€ƒåœºç½‘æ ¼
 * é‡è¦è¯´æ˜ï¼š
 * - HTML Grid é»˜è®¤ä»å·¦åˆ°å³æ¸²æŸ“ã€‚
 * - å¦‚æœè¦è®©â€œç¬¬ä¸€åˆ—â€åœ¨å±å¹•å³ä¾§ (é»‘æ¿è§†è§’)ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ col=0 æ”¾åœ¨æœ€å³è¾¹ã€‚
 * - åšæ³•ï¼šæ¸²æŸ“å¾ªç¯ä» cols-1 (å·¦) éå†åˆ° 0 (å³)ã€‚
 */
function renderRoomGrid(room, cols, container) {
    if (!room || !room.students) return;

    // è®¡ç®—æœ€å¤§è¡Œæ•°
    const maxRow = Math.max(...room.students.map(s => s.gridRow)) + 1;

    let html = `<div style="display: grid; grid-template-columns: repeat(${cols}, 1fr); gap: 10px; max-width: 1000px; margin: 0 auto;">`;

    // æ„å»ºçŸ©é˜µ
    const gridMap = Array(maxRow).fill(null).map(() => Array(cols).fill(null));
    room.students.forEach(s => {
        if (s.gridRow < maxRow && s.gridCol < cols) {
            gridMap[s.gridRow][s.gridCol] = s;
        }
    });

    // æ¸²æŸ“å¾ªç¯
    for (let r = 0; r < maxRow; r++) {
        // ä»æœ€å·¦è¾¹(åˆ—å·æœ€å¤§) æ¸²æŸ“åˆ° æœ€å³è¾¹(åˆ—å·æœ€å°)
        for (let c = cols - 1; c >= 0; c--) {
            const student = gridMap[r][c];
            if (student) {
                html += `
                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #f9f9f9; text-align: center; font-size: 0.85em; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-weight: bold; color: var(--primary-color); margin-bottom: 4px;">${student.name}</div>
                        <div style="color: #666;">åº§:${student.seatNo}</div>
                        <div style="color: #999; font-size: 0.8em;">${student.tempExamId || ''}</div>
                    </div>
                `;
            } else {
                html += `<div style="border: 1px dashed #eee; border-radius: 6px; background-color: #fff;"></div>`;
            }
        }
    }
    html += `</div>`;

    container.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px; background: #eee; padding: 5px; border-radius: 4px; font-weight: bold; color: #555;">
            ğŸ“º è®²å° / é»‘æ¿ (è§†å›¾ï¼šæœ€å³ä¾§ä¸ºç¬¬ä¸€åˆ—)
        </div>
        ${html}
    `;
}

/**
 * [æ——èˆ°ç‰ˆ V4] å¯¼å‡º Excel (å¸ƒå±€ä¿®æ­£ï¼šä»å³å¾€å·¦å¡«å……ï¼Œç¬¦åˆé»‘æ¿è§†è§’)
 */
function exportExamToExcel(rooms) {
    if (!rooms || rooms.length === 0) {
        alert("æš‚æ— è€ƒåœºæ•°æ®");
        return;
    }

    const wb = XLSX.utils.book_new();

    // ==========================================
    // Sheet 1: è€ƒåœºæ€»åå• (ä¿æŒä¸å˜)
    // ==========================================
    const allData = [];
    rooms.forEach(r => {
        r.students.forEach(s => {
            allData.push({
                "è€ƒåœº": r.name,
                "åº§ä½å·": s.seatNo,
                "å‡†è€ƒè¯å·": s.tempExamId,
                "å§“å": s.name,
                "ç­çº§": s.class,
                "æ€»åˆ†": s.totalScore || 0
            });
        });
    });
    const wsList = XLSX.utils.json_to_sheet(allData);
    wsList['!cols'] = [{ wch: 10 }, { wch: 8 }, { wch: 12 }, { wch: 10 }, { wch: 12 }, { wch: 8 }];
    XLSX.utils.book_append_sheet(wb, wsList, "è€ƒåœºæ€»åå•");

    // ==========================================
    // Sheet 2: è€ƒåœºåº§ä½å¸ƒå±€å›¾ (æ–¹å‘ä¿®æ­£ç‰ˆ)
    // ==========================================
    const layoutData = [];

    rooms.forEach(r => {
        // 1. è€ƒåœºæ ‡é¢˜
        layoutData.push([`=== ${r.name} (å…±${r.students.length}äºº) ===`]);

        // 2. è®¡ç®—è¯¥è€ƒåœºçš„æœ€å¤§è¡Œåˆ—
        let maxRow = 0;
        let maxCol = 0;
        if (r.students.length > 0) {
            maxRow = Math.max(...r.students.map(s => s.gridRow));
            maxCol = Math.max(...r.students.map(s => s.gridCol));
        }

        // 3. æ„å»ºâ€œç»„åˆ«â€è¡Œ (ä»å·¦åˆ°å³ï¼šç¬¬Nç»„ ... ç¬¬1ç»„)
        // è¿™æ · Excel å·¦è¾¹æ˜¯æœ€åä¸€ç»„ï¼Œå³è¾¹æ˜¯ç¬¬ä¸€ç»„
        const groupRow = [];
        const totalGroups = maxCol + 1;
        for (let i = 0; i < totalGroups; i++) {
            const groupNum = totalGroups - i; // å€’åºï¼š5, 4, 3, 2, 1
            groupRow.push(`ç¬¬${groupNum}ç»„`, ""); // å ä¸¤åˆ—(ç­çº§+å§“å)
        }
        groupRow.push(""); // é—¨çš„é‚£ä¸€åˆ—ç•™ç©º
        layoutData.push(groupRow);

        // 4. æ„å»ºè¡¨å¤´è¡Œ (ç­çº§ | å§“å ... | å‰é—¨)
        const headerRow = [];
        for (let c = 0; c <= maxCol; c++) {
            headerRow.push("ç­çº§", "å§“å");
        }
        headerRow.push("å‰é—¨"); // æœ€å³ä¾§æ·»åŠ å‰é—¨
        layoutData.push(headerRow);

        // 5. åˆå§‹åŒ–ç½‘æ ¼
        // è¡Œæ•° = maxRow + 1
        // åˆ—æ•° = (maxCol + 1) * 2 + 1 (é—¨åˆ—)
        const grid = [];
        for (let i = 0; i <= maxRow; i++) {
            const rowArr = new Array((maxCol + 1) * 2 + 1).fill("");
            grid.push(rowArr);
        }

        // 6. å¡«å……å­¦ç”Ÿæ•°æ® (æ ¸å¿ƒä¿®æ­£ï¼šåˆ—åºç¿»è½¬)
        r.students.forEach(s => {
            // [æ ¸å¿ƒä¿®æ”¹] ä»å³å‘å·¦å¡«å……
            // s.gridCol = 0 (ç¬¬1ç»„) -> æ˜ å°„åˆ°æœ€å³è¾¹çš„ Excel åˆ—
            // s.gridCol = max (ç¬¬Nç»„) -> æ˜ å°„åˆ°æœ€å·¦è¾¹çš„ Excel åˆ—
            // ç®—æ³•ï¼š(maxCol - s.gridCol) * 2

            const colIndex = (maxCol - s.gridCol) * 2;
            const rowIndex = s.gridRow;

            if (grid[rowIndex] && grid[rowIndex][colIndex] !== undefined) {
                // ç­çº§åç®€åŒ–
                let classStr = s.class.replace(/[^0-9]/g, '');
                if (!classStr) classStr = s.class;

                grid[rowIndex][colIndex] = classStr;     // å·¦æ ¼ï¼šç­çº§
                grid[rowIndex][colIndex + 1] = s.name;   // å³æ ¼ï¼šå§“å
            }
        });

        // 7. æ·»åŠ â€œåé—¨â€ (å³ä¸‹è§’)
        if (grid.length > 0) {
            const lastRowIndex = grid.length - 1;
            const lastColIndex = grid[0].length - 1;
            grid[lastRowIndex][lastColIndex] = "åé—¨";
        }

        // 8. å†™å…¥æ•°æ®
        layoutData.push(...grid);
        layoutData.push([]); // ç©ºè¡Œåˆ†éš”
        layoutData.push([]);
    });

    const wsLayout = XLSX.utils.aoa_to_sheet(layoutData);

    // 9. è®¾ç½®åˆ—å®½
    const colWidths = [];
    for (let i = 0; i < 50; i++) {
        if (i % 2 === 0) colWidths.push({ wch: 6 });  // ç­çº§åˆ—çª„
        else colWidths.push({ wch: 12 });             // å§“ååˆ—å®½
    }
    colWidths.push({ wch: 8 }); // é—¨åˆ—
    wsLayout['!cols'] = colWidths;

    XLSX.utils.book_append_sheet(wb, wsLayout, "è€ƒåœºåº§ä½å¸ƒå±€");
    XLSX.writeFile(wb, `è€ƒåœºç¼–æ’è¡¨${new Date().toLocaleDateString()}.xlsx`);
}


// =====================================================================
//    UPGRADED V2    æ¨¡å—åå…­ï¼šæ™ºèƒ½äº’åŠ©åˆ†ç»„ç”Ÿæˆå™¨ (åŸºäº T åˆ†äº’è¡¥)
// =====================================================================

/**
 * 16.1 [AI æ——èˆ°ç‰ˆ] æ¸²æŸ“ä¸»ç•Œé¢ (AI æ’åº§ + å­¦ä¹ åˆ†ç»„)
 */
function renderStudyGroups(container) {
    const classes = [...new Set(G_StudentsData.map(s => s.class))].sort();
    const subjectOptions = G_DynamicSubjectList.map(s => `<option value="${s}">${s}</option>`).join('');

    container.innerHTML = `
        <h2>ğŸ§© æ¨¡å—åå…­ï¼šæ™ºèƒ½äº’åŠ©åˆ†ç»„ & AI åº§ä½ç¼–æ’</h2>
        
        <div style="margin-bottom: 20px; border-bottom: 2px solid #eee; display: flex; gap: 20px;">
            <button class="tab-btn active" onclick="switchGroupTab('study')" id="tab-btn-study" 
                style="padding: 10px 20px; font-weight: bold; cursor: pointer; border:none; background:none; border-bottom: 3px solid #6f42c1; color: #6f42c1;">
                ğŸ“š å­¦ä¹ äº’åŠ©åˆ†ç»„
            </button>
            <button class="tab-btn" onclick="switchGroupTab('seat')" id="tab-btn-seat" 
                style="padding: 10px 20px; font-weight: bold; cursor: pointer; border:none; background:none; color: #666; border-bottom: 3px solid transparent;">
                ğŸ¤– AI ç­çº§åº§ä½ç¼–æ’
            </button>
        </div>

        <div id="tab-content-study">
            ${getTab1HTML(classes, subjectOptions)} 
        </div>

        <div id="tab-content-seat" style="display:none;">
            <div class="main-card-wrapper" style="border-left: 5px solid #20c997;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                    <h4 style="margin:0;">ğŸ¤– AI åº§ä½è®¾è®¡å¸ˆ</h4>
                    <span id="seat-db-status" style="font-size:0.85em; color:#666;">æœªæ£€æµ‹åˆ°èº«é«˜æ•°æ®</span>
                </div>
                
                <div style="background:#f0fdf4; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #bbf7d0;">
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <label style="font-weight:bold;">ç›®æ ‡ç­çº§:</label>
                        <select id="seat-class-select" class="sidebar-select" style="width:auto; font-weight:bold; min-width:150px;">
                                ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>

                        <label for="seat-physical-upload" class="sidebar-button" style="background-color:#fff; color:#333; border:1px solid #ccc; cursor:pointer; padding: 6px 12px;">
                            ğŸ“¤ å¯¼å…¥èº«é«˜/æ€§åˆ«è¡¨
                        </label>
                        <input type="file" id="seat-physical-upload" style="display:none;" accept=".xlsx, .xls, .csv">

                        <button id="btn-save-physical" class="sidebar-button" style="background-color:#20c997; display:none; padding: 6px 12px;">ğŸ’¾ ä¿å­˜åº“</button>
                        
                        <button id="btn-clear-physical" class="sidebar-button" style="background-color:#dc3545; display:none; padding: 6px 12px;">ğŸ—‘ï¸ åˆ é™¤åº“</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; align-items: start;">
                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">æ•™å®¤åˆ—å¸ƒå±€ (ä»å·¦åˆ°å³)</label>
                        <input type="text" id="seat-columns-config" class="sidebar-select" value="2,2,2,1" style="width:100%; letter-spacing:5px;">
                        <p style="font-size:0.8em; color:#666; margin-top:5px;">ä¾‹ "2,2,2,2" è¡¨ç¤º4ç»„åŒäººåº§ã€‚</p>
                        
                        <div style="margin-top:15px;">
                            <label style="font-weight:bold; display:block; margin-bottom:5px;">æ¨¡å‹é€‰æ‹©</label>
                            <select id="seat-ai-model" class="sidebar-select" style="width:100%;">
                                <option value="deepseek-chat">ğŸš€ DeepSeek V3 (æé€Ÿ)</option>
                                <option value="deepseek-reasoner">ğŸ§  DeepSeek R1 (æ·±åº¦æ€è€ƒ)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">âœ¨ AI æ’åº§æŒ‡ä»¤ (Prompt)</label>
                        <textarea id="seat-ai-prompt" class="sidebar-select" rows="4" style="width:100%; font-family:sans-serif; line-height:1.4;" 
                            placeholder="è¯·è¾“å…¥æ‚¨çš„æ’åº§è¦æ±‚ï¼Œä¾‹å¦‚ï¼š&#10;1. å¿…é¡»ä¸¥æ ¼æŒ‰ç…§èº«é«˜ä»çŸ®åˆ°é«˜æ’åˆ—ï¼ŒçŸ®çš„åœ¨å‰ï¼Œé«˜çš„åœ¨åã€‚&#10;2. åŒæ¡Œå°½é‡ç”·å¥³æ­é…ã€‚&#10;3. åŒä¸€ä¸ªå­¦ä¹ å°ç»„çš„æˆå‘˜å°½é‡å®‰æ’åœ¨ç›¸é‚»åŒºåŸŸã€‚"></textarea>
                    </div>
                </div>
                
                <div style="margin-top:20px; text-align:right; border-top:1px solid #eee; padding-top:15px; display:flex; justify-content:flex-end; gap:10px;">
                    <button id="btn-stop-ai-seat" class="sidebar-button" style="background-color: #dc3545; padding: 10px 20px; font-size: 1em; display:none;">
                        â¹ åœæ­¢ç”Ÿæˆ
                    </button>
                    
                    <button id="btn-generate-ai-seats" class="sidebar-button" style="background-color: #6f42c1; padding: 10px 30px; font-size: 1.1em;">
                        ğŸª„ å¼€å§‹ AI æ’åº§
                    </button>
                </div>
                
                <div id="seat-ai-loading" style="display:none; margin-top: 20px;">
                    <div style="text-align:center; margin-bottom: 10px; color:#6f42c1;">
                        <span style="font-size:1.5em; vertical-align:middle;">ğŸ¤–</span>
                        <span id="seat-ai-status-text" style="font-weight:bold; vertical-align:middle;">AI æ­£åœ¨æ€è€ƒä¸­...</span>
                    </div>
                    
                    <div style="background: #1e1e1e; color: #d4d4d4; border-radius: 6px; padding: 0; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; height: 300px; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid #333;">
                        <div style="background: #2d2d2d; padding: 5px 10px; border-bottom: 1px solid #333; border-radius: 6px 6px 0 0; display: flex; gap: 6px; align-items: center;">
                            <span style="width:10px; height:10px; border-radius:50%; background:#ff5f56;"></span>
                            <span style="width:10px; height:10px; border-radius:50%; background:#ffbd2e;"></span>
                            <span style="width:10px; height:10px; border-radius:50%; background:#27c93f;"></span>
                            <span style="margin-left: 10px; color: #888;">DeepSeek Output Stream</span>
                        </div>
                        
                        <div id="seat-ai-log-container" style="flex: 1; overflow-y: auto; padding: 10px; white-space: pre-wrap; word-break: break-all;">
                            <div id="seat-ai-reasoning" style="color: #808080; border-left: 2px solid #444; padding-left: 8px; margin-bottom: 10px; display:none;"></div>
                            <div id="seat-ai-content" style="color: #4ec9b0;"></div>
                            <span class="typing-cursor" style="display:inline-block; width:8px; height:14px; background:#ccc; vertical-align:middle;"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="seat-result-area" style="display:none;">
                 <div class="main-card-wrapper">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">ğŸ« æ•™å®¤åº§ä½é¢„è§ˆ</h3>
                        <button id="btn-export-seats" class="sidebar-button" style="background-color: var(--color-blue);">ğŸ“¥ å¯¼å‡ºExcel</button>
                    </div>
                    <div id="seat-map-container" style="overflow-x:auto; padding:20px; background:#fdfdfd; border:1px solid #eee; text-align:center;"></div>
                </div>
            </div>
        </div>
    `;

    // --- è¾…åŠ©ï¼šæ¢å¤ Tab 1 çš„ HTML (é¿å…ä»£ç é‡å¤å¤ªé•¿) ---
    // åœ¨å®é™…æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥æŠŠåŸæ¥ Tab 1 çš„ HTML ç›´æ¥è´´åœ¨ä¸Šé¢çš„ ${getTab1HTML} ä½ç½®
    // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ç”¨ä¸€ä¸ªå ä½ç¬¦ï¼Œæ‚¨æ“ä½œæ—¶è¯·ç›´æ¥ä¿ç•™åŸæœ‰çš„ Tab 1 å†…å®¹å³å¯ã€‚

    // Tab åˆ‡æ¢é€»è¾‘
    window.switchGroupTab = (tab) => {
        document.getElementById('tab-content-study').style.display = tab === 'study' ? 'block' : 'none';
        document.getElementById('tab-content-seat').style.display = tab === 'seat' ? 'block' : 'none';
        const btnStudy = document.getElementById('tab-btn-study');
        const btnSeat = document.getElementById('tab-btn-seat');
        if (tab === 'study') {
            btnStudy.style.borderBottomColor = '#6f42c1'; btnStudy.style.color = '#6f42c1';
            btnSeat.style.borderBottomColor = 'transparent'; btnSeat.style.color = '#666';
        } else {
            btnSeat.style.borderBottomColor = '#20c997'; btnSeat.style.color = '#20c997';
            btnStudy.style.borderBottomColor = 'transparent'; btnStudy.style.color = '#666';
        }
    };

    // ç»‘å®šäº‹ä»¶
    bindStudyGroupEvents();
    initGroupArchiveManager(); 
    initPhysicalDataManager(); 
    
    // [æ–°å¢] AI æŒ‰é’®ç»‘å®š
    document.getElementById('btn-generate-ai-seats').addEventListener('click', generateAISeatingChart);
    document.getElementById('btn-export-seats').addEventListener('click', exportSeatingChart);
}

function getTab1HTML(classes, subjectOptions) {
    return `
            <div class="main-card-wrapper" style="margin-bottom: 20px; background:#f8f9fa; border:1px dashed #ccc;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="margin:0; color:#555;">ğŸ’¾ åˆ†ç»„å­˜æ¡£åº“</h4>
                    <button id="btn-save-group-archive" class="sidebar-button" style="background-color:#28a745; font-size:0.85em;" disabled>ğŸ’¾ ä¿å­˜å½“å‰åˆ†ç»„</button>
                </div>
                <div id="group-archive-list" style="margin-top:10px; max-height:150px; overflow-y:auto; background:#fff; border:1px solid #eee; padding:5px; border-radius:4px;">
                    <div style="text-align:center; color:#999; padding:10px;">æ­£åœ¨åŠ è½½å­˜æ¡£...</div>
                </div>
            </div>
            <div class="main-card-wrapper" style="border-left: 5px solid #6f42c1;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                    <h4 style="margin:0;">ğŸ› ï¸ ç­–ç•¥é…ç½®</h4>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                    <div><label style="font-weight:600; font-size:0.9em; color:#555;">1. é€‰æ‹©ç­çº§</label><select id="group-class-select" class="sidebar-select" style="width:100%; font-weight:bold;">${classes.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
                    <div><label style="font-weight:600; font-size:0.9em; color:#555;">2. åˆ†ç»„æ¨¡å¼</label><select id="group-strategy" class="sidebar-select" style="width:100%;"><option value="balanced">âš–ï¸ Så‹å‡è¡¡åˆ†ç»„ (æ¨è)</option><option value="high_low">ğŸ¤ 1å¸®1 (é¦–å°¾ç»“å¯¹)</option><option value="random">ğŸ² å®Œå…¨éšæœº</option></select></div>
                    <div><label style="font-weight:600; font-size:0.9em; color:#555;">3. æ ¸å¿ƒä¾æ®</label><select id="group-sort-basis" class="sidebar-select" style="width:100%; color:#6f42c1; font-weight:bold;"><option value="total">ğŸ† æŒ‰â€œæ€»åˆ†â€å®åŠ›</option><option value="single">ğŸ¯ æŒ‰â€œå•ç§‘â€æˆç»©</option><option value="complementary">â˜¯ï¸ æŒ‰â€œåŒç§‘äº’è¡¥â€ (Aå¼ºBå¼±)</option></select></div>
                    <div id="group-params-area" style="grid-column: span 1;">
                        <div id="group-size-wrapper"><label style="font-weight:600; font-size:0.9em; color:#555;">æ¯ç»„äººæ•°</label><input type="number" id="group-size-input" class="sidebar-select" value="6" min="2" max="10" style="width:100%;"></div>
                        <div id="group-single-wrapper" style="display:none;"><label style="font-weight:600; font-size:0.9em; color:#555;">é€‰æ‹©ç›®æ ‡å­¦ç§‘</label><select id="group-single-subject" class="sidebar-select" style="width:100%;">${subjectOptions}</select></div>
                        <div id="group-comp-wrapper" style="display:none;"><label style="font-weight:600; font-size:0.9em; color:#555;">äº’è¡¥å­¦ç§‘ (A vs B)</label><div style="display:flex; gap:5px;"><select id="group-sub-a" class="sidebar-select" style="width:50%;">${subjectOptions}</select><span style="align-self:center;">âš¡ï¸</span><select id="group-sub-b" class="sidebar-select" style="width:50%;">${subjectOptions}</select></div></div>
                    </div>
                    <div><button id="btn-generate-groups" class="sidebar-button" style="background-color: #6f42c1; width:100%; height: 42px;">âœ¨ ç”Ÿæˆåˆ†ç»„</button></div>
                </div>
                <div id="group-strategy-desc" style="font-size:0.85em; color:#666; margin-top:15px; padding:10px; background:#f8f9fa; border-radius:6px;"></div>
            </div>
            <div id="group-result-area" style="display: none;">
                <div class="main-card-wrapper">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h3 style="margin:0;">ğŸ“‹ åˆ†ç»„ç»“æœé¢„è§ˆ</h3><button id="btn-export-groups" class="sidebar-button" style="background-color: var(--color-green);">ğŸ“¥ å¯¼å‡ºåå•</button></div>
                    <div id="group-stats-bar" style="background:#fff3cd; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.9em; color:#856404; border:1px solid #ffeeba;"></div>
                    <div id="group-cards-container" class="group-grid-container"></div>
                </div>
            </div>
    `;
}


/**
 * 16.2 åˆ†ç»„æ ¸å¿ƒç®—æ³• (é€‚é…å¤šæ¨¡å¼)
 */
function calculateGroups(students, strategy, groupSize, sortMode) {
    const groups = [];
    const totalStudents = students.length;

    // --- éšæœºæ¨¡å¼ ---
    if (strategy === 'random') {
        const shuffled = [...students].sort(() => Math.random() - 0.5);
        const numGroups = Math.ceil(totalStudents / groupSize);
        for (let i = 0; i < numGroups; i++) groups.push({ name: `ç¬¬ ${i + 1} ç»„`, members: [] });
        shuffled.forEach((s, idx) => groups[idx % numGroups].members.push(s));
        return groups;
    }

    // --- 1å¸®1æ¨¡å¼ (High-Low) ---
    if (strategy === 'high_low') {
        const pairCount = Math.floor(totalStudents / 2);
        for (let i = 0; i < pairCount; i++) {
            const top = students[i];
            const bottom = students[totalStudents - 1 - i];

            // åœ¨äº’è¡¥æ¨¡å¼ä¸‹ï¼ŒTopæ˜¯ Aå¼ºBå¼±ï¼ŒBottomæ˜¯ Aå¼±Bå¼ºã€‚ç»é…ï¼
            groups.push({
                name: sortMode === 'complementary' ? `äº’è¡¥å¯¹å­ ${i + 1}` : `å¸®æ‰¶å¯¹å­ ${i + 1}`,
                members: [top, bottom]
            });
        }
        // å¤„ç†è½å• (å¥‡æ•°)
        if (totalStudents % 2 !== 0) {
            const midStudent = students[Math.floor(totalStudents / 2)];
            groups[groups.length - 1].members.push(midStudent); // åŠ åˆ°æœ€åä¸€ç»„å˜3äºº
        }
    }
    // --- Så‹å‡è¡¡æ¨¡å¼ (Balanced) ---
    else {
        const numGroups = Math.ceil(totalStudents / groupSize);
        for (let i = 0; i < numGroups; i++) groups.push({ name: `ç¬¬ ${i + 1} ç»„`, members: [] });

        students.forEach((s, index) => {
            const row = Math.floor(index / numGroups);
            let groupIndex;
            if (row % 2 === 0) groupIndex = index % numGroups; // æ­£å‘
            else groupIndex = numGroups - 1 - (index % numGroups); // åå‘
            groups[groupIndex].members.push(s);
        });
    }

    // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯ (å‡åˆ†/å‡å·®)
    groups.forEach(g => {
        let sum = 0;
        g.members.forEach(m => sum += m._sortScore);
        g.avgSortScore = (sum / g.members.length).toFixed(1);

        // ç»„å†…æ’åº (æ–¹ä¾¿æ˜¾ç¤º Leader)
        g.members.sort((a, b) => b._sortScore - a._sortScore);

        // è§’è‰²æ ‡è®°
        g.members.forEach((m, idx) => {
            if (sortMode === 'complementary') {
                // äº’è¡¥æ¨¡å¼ä¸‹ï¼Œæ²¡æœ‰ç»å¯¹çš„ä¼˜å·®ï¼Œè€Œæ˜¯ç‰¹è´¨ä¸åŒ
                // æ’åºåˆ†é«˜(Aå¼ºBå¼±)ï¼Œæ’åºåˆ†ä½(Bå¼ºAå¼±)
                if (m._compDiff > 5) m.role = 'typeA'; // Aç§‘å¤§ä½¬
                else if (m._compDiff < -5) m.role = 'typeB'; // Bç§‘å¤§ä½¬
                else m.role = 'balance'; // å‡è¡¡
            } else {
                // ä¼ ç»Ÿä¼˜å·®
                if (idx === 0) m.role = 'leader';
                else if (idx === g.members.length - 1) m.role = 'support';
                else m.role = 'member';
            }
        });
    });

    return groups;
}

/**
 * 16.3 æ¸²æŸ“å¯è§†åŒ– (  å¼ºç‰ˆ)
 */
function renderGroupVisuals(groups, className, sortMode) {
    const container = document.getElementById('group-cards-container');
    const statsBar = document.getElementById('group-stats-bar');
    document.getElementById('group-result-area').style.display = 'block';

    // ç»Ÿè®¡æè¿°
    let statText = `<strong>${className}</strong> ç”Ÿæˆ <strong>${groups.length}</strong> ç»„ã€‚`;
    if (sortMode !== 'complementary' && groups.length > 0) {
        const max = Math.max(...groups.map(g => parseFloat(g.avgSortScore)));
        const min = Math.min(...groups.map(g => parseFloat(g.avgSortScore)));
        statText += ` ç»„é—´æŒ‡æ ‡æå·®ï¼š<strong>${(max - min).toFixed(1)}</strong> (è¶Šå°è¶Šå‡è¡¡)`;
    } else {
        statText += ` å·²å°è¯•æœ€å¤§åŒ–ç»„å†…äº’è¡¥æ€§ã€‚`;
    }
    statsBar.innerHTML = statText;

    container.innerHTML = groups.map(g => `
        <div class="group-card">
            <div class="group-header">
                <span>${g.name}</span>
                <span class="group-avg" style="font-size:0.8em; opacity:0.7;">æŒ‡æ ‡å‡å€¼:${g.avgSortScore}</span>
            </div>
            <ul class="group-member-list">
                ${g.members.map(m => {
        let badge = '';
        let scoreColor = '#666';

        if (sortMode === 'complementary') {
            if (m.role === 'typeA') {
                badge = `<span class="role-badge" style="background:#e3f2fd; color:#0d47a1;">Aå¼º</span>`;
                scoreColor = '#0d47a1';
            } else if (m.role === 'typeB') {
                badge = `<span class="role-badge" style="background:#fbe9e7; color:#bf360c;">Bå¼º</span>`;
                scoreColor = '#bf360c';
            } else {
                badge = `<span class="role-badge" style="background:#f5f5f5; color:#666;">å‡è¡¡</span>`;
            }
        } else {
            if (m.role === 'leader') badge = `<span class="role-badge role-leader">Leader</span>`;
            else if (m.role === 'support') badge = `<span class="role-badge role-support">Help</span>`;
        }

        return `
                    <li class="group-member-item">
                        <div style="font-weight:500;">
                            ${m.name} ${badge}
                        </div>
                        <div style="font-size:0.85em; color:${scoreColor};">
                            ${m._displayInfo}
                        </div>
                    </li>`;
    }).join('')}
            </ul>
        </div>
    `).join('');
}

/**
 * 16.4 å¯¼å‡º (é€‚é… Pro ç‰ˆ)
 */
function exportGroupsToExcel(groups) {
    const wb = XLSX.utils.book_new();
    const data = [];

    // 1. è®¾ç½®è¡¨å¤´
    data.push(["å°ç»„åç§°", "å§“å", "ç»„å†…è§’è‰²", "æ’åºæŒ‡æ ‡æ•°æ® (åˆ†æ•°/å·®å€¼)"]);

    // 2. å¡«å……æ•°æ®
    groups.forEach(g => {
        g.members.forEach(m => {
            let roleText = m.role;

            // è§’è‰²åç§°æ˜ å°„ (å¯¹åº” renderVisuals ä¸­çš„é€»è¾‘)
            if (roleText === 'leader') roleText = 'ğŸŒŸ ç»„é•¿';
            else if (roleText === 'support') roleText = 'ğŸ’ª å¸®æ‰¶å¯¹è±¡';
            else if (roleText === 'member') roleText = 'ç»„å‘˜';
            else if (roleText === 'typeA') roleText = 'ğŸ”µ Aç§‘ä¼˜åŠ¿';
            else if (roleText === 'typeB') roleText = 'ğŸ”´ Bç§‘ä¼˜åŠ¿';
            else if (roleText === 'balance') roleText = 'âšª å‡è¡¡';

            data.push([
                g.name,
                m.name,
                roleText,
                m._displayInfo // è¿™é‡Œä¼šæ˜¾ç¤º "æ€»åˆ†:500" æˆ– "æ•°å­¦:90 / è‹±è¯­:60"
            ]);
        });

        // æ¯ä¸ªå°ç»„ä¹‹é—´æ’å…¥ç©ºè¡Œï¼Œæ–¹ä¾¿é˜…è¯»
        data.push([]);
    });

    // 3. ç”Ÿæˆ Sheet
    const ws = XLSX.utils.aoa_to_sheet(data);

    // 4. è®¾ç½®åˆ—å®½ (wch æ˜¯å­—ç¬¦å®½åº¦)
    ws['!cols'] = [
        { wch: 12 }, // å°ç»„åç§°
        { wch: 10 }, // å§“å
        { wch: 12 }, // ç»„å†…è§’è‰²
        { wch: 30 }  // æ’åºæŒ‡æ ‡æ•°æ® (è¿™ä¸€åˆ—å¯èƒ½è¾ƒé•¿ï¼Œç»™å®½ä¸€ç‚¹)
    ];

    // 5. å†™å…¥å¹¶ä¸‹è½½
    XLSX.utils.book_append_sheet(wb, ws, "äº’åŠ©åˆ†ç»„åå•");
    XLSX.writeFile(wb, `æ™ºèƒ½äº’åŠ©åˆ†ç»„åå•_${new Date().toLocaleDateString()}.xlsx`);
}


// =====================================================================
//    UPGRADED V3    æ¨¡å—åä¸ƒï¼šå­¦æœŸç»¼åˆè¯„è¯­åŠ©æ‰‹ (æˆç»© + ç”Ÿæ´»åŒç»´åº¦)
// =====================================================================

// é¢„è®¾çš„æ—¥å¸¸è¡Œä¸ºæ ‡ç­¾åº“ (ç‚¹å‡»å¯å¿«é€Ÿæ’å…¥)
// é¢„è®¾çš„æ—¥å¸¸è¡Œä¸ºæ ‡ç­¾åº“ (ç‚¹å‡»å¯å¿«é€Ÿæ’å…¥)
const DAILY_TAGS = [
    // --- ğŸ‘ å­¦ä¹ ä¸æ€åº¦ ---
    { text: "ğŸ‘‚ å¬è¯¾ä¸“æ³¨", type: "good" },
    { text: "ğŸ§  æ€ç»´æ•æ·", type: "good" },
    { text: "ğŸ™‹ ç§¯æå‘è¨€", type: "good" },
    { text: "ğŸ“ ä¹¦å†™ç¾è§‚", type: "good" },
    { text: "ğŸ“š çƒ­çˆ±é˜…è¯»", type: "good" },
    { text: "ğŸ¦… æ•¢äºè´¨ç–‘", type: "good" },
    { text: "ğŸ¢ ä½œä¸šæ‹–æ‹‰", type: "bad" },
    { text: "ğŸ“‰ ç²—å¿ƒå¤§æ„", type: "bad" },
    { text: "ğŸ’¤ ä¸Šè¯¾èµ°ç¥", type: "bad" },
    { text: "ğŸ¤« çˆ±è®²å°è¯", type: "bad" },

    // --- ğŸŒŸ æ€§æ ¼ä¸å“è´¨ ---
    { text: "ğŸŒ é˜³å…‰å¼€æœ—", type: "good" },
    { text: "ğŸ’¼ è´£ä»»å¿ƒå¼º", type: "good" },
    { text: "ğŸ’ª æ„å¿—åšå¼º", type: "good" },
    { text: "ğŸ˜Š ç¤¼è²Œå¾…äºº", type: "good" },
    { text: "ğŸ¤ æ€§æ ¼å†…å‘", type: "neutral" },
    { text: "ğŸ˜¶ ç¼ºä¹è‡ªä¿¡", type: "bad" },
    { text: "ğŸ¤¯ æƒ…ç»ªæ³¢åŠ¨å¤§", type: "bad" },
    { text: "ğŸ§Š ä¸ªæ€§ç‹¬ç«‹", type: "neutral" },

    // --- ğŸ¤ ç¤¾äº¤ä¸é›†ä½“ ---
    { text: "ğŸ¤ ä¹äºåŠ©äºº", type: "good" },
    { text: "ğŸ† é›†ä½“è£èª‰æ„Ÿ", type: "good" },
    { text: "ğŸ‘® ä¼˜ç§€ç­å¹²", type: "good" },
    { text: "ğŸ‘¥ äººç¼˜æå¥½", type: "good" },
    { text: "ğŸŒµ å®¹æ˜“èµ·æ‘©æ“¦", type: "bad" },
    { text: "ğŸ§ çˆ±é’»ç‰›è§’å°–", type: "neutral" },

    // --- ğŸƒ ç»¼åˆä¸ç‰¹é•¿ ---
    { text: "ğŸ”¥ åŠ³åŠ¨ç§¯æ", type: "good" },
    { text: "ğŸƒ ä½“è‚²å¥å°†", type: "good" },
    { text: "ğŸ¨ è‰ºæœ¯ç‰¹é•¿", type: "good" },
    { text: "ğŸ’» ç”µè„‘é«˜æ‰‹", type: "good" },
    { text: "ğŸ•°ï¸ ç»å¸¸è¿Ÿåˆ°", type: "bad" },
    { text: "ğŸ§¹ å«ç”Ÿä¹ æƒ¯å·®", type: "bad" }
];
/**
 * 17.1 æ¸²æŸ“ä¸»ç•Œé¢
 */
async function renderCommentGenerator(container) {
    const multiData = await loadMultiExamData();

    if (!multiData || multiData.length === 0) {
        container.innerHTML = `<div class="main-card-wrapper" style="text-align:center; padding:50px; color:#666;">âš ï¸ è¯·å…ˆåœ¨â€œæ•°æ®ç®¡ç†ä¸­å¿ƒâ€å¯¼å…¥è€ƒè¯•æ•°æ®ã€‚</div>`;
        return;
    }

    // 1. æ•°æ®èšåˆ
    const studentMap = new Map();
    const classSet = new Set();

    multiData.forEach(exam => {
        if (exam.isHidden) return;
        exam.students.forEach(s => {
            if (!studentMap.has(s.id)) {
                studentMap.set(s.id, {
                    info: { name: s.name, class: s.class, id: s.id },
                    exams: []
                });
            }
            const record = studentMap.get(s.id);
            record.info.class = s.class;
            classSet.add(s.class);
            record.exams.push({
                label: exam.label,
                totalScore: s.totalScore,
                rank: s.rank,
                gradeRank: s.gradeRank
            });
        });
    });

    const classes = Array.from(classSet).sort();

    //            æ’åºçŠ¶æ€å˜é‡ (é»˜è®¤ä¸º rank)
    let currentSortMode = 'rank';

    // 2. æ¸²æŸ“ UI
    container.innerHTML = `
        <h2>âœï¸ æ¨¡å—åä¸ƒï¼šç»¼åˆè¯„è¯­åŠ©æ‰‹</h2>

        <div class="main-card-wrapper" style="border-left: 5px solid #20c997; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <div>
                        <label style="font-weight:600; font-size:0.9em; color:#555;">ç­çº§:</label>
                        <select id="comment-class-select" class="sidebar-select" style="width:auto; min-width:120px; font-weight:bold;">
                            ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <label style="font-weight:600; font-size:0.9em; color:#6f42c1;">ä¾æ®:</label>
                        <select id="comment-gen-mode" class="sidebar-select" style="width:auto; min-width:180px; border-color:#6f42c1; color:#6f42c1; font-weight:bold;">
                            <option value="comprehensive" selected>ğŸŒŸ ç»¼åˆ (å†å²è¶‹åŠ¿+æ—¥å¸¸)</option>
                            <option value="history_only">ğŸ“ˆ ä»…å†å²æˆç»©è¶‹åŠ¿</option>
                            <option value="current_only">ğŸ¯ ä»…æœ¬æ¬¡æˆç»©</option>
                            <option value="daily_only">ğŸ“ ä»…æ—¥å¸¸è¡Œä¸ºè¡¨ç°</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button id="btn-toggle-archive" class="sidebar-button" style="background-color: #6c757d; font-size: 0.9em;">ğŸ“‚ è¯„è¯­å­˜æ¡£åº“</button>
                    <button id="btn-gen-rule" class="sidebar-button" style="background-color: #17a2b8; font-size: 0.9em;">âš¡ï¸ è§„åˆ™ç”Ÿæˆ</button>
                    <button id="btn-gen-ai-batch" class="sidebar-button" style="background-color: #6f42c1; font-size: 0.9em;">ğŸ¤– AI æ‰¹é‡ç”Ÿæˆ</button>
                    <button id="btn-export-comments" class="sidebar-button" style="background-color: var(--color-green); font-size: 0.9em;">ğŸ“¥ å¯¼å‡º</button>
                </div>
            </div>

            <div id="archive-panel" style="display:none; margin-top:15px; padding-top:15px; border-top:1px dashed #ccc; background-color:#fcfcfc; padding:15px; border-radius:6px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; font-size:1em; color:#555;">ğŸ“š å†å²è¯„è¯­å­˜æ¡£</h4>
                    <button id="btn-save-library" class="sidebar-button" style="background-color: #28a745; padding:4px 10px; font-size: 0.8em;">ğŸ’¾ ä¿å­˜å½“å‰è¡¨æ ¼</button>
                </div>
                <div id="comment-library-list" style="max-height: 150px; overflow-y: auto; border:1px solid #eee; background:#fff; border-radius:4px;">
                    <div style="padding:15px; text-align:center; color:#999;">åŠ è½½ä¸­...</div>
                </div>
            </div>
            
            <div id="ai-batch-progress" style="display:none; margin-top:15px; background:#fff; padding:10px; border:1px solid #e9ecef; border-radius:6px;">
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.9em; margin-bottom:5px;">
                    <span id="ai-progress-text" style="font-weight:bold; color:#555;">AI ç”Ÿæˆä¸­...</span>
                    <div style="display:flex; gap:10px;">
                        <button id="btn-stop-ai" style="color:#dc3545; background:none; border:none; font-weight:bold; cursor:pointer;">â¹ åœæ­¢</button>
                        <button id="btn-close-progress" style="color:#999; background:none; border:none; font-size:1.2em; cursor:pointer;">&times;</button>
                    </div>
                </div>
                <div style="width:100%; background:#e9ecef; height:8px; border-radius:4px; overflow:hidden;">
                    <div id="ai-progress-bar" style="width:0%; height:100%; background:#6f42c1; transition:width 0.3s;"></div>
                </div>
            </div>
        </div>

        <div class="main-card-wrapper">
            <div class="table-container" style="max-height: 65vh; overflow-y: auto;">
                <table id="comment-table">
                    <thead>
                        <tr>
                            <th id="th-sort-name" style="width:70px; cursor:pointer; user-select:none;" title="ç‚¹å‡»åˆ‡æ¢ï¼šæŒ‰æˆç»©æ’åº / æŒ‰å§“åæ’åº">
                                å§“å <span id="sort-icon" style="font-size:0.8em; color:#ccc;">â‡…</span>
                            </th>
                            <th style="width:120px;">æˆç»©è¶‹åŠ¿</th>
                            <th style="width:250px; background-color:#fff9db;">ğŸ“ æ—¥å¸¸å°è±¡ (å…³é”®è¯)</th>
                            <th>è¯„è¯­å†…å®¹ (AI / è§„åˆ™)</th>
                            <th style="width:60px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="comment-tbody"></tbody>
                </table>
            </div>
        </div>
    `;

    // --- åŠŸèƒ½é€»è¾‘åŒºåŸŸ ---

    // 1. å­˜æ¡£åº“æŠ˜å é€»è¾‘
    const archiveBtn = document.getElementById('btn-toggle-archive');
    const archivePanel = document.getElementById('archive-panel');
    archiveBtn.addEventListener('click', () => {
        if (archivePanel.style.display === 'none') {
            archivePanel.style.display = 'block';
            renderLibraryList(); // å±•å¼€æ—¶åˆ·  åˆ—è¡¨
            archiveBtn.style.backgroundColor = '#5a6268'; // æ·±è‰²è¡¨ç¤ºæ¿€æ´»
        } else {
            archivePanel.style.display = 'none';
            archiveBtn.style.backgroundColor = '#6c757d'; // æ¢å¤åŸè‰²
        }
    });

    // --- å†…éƒ¨å‡½æ•°ï¼šæ¸²æŸ“å½’æ¡£åº“åˆ—è¡¨ (å·²å‡çº§ï¼šæ·»åŠ é‡å‘½åæŒ‰é’®) ---
    const renderLibraryList = async () => {
        const libContainer = document.getElementById('comment-library-list');
        const library = await localforage.getItem('G_Comment_Library') || [];

        if (library.length === 0) {
            libContainer.innerHTML = `<div style="padding:15px; text-align:center; color:#999;">æš‚æ— å­˜æ¡£ï¼Œç‚¹å‡»ç»¿è‰²æŒ‰é’®ä¿å­˜å½“å‰å·¥ä½œã€‚</div>`;
            return;
        }

        libContainer.innerHTML = library.map((item) => `
            <div class="multi-exam-item" style="padding:8px 12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <div style="flex-grow:1;">
                    <div style="font-weight:bold; color:#333; font-size:0.95em;">${item.name}</div>
                    <div style="font-size:0.8em; color:#999;">ğŸ“… ${item.date} | ğŸ‘¥ ${item.count} äºº</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="window.loadCommentLibrary('${item.id}')" class="sidebar-button" style="padding:3px 8px; font-size:0.8em; background-color:#17a2b8;">ğŸ“¥ è¯»å–</button>
                    
                    <button onclick="window.renameCommentLibrary('${item.id}')" class="sidebar-button" style="padding:3px 8px; font-size:0.8em; background-color:#fd7e14;">âœï¸ é‡å‘½å</button>
                    
                    <button onclick="window.deleteCommentLibrary('${item.id}')" class="sidebar-button" style="padding:3px 8px; font-size:0.8em; background-color:#fff; color:#dc3545; border:1px solid #dc3545;">åˆ é™¤</button>
                </div>
            </div>
        `).join('');
    };

    // 3. å­˜æ¡£æ“ä½œ (Save/Load/Delete)
    document.getElementById('btn-save-library').addEventListener('click', async () => {
        const rows = document.querySelectorAll('.comment-row');
        if (rows.length === 0) return;
        const name = prompt("è¯·è¾“å…¥å­˜æ¡£åç§° (ä¾‹å¦‚ï¼š2024ç§‹-æœŸæœ«è¯„è¯­):", "  è¯„è¯­å­˜æ¡£");
        if (!name) return;

        const dataToSave = {};
        rows.forEach(row => {
            const rec = JSON.parse(decodeURIComponent(row.dataset.history));
            dataToSave[rec.info.id] = {
                daily: row.querySelector('.daily-input').value,
                comment: row.querySelector('.result-textarea').value
            };
        });

        let library = await localforage.getItem('G_Comment_Library') || [];
        library.unshift({
            id: Date.now().toString(),
            name: name,
            date: new Date().toLocaleString(),
            count: Object.keys(dataToSave).length,
            data: dataToSave
        });
        await localforage.setItem('G_Comment_Library', library);
        renderLibraryList();
        alert("âœ… å­˜æ¡£æˆåŠŸï¼");
    });

    window.loadCommentLibrary = async (id) => {
        if (!confirm("ç¡®å®šè¯»å–è¯¥å­˜æ¡£å—ï¼Ÿå½“å‰è¡¨æ ¼å†…å®¹å°†è¢«è¦†ç›–ã€‚")) return;
        const library = await localforage.getItem('G_Comment_Library') || [];
        const record = library.find(r => r.id === id);
        if (record) {
            const rows = document.querySelectorAll('.comment-row');
            let matchCount = 0;
            rows.forEach(row => {
                const rec = JSON.parse(decodeURIComponent(row.dataset.history));
                const saved = record.data[rec.info.id];
                if (saved) {
                    row.querySelector('.daily-input').value = saved.daily || "";
                    row.querySelector('.result-textarea').value = saved.comment || "";
                    matchCount++;
                }
            });
            alert(`âœ… å·²æ¢å¤ ${matchCount} æ¡æ•°æ®ã€‚`);
        }
    };

    window.deleteCommentLibrary = async (id) => {
        if (!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
        let library = await localforage.getItem('G_Comment_Library') || [];
        library = library.filter(r => r.id !== id);
        await localforage.setItem('G_Comment_Library', library);
        renderLibraryList();
    };

    //            å…¨å±€é‡å‘½åå‡½æ•°
    window.renameCommentLibrary = async (id) => {
        let library = await localforage.getItem('G_Comment_Library') || [];
        const item = library.find(r => r.id === id);

        if (!item) return;

        // å¼¹å‡ºè¾“å…¥æ¡†ï¼Œé»˜è®¤æ˜¾ç¤ºæ—§åç§°
        const newName = prompt("é‡å‘½åå­˜æ¡£:", item.name);

        // æ ¡éªŒè¾“å…¥
        if (newName === null || newName.trim() === "") return;

        // æ›´  åç§°å¹¶ä¿å­˜
        item.name = newName.trim();
        await localforage.setItem('G_Comment_Library', library);

        // åˆ·  åˆ—è¡¨
        renderLibraryList();
    };

    // --- æ ¸å¿ƒé€»è¾‘ï¼šæ¸²æŸ“è¡¨æ ¼ ---
    const renderTable = (className) => {
        const tbody = document.getElementById('comment-tbody');
        let rowsHtml = '';
        const classStudents = [];
        studentMap.forEach(record => {
            if (record.info.class === className) classStudents.push(record);
        });

        //    ä¿®æ”¹    æ ¹æ® currentSortMode è¿›è¡Œæ’åº
        if (currentSortMode === 'name') {
            // æŒ‰å§“åæ‹¼éŸ³æ’åº
            classStudents.sort((a, b) => a.info.name.localeCompare(b.info.name, 'zh-CN'));
        } else {
            // é»˜è®¤ï¼šæŒ‰æœ€  ä¸€æ¬¡è€ƒè¯•æ’åæ’åº
            classStudents.sort((a, b) => {
                const lastRankA = a.exams[a.exams.length - 1].rank || 9999;
                const lastRankB = b.exams[b.exams.length - 1].rank || 9999;
                return lastRankA - lastRankB;
            });
        }

        classStudents.forEach(record => {
            const exams = record.exams;
            const count = exams.length;
            let trendHtml = '<span style="color:#ccc">-</span>';

            if (count >= 2) {
                const ranks = exams.map(e => e.gradeRank || e.rank || 0);
                // å‡è®¾ calculateTrendSlope å‡½æ•°å·²å­˜åœ¨äº script.js åº•éƒ¨
                const slope = (typeof calculateTrendSlope === 'function') ? calculateTrendSlope(ranks) : 0;
                const trendScore = Math.round(slope * (count - 1) * -1);

                if (trendScore > 20) trendHtml = `<span class="progress">ğŸš€ å‡ ${trendScore}</span>`;
                else if (trendScore > 5) trendHtml = `<span class="progress" style="color:#20c997">ğŸ“ˆ å‡ ${trendScore}</span>`;
                else if (trendScore < -20) trendHtml = `<span class="regress">ğŸ“‰ é™ ${Math.abs(trendScore)}</span>`;
                else if (trendScore < -5) trendHtml = `<span class="regress" style="color:#fd7e14">ğŸ“‰ é™ ${Math.abs(trendScore)}</span>`;
                else trendHtml = `<span style="color:#007bff">âš–ï¸ ç¨³å®š</span>`;
            }

            const historyJson = encodeURIComponent(JSON.stringify(record));
            //    ä¿®æ”¹    ç›´æ¥æ˜¾ç¤ºæ–‡æœ¬ï¼Œå¹¶æ ¹æ®ç±»å‹ç»™ä¸€ç‚¹é¢œè‰²æç¤º (å¯é€‰)
            const tagsHtml = DAILY_TAGS.map(tag => {
                let colorStyle = '';
                if (tag.type === 'good') colorStyle = 'color: #28a745; border-color: #c3e6cb; background-color: #f0fff4;';
                if (tag.type === 'bad') colorStyle = 'color: #dc3545; border-color: #f5c6cb; background-color: #fff5f5;';
                if (tag.type === 'neutral') colorStyle = 'color: #6c757d; border-color: #d6d8db; background-color: #f8f9fa;';

                return `<span class="quick-tag" style="${colorStyle}" onclick="addTag(this, '${tag.text}')" title="${tag.text}">${tag.text}</span>`;
            }).join('');
            //const tagsHtml = DAILY_TAGS.map(tag => `<span class="quick-tag" onclick="addTag(this, '${tag.text}')" title="${tag.text}">${tag.text.split(' ')[1]}</span>`).join('');

            rowsHtml += `
                <tr class="comment-row" data-history="${historyJson}">
                    <td style="font-weight:bold;">${record.info.name}</td>
                    <td style="font-size:0.9em;">${trendHtml}</td>
                    <td style="vertical-align:top;">
                        <input type="text" class="daily-input sidebar-select" style="width:90%; margin-bottom:5px; font-size:0.9em;" placeholder="ä¾‹: ä¹äºåŠ©äºº...">
                        
                        <div style="display:flex; flex-wrap:wrap; gap:10px; max-height:200px; overflow-y:auto;">
                            ${tagsHtml}
                        </div>
                    </td>
                    <td style="padding:10px;">
                        <textarea class="result-textarea sidebar-select" style="width:100%; height:220px; border:1px solid #eee; resize:vertical; font-family:inherit; line-height:1.4;"></textarea>
                    </td>
                    <td>
                        <button class="btn-single-ai sidebar-button" style="font-size:1.2em; padding:8px 16px; background-color:#6f42c1;">ğŸ¤–</button>
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = rowsHtml;
        bindRowEvents();

        // æ›´  å›¾æ ‡çŠ¶æ€
        const sortIcon = document.getElementById('sort-icon');
        if (sortIcon) {
            sortIcon.style.color = currentSortMode === 'name' ? '#007bff' : '#ccc';
            sortIcon.innerText = currentSortMode === 'name' ? 'ğŸ”¤' : 'â‡…';
        }

    };

    // --- ç»‘å®šäº‹ä»¶ ---
    const classSelect = document.getElementById('comment-class-select');
    classSelect.addEventListener('change', () => renderTable(classSelect.value));
    if (classes.length > 0) renderTable(classes[0]);

    //            ç»‘å®šè¡¨å¤´ç‚¹å‡»æ’åº
    document.getElementById('th-sort-name').addEventListener('click', () => {
        // åˆ‡æ¢æ¨¡å¼
        currentSortMode = (currentSortMode === 'rank') ? 'name' : 'rank';
        // é‡  æ¸²æŸ“
        renderTable(classSelect.value);
    });

    // 5. å…¶ä»–æŒ‰é’®ç»‘å®š
    window.addTag = (span, text) => {
        const row = span.closest('td');
        const input = row.querySelector('input');
        const clean = text.replace(/^[^\s]+\s/, '');
        if (!input.value.includes(clean)) input.value = input.value ? input.value + "ï¼Œ" + clean : clean;
    };

    document.getElementById('btn-export-comments').addEventListener('click', exportCommentsToExcel);

    //    ä¿®æ”¹    è§„åˆ™ç”Ÿæˆ (æ”¯æŒå¤šæ¨¡å¼)
    document.getElementById('btn-gen-rule').addEventListener('click', () => {
        const mode = document.getElementById('comment-gen-mode').value; // è·å–å½“å‰æ¨¡å¼

        document.querySelectorAll('.comment-row').forEach(row => {
            const record = JSON.parse(decodeURIComponent(row.dataset.history));
            const dailyText = row.querySelector('.daily-input').value; // è·å–æ—¥å¸¸æ ‡ç­¾æ–‡æœ¬

            // è°ƒç”¨  çš„åˆ†æµå‡½æ•°
            const result = generateModeRuleComment(record, dailyText, mode);
            row.querySelector('.result-textarea').value = result;
        });
    });

    // æ‰¹é‡ AI
    let aiController = null;
    document.getElementById('btn-gen-ai-batch').addEventListener('click', async () => {
        const apiKey = localStorage.getItem('G_DeepSeekKey');
        if (!apiKey) { alert("è¯·å…ˆè®¾ç½® API Key"); return; }
        const rows = Array.from(document.querySelectorAll('.comment-row'));
        if (rows.length === 0) return;

        const mode = document.getElementById('comment-gen-mode').value;
        const modeText = document.getElementById('comment-gen-mode').selectedOptions[0].text;

        if (!confirm(`å³å°†æŒ‰ã€${modeText}ã€‘æ¨¡å¼ä¸º ${rows.length} äººç”Ÿæˆè¯„è¯­ã€‚\nç¡®å®šå—ï¼Ÿ`)) return;

        document.getElementById('ai-batch-progress').style.display = 'block';
        if (aiController) aiController.abort();
        aiController = new AbortController();
        let completed = 0;

        for (const row of rows) {
            if (aiController.signal.aborted) break;
            const record = JSON.parse(decodeURIComponent(row.dataset.history));
            const daily = row.querySelector('.daily-input').value || "";
            const textarea = row.querySelector('.result-textarea');

            document.getElementById('ai-progress-text').innerText = `ğŸ¤– æ­£åœ¨ç”Ÿæˆ: ${record.info.name} (${completed + 1}/${rows.length})`;

            try {
                const comment = await fetchMultiModeAIComment(apiKey, record, daily, mode, aiController.signal);
                textarea.value = comment;
                completed++;
                document.getElementById('ai-progress-bar').style.width = `${(completed / rows.length) * 100}%`;
                await new Promise(r => setTimeout(r, 600));
            } catch (e) { if (e.name !== 'AbortError') textarea.value = `[Error] ${e.message}`; }
        }
        if (!aiController.signal.aborted) {
            document.getElementById('ai-progress-text').innerText = "âœ… å®Œæˆï¼";
            setTimeout(() => document.getElementById('ai-batch-progress').style.display = 'none', 3000);
        }
    });

    // åœæ­¢/å…³é—­é€»è¾‘
    document.getElementById('btn-stop-ai').addEventListener('click', () => {
        if (aiController) { aiController.abort(); document.getElementById('ai-progress-text').innerText = "ğŸ›‘ å·²åœæ­¢"; }
    });
    document.getElementById('btn-close-progress').addEventListener('click', () => {
        if (aiController) aiController.abort();
        document.getElementById('ai-batch-progress').style.display = 'none';
    });
}

/**
 * 17.2 è¾…åŠ©ï¼šç»‘å®šè¡Œå†…æŒ‰é’®
 */
function bindRowEvents() {
    document.querySelectorAll('.btn-single-ai').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const row = e.target.closest('tr');
            const record = JSON.parse(decodeURIComponent(row.dataset.history));
            const dailyText = row.querySelector('.daily-input').value || "";
            const textarea = row.querySelector('.result-textarea');
            const mode = document.getElementById('comment-gen-mode').value; // è·å–å½“å‰æ¨¡å¼

            const apiKey = localStorage.getItem('G_DeepSeekKey');
            if (!apiKey) { alert("è¯·è®¾ç½® API Key"); return; }

            const originalText = e.target.innerText;
            e.target.innerText = "â³";
            e.target.disabled = true;

            try {
                const comment = await fetchMultiModeAIComment(apiKey, record, dailyText, mode);
                textarea.value = comment;
            } catch (err) {
                alert(err.message);
            } finally {
                e.target.innerText = originalText;
                e.target.disabled = false;
            }
        });
    });
}



/**
 * 17.3    AI ç”Ÿæˆé€»è¾‘ (æ”¯æŒ 4 ç§æ¨¡å¼)
 */
async function fetchMultiModeAIComment(apiKey, record, dailyInfo, mode, signal) {
    let promptContext = "";
    let promptInstruction = "";
    const exams = record.exams;
    const hasExams = exams && exams.length > 0;

    // --- æ¨¡å¼ 1: ç»¼åˆè¯„ä»· (Comprehensive) ---
    if (mode === 'comprehensive') {
        // æ„å»ºå†å²æˆç»©ä¸²
        let historyStr = hasExams ? exams.map((e, i) => `${i + 1}. ${e.label}: æ€»åˆ†${e.totalScore} (ç­æ’${e.rank || '-'})`).join('\n') : "ï¼ˆæš‚æ— è€ƒè¯•æ•°æ®ï¼‰";
        promptContext = `
ã€å­¦ä¹ æ•°æ®ã€‘ï¼š
${historyStr}
ã€æ—¥å¸¸è¡¨ç°ã€‘ï¼š
${dailyInfo || "ï¼ˆè¡¨ç°ä¸­è§„ä¸­çŸ©ï¼‰"}
        `;
        promptInstruction = `è¯·ç»“åˆã€å­¦ä¹ æˆç»©å˜åŒ–è¶‹åŠ¿ã€‘å’Œã€æ—¥å¸¸è¡¨ç°ã€‘ï¼Œå†™ä¸€æ®µæœŸæœ«ç»¼åˆè¯„è¯­ã€‚å­¦ä¹ å’Œç”Ÿæ´»æ¯”é‡å„å 50%ã€‚å°†ä¸¤è€…è‡ªç„¶èåˆã€‚`;
    }

    // --- æ¨¡å¼ 2: ä»…å†å²è¶‹åŠ¿ (History Only) ---
    else if (mode === 'history_only') {
        let historyStr = hasExams ? exams.map((e, i) => `${i + 1}. ${e.label}: æ€»åˆ†${e.totalScore} (å¹´æ’${e.gradeRank || '-'}, ç­æ’${e.rank || '-'})`).join('\n') : "ï¼ˆæš‚æ— æ•°æ®ï¼‰";
        promptContext = `ã€å†æ¬¡è€ƒè¯•æ•°æ®ã€‘ï¼š\n${historyStr}`;
        promptInstruction = `è¯·ä»…æ ¹æ®ã€å†æ¬¡æˆç»©å˜åŒ–è¶‹åŠ¿ã€‘ï¼Œç‚¹è¯„å…¶å­¦ä¹ çŠ¶æ€çš„ç¨³å®šæ€§æˆ–è¿›é€€æ­¥æƒ…å†µï¼Œç»™å‡ºé’ˆå¯¹æ€§çš„å­¦ä¹ å»ºè®®ã€‚å¿½ç•¥ç”Ÿæ´»è¡¨ç°ã€‚`;
    }

    // --- æ¨¡å¼ 3: ä»…æœ¬æ¬¡æˆç»© (Current Only) ---
    else if (mode === 'current_only') {
        let currentStr = "ï¼ˆæ— æ•°æ®ï¼‰";
        if (hasExams) {
            const last = exams[exams.length - 1];
            currentStr = `è€ƒè¯•åç§°ï¼š${last.label}\næ€»åˆ†ï¼š${last.totalScore}\nç­çº§æ’åï¼š${last.rank}\nå¹´çº§æ’åï¼š${last.gradeRank || '-'}`;
        }
        promptContext = `ã€æœ¬æ¬¡è€ƒè¯•æ•°æ®ã€‘ï¼š\n${currentStr}`;
        promptInstruction = `è¯·ä»…é’ˆå¯¹ã€æœ¬æ¬¡è€ƒè¯•ã€‘çš„å‘æŒ¥æƒ…å†µè¿›è¡Œç‚¹è¯„ã€‚ä¸è¦æåŠä¹‹å‰çš„è€ƒè¯•ï¼Œä¹Ÿä¸è¦æåŠç”Ÿæ´»è¡¨ç°ã€‚`;
    }

    // --- æ¨¡å¼ 4: ä»…æ—¥å¸¸è¡¨ç° (Daily Only) ---
    else if (mode === 'daily_only') {
        promptContext = `ã€æ—¥å¸¸è¡¨ç°å…³é”®è¯ã€‘ï¼š\n${dailyInfo || "éµå®ˆçºªå¾‹ï¼Œå°Šæ•¬å¸ˆé•¿"}`;
        promptInstruction = `è¯·ä»…æ ¹æ®ã€æ—¥å¸¸è¡¨ç°å…³é”®è¯ã€‘ï¼Œæ‰©å†™æˆä¸€æ®µç”ŸåŠ¨çš„å¾·è‚²è¯„è¯­ã€‚é‡ç‚¹æè¿°æ€§æ ¼ã€å“å¾·å’Œä¹ æƒ¯ã€‚å¿½ç•¥æˆç»©æ•°æ®ã€‚`;
    }

    const prompt = `
ä½ æ˜¯ä¸€ä½æ¸©æš–ã€ä¸“ä¸šçš„ç­ä¸»ä»»ã€‚è¯·ä¸ºå­¦ç”Ÿã€${record.info.name}ã€‘å†™è¯„è¯­ã€‚
${promptContext}

ã€å†™ä½œè¦æ±‚ã€‘ï¼š
1. ${promptInstruction}
2. è¯­æ°”äº²åˆ‡ï¼Œä½¿ç”¨ç¬¬äºŒäººç§°â€œä½ â€ã€‚
3. å­—æ•°æ§åˆ¶åœ¨ 80-120 å­—ã€‚
4. ä¸è¦å‡ºç°â€œæ ¹æ®æ•°æ®â€ã€â€œå¦‚å›¾æ‰€ç¤ºâ€ç­‰æœºæ¢°è¯­è¨€ã€‚
    `.trim();

    const response = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        signal: signal,
        body: JSON.stringify({
            model: 'deepseek-chat',
            messages: [{ role: "user", content: prompt }],
            temperature: 0.7
        })
    });

    if (!response.ok) throw new Error("API Error");
    const data = await response.json();
    return data.choices[0].message.content.trim();
}

/**
 * 17.5 å¯¼å‡º
 */
function exportCommentsToExcel() {
    const className = document.getElementById('comment-class-select').value;
    const rows = Array.from(document.querySelectorAll('.comment-row'));
    const data = [];
    data.push(["ç­çº§", "å§“å", "æ—¥å¸¸æ ‡ç­¾", "æœ€ç»ˆè¯„è¯­"]);
    rows.forEach(row => {
        const record = JSON.parse(decodeURIComponent(row.dataset.history));
        const daily = row.querySelector('.daily-input').value;
        const comment = row.querySelector('.result-textarea').value;
        data.push([record.info.class, record.info.name, daily, comment]);
    });
    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [{ wch: 10 }, { wch: 10 }, { wch: 30 }, { wch: 80 }];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "è¯„è¯­");
    XLSX.writeFile(wb, `${className}_è¯„è¯­è¡¨.xlsx`);
}

// =====================================================================
//    NEW    å¤šæ¨¡å¼è§„åˆ™è¯„è¯­ç”Ÿæˆå¼•æ“
// =====================================================================

/**
 * æ€»å…¥å£ï¼šæ ¹æ®æ¨¡å¼åˆ†å‘é€»è¾‘
 */
function generateModeRuleComment(record, dailyText, mode) {
    switch (mode) {
        case 'history_only':
            return generateHistoryRuleComment(record); // (å¤ç”¨åŸæœ‰é€»è¾‘)
        case 'current_only':
            return generateCurrentRuleComment(record); // (    )
        case 'daily_only':
            return generateDailyRuleComment(record, dailyText); // (    )
        case 'comprehensive':
        default:
            return generateComprehensiveRuleComment(record, dailyText); // (    )
    }
}

/**
 * 1. [ä»…å†å²] (è¿™æ˜¯æ‚¨åŸæœ‰çš„é€»è¾‘ï¼Œç¨å¾®ä¼˜åŒ–)
 */
function generateHistoryRuleComment(record) {
    const exams = record.exams;
    if (!exams || exams.length === 0) return "æš‚æ— è€ƒè¯•æ•°æ®ã€‚";

    const name = record.info.name;
    const count = exams.length;
    const first = exams[0].gradeRank || exams[0].rank;
    const last = exams[count - 1].gradeRank || exams[count - 1].rank;
    const diff = first - last;

    let text = `æœ¬å­¦æœŸ ${name} åŒå­¦å…±å‚åŠ äº† ${count} æ¬¡å¤§è€ƒã€‚`;

    if (diff > 20) text += `æˆç»©å‘ˆç°æ˜¾è‘—çš„ä¸Šå‡è¶‹åŠ¿ï¼Œæ’åä»æœŸåˆçš„ ${first} åè¿›æ­¥è‡³æœŸæœ«çš„ ${last} åï¼Œè¿›æ­¥å¹…åº¦å¾ˆå¤§ï¼Œå€¼å¾—è¡¨æ‰¬ã€‚`;
    else if (diff > 5) text += `æˆç»©ç¨³ä¸­æœ‰å‡ï¼Œæ’åè¾ƒæœŸåˆè¿›æ­¥äº† ${diff} åï¼Œå­¦ä¹ çŠ¶æ€æ¸å…¥ä½³å¢ƒã€‚`;
    else if (diff < -20) text += `æˆç»©å‡ºç°äº†ä¸€å®šå¹…åº¦çš„ä¸‹æ»‘ï¼Œæ’åä» ${first} åé€€è‡³ ${last} åï¼Œå»ºè®®å‡æœŸå¥½å¥½è°ƒæ•´çŠ¶æ€ï¼ŒæŸ¥ç¼ºè¡¥æ¼ã€‚`;
    else text += `æˆç»©ä¿æŒç›¸å¯¹ç¨³å®šï¼Œæ’åå§‹ç»ˆç»´æŒåœ¨ ${last} åå·¦å³ï¼ŒåŸºç¡€è¾ƒä¸ºæ‰å®ã€‚`;

    return text;
}

/**
 * 2. [ä»…æœ¬æ¬¡] åªå…³æ³¨æœ€åä¸€æ¬¡è€ƒè¯•
 */
function generateCurrentRuleComment(record) {
    const exams = record.exams;
    if (!exams || exams.length === 0) return "æš‚æ— æœ¬æ¬¡è€ƒè¯•æ•°æ®ã€‚";

    const lastExam = exams[exams.length - 1]; // å–æœ€åä¸€æ¬¡
    const rank = lastExam.gradeRank || lastExam.rank;
    const score = lastExam.totalScore;
    const name = record.info.name;

    let text = `åœ¨æœ¬æ¬¡${lastExam.label}ä¸­ï¼Œ${name} åŒå­¦å–å¾—äº†æ€»åˆ† ${score} åˆ†ï¼Œå¹´çº§æ’å ${rank} åçš„æˆç»©ã€‚`;

    // ç®€å•æ’ä½åˆ¤æ–­ (å‡è®¾å¹´æ®µäººæ•° 500ï¼Œå¯æ ¹æ®å®é™…è°ƒæ•´)
    if (rank <= 50) text += ` è¡¨ç°éå¸¸ä¼˜å¼‚ï¼Œååˆ—å¹´æ®µå‰èŒ…ï¼Œå±•ç°äº†æ‰å®çš„å­¦ç§‘åŠŸåº•ã€‚`;
    else if (rank <= 150) text += ` æˆç»©è‰¯å¥½ï¼Œå¤„äºå¹´æ®µä¸Šæ¸¸æ°´å¹³ï¼Œè‹¥èƒ½è¡¥é½å¼±é¡¹ï¼Œå†²å‡»é¡¶å°–æŒ‡æ—¥å¯å¾…ã€‚`;
    else if (rank <= 350) text += ` æˆç»©å¤„äºä¸­æ¸¸ï¼ŒåŸºç¡€å°šå¯ï¼Œä½†éƒ¨åˆ†å­¦ç§‘å­˜åœ¨å¤±åˆ†ç‚¹ï¼Œéœ€è¦æ›´æœ‰é’ˆå¯¹æ€§çš„ç»ƒä¹ ã€‚`;
    else text += ` æˆç»©æš‚æ—¶ä¸ç†æƒ³ï¼ŒåŸºç¡€çŸ¥è¯†æŒæ¡ä¸å¤Ÿç‰¢å›ºï¼Œå¸Œæœ›ä½ èƒ½æ­£è§†å·®è·ï¼Œå¥‹èµ·ç›´è¿½ã€‚`;

    text += ` å¸Œæœ›ä½ èƒ½èƒœä¸éª„è´¥ä¸é¦ï¼Œåœ¨æ¥ä¸‹æ¥çš„å­¦ä¹ ä¸­ç»§ç»­åŠªåŠ›ã€‚`;
    return text;
}

/**
 * 3. [ä»…æ—¥å¸¸] æ ¹æ®å…³é”®è¯ç”Ÿæˆå¾·è‚²è¯„è¯­
 */
function generateDailyRuleComment(record, dailyText) {
    const name = record.info.name;
    if (!dailyText || dailyText.trim() === "") {
        return `${name} åŒå­¦åœ¨æ ¡è¡¨ç°ä¸­è§„ä¸­çŸ©ï¼Œéµå®ˆçºªå¾‹ï¼Œå°Šæ•¬å¸ˆé•¿ï¼Œä¸åŒå­¦ç›¸å¤„èæ´½ã€‚å¸Œæœ›ä»Šåèƒ½æ›´åŠ ç§¯æä¸»åŠ¨åœ°å‚ä¸ç­çº§æ´»åŠ¨ã€‚`;
    }

    let text = `${name} åŒå­¦åœ¨æ ¡æœŸé—´è¡¨ç°`;

    // ç®€å•çš„å…³é”®è¯åŒ¹é…é€»è¾‘
    if (dailyText.includes("ç§¯æ") || dailyText.includes("ä¼˜") || dailyText.includes("å¼º")) {
        text += `éå¸¸ç§¯æã€‚`;
    } else if (dailyText.includes("å·®") || dailyText.includes("æ‹–æ‹‰")) {
        text += `æœ‰å¾…åŠ å¼ºã€‚`;
    } else {
        text += `è‰¯å¥½ã€‚`;
    }

    // å°†è¾“å…¥çš„å…³é”®è¯ä¸²è”èµ·æ¥
    text += ` è€å¸ˆæ³¨æ„åˆ°ä½ ï¼š${dailyText}ã€‚`;

    // æ ¹æ®å…³é”®è¯ç»™å»ºè®®
    if (dailyText.includes("èµ°ç¥") || dailyText.includes("è®²è¯")) {
        text += ` å¸Œæœ›ä½ èƒ½æ”¹æ‰ä¸Šè¯¾æ³¨æ„åŠ›ä¸é›†ä¸­çš„å°æ¯›ç—…ï¼Œæé«˜è¯¾å ‚æ•ˆç‡ã€‚`;
    } else if (dailyText.includes("å†…å‘") || dailyText.includes("è‡ªä¿¡")) {
        text += ` å¸Œæœ›ä½ ä»Šåèƒ½æ›´åŠ è‡ªä¿¡ï¼Œå¤šä¸è€å¸ˆåŒå­¦äº¤æµï¼Œå±•ç°æ›´æ£’çš„è‡ªå·±ã€‚`;
    } else if (dailyText.includes("åŠ©äºº") || dailyText.includes("åŠ³åŠ¨")) {
        text += ` è¿™ç§ä¹äºå¥‰çŒ®çš„ç²¾ç¥å€¼å¾—æ‰€æœ‰åŒå­¦å­¦ä¹ ï¼Œä½ æ˜¯è€å¸ˆå¾—åŠ›çš„å°åŠ©æ‰‹ã€‚`;
    } else {
        text += ` å¸Œæœ›ä½ ç»§ç»­ä¿æŒä¼˜ç‚¹ï¼Œæ”¹æ‰ä¸è¶³ï¼Œåšæ›´å¥½çš„è‡ªå·±ã€‚`;
    }

    return text;
}

/**
 * 4. [ç»¼åˆ] å†å²è¶‹åŠ¿ + æ—¥å¸¸è¡¨ç° (å„å–ä¸€åŠ)
 */
function generateComprehensiveRuleComment(record, dailyText) {
    // 1. è·å–æˆç»©éƒ¨åˆ†
    const exams = record.exams;
    let scorePart = "";
    if (exams && exams.length >= 2) {
        const first = exams[0].gradeRank || exams[0].rank;
        const last = exams[exams.length - 1].gradeRank || exams[exams.length - 1].rank;
        const diff = first - last;
        if (diff > 0) scorePart = `æœ¬å­¦æœŸæˆç»©ç¨³æ­¥æå‡ï¼Œæ’åè¿›æ­¥äº† ${diff} åï¼Œè¿™ä¸ä½ çš„åŠªåŠ›åˆ†ä¸å¼€ã€‚`;
        else if (diff < 0) scorePart = `æœ¬å­¦æœŸæˆç»©ç•¥æœ‰èµ·ä¼ï¼Œæ’åæœ‰æ‰€ä¸‹æ»‘ï¼Œéœ€è¦åæ€å­¦ä¹ æ–¹æ³•ã€‚`;
        else scorePart = `æœ¬å­¦æœŸæˆç»©ä¿æŒç¨³å®šï¼ŒåŸºç¡€è¾ƒä¸ºæ‰å®ã€‚`;
    } else {
        scorePart = `æœ¬å­¦æœŸå­¦ä¹ æ€åº¦ç«¯æ­£ï¼Œèƒ½æŒ‰æ—¶å®Œæˆå­¦ä¹ ä»»åŠ¡ã€‚`;
    }

    // 2. è·å–æ—¥å¸¸éƒ¨åˆ†
    let dailyPart = "";
    if (dailyText) {
        dailyPart = `åœ¨ç”Ÿæ´»ä¸­ï¼Œä½ ${dailyText}ã€‚`;
    } else {
        dailyPart = `åœ¨ç”Ÿæ´»ä¸­ï¼Œä½ å°Šæ•¬å¸ˆé•¿ï¼Œå›¢ç»“åŒå­¦ï¼Œéµå®ˆæ ¡çºªæ ¡è§„ã€‚`;
    }

    // 3. æ‹¼æ¥
    return `${record.info.name} åŒå­¦ï¼š${scorePart}${dailyPart} å¸Œæœ›ä½ åœ¨  çš„å­¦æœŸé‡Œï¼Œèƒ½å¤Ÿå‘æ‰¬ä¼˜ç‚¹ï¼Œå¼¥è¡¥ä¸è¶³ï¼Œå‘ç€æ›´é«˜çš„ç›®æ ‡è¿ˆè¿›ï¼`;
}


/**
 * [æ•°å­¦æ ¸å¿ƒ] è®¡ç®—çº¿æ€§å›å½’æ–œç‡ (Linear Regression Slope)
 * ç”¨äºè¯„ä¼°æˆç»©çš„å¹³å‡èµ°åŠ¿
 * @param {Array} values - æ’åæ•°ç»„ (yè½´)
 * @returns {Number} - æ–œç‡ (Slope)ã€‚è´Ÿæ•°ä»£è¡¨æ•°å€¼å˜å°(æ’åè¿›æ­¥)ï¼Œæ­£æ•°ä»£è¡¨æ•°å€¼å˜å¤§(é€€æ­¥)
 */
function calculateTrendSlope(values) {
    const n = values.length;
    if (n < 2) return 0;

    let sumX = 0;   // è€ƒè¯•æ¬¡åºä¹‹å’Œ (0+1+2...)
    let sumY = 0;   // æ’åä¹‹å’Œ
    let sumXY = 0;  // æ¬¡åº*æ’å ä¹‹å’Œ
    let sumXX = 0;  // æ¬¡åºå¹³æ–¹ ä¹‹å’Œ

    for (let i = 0; i < n; i++) {
        const x = i;        // xè½´ï¼šæ—¶é—´/æ¬¡åº
        const y = values[i]; // yè½´ï¼šæ’å

        sumX += x;
        sumY += y;
        sumXY += x * y;
        sumXX += x * x;
    }

    // æ–œç‡å…¬å¼: (nÎ£xy - Î£xÎ£y) / (nÎ£xÂ² - (Î£x)Â²)
    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
    return slope;
}



// =====================================================================
//    NEW    æ¨¡å—åå…«ï¼šä¸ªæ€§åŒ–é”™é¢˜/è–„å¼±ç‚¹â€œæ”»åšæœ¬â€ç”Ÿæˆå™¨
// =====================================================================

/**
 * 18.1 æ¸²æŸ“ä¸»ç•Œé¢ (å·²å‡çº§ï¼šæ‰¹é‡ AI ç”Ÿæˆ)
 */
function renderWeaknessWorkbook(container) {
    // 1. æ£€æŸ¥æ•°æ®æº
    if (!G_ItemAnalysisData || Object.keys(G_ItemAnalysisData).length === 0) {
        container.innerHTML = `<div class="main-card-wrapper" style="text-align:center; padding:50px; color:#666;">âš ï¸ è¯·å…ˆå‰å¾€â€œå­¦ç§‘å°é¢˜åˆ†æâ€å¯¼å…¥æ•°æ®ã€‚</div>`;
        return;
    }

    const subjects = Object.keys(G_ItemAnalysisData);

    container.innerHTML = `
        <h2>ğŸ“ æ¨¡å—åå…«ï¼šä¸ªæ€§åŒ–é”™é¢˜æ”»åšæœ¬ç”Ÿæˆå™¨</h2>
        <p style="color: var(--text-muted); margin-top:-10px;">
            è‡ªåŠ¨ç­›é€‰å­¦ç”Ÿçš„è–„å¼±é¢˜ç›®ï¼Œæ”¯æŒ AI æ‰¹é‡ç”ŸæˆåŒç±»å˜å¼é¢˜ï¼Œä¸€é”®æ‰“å°ä¸“å±è®¢æ­£å•ã€‚
        </p>
        <p style="color: var(--text-muted); margin-top:-10px;">
            é¢˜ç›®ä¸ºAi ç”Ÿæˆï¼Œè¯·ä»”ç»†ç”„åˆ«æ˜¯å¦æœ‰é”™è¯¯ï¼ï¼ï¼
        </p>

        <div class="main-card-wrapper" style="border-left: 5px solid #fd7e14;">
            <h4 style="margin-top:0;">ğŸ› ï¸ ç”Ÿæˆé…ç½®</h4>
            <div class="controls-bar" style="background: transparent; box-shadow: none; padding: 0; flex-wrap: wrap;">
                
                <label>é€‰æ‹©ç§‘ç›®:</label>
                <select id="wb-subject-select" class="sidebar-select" style="width:auto; min-width:120px;">
                    ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                </select>

                <label style="margin-left:15px;">é€‰æ‹©ç­çº§:</label>
                <select id="wb-class-select" class="sidebar-select" style="width:auto; min-width:120px;">
                    <option value="ALL">-- å…¨ä½“ --</option>
                </select>

                <label style="margin-left:15px;">è–„å¼±é˜ˆå€¼:</label>
                <select id="wb-threshold" class="sidebar-select" style="width:auto;">
                    <option value="0.6" selected>å¾—åˆ†ç‡ < 60% (ä¸åŠæ ¼)</option>
                    <option value="0.8">å¾—åˆ†ç‡ < 80% (éä¼˜ç§€)</option>
                    <option value="1.0">æ‰€æœ‰é”™é¢˜ (å¾—åˆ† < æ»¡åˆ†)</option>
                </select>

                <button id="btn-gen-workbook" class="sidebar-button" style="background-color: #fd7e14; margin-left: 15px;">
                    ğŸ“„ ç”Ÿæˆé¢„è§ˆåˆ—è¡¨
                </button>
                
                <button id="btn-batch-ai-workbook" class="sidebar-button" style="background-color: #6f42c1; margin-left: 10px; display:none;">
                    ğŸ¤– æ‰¹é‡ç”Ÿæˆå˜å¼é¢˜
                </button>

                <button id="btn-print-workbook" class="sidebar-button" style="background-color: var(--color-blue); margin-left: 10px; display:none;">
                    ğŸ–¨ï¸ æ‰¹é‡æ‰“å°æ”»åšæœ¬
                </button>
            </div>
            
            <div id="wb-batch-progress" style="display:none; margin-top:15px; background:#f8f9fa; padding:10px; border-radius:6px; border:1px solid #eee;">
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.9em; margin-bottom:5px;">
                    <span id="wb-progress-text" style="font-weight:bold; color:#555;">AI ç”Ÿæˆä¸­... (0/0)</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button id="btn-stop-wb-ai" style="border:none; background:none; color:#dc3545; cursor:pointer; font-weight:bold;">â¹ åœæ­¢</button>
                        <button id="btn-close-wb-progress" style="border:none; background:none; color:#999; cursor:pointer; font-size:1.2em; line-height:1;">&times;</button>
                    </div>
                </div>
                <div style="width:100%; background:#e9ecef; height:8px; border-radius:4px; overflow:hidden;">
                    <div id="wb-progress-bar" style="width:0%; height:100%; background:#6f42c1; transition:width 0.3s;"></div>
                </div>
            </div>
        </div>

        <div id="wb-preview-area" class="main-card-wrapper" style="display:none;">
            <div style="margin-bottom:10px; font-weight:bold; color:#555;">
                å…±ç­›é€‰å‡º <span id="wb-student-count" style="color:#fd7e14;">0</span> åå­¦ç”Ÿæœ‰è–„å¼±é¢˜ï¼Œ
                ç´¯è®¡ <span id="wb-question-total" style="color:#fd7e14;">0</span> é“é”™é¢˜ã€‚
            </div>
            <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                <table id="wb-preview-table">
                    <thead>
                        <tr>
                            <th style="width:80px;">å§“å</th>
                            <th style="width:80px;">è–„å¼±é¢˜æ•°</th>
                            <th>è–„å¼±é¢˜ç›®è¯¦æƒ… (é¢˜å· / çŸ¥è¯†ç‚¹ / å¾—åˆ†ç‡)</th>
                            <th style="width:100px;">AI çŠ¶æ€</th>
                            <th style="width:120px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="wb-preview-tbody"></tbody>
                </table>
            </div>
        </div>
    `;

    // 2. ç»‘å®šåŸºç¡€äº‹ä»¶
    const subjectSelect = document.getElementById('wb-subject-select');
    const classSelect = document.getElementById('wb-class-select');

    const updateClassList = () => {
        const sub = subjectSelect.value;
        if (!sub || !G_ItemAnalysisData[sub]) return;
        const students = G_ItemAnalysisData[sub].students;
        const classes = [...new Set(students.map(s => s.class))].sort();
        classSelect.innerHTML = `<option value="ALL">-- å…¨ä½“ --</option>` + classes.map(c => `<option value="${c}">${c}</option>`).join('');
    };
    subjectSelect.addEventListener('change', updateClassList);
    updateClassList();

    let workbookData = []; // æ•°æ®ç¼“å­˜

    document.getElementById('btn-gen-workbook').addEventListener('click', () => {
        const subject = subjectSelect.value;
        const className = classSelect.value;
        const threshold = parseFloat(document.getElementById('wb-threshold').value);
        workbookData = calculateWeaknessWorkbook(subject, className, threshold);
        renderWorkbookPreview(workbookData); // è¿™é‡Œä¼šæ§åˆ¶æŒ‰é’®æ˜¾ç¤º
    });

    document.getElementById('btn-print-workbook').addEventListener('click', () => {
        if (workbookData.length === 0) return;
        const subject = subjectSelect.value;
        if (workbookData.length > 20 && !confirm(`å³å°†ç”Ÿæˆ ${workbookData.length} ä»½æ”»åšæœ¬ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) return;
        printWorkbook(workbookData, subject);
    });

    // ============================================================
    //    NEW    æ‰¹é‡ AI ç”Ÿæˆé€»è¾‘
    // ============================================================
    let wbAiController = null;

    document.getElementById('btn-batch-ai-workbook').addEventListener('click', async () => {
        const apiKey = localStorage.getItem('G_DeepSeekKey');
        if (!apiKey) { alert("è¯·å…ˆåœ¨ã€AI æ™ºèƒ½åˆ†æã€‘æ¨¡å—è®¾ç½® API Keyï¼"); return; }

        // ç­›é€‰å‡ºè¿˜æ²¡ç”Ÿæˆçš„å­¦ç”Ÿ
        const pendingItems = workbookData.map((item, index) => ({ item, index })).filter(obj => !obj.item.aiExercises);

        if (pendingItems.length === 0) {
            alert("å½“å‰åˆ—è¡¨ä¸­æ‰€æœ‰å­¦ç”Ÿå‡å·²ç”Ÿæˆå˜å¼é¢˜ï¼Œæ— éœ€é‡å¤ç”Ÿæˆã€‚");
            return;
        }

        if (!confirm(`å³å°†ä¸º ${pendingItems.length} ä½å­¦ç”Ÿæ‰¹é‡ç”Ÿæˆå˜å¼é¢˜ã€‚\nè¿™éœ€è¦æ¶ˆè€— Token å¹¶èŠ±è´¹ä¸€å®šæ—¶é—´ã€‚\n\nç¡®å®šå¼€å§‹å—ï¼Ÿ`)) return;

        // UI åˆå§‹åŒ–
        const progressBox = document.getElementById('wb-batch-progress');
        const progressBar = document.getElementById('wb-progress-bar');
        const progressText = document.getElementById('wb-progress-text');
        progressBox.style.display = 'block';

        if (wbAiController) wbAiController.abort();
        wbAiController = new AbortController();

        let completed = 0;
        const subject = subjectSelect.value;

        for (const obj of pendingItems) {
            if (wbAiController.signal.aborted) break;

            const { item, index } = obj;
            const studentName = item.student.name;

            // æå–çŸ¥è¯†ç‚¹
            const kps = [...new Set(item.questions.map(q => q.kp).filter(k => k && k !== 'æœªæ ‡è®°'))];

            if (kps.length === 0) {
                completed++; // æ²¡çŸ¥è¯†ç‚¹è·³è¿‡ï¼Œä¹Ÿç®—è¿›åº¦
                continue;
            }

            progressText.innerText = `ğŸ¤– æ­£åœ¨å‡ºé¢˜: ${studentName} (${completed + 1}/${pendingItems.length})`;

            // è§†è§‰ä¸Šå®šä½åˆ°è¯¥è¡Œ (å¯é€‰)
            const row = document.getElementById(`wb-row-${index}`);
            if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });

            try {
                const exercises = await fetchAIExercises(apiKey, studentName, kps, subject); // å¤ç”¨ä¹‹å‰çš„å‡½æ•°
                item.aiExercises = exercises; // ä¿å­˜æ•°æ®

                // æ›´  è¡¨æ ¼çŠ¶æ€ UI
                if (row && row.cells[3]) {
                    row.cells[3].innerHTML = `<span style="color:#28a745; font-size:0.8em;">âœ… å·²ç”Ÿæˆ</span>`;
                }

                completed++;
                progressBar.style.width = `${(completed / pendingItems.length) * 100}%`;

                // å»¶æ—¶é˜²å°
                await new Promise(r => setTimeout(r, 800));

            } catch (err) {
                if (row && row.cells[3]) row.cells[3].innerHTML = `<span style="color:red; font-size:0.8em;">âŒ å¤±è´¥</span>`;
            }
        }

        if (!wbAiController.signal.aborted) {
            progressText.innerText = "âœ… æ‰¹é‡ä»»åŠ¡å®Œæˆï¼";
            setTimeout(() => { progressBox.style.display = 'none'; }, 3000);
        }
    });

    // åœæ­¢ä¸å…³é—­
    document.getElementById('btn-stop-wb-ai').addEventListener('click', () => {
        if (wbAiController) {
            wbAiController.abort();
            document.getElementById('wb-progress-text').innerText = "ğŸ›‘ å·²åœæ­¢";
        }
    });
    document.getElementById('btn-close-wb-progress').addEventListener('click', () => {
        if (wbAiController) wbAiController.abort();
        document.getElementById('wb-batch-progress').style.display = 'none';
    });
}

/**
 * 18.2 è®¡ç®—é€»è¾‘ï¼šç­›é€‰è–„å¼±é¢˜
 */
function calculateWeaknessWorkbook(subject, className, threshold) {
    const itemData = G_ItemAnalysisData[subject];
    const itemConfig = G_ItemAnalysisConfig[subject] || {};
    const recalculatedStats = getRecalculatedItemStats(subject); // å¤ç”¨æ¨¡å—13çš„è®¡ç®—é€»è¾‘

    let students = itemData.students;
    if (className !== 'ALL') {
        students = students.filter(s => s.class === className);
    }

    const result = [];

    students.forEach(student => {
        const weakQuestions = [];

        // éå†å°é¢˜
        (recalculatedStats.minorQuestions || []).forEach(qName => {
            checkQuestion(student, qName, 'minorScores', recalculatedStats.minorStats, itemConfig, threshold, weakQuestions);
        });

        // éå†å¤§é¢˜
        (recalculatedStats.majorQuestions || []).forEach(qName => {
            checkQuestion(student, qName, 'majorScores', recalculatedStats.majorStats, itemConfig, threshold, weakQuestions);
        });

        if (weakQuestions.length > 0) {
            result.push({
                student: student,
                questions: weakQuestions
            });
        }
    });

    return result;
}

// è¾…åŠ©ï¼šæ£€æŸ¥å•é¢˜æ˜¯å¦è–„å¼±
function checkQuestion(student, qName, scoreType, statsObj, configObj, threshold, targetArray) {
    const score = student[scoreType][qName];
    const stat = statsObj[qName];
    const config = configObj[qName] || {};

    // è·å–æ­£ç¡®æ»¡åˆ†
    const fullScore = config.fullScore || stat.maxScore;
    const kp = config.content || ""; // çŸ¥è¯†ç‚¹

    if (typeof score === 'number' && !isNaN(score) && fullScore > 0) {
        const rate = score / fullScore;

        // åˆ¤æ–­æ˜¯å¦ä½äºé˜ˆå€¼
        // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœ thresholdæ˜¯1.0ï¼Œåªè¦ score < fullScore å°±ç®—é”™é¢˜
        let isWeak = false;
        if (threshold >= 0.99) {
            isWeak = score < fullScore;
        } else {
            isWeak = rate < threshold;
        }

        if (isWeak) {
            targetArray.push({
                qName: qName,
                kp: kp,
                score: score,
                full: fullScore,
                rate: rate
            });
        }
    }
}

/**
 * 18.3 æ¸²æŸ“é¢„è§ˆè¡¨æ ¼ (å·²å‡çº§ï¼šå…³è”æ‰¹é‡æŒ‰é’®)
 */
function renderWorkbookPreview(data) {
    const container = document.getElementById('wb-preview-area');
    const tbody = document.getElementById('wb-preview-tbody');
    const printBtn = document.getElementById('btn-print-workbook');
    const batchAiBtn = document.getElementById('btn-batch-ai-workbook'); //   
    const countEl = document.getElementById('wb-student-count');
    const totalEl = document.getElementById('wb-question-total');

    container.style.display = 'block';

    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">å½“å‰æ¡ä»¶ä¸‹æ²¡æœ‰å­¦ç”Ÿéœ€è¦ç”Ÿæˆæ”»åšæœ¬ã€‚</td></tr>`;
        printBtn.style.display = 'none';
        batchAiBtn.style.display = 'none'; // Hide
        return;
    }

    printBtn.style.display = 'inline-block';
    batchAiBtn.style.display = 'inline-block'; // Show

    let totalQ = 0;
    data.forEach(d => totalQ += d.questions.length);

    countEl.innerText = data.length;
    totalEl.innerText = totalQ;

    tbody.innerHTML = data.map((item, index) => {
        // é¢„è§ˆå‰5é¢˜
        const previewQ = item.questions.slice(0, 5).map(q =>
            `<span style="display:inline-block; background:#fff3cd; padding:2px 6px; border-radius:4px; margin:2px; font-size:0.85em; border:1px solid #ffeeba;">
                é¢˜${q.qName} [${(q.rate * 100).toFixed(0)}%] ${q.kp ? '(' + q.kp + ')' : ''}
            </span>`
        ).join('');
        const more = item.questions.length > 5 ? `...ç­‰${item.questions.length}é¢˜` : '';

        // çŠ¶æ€æ£€æŸ¥
        const aiStatus = item.aiExercises ? `<span style="color:#28a745; font-size:0.8em;">âœ… å·²ç”Ÿæˆ</span>` : `<span style="color:#ccc; font-size:0.8em;">æœªç”Ÿæˆ</span>`;

        return `
            <tr id="wb-row-${index}">
                <td style="font-weight:bold;">${item.student.name}</td>
                <td style="text-align:center;">${item.questions.length}</td>
                <td>${previewQ} ${more}</td>
                <td style="text-align:center;">${aiStatus}</td>
                <td>
                    <div style="display:flex; gap:5px;">
                        <button class="sidebar-button" style="font-size:0.8em; padding:4px 8px; background-color:#6f42c1;" onclick="generateSingleAIExercises(${index}, this)">ğŸ¤– å•ç‹¬ç”Ÿæˆ</button>
                        <button class="sidebar-button" style="font-size:0.8em; padding:4px 8px;" onclick="printSingleWorkbook(${index})">ğŸ–¨ï¸ æ‰“å°</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    // æŒ‚è½½å…¨å±€å‡½æ•°
    window.printSingleWorkbook = (index) => {
        const subject = document.getElementById('wb-subject-select').value;
        printWorkbook([data[index]], subject);
    };

    //            æŒ‚è½½ AI ç”Ÿæˆå‡½æ•°
    window.generateSingleAIExercises = async (index, btnElement) => {
        const apiKey = localStorage.getItem('G_DeepSeekKey');
        if (!apiKey) { alert("è¯·å…ˆåœ¨ã€AI æ™ºèƒ½åˆ†æã€‘æ¨¡å—è®¾ç½® API Keyï¼"); return; }

        const item = data[index];
        // æå–çŸ¥è¯†ç‚¹åˆ—è¡¨ (å»é‡)
        const kps = [...new Set(item.questions.map(q => q.kp).filter(k => k && k !== 'æœªæ ‡è®°'))];

        if (kps.length === 0) {
            alert("è¯¥å­¦ç”Ÿçš„é”™é¢˜æœªé…ç½®å…·ä½“â€œçŸ¥è¯†ç‚¹â€ï¼ŒAI æ— æ³•é’ˆå¯¹æ€§å‡ºé¢˜ã€‚\nè¯·å…ˆå»â€œå­¦ç§‘å°é¢˜åˆ†æâ€æ¨¡å—ç‚¹å‡»â€œé…ç½®é¢˜ç›®â€å®Œå–„è€ƒå¯Ÿå†…å®¹ã€‚");
            return;
        }

        const originalText = btnElement.innerText;
        btnElement.innerText = "â³ ç”Ÿæˆä¸­...";
        btnElement.disabled = true;

        try {
            // è°ƒç”¨ AI
            const exercises = await fetchAIExercises(apiKey, item.student.name, kps, document.getElementById('wb-subject-select').value);

            // ä¿å­˜ç»“æœåˆ°æ•°æ®å¯¹è±¡ä¸­
            item.aiExercises = exercises; // è¿™æ˜¯ä¸€ä¸ªåŒ…å«é¢˜ç›®æ–‡æœ¬çš„å­—ç¬¦ä¸²

            btnElement.innerText = "âœ… å®Œæˆ";
            // åˆ·  è¯¥è¡ŒçŠ¶æ€ (å¯é€‰)
            const row = document.getElementById(`wb-row-${index}`);
            if (row && row.cells[3]) row.cells[3].innerHTML = `<span style="color:#28a745; font-size:0.8em;">âœ… å·²ç”Ÿæˆ</span>`;

        } catch (err) {
            alert("ç”Ÿæˆå¤±è´¥: " + err.message);
            btnElement.innerText = originalText;
            btnElement.disabled = false;
        }
    };
}

/**
 * 18.5    è¯·æ±‚ AI ç”Ÿæˆå˜å¼é¢˜
 */
async function fetchAIExercises(apiKey, studentName, kps, subject) {
    // é™åˆ¶ä¸€ä¸‹çŸ¥è¯†ç‚¹æ•°é‡
    const targetKps = kps.slice(0, 5).join('ã€');

    const prompt = `
ä½ æ˜¯ä¸€ä½èµ„æ·±çš„${subject}è€å¸ˆã€‚å­¦ç”Ÿã€${studentName}ã€‘åœ¨ä»¥ä¸‹çŸ¥è¯†ç‚¹æŒæ¡è–„å¼±ï¼šã€${targetKps}ã€‘ã€‚

è¯·ä¸ºä»–è®¾è®¡ä¸€å¥—â€œé’ˆå¯¹æ€§æ”»åšç»ƒä¹ é¢˜â€ï¼š
1. é’ˆå¯¹ä¸Šè¿°æ¯ä¸ªçŸ¥è¯†ç‚¹ï¼Œå‡ºä¸€é“åŒç­‰éš¾åº¦çš„å˜å¼é¢˜ã€‚
2. ç”Ÿæˆæ‰€æœ‰çš„é¢˜ç›®å,å†åœ¨æœ€åä¸€é¢˜çš„åé¢é™„å¸¦ã€ç­”æ¡ˆã€‘å’Œç®€çŸ­ã€è§£æã€‘ã€‚
3. æ ¼å¼ä¸å…¬å¼è¦æ±‚ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š
   - æ‰€æœ‰æ•°å­¦ã€ç‰©ç†ã€åŒ–å­¦ç¬¦å·ã€å…¬å¼ã€å•ä½ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨ LaTeX æ ¼å¼ã€‚
   - è¡Œå†…å…¬å¼ç”¨å•ç¾å…ƒç¬¦å·åŒ…è£¹ï¼Œä¾‹å¦‚ï¼š$f(x) = x^2$ã€‚
   - ç‹¬ç«‹å…¬å¼ç”¨åŒç¾å…ƒç¬¦å·åŒ…è£¹ï¼Œä¾‹å¦‚ï¼š$$ E = mc^2 $$ã€‚
   - åŒ–å­¦å¼ä¹Ÿè¯·ç”¨ LaTeXï¼Œä¾‹å¦‚ï¼š$\\text{H}_2\\text{O}$ æˆ– $\\text{Fe}^{2+}$ã€‚
4. æ’ç‰ˆè¦æ±‚ï¼š
   - é¢˜å·ä½¿ç”¨ (1), (2)...
   - ç­”æ¡ˆå’Œè§£æå†™åœ¨æœ€åã€‚
   - ä¸è¦å†™å‰è¨€åè¯­ï¼Œç›´æ¥å‡ºé¢˜ã€‚
   - æ€»å­—æ•°æ§åˆ¶åœ¨ 800 å­—ä»¥å†…ã€‚
    `.trim();

    const response = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify({
            model: 'deepseek-chat', // ä½¿ç”¨ V3 å³å¯
            messages: [{ role: "user", content: prompt }],
            temperature: 0.7
        })
    });

    if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
    const data = await response.json();
    return data.choices[0].message.content.trim();
}

/**
 * 18.4 æ ¸å¿ƒæ‰“å°é€»è¾‘ (æœ€ç»ˆä¿®å¤ç‰ˆï¼šåŒ…å«è€ƒè¯•åç§° + AIå…¬å¼æ¸²æŸ“)
 */
async function printWorkbook(dataList, subjectName) {
    //            è·å–è€ƒè¯•åç§°
    let examName = await localforage.getItem('G_ItemAnalysisFileName');
    if (!examName) {
        // å¦‚æœå°é¢˜æ–‡ä»¶åä¸å­˜åœ¨ï¼Œå°è¯•è·å–ä¸»æ–‡ä»¶å
        examName = await localforage.getItem('G_MainFileName') || "æœ¬æ¬¡è€ƒè¯•";
    }
    // å»é™¤æ–‡ä»¶åç¼€ (.xlsx, .csv ç­‰)
    examName = examName.replace(/\.(xlsx|xls|csv)$/i, '');

    let html = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>${examName} - ${subjectName} æ”»åšæœ¬</title>
        <meta charset="UTF-8">
        
        <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/katex.min.css">
        <script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/katex.min.js"><\/script>
        <script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"><\/script>
        
        <style>
            body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; padding: 0; margin: 0; color: #333; }
            .page { 
                width: 210mm; min-height: 297mm; 
                padding: 1.5cm; box-sizing: border-box; 
                margin: 0 auto; background: white;
                page-break-after: always;
                position: relative;
                display: flex;
                flex-direction: column;
            }
            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; flex-shrink: 0; }
            /* [ä¿®æ”¹] æ ‡é¢˜æ ·å¼å¾®è°ƒ */
            .header h1 { margin: 0 0 8px 0; font-size: 24px; line-height: 1.4; }
            .header p { margin: 0; color: #666; font-size: 14px; }
            
            .content-wrapper { display: flex; flex-grow: 1; gap: 20px; }
            
            .left-column { width: 40%; border-right: 1px dashed #ccc; padding-right: 15px; }
            .q-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; break-inside: avoid; }
            .q-num { font-size: 1.1em; font-weight: bold; color: #000; }
            .q-kp { font-size: 0.9em; color: #666; margin-top: 2px; }
            .q-score { font-size: 0.9em; color: #dc3545; font-weight:bold; margin-top: 2px; }
            
            .right-column { width: 60%; position: relative; }
            .workspace-title { 
                font-weight: bold; color: #e0e0e0; font-size: 1.5em; 
                text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0;
            }
            .ai-content { 
                font-size: 14px; line-height: 1.6; color: #333; 
                white-space: pre-wrap; text-align: justify;
            }
            .katex { font-size: 1.1em; } 
            
            @media print {
                body { background: none; }
                .page { margin: 0; border: none; width: auto; height: auto; }
                .header { -webkit-print-color-adjust: exact; }
            }
        </style>
    </head>
    <body>
    `;

    dataList.forEach(d => {
        let rightContent = '';
        if (d.aiExercises) {
            rightContent = `
                <div class="workspace-title" style="color:#6f42c1;">ğŸ¤– AI æ™ºèƒ½å˜å¼è®­ç»ƒ</div>
                <div class="ai-content">${d.aiExercises}</div>
            `;
        } else {
            rightContent = `
                <div class="workspace-title">âœï¸ é”™é¢˜è®¢æ­£ / å½’å› åˆ†æ</div>
                <div style="height: 100%; background-image: linear-gradient(#f5f5f5 1px, transparent 1px); background-size: 100% 2em;"></div>
            `;
        }

        let leftContent = '';
        d.questions.forEach(q => {
            leftContent += `
                <div class="q-item">
                    <div class="q-num">ç¬¬ ${q.qName} é¢˜</div>
                    <div class="q-kp">ğŸ“Œ è€ƒç‚¹ï¼š${q.kp || 'æœªæ ‡è®°'}</div>
                    <div class="q-score">å¾—åˆ†ï¼š${q.score} / ${q.full} <span style="color:#999; font-weight:normal; font-size:0.9em;">(ç‡ ${(q.rate * 100).toFixed(0)}%)</span></div>
                </div>
            `;
        });

        //    ä¿®æ”¹    åœ¨ header ä¸­æ’å…¥ examName
        html += `
        <div class="page">
            <div class="header">
                <h1>${examName} Â· ${subjectName}</h1>
                <h1>ä¸ªæ€§åŒ–æ”»åšæœ¬</h1>
                <p>å§“åï¼š<strong>${d.student.name}</strong> | ç­çº§ï¼š${d.student.class} | å¾…æ”»åšé¢˜æ•°ï¼š${d.questions.length}</p>
            </div>
            
            <div class="content-wrapper">
                <div class="left-column">
                    <div style="margin-bottom:10px; font-weight:bold; color:#555;">ğŸš« æˆ‘çš„è–„å¼±ç‚¹ï¼š</div>
                    ${leftContent}
                </div>
                <div class="right-column">
                    ${rightContent}
                </div>
            </div>
        </div>
        `;
    });

    html += `
        <script>
            window.onload = function() {
                const renderOptions = {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\\\(", right: "\\\\)", display: false},
                        {left: "\\\\[", right: "\\\\]", display: true}
                    ],
                    throwOnError: false
                };
                if (window.renderMathInElement) {
                    renderMathInElement(document.body, renderOptions);
                }
                setTimeout(function() {
                    window.focus();
                    window.print();
                }, 500);
            };
        <\/script>
    </body></html>`;

    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
}


/**
 * [æ——èˆ°å®Œæ•´ç‰ˆ] 24.1 æ¸²æŸ“ä¸»ç•Œé¢
 * é›†æˆåŒæ¨¡å¼ï¼š
 * Tab 1: å¿«æ·å–œæŠ¥ (è‡ªåŠ¨æŒ–æ˜ + é•¿å›¾ç”Ÿæˆ)
 * Tab 2: ä¸“ä¸šå¥–çŠ¶ (è‡ªå®šä¹‰æ’ç‰ˆ + é«˜æ¸…æ‰“å°)
 */
function renderHonorWall(container) {
    // --- [Tab 1 æ•°æ®å‡†å¤‡] ---
    const classes = [...new Set(G_StudentsData.map(s => s.class))].sort();
    const classOptions = classes.map(c => `<option value="${c}">${c}</option>`).join('');
    
    // è·å–é»˜è®¤æ–‡ä»¶åç”¨äºæ ‡é¢˜å ä½
    let defaultName = localStorage.getItem('G_MainFileName') || "æœ¬æ¬¡è€ƒè¯•";
    defaultName = defaultName.replace(/\.(xlsx|xls|csv)/i, '');

    // --- [æ¸²æŸ“ HTML ç»“æ„] ---
    container.innerHTML = `
        <h2>ğŸ† æ¨¡å—åä¹ï¼šè£èª‰ä¸­å¿ƒ</h2>
        
        <div class="tab-header" style="display:flex; border-bottom:2px solid #ddd; margin-bottom:20px;">
            <div class="tab-item active" data-tab="quick-poster" style="padding:10px 20px; cursor:pointer; font-weight:bold; color:#d35400; border-bottom:3px solid #d35400;">ğŸš€ å¿«æ·å–œæŠ¥ç”Ÿæˆ</div>
            <div class="tab-item" data-tab="custom-cert" style="padding:10px 20px; cursor:pointer; color:#666;">ğŸ¨ ä¸“ä¸šå¥–çŠ¶å®šåˆ¶</div>
        </div>

        <div id="tab-content-quick-poster" class="tab-content">
            
            <div class="main-card-wrapper" style="border-left: 5px solid #6f42c1; background: #f8f9fa; margin-bottom: 20px;">
                <h4 style="margin:0 0 15px 0; color:#6f42c1;">âš™ï¸ å–œæŠ¥å¤–è§‚é…ç½®</h4>
                <div style="display:flex; gap:30px; align-items:flex-start; flex-wrap:wrap;">
                    
                    <div style="flex:1; min-width:250px;">
                        <label style="font-weight:bold; display:block; margin-bottom:8px; color:#555;">1. é¡¶éƒ¨å°æ ‡é¢˜ (è‡ªå®šä¹‰è€ƒè¯•å):</label>
                        <input type="text" id="honor-custom-title" class="sidebar-select" style="width:100%;" placeholder="é»˜è®¤æ˜¾ç¤ºï¼š${defaultName}" value="${localStorage.getItem('G_Honor_CustomTitle') || ''}">
                        <p style="font-size:0.8em; color:#999; margin-top:5px;">* ä¿®æ”¹åå°†æ°¸ä¹…ä¿å­˜ï¼Œç›´åˆ°ä¸‹æ¬¡ä¿®æ”¹ã€‚</p>
                    </div>
                    
                    <div style="flex:1; min-width:250px;">
                        <label style="font-weight:bold; display:block; margin-bottom:8px; color:#555;">2. å­¦æ ¡/ç­çº§ Logo:</label>
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div id="honor-logo-preview-box" style="width:60px; height:60px; border:2px dashed #ccc; border-radius:8px; display:flex; justify-content:center; align-items:center; background:white; overflow:hidden;">
                                <span style="font-size:0.8em; color:#ccc;">æ— </span>
                            </div>
                            
                            <div style="display:flex; flex-direction:column; gap:5px;">
                                <label for="honor-logo-upload" class="sidebar-button" style="background-color:#fff; color:#333; border:1px solid #ccc; cursor:pointer; font-size:0.9em; text-align:center;">
                                    ğŸ“¤ ä¸Šä¼ å›¾ç‰‡
                                </label>
                                <input type="file" id="honor-logo-upload" accept="image/*" style="display:none;">
                                
                                <button id="btn-clear-logo" class="sidebar-button" style="background-color:#dc3545; font-size:0.8em; padding:4px 10px; display:none;">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                        </div>
                        <p style="font-size:0.8em; color:#999; margin-top:5px;">* å›¾ç‰‡å°†ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œä¸‹æ¬¡æ— éœ€é‡æ–°ä¸Šä¼ ã€‚</p>
                    </div>
                </div>
            </div>

            <div class="main-card-wrapper" style="border-left: 5px solid #ffc107; background: #fffdf5;">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap: 15px;">
                    <div>
                        <h4 style="margin:0; color:#d35400;">ğŸŒŸ è£èª‰æŒ–æ˜æœº</h4>
                        <p style="font-size:0.8em; color:#888; margin:5px 0 0 0;">åŸºäºã€æœ¬æ¬¡æˆç»©ã€‘ä¸ã€å¯¹æ¯”æˆç»©ã€‘è‡ªåŠ¨è®¡ç®—ã€‚</p>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label style="font-weight:bold; color:#555;">ç»Ÿè®¡èŒƒå›´:</label>
                        <select id="honor-class-filter" class="sidebar-select" style="width:auto; min-width:120px; font-weight:bold; border-color:#ffc107;">
                            <option value="ALL">ğŸ« å…¨ä½“å¹´æ®µ</option>
                            ${classOptions}
                        </select>
                        <button id="btn-honor-refresh" class="sidebar-button" style="background-color:#ffc107; color:#333;">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    </div>
                </div>
            </div>

            <div id="honor-display-area" style="margin-top:20px;"></div>

            <div id="poster-modal" class="modal-overlay" style="display: none;">
                <div class="modal-content" style="max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; background: #f5f5f5; padding: 0;">
                    <div class="modal-header" style="padding: 15px; flex-shrink: 0;">
                        <h3>ğŸ–¼ï¸ å–œæŠ¥é¢„è§ˆ</h3>
                        <span onclick="document.getElementById('poster-modal').style.display='none'" class="modal-close-btn">&times;</span>
                    </div>
                    <div class="modal-body" style="padding: 0; flex-grow: 1; overflow-y: auto; display: flex; justify-content: center; background: #333;">
                        <div id="poster-canvas-container" style="margin: 20px 0;"></div>
                    </div>
                    <div class="modal-footer" style="justify-content: center; gap: 15px; flex-shrink: 0; padding: 15px;">
                        <p style="font-size:0.85em; color:#666; width:100%; margin-bottom:10px; text-align:center;">(é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡æˆ–ç‚¹å‡»ä¸‹è½½æŒ‰é’®ä¿å­˜)</p>
                        <button id="btn-download-poster" class="sidebar-button" style="background-color: #d35400;">ğŸ“¥ ä¸‹è½½å›¾ç‰‡</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-content-custom-cert" class="tab-content" style="display:none;">
            <div id="cert-creator-container"></div>
        </div>
    `;

    // ==============================================
    // 1. Tab åˆ‡æ¢é€»è¾‘
    // ==============================================
    const tabs = container.querySelectorAll('.tab-item');
    const contents = container.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => { t.classList.remove('active'); t.style.color='#666'; t.style.borderBottom='none'; });
            contents.forEach(c => c.style.display = 'none');
            
            tab.classList.add('active');
            tab.style.color='#d35400';
            tab.style.borderBottom='3px solid #d35400';
            container.querySelector(`#tab-content-${tab.dataset.tab}`).style.display = 'block';
        });
    });

    // ==============================================
    // 2. Tab 1 (å¿«æ·å–œæŠ¥) äº‹ä»¶ç»‘å®š
    // ==============================================
    
    // A. æ ‡é¢˜è¾“å…¥ä¿å­˜
    const titleInput = document.getElementById('honor-custom-title');
    if (titleInput) {
        titleInput.addEventListener('input', (e) => {
            localStorage.setItem('G_Honor_CustomTitle', e.target.value);
        });
    }

    // B. Logo å¤„ç†é€»è¾‘
    const logoInput = document.getElementById('honor-logo-upload');
    const logoPreviewBox = document.getElementById('honor-logo-preview-box');
    const clearLogoBtn = document.getElementById('btn-clear-logo');

    const updateLogoPreview = async () => {
        const base64 = await localforage.getItem('G_School_Logo');
        if (base64 && logoPreviewBox) {
            logoPreviewBox.innerHTML = `<img src="${base64}" style="width:100%; height:100%; object-fit:contain;">`;
            if(clearLogoBtn) clearLogoBtn.style.display = 'inline-block';
        } else if (logoPreviewBox) {
            logoPreviewBox.innerHTML = `<span style="font-size:0.8em; color:#ccc;">æ— </span>`;
            if(clearLogoBtn) clearLogoBtn.style.display = 'none';
        }
    };
    updateLogoPreview(); // åˆå§‹åŠ è½½

    if (logoInput) {
        logoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                await localforage.setItem('G_School_Logo', event.target.result);
                updateLogoPreview();
            };
            reader.readAsDataURL(file);
        });
    }

    if (clearLogoBtn) {
        clearLogoBtn.addEventListener('click', async () => {
            await localforage.removeItem('G_School_Logo');
            if(logoInput) logoInput.value = '';
            updateLogoPreview();
        });
    }

    // C. åˆ·æ–°ä¸ç­›é€‰
    const refreshBtn = document.getElementById('btn-honor-refresh');
    const filterSelect = document.getElementById('honor-class-filter');
    
    if (refreshBtn) refreshBtn.onclick = () => calculateAndRenderHonors();
    if (filterSelect) filterSelect.addEventListener('change', () => calculateAndRenderHonors());

    // åˆå§‹åŠ è½½ Tab 1 æ•°æ®
    calculateAndRenderHonors();

    // ==============================================
    // 3. Tab 2 (ä¸“ä¸šå¥–çŠ¶) åˆå§‹åŒ–
    // ==============================================
    const certContainer = document.getElementById('cert-creator-container');
    if (certContainer) {
        renderCertificateCreator(certContainer);
    }
}

/**
 * [æ——èˆ°ç‰ˆ V8] 24.2 è®¡ç®—è£èª‰åå•
 * - åŠŸèƒ½ï¼šè‡ªåŠ¨æŒ–æ˜è£èª‰å­¦ç”Ÿã€ç”Ÿæˆå¯è§†åŒ–å¡ç‰‡ã€ç”Ÿæˆå¥–çŠ¶å®šåˆ¶æ•°æ®
 * - äº®ç‚¹ï¼šæ”¯æŒâ€œå¥–é¡¹è¡Œâ€ç‹¬ç«‹æ‹†åˆ† (award)ã€æ–‡æ¡ˆæ™ºèƒ½é€‚é…ç­çº§/å¹´çº§ã€æ•°æ®å®æ—¶è”åŠ¨
 */
function calculateAndRenderHonors() {
    const container = document.getElementById('honor-display-area');
    const filterVal = document.getElementById('honor-class-filter').value;

    // 1. è·å–æ•°æ®ä¸Šä¸‹æ–‡ (æ”¯æŒç­çº§ç­›é€‰)
    let activeData = G_StudentsData;
    let compareData = G_CompareData;

    if (filterVal !== 'ALL') {
        activeData = G_StudentsData.filter(s => s.class === filterVal);
        if (G_CompareData) {
            compareData = G_CompareData.filter(s => s.class === filterVal);
        }
    }

    if (!activeData || activeData.length === 0) {
        container.innerHTML = `<p style="text-align:center; padding:20px; color:#999;">è¯¥èŒƒå›´å†…æš‚æ— æ•°æ®ã€‚</p>`;
        window.G_Honor_List = [];
        if (typeof window.updateCertChecklist === 'function') window.updateCertChecklist();
        return;
    }

    // è·å–åŠ¨æ€è€ƒè¯•åç§°
    let examName = localStorage.getItem('G_Honor_CustomTitle');
    if (!examName) {
        examName = localStorage.getItem('G_MainFileName') || "æœ¬æ¬¡è€ƒè¯•";
        examName = examName.replace(/\.(xlsx|xls|csv)/i, '');
    }

    // =========================================
    //   æ ¸å¿ƒè®¡ç®—é€»è¾‘
    // =========================================
    
    // 1. ğŸ† å·…å³°é¢†è·‘è€… (æ€»åˆ† Top 5)
    const topTotal = [...activeData].sort((a, b) => b.totalScore - a.totalScore).slice(0, 5);

    // 2. ğŸ¥‡ å•ç§‘çŠ¶å…ƒ (å„ç§‘ Top 1)
    const subjectKings = [];
    G_DynamicSubjectList.forEach(sub => {
        let maxScore = -Infinity;
        activeData.forEach(s => { if ((s.scores[sub]||0) > maxScore) maxScore = s.scores[sub]; });
        if (maxScore > 0) {
            const kings = activeData.filter(s => s.scores[sub] === maxScore);
            subjectKings.push({ subject: sub, score: maxScore, students: kings });
        }
    });

    // 3. ğŸš€ è¿›æ­¥ä¹‹æ˜Ÿ (æ‹†åˆ†ï¼šå¹´çº§ vs ç­çº§)
    let gradeProgressStars = [];
    let classProgressStars = [];
    
    if (compareData && compareData.length > 0) {
        // A. å¹´çº§è¿›æ­¥æ¦œ (å¯¹æ¯” gradeRank)
        gradeProgressStars = activeData.map(s => {
            const old = compareData.find(o => String(o.id) === String(s.id));
            if (!old || !old.gradeRank || !s.gradeRank) return null;
            return { ...s, diff: old.gradeRank - s.gradeRank };
        }).filter(s => s && s.diff > 0).sort((a, b) => b.diff - a.diff).slice(0, 5);

        // B. ç­çº§è¿›æ­¥æ¦œ (å¯¹æ¯” rank)
        classProgressStars = activeData.map(s => {
            const old = compareData.find(o => String(o.id) === String(s.id));
            if (!old || !old.rank || !s.rank) return null;
            return { ...s, diff: old.rank - s.rank };
        }).filter(s => s && s.diff > 0).sort((a, b) => b.diff - a.diff).slice(0, 5);
    }

    // 4. âš–ï¸ å…¨èƒ½æˆ˜å£« (å‡è¡¡åº¦ Top 5)
    const top30PercentCount = Math.ceil(activeData.length * 0.3);
    const highScorers = [...activeData].sort((a, b) => b.totalScore - a.totalScore).slice(0, top30PercentCount);
    const balancedStars = highScorers.map(s => {
        const rates = [];
        G_DynamicSubjectList.forEach(sub => {
            const config = G_SubjectConfigs[sub];
            if (config && config.full > 0 && typeof s.scores[sub] === 'number') {
                rates.push(s.scores[sub] / config.full);
            }
        });
        if (rates.length < 3) return null;
        const mean = rates.reduce((a, b) => a + b) / rates.length;
        const variance = rates.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / rates.length;
        return { ...s, balanceScore: variance };
    }).filter(s => s !== null).sort((a, b) => a.balanceScore - b.balanceScore).slice(0, 5);


    // =========================================
    //   ç•Œé¢æ¸²æŸ“ (HTML Card)
    // =========================================
    let html = ``;
    const createCard = (title, icon, color, contentHtml, type) => `
        <div class="main-card-wrapper" style="border-top: 4px solid ${color}; padding-top:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4 style="margin:0; color:${color}; font-size:1.1em;">${icon} ${title}</h4>
                <button class="sidebar-button" style="background-color:${color}; font-size:0.85em; padding:4px 10px;" 
                    onclick="generatePoster('${type}', '${title.split(' ')[0]}')">
                    ğŸ–¼ï¸ ç”Ÿæˆå–œæŠ¥
                </button>
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                ${contentHtml || '<span style="color:#999; font-size:0.9em;">(æš‚æ— æ•°æ®)</span>'}
            </div>
        </div>
    `;

    // 1. æ€»åˆ†
    const topContent = topTotal.map((s, i) => `<div class="honor-badge" style="background:#fff8e1; border:1px solid #ffe082; color:#bf360c;"><span style="font-weight:bold;">Top${i+1} ${s.name}</span> <span style="font-size:0.8em;">(${s.totalScore})</span></div>`).join('');
    html += createCard('å·…å³°é¢†è·‘æ¦œ (Top5)', 'ğŸ†', '#f39c12', topContent, 'total');

    // 2. å•ç§‘
    const kingContent = subjectKings.map(k => {
        const names = k.students.map(s=>s.name).join('ã€');
        return `<div class="honor-badge" style="background:#e3f2fd; border:1px solid #90caf9; color:#0d47a1;"><span style="font-weight:bold;">${k.subject}ï¼š${names}</span> <span style="font-size:0.8em;">(${k.score})</span></div>`;
    }).join('');
    html += createCard('å•ç§‘çŠ¶å…ƒæ¦œ', 'ğŸ¥‡', '#3498db', kingContent, 'subject');

    // 3. è¿›æ­¥ (å¹´çº§)
    if (gradeProgressStars.length > 0) {
        const gradeContent = gradeProgressStars.map(s => `<div class="honor-badge" style="background:#e8f5e9; border:1px solid #a5d6a7; color:#1b5e20;"><span style="font-weight:bold;">${s.name}</span> <span style="font-size:0.8em;">(å¹´æ’ â¬†ï¸${s.diff})</span></div>`).join('');
        html += createCard('å¹´çº§è¿›æ­¥ä¹‹æ˜Ÿ', 'ğŸš€', '#2ecc71', gradeContent, 'progress_grade');
    }

    // 4. è¿›æ­¥ (ç­çº§)
    if (classProgressStars.length > 0) {
        const classContent = classProgressStars.map(s => `<div class="honor-badge" style="background:#e0f7fa; border:1px solid #80deea; color:#006064;"><span style="font-weight:bold;">${s.name}</span> <span style="font-size:0.8em;">(ç­æ’ â¬†ï¸${s.diff})</span></div>`).join('');
        html += createCard('ç­çº§è¿›æ­¥ä¹‹æ˜Ÿ', 'ğŸ“ˆ', '#17a2b8', classContent, 'progress_class');
    }

    // 5. å‡è¡¡
    const balContent = balancedStars.map(s => `<div class="honor-badge" style="background:#f3e5f5; border:1px solid #ce93d8; color:#4a148c;"><span style="font-weight:bold;">${s.name}</span> <span style="font-size:0.8em;">(${s.totalScore})</span></div>`).join('');
    html += createCard('å…¨èƒ½æˆ˜å£«æ¦œ (å‡è¡¡)', 'âš–ï¸', '#9b59b6', balContent, 'balance');

    container.innerHTML = html + `<style>.honor-badge { padding: 6px 10px; border-radius: 4px; display:flex; align-items:center; gap:5px; font-size:0.9em; }</style>`;


    // =========================================
    // ğŸ”¥ğŸ”¥ğŸ”¥ æ•°æ®å¯¼å‡º (å«ç‹¬ç«‹ award) ğŸ”¥ğŸ”¥ğŸ”¥
    // =========================================
    window.G_Honor_List = [];
    
    // 1. å·…å³°é¢†è·‘
    topTotal.forEach((s, i) => {
        let rankText = filterVal === 'ALL' ? `å¹´çº§ç¬¬ ${i+1} å` : `ç­çº§ç¬¬ ${i+1} å (å¹´çº§ç¬¬ ${s.gradeRank} å)`;
        window.G_Honor_List.push({ 
            name: s.name, 
            title: "å·…å³°é¢†è·‘å¥–", 
            desc: `åœ¨${examName}ä¸­ä»¥æ€»åˆ† ${s.totalScore} åˆ†è£è·${rankText}ã€‚`,
            award: `ç‰¹è¢«è¯„ä¸ºï¼š<span class="cert-highlight">å·…å³°é¢†è·‘è€…</span>`
        });
    });

    // 2. å•ç§‘çŠ¶å…ƒ
    subjectKings.forEach(k => {
        k.students.forEach(s => {
            window.G_Honor_List.push({ 
                name: s.name, 
                title: `${k.subject}å•ç§‘çŠ¶å…ƒ`, 
                desc: `åœ¨${examName}ä¸­${k.subject}å­¦ç§‘å–å¾— ${k.score} åˆ†çš„ä¼˜å¼‚æˆç»©ã€‚`,
                award: `ç‰¹è¢«è¯„ä¸ºï¼š<span class="cert-highlight">${k.subject}å•ç§‘çŠ¶å…ƒ</span>`
            });
        });
    });

    // 3.1 å¹´çº§è¿›æ­¥
    gradeProgressStars.forEach(s => {
        window.G_Honor_List.push({ 
            name: s.name, 
            title: "å¹´çº§è¿›æ­¥ä¹‹æ˜Ÿ", 
            desc: `åœ¨${examName}ä¸­å¹´çº§æ’åæ˜¾è‘—æå‡ ${s.diff} åï¼Œå‹¤å¥‹åˆ»è‹¦ã€‚`,
            award: `ç‰¹è¢«è¯„ä¸ºï¼š<span class="cert-highlight">å¹´çº§è¿›æ­¥ä¹‹æ˜Ÿ</span>`
        });
    });

    // 3.2 ç­çº§è¿›æ­¥
    classProgressStars.forEach(s => {
        window.G_Honor_List.push({ 
            name: s.name, 
            title: "ç­çº§è¿›æ­¥ä¹‹æ˜Ÿ", 
            desc: `åœ¨${examName}ä¸­ç­çº§æ’åæ˜¾è‘—æå‡ ${s.diff} åï¼Œè¶…è¶Šè‡ªæˆ‘ã€‚`,
            award: `ç‰¹è¢«è¯„ä¸ºï¼š<span class="cert-highlight">ç­çº§è¿›æ­¥ä¹‹æ˜Ÿ</span>`
        });
    });

    // 4. å…¨èƒ½æˆ˜å£«
    balancedStars.forEach(s => {
        window.G_Honor_List.push({ 
            name: s.name, 
            title: "å…¨èƒ½æˆ˜å£«å¥–", 
            desc: `åœ¨${examName}ä¸­å„ç§‘å‘å±•å‡è¡¡ï¼ŒåŸºç¡€æ‰å®ã€‚`,
            award: `ç‰¹è¢«è¯„ä¸ºï¼š<span class="cert-highlight">å…¨èƒ½æˆ˜å£«</span>`
        });
    });

    // ğŸ”¥ å¼ºåˆ¶åˆ·æ–°åˆ—è¡¨ UI
    if (typeof window.updateCertChecklist === 'function') {
        window.updateCertChecklist();
        
        // åŒæ­¥æ›´æ–°æ‰¹é‡æŒ‰é’®çš„æ•°å­— (å¯é€‰)
        const btn = document.getElementById('btn-batch-generate-certs');
        if(btn) btn.innerText = `ğŸ“¦ ç”Ÿæˆ ZIP å‹ç¼©åŒ… (${window.G_Honor_List.length})`;
    }
}

/**
 * [æ——èˆ°ç‰ˆ] 24.3 ç”Ÿæˆå–œæŠ¥å›¾ç‰‡ (æ”¯æŒ Logo + è‡ªå®šä¹‰æ ‡é¢˜ + é•¿å›¾)
 */
window.generatePoster = async function(type, titleStr) {
    const modal = document.getElementById('poster-modal');
    const container = document.getElementById('poster-canvas-container');
    const downloadBtn = document.getElementById('btn-download-poster');
    
    // 1. è·å–æ•°æ®ä¸Šä¸‹æ–‡
    const filterVal = document.getElementById('honor-class-filter').value;
    let scopeText = filterVal === 'ALL' ? "å…¨ä½“å¹´æ®µ" : filterVal;
    
    let activeData = G_StudentsData;
    let compareData = G_CompareData;
    if (filterVal !== 'ALL') {
        activeData = G_StudentsData.filter(s => s.class === filterVal);
        if (G_CompareData) compareData = G_CompareData.filter(s => s.class === filterVal);
    }

    if (activeData.length === 0) { alert("å½“å‰èŒƒå›´å†…æ— æ•°æ®ï¼Œæ— æ³•ç”Ÿæˆã€‚"); return; }

    container.innerHTML = '<div style="padding:40px; color:white;">â³ æ­£åœ¨ç»˜åˆ¶é«˜æ¸…å–œæŠ¥...</div>';
    modal.style.display = 'flex';
    downloadBtn.style.display = 'none';

    // 2. è·å–é…ç½® (æ ‡é¢˜ & Logo)
    let customTitle = document.getElementById('honor-custom-title').value.trim();
    let examName = customTitle;
    
    if (!examName) {
        // å›é€€åˆ°é»˜è®¤æ–‡ä»¶å
        examName = localStorage.getItem('G_MainFileName') || "æœ¬æ¬¡è€ƒè¯•";
        examName = examName.replace(/\.(xlsx|xls|csv)/i, '');
    }

    // å¼‚æ­¥è·å– Logo
    const logoBase64 = await localforage.getItem('G_School_Logo');
    let logoHtml = '';
    if (logoBase64) {
        logoHtml = `<img src="${logoBase64}" style="height:60px; max-width:80%; object-fit:contain; margin-bottom:10px; border-radius:4px; background:rgba(255,255,255,0.9); padding:4px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">`;
    }

    // 3. å‡†å¤‡åˆ—è¡¨å†…å®¹
    let listHtml = "";
    let mainColor = "#d35400";
    let subTitle = `èŒƒå›´ï¼š${scopeText}`;

    // --- æ•°æ®é€»è¾‘ (ä¿æŒä¸å˜) ---
    if (type === 'total') {
        mainColor = "#c0392b"; titleStr = "å·…å³°é¢†è·‘æ¦œ";
        const data = [...activeData].sort((a, b) => b.totalScore - a.totalScore).slice(0, 15);
        listHtml = data.map((s, i) => 
            `<div class="poster-row">
                <span class="poster-rank" style="background:${i<3?'#f1c40f':'#eee'}; color:${i<3?'#fff':'#666'}">${i+1}</span>
                <span class="poster-name">${s.name}</span>
                <span class="poster-score">${s.totalScore}åˆ†</span>
            </div>`
        ).join('');
    } 
else if (type === 'progress_grade') { // å¹´çº§è¿›æ­¥
        mainColor = "#27ae60"; 
        titleStr = "å¹´çº§è¿›æ­¥ä¹‹æ˜Ÿ";
        
        const data = activeData.filter(s => s.gradeRank!==undefined).map(s => {
             const old = (compareData||[]).find(o => String(o.id) === String(s.id));
             // å¼ºåˆ¶åªç®—å¹´æ’
             const diff = (old && old.gradeRank) ? (old.gradeRank - s.gradeRank) : 0;
             return { ...s, diff };
        }).filter(s => s.diff > 0).sort((a, b) => b.diff - a.diff).slice(0, 15);
        
        listHtml = data.map((s, i) => 
            `<div class="poster-row">
                <span class="poster-rank" style="background:#e8f5e9; color:#2e7d32;">${i+1}</span>
                <span class="poster-name">${s.name}</span>
                <span class="poster-detail" style="color:#e74c3c;">å¹´æ’ â¬†ï¸ ${s.diff}</span>
            </div>`
        ).join('');
    }
    else if (type === 'progress_class') { // ç­çº§è¿›æ­¥
        mainColor = "#17a2b8"; 
        titleStr = "ç­çº§è¿›æ­¥ä¹‹æ˜Ÿ";
        
        const data = activeData.filter(s => s.rank!==undefined).map(s => {
             const old = (compareData||[]).find(o => String(o.id) === String(s.id));
             // å¼ºåˆ¶åªç®—ç­æ’
             const diff = (old && old.rank) ? (old.rank - s.rank) : 0;
             return { ...s, diff };
        }).filter(s => s.diff > 0).sort((a, b) => b.diff - a.diff).slice(0, 15);
        
        listHtml = data.map((s, i) => 
            `<div class="poster-row">
                <span class="poster-rank" style="background:#e0f7fa; color:#006064;">${i+1}</span>
                <span class="poster-name">${s.name}</span>
                <span class="poster-detail" style="color:#0097a7;">ç­æ’ â¬†ï¸ ${s.diff}</span>
            </div>`
        ).join('');
    }
    else if (type === 'balance') {
        mainColor = "#8e44ad"; titleStr = "å…¨èƒ½æˆ˜å£«æ¦œ";
        const top30 = Math.ceil(activeData.length * 0.3);
        const pool = [...activeData].sort((a,b)=>b.totalScore-a.totalScore).slice(0, top30);
        const data = pool.map(s => {
             let arr = [];
             G_DynamicSubjectList.forEach(sub=> { 
                 const cfg = G_SubjectConfigs[sub];
                 if(typeof s.scores[sub]=='number' && cfg && cfg.full) arr.push(s.scores[sub]/cfg.full); 
             });
             if(arr.length===0) return {...s, v:999};
             const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
             const v = arr.reduce((a,b)=>a+Math.pow(b-mean,2),0)/arr.length;
             return {...s, v};
        }).sort((a,b)=>a.v - b.v).slice(0, 10);
        listHtml = data.map(s => 
            `<div class="poster-row">
                <span class="poster-icon">âš–ï¸</span>
                <span class="poster-name">${s.name}</span>
                <span class="poster-detail">æ€»åˆ† ${s.totalScore}</span>
            </div>`
        ).join('');
    }
    else if (type === 'subject') {
        mainColor = "#2980b9"; titleStr = "å•ç§‘çŠ¶å…ƒæ¦œ";
        let rows = [];
        G_DynamicSubjectList.forEach(sub => {
            let max = -Infinity;
            activeData.forEach(s => { if(s.scores[sub] > max) max = s.scores[sub]; });
            if(max > 0) {
                const kings = activeData.filter(s => s.scores[sub] === max);
                const names = kings.map(k => k.name).join('ã€');
                rows.push({ sub, names: names, score: max });
            }
        });
        listHtml = rows.map(r => 
            `<div class="poster-row">
                <span class="poster-rank" style="background:${mainColor}; width:auto; padding:2px 8px; font-size:11px;">${r.sub}</span>
                <div style="flex-grow:1; margin-left:10px; text-align:left;">
                    <span class="poster-name" style="font-size:14px;">${r.names}</span>
                </div>
                <span class="poster-score" style="color:${mainColor}">${r.score}åˆ†</span>
            </div>`
        ).join('');
    }

    // 4. æ„å»º DOM
    const posterDom = document.createElement('div');
    posterDom.style.cssText = `
        width: 375px; min-height: 600px;
        background: linear-gradient(180deg, #fff5e6 0%, #ffffff 100%);
        padding: 0 0 30px 0;
        font-family: "Microsoft YaHei", sans-serif;
        box-sizing: border-box;
        position: absolute; top: -9999px; left: -9999px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    `;

    // é¡¶éƒ¨èƒŒæ™¯è‰²
    const headerBg = `background: ${mainColor};`; 
    
    posterDom.innerHTML = `
        <div style="${headerBg} padding: 25px 20px 20px 20px; text-align: center; color: white; border-radius: 0 0 20px 20px;">
            
            ${logoHtml}
            
            <div style="font-size:16px; opacity:0.95; margin-bottom:5px; font-weight:bold; line-height:1.4;">${examName}</div>
            
            <div style="font-size:32px; font-weight:bold; letter-spacing:2px; margin-top:5px;">${titleStr}</div>
            <div style="margin-top:10px; font-size:14px; background:rgba(255,255,255,0.2); display:inline-block; padding:4px 12px; border-radius:15px;">
                ${subTitle}
            </div>
        </div>
        
        <div style="padding: 20px;">
            <div style="background:white; border-radius:12px; padding:10px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                ${listHtml}
            </div>
        </div>

        <div style="text-align:center; color:#bbb; font-size:12px;">
            - æ™ºæ…§æ£±é•œç³»ç»Ÿç”Ÿæˆ -
        </div>

        <style>
            .poster-row { display:flex; justify-content:space-between; align-items:center; padding:12px 10px; border-bottom:1px dashed #eee; }
            .poster-row:last-child { border-bottom:none; }
            .poster-rank { width:24px; height:24px; line-height:24px; text-align:center; border-radius:50%; font-size:12px; font-weight:bold; flex-shrink:0; }
            .poster-name { font-weight:bold; font-size:15px; color:#333; margin-left:10px; flex-grow:1; text-align:left; line-height:1.4; }
            .poster-score { font-weight:bold; color:#333; font-size:16px; }
            .poster-detail { color:#666; font-size:13px; }
            .poster-icon { font-size:18px; }
        </style>
    `;

    document.body.appendChild(posterDom);

    // 5. æˆªå›¾
    try {
        await new Promise(r => setTimeout(r, 200)); // ç­‰å¾…å›¾ç‰‡åŠ è½½
        const canvas = await html2canvas(posterDom, {
            scale: 2, useCORS: true, backgroundColor: null
        });
        
        container.innerHTML = '';
        canvas.style.maxWidth = '100%';
        canvas.style.height = 'auto';
        canvas.style.borderRadius = '8px';
        canvas.style.display = 'block';
        container.appendChild(canvas);
        
        downloadBtn.style.display = 'inline-block';
        downloadBtn.onclick = () => {
            const link = document.createElement('a');
            link.download = `${titleStr}_${scopeText}_å–œæŠ¥.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        };
    } catch (err) {
        console.error(err);
        container.innerHTML = `<p style="color:red;">ç”Ÿæˆå¤±è´¥ï¼š${err.message}</p>`;
    } finally {
        document.body.removeChild(posterDom);
    }
};

// =====================================================================
//    ğŸ† æ¨¡å—äºŒåå››ï¼šä¸“ä¸šå¥–çŠ¶å®šåˆ¶ (ç»ˆæå®Œæ•´ç‰ˆ)
// =====================================================================

// 1. å…¨å±€çŠ¶æ€å¯¹è±¡ (å¸¦è‡ªåŠ¨ä¿®å¤)
let G_CertState = {
    bgImage: null,
    bgRect: { x: 0, y: 0, w: 800, h: 565 },
    sealImage: null,
    seal: { x: 75, y: 75, w: 120, h: 200 }, // ç»Ÿä¸€ä½¿ç”¨ w, h
    
    texts: {
        title: 'HONORARY CERTIFICATE',
        winner: 'å¼ ä¸‰å³° åŒå­¦',
        desc: 'åœ¨æœ¬æ¬¡æœŸæœ«è€ƒè¯•ä¸­æˆç»©ä¼˜å¼‚ã€‚',
        award: 'ç‰¹è¢«è¯„ä¸ºï¼š<span class="cert-highlight">å­¦ä¹ æ ‡å…µ</span>', 
        footer: 'ç‰¹å‘æ­¤çŠ¶ï¼Œä»¥èµ„é¼“åŠ±', 
        signature: 'é¢å‘å•ä½', // é»˜è®¤ç½²å
        date: 'äºŒã€‡äºŒäº”å¹´åä¸€æœˆ'
    },
    style: {
        fontFamily: '"KaiTi", "STKaiti", "æ¥·ä½“", serif', 
        color: '#333333',
        textAlign: 'center',
        sizes: { title: 30, winner: 30, desc: 20, award: 24, footer: 20, signature: 16, date: 16 }
    },
    paper: { size: 'A4', orientation: 'L' },
    layoutMode: 'auto', 
    manualPos: { 
        title: { x: 50, y: 28 }, 
        winner: { x: 20, y: 40 }, 
        desc: { x: 51, y: 49 }, 
        award: { x: 50, y: 55 },
        footer: { x: -23.0, y: 66 }, 
        signature: { x: 74, y: 73 }, // ç½²ååæ ‡
        date: { x: 77, y: 78 } 
    }
};

// å¼ºåˆ¶çŠ¶æ€æ£€æŸ¥ (é˜²æ­¢æŠ¥é”™)
(function fixCertState() {
    if (!G_CertState.background) G_CertState.background = { x: 0, y: 0, w: 800, h: 565 };
    if (!G_CertState.seal) G_CertState.seal = { x: 75, y: 75, w: 120, h: 120 };
})();


/**
 * 2. æ¸²æŸ“å®šåˆ¶å™¨ä¸»ç•Œé¢
 */
function renderCertificateCreator(container) {
    // å­—ä½“åŠ è½½
    if (!document.getElementById('font-cn-mirror')) {
        const fontLink = document.createElement('link');
        fontLink.id = 'font-cn-mirror';
        fontLink.href = 'https://fonts.loli.net/css2?family=Ma+Shan+Zheng&family=Zhi+Mang+Xing&display=swap';
        fontLink.rel = 'stylesheet';
        document.head.appendChild(fontLink);
    }

    container.innerHTML = `
        <style>
            .cert-highlight { font-family: 'Ma Shan Zheng', cursive; font-size: 1.5em; color: #c0392b; margin: 0 5px; vertical-align: middle; }
            .cert-element { position: absolute; line-height: 1.6; white-space: nowrap; cursor: grab; border: 1px dashed transparent; z-index: 20; user-select: none; transform-origin: center center; }
            .cert-desc { white-space: pre-wrap; word-break: break-word; } /* æ­£æ–‡å…è®¸æ¢è¡Œ */
            .cert-element:hover { border-color: #007bff; background: rgba(0,123,255,0.05); }
            .cert-element:active { cursor: grabbing; }
            
            #bg-transform-box { position: absolute; z-index: 10; border: 2px solid #20c997; display: none; pointer-events: none; }
            .resize-handle { position: absolute; width: 10px; height: 10px; background: #fff; border: 1px solid #20c997; pointer-events: auto; z-index: 11; }
            .rh-nw { top: -6px; left: -6px; cursor: nw-resize; } .rh-n { top: -6px; left: 50%; margin-left:-5px; cursor: n-resize; }
            .rh-ne { top: -6px; right: -6px; cursor: ne-resize; } .rh-w { top: 50%; left: -6px; margin-top:-5px; cursor: w-resize; }
            .rh-e { top: 50%; right: -6px; margin-top:-5px; cursor: e-resize; } .rh-sw { bottom: -6px; left: -6px; cursor: sw-resize; }
            .rh-s { bottom: -6px; left: 50%; margin-left:-5px; cursor: s-resize; } .rh-se { bottom: -6px; right: -6px; cursor: se-resize; }

            .asset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; margin-top: 8px; }
            .asset-item { height: 60px; border: 2px solid #eee; border-radius: 4px; cursor: pointer; background-size: cover; background-position: center; position: relative; overflow: hidden; }
            .asset-del { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 4px; display: none; }
            .asset-item:hover .asset-del { display: block; }
            .font-option { font-size: 14px; }
        </style>

        <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
            
            <div class="main-card-wrapper" style="flex: 1; min-width: 350px; background: #f8f9fa; border-left: 4px solid #2980b9;">
                <h4 style="margin-top:0; color:#2980b9;">ğŸ› ï¸ å®šåˆ¶é¢æ¿</h4>
                
                <div class="cert-control-group" style="background: #e8f4f8; padding: 10px; border-radius: 4px; border: 1px solid #bce8f1;">
                    <label class="cert-label" style="color:#0056b3;">ğŸš€ è·å¥–åå•é€‰æ‹©</label>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.85em;">
                        <span>è¯·å‹¾é€‰è¦ç”Ÿæˆçš„å­¦ç”Ÿï¼š</span>
                        <div><a id="cert-sel-all" style="cursor:pointer; color:#007bff; margin-right:10px;">å…¨é€‰</a><a id="cert-sel-none" style="cursor:pointer; color:#666;">æ¸…ç©º</a></div>
                    </div>
                    <div id="cert-checklist-container" style="height: 120px; overflow-y: auto; background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 5px; margin-bottom: 10px;">
                        <div style="text-align:center; color:#999; padding:20px;">-- è¯·å…ˆåˆ°â€œè£èª‰æ¦œâ€åˆ·æ–°æ•°æ® --</div>
                    </div>
                    <button id="btn-batch-generate-certs" class="sidebar-button" style="width:100%; background-color:#6f42c1; font-size:0.9em;">ğŸ“¦ ç”Ÿæˆ ZIP å‹ç¼©åŒ… (0)</button>
                    <div id="cert-batch-progress-box" style="display:none; margin-top:10px;">
                        <div style="width:100%; height:8px; background:#ccc; border-radius:4px; overflow:hidden;">
                            <div id="cert-batch-bar" style="width:0%; height:100%; background:#28a745; transition:width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <div class="cert-control-group">
                    <label class="cert-label">ğŸ–¼ï¸ èƒŒæ™¯ç´ æåº“</label>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <label class="sidebar-button upload-btn" style="flex:1; text-align:center; background:#fff; border:1px solid #ccc; color:#333; cursor:pointer;">
                            â• ä¸Šä¼ æ–°èƒŒæ™¯ <input type="file" id="lib-bg-upload" accept="image/*" style="display:none;">
                        </label>
                        <button id="btn-bg-fit" class="sidebar-button" style="background:#20c997; font-size:0.8em; padding:4px 8px;" title="é“ºæ»¡">â†”ï¸</button>
                        <button id="btn-bg-reset" class="sidebar-button" style="background:#6c757d; font-size:0.8em; padding:4px 8px;" title="é‡ç½®">â†º</button>
                    </div>
                    <div id="lib-bg-grid" class="asset-grid"></div>

                    <label class="cert-label" style="margin-top:15px;">ğŸ’® å°ç« ç´ æåº“</label>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <label class="sidebar-button upload-btn" style="flex:1; text-align:center; background:#fff; border:1px solid #ccc; color:#333; cursor:pointer;">
                            â• ä¸Šä¼ æ–°å°ç«  <input type="file" id="lib-seal-upload" accept="image/*" style="display:none;">
                        </label>
                    </div>
                    <div id="lib-seal-grid" class="asset-grid"></div>
                </div>

                <div class="cert-control-group">
                    <label class="cert-label">âœï¸ æ–‡æœ¬å†…å®¹</label>
                    <input type="text" id="cert-text-title" class="cert-input" placeholder="æ ‡é¢˜" value="${G_CertState.texts.title}">
                    <input type="text" id="cert-text-winner" class="cert-input cert-input-lg" placeholder="å§“å" value="${G_CertState.texts.winner}">
                    <textarea id="cert-text-desc" class="cert-input" rows="2" placeholder="æ­£æ–‡">${G_CertState.texts.desc}</textarea>
                    <input type="text" id="cert-text-award" class="cert-input" placeholder="å¥–é¡¹è¡Œ" value='${G_CertState.texts.award}' style="border-left:4px solid #fd7e14;">
                    
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="cert-text-footer" class="cert-input" placeholder="ç»“è¯­" value="${G_CertState.texts.footer}" style="flex:1;">
                        <input type="text" id="cert-text-signature" class="cert-input" placeholder="ç½²å" value="${G_CertState.texts.signature}" style="flex:1;">
                    </div>
                    <input type="text" id="cert-text-date" class="cert-input" placeholder="æ—¥æœŸ" value="${G_CertState.texts.date}" style="text-align:right;">
                </div>

                <div class="cert-control-group">
                    <label class="cert-label">ğŸ¨ æ ·å¼è®¾ç½®</label>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <select id="cert-style-font" class="cert-input" style="margin:0; flex:2;">
                            <option value='"KaiTi", "STKaiti", "æ¥·ä½“", serif'>æ¥·ä½“</option>
                            <option value='"SimSun", "å®‹ä½“", serif'>å®‹ä½“</option>
                            <option value='"Microsoft YaHei", sans-serif'>é»‘ä½“</option>
                            <option value="'Ma Shan Zheng', cursive">âœ¨ é©¬å–„æ”¿ä¹¦æ³•</option>
                        </select>
                        <input type="color" id="cert-style-color" value="${G_CertState.style.color}" style="height:36px; padding:0; flex:1;">
                        <select id="cert-style-align" class="cert-input" style="margin:0; flex:1;">
                            <option value="center">å±…ä¸­</option>
                            <option value="left">å·¦å¯¹é½</option>
                        </select>
                    </div>
                    
                    <div style="font-size:0.8em; font-weight:bold; color:#555; margin-bottom:5px;">å­—å·å¾®è°ƒ (px):</div>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px;">
                        ${['title', 'winner', 'desc', 'award', 'footer', 'signature', 'date'].map(k => {
                            const map = {title:'æ ‡é¢˜', winner:'å§“å', desc:'æ­£æ–‡', award:'å¥–é¡¹', footer:'ç»“è¯­', signature:'ç½²å', date:'æ—¥æœŸ'};
                            return `<label style="text-align:center; font-size:0.75em;">${map[k]}<input type="number" id="size-${k}" class="pos-input" value="${G_CertState.style.sizes[k]}" style="width:100%"></label>`;
                        }).join('')}
                    </div>
                </div>

                <div class="cert-control-group">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                         <label class="cert-label">5. æ’ç‰ˆ (X/Y%)</label>
                         <label style="font-size:0.85em;"><input type="checkbox" id="cert-layout-mode"> å¯ç”¨æ‰‹åŠ¨æ’ç‰ˆ</label>
                    </div>
                    <div id="cert-manual-controls" style="display:none; background:#eee; padding:10px; border-radius:4px; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.75em; color:#666; margin-bottom:5px;">
                            <span style="margin-left:5px;">å…ƒç´ </span><span>X(%)</span><span>Y(%)</span>
                        </div>
                        ${['title', 'winner', 'desc', 'award', 'footer', 'signature', 'date'].map(k => {
                            const map = {title:'æ ‡é¢˜', winner:'å§“å', desc:'æ­£æ–‡', award:'å¥–é¡¹', footer:'ç»“è¯­', signature:'ç½²å', date:'æ—¥æœŸ'};
                            return `
                            <div style="display:flex; gap:5px; margin-bottom:5px; align-items:center;">
                                <span style="width:30px; font-size:0.8em; font-weight:bold; text-align:center;">${map[k]}</span>
                                <input type="number" id="pos-x-${k}" class="pos-input" value="${G_CertState.manualPos[k].x}">
                                <input type="number" id="pos-y-${k}" class="pos-input" value="${G_CertState.manualPos[k].y}">
                            </div>`;
                        }).join('')}
                    </div>
                    
                    <div style="margin-top:10px; background:#fff5e6; padding:8px; border-radius:4px; border:1px solid #ffe082;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <label style="font-size:0.9em; font-weight:bold; color:#d35400;">ğŸ’® å°ç« </label>
                            <label style="font-size:0.8em;">X:<input type="number" id="seal-x" class="pos-input" value="${G_CertState.seal.x}" style="width:40px;"></label>
                            <label style="font-size:0.8em;">Y:<input type="number" id="seal-y" class="pos-input" value="${G_CertState.seal.y}" style="width:40px;"></label>
                            <label style="font-size:0.8em;">å®½:<input type="number" id="seal-size" class="pos-input" value="${G_CertState.seal.w}" style="width:40px;"></label>
                        </div>
                    </div>
                </div>

                <div class="cert-control-group" style="background: #fff; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                    <label class="cert-label">0. çº¸å¼ ä¸å¸ƒå±€</label>
                    <div style="display:flex; gap:10px;">
                        <select id="cert-paper-size" class="sidebar-select" style="flex:1;">
                            <option value="A4">A4</option><option value="A3">A3</option><option value="16:9">16:9</option>
                        </select>
                        <div style="display:flex; background:#eee; border-radius:4px; padding:2px;">
                            <button class="paper-orient-btn active" data-o="L" style="border:none; padding:5px 10px; cursor:pointer;">â–­</button>
                            <button class="paper-orient-btn" data-o="P" style="border:none; padding:5px 10px; cursor:pointer;">â–¯</button>
                        </div>
                    </div>
                </div>

                <button id="btn-generate-cert" class="sidebar-button" style="width:100%; background:#2980b9; font-size:1.1em; padding: 12px;">ğŸ–¨ï¸ ç”Ÿæˆå½“å‰é¢„è§ˆå›¾</button>
            </div>

            <div class="main-card-wrapper" style="flex: 2; min-width: 400px; background: #e0e0e0; padding: 20px; display: flex; justify-content: center; align-items: center; position: sticky; top: 20px; align-self: flex-start;">
                <div id="cert-canvas-container" style="width: 800px; height: 565px; background-color: #fffdf5; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden; user-select: none;">
                    <img id="preview-bg-img" src="" style="display:none; position:absolute; cursor:move;" draggable="false">
                    <div id="bg-transform-box">
                        <div class="resize-handle rh-nw" data-dir="nw"></div><div class="resize-handle rh-n" data-dir="n"></div>
                        <div class="resize-handle rh-ne" data-dir="ne"></div><div class="resize-handle rh-w" data-dir="w"></div>
                        <div class="resize-handle rh-e" data-dir="e"></div><div class="resize-handle rh-sw" data-dir="sw"></div>
                        <div class="resize-handle rh-s" data-dir="s"></div><div class="resize-handle rh-se" data-dir="se"></div>
                    </div>
                    <div id="preview-text-title" class="cert-element" data-key="title"></div>
                    <div id="preview-text-winner" class="cert-element" data-key="winner"></div>
                    <div id="preview-text-desc" class="cert-element cert-desc" data-key="desc"></div>
                    <div id="preview-text-award" class="cert-element" data-key="award"></div>
                    <div id="preview-text-footer" class="cert-element" data-key="footer"></div>
                    <div id="preview-text-signature" class="cert-element" data-key="signature"></div>
                    <div id="preview-text-date" class="cert-element" data-key="date"></div>
                    <img id="preview-seal-img" src="" class="cert-element" style="width:120px; opacity:0.9; mix-blend-mode:multiply; display:none;" draggable="false" data-key="seal">
                </div>
            </div>
        </div>

        <div id="cert-result-modal" class="modal-overlay" style="display: none;">
             <div class="modal-content" style="max-width: 900px; text-align: center; background: #f5f5f5;">
                <div class="modal-header"><h3>ç”Ÿæˆç»“æœ</h3><span onclick="document.getElementById('cert-result-modal').style.display='none'" class="modal-close-btn">&times;</span></div>
                <div class="modal-body" style="padding:20px;"><img id="final-cert-img" style="max-width:100%; border: 1px solid #ddd;"></div>
                <div class="modal-footer" style="justify-content: center;"><a id="btn-download-cert" class="sidebar-button" style="background-color: #27ae60;">ä¸‹è½½å›¾ç‰‡</a></div>
            </div>
        </div>
        
        <style>
            .cert-control-group { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
            .cert-label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; font-size: 0.9em; }
            .cert-input { width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing:border-box; }
            .cert-input-lg { font-size: 1.1em; font-weight: bold; }
            .paper-orient-btn.active { background-color: #2980b9; color: white; }
            .paper-orient-btn { background-color: #ddd; color: #666; }
        </style>
    `;

    bindCertCreatorEvents();
    updateCertPreview();
    setupInteractionEngine(); 
    updateCertChecklist();
    
    initAssetLibrary('lib-bg', 'G_Asset_BG_Lib', 'bgImage');
    initAssetLibrary('lib-seal', 'G_Asset_Seal_Lib', 'sealImage');
}

/**
 * 3. æ›´æ–°è§†å›¾ (å¸¦é˜²å´©æ£€æŸ¥)
 */
function updateCertPreview() {
    const container = document.getElementById('cert-canvas-container');
    if (!container) return;
    const s = G_CertState;

    // é˜²å´©æ£€æŸ¥
    if (!s.background) s.background = { x: 0, y: 0, w: 800, h: 565 };
    if (!s.seal) s.seal = { x: 75, y: 75, w: 120, h: 120 };

    // A. çº¸å¼ 
    let ratio = 1.414; if (s.paper.size === '16:9') ratio = 1.777;
    const BASE = 800; let cw, ch;
    if (s.paper.orientation === 'L') { cw = BASE; ch = BASE / ratio; } else { ch = BASE; cw = BASE / ratio; }
    container.style.width = cw + 'px'; container.style.height = ch + 'px';

    // B. èƒŒæ™¯å›¾
    const bgImg = document.getElementById('preview-bg-img');
    const tb = document.getElementById('bg-transform-box');
    if (s.bgImage) {
        bgImg.src = s.bgImage; bgImg.style.display = 'block';
        if (!s.background.w) s.background = { x:0, y:0, w:cw, h:ch };
        bgImg.style.left = (s.background.x||0) + 'px'; bgImg.style.top = (s.background.y||0) + 'px';
        bgImg.style.width = s.background.w + 'px'; bgImg.style.height = s.background.h + 'px';
        if(tb) { tb.style.display='block'; tb.style.left=bgImg.style.left; tb.style.top=bgImg.style.top; tb.style.width=bgImg.style.width; tb.style.height=bgImg.style.height; }
    } else {
        bgImg.style.display = 'none'; if(tb) tb.style.display='none';
        container.style.backgroundColor = '#fffdf5'; container.style.backgroundImage = 'none';
    }

    // C. æ–‡æœ¬
    container.style.fontFamily = s.style.fontFamily; container.style.color = s.style.color;

    const updateEl = (id, text, key, defaultTop) => {
        const el = document.getElementById(id);
        if(!el) return;
        el.innerHTML = text; 
        el.style.fontSize = (s.style.sizes[key]||16) + 'px'; 
        
        // å¯¹é½é€»è¾‘
        if (key === 'desc') {
            el.style.textAlign = 'left'; el.style.textIndent = '2em'; el.style.width = '80%';
        } else if (key === 'award') {
            el.style.textAlign = 'center'; el.style.width = '100%'; 
        } else if (key === 'footer' || key === 'date' || key === 'signature') {
            el.style.textAlign = 'right'; el.style.width = 'auto'; el.style.textIndent = '0';
        } else {
            el.style.textAlign = s.style.textAlign; el.style.width = 'auto'; el.style.textIndent = '0';
        }
        
        if (s.layoutMode === 'auto') {
            el.style.top = defaultTop; el.style.transform = 'none';
            if (key === 'footer' || key === 'date' || key === 'signature') { el.style.left = 'auto'; el.style.right = '10%'; }
            else if (key === 'desc') { el.style.left = '10%'; }
            else { el.style.left = '0'; el.style.right = 'auto'; el.style.width = '100%'; }
        } else {
            const pos = s.manualPos[key];
            el.style.left = pos.x + '%'; el.style.top = pos.y + '%';
            el.style.transform = 'translate(-50%, 0)';
        }
    };

    updateEl('preview-text-title', s.texts.title, 'title', '15%');
    updateEl('preview-text-winner', s.texts.winner, 'winner', '35%');
    updateEl('preview-text-desc', s.texts.desc, 'desc', '48%');
    updateEl('preview-text-award', s.texts.award, 'award', '60%');
    updateEl('preview-text-footer', s.texts.footer, 'footer', '70%');
    updateEl('preview-text-signature', s.texts.signature, 'signature', '75%');
    updateEl('preview-text-date', s.texts.date, 'date', '80%');

    // D. å°ç« 
    const sealEl = document.getElementById('preview-seal-img');
    if (s.sealImage) {
        sealEl.src = s.sealImage; sealEl.style.display = 'block';
        sealEl.style.left = (s.seal.x||75) + '%'; sealEl.style.top = (s.seal.y||75) + '%';
        sealEl.style.width = (s.seal.w||120) + 'px';
        sealEl.style.transform = 'translate(-50%, -50%)';
    } else { sealEl.style.display = 'none'; }
}

// 4. ç»‘å®šäº‹ä»¶ (å¤šé€‰åˆ—è¡¨+æ‰¹é‡)
function bindCertCreatorEvents() {
    window.updateCertChecklist = () => {
        const container = document.getElementById('cert-checklist-container');
        const btnBatch = document.getElementById('btn-batch-generate-certs');
        if (!container) return;
        if (!window.G_Honor_List || window.G_Honor_List.length === 0) {
            container.innerHTML = `<div style="text-align:center; color:#999; padding:20px;">-- æš‚æ— æ•°æ® --</div>`;
            if(btnBatch) btnBatch.innerText = `ğŸ“¦ ç”Ÿæˆ ZIP å‹ç¼©åŒ… (0)`;
            return;
        }
        container.innerHTML = window.G_Honor_List.map((h, i) => `
            <div style="display:flex; align-items:center; padding:4px 0; border-bottom:1px dashed #eee;">
                <input type="checkbox" class="cert-batch-cb" value="${i}" id="cert-cb-${i}" checked style="margin-right:8px;">
                <label for="cert-cb-${i}" style="flex:1; cursor:pointer; font-size:0.85em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    <span style="color:#d35400; font-weight:bold;">[${h.title}]</span> ${h.name}
                </label>
                <button class="sidebar-button btn-preview-single" data-idx="${i}" style="padding:2px 6px; font-size:0.75em; background:#17a2b8; margin-left:5px;" title="å¡«å……">ğŸ‘ï¸</button>
            </div>
        `).join('');
        
        const updateBtn = () => { if(btnBatch) btnBatch.innerText = `ğŸ“¦ ç”Ÿæˆ ZIP å‹ç¼©åŒ… (${document.querySelectorAll('.cert-batch-cb:checked').length})`; };
        updateBtn();
        container.querySelectorAll('.cert-batch-cb').forEach(cb => cb.addEventListener('change', updateBtn));
        container.querySelectorAll('.btn-preview-single').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); fillCertData(e.target.dataset.idx); }));
    };
    
    const fillCertData = (idx) => {
        if (idx == null) return;
        const data = window.G_Honor_List[idx];
        G_CertState.texts.winner = data.name + " åŒå­¦";
        G_CertState.texts.desc = data.desc;
        G_CertState.texts.award = data.award;
        const elW = document.getElementById('cert-text-winner'); if(elW) elW.value = G_CertState.texts.winner;
        const elD = document.getElementById('cert-text-desc'); if(elD) elD.value = G_CertState.texts.desc;
        const elA = document.getElementById('cert-text-award'); if(elA) elA.value = G_CertState.texts.award;
        updateCertPreview();
    };
    
    updateCertChecklist();

    const btnAll = document.getElementById('cert-sel-all'); if(btnAll) btnAll.onclick = () => { document.querySelectorAll('.cert-batch-cb').forEach(c=>c.checked=true); document.getElementById('btn-batch-generate-certs').click(); };
    const btnNone = document.getElementById('cert-sel-none'); if(btnNone) btnNone.onclick = () => { document.querySelectorAll('.cert-batch-cb').forEach(c=>c.checked=false); };

    const btnBatch = document.getElementById('btn-batch-generate-certs');
    if (btnBatch) btnBatch.addEventListener('click', async () => {
        const checked = document.querySelectorAll('.cert-batch-cb:checked');
        if (checked.length === 0) { alert("è¯·å‹¾é€‰ï¼"); return; }
        if (!confirm(`ç¡®å®šç”Ÿæˆ ${checked.length} å¼ ï¼Ÿ`)) return;
        document.getElementById('cert-batch-progress-box').style.display = 'block';
        const pBar = document.getElementById('cert-batch-bar');
        btnBatch.disabled = true;
        const backup = { ...G_CertState.texts };
        const zip = new JSZip();
        const folder = zip.folder("å¥–çŠ¶");

        for (let i = 0; i < checked.length; i++) {
            const idx = checked[i].value;
            const data = window.G_Honor_List[idx];
            pBar.style.width = `${Math.round(((i + 1) / checked.length) * 100)}%`;
            
            G_CertState.texts.winner = data.name + " åŒå­¦";
            G_CertState.texts.desc = data.desc;
            G_CertState.texts.award = data.award;
            updateCertPreview();
            await new Promise(r => setTimeout(r, 150));
            const base64 = await generateHighResCertificate(true);
            if (base64) folder.file(`${data.title}_${data.name}.jpg`, base64.split(',')[1], {base64:true});
        }
        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, "å¥–çŠ¶æ‰“åŒ….zip");
        btnBatch.disabled = false;
        G_CertState.texts = backup;
        updateCertPreview();
    });

    const bindInput = (id, cb) => { const el=document.getElementById(id); if(el) el.addEventListener('input', cb); };
    ['title', 'winner', 'desc', 'award', 'footer', 'signature', 'date'].forEach(k => {
        bindInput(`cert-text-${k}`, (e) => { G_CertState.texts[k] = e.target.value; updateCertPreview(); });
        bindInput(`size-${k}`, (e) => { G_CertState.style.sizes[k] = e.target.value; updateCertPreview(); });
        bindInput(`pos-x-${k}`, (e) => { G_CertState.manualPos[k].x = e.target.value; updateCertPreview(); });
        bindInput(`pos-y-${k}`, (e) => { G_CertState.manualPos[k].y = e.target.value; updateCertPreview(); });
    });

    const fontSel = document.getElementById('cert-style-font'); if(fontSel) fontSel.onchange = (e) => { G_CertState.style.fontFamily = e.target.value; updateCertPreview(); };
    const colorInp = document.getElementById('cert-style-color'); if(colorInp) colorInp.oninput = (e) => { G_CertState.style.color = e.target.value; updateCertPreview(); };
    const alignSel = document.getElementById('cert-style-align'); if(alignSel) alignSel.onchange = (e) => { G_CertState.style.textAlign = e.target.value; updateCertPreview(); };
    const layoutCb = document.getElementById('cert-layout-mode'); if(layoutCb) layoutCb.onchange = (e) => {
        G_CertState.layoutMode = e.target.checked ? 'manual' : 'auto';
        const mc = document.getElementById('cert-manual-controls');
        if(mc) mc.style.display = e.target.checked ? 'block' : 'none';
        updateCertPreview();
    };

    bindInput('seal-x', (e) => { G_CertState.seal.x = e.target.value; updateCertPreview(); });
    bindInput('seal-y', (e) => { G_CertState.seal.y = e.target.value; updateCertPreview(); });
    bindInput('seal-size', (e) => { G_CertState.seal.w = e.target.value; G_CertState.seal.h = e.target.value; updateCertPreview(); });

    const paperSel = document.getElementById('cert-paper-size'); if(paperSel) paperSel.onchange = (e) => { G_CertState.paper.size = e.target.value; updateCertPreview(); };
    document.querySelectorAll('.paper-orient-btn').forEach(b => b.onclick = function() {
        document.querySelectorAll('.paper-orient-btn').forEach(x=>x.classList.remove('active'));
        this.classList.add('active'); G_CertState.paper.orientation = this.dataset.o; updateCertPreview();
    });
    
    const btnFit = document.getElementById('btn-bg-fit'); if(btnFit) btnFit.onclick = () => { G_CertState.background = { x:0, y:0, w:parseInt(document.getElementById('cert-canvas-container').style.width), h:parseInt(document.getElementById('cert-canvas-container').style.height) }; updateCertPreview(); };
    const btnReset = document.getElementById('btn-bg-reset'); if(btnReset) btnReset.onclick = () => { G_CertState.background = { x:0, y:0, w:800, h:565 }; updateCertPreview(); };
    
    const genBtn = document.getElementById('btn-generate-cert');
    if(genBtn) genBtn.onclick = () => generateHighResCertificate(false);
}

// 5. äº¤äº’å¼•æ“
function setupInteractionEngine() {
    const container = document.getElementById('cert-canvas-container');
    if (window.interactionEngineBound) return;
    window.interactionEngineBound = true;

    let mode = null, startX, startY, startRect, startPos, activeKey;
    
    container.addEventListener('mousedown', (e) => {
        const t = e.target;
        startX = e.clientX; startY = e.clientY;
        
        document.body.style.userSelect = 'none';
        
        if (t.classList.contains('cert-element') || t.classList.contains('resize-handle') || t.id==='preview-bg-img') {
            if (G_CertState.layoutMode === 'auto') {
                G_CertState.layoutMode = 'manual';
                document.getElementById('cert-layout-mode').checked = true;
                document.getElementById('cert-manual-controls').style.display = 'block';
                updateCertPreview(); 
            }
        }

        if (t.classList.contains('resize-handle')) {
            mode = 'resize_bg'; startRect = { ...G_CertState.background }; e.preventDefault();
        } else if (t.id === 'preview-bg-img') {
            mode = 'move_bg'; startRect = { ...G_CertState.background }; e.preventDefault();
        } else if (t.dataset.key === 'seal') {
            mode = 'move_seal'; startPos = { x: parseFloat(G_CertState.seal.x), y: parseFloat(G_CertState.seal.y) }; e.preventDefault();
        } else if (t.classList.contains('cert-element')) {
            mode = 'move_text'; activeKey = t.dataset.key;
            startPos = { x: parseFloat(G_CertState.manualPos[activeKey].x), y: parseFloat(G_CertState.manualPos[activeKey].y) }; e.preventDefault();
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (!mode) return;
        e.preventDefault();
        const dx = e.clientX - startX, dy = e.clientY - startY;
        const rect = container.getBoundingClientRect();
        
        if (mode === 'move_bg') {
            G_CertState.background.x = startRect.x + dx; G_CertState.background.y = startRect.y + dy;
        } else if (mode === 'move_seal') {
            G_CertState.seal.x = (startPos.x + (dx/rect.width)*100).toFixed(1);
            G_CertState.seal.y = (startPos.y + (dy/rect.height)*100).toFixed(1);
            const sx=document.getElementById('seal-x'), sy=document.getElementById('seal-y');
            if(sx) sx.value = G_CertState.seal.x; if(sy) sy.value = G_CertState.seal.y;
        } else if (mode === 'move_text') {
            G_CertState.manualPos[activeKey].x = (startPos.x + (dx/rect.width)*100).toFixed(1);
            G_CertState.manualPos[activeKey].y = (startPos.y + (dy/rect.height)*100).toFixed(1);
            const ix=document.getElementById(`pos-x-${activeKey}`), iy=document.getElementById(`pos-y-${activeKey}`);
            if(ix) ix.value = G_CertState.manualPos[activeKey].x; if(iy) iy.value = G_CertState.manualPos[activeKey].y;
        } else if (mode === 'resize_bg') {
            G_CertState.background.w = Math.max(20, startRect.w + dx);
            G_CertState.background.h = Math.max(20, startRect.h + dy);
        }
        requestAnimationFrame(updateCertPreview);
    });
    document.addEventListener('mouseup', () => { mode = null; document.body.style.userSelect = ''; });
}

// 6. ç´ æåº“ä¸è¾…åŠ©
window.initAssetLibrary = async function(typePrefix, storageKey, targetStateKey) {
    const uploadInput = document.getElementById(`${typePrefix}-upload`);
    const gridContainer = document.getElementById(`${typePrefix}-grid`);
    if (!uploadInput || !gridContainer) return;

    let library = await localforage.getItem(storageKey) || [];
    const renderGrid = () => {
        if (library.length === 0) { gridContainer.innerHTML = `<div style="font-size:0.8em; color:#ccc; padding:10px;">æš‚æ— ç´ æ</div>`; return; }
        gridContainer.innerHTML = library.map((item, idx) => `
            <div class="asset-item" onclick="window.applyAssetData('${item}', '${targetStateKey}')" style="background-image:url('${item}');">
                <div class="asset-del" onclick="event.stopPropagation(); window.deleteAssetItem('${storageKey}', ${idx}, '${typePrefix}', '${targetStateKey}')">ğŸ—‘ï¸</div>
            </div>`).join('');
    };
    
    const newInput = uploadInput.cloneNode(true);
    uploadInput.parentNode.replaceChild(newInput, uploadInput);
    newInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (evt) => {
            let base64 = evt.target.result;
            // è‡ªåŠ¨å»ç™½åº•
            if (targetStateKey === 'sealImage' && typeof removeWhiteBackground === 'function') {
                if(confirm("æ˜¯å¦å»é™¤å°ç« ç™½åº•?")) base64 = await removeWhiteBackground(base64);
            }
            library.push(base64); await localforage.setItem(storageKey, library);
            window.applyAssetData(base64, targetStateKey); renderGrid();
        };
        reader.readAsDataURL(file);
        newInput.value = '';
    });
    renderGrid();
};

window.applyAssetData = function(base64, key) {
    G_CertState[key] = base64;
    if (key === 'bgImage') G_CertState.background = { x: 0, y: 0, w: 800, h: 565 };
    updateCertPreview();
};

window.deleteAssetItem = async function(sKey, idx, pre, tKey) {
    if(!confirm('åˆ é™¤?')) return;
    let lib = await localforage.getItem(sKey); lib.splice(idx, 1); await localforage.setItem(sKey, lib);
    window.initAssetLibrary(pre, sKey, tKey);
};

/**
 * [è¾…åŠ©å‡½æ•°] å›¾ç‰‡æ™ºèƒ½å»ç™½åº•
 */
function removeWhiteBackground(base64Data, tolerance = 60) {
    return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const distance = Math.sqrt((255-r)**2 + (255-g)**2 + (255-b)**2);
                if (distance < tolerance) data[i+3] = 0;
            }
            ctx.putImageData(imgData, 0, 0);
            resolve(canvas.toDataURL('image/png'));
        };
        img.src = base64Data;
    });
}

// 7. ç”Ÿæˆé«˜æ¸…å›¾
async function generateHighResCertificate(isBatch = false) {
    const dom = document.getElementById('cert-canvas-container');
    const modal = document.getElementById('cert-result-modal');
    if (!isBatch) { modal.style.display = 'flex'; document.getElementById('final-cert-img').alt = 'æ¸²æŸ“ä¸­...'; }

    const clone = dom.cloneNode(true);
    clone.style.cssText += 'position:absolute; top:-9999px; left:-9999px; margin:0; transform:none; z-index:-1;';
    
    // éšè—å˜å½¢æ¡†
    const box = clone.querySelector('#bg-transform-box');
    if(box) box.style.display = 'none';
    
    document.body.appendChild(clone);

    try {
        await new Promise(r => setTimeout(r, 100));
        const canvas = await html2canvas(clone, { scale: 4, useCORS: true, backgroundColor: null, logging: false });
        const data = canvas.toDataURL('image/jpeg', 0.9);
        
        if (isBatch) return data;
        
        document.getElementById('final-cert-img').src = data;
        const btn = document.getElementById('btn-download-cert');
        btn.href = data;
        btn.download = `å¥–çŠ¶_${G_CertState.texts.winner.replace(/\s/g,'')}.jpg`;
    } catch (e) { console.error(e); } 
    finally { document.body.removeChild(clone); }
}


// =====================================================================
//    NEW    ä¾§è¾¹æ æ¨¡å—æ˜¾ç¤ºç®¡ç†å™¨
// =====================================================================

// 1. å®šä¹‰æ‰€æœ‰å¯é…ç½®çš„æ¨¡å— (ID å¯¹åº” data-module å±æ€§, Name å¯¹åº”æ˜¾ç¤ºæ–‡æœ¬)
const ALL_MODULE_DEFINITIONS = [
    { id: 'dashboard', name: 'ğŸ“ˆ æ•´ä½“æˆç»©åˆ†æ' },
    { id: 'student', name: 'ğŸ‘©â€ğŸ“ å­¦ç”Ÿä¸ªä½“æŠ¥å‘Š' },
    { id: 'paper', name: 'ğŸ“ è¯•å·ç§‘ç›®åˆ†æ' },
    { id: 'single-subject', name: 'ğŸ¯ å•ç§‘æˆç»©åˆ†æ' },
    { id: 'boundary', name: 'ğŸ“Š ä¸´ç•Œç”Ÿåˆ†æ' },
    { id: 'holistic', name: 'âš–ï¸ å…¨ç§‘å‡è¡¡åˆ†æ' },
    { id: 'trend-distribution', name: 'ğŸŒŠ æˆç»©åˆ†å¸ƒå˜åŠ¨' },
    { id: 'groups', name: 'ğŸ¯ å­¦ç”Ÿåˆ†å±‚ç­›é€‰' },
    { id: 'correlation', name: 'ğŸŒ¡ï¸ å­¦ç§‘å…³è”çŸ©é˜µ' },
    { id: 'weakness', name: 'ğŸ“‰ åç§‘è¯Šæ–­åˆ†æ' },
    { id: 'trend', name: 'ğŸš€ æˆç»©è¶‹åŠ¿å¯¹æ¯”' },
    { id: 'item-analysis', name: 'ğŸ”¬ å­¦ç§‘å°é¢˜åˆ†æ' },
    { id: 'ai-advisor', name: 'ğŸ¤– AI æ™ºèƒ½åˆ†æ' },
    { id: 'goal-setting', name: 'ğŸ¯ ç›®æ ‡ä¸è§„åˆ’' },
    { id: 'exam-arrangement', name: 'ğŸ§˜ è€ƒåœºç¼–æ’' },
    { id: 'study-groups', name: 'ğŸ§© æ™ºèƒ½äº’åŠ©åˆ†ç»„' },
    { id: 'comment-gen', name: 'âœï¸ è¯„è¯­ç”ŸæˆåŠ©æ‰‹' },
    { id: 'weakness-workbook', name: 'ğŸ“ é”™é¢˜æ”»åšæœ¬' },
    // æ³¨æ„ï¼š'multi-exam' (æ•°æ®ç®¡ç†ä¸­å¿ƒ) ä¸å»ºè®®éšè—ï¼Œå› ä¸ºå®ƒæ˜¯æ•°æ®æºå¤´ï¼Œæ•…ä¸åˆ—å…¥
];

// 2. åˆå§‹åŒ–ç®¡ç†å™¨
function initModuleSettingsManager() {
    const openBtn = document.getElementById('module-settings-btn');
    const modal = document.getElementById('module-settings-modal');
    const closeBtn = document.getElementById('module-settings-close-btn');
    const saveBtn = document.getElementById('module-settings-save-btn');
    const listContainer = document.getElementById('module-checklist-container');

    if (!openBtn) return;

    // åŠ è½½å·²ä¿å­˜çš„è®¾ç½® (é»˜è®¤å…¨éƒ¨æ˜¾ç¤º)
    // å­˜å‚¨æ ¼å¼: JSON array of visible IDs
    const getSavedSettings = () => {
        const json = localStorage.getItem('App_Module_Visibility');
        if (json) return JSON.parse(json);
        // é»˜è®¤æ‰€æœ‰ ID éƒ½å­˜åœ¨
        return ALL_MODULE_DEFINITIONS.map(m => m.id);
    };

    // åº”ç”¨è®¾ç½® (éšè—/æ˜¾ç¤ºä¾§è¾¹æ  LI)
    const applySettings = () => {
        const visibleIds = getSavedSettings();
        const visibleSet = new Set(visibleIds);

        ALL_MODULE_DEFINITIONS.forEach(mod => {
            // æ‰¾åˆ°å¯¹åº”çš„ä¾§è¾¹æ é“¾æ¥
            const link = document.querySelector(`.sidebar a[data-module="${mod.id}"]`);
            if (link) {
                // æ§åˆ¶æ•´ä¸ª li (linkçš„çˆ¶çº§)
                const li = link.parentElement;
                if (visibleSet.has(mod.id)) {
                    li.style.display = ''; // æ¢å¤æ˜¾ç¤º
                } else {
                    li.style.display = 'none'; // éšè—
                }
            }
        });
    };

    // æ¸²æŸ“æ¨¡æ€æ¡†å†…å®¹
    const renderChecklist = () => {
        const visibleIds = new Set(getSavedSettings());

        listContainer.innerHTML = ALL_MODULE_DEFINITIONS.map(mod => {
            const isChecked = visibleIds.has(mod.id) ? 'checked' : '';
            return `
                <label style="display: flex; align-items: center; padding: 8px; background: #faf9f8ff; border-radius: 4px; border: 1px solid #eee; cursor: pointer;">
                    <input type="checkbox" value="${mod.id}" ${isChecked} style="margin-right: 10px;">
                    <span>${mod.name}</span>
                </label>
            `;
        }).join('');
    };

    // æ‰“å¼€æ¨¡æ€æ¡†
    openBtn.addEventListener('click', () => {
        renderChecklist();
        modal.style.display = 'flex';
    });

    // å…³é—­
    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    // ä¿å­˜
    saveBtn.addEventListener('click', () => {
        const checkboxes = listContainer.querySelectorAll('input[type="checkbox"]');
        const newVisibleIds = [];
        checkboxes.forEach(cb => {
            if (cb.checked) newVisibleIds.push(cb.value);
        });

        // è‡³å°‘ä¿ç•™ä¸€ä¸ªæ¨¡å—ï¼Œé˜²æ­¢å…¨éƒ¨éšè—å¯¼è‡´ä¸å¯ç”¨
        if (newVisibleIds.length === 0) {
            alert("è¯·è‡³å°‘ä¿ç•™ä¸€ä¸ªæ¨¡å—ï¼");
            return;
        }

        localStorage.setItem('App_Module_Visibility', JSON.stringify(newVisibleIds));
        applySettings();
        modal.style.display = 'none';

        // å¦‚æœå½“å‰æ‰€åœ¨çš„æ¨¡å—è¢«éšè—äº†ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªå¯è§æ¨¡å—
        const currentActive = document.querySelector('.nav-link.active');
        if (currentActive && currentActive.dataset.module && !newVisibleIds.includes(currentActive.dataset.module)) {
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è§çš„é“¾æ¥å¹¶ç‚¹å‡»
            const firstVisibleId = newVisibleIds[0];
            const firstLink = document.querySelector(`.sidebar a[data-module="${firstVisibleId}"]`);
            if (firstLink) firstLink.click();
        }
    });

    // åˆå§‹åŒ–æ—¶åº”ç”¨ä¸€æ¬¡
    applySettings();
}

// 3. å¯åŠ¨
document.addEventListener('DOMContentLoaded', () => {
    // ç¨å¾®å»¶æ—¶ä¸€ç‚¹ï¼Œç¡®ä¿ DOM ç»“æ„å®Œå…¨å°±ç»ª
    setTimeout(initModuleSettingsManager, 100);
});



// =====================================================================
//    NEW    ä¾§è¾¹æ æŠ˜å æ§åˆ¶å™¨ (æ‚¬æµ®æ‰‹æŸ„ç‰ˆ)
// =====================================================================
function initSidebarToggle() {
    const handle = document.getElementById('sidebar-drag-handle'); // [ä¿®æ”¹] è·å–   ID
    const sidebar = document.querySelector('.sidebar');

    if (!handle || !sidebar) return;

    // 1. è¯»å–ç”¨æˆ·ä¸Šæ¬¡çš„åå¥½
    const isCollapsed = localStorage.getItem('App_Sidebar_Collapsed') === 'true';
    if (isCollapsed) {
        sidebar.classList.add('collapsed');
    }

    // 2. ç‚¹å‡»äº‹ä»¶
    handle.addEventListener('click', () => {
        // åˆ‡æ¢ class
        sidebar.classList.toggle('collapsed');

        // ä¿å­˜åå¥½
        const collapsed = sidebar.classList.contains('collapsed');
        localStorage.setItem('App_Sidebar_Collapsed', collapsed);

        //    å…³é”®    è§¦å‘å›¾è¡¨é‡ç»˜
        // å› ä¸ºä¾§è¾¹æ æ”¶èµ·æœ‰ 0.3s çš„åŠ¨ç”»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­æˆ–ç»“æŸåè°ƒæ•´å›¾è¡¨å¤§å°
        setTimeout(() => {
            resizeAllCharts();
        }, 310);
    });
}

// [è¾…åŠ©] é‡ç½®æ‰€æœ‰ ECharts å›¾è¡¨å¤§å°
function resizeAllCharts() {
    for (const key in echartsInstances) {
        if (echartsInstances[key]) {
            echartsInstances[key].resize();
        }
    }
}

// 3. å¯åŠ¨
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebarToggle);
} else {
    initSidebarToggle();
}


// =====================================================================
//    NEW    ä¾§è¾¹æ å®½åº¦æ‹–æ‹½åŠŸèƒ½
// =====================================================================
function initSidebarResizer() {
    const resizer = document.getElementById('sidebar-resizer');
    const sidebar = document.querySelector('.sidebar');

    if (!resizer || !sidebar) return;

    let isResizing = false;
    let lastDownX = 0;

    // 1. é¼ æ ‡æŒ‰ä¸‹ (Start)
    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        lastDownX = e.clientX;

        // æ·»åŠ æ ·å¼æ ‡è®°
        resizer.classList.add('resizing');

        // [å…³é”®] æš‚æ—¶ç§»é™¤è¿‡æ¸¡åŠ¨ç”»ï¼Œè®©æ‹–åŠ¨è·Ÿæ‰‹
        sidebar.classList.add('no-transition');

        // é˜²æ­¢é€‰ä¸­æ–‡å­—
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
    });

    // 2. é¼ æ ‡ç§»åŠ¨ (Move) - ç»‘å®šåˆ° document ä»¥é˜²é¼ æ ‡ç§»å‡ºä¾§è¾¹æ 
    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        // è®¡ç®—  å®½åº¦ (ç›´æ¥ä½¿ç”¨é¼ æ ‡çš„ X åæ ‡ä½œä¸ºå®½åº¦)
        // å› ä¸ºä¾§è¾¹æ åœ¨å·¦ä¾§ï¼Œé¼ æ ‡Xåæ ‡åŸºæœ¬ä¸Šå°±æ˜¯ä¾§è¾¹æ çš„å®½åº¦
        let newWidth = e.clientX;

        // é™åˆ¶æœ€å°/æœ€å¤§å®½åº¦ (è™½ç„¶CSSæœ‰å†™ï¼ŒJSé™åˆ¶æ›´æµç•…)
        if (newWidth < 150) newWidth = 150;
        if (newWidth > 600) newWidth = 600;

        sidebar.style.width = `${newWidth}px`;

        // å®æ—¶é‡ç»˜å›¾è¡¨ (å¯é€‰ï¼Œå¦‚æœè§‰å¾—å¡é¡¿å¯ä»¥å»æ‰è¿™ä¸€è¡Œï¼Œåªåœ¨mouseupæ—¶é‡ç»˜)
        // requestAnimationFrame(() => resizeAllCharts()); 
    });

    // 3. é¼ æ ‡æ¾å¼€ (End)
    document.addEventListener('mouseup', (e) => {
        if (!isResizing) return;

        isResizing = false;
        resizer.classList.remove('resizing');

        // [å…³é”®] æ¢å¤è¿‡æ¸¡åŠ¨ç”»
        sidebar.classList.remove('no-transition');

        // æ¢å¤é¼ æ ‡æ ·å¼
        document.body.style.cursor = '';
        document.body.style.userSelect = '';

        // æ‹–æ‹½ç»“æŸï¼Œå¿…é¡»é‡ç»˜ä¸€æ¬¡å›¾è¡¨ä»¥é€‚åº”  å°ºå¯¸
        resizeAllCharts();
    });
}

// å¯åŠ¨
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebarResizer);
} else {
    initSidebarResizer();
}


// =====================================================================
//    NEW    å›¾è¡¨è‡ªé€‚åº”  å¼º (ResizeObserver)
// =====================================================================
function initChartAutoResize() {
    const mainContent = document.querySelector('.main-content');
    if (!mainContent) return;

    // åˆ›å»ºè§‚å¯Ÿè€…ï¼šåªè¦ä¸»å†…å®¹åŒºå¤§å°å‘ç”Ÿå¾®å°å˜åŒ–ï¼Œå°±è§¦å‘å›¾è¡¨é‡ç»˜
    const observer = new ResizeObserver(() => {
        // ä½¿ç”¨ requestAnimationFrame é¿å…é«˜é¢‘è§¦å‘å¯¼è‡´å¡é¡¿
        window.requestAnimationFrame(() => {
            resizeAllCharts();
        });
    });

    // å¼€å§‹ç›‘å¬
    observer.observe(mainContent);
}

// å¯åŠ¨ç›‘å¬
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initChartAutoResize);
} else {
    initChartAutoResize();
}

// [è¾…åŠ©] é‡ç½®æ‰€æœ‰ ECharts å›¾è¡¨å¤§å° (  å¼ºç‰ˆ)
function resizeAllCharts() {
    for (const key in echartsInstances) {
        if (echartsInstances[key]) {
            // [å…³é”®] ä¼ å…¥å‚æ•°ï¼Œå¼ºåˆ¶ ECharts é‡  è¯»å–å®¹å™¨å®½åº¦
            // å¦åˆ™å®ƒå¯èƒ½è¿˜ä¼šæ²¿ç”¨ä¹‹å‰çš„å®½ canvas
            echartsInstances[key].resize({
                width: 'auto',
                height: 'auto'
            });
        }
    }
}

/**
 * [ä¿®æ”¹ç‰ˆ] æ¸²æŸ“ç­‰çº§æ„æˆå›¾ (æ”¯æŒ Raw / TScore åŒæ¨¡å¼)
 */
function renderTrendCompositionChart(elementId, currentData, compareData, mode = 'raw') {
    const chartDom = document.getElementById(elementId);
    if (!chartDom) return;
    if (echartsInstances[elementId]) echartsInstances[elementId].dispose();
    echartsInstances[elementId] = echarts.init(chartDom);

    const subjects = G_DynamicSubjectList;
    const dataMap = { curr: { A: [], B: [], C: [], D: [] }, comp: { A: [], B: [], C: [], D: [] } };

    // å†…éƒ¨è¾…åŠ©ï¼šè·å–å•ç§‘ç»Ÿè®¡
    const calcDist = (list, subject) => {
        let cA = 0, cB = 0, cC = 0, cD = 0, total = 0;
        const config = G_SubjectConfigs[subject] || {}; // è·å–åˆ†æ•°çº¿é…ç½®

        list.forEach(s => {
            let val, isGood;
            if (mode === 'tscore') {
                val = (s.tScores && s.tScores[subject]); // Tåˆ†
                // Tåˆ†æ ‡å‡†ï¼šA>=60, B>=50, C>=40
                if (val !== undefined && val !== null && !isNaN(val)) {
                    total++;
                    if (val >= 60) cA++;
                    else if (val >= 50) cB++;
                    else if (val >= 40) cC++;
                    else cD++;
                }
            } else {
                val = s.scores[subject]; // åŸå§‹åˆ†
                // åŸå§‹åˆ†æ ‡å‡†ï¼šè¯»å– Config
                if (val !== undefined && val !== null && !isNaN(val)) {
                    total++;
                    if (val >= config.excel) cA++;
                    else if (val >= config.good) cB++;
                    else if (val >= config.pass) cC++;
                    else cD++;
                }
            }
        });

        if (total === 0) return { A: 0, B: 0, C: 0, D: 0 };
        return {
            A: parseFloat(((cA / total) * 100).toFixed(1)),
            B: parseFloat(((cB / total) * 100).toFixed(1)),
            C: parseFloat(((cC / total) * 100).toFixed(1)),
            D: parseFloat(((cD / total) * 100).toFixed(1))
        };
    };

    subjects.forEach(sub => {
        const curr = calcDist(currentData, sub);
        const comp = calcDist(compareData, sub);
        ['A', 'B', 'C', 'D'].forEach(k => {
            dataMap.curr[k].push(curr[k]);
            dataMap.comp[k].push(comp[k]);
        });
    });

    const colors = { A: '#28a745', B: '#007bff', C: '#ffc107', D: '#dc3545' };
    const titleText = mode === 'tscore' ? 'å„ç§‘ Tåˆ†ç­‰çº§æ„æˆ (A:Tâ‰¥60, B:â‰¥50, C:â‰¥40)' : 'å„ç§‘ åŸå§‹åˆ†ç­‰çº§æ„æˆ (åŸºäºä¼˜ç§€/è‰¯å¥½/åŠæ ¼çº¿)';

    const option = {
        title: { text: titleText, left: 'center', textStyle: { fontSize: 14, fontWeight: 'normal', color: '#666' }, top: 5 },
        tooltip: {
            trigger: 'axis', axisPointer: { type: 'shadow' },
            formatter: (params) => {
                let html = `<strong>${params[0].name}</strong><br/>`;
                html += `<div style="display:inline-block; width:49%; vertical-align:top;">`;
                html += `<div style="border-bottom:1px solid #eee; margin-bottom:5px;">ğŸ“˜ æœ¬æ¬¡</div>`;
                params.filter(p => p.seriesName.startsWith('æœ¬æ¬¡')).reverse().forEach(p => html += `${p.marker} ${p.seriesName.split('-')[1]}: ${p.value}%<br/>`);
                html += `</div>`;
                html += `<div style="display:inline-block; width:49%; vertical-align:top; margin-left:2%;">`;
                html += `<div style="border-bottom:1px solid #eee; margin-bottom:5px; color:#999;">ğŸ““ ä¸Šæ¬¡</div>`;
                params.filter(p => p.seriesName.startsWith('ä¸Šæ¬¡')).reverse().forEach(p => html += `${p.marker} ${p.seriesName.split('-')[1]}: ${p.value}%<br/>`);
                html += `</div>`;
                return html;
            }
        },
        legend: { data: ['A (ä¼˜ç§€)', 'B (è‰¯å¥½)', 'C (åŠæ ¼)', 'D (ä¸åŠæ ¼)'], bottom: 0 },
        grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
        xAxis: { type: 'category', data: subjects, axisLabel: { rotate: 30, interval: 0 } },
        yAxis: { type: 'value', max: 100, name: 'ç™¾åˆ†æ¯” (%)' },
        series: [
            { name: 'æœ¬æ¬¡-D (ä¸åŠæ ¼)', stack: 'current', type: 'bar', data: dataMap.curr.D, itemStyle: { color: colors.D }, barGap: 0 },
            { name: 'æœ¬æ¬¡-C (åŠæ ¼)', stack: 'current', type: 'bar', data: dataMap.curr.C, itemStyle: { color: colors.C } },
            { name: 'æœ¬æ¬¡-B (è‰¯å¥½)', stack: 'current', type: 'bar', data: dataMap.curr.B, itemStyle: { color: colors.B } },
            { name: 'æœ¬æ¬¡-A (ä¼˜ç§€)', stack: 'current', type: 'bar', data: dataMap.curr.A, itemStyle: { color: colors.A } },

            { name: 'ä¸Šæ¬¡-D (ä¸åŠæ ¼)', stack: 'compare', type: 'bar', data: dataMap.comp.D, itemStyle: { color: colors.D, opacity: 0.4 } },
            { name: 'ä¸Šæ¬¡-C (åŠæ ¼)', stack: 'compare', type: 'bar', data: dataMap.comp.C, itemStyle: { color: colors.C, opacity: 0.4 } },
            { name: 'ä¸Šæ¬¡-B (è‰¯å¥½)', stack: 'compare', type: 'bar', data: dataMap.comp.B, itemStyle: { color: colors.B, opacity: 0.4 } },
            { name: 'ä¸Šæ¬¡-A (ä¼˜ç§€)', stack: 'compare', type: 'bar', data: dataMap.comp.A, itemStyle: { color: colors.A, opacity: 0.4 } },

            // ä»£ç†å›¾ä¾‹
{ 
                name: 'A (ä¼˜ç§€)', type: 'bar', stack: 'current', data: [], 
                itemStyle: { color: colors.A } 
            },
            { 
                name: 'B (è‰¯å¥½)', type: 'bar', stack: 'current', data: [], 
                itemStyle: { color: colors.B } 
            },
            { 
                name: 'C (åŠæ ¼)', type: 'bar', stack: 'current', data: [], 
                itemStyle: { color: colors.C } 
            },
            { 
                name: 'D (ä¸åŠæ ¼)', type: 'bar', stack: 'current', data: [], 
                itemStyle: { color: colors.D } 
            }
        ]
    };
    echartsInstances[elementId].setOption(option);
}


/**
 * 13.9. æ‰¹é‡å¯¼å…¥çŸ¥è¯†ç‚¹é…ç½®
 */
function batchImportKnowledge() {
    const textarea = document.getElementById('item-config-batch-knowledge');
    const inputContent = textarea.value.trim();

    if (!inputContent) {
        alert("è¯·å…ˆåœ¨æ–‡æœ¬æ¡†ä¸­ç²˜è´´çŸ¥è¯†ç‚¹å†…å®¹ã€‚");
        return;
    }

    // 1. æŒ‰è¡Œåˆ†å‰²å†…å®¹
    const knowledgeList = inputContent.split('\n').map(s => s.trim()).filter(s => s.length > 0);
    if (knowledgeList.length === 0) {
        alert("ç²˜è´´çš„å†…å®¹ä¸ºç©ºæˆ–æ— æ³•è¯†åˆ«æ¢è¡Œã€‚");
        return;
    }

    // 2. è·å–é…ç½®è¡¨æ ¼ä¸­çš„æ‰€æœ‰è¡Œ
    const tbody = document.getElementById('item-config-table-body');
    if (!tbody) return;
    
    // 3. [æ ¸å¿ƒä¿®æ”¹] ç­›é€‰å‡ºéœ€è¦å¡«å……çš„ã€å°é¢˜ã€‘è¡Œ
    const qRows = Array.from(tbody.querySelectorAll('tr')).filter(row => {
        // è·å–ç¬¬ä¸€åˆ—çš„æ–‡æœ¬ï¼Œæ£€æŸ¥å®ƒæ˜¯å¦ä»¥æ•°å­—å¼€å¤´ (ä¾‹å¦‚ "1 (å°é¢˜)", "10 (å°é¢˜)")
        const firstCellText = row.cells[0]?.textContent.trim() || '';
        // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ¤æ–­ï¼šå¿…é¡»ä»¥æ•°å­—å¼€å¤´ï¼Œå¹¶ä¸”åŒ…å«æ‹¬å·å’Œâ€œå°é¢˜â€å­—æ ·
        return /^\d+\s*\(å°é¢˜\)$/i.test(firstCellText);
    });

    if (qRows.length === 0) {
        alert("âš ï¸ é”™è¯¯ï¼šè¡¨æ ¼ä¸­æ²¡æœ‰æ£€æµ‹åˆ°å¯é…ç½®çš„å°é¢˜ã€‚");
        return;
    }

    let matchCount = 0;
    
    // 4. éå†çŸ¥è¯†ç‚¹åˆ—è¡¨å¹¶æŒ‰é¡ºåºåŒ¹é…ç­›é€‰åçš„è¡Œ
    for (let i = 0; i < knowledgeList.length; i++) {
        const knowledge = knowledgeList[i];
        const row = qRows[i]; // æŒ‰é¡ºåºåŒ¹é…ã€å°é¢˜ã€‘

        if (row) {
            // æ‰¾åˆ°å¯¹åº”çš„çŸ¥è¯†ç‚¹è¾“å…¥æ¡†å¹¶èµ‹å€¼
            const contentInput = row.querySelector('.item-config-content');
            if (contentInput) {
                contentInput.value = knowledge;
                matchCount++;
            }
        } else {
            // çŸ¥è¯†ç‚¹æ•°é‡å¤šäºè¡¨æ ¼ä¸­çš„å°é¢˜æ•°é‡ï¼Œåœæ­¢åŒ¹é…
            break;
        }
    }

    if (matchCount > 0) {
        alert(`ğŸ‰ æˆåŠŸå¯¼å…¥ ${matchCount} ä¸ªçŸ¥è¯†ç‚¹åˆ°å°é¢˜ã€‚`);
        // æ¸…ç©ºæ–‡æœ¬æ¡†ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨
        textarea.value = ''; 
    } else {
        alert("âš ï¸ å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¡®è®¤ç²˜è´´çš„çŸ¥è¯†ç‚¹æ•°é‡ä¸å°é¢˜æ•°é‡æ˜¯å¦åŒ¹é…ã€‚");
    }
}


/**
 * 13.10. æ¸…ç©ºæ‰€æœ‰é¢˜ç›®çš„çŸ¥è¯†ç‚¹é…ç½®
 */
function clearAllKnowledgeConfig() {
    if (!confirm("âš ï¸ ç¡®å®šè¦æ¸…ç©ºå½“å‰ç§‘ç›®é…ç½®ä¸­æ‰€æœ‰é¢˜ç›®çš„ã€è€ƒå¯Ÿå†…å®¹ï¼ˆçŸ¥è¯†ç‚¹ï¼‰ã€‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œéœ€è¦æ‰‹åŠ¨ä¿å­˜åæ‰ä¼šç”Ÿæ•ˆï¼")) {
        return;
    }

    const tbody = document.getElementById('item-config-table-body');
    if (!tbody) return;

    const contentInputs = tbody.querySelectorAll('.item-config-content');

    if (contentInputs.length === 0) {
        alert("é…ç½®è¡¨æ ¼ä¸­æ²¡æœ‰æ‰¾åˆ°å¯æ¸…ç©ºçš„çŸ¥è¯†ç‚¹è¾“å…¥æ¡†ã€‚");
        return;
    }
    
    let clearCount = 0;
    contentInputs.forEach(input => {
        if (input.value !== "") {
            input.value = "";
            clearCount++;
        }
    });

    alert(`ğŸ—‘ï¸ æˆåŠŸæ¸…ç©ºäº† ${clearCount} ä¸ªçŸ¥è¯†ç‚¹çš„é…ç½®ï¼\nè¯·åŠ¡å¿…ç‚¹å‡»ä¸‹æ–¹çš„ã€ä¿å­˜é…ç½®ã€‘æŒ‰é’®ä»¥ç”Ÿæ•ˆã€‚`);
}

/**
 * [å‡çº§ç‰ˆ] 10.22. æ¸²æŸ“åˆ†æ•°æ®µå¹³æ»‘æ›²çº¿å›¾
 * - æ”¯æŒï¼šå•ç§‘åˆ†å¸ƒã€å…¨ç§‘å¯¹æ¯”
 * - æ–°å¢ï¼šå„ç­çº§å¯¹æ¯” (isClassCompare = true)
 */
function renderScoreCurve(elementId, students, subject, binSize, isClassCompare = false) {
    const chartDom = document.getElementById(elementId);
    const analysisDiv = document.getElementById('curve-analysis-text');
    if (!chartDom) return;

    if (echartsInstances[elementId]) {
        echartsInstances[elementId].dispose();
    }
    const myChart = echarts.init(chartDom);
    echartsInstances[elementId] = myChart;

    const isAllSubjects = (subject === 'ALL_SUBJECTS');
    let series = [];
    let categories = [];
    let analysisText = "";
    const colors = ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc'];

    // ============================================================
    // æ¨¡å¼ A: å…¨ç§‘å¯¹æ¯” (åŸé€»è¾‘ä¿æŒä¸å˜ï¼Œå¼ºåˆ¶å…³é—­ç­çº§å¯¹æ¯”)
    // ============================================================
    if (isAllSubjects) {
        // ... (ä¿ç•™ä½ åŸæœ‰çš„å…¨ç§‘å¯¹æ¯”é€»è¾‘ï¼Œæ­¤å¤„çœç•¥é‡å¤ä»£ç ä»¥èŠ‚çœç¯‡å¹…ï¼Œé€»è¾‘ä¸ä¹‹å‰ä¸€è‡´) ...
        // ç®€å•èµ·è§ï¼Œå»ºè®®å…¨ç§‘å¯¹æ¯”æ—¶ä¸æ”¯æŒç­çº§å¯¹æ¯”ï¼Œå› ä¸ºçº¿æ¡å¤ªå¤šä¼šä¹±
        
        // 1. ç¡®å®šå…¨å±€æœ€å¤§åˆ†
        let globalMax = 0;
        G_DynamicSubjectList.forEach(sub => {
            const subScores = students.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            if(subScores.length > 0) globalMax = Math.max(globalMax, Math.max(...subScores));
        });
        
        const endBin = Math.ceil((globalMax + 1) / binSize) * binSize;
        for (let i = 0; i < endBin; i += binSize) {
            categories.push(`[${i},${i + binSize})`);
        }

        G_DynamicSubjectList.forEach((sub, idx) => {
            const subScores = students.map(s => s.scores[sub]).filter(v => typeof v === 'number');
            const data = new Array(categories.length).fill(0);
            subScores.forEach(score => {
                let binIndex = Math.floor(score / binSize);
                if (binIndex >= data.length) binIndex = data.length - 1;
                data[binIndex]++;
            });
            
            series.push({
                name: sub, type: 'line', smooth: 0.4, symbol: 'none', data: data,
                itemStyle: { color: colors[idx % colors.length] }, lineStyle: { width: 2.5 }
            });
        });
        analysisText = "å…¨ç§‘å¯¹æ¯”å±•ç¤ºäº†å„å­¦ç§‘çš„åˆ†å¸ƒå½¢æ€å·®å¼‚ã€‚";
    } 
    
    // ============================================================
    // æ¨¡å¼ B: ç­çº§å¯¹æ¯” (æ–°å¢æ ¸å¿ƒé€»è¾‘)
    // ============================================================
    else if (isClassCompare) {
        // 1. è·å–æ‰€æœ‰ç­çº§åˆ—è¡¨
        const classSet = new Set(students.map(s => s.class));
        const classes = Array.from(classSet).sort();

        // 2. ç¡®å®šè¯¥ç§‘ç›®åœ¨å…¨æ ¡èŒƒå›´å†…çš„æœ€å¤§åˆ† (ç»Ÿä¸€ X è½´)
        const allScores = students.map(s => subject === 'totalScore' ? s.totalScore : s.scores[subject])
                                  .filter(v => typeof v === 'number' && !isNaN(v));
        
        if (allScores.length === 0) {
            chartDom.innerHTML = `<p style="text-align:center; padding-top:50px; color:#999;">æ— æœ‰æ•ˆåˆ†æ•°æ•°æ®</p>`;
            return;
        }

        const maxScore = Math.max(...allScores);
        const endBin = Math.ceil((maxScore + 1) / binSize) * binSize;

        // ç”Ÿæˆ X è½´æ ‡ç­¾
        for (let i = 0; i < endBin; i += binSize) {
            categories.push(`[${i},${i + binSize})`);
        }

        // 3. éå†æ¯ä¸ªç­çº§ç”Ÿæˆ Series
        classes.forEach((className, idx) => {
            const classStudents = students.filter(s => s.class === className);
            const scores = classStudents.map(s => subject === 'totalScore' ? s.totalScore : s.scores[subject])
                                        .filter(v => typeof v === 'number' && !isNaN(v));
            
            const data = new Array(categories.length).fill(0);
            
            scores.forEach(score => {
                let binIndex = Math.floor(score / binSize);
                if (binIndex >= data.length) binIndex = data.length - 1;
                data[binIndex]++;
            });

            series.push({
                name: className,
                type: 'line',
                smooth: 0.4,
                symbol: 'circle', // æ˜¾ç¤ºç‚¹ï¼Œæ–¹ä¾¿çœ‹å…·ä½“æ•°æ®
                symbolSize: 6,
                data: data,
                itemStyle: { color: colors[idx % colors.length] },
                lineStyle: { width: 2 },
                // åŒºåŸŸå¡«å……è®¾ä¸ºé€æ˜æˆ–å¾ˆæ·¡ï¼Œé˜²æ­¢é‡å çœ‹ä¸æ¸…
                areaStyle: { opacity: 0.05, color: colors[idx % colors.length] }
            });
        });

        analysisText = `å½“å‰å±•ç¤º <strong>${subject}</strong> ç§‘ç›®åœ¨ <strong>${classes.length}</strong> ä¸ªç­çº§é—´çš„åˆ†å¸ƒå¯¹æ¯”ã€‚æ‚¨å¯ä»¥ç‚¹å‡»ä¸Šæ–¹å›¾ä¾‹éšè—/æ˜¾ç¤ºç‰¹å®šç­çº§ã€‚æ›²çº¿è¶Šå‘å³åç§»ï¼Œè¯´æ˜è¯¥ç­çº§é«˜åˆ†æ®µäººæ•°è¶Šå¤šã€‚`;
    }

    // ============================================================
    // æ¨¡å¼ C: å•ä¸€ç¾¤ä½“åˆ†å¸ƒ (åŸé€»è¾‘)
    // ============================================================
    else {
        const scores = students.map(s => subject === 'totalScore' ? s.totalScore : s.scores[subject])
                               .filter(val => typeof val === 'number' && !isNaN(val));

        if (scores.length === 0) {
            chartDom.innerHTML = `<p style="text-align:center; padding-top:50px; color:#999;">æ— æœ‰æ•ˆåˆ†æ•°æ•°æ®</p>`;
            return;
        }

        const min = Math.min(...scores);
        const max = Math.max(...scores);
        const startBin = Math.floor(min / binSize) * binSize;
        const endBin = Math.ceil((max + 1) / binSize) * binSize;
        
        const binMap = {};
        for (let i = startBin; i < endBin; i += binSize) {
            const label = `[${i},${i + binSize})`;
            categories.push(label);
            binMap[label] = 0;
        }

        scores.forEach(score => {
            let binStart = Math.floor(score / binSize) * binSize;
            if (binStart < startBin) binStart = startBin; 
            if (binStart >= endBin) binStart = endBin - binSize;
            const label = `[${binStart},${binStart + binSize})`;
            if (binMap[label] !== undefined) binMap[label]++;
        });

        const data = categories.map(cat => binMap[cat]);
        
        // ç”Ÿæˆç®€æ˜“åˆ†ææ–‡æ¡ˆ
        let maxCount = Math.max(...data);
        let peakIndex = data.indexOf(maxCount);
        analysisText = `æœ¬æ¬¡ç»Ÿè®¡æˆç»©åˆ†å¸ƒå³°å€¼å‡ºç°åœ¨ <strong>${categories[peakIndex]}</strong>ï¼Œæœ‰ <strong>${maxCount}</strong> äººã€‚`;

        series.push({
            name: 'äººæ•°',
            type: 'line',
            smooth: 0.4,
            symbol: 'circle',
            symbolSize: 8,
            showSymbol: true,
            itemStyle: { color: '#20c997', borderColor: '#fff', borderWidth: 2 },
            lineStyle: { width: 3, color: '#20c997' },
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: 'rgba(32, 201, 151, 0.3)' },
                    { offset: 1, color: 'rgba(32, 201, 151, 0.05)' }
                ])
            },
            data: data,
            label: { show: true, position: 'top', color: '#20c997', fontSize: 12, fontWeight: 'bold' },
            markPoint: { data: [{ type: 'max', name: 'æœ€å¤§å€¼' }], itemStyle: { color: '#ffc107' } }
        });
    }

    // æ›´æ–°åˆ†ææ–‡æ¡ˆ
    if (analysisDiv) analysisDiv.innerHTML = analysisText;

    // ECharts é…ç½®
    const option = {
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            borderColor: '#ccc',
            textStyle: { color: '#333' },
            formatter: (params) => {
                let html = `<strong>${params[0].name}</strong><br/>`;
                // æŒ‰äººæ•°ä»å¤šåˆ°å°‘æ’åºæ˜¾ç¤º Tooltip
                const sortedParams = [...params].sort((a, b) => b.value - a.value);
                sortedParams.forEach(p => {
                    const marker = p.marker || `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${p.color};"></span>`;
                    if (p.value > 0) {
                        html += `${marker} ${p.seriesName}: <strong>${p.value}</strong>äºº<br/>`;
                    }
                });
                return html;
            }
        },
        legend: {
            show: isClassCompare || isAllSubjects, // å¯¹æ¯”æ¨¡å¼ä¸‹æ˜¾ç¤ºå›¾ä¾‹
            top: 0,
            type: 'scroll',
            width: '80%'
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '10%',
            top: (isClassCompare || isAllSubjects) ? '15%' : '10%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: categories,
            axisLabel: {
                interval: 'auto',
                rotate: categories.length > 10 ? 30 : 0,
                color: '#666'
            },
            axisLine: { lineStyle: { color: '#ccc' } },
            axisTick: { show: false }
        },
        yAxis: {
            type: 'value',
            name: 'äººæ•°',
            splitLine: { lineStyle: { type: 'dashed', color: '#eee' } },
            axisLine: { show: false },
            axisTick: { show: false }
        },
        series: series
    };

    myChart.setOption(option, true); // true è¡¨ç¤ºä¸åˆå¹¶æ—§é…ç½®ï¼Œå½»åº•é‡ç»˜
}

/**
 *    13.21 ç»˜åˆ¶åˆ†å±‚å­¦ç”Ÿåå•è¡¨æ ¼ (è‡ªåŠ¨è®¡ç®—ç¼ºå¤±çš„æ’å)
 */
function drawLayerStudentTable() {
    const tbody = document.getElementById('item-layer-tbody');
    const select = document.getElementById('item-layer-list-select');
    if (!tbody || !select) return;

    // 1. è·å–ç¯å¢ƒå‚æ•°
    const subjectName = document.getElementById('item-subject-select').value;
    const selectedClass = document.getElementById('item-class-filter').value;
    const numGroups = parseInt(document.getElementById('item-layer-groups').value);

    if (!G_ItemAnalysisData || !G_ItemAnalysisData[subjectName]) return;
    
    // è·å–è¯¥ç§‘ç›®ä¸‹çš„æ‰€æœ‰å­¦ç”Ÿ
    const allStudents = G_ItemAnalysisData[subjectName].students;

    // ============================================================
    //    è‡ªåŠ¨è¡¥å…¨æ’å (å¦‚æœæ•°æ®ä¸­ç¼ºå¤±)
    // ============================================================
    // æ£€æŸ¥ç¬¬ä¸€ä¸ªæœ‰æ•ˆå­¦ç”Ÿæ˜¯å¦æœ‰æ’åæ•°æ®
    const sample = allStudents.find(s => typeof s.totalScore === 'number');
    
    if (sample && (sample.rank === undefined || sample.gradeRank === undefined || sample.rank === null)) {
        // A. è®¡ç®—å¹´çº§æ’å (æŒ‰åˆ†æ•°é™åº)
        // æ³¨æ„ï¼šè¿™é‡Œæ˜¯åŸºäºâ€œå½“å‰ç§‘ç›®â€çš„åˆ†æ•°è¿›è¡Œæ’åï¼Œè¿™æ˜¯æœ€ç¬¦åˆå°é¢˜åˆ†æåœºæ™¯çš„
        const sortedByGrade = [...allStudents].filter(s => typeof s.totalScore === 'number')
            .sort((a, b) => b.totalScore - a.totalScore);
            
        sortedByGrade.forEach((s, index) => {
            s.gradeRank = index + 1;
        });

        // B. è®¡ç®—ç­çº§æ’å (æŒ‰ç­çº§åˆ†ç»„åæ’åº)
        const classMap = {};
        allStudents.forEach(s => {
            if (typeof s.totalScore === 'number') {
                if (!classMap[s.class]) classMap[s.class] = [];
                classMap[s.class].push(s);
            }
        });

        Object.keys(classMap).forEach(className => {
            const classGroup = classMap[className];
            classGroup.sort((a, b) => b.totalScore - a.totalScore);
            classGroup.forEach((s, index) => {
                s.rank = index + 1;
            });
        });
    }
    // ============================================================

    // 2. ç­›é€‰ (åŸºäºç­çº§)
    const filteredStudents = (selectedClass === 'ALL') 
        ? allStudents 
        : allStudents.filter(s => s.class === selectedClass);

    // 3. æ’åº (ç”¨äºåˆ†å±‚é€»è¾‘)
    const validStudents = filteredStudents
        .filter(s => typeof s.totalScore === 'number' && !isNaN(s.totalScore))
        .sort((a, b) => b.totalScore - a.totalScore); // é«˜åˆ†åœ¨å‰

    if (validStudents.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:#999;">æ— æœ‰æ•ˆæ•°æ®</td></tr>`;
        return;
    }

    // 4. åˆ†å±‚é€»è¾‘ (è®¡ç®—åˆ†å±‚åŒºé—´)
    const groupSize = Math.ceil(validStudents.length / numGroups);
    const groups = [];
    for (let i = 0; i < numGroups; i++) {
        const group = validStudents.slice(i * groupSize, (i + 1) * groupSize);
        if (group.length > 0) {
            const maxScore = group[0].totalScore;
            const minScore = group[group.length - 1].totalScore;
            groups.push({
                id: `G${i + 1}`,
                name: `G${i + 1} (ç¬¬${i * groupSize + 1}-${Math.min((i + 1) * groupSize, validStudents.length)}å)`,
                range: `${minScore} - ${maxScore}åˆ†`,
                students: group
            });
        }
    }

    // 5. å¡«å……ä¸‹æ‹‰æ¡†
    const currentVal = select.value;
    let htmlOpts = '';
    groups.forEach(g => {
        htmlOpts += `<option value="${g.id}">${g.name} [${g.range}]</option>`;
    });
    
    if (select.innerHTML !== htmlOpts) {
        select.innerHTML = htmlOpts;
        if (currentVal && groups.some(g => g.id === currentVal)) {
            select.value = currentVal;
        } else {
            select.value = 'G1';
        }
    }

    // 6. è·å–å½“å‰é€‰ä¸­å±‚çº§çš„å­¦ç”Ÿå¹¶æ¸²æŸ“
    const selectedGroupId = select.value;
    const targetGroup = groups.find(g => g.id === selectedGroupId);

    if (!targetGroup) {
        tbody.innerHTML = '';
        return;
    }

    tbody.innerHTML = targetGroup.students.map(s => {
        return `
            <tr>
                <td><span style="font-weight:bold; color:#17a2b8;">${targetGroup.id}</span></td>
                <td style="font-weight:bold;">${s.name}</td>
                <td>${s.class}</td>
                <td style="font-weight:bold; color:#007bff;">${s.totalScore}</td>
                <td style="color:#666;">-</td> 
                <td>${s.rank || '-'}</td>
                <td>${s.gradeRank || '-'}</td>
            </tr>
        `;
    }).join('');
}

/**
 * 16.5 [ç»ˆæä¿®å¤ç‰ˆ] å¤„ç†èº«é«˜/æ€§åˆ« Excel ä¸Šä¼ 
 */
function handlePhysicalDataUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // ä½¿ç”¨ FileReader ç›´æ¥è¯»å–ï¼Œç»•è¿‡ loadExcelData çš„ä¸¥æ ¼é™åˆ¶
    const reader = new FileReader();
    
    reader.onload = (event) => {
        try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // ç›´æ¥è½¬ä¸ºæœ€åŸå§‹çš„ JSON æ•°æ®
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            if (jsonData.length === 0) {
                alert("æ–‡ä»¶ä¼¼ä¹æ˜¯ç©ºçš„ï¼Œè¯·æ£€æŸ¥ Excel å†…å®¹ã€‚");
                return;
            }

            // --- æ ¸å¿ƒä¿®å¤ï¼šæ¨¡ç³ŠåŒ¹é…è¾…åŠ©å‡½æ•° ---
            // å³ä½¿è¡¨å¤´æ˜¯ " èº«é«˜ " (å¸¦ç©ºæ ¼)ï¼Œä¹Ÿèƒ½é€šè¿‡ ['èº«é«˜', 'height'] æ‰¾åˆ°
            const findValue = (row, keywords) => {
                // 1. è·å–è¯¥è¡Œæ‰€æœ‰çš„ Key (è¡¨å¤´)
                const keys = Object.keys(row);
                // 2. éå† Keyï¼Œå»æ‰ç©ºæ ¼åå¯¹æ¯”
                for (const key of keys) {
                    const cleanKey = key.trim().replace(/\s+/g, ''); // å»é™¤æ‰€æœ‰ç©ºæ ¼
                    if (keywords.some(kw => cleanKey.includes(kw))) {
                        return row[key];
                    }
                }
                return undefined;
            };

            let count = 0;
            G_PhysicalData = {}; // é‡ç½®å…¨å±€æ•°æ®

            jsonData.forEach(row => {
                // ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…æŸ¥æ‰¾åˆ—
                const name = findValue(row, ['å§“å', 'Name', 'name']);
                const gender = findValue(row, ['æ€§åˆ«', 'Gender', 'gender', 'sex']);
                const heightVal = findValue(row, ['èº«é«˜', 'Height', 'height']);

                if (name) {
                    // ç®€å•æ¸…æ´—æ•°æ®
                    const cleanHeight = parseFloat(heightVal) || 0;
                    const cleanGender = gender ? String(gender).trim() : 'æœªçŸ¥';

                    // åŒæ—¶ä»¥â€œå§“åâ€ä¸ºç´¢å¼•ä¿å­˜
                    // (å› ä¸ºè¿™ä¸ª Excel æ²¡æœ‰å­¦å·ï¼Œæˆ‘ä»¬ç”¨å§“åæ¥åŒ¹é…ç³»ç»Ÿé‡Œçš„å­¦ç”Ÿ)
                    G_PhysicalData[name.trim()] = { 
                        height: cleanHeight, 
                        gender: cleanGender 
                    };
                    count++;
                }
            });
            
            if (count === 0) {
                alert("æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®ã€‚\nè¯·ç¡®ä¿è¡¨å¤´åŒ…å«ï¼šå§“åã€æ€§åˆ«ã€èº«é«˜ã€‚");
                document.getElementById('seat-upload-status').innerHTML = `âŒ è¯»å–å¤±è´¥`;
            } else {
                document.getElementById('seat-upload-status').innerHTML = `âœ… æˆåŠŸè¯»å– ${count} äººæ•°æ®`;
                document.getElementById('seat-upload-status').style.color = '#28a745';
                console.log("å¯¼å…¥é¢„è§ˆ:", G_PhysicalData); // æ–¹ä¾¿ä½ åœ¨æ§åˆ¶å°æŸ¥çœ‹æ˜¯å¦å¯¼å…¥æˆåŠŸ
            }
            
        } catch (err) {
            console.error(err);
            alert("è§£æå‡ºé”™: " + err.message);
        }
        
        // é‡ç½®æ§ä»¶ï¼Œå…è®¸é‡å¤ä¸Šä¼ 
        e.target.value = '';
    };
    
    reader.readAsArrayBuffer(file);
}



/**
 * 16.7 [è§†è§‰æ——èˆ°ç‰ˆ] æ¸²æŸ“åº§ä½å›¾
 * - æ–°å¢ï¼šé¡¶éƒ¨å›¾ä¾‹ (Legend)ï¼Œæ˜¾ç¤ºå°ç»„é¢œè‰²
 * - ä¼˜åŒ–ï¼šæ ¹æ®å­¦ç”Ÿæ‰€å±å°ç»„ï¼Œç»™åº§ä½å—(Desk Block)æ·»åŠ å½©è‰²è¾¹æ¡†
 * - ä¿æŒï¼šç”·ç”Ÿè“/å¥³ç”Ÿç²‰çš„åº§ä½åº•è‰²
 */
function renderSeatingVisuals(seatMap) {
    const container = document.getElementById('seat-map-container');
    document.getElementById('seat-result-area').style.display = 'block';
    
    // 1. æå–æ‰€æœ‰å‡ºç°çš„å°ç»„ï¼Œå¹¶åˆ†é…é¢œè‰²
    const groupsSet = new Set();
    seatMap.forEach(row => {
        row.forEach(block => {
            if (block.students) {
                block.students.forEach(s => {
                    if (s && s._group && s._group !== 'æœªåˆ†ç»„') groupsSet.add(s._group);
                });
            }
        });
    });
    // æ’åºï¼šç¬¬1ç»„, ç¬¬2ç»„...
    const groupsList = Array.from(groupsSet).sort((a, b) => a.localeCompare(b, 'zh-CN', {numeric: true}));

    // å®šä¹‰ä¸€ç»„é²œæ˜çš„é¢œè‰² (ç”¨äºè¾¹æ¡†å’Œå›¾ä¾‹)
    const palette = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', 
        '#F7DC6F', '#BB8FCE', '#82E0AA', '#F1948A', '#85C1E9'
    ];
    const groupColorMap = {};
    groupsList.forEach((g, i) => {
        groupColorMap[g] = palette[i % palette.length];
    });

    // 2. ç”Ÿæˆå›¾ä¾‹ HTML
    let legendHtml = '';
    if (groupsList.length > 0) {
        legendHtml = `<div class="legend-bar">`;
        groupsList.forEach(g => {
            const color = groupColorMap[g];
            legendHtml += `
                <div class="legend-item">
                    <span class="legend-dot" style="background:${color}"></span>
                    <span>${g}</span>
                </div>
            `;
        });
        legendHtml += `</div>`;
    }

    // 3. ç”Ÿæˆåº§ä½è¡¨ HTML
    let html = legendHtml;
    html += `<div class="blackboard">ğŸ“º è®²å° / é»‘æ¿</div>`;
    html += `<div class="classroom-grid">`;
    
    seatMap.forEach((row, rIdx) => {
        html += `<div class="seat-row">`;
        row.forEach((block, bIdx) => {
            // ç¡®å®šè¯¥ Block çš„é¢œè‰² (å–ç¬¬ä¸€ä¸ªæœ‰ç»„çš„å­¦ç”Ÿ)
            let borderColor = '#ddd'; // é»˜è®¤ç°
            let blockGroup = '';
            
            // æŸ¥æ‰¾è¯¥æ¡Œæ˜¯å¦æœ‰å·²åˆ†ç»„å­¦ç”Ÿ
            const firstGroupedStudent = block.students.find(s => s && s._group && groupColorMap[s._group]);
            if (firstGroupedStudent) {
                blockGroup = firstGroupedStudent._group;
                borderColor = groupColorMap[blockGroup];
            }

            // æ¸²æŸ“ Block (åŠ ç²—è¾¹æ¡†æ˜¾ç¤ºå°ç»„è‰²)
            const borderStyle = blockGroup ? `border: 2px solid ${borderColor}; background: ${borderColor}11;` : '';
            
            html += `<div class="desk-block" style="${borderStyle}">`;
            
            // æ¸²æŸ“åº§ä½
            block.students.forEach(s => {
                if (!s) { // ç©ºåº§
                     html += `<div class="seat empty">ç©º</div>`;
                } else {
                    const genderClass = s._gender === 'å¥³' ? 'girl' : (s._gender === 'ç”·' ? 'boy' : 'unknown');
                    html += `
                        <div class="seat ${genderClass}">
                            <div class="seat-name" title="${s.name} (${s._gender}, ${s._height}cm)">${s.name}</div>
                        </div>
                    `;
                }
            });
            
            // è¡¥é½ç©ºä½
            for(let i=0; i < block.size - block.students.length; i++) {
                 html += `<div class="seat empty">ç©º</div>`;
            }
            html += `</div>`; // end desk-block
            
            // è¿‡é“
            if (bIdx < row.length - 1) html += `<div class="aisle"></div>`;
        });
        html += `</div>`; // end seat-row
    });
    html += `</div>`;
    
    const style = `
        <style>
            .legend-bar { 
                display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; 
                margin-bottom: 20px; padding: 10px; background: #fff; border-radius: 8px; border: 1px solid #eee; 
            }
            .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.9em; color: #555; }
            .legend-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

            .blackboard { background: #333; color: #fff; padding: 10px; margin-bottom: 30px; border-radius: 4px; width: 200px; margin-left: auto; margin-right: auto; }
            .seat-row { display: flex; justify-content: center; margin-bottom: 15px; }
            
            .desk-block { 
                display: flex; gap: 4px; 
                padding: 4px; 
                border: 1px solid #ddd; /* é»˜è®¤è¾¹æ¡† */
                border-radius: 6px; 
                background: #f9f9f9;
                min-width: 70px;
                transition: all 0.3s;
            }
            .aisle { width: 30px; } 
            
            .seat { 
                width: 65px; height: 55px; 
                display: flex; flex-direction: column; justify-content: center; align-items: center;
                border-radius: 4px; font-size: 0.85em;
                border: 1px solid rgba(0,0,0,0.05);
                position: relative;
            }
            .seat.boy { background-color: #bbdefb; color: #0d47a1; } /* è“ */
            .seat.girl { background-color: #f8bbd0; color: #880e4f; } /* ç²‰ */
            .seat.unknown { background-color: #fff; color: #666; border: 1px dashed #ccc; }
            .seat.empty { background-color: #f0f0f0; color: #ccc; border: 1px dashed #ddd; }
            
            .seat-name { font-weight: bold; max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        </style>
    `;
    
    container.innerHTML = style + html;
}

/**
 * 16.8 å¯¼å‡ºåº§ä½è¡¨ Excel
 */
function exportSeatingChart() {
    if (!G_CurrentSeatMap) return;
    
    const wb = XLSX.utils.book_new();
    const data = [];
    
    // è®²å°è¡Œ
    data.push(["è®²å°", "", "", "", ""]);
    data.push([]); // ç©ºè¡Œ
    
    G_CurrentSeatMap.forEach((row, rIdx) => {
        const rowArr = [];
        row.forEach((block, bIdx) => {
             block.students.forEach(s => {
                 rowArr.push(`${s.name}\n(${s._height.toFixed(0)}cm)`);
             });
             // è¡¥ç©ºä½
             for(let i=0; i < block.size - block.students.length; i++) rowArr.push("ç©º");
             
             // æ¨¡æ‹Ÿè¿‡é“ (æ’å…¥ç©ºåˆ—)
             if (bIdx < row.length - 1) rowArr.push(""); 
        });
        data.push(rowArr);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // è®¾ç½®åˆ—å®½
    const wscols = [];
    for(let i=0; i<20; i++) wscols.push({wch: 12});
    ws['!cols'] = wscols;

    XLSX.utils.book_append_sheet(wb, ws, "åº§ä½è¡¨");
    XLSX.writeFile(wb, "ç­çº§åº§ä½è¡¨.xlsx");
}



// ==========================================
//  æ¨¡å—åå…­ï¼šå¢å¼ºåŠŸèƒ½ (å­˜æ¡£ & æ•°æ®ç®¡ç†)
// ==========================================

// --- 1. å­¦ä¹ åˆ†ç»„å­˜æ¡£ç®¡ç†å™¨ ---
async function initGroupArchiveManager() {
    const listContainer = document.getElementById('group-archive-list');
    const saveBtn = document.getElementById('btn-save-group-archive');
    if (!listContainer) return;

    // æ¸²æŸ“åˆ—è¡¨
    const renderList = async () => {
        const archives = await localforage.getItem('G_Group_Archives') || [];
        if (archives.length === 0) {
            listContainer.innerHTML = `<div style="text-align:center; color:#999; padding:10px; font-size:0.9em;">æš‚æ— å­˜æ¡£ï¼Œç”Ÿæˆåˆ†ç»„åå¯ç‚¹å‡»å³ä¸Šè§’ä¿å­˜ã€‚</div>`;
            return;
        }
        listContainer.innerHTML = archives.map((item, idx) => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #f0f0f0;">
                <div onclick="window.loadGroupArchive(${item.id})" style="cursor:pointer; flex:1;">
                    <strong style="color:#6f42c1;">${item.name}</strong>
                    <span style="font-size:0.8em; color:#999; margin-left:10px;">${item.date} (${item.className})</span>
                </div>
                <button onclick="window.deleteGroupArchive(${item.id})" style="border:none; background:none; color:#dc3545; cursor:pointer;">&times;</button>
            </div>
        `).join('');
    };

    // ç»‘å®šä¿å­˜
    saveBtn.onclick = async () => {
        if (!window.currentGroupsCache || window.currentGroupsCache.length === 0) {
            alert("å½“å‰æ²¡æœ‰ç”Ÿæˆçš„åˆ†ç»„æ•°æ®ï¼"); return;
        }
        const name = prompt("ä¸ºè¯¥åˆ†ç»„æ–¹æ¡ˆå‘½å:", "åˆ†ç»„-" + new Date().toLocaleDateString());
        if (!name) return;

        const className = document.getElementById('group-class-select').value;
        const record = {
            id: Date.now(),
            name: name,
            date: new Date().toLocaleString(),
            className: className,
            groups: window.currentGroupsCache
        };

        const archives = await localforage.getItem('G_Group_Archives') || [];
        archives.unshift(record);
        await localforage.setItem('G_Group_Archives', archives);
        alert("âœ… å­˜æ¡£æˆåŠŸï¼");
        renderList();
    };

    // å…¨å±€åŠ è½½å‡½æ•°
    window.loadGroupArchive = async (id) => {
        const archives = await localforage.getItem('G_Group_Archives');
        const record = archives.find(r => r.id === id);
        if (record) {
            if(!confirm(`ç¡®å®šåŠ è½½å­˜æ¡£ã€${record.name}ã€‘å—ï¼Ÿ\nè¿™å°†è¦†ç›–å½“å‰å±å¹•ä¸Šçš„æ˜¾ç¤ºã€‚`)) return;
            window.currentGroupsCache = record.groups;
            renderGroupVisuals(record.groups, record.className, 'archive'); // æ¸²æŸ“
            alert(`å·²åŠ è½½ ${record.name}`);
        }
    };

    // å…¨å±€åˆ é™¤å‡½æ•°
    window.deleteGroupArchive = async (id) => {
        if(!confirm("ç¡®å®šåˆ é™¤æ­¤å­˜æ¡£ï¼Ÿ")) return;
        let archives = await localforage.getItem('G_Group_Archives');
        archives = archives.filter(r => r.id !== id);
        await localforage.setItem('G_Group_Archives', archives);
        renderList();
    };

    renderList();
}


// --- 2. [ä¿®å¤ç‰ˆ] èº«é«˜æ•°æ®ç®¡ç†å™¨ (é˜²å´©æºƒ) ---
function initPhysicalDataManager() {
    const classSelect = document.getElementById('seat-class-select');
    const uploadInput = document.getElementById('seat-physical-upload');
    const saveBtn = document.getElementById('btn-save-physical');
    const clearBtn = document.getElementById('btn-clear-physical');
    const statusLabel = document.getElementById('seat-db-status'); // æ³¨æ„ï¼šAIç‰ˆæŠŠçŠ¶æ€æ”¾åœ¨äº†æ ‡é¢˜æ 

    // å¦‚æœæ ¸å¿ƒå…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥é€€å‡ºï¼Œé˜²æ­¢æŠ¥é”™
    if (!classSelect || !uploadInput) return;

    // åŠ è½½å½“å‰ç­çº§çš„æ•°æ®çŠ¶æ€
    const checkStatus = async () => {
        const cls = classSelect.value;
        const allData = await localforage.getItem('G_Physical_DB') || {};
        
        if (allData[cls]) {
            const count = Object.keys(allData[cls]).length;
            if (statusLabel) {
                statusLabel.innerHTML = `âœ… <strong>${cls}</strong> å·²å­˜æ¡£ (${count}äºº)`;
                statusLabel.style.color = "#28a745";
            }
            // [å®‰å…¨æ£€æŸ¥] æŒ‰é’®å­˜åœ¨æ‰æ“ä½œ
            if (clearBtn) clearBtn.style.display = 'inline-block';
            if (saveBtn) saveBtn.style.display = 'none'; 
            
            G_PhysicalData = allData[cls];
        } else {
            if (statusLabel) {
                statusLabel.innerHTML = `âšª ${cls} æš‚æ— æ•°æ®`;
                statusLabel.style.color = "#999";
            }
            if (clearBtn) clearBtn.style.display = 'none';
            if (saveBtn) saveBtn.style.display = 'none';
            G_PhysicalData = {}; 
        }
    };

    // ç»‘å®šäº‹ä»¶
    classSelect.addEventListener('change', checkStatus);

    uploadInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                const findValue = (row, keywords) => {
                    for (const key of Object.keys(row)) {
                        if (keywords.some(kw => key.trim().includes(kw))) return row[key];
                    }
                    return undefined;
                };

                let tempPhysicalData = {};
                let count = 0;

                jsonData.forEach(row => {
                    const name = findValue(row, ['å§“å', 'Name']);
                    const gender = findValue(row, ['æ€§åˆ«', 'Gender']);
                    const heightVal = findValue(row, ['èº«é«˜', 'Height']);

                    if (name) {
                        tempPhysicalData[name.trim()] = { 
                            height: parseFloat(heightVal) || 0, 
                            gender: gender ? String(gender).trim() : 'æœªçŸ¥' 
                        };
                        count++;
                    }
                });

                if (count > 0) {
                    G_PhysicalData = tempPhysicalData;
                    if (statusLabel) {
                        statusLabel.innerHTML = `ğŸ“‚ å¾…ä¿å­˜: è¯»å–åˆ° ${count} äºº`;
                        statusLabel.style.color = "#fd7e14";
                    }
                    if (saveBtn) saveBtn.style.display = 'inline-block';
                } else {
                    alert("æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥è¡¨å¤´ã€‚");
                }
            } catch (err) {
                alert("è§£æå¤±è´¥: " + err.message);
            }
            e.target.value = '';
        };
        reader.readAsArrayBuffer(file);
    });

    // [å®‰å…¨ç»‘å®š] ä¿å­˜æŒ‰é’®
    if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
            const cls = classSelect.value;
            if (Object.keys(G_PhysicalData).length === 0) return;

            let allData = await localforage.getItem('G_Physical_DB') || {};
            allData[cls] = G_PhysicalData;
            await localforage.setItem('G_Physical_DB', allData);
            
            alert(`âœ… ${cls} çš„ç‰¹å¾æ•°æ®å·²ä¿å­˜ï¼`);
            checkStatus();
        });
    }

    // [å®‰å…¨ç»‘å®š] åˆ é™¤æŒ‰é’®
    if (clearBtn) {
        clearBtn.addEventListener('click', async () => {
            const cls = classSelect.value;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ã€${cls}ã€‘çš„èº«é«˜æ€§åˆ«å­˜æ¡£å—ï¼Ÿ`)) return;

            let allData = await localforage.getItem('G_Physical_DB') || {};
            delete allData[cls];
            await localforage.setItem('G_Physical_DB', allData);
            checkStatus();
        });
    }

    // åˆå§‹æ£€æŸ¥
    checkStatus();
}

/**
 * [è¡¥å…¨] ç»‘å®š Tab 1 (å­¦ä¹ äº’åŠ©åˆ†ç»„) çš„ç›¸å…³äº‹ä»¶
 */
function bindStudyGroupEvents() {
    const strategySelect = document.getElementById('group-strategy');
    const sortSelect = document.getElementById('group-sort-basis');
    const sizeWrapper = document.getElementById('group-size-wrapper');
    const singleWrapper = document.getElementById('group-single-wrapper');
    const compWrapper = document.getElementById('group-comp-wrapper');
    const descBox = document.getElementById('group-strategy-desc');

    // UI è”åŠ¨æ›´æ–°
    const updateUI = () => {
        const st = strategySelect.value;
        const so = sortSelect.value;

        const sizeInput = document.getElementById('group-size-input');
        if (st === 'high_low') {
            sizeInput.value = 2;
            sizeInput.disabled = true;
        } else {
            sizeInput.disabled = false;
        }

        sizeWrapper.style.display = 'none';
        singleWrapper.style.display = 'none';
        compWrapper.style.display = 'none';

        if (so === 'single') singleWrapper.style.display = 'block';
        else if (so === 'complementary') compWrapper.style.display = 'block';

        if (st !== 'high_low') sizeWrapper.style.display = 'block';

        let text = "ğŸ’¡ <strong>å½“å‰é€»è¾‘ï¼š</strong> ";
        if (so === 'total') text += "ä¾æ® <span style='color:#007bff'>æ€»åˆ†</span> ";
        else if (so === 'single') text += "ä¾æ® <span style='color:#007bff'>å•ç§‘æˆç»©</span> ";
        else text += "ä¾æ® <span style='color:#007bff'>åŒç§‘ T åˆ†å·®å€¼ (A-B)</span> ";

        if (st === 'balanced') text += "è¿›è¡Œ <span style='color:#007bff'>Så‹è›‡å½¢åˆ†ç»„</span>ã€‚<br>ä¿è¯ç»„é—´å®åŠ›å‡è¡¡ï¼Œé€‚åˆé•¿æœŸå°ç»„ã€‚";
        else if (st === 'high_low') text += "è¿›è¡Œ <span style='color:#007bff'>é¦–å°¾ç»“å¯¹ (1å¸®1)</span>ã€‚<br>æœ€å¼ºé…æœ€å¼±ï¼Œé€‚åˆä¸“é¡¹å¸®æ‰¶ã€‚";
        else text += "è¿›è¡Œ <span style='color:#007bff'>éšæœºåˆ†ç»„</span>ã€‚";

        if (so === 'complementary') {
            text += `<br>ğŸ”¥ <strong>Tåˆ†ä¼˜åŠ¿ï¼š</strong> å·²æ¶ˆé™¤å­¦ç§‘éš¾åº¦å·®å¼‚ã€‚é˜Ÿé¦–æ˜¯â€œAå¼ºBå¼±â€ï¼Œé˜Ÿå°¾æ˜¯â€œBå¼ºAå¼±â€ï¼Œ1å¸®1ç»“åˆåå½¢æˆå®Œç¾äº’è¡¥ï¼`;
        }
        descBox.innerHTML = text;
    };

    strategySelect.addEventListener('change', updateUI);
    sortSelect.addEventListener('change', updateUI);
    updateUI(); // åˆå§‹è¿è¡Œä¸€æ¬¡

    // ç”ŸæˆæŒ‰é’®äº‹ä»¶
    window.currentGroupsCache = []; // åˆå§‹åŒ–ç¼“å­˜
    
    document.getElementById('btn-generate-groups').addEventListener('click', () => {
        const className = document.getElementById('group-class-select').value;
        const strategy = strategySelect.value;
        const sortMode = sortSelect.value;
        const size = parseInt(document.getElementById('group-size-input').value) || 6;

        const params = {
            subject: document.getElementById('group-single-subject').value,
            subA: document.getElementById('group-sub-a').value,
            subB: document.getElementById('group-sub-b').value
        };

        // 1. ç­›é€‰ç­çº§
        let students = G_StudentsData.filter(s => s.class === className);
        if (students.length === 0) { alert("è¯¥ç­çº§æ— å­¦ç”Ÿæ•°æ®"); return; }

        // ç¡®ä¿ T åˆ†å·²è®¡ç®—
        if (!G_StudentsData[0].tScores) {
            console.log("æ£€æµ‹åˆ° T åˆ†ç¼ºå¤±ï¼Œæ­£åœ¨è®¡ç®—å…¨ä½“æ ‡å‡†åˆ†...");
            const globalStats = calculateAllStatistics(G_StudentsData);
            calculateStandardScores(G_StudentsData, globalStats);
        }

        // 2. è®¡ç®—æ’åºæƒé‡
        students.forEach(s => {
            if (sortMode === 'total') {
                s._sortScore = s.totalScore || 0;
                s._displayInfo = `æ€»åˆ†: ${s.totalScore}`;
            } else if (sortMode === 'single') {
                s._sortScore = s.scores[params.subject] || 0;
                s._displayInfo = `${params.subject}: ${s.scores[params.subject]}`;
            } else if (sortMode === 'complementary') {
                // T åˆ†å·®å€¼
                const tA = (s.tScores && s.tScores[params.subA]) ? s.tScores[params.subA] : 50;
                const tB = (s.tScores && s.tScores[params.subB]) ? s.tScores[params.subB] : 50;
                const diff = tA - tB;
                
                s._sortScore = diff;
                // æ˜¾ç¤ºåŸå§‹åˆ†ç»™è€å¸ˆçœ‹
                const rawA = s.scores[params.subA] || 0;
                const rawB = s.scores[params.subB] || 0;
                s._displayInfo = `${params.subA}:${rawA} / ${params.subB}:${rawB}`;
                s._compDiff = diff; 
            }
        });

        // 3. æ’åº (é™åº)
        students.sort((a, b) => b._sortScore - a._sortScore);

        // 4. æ‰§è¡Œåˆ†ç»„
        // (å‡è®¾ calculateGroups å‡½æ•°å·²å­˜åœ¨äº script.js ä¸­)
        window.currentGroupsCache = calculateGroups(students, strategy, size, sortMode);

        // 5. æ¸²æŸ“
        // (å‡è®¾ renderGroupVisuals å‡½æ•°å·²å­˜åœ¨äº script.js ä¸­)
        renderGroupVisuals(window.currentGroupsCache, className, sortMode);

        // 6. æ¿€æ´»ä¿å­˜æŒ‰é’®
        const saveBtn = document.getElementById('btn-save-group-archive');
        if(saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerText = "ğŸ’¾ ä¿å­˜å½“å‰åˆ†ç»„";
        }
    });

    // å¯¼å‡ºæŒ‰é’®äº‹ä»¶
    document.getElementById('btn-export-groups').addEventListener('click', () => {
        if (window.currentGroupsCache.length > 0) exportGroupsToExcel(window.currentGroupsCache);
    });
}


// ==========================================
//  æ¨¡å—åå…­ï¼šAI åº§ä½ç¼–æ’æ ¸å¿ƒå¼•æ“
// ==========================================

// å…¨å±€å˜é‡ï¼šç”¨äºä¸­æ–­ AI æ’åº§è¯·æ±‚
let seatAIController = null;

/**
 * 16.9 [å¯åœæ­¢ç‰ˆ] AI æ’åº§ä¸»å…¥å£
 * - æ–°å¢ï¼šAbortController æ”¯æŒéšæ—¶ä¸­æ–­
 * - ä¼˜åŒ–ï¼šåœæ­¢æ—¶ UI çŠ¶æ€å¤åŸ
 */
async function generateAISeatingChart() {
    const apiKey = localStorage.getItem('G_DeepSeekKey');
    if (!apiKey) { alert("è¯·å…ˆåœ¨ã€AI æ™ºèƒ½åˆ†æã€‘æ¨¡å—è®¾ç½® DeepSeek API Keyã€‚"); return; }

    const className = document.getElementById('seat-class-select').value;
    const configStr = document.getElementById('seat-columns-config').value;
    const userPrompt = document.getElementById('seat-ai-prompt').value;
    const model = document.getElementById('seat-ai-model').value;

    // 1. å‡†å¤‡æ•°æ®
    let students = G_StudentsData.filter(s => s.class === className);
    if (students.length === 0) { alert(`æœªæ‰¾åˆ° ${className} çš„å­¦ç”Ÿæ•°æ®ã€‚`); return; }

    // 2. æ•°æ®æ‰“åŒ…
    const groupMap = {};
    if (window.currentGroupsCache) {
        window.currentGroupsCache.forEach((g, idx) => {
            g.members.forEach(m => groupMap[m.id] = `ç¬¬${idx+1}ç»„`);
        });
    }

    const studentList = students.map(s => {
        let phys = G_PhysicalData[s.id] || G_PhysicalData[s.name] || {};
        return {
            name: s.name,
            gender: phys.gender || 'æœªçŸ¥',
            height: parseFloat(phys.height) || 'æœªçŸ¥',
            group: groupMap[s.id] || 'æœªåˆ†ç»„'
        };
    });
    
    const totalCount = studentList.length;

    // 3. æ„å»º Prompt
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæ’åº§ç®—æ³•ã€‚ä»»åŠ¡ï¼šå°†è¾“å…¥çš„ ${totalCount} åå­¦ç”Ÿå…¨éƒ¨åˆ†é…åˆ°åº§ä½ä¸­ã€‚
ã€çº¦æŸã€‘ï¼š
1. ä¸¥ç¦ Markdownï¼Œåªè¾“ JSONã€‚
2. å¿…é¡»åŒ…å« EXACTLY ${totalCount} studentsã€‚
3. JSONç»“æ„ï¼š[[{"size":N, "students":[...]}, ...], ...]
4. "students"å«ï¼šname, gender, height, groupã€‚
5. å¸ƒå±€ï¼š[${configStr}]ã€‚`;

    const fullPrompt = `åå•ï¼š${JSON.stringify(studentList)}\nè¦æ±‚ï¼š${userPrompt || "æŒ‰èº«é«˜ä»çŸ®åˆ°é«˜æ’ã€‚"}`;

    // 4. UI åˆå§‹åŒ– (æ˜¾ç¤ºåœæ­¢æŒ‰é’®)
    const loadingDiv = document.getElementById('seat-ai-loading');
    const resultArea = document.getElementById('seat-result-area');
    
    const startBtn = document.getElementById('btn-generate-ai-seats');
    const stopBtn = document.getElementById('btn-stop-ai-seat'); // [æ–°å¢]
    
    const statusText = document.getElementById('seat-ai-status-text');
    const logContainer = document.getElementById('seat-ai-log-container');
    const reasoningEl = document.getElementById('seat-ai-reasoning');
    const contentEl = document.getElementById('seat-ai-content');

    // [çŠ¶æ€åˆ‡æ¢]
    loadingDiv.style.display = 'block';
    resultArea.style.display = 'none';
    startBtn.style.display = 'none'; // éšè—å¼€å§‹
    stopBtn.style.display = 'inline-block'; // æ˜¾ç¤ºåœæ­¢
    
    // é‡ç½®æ—¥å¿—
    reasoningEl.innerHTML = '';
    contentEl.innerHTML = '';
    reasoningEl.style.display = 'none';
    statusText.innerText = model === 'deepseek-reasoner' ? "ğŸ§  æ·±åº¦æ€è€ƒä¸­..." : "ğŸš€ æ­£åœ¨è§„åˆ’å¸ƒå±€...";

    let fullContent = "";
    
    // [æ ¸å¿ƒ] åˆå§‹åŒ– AbortController
    if (seatAIController) seatAIController.abort(); // é˜²æ­¢é‡å¤ç‚¹å‡»
    seatAIController = new AbortController();

    // [ç»‘å®šåœæ­¢äº‹ä»¶]
    stopBtn.onclick = () => {
        if (seatAIController) {
            seatAIController.abort(); // ä¸­æ–­è¯·æ±‚
            seatAIController = null;
            
            // UI åé¦ˆ
            statusText.innerText = "ğŸ›‘ ç”¨æˆ·å·²æ‰‹åŠ¨åœæ­¢ç”Ÿæˆ";
            statusText.style.color = "#dc3545";
            contentEl.innerHTML += `<br><br><em style="color:#dc3545;">[è¿›ç¨‹å·²ç»ˆæ­¢]</em>`;
            
            // æ¢å¤æŒ‰é’®
            stopBtn.style.display = 'none';
            startBtn.style.display = 'inline-block';
        }
    };

    try {
        // 5. å‘èµ·è¯·æ±‚ (ä¼ å…¥ signal)
        const response = await fetch('https://api.deepseek.com/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: fullPrompt }
                ],
                temperature: 0.7,
                stream: true 
            }),
            signal: seatAIController.signal // [å…³é”®] ç»‘å®šä¿¡å·
        });

        if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');
            for (const line of lines) {
                if (line.trim().startsWith('data: ')) {
                    const jsonStr = line.replace('data: ', '').trim();
                    if (jsonStr === '[DONE]') break;
                    try {
                        const json = JSON.parse(jsonStr);
                        const delta = json.choices[0].delta;
                        // æ¸²æŸ“æ€è€ƒ
                        if (delta.reasoning_content) {
                            if (reasoningEl.style.display === 'none') {
                                reasoningEl.style.display = 'block';
                                reasoningEl.innerHTML = `<strong>[æ€ç»´é“¾]:</strong><br>`;
                            }
                            reasoningEl.innerText += delta.reasoning_content;
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                        // æ¸²æŸ“å†…å®¹
                        if (delta.content) {
                            if (delta.content && statusText.innerText.includes("æ€è€ƒ")) {
                                statusText.innerText = "ğŸ“ æ­£åœ¨ç»˜åˆ¶åº§ä½è¡¨...";
                                statusText.style.color = "#20c997";
                            }
                            fullContent += delta.content;
                            contentEl.innerText += delta.content;
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    } catch (e) {}
                }
            }
        }

        // 6. è§£æä¸æ ¡éªŒ
        statusText.innerText = "âœ… ç”Ÿæˆå®Œæˆï¼Œæ­£åœ¨æ¸²æŸ“...";
        
        let cleanJson = fullContent.replace(/```json/g, '').replace(/```/g, '').trim();
        const firstBracket = cleanJson.indexOf('[');
        const lastBracket = cleanJson.lastIndexOf(']');
        if (firstBracket !== -1 && lastBracket !== -1) {
            cleanJson = cleanJson.substring(firstBracket, lastBracket + 1);
        }

        const seatMap = JSON.parse(cleanJson);
        
        let placedCount = 0;
        seatMap.forEach(row => {
            row.forEach(block => {
                if (block.students) {
                    block.students = block.students.map(s => {
                        if(s) placedCount++;
                        return s ? { 
                            ...s, 
                            _gender: s.gender, 
                            _height: parseFloat(s.height)||0,
                            _group: s.group || "æœªåˆ†ç»„"
                        } : null;
                    });
                }
            });
        });

        G_CurrentSeatMap = seatMap;
        
        setTimeout(() => {
            loadingDiv.style.display = 'none';
            renderSeatingVisuals(seatMap);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            stopBtn.style.display = 'none';
            startBtn.style.display = 'inline-block';

            if (placedCount < totalCount) {
                alert(`âš ï¸ è­¦å‘Šï¼šAI åªæ’äº† ${placedCount}/${totalCount} äººã€‚\nå»ºè®®åˆ‡æ¢ R1 æ¨¡å‹é‡è¯•ã€‚`);
            }
        }, 800);

    } catch (err) {
        if (err.name === 'AbortError') {
            // ç”¨æˆ·æ‰‹åŠ¨åœæ­¢ï¼Œå‰é¢ stopBtn.onclick å·²ç»å¤„ç†äº† UIï¼Œè¿™é‡Œæ— éœ€å¼¹çª—
            console.log("ç”¨æˆ·ç»ˆæ­¢äº† AI ç”Ÿæˆ");
        } else {
            console.error(err);
            alert("AI æ’åº§å¤±è´¥ã€‚\n" + err.message);
            loadingDiv.style.display = 'none';
            stopBtn.style.display = 'none';
            startBtn.style.display = 'inline-block';
        }
    } finally {
        seatAIController = null;
    }
}


// ==========================================
//  æ¨¡å—åä¸‰ï¼šAI æ‰¹é‡ç”Ÿæˆä¸æ‰“å°ç³»ç»Ÿ
// ==========================================
/**
 * æ‰“å¼€æ‰¹é‡é…ç½®çª—å£
 */
function openBatchModal() {
    const modal = document.getElementById('ai-batch-modal');
    const classSelect = document.getElementById('ai-batch-class');
    const modeDisplay = document.getElementById('ai-batch-mode-display');
    const mainModeSelect = document.getElementById('ai-mode-select');

    // 1. å¡«å……ç­çº§
    const classes = [...new Set(G_StudentsData.map(s => s.class))].sort();
    classSelect.innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join('');

    // 2. åŒæ­¥å½“å‰æ¨¡å¼
    const modeText = mainModeSelect.options[mainModeSelect.selectedIndex].text;
    modeDisplay.innerText = modeText;

    // 3. é‡ç½® UI
    document.getElementById('ai-batch-config').style.display = 'block';
    document.getElementById('ai-batch-progress-area').style.display = 'none';
    
    modal.style.display = 'flex';
}

/**
 * [å…¨å±€ä¿®å¤ç‰ˆ] æ‰§è¡Œæ‰¹é‡åˆ†æ
 */
async function runBatchAnalysis() {
    const apiKey = localStorage.getItem('G_DeepSeekKey');
    if (!apiKey) { alert("è¯·å…ˆè®¾ç½® API Key"); return; }

    const targetClass = document.getElementById('ai-batch-class').value;
    const mode = document.getElementById('ai-mode-select').value;
    const model = document.getElementById('ai-model-select').value;
    const grade = document.getElementById('ai-grade-select').value;
    const qCount = document.getElementById('ai-q-count').value;
    
    let targetSubject = document.getElementById('ai-item-subject').value;
    if (mode !== 'item_diagnosis' && mode !== 'teaching_guide') targetSubject = "";

    const checkboxes = document.querySelectorAll('.ai-batch-cb:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);

    if (selectedIds.length === 0) { alert("è¯·è‡³å°‘å‹¾é€‰ä¸€åå­¦ç”Ÿï¼"); return; }

    const students = G_StudentsData.filter(s => selectedIds.includes(String(s.id)));

    if (!confirm(`å³å°†ç”Ÿæˆ ${students.length} ä»½æŠ¥å‘Šã€‚\nç¡®å®šå¼€å§‹å—ï¼Ÿ`)) return;

    // UI åˆ‡æ¢
    document.getElementById('ai-batch-config').style.display = 'none';
    document.getElementById('ai-batch-progress-area').style.display = 'block';
    const logEl = document.getElementById('ai-batch-log');
    const barEl = document.getElementById('ai-batch-bar');
    const countEl = document.getElementById('ai-batch-count');
    const statusEl = document.getElementById('ai-batch-status');
    
    const saveBtn = document.getElementById('ai-batch-save-btn');
    const printBtn = document.getElementById('ai-batch-print-btn');
    const stopBtn = document.getElementById('ai-batch-stop-btn');

    // [æ ¸å¿ƒ] é‡ç½®å…¨å±€å˜é‡
    window.G_BatchResults = [];
    window.stopBatchAI = false;

    logEl.innerHTML = '';
    saveBtn.disabled = true;
    printBtn.disabled = true;
    stopBtn.disabled = false;
    barEl.style.width = '0%';

    for (let i = 0; i < students.length; i++) {
        if (window.stopBatchAI) {
            logLog("ğŸ›‘ ç”¨æˆ·å·²åœæ­¢ä»»åŠ¡", "red");
            break;
        }

        const s = students[i];
        const progress = i + 1;
        countEl.innerText = `${progress}/${students.length}`;
        barEl.style.width = `${(progress / students.length) * 100}%`;
        statusEl.innerText = `æ­£åœ¨ç”Ÿæˆ: ${s.name}...`;

        try {
            const promptData = await generateAIPrompt(s.id, s.name, mode, qCount, grade, targetSubject, targetClass);
            const content = await fetchBatchAIResponse(apiKey, model, promptData);
            

            window.G_BatchResults.push({
                student: s,
                content: content,
                subject: targetSubject || "ç»¼åˆ",
                mode: mode,
                grade: grade 
            });

            logLog(`âœ… [${s.name}] ç”ŸæˆæˆåŠŸ`, "green");

        } catch (err) {
            console.error(err);
            logLog(`âŒ [${s.name}] å¤±è´¥: ${err.message}`, "red");
        }

        await new Promise(r => setTimeout(r, 2000));
    }

    statusEl.innerText = window.stopBatchAI ? "ä»»åŠ¡å·²ç»ˆæ­¢" : "ğŸ‰ æ‰¹é‡ä»»åŠ¡å®Œæˆï¼";
    stopBtn.disabled = true;
    
    // ä»»åŠ¡ç»“æŸï¼Œå¯ç”¨ä¿å­˜æŒ‰é’®
    if (window.G_BatchResults.length > 0) {
        printBtn.disabled = false;
        printBtn.innerText = `ğŸ–¨ï¸ æ‰¹é‡æ‰“å° (${window.G_BatchResults.length})`;
        
        saveBtn.disabled = false;
        saveBtn.innerText = `ğŸ’¾ æ‰¹é‡å­˜æ¡£ (${window.G_BatchResults.length})`;
    }
}
// è¾…åŠ©ï¼šæ‰¹é‡ä¸“ç”¨çš„ API è°ƒç”¨ (æ— æµå¼ï¼Œç›´æ¥è¿”å›æ–‡æœ¬)
async function fetchBatchAIResponse(apiKey, model, promptData) {
    const response = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify({
            model: model,
            messages: [
                { role: "system", content: promptData.system },
                { role: "user", content: promptData.user }
            ],
            temperature: 0.7,
            stream: false // æ‰¹é‡æ¨¡å¼ä¸‹ä¸ä½¿ç”¨æµå¼ï¼Œç›´æ¥æ‹¿ç»“æœæ›´ç¨³
        })
    });

    if (!response.ok) throw new Error("API Error");
    const data = await response.json();
    return data.choices[0].message.content;
}

// è¾…åŠ©ï¼šå†™æ—¥å¿—
function logLog(msg, color = "#333") {
    const logEl = document.getElementById('ai-batch-log');
    const div = document.createElement('div');
    div.style.color = color;
    div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
}

/**
 * æ‰¹é‡æ‰“å°é€»è¾‘
 */
function printBatchReports() {
    if (G_BatchResults.length === 0) return;
    
    const grade = document.getElementById('ai-grade-select').value;
    const modeEl = document.getElementById('ai-mode-select');
    const modeText = modeEl.options[modeEl.selectedIndex].text;

    let allHtml = "";

    G_BatchResults.forEach((item, index) => {
        // æ¸²æŸ“ Markdown
        const renderedContent = marked.parse(item.content);
        
        // åˆ†é¡µç¬¦ (ç¬¬ä¸€ä¸ªä¸éœ€è¦)
        const pageBreak = index > 0 ? 'page-break-before: always;' : '';

        allHtml += `
            <div class="report-page" style="${pageBreak} padding: 2cm; position: relative;">
                <div class="print-header" style="text-align:center; border-bottom:2px solid #333; margin-bottom:20px; padding-bottom:10px;">
                    <h1 style="margin:0; font-size:24px;">å­¦ä¸šåˆ†ææŠ¥å‘Š - ${item.student.name}</h1>
                    <p style="margin:5px 0 0; color:#666; font-size:14px;">
                        å¹´çº§ï¼š${grade} | ç§‘ç›®ï¼š${item.subject} | ç­çº§ï¼š${item.student.class}
                    </p>
                </div>
                
                <div class="report-body markdown-body" style="line-height:1.6; font-family:'Segoe UI', sans-serif;">
                    ${renderedContent}
                </div>
            </div>
        `;
    });

    // æ‰“å¼€æ‰“å°çª—å£
    const win = window.open('', '_blank');
    win.document.write(`
        <html>
        <head>
            <title>æ‰¹é‡åˆ†ææŠ¥å‘Š</title>
            <style>
                body { background: #eee; margin: 0; font-family: sans-serif; }
                .report-page { background: white; width: 210mm; min-height: 297mm; margin: 20px auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); box-sizing: border-box; }
                
                /* ç®€æ˜“ Markdown æ ·å¼å¤åˆ» */
                h1, h2, h3 { color: #333; }
                strong { color: #000; background: #f0f0f0; padding: 0 4px; }
                ul { padding-left: 20px; }
                table { border-collapse: collapse; width: 100%; margin: 10px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }

                @media print {
                    body { background: none; margin: 0; }
                    .report-page { width: auto; height: auto; margin: 0; box-shadow: none; border: none; }
                }
            </style>
        </head>
        <body>
            ${allHtml}
        </body>
        </html>
    `);
    win.document.close();
    
    // ç­‰å¾…å›¾ç‰‡ç­‰åŠ è½½ (è™½ç„¶è¿™é‡Œä¸»è¦æ˜¯æ–‡æœ¬)
    setTimeout(() => {
        win.focus();
        win.print();
    }, 1000);
}


/**
 * æ‰“å¼€æ‰¹é‡é…ç½®çª—å£
 */
function openBatchModal() {
    const modal = document.getElementById('ai-batch-modal');
    const classSelect = document.getElementById('ai-batch-class');
    const modeDisplay = document.getElementById('ai-batch-mode-display');
    const mainModeSelect = document.getElementById('ai-mode-select');

    // 1. å¡«å……ç­çº§
    const classes = [...new Set(G_StudentsData.map(s => s.class))].sort();
    classSelect.innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join('');

    // 2. åŒæ­¥å½“å‰æ¨¡å¼
    const modeText = mainModeSelect.options[mainModeSelect.selectedIndex].text;
    modeDisplay.innerText = modeText;

    // 3. [æ–°å¢] æ¸²æŸ“é»˜è®¤é€‰ä¸­ç­çº§çš„å­¦ç”Ÿåˆ—è¡¨
    if (classes.length > 0) {
        renderBatchStudentList(classes[0]);
    }

    // 4. é‡ç½® UI
    document.getElementById('ai-batch-config').style.display = 'block';
    document.getElementById('ai-batch-progress-area').style.display = 'none';
    modal.style.display = 'flex';
}

/**
 * [æ–°å¢] æ¸²æŸ“å­¦ç”Ÿå¤é€‰æ¡†åˆ—è¡¨
 */
function renderBatchStudentList(className) {
    const container = document.getElementById('ai-batch-student-list');
    const countLabel = document.getElementById('ai-batch-selected-count');
    container.innerHTML = '';

    const students = G_StudentsData.filter(s => s.class === className);
    
    students.forEach(s => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label style="cursor:pointer; font-size:0.9em; display:flex; align-items:center;">
                <input type="checkbox" value="${s.id}" checked class="ai-batch-cb" style="margin-right:5px;">
                ${s.name}
            </label>
        `;
        container.appendChild(div);
    });

    // ç»‘å®šç‚¹å‡»æ›´æ–°è®¡æ•°
    const checkboxes = container.querySelectorAll('.ai-batch-cb');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            const selected = container.querySelectorAll('.ai-batch-cb:checked').length;
            countLabel.innerText = `å·²é€‰: ${selected} äºº`;
        });
    });
    countLabel.innerText = `å·²é€‰: ${students.length} äºº`;
}

/**
 * [æ–°å¢] å…¨é€‰/åé€‰
 */
function toggleBatchSelection(checked) {
    const checkboxes = document.querySelectorAll('.ai-batch-cb');
    checkboxes.forEach(cb => cb.checked = checked);
    const countLabel = document.getElementById('ai-batch-selected-count');
    countLabel.innerText = `å·²é€‰: ${checked ? checkboxes.length : 0} äºº`;
}


/**
 * [æ–°å¢] æ‰¹é‡ä¿å­˜åˆ°å†å²è®°å½•
 */
function saveBatchToHistory() {
    // 1. æ£€æŸ¥æ˜¯å¦æœ‰ç»“æœ
    if (!G_BatchResults || G_BatchResults.length === 0) {
        alert("å½“å‰æ²¡æœ‰å¯ä¿å­˜çš„ç”Ÿæˆç»“æœï¼");
        return;
    }

    const btn = document.getElementById('ai-batch-save-btn');
    const originalText = btn.innerText;
    
    // 2. è§†è§‰åé¦ˆ
    btn.innerText = "â³ æ­£åœ¨å­˜æ¡£...";
    btn.disabled = true;

    // è·å–æ¨¡å¼æ–‡æœ¬
    const modeEl = document.getElementById('ai-mode-select');
    const modeText = modeEl.options[modeEl.selectedIndex].text;

    let savedCount = 0;

    // 3. å¾ªç¯ä¿å­˜
    G_BatchResults.forEach(item => {
        // è½¬æ¢ Markdown -> HTML
        // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ item.content (AIè¿”å›çš„åŸå§‹æ–‡æœ¬)
        const htmlContent = `<div class="ai-batch-saved markdown-body">${marked.parse(item.content)}</div>`;
        
        saveToAIHistory(
            `${item.student.name} - ${modeText}`,   // æ ‡é¢˜
            `${item.grade} | ${item.subject} (æ‰¹é‡)`, // å‰¯æ ‡é¢˜
            null,                                   // ID
            htmlContent                             // å†…å®¹
        );
        savedCount++;
    });

    // 4. å®Œæˆæç¤º
    setTimeout(() => {
        btn.innerText = `âœ… å·²å­˜ ${savedCount} æ¡`;
        // ä¿æŒ disabled çŠ¶æ€é˜²æ­¢é‡å¤ç‚¹å‡»åˆ·å±
        
        // åˆ·æ–°ä¾§è¾¹æ  (å¦‚æœä¾§è¾¹æ æ˜¯æ‰“å¼€çš„)
        if (typeof renderAIHistoryList === 'function') {
            renderAIHistoryList();
        }
        
        alert(`æˆåŠŸå°† ${savedCount} æ¡åˆ†ææŠ¥å‘Šä¿å­˜åˆ°â€œå†å²è®°å½•â€ï¼\n\næ‚¨å¯ä»¥åœ¨ä¾§è¾¹æ çš„â€œğŸ•’ å†å²â€ä¸­æŸ¥çœ‹ã€‚`);
    }, 500);
}

// [è¾…åŠ©] å°†æœç´¢æ¡†é€»è¾‘æå–å‡ºæ¥ï¼Œä¿æŒ initAIModule æ•´æ´
async function initStudentSearchLogic() {
    const searchInput = document.getElementById('ai-student-search');
    const resultsContainer = document.getElementById('ai-student-search-results');
    const analyzeBtn = document.getElementById('ai-analyze-btn');

    const multiData = await loadMultiExamData();
    const allStudentsMap = new Map();
    multiData.forEach(exam => exam.students.forEach(s => allStudentsMap.set(s.id, s.name)));
    G_StudentsData.forEach(s => allStudentsMap.set(s.id, s.name));
    const allStudentsList = Array.from(allStudentsMap, ([id, name]) => ({ id, name }));

    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        if (term.length < 1) { resultsContainer.style.display = 'none'; return; }
        const matches = allStudentsList.filter(s => s.name.toLowerCase().includes(term) || String(s.id).includes(term)).slice(0, 10);
        resultsContainer.innerHTML = matches.map(s => `<div class="result-item" data-id="${s.id}" data-name="${s.name}">${s.name} (${s.id})</div>`).join('');
        resultsContainer.style.display = 'block';
    });

    resultsContainer.addEventListener('click', (e) => {
        const item = e.target.closest('.result-item');
        if (item) {
            searchInput.value = `${item.dataset.name} (${item.dataset.id})`;
            searchInput.dataset.selectedId = item.dataset.id;
            searchInput.dataset.selectedName = item.dataset.name;
            resultsContainer.style.display = 'none';
            analyzeBtn.disabled = false;
        }
    });
}


// 1. å®šä¹‰å…¨å±€å˜é‡
window.G_BatchResults = []; 
window.stopBatchAI = false;

// ============================================================
//    ğŸ”¥ éœ¸é“ä¿®å¤è¡¥ä¸ï¼šå¼ºåˆ¶å±æ€§æ³¨å…¥ (Inline Attribute Force)
// ============================================================

(function() {
    console.log("ğŸ›¡ï¸ [ç³»ç»Ÿ] éœ¸é“ä¿®å¤æ¨¡å¼å·²å¯åŠ¨...");

    // 1. å®šä¹‰ä¸€ä¸ªç»å¯¹å…¨å±€çš„ä¿å­˜å‡½æ•° (æŒ‚è½½åˆ° window ä¸Š)
    // è¿™æ ·æ— è®ºä½œç”¨åŸŸæ€ä¹ˆå˜ï¼ŒHTML é‡Œçš„ onclick éƒ½èƒ½æ‰¾åˆ°å®ƒ
    window.forceBatchSave = function(btnElement) {
        console.log("ğŸ–±ï¸ [Click] ç»ˆäºæ•è·åˆ°ç‚¹å‡»äº†ï¼å¼€å§‹æ‰§è¡Œä¿å­˜...");

        // --- æ•°æ®æ£€æŸ¥ ---
        if (!window.G_BatchResults || window.G_BatchResults.length === 0) {
            alert("âŒ å†…å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼\nè¯·å…ˆç‚¹å‡»ã€æ‰¹é‡ç”Ÿæˆã€‘ï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆåå†å­˜æ¡£ã€‚");
            return;
        }

        // --- UI åé¦ˆ ---
        const originalText = btnElement.innerText;
        btnElement.innerText = "â³ å†™å…¥ä¸­...";
        btnElement.disabled = true;

        // --- æ ¸å¿ƒä¿å­˜é€»è¾‘ ---
        setTimeout(() => {
            try {
                const AI_HISTORY_KEY = 'G_AI_History_Archive';
                let history = [];
                try { history = JSON.parse(localStorage.getItem(AI_HISTORY_KEY) || "[]"); } catch(e) {}

                let savedCount = 0;
                // è·å–å½“å‰æ¨¡å¼åç§°
                let modeText = "AIåˆ†æ";
                try { modeText = document.getElementById('ai-mode-select').selectedOptions[0].text; } catch(e) {}

                // å¾ªç¯å¤„ç†æ¯ä¸€æ¡
                window.G_BatchResults.forEach((item) => {
                    // æ„å»º Markdown å†…å®¹
                    let htmlContent = "";
                    if (typeof marked !== 'undefined') {
                        // å…¼å®¹ä¸åŒç‰ˆæœ¬çš„ marked
                        const parseFn = (typeof marked.parse === 'function') ? marked.parse : marked;
                        htmlContent = `<div class="ai-batch-saved markdown-body">${parseFn(item.content)}</div>`;
                    } else {
                        htmlContent = `<div class="ai-batch-saved"><pre>${item.content}</pre></div>`;
                    }

                    // æ„å»ºè®°å½•
                    history.unshift({
                        id: Date.now() + Math.random(),
                        timestamp: new Date().toLocaleString(),
                        title: `${item.student.name} - ${modeText}`,
                        subTitle: `${item.grade} | ${item.subject} (æ‰¹é‡å­˜æ¡£)`,
                        mainContent: htmlContent,
                        chatContent: ""
                    });
                    savedCount++;
                });

                // å†™å…¥å­˜å‚¨
                localStorage.setItem(AI_HISTORY_KEY, JSON.stringify(history));

                // å°è¯•åˆ·æ–°ä¾§è¾¹æ  (å¦‚æœå‡½æ•°å­˜åœ¨)
                if (typeof renderAIHistoryList === 'function') renderAIHistoryList();

                alert(`ğŸ‰ å­˜æ¡£æˆåŠŸï¼\nå·²å°† ${savedCount} æ¡è®°å½•å†™å…¥å†å²åº“ã€‚\nè¯·ç‚¹å‡»ä¾§è¾¹æ ã€ğŸ•’ å†å²ã€‘æŸ¥çœ‹ã€‚`);

            } catch (err) {
                console.error("ä¿å­˜è¿‡ç¨‹å‡ºé”™:", err);
                alert("âŒ ä¿å­˜å‡ºé”™: " + err.message);
            } finally {
                // æ¢å¤æŒ‰é’®
                btnElement.innerText = originalText;
                btnElement.disabled = false;
            }
        }, 100); // ç¨å¾®å»¶æ—¶ï¼Œè®©UIå…ˆå˜ä¸€ä¸‹
    };

    // 2. å¯åŠ¨â€œç›‘å·¥â€å®šæ—¶å™¨
    // æ¯ 500æ¯«ç§’ å·¡é€»ä¸€æ¬¡ï¼Œç¡®ä¿æŒ‰é’®ä¸Šä¸€å®šæœ‰ onclick å±æ€§
    setInterval(() => {
        const btn = document.getElementById('ai-batch-save-btn');
        
        // åªæœ‰å½“æŒ‰é’®å­˜åœ¨ï¼Œä¸”æ²¡æœ‰è¢«ç¦ç”¨ï¼ˆè¯´æ˜ä»»åŠ¡å®Œæˆäº†ï¼‰æ—¶ï¼Œæ‰è¿›è¡Œå¼ºåˆ¶ç»‘å®š
        if (btn && !btn.disabled) {
            const currentAttr = btn.getAttribute('onclick');
            
            // å¦‚æœæŒ‰é’®ä¸Šæ²¡æœ‰ onclickï¼Œæˆ–è€… onclick ä¸æ˜¯æˆ‘ä»¬è¦çš„é‚£ä¸ª
            if (currentAttr !== 'window.forceBatchSave(this)') {
                // console.log("ğŸ”§ [Enforcer] å¼ºåˆ¶æ³¨å…¥ onclick å±æ€§...");
                // 1. ç§»é™¤æ‰€æœ‰å¯èƒ½çš„å¹²æ‰°ç›‘å¬å™¨ (é€šè¿‡å…‹éš†èŠ‚ç‚¹)
                // æ³¨æ„ï¼šå…‹éš†ä¼šå¯¼è‡´å¼•ç”¨å˜åŒ–ï¼Œå¦‚æœä¸»ç¨‹åºè¿˜åœ¨ç”¨æ—§å¼•ç”¨æ›´æ–°UIå¯èƒ½ä¼šæœ‰é—®é¢˜
                // æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªåšå±æ€§è¦†ç›–ï¼Œä¸å…‹éš†ï¼Œè¿™æ˜¯æœ€ç¨³å¦¥çš„
                
                // 2. å¼ºåˆ¶è¦†ç›– onclick
                btn.setAttribute('onclick', 'window.forceBatchSave(this)');
                
                // 3. ç¡®ä¿æ ·å¼æ˜¯é¼ æ ‡æ‰‹å‹
                btn.style.cursor = 'pointer';
            }
        }
    }, 500);

})();